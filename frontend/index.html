<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aviation Engine Management</title>
    <script>
        // Global helpers available to all scripts
        function noCache() { return `?t=${Date.now()}`; }
        window.noCache = window.noCache || noCache;

        window.getDeletedEngineIds = window.getDeletedEngineIds || function() {
            try {
                const ids = localStorage.getItem('engine-deleted-ids');
                return ids ? JSON.parse(ids) : [];
            } catch (e) {
                return [];
            }
        };
        var getDeletedEngineIds = window.getDeletedEngineIds;
    </script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <!-- SheetJS for Excel Export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- PDF Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    
    <style>
        html { overflow-y: auto; overflow-x: hidden; }
        html::-webkit-scrollbar { width: 0; }
        html { -ms-overflow-style: none; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #0b1120; overflow-x: visible; padding-top: 0; max-width: 100vw; color: #e2e8f0; }
        
        /* Prevent horizontal overflow on main content */
        #wrapper { display: flex; width: 100%; max-width: 100vw; align-items: stretch; transition: all 0.3s; padding-top: 0; overflow-x: visible; }
        #page-content-wrapper { flex: 1 1 auto; width: auto !important; min-width: 0; max-width: 100%; overflow-x: visible; background-color: #0b1120; }
        .container-fluid { max-width: 100%; overflow-x: visible; }
        .dashboard-content { width: 100%; max-width: 100%; overflow-x: visible; }
        #fleet-section, .parts-dashboard-grid, #calendar-grid-container { max-width: 100%; overflow-x: visible; }

        /* --- SIDEBAR --- */
        #sidebar-wrapper {
            min-width: 260px; 
            max-width: 260px;
            min-height: 100vh;
            background: linear-gradient(180deg, #0a1929 0%, #0d1f2d 100%);
            color: #b0bec5;
            transition: margin 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            margin-top: 0;
            border-right: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 4px 0 24px rgba(0, 0, 0, 0.3);
        }
        #wrapper.toggled #sidebar-wrapper { margin-left: -260px; }
        
        .sidebar-brand { 
            padding: 1.5rem 1.25rem; 
            font-size: 1.15rem; 
            font-weight: 600; 
            border-bottom: 1px solid rgba(255, 255, 255, 0.1); 
            color: #eceff1; 
            text-decoration: none; 
            display: flex;
            align-items: center;
            gap: 10px;
            letter-spacing: 0.5px;
            transition: all 0.2s ease;
        }
        .sidebar-brand:hover {
            color: #4fc3f7;
            background: rgba(255, 255, 255, 0.03);
        }
        .sidebar-brand i {
            font-size: 1.1rem;
            color: #4fc3f7;
        }
        .list-group-item { 
            background: transparent; 
            color: #b0bec5; 
            border: none; 
            padding: 11px 20px; 
            font-size: 0.9rem;
            font-weight: 500;
            letter-spacing: 0.3px;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            border-left: 3px solid transparent;
        }
        .list-group-item:hover { 
            background: rgba(79, 195, 247, 0.08); 
            color: #eceff1;
            border-left-color: #4fc3f7;
            transform: translateX(2px);
        }
        .list-group-item.active { 
            background: rgba(79, 195, 247, 0.12); 
            color: #4fc3f7; 
            border-left-color: #4fc3f7;
            font-weight: 600;
        }
        .list-group-item i { 
            margin-right: 12px; 
            width: 18px; 
            text-align: center;
            font-size: 0.95rem;
            opacity: 0.9;
        }
        
        /* Settings modal list items - dark text by default, white on hover */
        #locations-edit-list .list-group-item,
        #fleet-edit-list .list-group-item,
        #status-edit-list .list-group-item {
            color: #2c3e50;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            margin-bottom: 4px;
            border-radius: 6px;
        }
        
        #locations-edit-list .list-group-item:hover,
        #fleet-edit-list .list-group-item:hover,
        #status-edit-list .list-group-item:hover {
            background: #0d6efd;
            color: #fff;
            border-color: #0d6efd;
        }
        
        #locations-edit-list .list-group-item strong,
        #fleet-edit-list .list-group-item strong,
        #status-edit-list .list-group-item strong {
            color: inherit;
        }

        /* Global Dark Theme Overrides */
        h1, h2, h3, h4, h5, h6 { color: #f1f5f9; }
        p, span, div { color: #e2e8f0; }
        .text-muted { color: #94a3b8 !important; }
        
        /* Dark Cards */
        .card {
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            border: 1px solid rgba(148, 163, 184, 0.2);
            color: #e2e8f0;
        }
        
        .card-header {
            background: rgba(15, 23, 42, 0.5);
            border-bottom: 1px solid rgba(148, 163, 184, 0.2);
            color: #f1f5f9;
        }
        
        /* Dark Tables */
        .table {
            color: #e2e8f0;
        }
        
        .table thead th {
            background: rgba(15, 23, 42, 0.6);
            color: #f1f5f9;
            border-color: rgba(148, 163, 184, 0.2);
        }
        
        .table tbody tr {
            background: rgba(30, 41, 59, 0.4);
            border-color: rgba(148, 163, 184, 0.1);
        }
        
        .table tbody tr:hover {
            background: rgba(51, 65, 85, 0.6);
        }
        
        /* White Input Fields - Always (both dark and light modes) */
        .form-control, .form-select, textarea {
            background: #ffffff !important;
            border: 1px solid #ced4da !important;
            color: #212529 !important;
        }
        
        .form-control:focus, .form-select:focus, textarea:focus {
            background: #ffffff !important;
            border-color: #0d6efd !important;
            color: #212529 !important;
            box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25) !important;
        }
        
        .form-control::placeholder, textarea::placeholder {
            color: #6c757d !important;
            opacity: 0.7;
        }
        
        .form-label {
            color: #e2e8f0;
        }

        /* Light Background Mode - minimal changes */
        body.light-bg {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%) !important;
        }
        
        body.light-bg #page-content-wrapper {
            background: transparent;
        }
        
        /* Exclude all dashboard cards from light-bg changes */
        body.light-bg .card:not(.parts-card-3d):not(.aircraft-card):not(.btn-dashboard):not(.btn-dashboard-sub) {
            background: #ffffff;
            border: 1px solid #dee2e6;
        }
        
        body.light-bg .card-header {
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
        }
        
        body.light-bg .table {
            background: #ffffff;
        }
        
        body.light-bg .table thead th {
            background: #f8f9fa;
            color: #212529;
            border-color: #dee2e6;
        }
        
        body.light-bg .table tbody tr {
            background: #ffffff;
            border-color: #dee2e6;
        }
        
        body.light-bg .table tbody tr:hover {
            background: #f8f9fa;
        }
        
        body.light-bg .modal-content {
            background: #ffffff;
        }
        
        body.light-bg .modal-header {
            background: #f8f9fa;
            color: #212529;
        }
        
        body.light-bg .nav-tabs .nav-link {
            background: #f8f9fa;
            color: #495057;
        }
        
        body.light-bg .nav-tabs .nav-link.active {
            background: #ffffff;
            color: #0d6efd;
        }
        
        body.light-bg .tab-content {
            background: #ffffff;
        }
        
        /* Data modal (locations): keep white body, dark header with white city title */
        body.light-bg #dataModal .modal-content {
            background: #ffffff;
            color: #212529;
            border: 1px solid #dee2e6;
        }

        body.light-bg #dataModal .modal-header {
            background: #111827;
            color: #f8fafc;
            border-bottom: 1px solid #0b1324;
        }

        body.light-bg #dataModal .table thead th {
            background: #f8f9fa;
            color: #212529;
            border-color: #dee2e6;
        }

        body.light-bg #dataModal .table tbody tr {
            background: #ffffff;
            color: #212529;
            border-color: #dee2e6;
        }

        body.light-bg #dataModal .table tbody tr:hover {
            background: #f8f9fa;
        }

        /* Light Background Mode - Text Colors (exclude sidebar and all dashboard cards) */
        body.light-bg #page-content-wrapper .form-label,
        body.light-bg .modal .form-label {
            color: #212529 !important;
        }
        
        body.light-bg #page-content-wrapper h1:not(.btn-dashboard *):not(.btn-dashboard-sub *):not(.parts-card-3d *):not(.aircraft-card *),
        body.light-bg #page-content-wrapper h2:not(.btn-dashboard *):not(.btn-dashboard-sub *):not(.parts-card-3d *):not(.aircraft-card *),
        body.light-bg #page-content-wrapper h3:not(.btn-dashboard *):not(.btn-dashboard-sub *):not(.parts-card-3d *):not(.aircraft-card *),
        body.light-bg #page-content-wrapper h4:not(.btn-dashboard *):not(.btn-dashboard-sub *):not(.parts-card-3d *):not(.aircraft-card *),
        body.light-bg #page-content-wrapper h5:not(.btn-dashboard *):not(.btn-dashboard-sub *):not(.parts-card-3d *):not(.aircraft-card *),
        body.light-bg #page-content-wrapper h6:not(.btn-dashboard *):not(.btn-dashboard-sub *):not(.parts-card-3d *):not(.aircraft-card *),
        body.light-bg .modal h1,
        body.light-bg .modal h2,
        body.light-bg .modal h3,
        body.light-bg .modal h4,
        body.light-bg .modal h5,
        body.light-bg .modal h6 {
            color: #212529 !important;
        }
        
        body.light-bg #page-content-wrapper p:not(.btn-dashboard *):not(.btn-dashboard-sub *):not(.parts-card-3d *):not(.aircraft-card *),
        body.light-bg #page-content-wrapper span:not(.btn-dashboard *):not(.btn-dashboard-sub *):not(.parts-card-3d *):not(.aircraft-card *),
        body.light-bg #page-content-wrapper div:not(.btn-dashboard):not(.btn-dashboard-sub):not(.parts-card-3d):not(.aircraft-card):not(.btn-dashboard *):not(.btn-dashboard-sub *):not(.parts-card-3d *):not(.aircraft-card *),
        body.light-bg .modal p,
        body.light-bg .modal span,
        body.light-bg .modal div {
            color: #2d3748 !important;
        }
        
        body.light-bg #page-content-wrapper .text-muted:not(.btn-dashboard *):not(.btn-dashboard-sub *):not(.parts-card-3d *):not(.aircraft-card *),
        body.light-bg .modal .text-muted {
            color: #6c757d !important;
        }
        
        body.light-bg #page-content-wrapper small:not(.btn-dashboard *):not(.btn-dashboard-sub *):not(.parts-card-3d *):not(.aircraft-card *),
        body.light-bg .modal small {
            color: #495057 !important;
        }
        
        body.light-bg .modal-body {
            color: #212529 !important;
        }
        
        body.light-bg #page-content-wrapper td:not(.btn-dashboard *):not(.btn-dashboard-sub *):not(.parts-card-3d *):not(.aircraft-card *),
        body.light-bg .modal td {
            color: #212529 !important;
        }

        /* ===== ДЕЙСТВИЯ (ACTIONS) - БЕЛЫЕ ШАПКИ И ЗАЩИТА ОТ LIGHT-BG ===== */
        
        /* Белые шапки таблиц Actions (всегда, даже в ночном режиме) */
        #view-install .table thead th,
        #view-remove .table thead th,
        #view-repair .table thead th,
        #view-atlb .table thead th,
        #view-eng-params .table thead th,
        #view-utilization-params .table thead th,
        #view-parts .table thead th,
        #view-store-balance .table thead th,
        #view-gss-modal .table thead th {
            background: #ffffff !important;
            color: #212529 !important;
            border-color: #dee2e6 !important;
        }

        /* Исключить таблицы Actions из light-bg затемнения */
        body.light-bg #view-install .table,
        body.light-bg #view-remove .table,
        body.light-bg #view-repair .table,
        body.light-bg #view-atlb .table,
        body.light-bg #view-eng-params .table,
        body.light-bg #view-utilization-params .table,
        body.light-bg #view-parts .table,
        body.light-bg #view-store-balance .table {
            background: #ffffff;
        }

        body.light-bg #view-install .table tbody tr,
        body.light-bg #view-remove .table tbody tr,
        body.light-bg #view-repair .table tbody tr,
        body.light-bg #view-atlb .table tbody tr,
        body.light-bg #view-eng-params .table tbody tr,
        body.light-bg #view-utilization-params .table tbody tr,
        body.light-bg #view-parts .table tbody tr,
        body.light-bg #view-store-balance .table tbody tr {
            background: #ffffff;
            color: #212529;
            border-color: #dee2e6;
        }

        body.light-bg #view-install .table tbody tr:hover,
        body.light-bg #view-remove .table tbody tr:hover,
        body.light-bg #view-repair .table tbody tr:hover,
        body.light-bg #view-atlb .table tbody tr:hover,
        body.light-bg #view-eng-params .table tbody tr:hover,
        body.light-bg #view-utilization-params .table tbody tr:hover,
        body.light-bg #view-parts .table tbody tr:hover,
        body.light-bg #view-store-balance .table tbody tr:hover {
            background: #f8f9fa;
        }

        /* Защита бейджей/статусов от изменения в light-bg */
        body.light-bg #view-install .badge,
        body.light-bg #view-remove .badge,
        body.light-bg #view-repair .badge,
        body.light-bg #view-atlb .badge,
        body.light-bg #view-eng-params .badge,
        body.light-bg #view-utilization-params .badge,
        body.light-bg #view-parts .badge,
        body.light-bg #view-store-balance .badge {
            filter: none !important;
            opacity: 1 !important;
        }

        /* ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ */
        /* ГЛОБАЛЬНЫЕ ПРАВИЛА - БЕЛЫЙ ТЕКСТ ВО ВСЕХ СТАТУСАХ ВЕЗДЕ */
        /* ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ */
        
        /* Белый текст для всех бейджей везде */
        .badge {
            color: #ffffff !important;
        }

        .badge.bg-success,
        .badge.bg-danger,
        .badge.bg-primary,
        .badge.bg-warning,
        .badge.bg-info,
        .badge.bg-secondary,
        .badge.bg-light,
        .badge.bg-dark {
            color: #ffffff !important;
        }

        /* Белый текст для всех элементов с bg-* классами */
        [class*="bg-success"],
        [class*="bg-danger"],
        [class*="bg-primary"],
        [class*="bg-warning"],
        [class*="bg-info"],
        [class*="bg-secondary"] {
            color: #ffffff !important;
        }

        /* Убрать попытки использовать черный текст */
        .text-dark,
        .badge.text-dark {
            color: #ffffff !important;
        }

        /* ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ */
        /* ДОПОЛНИТЕЛЬНЫЕ ПРАВИЛА ДЛЯ ДНЕВНОГО РЕЖИМА */
        /* ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ */
        
        /* Сохранить контрастные цвета бейджей в light-bg режиме с белым текстом */
        body.light-bg .badge.bg-success {
            background-color: #198754 !important;
            color: #ffffff !important;
        }

        body.light-bg .badge.bg-danger {
            background-color: #dc3545 !important;
            color: #ffffff !important;
        }

        body.light-bg .badge.bg-info {
            background-color: #0dcaf0 !important;
            color: #ffffff !important;
        }

        body.light-bg .badge.bg-warning {
            background-color: #ffc107 !important;
            color: #ffffff !important;
        }

        body.light-bg .badge.bg-secondary {
            background-color: #6c757d !important;
            color: #ffffff !important;
        }

        body.light-bg .badge.bg-primary {
            background-color: #0d6efd !important;
            color: #ffffff !important;
        }

        body.light-bg .badge.bg-light {
            background-color: #f8f9fa !important;
            color: #ffffff !important;
        }

        body.light-bg .badge.bg-dark {
            background-color: #212529 !important;
            color: #ffffff !important;
        }

        /* Белый текст для всех остальных цветных элементов при дневном режиме */
        body.light-bg .badge {
            color: #ffffff !important;
        }

        /* Убрать черный текст если есть */
        body.light-bg .badge.text-dark {
            color: #ffffff !important;
        }

        /* Убрать text-dark из всех бейджей */
        body.light-bg .badge:not(.bg-light.text-dark) {
            color: #ffffff !important;
        }

        /* Глобальный переопредел для всех span с bg-* классами */
        body.light-bg span[class*="bg-success"],
        body.light-bg span[class*="bg-danger"],
        body.light-bg span[class*="bg-primary"],
        body.light-bg span[class*="bg-warning"],
        body.light-bg span[class*="bg-info"],
        body.light-bg span[class*="bg-secondary"] {
            color: #ffffff !important;
        }
        /* Дополнительная защита для всех статусов и условий в light-bg - ТОЛЬКО БЕЛЫЙ ТЕКСТ */
        body.light-bg [class*="bg-success"],
        body.light-bg [class*="bg-danger"],
        body.light-bg [class*="bg-primary"],
        body.light-bg [class*="bg-warning"],
        body.light-bg [class*="bg-info"],
        body.light-bg [class*="bg-secondary"] {
            color: #ffffff !important;
        }

        /* Решающее правило - белый текст везде в light-bg режиме */
        body.light-bg .badge,
        body.light-bg span[class*="bg-"] {
            color: #ffffff !important;
        }

        /* Убить все попытки text-dark */
        body.light-bg .badge.text-dark,
        body.light-bg .text-dark {
            color: #ffffff !important;
        }


        /* Защита иконок статусов */
        body.light-bg .badge.bg-success::before,
        body.light-bg .badge.bg-success::after,
        body.light-bg .badge.bg-danger::before,
        body.light-bg .badge.bg-danger::after,
        body.light-bg .badge.bg-primary::before,
        body.light-bg .badge.bg-primary::after,
        body.light-bg .badge.bg-warning::before,
        body.light-bg .badge.bg-warning::after {
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3) !important;
        }

        /* Защита статусных кнопок на дашборде */
        body.light-bg .btn-dashboard.btn-status-sv,
        body.light-bg .btn-dashboard.btn-status-us,
        body.light-bg .btn-dashboard.btn-status-rem,
        body.light-bg .btn-dashboard.btn-status-inst {
            opacity: 1 !important;
            filter: none !important;
        }

        /* Защита текста в статусных кнопках */
        body.light-bg .btn-dashboard.btn-status-sv .label,
        body.light-bg .btn-dashboard.btn-status-us .label,
        body.light-bg .btn-dashboard.btn-status-rem .label,
        body.light-bg .btn-dashboard.btn-status-inst .label {
            color: white !important;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.4) !important;
        }

        /* Решающее правило - белый текст везде в light-bg режиме */
        body.light-bg .badge,
        body.light-bg span[class*="bg-"] {
            color: #ffffff !important;
        }

        /* Убить все попытки text-dark */
        body.light-bg .badge.text-dark,
        body.light-bg .text-dark {
            color: #ffffff !important;
        }

        /* КНОПКИ НА ДАШБОРДЕ (Полный стиль) */
        .btn-dashboard {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            justify-content: space-between;
            gap: 0.35rem;
            width: 100%;
            padding: 18px 20px;
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 12px;
            background: linear-gradient(135deg, #1a2332 0%, #243040 100%);
            color: #eceff1;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25), inset 0 1px 0 rgba(255, 255, 255, 0.05);
            text-align: left;
            text-transform: none;
            cursor: pointer;
            overflow: hidden;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .btn-dashboard .label {
            font-size: 0.75rem;
            letter-spacing: 1px;
            text-transform: uppercase;
            opacity: 0.85;
            color: #b0bec5 !important;
            font-weight: 600;
            position: relative;
            z-index: 2;
            display: block;
        }
        .btn-dashboard .count {
            font-size: 1.9rem;
            font-weight: 700;
            line-height: 1;
            color: #ffffff !important;
            position: relative;
            z-index: 2;
            display: block;
        }

        .btn-dashboard i {
            position: absolute;
            top: 16px;
            right: 16px;
            font-size: 1.5rem;
            opacity: 0.15;
            transition: all 0.2s ease;
            z-index: 1;
            color: #4fc3f7;
        }

        .btn-dashboard:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 24px rgba(79, 195, 247, 0.25), 0 0 0 2px rgba(79, 195, 247, 0.4), inset 0 1px 0 rgba(255, 255, 255, 0.1);
            border-color: rgba(79, 195, 247, 0.6);
            background: linear-gradient(135deg, #1e2938 0%, #2a3a4d 100%);
        }

        .btn-dashboard:hover .label {
            color: #e3f2fd !important;
        }

        .btn-dashboard:hover i {
            opacity: 0.4;
            transform: scale(1.1);
        }

        .btn-status-sv {
            background: linear-gradient(135deg, #22754a 0%, #34955f 100%);
            box-shadow: 0 4px 12px rgba(34, 117, 74, 0.35);
            border-color: rgba(52, 149, 95, 0.5);
        }
        
        .btn-status-sv:hover {
            background: linear-gradient(135deg, #2a8a5a 0%, #3db070 100%);
            box-shadow: 0 8px 24px rgba(34, 149, 74, 0.4), 0 0 0 2px rgba(52, 149, 95, 0.5);
            border-color: rgba(52, 149, 95, 0.8);
        }

        .btn-status-us {
            background: linear-gradient(135deg, #6e2020 0%, #943535 100%);
            box-shadow: 0 4px 12px rgba(110, 32, 32, 0.35);
            border-color: rgba(148, 53, 53, 0.5);
        }
        
        .btn-status-us:hover {
            background: linear-gradient(135deg, #852828 0%, #af4444 100%);
            box-shadow: 0 8px 24px rgba(133, 40, 40, 0.4), 0 0 0 2px rgba(148, 53, 53, 0.5);
            border-color: rgba(148, 53, 53, 0.8);
        }

        .btn-status-rem {
            background: linear-gradient(135deg, #4a2d7a 0%, #6b4a9e 100%);
            box-shadow: 0 4px 12px rgba(74, 45, 122, 0.35);
            border-color: rgba(107, 74, 158, 0.5);
        }
        
        .btn-status-rem:hover {
            background: linear-gradient(135deg, #5a3990 0%, #7f5ab8 100%);
            box-shadow: 0 8px 24px rgba(90, 57, 144, 0.4), 0 0 0 2px rgba(107, 74, 158, 0.5);
            border-color: rgba(107, 74, 158, 0.8);
        }

        .btn-status-inst {
            background: linear-gradient(135deg, #114a82 0%, #2270ad 100%);
            box-shadow: 0 4px 12px rgba(17, 74, 130, 0.35);
            border-color: rgba(34, 112, 173, 0.5);
        }
        
        .btn-status-inst:hover {
            background: linear-gradient(135deg, #165c9f 0%, #2a86ca 100%);
            box-shadow: 0 8px 24px rgba(22, 92, 159, 0.4), 0 0 0 2px rgba(34, 112, 173, 0.5);
            border-color: rgba(34, 112, 173, 0.8);
        }

        /* Защита статусных кнопок от light-bg темы */
        body.light-bg .btn-status-sv {
            background: linear-gradient(135deg, #22754a 0%, #34955f 100%) !important;
            box-shadow: 0 4px 12px rgba(34, 117, 74, 0.35) !important;
            border-color: rgba(52, 149, 95, 0.5) !important;
        }
        
        body.light-bg .btn-status-sv:hover {
            background: linear-gradient(135deg, #2a8a5a 0%, #3db070 100%) !important;
            box-shadow: 0 8px 24px rgba(34, 149, 74, 0.4), 0 0 0 2px rgba(52, 149, 95, 0.5) !important;
            border-color: rgba(52, 149, 95, 0.8) !important;
        }

        body.light-bg .btn-status-us {
            background: linear-gradient(135deg, #6e2020 0%, #943535 100%) !important;
            box-shadow: 0 4px 12px rgba(110, 32, 32, 0.35) !important;
            border-color: rgba(148, 53, 53, 0.5) !important;
        }
        
        body.light-bg .btn-status-us:hover {
            background: linear-gradient(135deg, #852828 0%, #af4444 100%) !important;
            box-shadow: 0 8px 24px rgba(133, 40, 40, 0.4), 0 0 0 2px rgba(148, 53, 53, 0.5) !important;
            border-color: rgba(148, 53, 53, 0.8) !important;
        }

        body.light-bg .btn-status-rem {
            background: linear-gradient(135deg, #4a2d7a 0%, #6b4a9e 100%) !important;
            box-shadow: 0 4px 12px rgba(74, 45, 122, 0.35) !important;
            border-color: rgba(107, 74, 158, 0.5) !important;
        }
        
        body.light-bg .btn-status-rem:hover {
            background: linear-gradient(135deg, #5a3990 0%, #7f5ab8 100%) !important;
            box-shadow: 0 8px 24px rgba(90, 57, 144, 0.4), 0 0 0 2px rgba(107, 74, 158, 0.5) !important;
            border-color: rgba(107, 74, 158, 0.8) !important;
        }

        body.light-bg .btn-status-inst {
            background: linear-gradient(135deg, #114a82 0%, #2270ad 100%) !important;
            box-shadow: 0 4px 12px rgba(17, 74, 130, 0.35) !important;
            border-color: rgba(34, 112, 173, 0.5) !important;
        }
        
        body.light-bg .btn-status-inst:hover {
            background: linear-gradient(135deg, #165c9f 0%, #2a86ca 100%) !important;
            box-shadow: 0 8px 24px rgba(22, 92, 159, 0.4), 0 0 0 2px rgba(34, 112, 173, 0.5) !important;
            border-color: rgba(34, 112, 173, 0.8) !important;
        }

        .btn-status-scrap {
            background: linear-gradient(135deg, #2a2f35 0%, #3d454d 100%);
            box-shadow: 0 4px 12px rgba(42, 47, 53, 0.3);
            border-color: rgba(61, 69, 77, 0.4);
            color: #eceff1;
        }

        /* Subcards: full size matching main dashboard cards */
        .btn-dashboard-sub {
            padding: 20px;
            font-size: 1rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 12px;
            position: relative;
            min-height: 140px;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .btn-dashboard-sub:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.3);
        }
        .btn-dashboard-sub .label {
            font-size: 0.8rem;
            font-weight: 600;
            opacity: 0.85;
            margin-bottom: 8px;
            color: #b0bec5 !important;
            position: relative;
            z-index: 2;
            display: block;
            letter-spacing: 0.5px;
        }
        .btn-dashboard-sub .count {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 4px;
        }
        .btn-dashboard-sub i {
            position: absolute;
            bottom: 15px;
            right: 15px;
            font-size: 2.5rem;
            opacity: 0.2;
        }
        .btn-cond-new {
            background: linear-gradient(135deg, #0d5299 0%, #1a6bb8 100%);
            box-shadow: 0 4px 12px rgba(13, 82, 153, 0.3);
            border-color: rgba(26, 107, 184, 0.4);
            color: #eceff1;
        }
        .btn-cond-overhauled {
            background: linear-gradient(135deg, #b85d10 0%, #d97514 100%);
            box-shadow: 0 4px 12px rgba(184, 93, 16, 0.3);
            border-color: rgba(217, 117, 20, 0.4);
            color: #eceff1;
        }
        .btn-cond-inspected {
            background: linear-gradient(135deg, #127a8a 0%, #1a99ab 100%);
            box-shadow: 0 4px 12px rgba(18, 122, 138, 0.3);
            border-color: rgba(26, 153, 171, 0.4);
            color: #eceff1;
        }
        .btn-cond-as {
            background: linear-gradient(135deg, #4a5158 0%, #5d656e 100%);
            box-shadow: 0 4px 12px rgba(74, 81, 88, 0.3);
            border-color: rgba(93, 101, 110, 0.4);
            color: #eceff1;
        }

        #locations-container .btn-dashboard {
            background: linear-gradient(135deg, #1a2332 0%, #243040 100%);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25), inset 0 1px 0 rgba(255, 255, 255, 0.05);
        }

        #locations-container .btn-dashboard .label {
            font-size: 0.7rem;
            opacity: 0.85;
            color: #b0bec5 !important;
            font-weight: 600;
            position: relative;
            z-index: 2;
            display: block;
            letter-spacing: 1px;
            text-transform: uppercase;
        }

        #locations-container .btn-dashboard .count {
            font-size: 1.4rem;
            color: #eceff1;
        }

        #locations-container .btn-dashboard i {
            font-size: 1.3rem;
            opacity: 0.15;
            color: #4fc3f7;
        }
        
        #locations-container .btn-dashboard:hover {
            border-color: rgba(79, 195, 247, 0.6);
            box-shadow: 0 8px 24px rgba(79, 195, 247, 0.25), 0 0 0 2px rgba(79, 195, 247, 0.4), inset 0 1px 0 rgba(255, 255, 255, 0.1);
            background: linear-gradient(135deg, #1e2938 0%, #2a3a4d 100%);
            transform: translateY(-3px);
        }
        
        #locations-container .btn-dashboard:hover .label {
            color: #e3f2fd !important;
        }
        
        #locations-container .btn-dashboard:hover i {
            opacity: 0.4;
        }

        .aircraft-card {
            background: linear-gradient(135deg, rgba(26, 35, 50, 0.8) 0%, rgba(45, 62, 80, 0.8) 100%);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 20px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4), inset 0 1px 0 rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(0, 210, 255, 0.2);
            transition: all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
            margin-bottom: 20px;
            isolation: isolate;
        }
        
        .aircraft-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(0, 210, 255, 0.1) 0%, rgba(138, 43, 226, 0.05) 100%);
            opacity: 0;
            transition: opacity 0.4s;
            pointer-events: none;
        }
        
        .aircraft-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 20px 60px rgba(0, 210, 255, 0.4), inset 0 1px 0 rgba(255, 255, 255, 0.15);
            border-color: rgba(0, 255, 200, 0.5);
        }
        
        .aircraft-card:hover::before {
            opacity: 1;
        }
        
        .aircraft-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
            position: relative;
            z-index: 10;
        }
        
        .aircraft-name {
            font-size: 1.5rem;
            font-weight: 700;
            color: #ffffff;
            text-shadow: 0 2px 12px rgba(0, 0, 0, 0.9);
            letter-spacing: 1px;
            transition: all 0.3s;
        }
        
        .aircraft-name:hover {
            text-shadow: 0 2px 12px rgba(0, 0, 0, 0.9);
        }
        
        .aircraft-stats {
            text-align: right;
        }
        
        .aircraft-icon {
            font-size: 2.5rem;
            color: rgba(255, 255, 255, 0.15);
            margin-bottom: 8px;
        }
        
        .aircraft-hours {
            font-size: 1.1rem;
            font-weight: 700;
            background: linear-gradient(135deg, #00ffff 0%, #ffffff 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 0 0 20px rgba(0, 255, 200, 0.6);
            filter: drop-shadow(0 0 10px rgba(255, 255, 255, 0.4));
            transition: all 0.3s;
        }
        
        .aircraft-hours:hover {
            filter: drop-shadow(0 0 20px rgba(255, 255, 255, 0.6));
        }
        
        .aircraft-hours-label {
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.6);
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .chevron-toggle {
            text-align: center;
            cursor: pointer;
            padding: 10px;
            margin: 0 -20px -20px;
            background: rgba(0, 0, 0, 0.2);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }
        
        .chevron-toggle:hover {
            background: rgba(0, 123, 255, 0.3);
        }
        
        .chevron-icon {
            color: rgba(255, 255, 255, 0.7);
            font-size: 1.2rem;
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .chevron-icon.rotated {
            transform: rotate(180deg);
        }
        
        .engine-positions {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            z-index: 10;
        }
        
        .engine-positions.expanded {
            max-height: 4000px;
        }

        /* Position Item - Accordion Style */
        .position-item {
            background: rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(12px);
            border-radius: 10px;
            margin-bottom: 8px;
            border: 1px solid rgba(0, 210, 255, 0.15);
            transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            overflow: hidden;
            position: relative;
        }

        .position-item:hover {
            background: rgba(0, 0, 0, 0.2);
            border-color: rgba(0, 210, 255, 0.15);
        }

        .position-item-header {
            padding: 12px 16px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.2s;
        }

        .position-item-header:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .position-label {
            font-size: 0.95rem;
            font-weight: 700;
            color: #ffffff;
            letter-spacing: 0.5px;
        }

        .position-status {
            font-size: 0.8rem;
            padding: 4px 10px;
            border-radius: 12px;
            font-weight: 500;
            white-space: nowrap;
        }

        .position-status.empty {
            background: rgba(220, 38, 38, 0.15);
            color: #fca5a5;
        }

        .position-status.installed {
            background: rgba(34, 197, 94, 0.15);
            color: #86efac;
            max-width: 120px;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .position-details {
            padding: 0 16px 12px 16px;
            animation: slideDown 0.3s ease-out;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                max-height: 0;
            }
            to {
                opacity: 1;
                max-height: 500px;
            }
        }

        .empty-position-details {
            text-align: center;
            padding: 20px;
            color: rgba(255, 255, 255, 0.5);
        }

        .empty-position-details i {
            font-size: 2rem;
            margin-bottom: 8px;
            opacity: 0.5;
        }

        .position-period-info {
            background: linear-gradient(135deg, rgba(255, 193, 7, 0.15), rgba(255, 140, 0, 0.1));
            backdrop-filter: blur(10px);
            border-left: 4px solid rgba(255, 193, 7, 0.6);
            padding: 12px 14px;
            border-radius: 8px;
            margin-bottom: 10px;
            box-shadow: 0 0 15px rgba(255, 193, 7, 0.2), inset 0 1px 0 rgba(255, 255, 255, 0.1);
            transition: all 0.3s;
        }

        .position-period-info:hover {
            background: linear-gradient(135deg, rgba(255, 193, 7, 0.25), rgba(255, 140, 0, 0.15));
            border-left-color: #ffeb3b;
            box-shadow: 0 0 25px rgba(255, 193, 7, 0.4), inset 0 1px 0 rgba(255, 255, 255, 0.15);
        }

        .period-label {
            font-size: 0.75rem;
            color: rgba(255, 235, 59, 0.8);
            margin-bottom: 8px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .period-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            font-size: 0.85rem;
        }

        .period-stats div {
            text-align: center;
            color: rgba(255, 255, 255, 0.8);
            background: rgba(0, 0, 0, 0.2);
            padding: 8px;
            border-radius: 6px;
            border: 1px solid rgba(255, 193, 7, 0.2);
            transition: all 0.3s;
        }

        .period-stats div:hover {
            background: rgba(255, 193, 7, 0.1);
            border-color: rgba(255, 193, 7, 0.4);
            transform: scale(1.05);
        }

        .period-stats strong {
            color: #ffffff;
            display: block;
            font-size: 1.2rem;
            margin-bottom: 2px;
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
        }

        .engine-info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }

        /* Последние две ячейки (Installed и Param Date) на одной строке */
        .engine-info-grid .info-row:nth-last-child(-n+2) {
            grid-column: auto;
        }

        .engine-info-grid .info-row:last-child {
            grid-column: 2 / 3;
            margin-top: -8px;
        }

        .engine-info-grid .info-row:nth-last-child(2) {
            grid-column: 1 / 2;
            margin-bottom: 0;
        }

        .info-row {
            background: linear-gradient(135deg, rgba(0, 70, 140, 0.2), rgba(0, 100, 200, 0.1));
            backdrop-filter: blur(10px);
            padding: 10px 12px;
            border-radius: 6px;
            border-left: 3px solid rgba(0, 255, 200, 0.4);
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            position: relative;
            overflow: hidden;
        }

        .info-row::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(0, 255, 255, 0.15), transparent);
            transition: left 0.5s ease;
            pointer-events: none;
            z-index: 0;
        }

        .info-row:hover {
            background: linear-gradient(135deg, rgba(0, 210, 255, 0.4), rgba(138, 43, 226, 0.25));
            border-left-color: #00ffff;
            box-shadow: 0 0 25px rgba(0, 210, 255, 0.6), inset 0 0 20px rgba(0, 255, 255, 0.15);
        }

        .info-row:hover::before {
            left: 100%;
        }

        .info-label {
            font-size: 0.75rem;
            color: rgba(0, 255, 200, 0.7);
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: color 0.3s;
        }

        .info-value {
            font-size: 0.9rem;
            background: linear-gradient(135deg, #00ffff 0%, #ffffff 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: 700;
            text-align: right;
            word-break: break-word;
            transition: all 0.3s;
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.2);
            filter: drop-shadow(0 0 5px rgba(255, 255, 255, 0.15));
        }
        
        .engine-position-card {
            background: linear-gradient(135deg, #0f1419 0%, #1e2835 100%);
            border-radius: 12px;
            padding: 20px;
            margin-top: 15px;
            border: 1px solid rgba(255, 255, 255, 0.08);
            animation: slideIn 0.5s ease-out;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes neonGlow {
            0%, 100% {
                text-shadow: 0 0 10px rgba(0, 255, 255, 0.5), 0 0 20px rgba(0, 210, 255, 0.3);
            }
            50% {
                text-shadow: 0 0 20px rgba(0, 255, 255, 0.8), 0 0 40px rgba(0, 210, 255, 0.5), 0 0 60px rgba(138, 43, 226, 0.3);
            }
        }

        @keyframes shimmer {
            0% {
                left: -100%;
            }
            100% {
                left: 100%;
            }
        }

        .aircraft-name {
            animation: neonGlow 3s ease-in-out infinite;
        }
        
        .engine-visual {
            flex: 0 0 200px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        .engine-visual svg {
            width: 180px;
            height: 180px;
            opacity: 0.8;
        }
        
        .engine-data {
            flex: 1;
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }
        
        .engine-data-item {
            background: rgba(0, 0, 0, 0.3);
            padding: 12px;
            border-radius: 8px;
            border-left: 3px solid #007bff;
        }
        
        .engine-data-label {
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.5);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 4px;
        }
        
        .engine-data-value {
            font-size: 1.1rem;
            font-weight: 600;
            color: #ffffff;
        }
        
        .engine-data-value.highlight {
            color: #ffd700;
            font-size: 1.3rem;
        }
        
        .engine-data-value.param-date-value {
            color: #94a3b8;
            font-size: 0.9rem;
            font-style: italic;
        }
        
        .position-header {
            font-size: 1.1rem;
            font-weight: 600;
            color: #007bff;
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            border-bottom: 2px solid rgba(0, 123, 255, 0.3);
            padding-bottom: 8px;
        }
        
        .empty-position {
            text-align: center;
            padding: 40px;
            color: rgba(255, 255, 255, 0.3);
            font-style: italic;
        }
        
        /* Aircraft Main Visual - Full background video */
        .aircraft-visual-main {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            z-index: 0;
            border-radius: 16px;
        }
        
        .aircraft-visual-main::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(to bottom, rgba(26, 35, 50, 0.3) 0%, rgba(26, 35, 50, 0.5) 100%);
            z-index: 1;
            pointer-events: none;
        }
        
        .engine-3d-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: block;
            pointer-events: none;
        }
        
        .engine-video {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
            z-index: 0;
        }
        
        /* Chevron Toggle on Top - меньше и менее заметная */
        .chevron-toggle-top {
            text-align: center;
            position: relative;
            z-index: 10;
            position: relative;
            z-index: 2;
            padding: 6px;
            cursor: pointer;
            color: rgba(255, 215, 0, 0.4);
            font-size: 1rem;
            border-top: 1px solid rgba(255, 255, 255, 0.05);
            transition: all 0.3s ease;
        }
        
        .chevron-toggle-top:hover {
            background: rgba(255, 215, 0, 0.08);
            color: rgba(255, 215, 0, 0.7);
        }
        
        .chevron-toggle-top i {
            transition: transform 0.3s ease;
        }
        
        .chevron-toggle-top i.rotated {
            transform: rotate(180deg);
        }
        
        /* Engine Table Container */
        .engine-table-container {
            padding: 20px;
            background: linear-gradient(135deg, #0f1419 0%, #1e2835 100%);
            border-radius: 12px;
            margin-top: 15px;
            border: 1px solid rgba(255, 255, 255, 0.08);
            overflow-x: auto;
        }
        
        .engine-table {
            width: 100%;
            border-collapse: collapse;
            color: rgba(255, 255, 255, 0.9);
            font-size: 0.9rem;
        }
        
        .engine-table thead th {
            background: rgba(0, 123, 255, 0.2);
            padding: 12px 8px;
            text-align: left;
            font-weight: 600;
            border-bottom: 2px solid rgba(0, 123, 255, 0.5);
            font-size: 0.85rem;
            white-space: nowrap;
        }
        
        .engine-table tbody td {
            padding: 10px 8px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        .engine-table tbody tr:hover {
            background: rgba(0, 123, 255, 0.05);
        }
        
        .engine-table .position-num {
            font-weight: bold;
            color: #ffd700;
        }
        
        .engine-table .engine-sn {
            font-weight: bold;
            color: #60a5fa;
        }
        
        .engine-table .highlight {
            background: rgba(255, 215, 0, 0.1);
            font-weight: 600;
            color: #ffd700;
        }
        
        .engine-table .param-date {
            color: #94a3b8;
            font-size: 0.85rem;
            font-style: italic;
        }
        
        .engine-table .empty-position-cell {
            text-align: center;
            padding: 20px;
            color: rgba(255, 255, 255, 0.3);
            font-style: italic;
        }

        /* Global professional checkbox styling (no markup changes) */
        input[type="checkbox"], .form-check-input {
            width: 1.05rem;
            height: 1.05rem;
            cursor: pointer;
            accent-color: #0d6efd; /* Bootstrap primary */
            vertical-align: middle;
        }
        .form-check .form-check-input {
            margin-top: 0.1rem;
        }
        .form-check .form-check-input + .form-check-label {
            margin-left: 0.4rem;
            cursor: pointer;
        }
        /* Slight hover emphasis */
        .form-check-input:hover { filter: brightness(0.95); }
        .form-check-input:focus { outline: none; box-shadow: 0 0 0 0.2rem rgba(13,110,253,.15); }

        /* Professional controls for delete/select column */
        .delete-col .bulk-controls,
        .delete-col .select-controls {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .delete-col .form-check-input { cursor: pointer; width: 1.05rem; height: 1.05rem; }
        .delete-col .trash-btn { padding: 2px 6px; line-height: 1; }

        /* Table Styles in Modal */
        .modal-xl { max-width: 95%; }
        .table-custom th { background-color: #343a40; color: white; font-size: 0.85rem; vertical-align: middle; }
        .table-custom td { font-size: 0.9rem; vertical-align: middle; }
        .param-col { background-color: #f8f9fa; font-weight: bold; color: #0056b3; }
        /* --- UNIVERSAL COLUMN RESIZER (ALL TABLES) --- */
        table thead th { position: relative; }
        .col-resizer { 
            position: absolute; 
            right: 0; 
            top: 0; 
            width: 10px; 
            height: 100%; 
            cursor: col-resize; 
            user-select: none; 
            background: linear-gradient(90deg, transparent 40%, rgba(0, 123, 255, 0.3) 50%, transparent 60%);
            opacity: 0.5;
            transition: opacity 0.2s;
        }
        .col-resizer:hover { 
            opacity: 1;
            background: linear-gradient(90deg, transparent 30%, rgba(0, 123, 255, 0.7) 50%, transparent 70%);
        }
        table thead th, 
        table tbody td { white-space: nowrap; }
        /* --- UNIVERSAL FILTER PANEL --- */
        .filter-panel {
            position: fixed;
            top: 0;
            right: -420px;
            width: 400px;
            height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            box-shadow: -4px 0 25px rgba(0, 0, 0, 0.3);
            transition: right 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            z-index: 9999;
            overflow-y: auto;
            padding: 20px;
            color: white;
        }
        .filter-panel.open { right: 0; }
        .filter-panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.3);
        }
        .filter-panel-header h4 {
            margin: 0;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .filter-panel-close {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
            transition: all 0.3s;
        }
        .filter-panel-close:hover {
            background: rgba(255, 255, 255, 0.4);
            transform: rotate(90deg);
        }
        .filter-field {
            margin-bottom: 18px;
        }
        .filter-field label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            opacity: 0.95;
        }
        .filter-field input {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.15);
            color: white;
            font-size: 14px;
            transition: all 0.3s;
            backdrop-filter: blur(10px);
        }
        .filter-field input::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }
        .filter-field input:focus {
            outline: none;
            border-color: rgba(255, 255, 255, 0.8);
            background: rgba(255, 255, 255, 0.25);
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.3);
        }
        .filter-actions {
            display: flex;
            gap: 10px;
            margin-top: 25px;
            padding-top: 20px;
            border-top: 2px solid rgba(255, 255, 255, 0.3);
        }
        .filter-actions button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .filter-apply {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
        }
        .filter-apply:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(56, 239, 125, 0.4);
        }
        .filter-reset {
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }
        .filter-reset:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        .filter-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(3px);
            z-index: 9998;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }
        .filter-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        .btn-filter-toggle {
            margin-left: 8px;
        }
        /* --- NEON BUTTON & EDIT STYLES --- */
        .btn-neon {
            background: linear-gradient(135deg, #1e3a5f 0%, #2a5a8a 100%);
            color: #eceff1;
            border: 1px solid rgba(79, 195, 247, 0.3);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            font-weight: 600;
            text-align: left;
            font-size: 0.9rem;
            letter-spacing: 0.3px;
        }
        .btn-neon:hover {
            background: linear-gradient(135deg, #2a5a8a 0%, #3a7aba 100%);
            border-color: #4fc3f7;
            box-shadow: 0 4px 12px rgba(79, 195, 247, 0.2);
            color: #ffffff;
            transform: translateY(-1px);
        }
        .btn-neon i {
            opacity: 0.9;
        }

        /* Цвета статусов для таблицы */
        .badge-as { background-color: #8B4513; color: white; } /* Коричневый */

        /* Store Balance Condition badges */
        .cond-badge { font-weight: 600; padding: 0.35rem 0.5rem; border-radius: 0.25rem; }
        .cond-sv { background-color: #28a745; color: #fff; }            /* SV - NGV (SENT) */
        .cond-under { background-color: #0056b3; color: #fff; }         /* UNDER REPAIRING */
        .cond-delivered { background-color: #90ee90; color: #000; }     /* Delivered in Roma Italy */
        .cond-nocap { background-color: #dc3545; color: #fff; }         /* NO CAPABILITY */
        .cond-us { background-color: #ffc107; color: #000; }            /* US - SHJ */
        .cond-default { background-color: #e9ecef; color: #212529; }
        
        /* Режим редактирования */
        .editing-row { background-color: #fff3cd !important; } /* Желтый фон */
        /* --- СТИЛЬ ПОЛЕЙ ВВОДА ПРИ РЕДАКТИРОВАНИИ --- */
        .editing-input { 
            width: 100%; 
            border: 2px solid #ffc107; /* Желтая рамка */
            background-color: white;   /* Белый фон внутри */
            font-size: 0.85rem; 
            padding: 2px;
            /* Эффект свечения вокруг */
            box-shadow: 0 0 8px rgba(255, 193, 7, 0.6); 
            outline: none; /* Убираем стандартную синюю обводку браузера */
            transition: all 0.2s ease-in-out;
        }
        
        /* При фокусе (когда кликаешь) свечение становится ярче */
        .editing-input:focus {
            box-shadow: 0 0 12px rgba(44, 211, 3, 0.9); 
            border-color: #ffb300;
        }
        
        /* Круглая кнопка для добавления строки */
        .btn-circle {
            width: 38px;
            height: 38px;
            border-radius: 50%;
            padding: 0;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
        }
        
        .btn-circle:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        
        /* --- ENGINE START BUTTON --- */
        .engine-btn-container {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px 0;
            margin-bottom: 20px;
        }

        .btn-engine-start {
            width: 126px;
            height: 126px;
            border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, #0f202d 0%, #061018 55%, #020508 100%);
            border: 2px solid rgba(0, 210, 255, 0.35);
            color: inherit;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 0 28px rgba(0, 210, 255, 0.25);
            transition: all 0.35s ease;
            cursor: pointer;
            position: relative;
            z-index: 10;
            overflow: hidden;
        }

        .btn-engine-start:hover {
            box-shadow: 0 0 42px rgba(0, 210, 255, 0.6);
            transform: scale(1.05);
            border-color: rgba(0, 210, 255, 0.65);
        }

        .btn-engine-start.active {
            background: radial-gradient(circle, #27e3ff 0%, #0c9ed1 45%, #072130 100%);
            box-shadow: 0 0 60px rgba(0, 210, 255, 0.85);
            transform: scale(1.03) rotate(360deg);
        }

        .btn-engine-start.menu-open {
            box-shadow: 0 0 50px rgba(0, 210, 255, 0.8);
            border-color: #00d2ff;
        }

        .engine-btn-core {
            position: relative;
        }

        .engine-btn-menu {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 340px;
            height: 340px;
            transform: translate(-50%, -50%);
            pointer-events: none;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease;
        }

        .engine-btn-menu.show {
            opacity: 1;
            pointer-events: auto;
            visibility: visible;
        }

        .engine-menu-item {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 96px;
            height: 96px;
            border-radius: 18px;
            background: rgba(0, 210, 255, 0.06);
            border: 1px solid rgba(0, 210, 255, 0.28);
            color: #ecfaff;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 6px;
            font-size: 0.8rem;
            box-shadow: 0 0 18px rgba(0, 210, 255, 0.18);
            backdrop-filter: blur(6px);
            opacity: 0;
            pointer-events: none;
            --angle: 0deg;
            --radius: 140px;
            --scale: 0.55;
            transform: translate(-50%, -50%) rotate(var(--angle)) translate(var(--radius)) rotate(calc(var(--angle) * -1)) scale(var(--scale));
            transition: opacity 0.25s ease, transform 0.25s ease, box-shadow 0.25s ease;
            transform-origin: center;
        }

        .engine-btn-menu.show .engine-menu-item {
            opacity: 1;
            pointer-events: auto;
            --scale: 1;
        }

        .engine-menu-item:hover {
            box-shadow: 0 0 28px rgba(0, 210, 255, 0.4);
            border-color: rgba(0, 210, 255, 0.65);
        }

        .engine-menu-item i {
            font-size: 1.6rem;
        }

        .engine-btn-menu.show .engine-menu-item-manuals { transition-delay: 0.02s; }
        .engine-btn-menu.show .engine-menu-item-reports { transition-delay: 0.08s; }
        .engine-btn-menu.show .engine-menu-item-borescope-reports { transition-delay: 0.12s; }
        .engine-btn-menu.show .engine-menu-item-folders { transition-delay: 0.14s; }

        /* Hide main menu items when aircraft selector is shown */
        .engine-btn-menu.aircraft-selector-active > .engine-menu-item {
            opacity: 0 !important;
            pointer-events: none !important;
            transform: translate(-50%, -50%) rotate(var(--angle)) translate(var(--radius)) rotate(calc(var(--angle) * -1)) scale(0.5) !important;
        }

        /* Hide main menu items when reports submenu is shown */
        .engine-btn-menu.reports-submenu-active > .engine-menu-item {
            opacity: 0 !important;
            pointer-events: none !important;
            transform: translate(-50%, -50%) rotate(var(--angle)) translate(var(--radius)) rotate(calc(var(--angle) * -1)) scale(0.5) !important;
        }

        /* === SECOND LEVEL RADIAL MENU (Reports submenu) === */
        .reports-radial-menu {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 340px;
            height: 340px;
            transform: translate(-50%, -50%);
            pointer-events: none;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease;
        }

        .reports-radial-menu.show {
            opacity: 1;
            pointer-events: auto;
            visibility: visible;
        }

        .reports-menu-item {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 80px;
            height: 80px;
            border-radius: 14px;
            background: rgba(0, 255, 150, 0.08);
            border: 1px solid rgba(0, 255, 150, 0.35);
            color: #ecfaff;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 4px;
            font-size: 0.75rem;
            box-shadow: 0 0 16px rgba(0, 255, 150, 0.2);
            backdrop-filter: blur(6px);
            opacity: 0;
            pointer-events: none;
            --angle: 0deg;
            --radius: 110px;
            --scale: 0.55;
            cursor: pointer;
            transform: translate(-50%, -50%) rotate(var(--angle)) translate(var(--radius)) rotate(calc(var(--angle) * -1)) scale(var(--scale));
            transition: opacity 0.25s ease, transform 0.25s ease, box-shadow 0.25s ease;
            transform-origin: center;
        }

        .reports-radial-menu.show .reports-menu-item {
            opacity: 1;
            pointer-events: auto;
            --scale: 1;
        }

        .reports-menu-item:hover {
            box-shadow: 0 0 24px rgba(0, 255, 150, 0.5);
            border-color: rgba(0, 255, 150, 0.75);
            background: rgba(0, 255, 150, 0.12);
        }

        .reports-menu-item i {
            font-size: 1.4rem;
        }

        .reports-radial-menu.show .reports-menu-item-borescope { transition-delay: 0.02s; }
        .reports-radial-menu.show .reports-menu-item-engine-reports { transition-delay: 0.06s; }
        .reports-radial-menu.show .reports-menu-item-purchase { transition-delay: 0.10s; }
        .reports-radial-menu.show .reports-menu-item-nameplate { transition-delay: 0.14s; }

        /* === SECOND LEVEL RADIAL MENU (Manuals submenu) === */
        .manuals-radial-menu {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 340px;
            height: 340px;
            transform: translate(-50%, -50%);
            pointer-events: none;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease;
        }

        .manuals-radial-menu.show {
            opacity: 1;
            pointer-events: auto;
            visibility: visible;
        }

        .manuals-menu-item {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 80px;
            height: 80px;
            border-radius: 14px;
            background: rgba(100, 180, 255, 0.08);
            border: 1px solid rgba(100, 180, 255, 0.35);
            color: #ecfaff;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 4px;
            font-size: 0.75rem;
            box-shadow: 0 0 16px rgba(100, 180, 255, 0.2);
            backdrop-filter: blur(6px);
            opacity: 0;
            pointer-events: none;
            --angle: 0deg;
            --radius: 110px;
            --scale: 0.55;
            cursor: pointer;
            transform: translate(-50%, -50%) rotate(var(--angle)) translate(var(--radius)) rotate(calc(var(--angle) * -1)) scale(var(--scale));
            transition: opacity 0.25s ease, transform 0.25s ease, box-shadow 0.25s ease;
            transform-origin: center;
        }

        .manuals-radial-menu.show .manuals-menu-item {
            opacity: 1;
            pointer-events: auto;
            --scale: 1;
        }

        .manuals-menu-item:hover {
            box-shadow: 0 0 24px rgba(100, 180, 255, 0.5);
            border-color: rgba(100, 180, 255, 0.75);
            background: rgba(100, 180, 255, 0.12);
        }

        .manuals-menu-item i {
            font-size: 1.4rem;
        }

        .manuals-radial-menu.show .manuals-menu-item-boeing { transition-delay: 0.02s; }
        .manuals-radial-menu.show .manuals-menu-item-gecards { transition-delay: 0.06s; }

        /* === THIRD LEVEL RADIAL MENU (Aircraft selector for Borescope Reports) === */
        .aircraft-selector-menu {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 340px;
            height: 340px;
            transform: translate(-50%, -50%);
            pointer-events: none;
            display: none;
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .aircraft-selector-menu.show {
            display: flex;
            pointer-events: auto;
        }

        .aircraft-menu-item {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 80px;
            height: 80px;
            border-radius: 14px;
            background: rgba(255, 150, 100, 0.08);
            border: 1px solid rgba(255, 150, 100, 0.35);
            color: #ecfaff;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 4px;
            font-size: 0.75rem;
            box-shadow: 0 0 16px rgba(255, 150, 100, 0.2);
            backdrop-filter: blur(6px);
            opacity: 0;
            pointer-events: none;
            --angle: 0deg;
            --radius: 110px;
            --scale: 0.55;
            cursor: pointer;
            transform: translate(-50%, -50%) rotate(var(--angle)) translate(var(--radius)) rotate(calc(var(--angle) * -1)) scale(var(--scale));
            transition: opacity 0.25s ease, transform 0.25s ease, box-shadow 0.25s ease;
            transform-origin: center;
        }

        .aircraft-selector-menu.show .aircraft-menu-item {
            opacity: 1;
            pointer-events: auto;
            --scale: 1;
        }

        .aircraft-menu-item:hover {
            box-shadow: 0 0 24px rgba(255, 150, 100, 0.5);
            border-color: rgba(255, 150, 100, 0.75);
            background: rgba(255, 150, 100, 0.12);
        }

        .aircraft-menu-item i {
            font-size: 1.4rem;
        }

        .aircraft-selector-menu.show .aircraft-item-bar { transition-delay: 0.02s; }
        .aircraft-selector-menu.show .aircraft-item-baq { transition-delay: 0.06s; }
        .aircraft-selector-menu.show .aircraft-item-bat { transition-delay: 0.10s; }

        /* === FOURTH LEVEL RADIAL MENU (Positions selector) === */
        .positions-selector-menu {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 340px;
            height: 340px;
            transform: translate(-50%, -50%);
            pointer-events: none;
            display: none;
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .positions-selector-menu.show {
            display: flex;
            pointer-events: auto;
        }

        .position-menu-item {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 80px;
            height: 80px;
            border-radius: 14px;
            background: rgba(150, 255, 150, 0.08);
            border: 1px solid rgba(150, 255, 150, 0.35);
            color: #ecfaff;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 4px;
            font-size: 0.75rem;
            box-shadow: 0 0 16px rgba(150, 255, 150, 0.2);
            backdrop-filter: blur(6px);
            opacity: 0;
            pointer-events: none;
            --angle: 0deg;
            --radius: 110px;
            --scale: 0.55;
            cursor: pointer;
            transform: translate(-50%, -50%) rotate(var(--angle)) translate(var(--radius)) rotate(calc(var(--angle) * -1)) scale(var(--scale));
            transition: opacity 0.25s ease, transform 0.25s ease, box-shadow 0.25s ease;
            transform-origin: center;
        }

        .positions-selector-menu.show .position-menu-item {
            opacity: 1;
            pointer-events: auto;
            --scale: 1;
        }

        .position-menu-item:hover {
            box-shadow: 0 0 24px rgba(150, 255, 150, 0.5);
            border-color: rgba(150, 255, 150, 0.75);
            background: rgba(150, 255, 150, 0.12);
        }

        .position-menu-item i {
            font-size: 1.4rem;
        }

        .positions-selector-menu.show .position-item-1 { transition-delay: 0.02s; }
        .positions-selector-menu.show .position-item-2 { transition-delay: 0.06s; }
        .positions-selector-menu.show .position-item-3 { transition-delay: 0.10s; }
        .positions-selector-menu.show .position-item-4 { transition-delay: 0.14s; }
        .positions-selector-menu.show .position-item-all { transition-delay: 0.18s; }

        .engine-fan {
            position: relative;
            width: 78px;
            height: 78px;
            border-radius: 50%;
            background: radial-gradient(circle at 40% 40%, #1c3a4c 0%, #0a1821 55%, #02070c 100%);
            box-shadow: inset 0 0 18px rgba(0, 0, 0, 0.65), 0 0 22px rgba(0, 210, 255, 0.35);
            display: block;
            transform-origin: 50% 50%;
        }

        .engine-fan::before {
            content: '';
            position: absolute;
            inset: 6px;
            border-radius: 50%;
            border: 1px solid rgba(0, 210, 255, 0.25);
            box-shadow: inset 0 0 12px rgba(0, 210, 255, 0.18);
        }

        .fan-blade {
            position: absolute;
            top: 12px;
            left: 34px;
            width: 10px;
            height: 30px;
            border-radius: 50% 50% 20% 20%;
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.35) 0%, rgba(0, 178, 255, 0.25) 60%, rgba(0, 19, 34, 0.75) 100%);
            transform-origin: 50% 100%;
            filter: drop-shadow(0 0 6px rgba(0, 210, 255, 0.25));
        }

        .blade-1 { transform: rotate(0deg); }
        .blade-2 { transform: rotate(60deg); }
        .blade-3 { transform: rotate(120deg); }
        .blade-4 { transform: rotate(180deg); }
        .blade-5 { transform: rotate(240deg); }
        .blade-6 { transform: rotate(300deg); }

        .fan-hub {
            position: absolute;
            top: 28px;
            left: 28px;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background: radial-gradient(circle, #1d4d63 0%, #051019 70%, #01060a 100%);
            border: 1px solid rgba(0, 210, 255, 0.4);
            box-shadow: 0 0 12px rgba(0, 210, 255, 0.35);
        }

        .fan-hub::after {
            content: '';
            position: absolute;
            inset: 6px;
            border-radius: 50%;
            background: radial-gradient(circle, #0fd9ff 0%, #082534 100%);
            box-shadow: 0 0 8px rgba(0, 210, 255, 0.45);
        }

        .engine-fan.spin {
            animation: fanSpin 0.9s linear infinite;
        }

        @keyframes fanSpin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        /* АНИМАЦИЯ ИСЧЕЗНОВЕНИЯ (Сворачивание в центр) */
        @keyframes collapse-in {
            0% { opacity: 1; transform: scale(1); }
            100% { opacity: 0; transform: scale(0); }
        }

        .dashboard-collapsed {
            animation: collapse-in 0.5s forwards; /* forwards сохраняет конечное состояние (скрыто) */
            pointer-events: none; /* Чтобы нельзя было нажать на скрытые элементы */
        }

        /* Скрываем кнопку по умолчанию, пока JS не покажет её */
        #engine-btn-wrapper {
            display: none; 
        }
        /* АНИМАЦИЯ ПОЯВЛЕНИЯ (Расходятся по местам) */
        @keyframes expand-out {
            0% { opacity: 0; transform: scale(0.5) translateY(-50px); }
            100% { opacity: 1; transform: scale(1) translateY(0); }
        }

        .dashboard-expanded {
            animation: expand-out 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }
        #engine-btn-wrapper {
        position: fixed; /* Фиксируем на экране, чтобы она плавала */
        top: 20%;        /* Начальная позиция сверху */
        left: 50%;       /* Начальная позиция слева */
        transform: translate(-50%, -50%); /* Центровка */
        z-index: 9999;   /* Поверх всех остальных элементов */
        cursor: grab;    /* Курсор в виде "лапки" */
        
        /* Убираем отступы, если они были */
        margin: 0;
        padding: 0;
        }

        #engine-btn-wrapper:active {
        cursor: grabbing; /* Когда тащим - лапка сжимается */
        }
        /* --- EXCEL-LIKE FILTER STYLES --- */
        .filter-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }

        .filter-icon {
            color: #adb5bd;
            font-size: 0.8rem;
            margin-left: 5px;
            transition: color 0.2s;
        }

        .filter-icon:hover, .filter-icon.active {
            color: #0d6efd; /* Синий цвет при наведении или активности */
        }

        .filter-dropdown-menu {
            max-height: 300px;
            overflow-y: auto;
            min-width: 200px;
            padding: 10px;
            font-size: 0.9rem;
            font-weight: normal; /* Чтобы текст в меню не был жирным как в заголовке */
        }

        .filter-checkbox-item {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }

        .filter-checkbox-item input {
            margin-right: 8px;
        }

        /* Professional sidebar section headers */
        .neon-header {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #78909c !important;
            font-weight: 600;
            letter-spacing: 1.5px;
            font-size: 0.75rem;
            transition: all 0.2s ease;
            padding: 8px 0;
            text-transform: uppercase;
        }

        .neon-header i {
            font-size: 0.7rem;
            color: #546e7a;
            transition: all 0.2s ease;
        }

        .neon-header:hover {
            color: #90caf9 !important;
        }
        
        .neon-header:hover i {
            color: #90caf9;
            transform: rotate(90deg);
        }
        
        /* --- DELETE BUTTON STYLES --- */
        .delete-col {
            background-color: #fff3cd !important;
            vertical-align: middle !important;
        }
        
        .delete-col .btn-danger {
            padding: 2px 6px;
            font-size: 0.75rem;
            transition: all 0.2s;
        }
        
        .delete-col .btn-danger:hover {
            transform: scale(1.1);
            box-shadow: 0 2px 8px rgba(220, 53, 69, 0.4);
        }
        /* === AUTHENTICATION STYLES === */
        .login-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: url('/static/assets/login-bg.jpg') center / cover no-repeat fixed;
            background-color: #1a1a1a;
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            will-change: background;
            contain: layout style paint;
        }
        
        .login-modal.show {
            display: flex;
        }

        .login-box {
            background: #ffffff;
            padding: 50px 40px;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.25);
            width: 400px;
            max-width: 90%;
            animation: slideInUp 0.5s ease-out;
        }

        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .login-box h2 {
            text-align: center;
            margin-bottom: 30px;
            color: #1a3a52;
            font-weight: 700;
            font-size: 1.8rem;
            letter-spacing: -0.5px;
        }

        .login-box h2 i {
            color: #3b82f6;
            margin-right: 8px;
        }

        .login-error {
            background: rgba(220, 53, 69, 0.1);
            color: #d32f2f;
            padding: 12px 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            display: none;
            border-left: 4px solid #d32f2f;
            font-weight: 500;
        }

        #login-form .form-label {
            color: #1a3a52;
            font-weight: 600;
            font-size: 0.95rem;
            margin-bottom: 8px;
        }

        #login-form .form-control {
            border: 1.5px solid #e5e7eb;
            border-radius: 8px;
            padding: 12px 15px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background-color: #f9fafb;
        }

        #login-form .form-control:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
            background-color: #ffffff;
            outline: none;
        }

        #login-form .mb-3 {
            margin-bottom: 18px;
        }

        #login-form .btn {
            margin-top: 15px;
            padding: 12px;
            font-weight: 600;
            border-radius: 8px;
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            border: none;
            transition: all 0.3s ease;
            font-size: 1rem;
            color: white;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        #login-form .btn:hover {
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(59, 130, 246, 0.4);
        }

        #login-form .btn:active {
            transform: translateY(0);
        }

        /* User Header Bar */
        .user-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 60px;
            padding: 0 20px;
            display: flex;
            justify-content: flex-end;
            align-items: center;
            gap: 10px;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(0, 0, 0, 0.08);
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.06);
        }

        .user-icon-btn {
            position: relative;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px solid #ddd;
            background: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .user-icon-btn:hover {
            border-color: #007bff;
            transform: scale(1.05);
        }

        #user-profile-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: bold;
            font-size: 14px;
            border: none;
        }

        .notification-badge {
            position: absolute;
            top: -4px;
            right: -4px;
            min-width: 18px;
            height: 18px;
            background: #dc3545;
            color: white;
            border-radius: 3px;
            font-size: 11px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s;
            padding: 0 4px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        .notification-badge.show {
            opacity: 1;
            visibility: visible;
        }

        #add-user-btn {
            display: none;
            padding: 8px 16px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s;
        }

        #add-user-btn:hover {
            background: #218838;
        }

        /* Profile Dropdown */
        .profile-dropdown {
            position: fixed;
            top: 65px;
            right: 20px;
            width: 280px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
            display: none;
            z-index: 10001;
        }

        .profile-dropdown.show {
            display: block;
            animation: dropdownSlide 0.2s ease;
        }

        /* Force readable text in profile dropdown */
        #profile-dropdown,
        #profile-dropdown * {
            color: #0b0f19 !important;
        }

        @keyframes dropdownSlide {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .profile-header {
            padding: 20px;
            border-bottom: 1px solid #eee;
            text-align: center;
        }

        .profile-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: bold;
            margin: 0 auto 10px;
        }

        .profile-name {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .profile-position {
            font-size: 13px;
            color: #666;
            margin-bottom: 8px;
        }

        .profile-role {
            display: inline-block;
            padding: 4px 12px;
            background: #e3f2fd;
            color: #1976d2;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .profile-menu {
            padding: 8px 0;
        }

        .profile-menu-item {
            padding: 12px 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: background 0.2s;
        }

        .profile-menu-item:hover {
            background: #f8f9fa;
        }

        .profile-menu-item i {
            width: 20px;
            text-align: center;
            color: #666;
        }

        /* Notifications Panel */
        .notifications-panel {
            position: fixed;
            top: 65px;
            right: 20px;
            width: 360px;
            max-height: 500px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
            display: none;
            z-index: 10000;
        }

        /* Force readable text in notifications panel */
        #notifications-panel,
        #notifications-panel * {
            color: #0b0f19 !important;
        }

        /* User management modal: readable text and light inputs (scoped) */
        #user-manage-modal .modal-body,
        #user-manage-modal .modal-body * {
            color: #0b0f19 !important;
        }
        #user-manage-modal .form-control,
        #user-manage-modal .form-select {
            background: #ffffff !important;
            color: #0b0f19 !important;
            border-color: #ced4da;
        }

        .notifications-panel.show {
            display: flex;
            flex-direction: column;
            animation: dropdownSlide 0.2s ease;
        }

        .notifications-header {
            padding: 16px 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .notifications-header h5 {
            margin: 0;
            font-size: 16px;
            font-weight: 600;
        }

        .mark-all-read {
            color: #007bff;
            cursor: pointer;
            font-size: 13px;
            text-decoration: none;
        }

        .mark-all-read:hover {
            text-decoration: underline;
        }

        .notifications-list {
            overflow-y: auto;
            max-height: 440px;
        }

        .notification-item {
            padding: 16px 20px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: background 0.2s;
        }

        .notification-item:hover {
            background: #f8f9fa;
        }

        .notification-item.unread {
            background: #f0f7ff;
        }

        .notification-item.unread:hover {
            background: #e3f2fd;
        }

        .notification-time {
            font-size: 12px;
            color: #999;
            margin-top: 6px;
        }
        
        /* Store Condition Color Styles */
        #store-condition.sv-sent {
            background-color: #28a745 !important;
            color: white !important;
            font-weight: bold;
        }
        #store-condition.under-repair {
            background-color: #0056b3 !important;
            color: white !important;
            font-weight: bold;
        }
        #store-condition.delivered-roma {
            background-color: #90ee90 !important;
            color: black !important;
            font-weight: bold;
        }
        #store-condition.no-capability {
            background-color: #dc3545 !important;
            color: white !important;
            font-weight: bold;
        }
        #store-condition.us-shj {
            background-color: #ffc107 !important;
            color: black !important;
            font-weight: bold;
        }

        /* === 3D PARTS CARDS === */
        :root {
            --parts-card-height: 200px;
            --parts-card-width: 49%;
        }
        .parts-cards-section {
            margin-top: 2.5rem;
            margin-bottom: 2rem;
            position: relative;
            z-index: 1;
            padding: 0 1rem;
        }

        /* Horizontal layout with equal distribution */
        .parts-dashboard-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
            align-items: stretch;
            width: 100%;
            position: relative;
            z-index: 1;
            overflow: visible;
        }

        .parts-dashboard-grid .parts-cards-grid {
            display: contents;
        }

        .parts-dashboard-grid .parts-cards-grid .parts-card-wrapper {
            display: flex;
            flex-direction: column;
            min-width: 0;
            position: relative;
            z-index: 2;
        }

        .parts-dashboard-grid .parts-cards-grid .parts-card-wrapper .parts-card-3d {
            width: 100%;
            flex: 1;
        }

        .parts-dashboard-grid .schedule-cards-grid {
            display: contents;
        }

        .parts-dashboard-grid .schedule-card-wrapper {
            display: flex;
            flex-direction: column;
            min-width: 0;
            position: relative;
            z-index: 2;
        }

        .parts-dashboard-grid .schedule-card-wrapper .parts-card-3d {
            width: 100%;
            flex: 1;
        }

        @media (max-width: 992px) {
            .parts-dashboard-grid {
                flex-direction: column;
            }
            .parts-dashboard-grid .parts-cards-grid {
                flex: 1 1 auto;
            }
            .parts-dashboard-grid .parts-cards-grid .parts-card-wrapper {
                flex-basis: 100%;
            }
        }

        .parts-card-3d {
            position: relative;
            height: var(--parts-card-height, 280px);
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 20px;
            padding: 1.5rem;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            transform-style: preserve-3d;
            perspective: 1000px;
            box-shadow: 0 10px 40px rgba(102, 126, 234, 0.3);
            overflow: visible;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            z-index: 2;
        }

        .parts-card-3d::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0) 100%);
            opacity: 0;
            transition: opacity 0.3s;
        }

        .parts-card-3d:hover::before {
            opacity: 1;
        }

        .parts-card-3d:hover {
            transform: translateY(-10px) rotateX(5deg);
            box-shadow: 0 20px 60px rgba(102, 126, 234, 0.5);
            z-index: 50;
        }

        .parts-card-3d.card-green {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            box-shadow: 0 10px 40px rgba(17, 153, 142, 0.3);
        }

        .parts-card-3d.card-green:hover {
            box-shadow: 0 20px 60px rgba(17, 153, 142, 0.5);
        }

        .parts-card-icon {
            position: absolute;
            right: 1.5rem;
            top: 1.5rem;
            transform: none;
            font-size: 1.75rem;
            color: rgba(255, 255, 255, 0.3);
            transition: all 0.3s;
        }

        .parts-card-3d:hover .parts-card-icon {
            transform: translateY(-50%) scale(1.1) rotate(10deg);
            color: rgba(255, 255, 255, 0.25);
        }

        .parts-card-content {
            position: relative;
            z-index: 2;
            color: white;
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
        }

        .parts-card-title {
            font-family: 'Inter', 'Segoe UI', system-ui, -apple-system, sans-serif;
            font-size: 1.2rem;
            font-weight: 700;
            letter-spacing: -0.01em;
            margin-bottom: 0.25rem;
            text-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .parts-card-subtitle {
            font-family: 'Inter', 'Segoe UI', system-ui, -apple-system, sans-serif;
            font-size: 0.8rem;
            opacity: 0.85;
            font-weight: 400;
        }

        .parts-card-count {
            position: relative;
            font-family: 'Inter', 'Segoe UI', system-ui, -apple-system, sans-serif;
            font-size: 3.5rem;
            font-weight: 900;
            letter-spacing: -0.04em;
            color: rgba(255, 255, 255, 1);
            text-shadow: 0 2px 15px rgba(0,0,0,0.2);
            line-height: 1;
            margin-top: auto;
            padding-top: 1.5rem;
        }

        /* Parts Modal */
        .parts-modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 10000;
            backdrop-filter: blur(4px);
        }

        .parts-modal-overlay.show {
            display: flex;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s;
        }

        .parts-modal-content {
            background: white;
            border-radius: 20px;
            width: 90%;
            max-width: 1200px;
            max-height: 85vh;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            animation: slideUp 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .parts-modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1.5rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .parts-modal-header.green {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        }

        .parts-modal-header h4 {
            margin: 0;
            font-weight: 700;
        }

        .parts-modal-close {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.5rem;
            transition: all 0.3s;
        }

        .parts-modal-close:hover {
            background: rgba(255,255,255,0.3);
            transform: rotate(90deg);
        }

        .parts-modal-body {
            padding: 2rem;
            max-height: calc(85vh - 100px);
            overflow-y: auto;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideUp {
            from { 
                opacity: 0;
                transform: translateY(50px) scale(0.95); 
            }
            to { 
                opacity: 1;
                transform: translateY(0) scale(1); 
            }
        }

        /* ENGINE HISTORY TIMELINE STYLES */
        .timeline-container {
            position: relative;
            padding: 20px 0;
            max-width: 1200px;
            margin: 0 auto;
        }

        .timeline-header {
            text-align: center;
            margin-bottom: 30px;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .timeline-header h5 {
            margin: 0;
            font-weight: 600;
        }

        .timeline-header .engine-meta {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-top: 10px;
            font-size: 0.9rem;
        }

        .timeline-line {
            position: absolute;
            left: 50%;
            top: 0;
            bottom: 0;
            width: 3px;
            background: linear-gradient(to bottom, #667eea, #764ba2);
            transform: translateX(-50%);
        }

        .timeline-event {
            position: relative;
            margin-bottom: 30px;
            display: flex;
            align-items: flex-start;
        }

        .timeline-event:nth-child(odd) {
            flex-direction: row;
        }

        .timeline-event:nth-child(even) {
            flex-direction: row-reverse;
        }

        .timeline-date {
            width: 45%;
            text-align: right;
            padding-right: 30px;
            font-weight: 600;
            color: #666;
            padding-top: 15px;
        }

        .timeline-event:nth-child(even) .timeline-date {
            text-align: left;
            padding-left: 30px;
            padding-right: 0;
        }

        .timeline-icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.3rem;
            color: white;
            z-index: 10;
            flex-shrink: 0;
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
        }

        .timeline-icon.install { background: linear-gradient(135deg, #11998e, #38ef7d); }
        .timeline-icon.remove { background: linear-gradient(135deg, #ee0979, #ff6a00); }
        .timeline-icon.repair { background: linear-gradient(135deg, #f093fb, #f5576c); }
        .timeline-icon.ship { background: linear-gradient(135deg, #8e44ad, #3498db); }
        .timeline-icon.part { background: linear-gradient(135deg, #4facfe, #00f2fe); }
        .timeline-icon.atlb { background: linear-gradient(135deg, #43e97b, #38f9d7); }
        .timeline-icon.inspect { background: linear-gradient(135deg, #f39c12, #e67e22); }
        .timeline-icon.param { background: linear-gradient(135deg, #fa709a, #fee140); }

        .timeline-content {
            width: 45%;
            padding: 15px 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 3px 15px rgba(0,0,0,0.1);
            border-left: 4px solid #667eea;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .timeline-event:nth-child(even) .timeline-content {
            border-left: none;
            border-right: 4px solid #667eea;
        }

        .timeline-content:hover {
            box-shadow: 0 5px 25px rgba(0,0,0,0.15);
            transform: translateY(-2px);
            background: linear-gradient(to right, #ffffff, #f8f9ff);
        }

        .timeline-content h6 {
            margin: 0 0 8px 0;
            color: #333;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .timeline-content h6::after {
            content: '→';
            opacity: 0;
            transition: opacity 0.3s ease, transform 0.3s ease;
            transform: translateX(-10px);
            color: #667eea;
            font-weight: bold;
            font-size: 1.2rem;
        }

        .timeline-content:hover h6::after {
            opacity: 1;
            transform: translateX(0);
        }

        /* Ensure preview modal stacks above history */
        .table-preview-modal { z-index: 1065 !important; }

        .timeline-content .badge {
            font-size: 0.75rem;
            padding: 4px 8px;
        }

        .timeline-details {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #eee;
            font-size: 0.85rem;
            color: #666;
        }

        .timeline-details strong {
            color: #333;
        }

        .timeline-no-data {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        @media (max-width: 768px) {
            .timeline-line { left: 25px; }
            .timeline-event { flex-direction: column !important; }
            .timeline-date, .timeline-content { width: 100%; text-align: left !important; padding-left: 70px !important; padding-right: 0 !important; }
            .timeline-icon { position: absolute; left: 0; }
        }

        /* ===== CALENDAR STYLES ===== */
        .calendar-grid-container {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 10px;
            min-height: 600px;
        }

        .calendar-header-cell {
            text-align: center;
            font-weight: 600;
            font-size: 0.9rem;
            color: #495057;
            padding: 12px 8px;
            background: #f8f9fa;
            border-radius: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .calendar-day-cell {
            min-height: 120px;
            padding: 10px;
            border: 1px solid #e9ecef;
            border-radius: 10px;
            background: #ffffff;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .calendar-day-cell:hover {
            background: #f8f9ff;
            border-color: #667eea;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.15);
        }

        .calendar-day-cell.other-month {
            background: #fafbfc;
            opacity: 0.5;
        }

        .calendar-day-cell.today {
            border: 2px solid #667eea;
            background: linear-gradient(135deg, #f8f9ff 0%, #ffffff 100%);
        }

        .calendar-day-number {
            font-size: 1rem;
            font-weight: 600;
            color: #495057;
            margin-bottom: 8px;
        }

        .calendar-day-cell.today .calendar-day-number {
            color: #667eea;
            font-weight: 700;
        }

        .calendar-events-list {
            flex: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .calendar-event-badge {
            padding: 6px 8px;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 500;
            color: white;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            position: relative;
        }

        .calendar-event-badge:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 10;
        }

        .calendar-event-badge i {
            font-size: 0.7rem;
            flex-shrink: 0;
        }

        .calendar-event-badge.event-shipment { background: linear-gradient(135deg, #8e44ad, #3498db); }
        .calendar-event-badge.event-meeting { background: linear-gradient(135deg, #11998e, #38ef7d); }
        .calendar-event-badge.event-inspection { background: linear-gradient(135deg, #f39c12, #e67e22); }
        .calendar-event-badge.event-maintenance { background: linear-gradient(135deg, #ee0979, #ff6a00); }
        .calendar-event-badge.event-deadline { background: linear-gradient(135deg, #fa709a, #fee140); }
        .calendar-event-badge.event-boroscope { background: linear-gradient(135deg, #1fa2ff, #12d8fa); }
        .calendar-event-badge.event-other { background: linear-gradient(135deg, #667eea, #764ba2); }

        .calendar-event-badge.event-completed {
            background: linear-gradient(135deg, #95a5a6, #bdc3c7) !important;
            opacity: 0.6;
            text-decoration: line-through;
        }

        /* Pulsing animations for urgent events */
        @keyframes pulse-warning {
            0%, 100% { opacity: 0.8; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.02); }
        }

        @keyframes pulse-danger {
            0%, 100% { opacity: 0.5; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.03); }
        }

        .calendar-event-badge.event-urgent-2days {
            animation: pulse-warning 2s ease-in-out infinite;
        }

        .calendar-event-badge.event-urgent-1day {
            animation: pulse-danger 1s ease-in-out infinite;
            background: linear-gradient(135deg, #ff4757, #ff6348) !important;
            font-weight: 600;
        }

        .calendar-event-time {
            font-size: 0.7rem;
            opacity: 0.9;
        }

        .event-tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 0.85rem;
            z-index: 1000;
            pointer-events: none;
            white-space: normal;
            max-width: 300px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .event-tooltip strong {
            display: block;
            margin-bottom: 4px;
            font-size: 0.95rem;
        }

        /* ============================================================
           LOGISTICS & SCHEDULES STYLES
           ============================================================ */
        
        /* Store Balance - Simplified */
        #store-balance-widget {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(102,126,234,0.3);
        }

        #store-balance-widget h4 {
            margin-bottom: 15px;
            font-size: 1.1rem;
            font-weight: 600;
        }

        #store-balance-widget .balance-stats {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 1.4em;
        }

        #store-balance-widget .stat-label {
            font-weight: 500;
        }

        #store-balance-widget .stat-value {
            font-weight: bold;
            font-size: 1.6em;
            background: rgba(255,255,255,0.2);
            padding: 8px 20px;
            border-radius: 8px;
        }

        /* Logistics & Movements Card */
        #logistics-movements-widget {
            background: #f8f9fa;
            border: 2px solid #dee2e6;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        #logistics-movements-widget h4 {
            margin-bottom: 15px;
            color: #333;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .movements-summary {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            box-shadow: 0 4px 12px rgba(17,153,142,0.3);
        }

        .movements-summary .main-stat {
            font-size: 1.5em;
            font-weight: bold;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .movements-summary .main-stat .icon {
            font-size: 1.2em;
        }

        .movements-summary .main-stat .value {
            background: rgba(0,0,0,0.25);
            padding: 6px 18px;
            border-radius: 8px;
            font-size: 1.3em;
        }

        .movements-breakdown {
            display: flex;
            flex-direction: column;
            gap: 10px;
            background: rgba(255,255,255,0.15);
            padding: 12px;
            border-radius: 8px;
        }

        .breakdown-item {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.95em;
        }

        .breakdown-item .icon {
            font-size: 1.3em;
        }

        .breakdown-item .label {
            flex: 1;
        }

        .breakdown-item .value {
            font-weight: bold;
            background: rgba(0,0,0,0.25);
            padding: 4px 12px;
            border-radius: 5px;
            font-size: 1.1em;
        }

        /* Schedule Status Section */
        .schedule-summary {
            background: #fff;
            border: 1px solid #dee2e6;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
        }

        .schedule-summary h5 {
            margin-bottom: 12px;
            color: #333;
            font-size: 1rem;
            font-weight: 600;
        }

        .schedule-summary .stat-row {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            border-bottom: 1px solid #f0f0f0;
        }

        .schedule-summary .stat-row:last-child {
            border-bottom: none;
        }

        .schedule-summary .stat-row .icon {
            font-size: 1.2em;
        }

        .schedule-summary .stat-row .label {
            flex: 1;
            font-size: 0.9em;
        }

        .schedule-summary .stat-row .value {
            font-weight: bold;
            background: #007bff;
            color: white;
            padding: 4px 12px;
            border-radius: 5px;
            font-size: 1.1em;
        }

        .stat-row.arriving-soon {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding-left: 15px;
            animation: pulse-glow 2s ease-in-out infinite;
        }

        .stat-row.arriving-soon .value {
            background: #ffc107;
            color: #000;
        }

        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 5px rgba(255,193,7,0.5); }
            50% { box-shadow: 0 0 15px rgba(255,193,7,0.8); }
        }

        .btn-open-logistics {
            width: 100%;
            padding: 14px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            margin-top: 15px;
            transition: all 0.3s;
            box-shadow: 0 2px 8px rgba(0,123,255,0.3);
        }

        .btn-open-logistics:hover {
            background: #0056b3;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,123,255,0.5);
        }

        /* Main Action Button (Right Side) */
        .logistics-shipments-button {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
            color: white;
            border-radius: 12px;
            padding: 0;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(238,90,111,0.4);
            transition: all 0.3s;
            margin-bottom: 20px;
        }

        .btn-logistics-main {
            background: transparent;
            color: white;
            font-size: 1.2em;
            padding: 22px;
            border: none;
            cursor: pointer;
            width: 100%;
            text-align: center;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn-logistics-main:hover {
            transform: translateY(-3px);
        }

        .btn-logistics-main .subtitle {
            display: block;
            font-size: 0.7em;
            opacity: 0.9;
            margin-top: 6px;
            font-weight: 400;
        }

        .quick-stats {
            display: flex;
            flex-direction: column;
            gap: 10px;
            padding: 15px;
            background: rgba(255,255,255,0.95);
        }

        .quick-stats .stat {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9em;
            color: #333;
            padding: 5px 0;
        }

        .quick-stats .stat .label {
            font-weight: 500;
        }

        .quick-stats .stat .value {
            font-weight: bold;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 5px 14px;
            border-radius: 5px;
        }

        /* Schedules Modal */
        #schedules-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1040; /* Below Bootstrap modals/backdrop (1050/1055) so status/edit pop over */
            justify-content: center;
            align-items: center;
        }

        #schedules-modal.active {
            display: flex;
        }

        .schedules-modal-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            max-width: 95%;
            width: 1200px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }

        .schedules-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            border-bottom: 2px solid #dee2e6;
            padding-bottom: 15px;
        }

        .schedules-modal-header h3 {
            margin: 0;
            color: #333;
            font-weight: 600;
        }

        .btn-close-modal {
            background: #dc3545;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn-close-modal:hover {
            background: #c82333;
        }

        /* Tabs for Schedules Modal */
        .schedules-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
            border-bottom: 2px solid #dee2e6;
        }

        .schedules-tab {
            padding: 12px 25px;
            background: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-size: 1em;
            font-weight: 500;
            color: #666;
            transition: all 0.3s;
        }

        .schedules-tab.active {
            color: #007bff;
            border-bottom-color: #007bff;
        }

        .schedules-tab:hover {
            color: #007bff;
        }

        .tab-content-schedules {
            display: none;
        }

        .tab-content-schedules.active {
            display: block;
        }

        /* Type Selector Buttons */
        .type-selector-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
            max-width: 600px;
            margin: 0 auto;
        }

        .btn-type-selector {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 25px;
            font-size: 1.2em;
            border: 2px solid #dee2e6;
            border-radius: 10px;
            background: linear-gradient(135deg, #e0e7ff 0%, #cfd9ff 100%);
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
        }

        .btn-type-selector:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(102,126,234,0.4);
            border-color: #667eea;
        }

        .btn-type-selector .icon {
            font-size: 2em;
        }

        .btn-type-selector .text-container {
            text-align: left;
        }

        .btn-type-selector .title {
            display: block;
            font-size: 1em;
            margin-bottom: 5px;
        }

        .btn-type-selector .subtitle {
            display: block;
            font-size: 0.7em;
            opacity: 0.8;
            font-weight: 400;
        }

        /* Schedules Table */
        #schedules-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        #schedules-table th {
            background: #f8f9fa;
            padding: 12px;
            text-align: left;
            border-bottom: 2px solid #dee2e6;
            font-weight: 600;
            font-size: 0.9em;
        }

        #schedules-table td {
            padding: 12px;
            border-bottom: 1px solid #f0f0f0;
            font-size: 0.9em;
        }

        #schedules-table tbody tr:hover {
            background: #f8f9fa;
            cursor: pointer;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 5px;
            font-size: 0.85em;
            font-weight: 600;
        }

        .status-PLANNED {
            background: #fff3cd;
            color: #856404;
        }

        .status-IN_TRANSIT {
            background: #cfe2ff;
            color: #084298;
        }

        .status-DELIVERED {
            background: #d1e7dd;
            color: #0f5132;
        }

        .status-DELAYED {
            background: #f8d7da;
            color: #842029;
        }

        .status-CANCELLED {
            background: #e2e3e5;
            color: #41464b;
        }

        /* ========================= */
        /* BOROSCOPE SCHEDULE MODAL */
        /* ========================= */
        #boroscope-schedule-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        #boroscope-schedule-modal.active {
            display: flex;
        }

        #boroscope-schedule-modal .modal-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            cursor: pointer;
        }

        .boroscope-modal-content {
            position: relative;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            max-width: 600px;
            width: 95%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .boroscope-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 2px solid #dee2e6;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 12px 12px 0 0;
        }

        .boroscope-modal-header h3 {
            margin: 0;
            color: white;
            font-weight: 600;
            font-size: 1.3em;
        }

        #boroscope-schedule-modal .btn-close-modal {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        #boroscope-schedule-modal .btn-close-modal:hover {
            background: rgba(255, 255, 255, 0.4);
        }

        #boroscope-schedule-form .form-label {
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
        }

        #boroscope-schedule-form .form-control,
        #boroscope-schedule-form .form-select {
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 8px 12px;
            font-size: 0.95em;
        }

        #boroscope-schedule-form .form-control:focus,
        #boroscope-schedule-form .form-select:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        /* === ENGINE DETAILS MODAL === */
        #engine-details-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(11, 17, 32, 0.95) 0%, rgba(15, 23, 42, 0.98) 100%);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            z-index: 10000;
            overflow-y: auto;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .engine-details-container {
            max-width: 1600px;
            margin: 30px auto;
            padding: 30px;
        }

        .engine-details-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding: 20px 30px;
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            border-radius: 16px;
            box-shadow: 0 4px 24px rgba(0, 0, 0, 0.5);
        }

        .engine-details-header h2 {
            color: #f1f5f9;
            font-size: 2.2rem;
            font-weight: 800;
            margin: 0;
            letter-spacing: 0.5px;
        }

        .engine-details-header .aircraft-info {
            color: #94a3b8;
            font-size: 0.9rem;
            margin-top: 5px;
        }

        .btn-close-engine-modal {
            background: rgba(239, 68, 68, 0.9);
            border: none;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn-close-engine-modal:hover {
            background: rgba(239, 68, 68, 1);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4);
        }

        /* Engine Modal Content Container */
        #engine-modal-content {
            width: 100%;
        }

        /* Engine Position Cards (Top Row - Clickable) */
        .engine-positions-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 24px;
            margin-bottom: 40px;
        }

        .engine-pos-card {
            background: linear-gradient(135deg, #1f7a4d 0%, #2bc66d 100%);
            border-radius: 20px;
            padding: 32px 24px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 12px 40px rgba(43, 198, 109, 0.3);
            border: 2px solid transparent;
            position: relative;
            overflow: hidden;
        }

        .engine-pos-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0) 100%);
            opacity: 0;
            transition: opacity 0.3s;
        }

        .engine-pos-card:hover::before {
            opacity: 1;
        }

        .engine-pos-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 32px rgba(43, 198, 109, 0.4);
            border-color: rgba(255, 255, 255, 0.3);
        }

        .engine-pos-card.selected {
            border-color: #fbbf24;
            box-shadow: 0 12px 32px rgba(251, 191, 36, 0.5);
        }

        .engine-pos-card.empty {
            background: linear-gradient(135deg, #334155 0%, #475569 100%);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
            cursor: default;
            opacity: 0.6;
        }

        .engine-pos-card.empty:hover {
            transform: none;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
        }

        .engine-pos-title {
            font-size: 1.6rem;
            font-weight: 800;
            color: #ffffff;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .engine-pos-sn {
            font-size: 1.15rem;
            color: rgba(255, 255, 255, 0.9);
            font-weight: 600;
        }

        .engine-pos-empty-text {
            color: rgba(255, 255, 255, 0.5);
            font-style: italic;
        }

        /* Engine Details Grid (Bottom - Parameters) */
        .engine-details-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            padding: 30px;
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
        }

        .engine-detail-item {
            background: rgba(15, 23, 42, 0.6);
            padding: 20px;
            border-radius: 12px;
            border-left: 4px solid #3b82f6;
            transition: all 0.3s;
        }

        .engine-detail-item:hover {
            background: rgba(15, 23, 42, 0.8);
            transform: translateX(4px);
        }

        .engine-detail-label {
            font-size: 0.8rem;
            color: #94a3b8;
            text-transform: uppercase;
            letter-spacing: 1.2px;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .engine-detail-value {
            font-size: 1.3rem;
            color: #f1f5f9;
            font-weight: 700;
        }

        .engine-detail-value.highlight {
            color: #fbbf24;
            font-size: 1.5rem;
        }

        /* Selector bar → Action Buttons */
        .engine-selector-bar {
            display: flex;
            align-items: center;
            gap: 16px;
            background: #0b1324;
            border-radius: 12px;
            padding: 14px 20px;
            margin: 20px 0;
            justify-content: center;
            border: 1px solid rgba(71, 85, 105, 0.3);
        }
        .engine-action-btn {
            background: linear-gradient(135deg, #3b82f6 0%, #1e40af 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 10px;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }
        .engine-action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(59, 130, 246, 0.5);
            background: linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%);
        }
        .engine-action-btn:active {
            transform: translateY(0);
        }
        .engine-action-btn.active {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }
        .selector-item, .dot, .label {
            display: none;
        }

        /* Engine Details Sections */
        .engine-section {
            display: none;
            animation: fadeIn 0.3s ease;
        }
        .engine-section.active {
            display: block;
        }

        /* Only the details panels (with three blocks) should be a grid */
        .engine-info-sections.engine-section.active {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 28px;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Engine History Section */
        .engine-history-section {
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            border-radius: 16px;
            padding: 24px;
            margin-top: 10px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
            max-height: 600px;
            overflow-y: auto;
        }

        .history-item {
            display: flex;
            gap: 16px;
            padding: 14px;
            border-left: 4px solid #3b82f6;
            background: rgba(15, 23, 42, 0.6);
            border-radius: 8px;
            margin-bottom: 10px;
        }
        .history-item.install { border-left-color: #10b981; }
        .history-item.remove { border-left-color: #ef4444; }
        .history-item.boroscope { border-left-color: #f59e0b; }

        .history-date {
            font-weight: 700;
            color: #60a5fa;
            min-width: 120px;
            font-size: 0.9rem;
        }
        .history-action {
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 1px;
            padding: 4px 8px;
            border-radius: 4px;
            background: rgba(59, 130, 246, 0.2);
            color: #60a5fa;
            min-width: 80px;
            text-align: center;
        }
        .history-action.install {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
        }
        .history-action.remove {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }
        .history-detail {
            flex: 1;
            color: #cbd5e1;
            font-size: 0.95rem;
        }

        /* Analytics Section */
        .analytics-section {
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            border-radius: 16px;
            padding: 24px;
            margin-top: 10px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
        }

        .analytics-tabs {
            display: flex;
            gap: 10px;
            border-bottom: 2px solid rgba(71, 85, 105, 0.4);
            padding-bottom: 14px;
            margin-bottom: 20px;
        }
        .tab-btn {
            background: transparent;
            border: none;
            color: #cbd5e1;
            padding: 10px 16px;
            cursor: pointer;
            font-weight: 600;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
        }
        .tab-btn:hover { color: #e2e8f0; }
        .tab-btn.active {
            color: #60a5fa;
            border-bottom-color: #60a5fa;
        }

        /* Limit tab visibility control to analytics section to avoid hiding Bootstrap tabs elsewhere */
        .analytics-section .tab-content {
            display: none;
        }
        .analytics-section .tab-content.active {
            display: block;
        }

        /* Make settings modal text readable (scoped to settings only) */
        #settings-modal .modal-body,
        #settings-modal .modal-body * {
            color: #0b0f19 !important;
        }
        #settings-modal .nav-link {
            color: #0b0f19 !important;
        }
        #settings-modal .nav-link.active {
            color: #0b0f19 !important;
        }

        .chart-container {
            background: rgba(15, 23, 42, 0.6);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            position: relative;
            height: 350px;
        }

        .chart-filters {
            display: flex;
            gap: 12px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        .filter-checkbox {
            display: flex;
            align-items: center;
            gap: 6px;
            color: #cbd5e1;
            cursor: pointer;
        }
        .filter-checkbox input {
            cursor: pointer;
            width: 18px;
            height: 18px;
        }

        /* Three-panels layout */
        .engine-info-sections {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 28px;
        }
        .engine-panel {
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            border-radius: 20px;
            padding: 28px 32px;
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.6);
            border: 1px solid rgba(71, 85, 105, 0.4);
        }
        .engine-panel .panel-title {
            font-weight: 800; color: #e2e8f0; margin-bottom: 16px; font-size: 1.35rem; letter-spacing: 0.5px;
        }
        .engine-panel .panel-title.small { font-size: 1.1rem; opacity: .9; font-weight: 700; }
        .engine-panel .panel-row {
            display: flex; justify-content: space-between; align-items: center;
            padding: 14px 0; border-bottom: 1px dashed rgba(148, 163, 184, 0.25);
        }
        .engine-panel .panel-row:last-child { border-bottom: none; }
        .engine-panel .row-label { color: #cbd5e1; font-size: 1rem; font-weight: 500; }
        .engine-panel .row-value { color: #f8fafc; font-weight: 700; font-size: 1.3rem; }
        .engine-panel .row-value.cyan { color: #00d9ff; }
        .engine-panel .row-value.blue { color: #0099ff; }
        .engine-panel .row-value.green { color: #00ff66; }
        .engine-panel .row-value.lime { color: #86efac; }
        .engine-panel .panel-divider { height: 12px; }
        .engine-panel .report-link { color: #60a5fa; text-decoration: none; }
        .engine-panel .report-link:hover { text-decoration: underline; }

        /* Loading State */
        .engine-loading {
            text-align: center;
            padding: 60px;
            color: #94a3b8;
        }

        .engine-loading .spinner {
            display: inline-block;
            width: 50px;
            height: 50px;
            border: 4px solid rgba(148, 163, 184, 0.2);
            border-top-color: #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .engine-loading p {
            margin-top: 20px;
            font-size: 1.1rem;
        }

        /* Error State */
        .engine-error {
            text-align: center;
            padding: 60px;
            color: #ef4444;
            background: rgba(239, 68, 68, 0.1);
            border-radius: 12px;
            border: 2px dashed #ef4444;
        }

        .engine-error i {
            font-size: 3rem;
            margin-bottom: 20px;
        }

        .engine-error p {
            font-size: 1.1rem;
            font-weight: 600;
        }

    </style>
    <style>
        /* Extra spacing to avoid overlap for Nameplate tracker blocks */
        .np-table-wrap { margin-bottom: 1.5rem; }
        
        /* Inspection Photos Table Styles */
        .inspection-photo-cell {
            position: relative;
            min-height: 150px;
            border: 2px dashed #ccc;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #f8f9fa;
        }
        
        .inspection-photo-cell:hover {
            border-color: #0d6efd;
            background: #e7f1ff;
        }
        
        .inspection-photo-cell.has-photo {
            border-style: solid;
            border-color: #198754;
            padding: 0;
        }
        
        .inspection-photo-preview {
            max-width: 100%;
            max-height: 150px;
            object-fit: contain;
        }
        
        .inspection-photo-placeholder {
            text-align: center;
            color: #6c757d;
            font-size: 14px;
        }
        
        .inspection-photo-remove {
            position: absolute;
            top: 5px;
            right: 5px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 10;
        }
        
        .inspection-photo-remove:hover {
            background: #bb2d3b;
        }
        
        /* ФИКСАЦИЯ ВЕРХНЕЙ ПАНЕЛИ (navbar) */
        .navbar {
            position: sticky !important;
            top: 0;
            z-index: 1030;
            box-shadow: 0 3px 12px rgba(0, 0, 0, 0.3);
            width: 100%;
            background: linear-gradient(135deg, #0f172a 0%, #1f2937 100%) !important;
            border-bottom: 1px solid rgba(226, 232, 240, 0.08);
            color: #e2e8f0;
        }
        
        body.light-bg .navbar {
            background: #ffffff !important;
            border-bottom: 1px solid #e2e8f0;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            color: #1f2937;
        }
        
        .navbar .d-flex.align-items-center {
            flex-wrap: nowrap;
        }
        
        /* Иконки в navbar: темная и светлая темы */
        .navbar .user-icon-btn {
            flex-shrink: 0;
            min-width: 40px;
            height: 40px;
            border-radius: 8px;
            cursor: pointer;
            color: #cbd5e1;
            background: transparent;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.15s ease, background 0.15s ease, color 0.15s ease, filter 0.15s ease;
        }
        
        .navbar .user-icon-btn:hover {
            background: rgba(255, 255, 255, 0.08) !important;
            color: #e0f2fe;
            transform: translateY(-1px);
        }
        
        body.light-bg .navbar .user-icon-btn {
            color: #475569;
        }
        
        body.light-bg .navbar .user-icon-btn:hover {
            background: rgba(0, 102, 204, 0.1) !important;
            color: #0f172a;
        }
        
        .navbar #add-user-btn {
            background: #22c55e;
            color: #ffffff;
            box-shadow: 0 2px 6px rgba(34, 197, 94, 0.25);
        }
        
        .navbar #add-user-btn:hover {
            filter: brightness(1.05);
            transform: translateY(-1px);
        }
        
        .navbar #notifications-btn {
            position: relative;
        }
        
        .navbar #user-profile-btn {
            background: linear-gradient(135deg, #0ea5e9 0%, #2563eb 100%);
            color: #ffffff;
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.35);
            border-radius: 12px;
        }
        
        .navbar #user-profile-btn:hover {
            filter: brightness(1.08);
            transform: translateY(-1px);
        }
        
        /* ФИКСАЦИЯ ПАНЕЛИ С КНОПКАМИ (Refresh, Edit, Filter) - универсально для всех страниц */
        .card-body > .d-flex.justify-content-between.align-items-center,
        .card-body > .d-flex.justify-content-end.mb-2,
        .card-body > .d-flex[style*="overflow-x"] {
            position: sticky;
            top: 60px;
            z-index: 1020;
            background: #0f172a;
            margin: -15px -15px 15px -15px !important;
            padding: 15px !important;
            border-bottom: 1px solid rgba(148, 163, 184, 0.2);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            flex-wrap: wrap !important;
            gap: 8px !important;
        }
        
        /* Адаптивность кнопок */
        .card-body .btn-sm {
            white-space: nowrap;
            flex-shrink: 0;
        }
        
        /* Поле поиска адаптивное */
        .input-group {
            min-width: 150px !important;
            flex-shrink: 1;
        }
        
        /* ФИКСАЦИЯ ЗАГОЛОВКА ТАБЛИЦЫ при прокрутке */
        .table thead {
            z-index: 1010;
        }
        
        .table thead.table-dark {
            position: sticky;
            top: 120px;
            background: #212529 !important;
        }
        
        .table thead.table-light {
            background: #f8f9fa !important;
        }
        
        /* АДАПТИВНЫЕ ТАБЛИЦЫ - автоперенос текста */
        .table td, .table th {
            word-wrap: break-word;
            word-break: break-word;
            white-space: normal !important;
            max-width: 200px;
            overflow-wrap: break-word;
            vertical-align: middle;
        }
        
        /* Для колонки Remarks / Notes - увеличенная ширина */
        .table td:last-child,
        .table th:last-child {
            max-width: 300px;
            min-width: 150px;
        }
        
        /* Для коротких колонок (чекбоксы, иконки) - без ограничений */
        .table th[style*="width: 40px"],
        .table th[style*="width: 50px"],
        .table td.delete-col,
        .table th.delete-col {
            max-width: none;
            white-space: nowrap !important;
        }
        
        /* Адаптивность таблицы при уменьшении окна */
        @media (max-width: 1400px) {
            .table td, .table th {
                font-size: 0.8rem;
                padding: 0.4rem;
                max-width: 150px;
            }
            
            .card-body .btn-sm {
                font-size: 0.75rem;
                padding: 0.25rem 0.5rem;
            }
            
            .navbar .user-icon-btn {
                width: 36px;
                height: 36px;
                font-size: 0.9rem;
            }
        }
        
        @media (max-width: 1000px) {
            .table td, .table th {
                font-size: 0.75rem;
                padding: 0.3rem;
                max-width: 120px;
            }
            
            .card-body .btn-sm {
                font-size: 0.7rem;
                padding: 0.2rem 0.4rem;
            }
            
            .navbar .user-icon-btn {
                width: 32px;
                height: 32px;
                font-size: 0.8rem;
            }
            
            .input-group {
                max-width: 120px !important;
            }
        }
        
        @media (max-width: 768px) {
            .card-body > .d-flex {
                top: 55px !important;
            }
            
            .table thead {
                top: 110px !important;
            }
            
            .navbar {
                padding: 8px !important;
            }
            
            .user-icon-btn {
                width: 30px;
                height: 30px;
                font-size: 0.75rem;
            }
        }
        
        /* Smooth scroll для всей страницы */
        html {
            scroll-behavior: smooth;
        }
        
        /* Адаптивная ширина для table-responsive */
        .table-responsive {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
    </style>
    <!-- Preload login background for faster loading -->
    <link rel="preload" as="image" href="/static/assets/login-bg.jpg" media="(prefers-reduced-motion: no-preference)">
</head>
<body>

    <!-- Modern GSS Preloader -->
    <div id="aviation-preloader" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #0f172a 100%); z-index: 99999; display: flex; flex-direction: column; justify-content: center; align-items: center; overflow: hidden;">
        <!-- Subtle animated background -->
        <div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: radial-gradient(ellipse at 20% 50%, rgba(79, 195, 247, 0.03) 0%, transparent 50%), radial-gradient(ellipse at 80% 50%, rgba(71, 184, 255, 0.03) 0%, transparent 50%); animation: subtle-shift 8s ease-in-out infinite;"></div>
        
        <!-- Main container -->
        <div style="position: relative; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 50px; z-index: 10; text-align: center;">
            
            <!-- 3D GSS Title -->
            <div id="preloader-title-gss" style="
                font-size: 4.5rem;
                font-weight: 900;
                letter-spacing: 12px;
                background: linear-gradient(135deg, #4fc3f7 0%, #47b8ff 50%, #00bcd4 100%);
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
                background-clip: text;
                text-shadow: 0 0 30px rgba(79, 195, 247, 0.4);
                filter: drop-shadow(0 0 20px rgba(79, 195, 247, 0.3)) drop-shadow(0 10px 20px rgba(0, 0, 0, 0.3));
                opacity: 1;
                transition: opacity 0.6s ease;
                transform: perspective(1000px) rotateX(0deg);
                animation: gss-float 3s ease-in-out infinite;
                line-height: 1;
            ">GSS Engine Shop</div>
            
            <!-- Welcome text (hidden initially) -->
            <div id="preloader-title-welcome" style="
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                font-size: 2.5rem;
                font-weight: 400;
                color: #fff;
                letter-spacing: 2px;
                text-shadow: 0 0 20px rgba(79, 195, 247, 0.5);
                opacity: 0;
                transition: opacity 0.6s ease;
                white-space: nowrap;
            ">Добро пожаловать!</div>
            
            <!-- Progress Container -->
            <div style="position: relative; width: 100%; max-width: 500px; padding: 0 40px;">
                <!-- Label -->
                <div style="font-size: 0.85rem; color: rgba(255, 255, 255, 0.6); margin-bottom: 12px; letter-spacing: 1px; text-transform: uppercase;">Загрузка системы</div>
                
                <!-- Progress Track -->
                <div style="
                    position: relative;
                    width: 100%;
                    height: 6px;
                    background: rgba(255, 255, 255, 0.1);
                    border-radius: 3px;
                    overflow: hidden;
                    border: 1px solid rgba(79, 195, 247, 0.2);
                ">
                    <!-- Progress Bar Fill -->
                    <div id="preloader-progress" style="
                        position: absolute;
                        top: 0;
                        left: 0;
                        height: 100%;
                        background: linear-gradient(90deg, #4fc3f7 0%, #47b8ff 50%, #00bcd4 100%);
                        border-radius: 3px;
                        width: 0%;
                        transition: width 0.15s linear;
                        box-shadow: 0 0 15px rgba(79, 195, 247, 0.6), inset 0 0 8px rgba(255, 255, 255, 0.2);
                    "></div>
                    
                    <!-- Animated Airplane on Progress (Top-Down View) -->
                    <div id="preloader-plane-progress" style="
                        position: absolute;
                        top: 50%;
                        left: 0%;
                        transform: translate(-50%, -50%);
                        transition: left 0.15s linear;
                        z-index: 10;
                    ">
                        <svg width="32" height="32" viewBox="0 0 32 32" style="filter: drop-shadow(0 2px 8px rgba(79, 195, 247, 0.6));">
                            <!-- Fuselage (body) -->
                            <rect x="13" y="2" width="6" height="28" rx="3" fill="#4fc3f7" stroke="#47b8ff" stroke-width="0.8"/>
                            
                            <!-- Wings -->
                            <ellipse cx="16" cy="14" rx="14" ry="6" fill="#e0f7fa" stroke="#4fc3f7" stroke-width="1"/>
                            
                            <!-- Nose cone (pointing right) -->
                            <polygon points="19,2 24,6 19,10" fill="#4fc3f7" stroke="#47b8ff" stroke-width="0.8"/>
                            
                            <!-- Cockpit window -->
                            <circle cx="16" cy="8" r="2" fill="#fff" stroke="#4fc3f7" stroke-width="0.5"/>
                            
                            <!-- Engine glow indicator -->
                            <circle cx="16" cy="4" r="2.5" fill="none" stroke="#47b8ff" stroke-width="1" opacity="0.7">
                                <animate attributeName="r" values="2.5;3.5;2.5" dur="1.5s" repeatCount="indefinite"/>
                                <animate attributeName="opacity" values="0.7;0.3;0.7" dur="1.5s" repeatCount="indefinite"/>
                            </circle>
                            
                            <!-- Landing gear (simple dots) -->
                            <circle cx="12" cy="20" r="1.5" fill="#9e9e9e" stroke="#757575" stroke-width="0.5"/>
                            <circle cx="20" cy="20" r="1.5" fill="#9e9e9e" stroke="#757575" stroke-width="0.5"/>
                        </svg>
                    </div>
                </div>
                
                <!-- Percentage text -->
                <div style="font-size: 0.8rem; color: rgba(255, 255, 255, 0.5); margin-top: 8px; text-align: center;">
                    <span id="preloader-percent">0</span>%
                </div>
            </div>
        </div>
    </div>

    <style>
        @keyframes gss-float {
            0%, 100% { transform: perspective(1000px) rotateX(0deg) translateY(0px); }
            50% { transform: perspective(1000px) rotateX(5deg) translateY(-10px); }
        }
        
        @keyframes subtle-shift {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 0.8; }
        }
    </style>

    <script>
        // Modern GSS Preloader with Smart Logic
        (function() {
            const PRELOADER_STORAGE_KEY = 'gss_preloader_timestamp';
            const PRELOADER_TIMEOUT = 24 * 60 * 60 * 1000; // 24 hours (1 day)
            
            function shouldShowPreloader() {
                const lastTime = localStorage.getItem(PRELOADER_STORAGE_KEY);
                
                // First visit - always show (with flag)
                if (!lastTime) {
                    return { show: true, isFirstVisit: true };
                }
                
                // Check if more than 24 hours have passed
                const now = Date.now();
                const elapsed = now - parseInt(lastTime);
                
                return { show: elapsed > PRELOADER_TIMEOUT, isFirstVisit: false };
            }
            
            function recordPreloaderTime() {
                localStorage.setItem(PRELOADER_STORAGE_KEY, Date.now().toString());
            }
            
            function showPreloader(isFirstVisit = true) {
                const preloader = document.getElementById('aviation-preloader');
                const loginModal = document.getElementById('login-modal');
                const progressBar = document.getElementById('preloader-progress');
                const planeProgress = document.getElementById('preloader-plane-progress');
                const percentText = document.getElementById('preloader-percent');
                const titleGSS = document.getElementById('preloader-title-gss');
                const titleWelcome = document.getElementById('preloader-title-welcome');
                
                // Ensure preloader is visible
                preloader.style.display = 'flex';
                preloader.style.opacity = '1';
                loginModal.classList.remove('show');
                
                let progress = 0;
                // Different durations: 4.5 seconds for first visit, 2 seconds for refresh
                const duration = isFirstVisit ? 4500 : 2000;
                const interval = 40; // Update every 40ms
                const increment = (100 / duration) * interval;
                
                const timer = setInterval(() => {
                    progress += increment;
                    if (progress >= 100) progress = 100;
                    
                    // Update progress bar and plane position
                    progressBar.style.width = progress + '%';
                    planeProgress.style.left = progress + '%';
                    percentText.textContent = Math.floor(progress);
                    
                    // Text swap at 50%
                    if (progress >= 50) {
                        titleGSS.style.opacity = '0';
                        titleWelcome.style.opacity = '1';
                    }
                    
                    // Complete and fade out
                    if (progress >= 100) {
                        clearInterval(timer);
                        setTimeout(() => {
                            preloader.style.opacity = '0';
                            preloader.style.transition = 'opacity 0.6s ease';
                            setTimeout(() => {
                                // Полностью удаляем preloader из потока
                                preloader.style.display = 'none';
                                preloader.style.pointerEvents = 'none';
                                
                                // Only show login modal if user is not already logged in
                                const savedUser = sessionStorage.getItem('currentUser');
                                if (!savedUser) {
                                    loginModal.classList.add('show');
                                }
                                recordPreloaderTime();
                            }, 600);
                        }, 300);
                    }
                }, interval);
            }
            
            function skipPreloader() {
                const preloader = document.getElementById('aviation-preloader');
                const loginModal = document.getElementById('login-modal');
                
                // Hide preloader completely
                preloader.style.display = 'none';
                preloader.style.pointerEvents = 'none';
                
                // Only show login modal if user is not already logged in
                const savedUser = sessionStorage.getItem('currentUser');
                if (!savedUser) {
                    loginModal.classList.add('show');
                }
            }
            
            // Initialize on page load
            window.addEventListener('DOMContentLoaded', function() {
                const preloaderCheck = shouldShowPreloader();
                if (preloaderCheck.show) {
                    showPreloader(preloaderCheck.isFirstVisit);
                } else {
                    skipPreloader();
                }
            }, { once: true });
        })();
    </script>

    <!-- Login Modal -->
    <div id="login-modal" class="login-modal">
        <div class="login-box">
            <h2><i class="bi bi-shield-lock"></i> GSS Engine Shop</h2>
            <div id="login-error" class="login-error"></div>
            <form id="login-form">
                <div class="mb-3">
                    <label class="form-label">Username</label>
                    <input type="text" class="form-control" id="login-username" required autofocus>
                </div>
            
                            <!-- ACTION DETAILS MODAL -->
                            <div id="action-details-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; justify-content: center; align-items: center;">
                                <div style="background: white; border-radius: 8px; max-width: 700px; max-height: 80vh; overflow: auto; box-shadow: 0 4px 20px rgba(0,0,0,0.3); padding: 25px; position: relative;">
                                    <button onclick="closeActionDetailsModal()" style="position: absolute; top: 10px; right: 10px; background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #999;">&times;</button>
                                    <h5 class="mb-4"><i class="bi bi-info-circle me-2"></i>Action Details</h5>
                                    <div id="action-details-content">
                                        <!-- Will be populated by JS -->
                                    </div>
                                </div>
                            </div>
                <div class="mb-3">
                    <label class="form-label">Password</label>
                    <input type="password" class="form-control" id="login-password" required>
                </div>
                <button type="submit" class="btn btn-primary w-100">
                    <i class="bi bi-box-arrow-in-right"></i> Sign In
                </button>
            </form>

        </div>
    </div>

    <!-- Profile Dropdown -->
    <div id="profile-dropdown" class="profile-dropdown">
        <div class="profile-header">
            <div class="profile-avatar" id="profile-avatar">AA</div>
            <div class="profile-name" id="profile-name">Admin User</div>
            <div class="profile-position" id="profile-position">System Administrator</div>
            <span class="profile-role" id="profile-role">admin</span>
        </div>
        <div class="profile-menu">
            <div class="profile-menu-item" onclick="editProfile()">
                <i class="bi bi-person"></i>
                <span>Edit Profile</span>
            </div>
            <div class="profile-menu-item" onclick="changePassword()">
                <i class="bi bi-key"></i>
                <span>Change Password</span>
            </div>
            <div class="profile-menu-item" onclick="logout()">
                <i class="bi bi-box-arrow-right"></i>
                <span>Logout</span>
            </div>
        </div>
    </div>

    <!-- Notifications Panel -->
    <div id="notifications-panel" class="notifications-panel">
        <div class="notifications-header">
            <h5><i class="bi bi-bell"></i> Notifications</h5>
            <a href="#" class="mark-all-read" onclick="markAllNotificationsRead(); return false;">
                Mark all read
            </a>
        </div>
        <div id="notifications-list" class="notifications-list">
            <div class="text-center text-muted py-4">Loading...</div>
        </div>
    </div>

<div id="wrapper">
    <div id="sidebar-wrapper">
        <a href="#" class="sidebar-brand text-white text-decoration-none" onclick="if(typeof openDashboardView === 'function') { openDashboardView(); } return false;">
            <i class="bi bi-gear-fill"></i> Engine Management
        </a>
        <div class="list-group list-group-flush">

            <!-- MASTER DATA ENTRY BUTTON -->
            <div class="px-3 mt-3">
                <a href="#" class="btn btn-neon w-100 text-start mb-2" onclick="openMainEngineView(); return false;">
                    <i class="bi bi-database-add"></i> Add Engine
                </a>
                <a href="#" class="btn btn-neon w-100 text-start mb-2" onclick="openSchedulesModal(); return false;">
                    <i class="bi bi-calendar-check"></i> Open Schedules
                </a>
            </div>
            <!-- REPORTS GROUP (COLLAPSIBLE) -->
            <div class="text-uppercase text-muted small mt-4 mb-2 px-3">
                <div class="neon-header" style="cursor: pointer; user-select: none;" onclick="if(typeof toggleReportsMenu === 'function') { toggleReportsMenu(); }">
                    <i class="bi bi-chevron-right" id="reports-chevron" style="transition: transform 0.3s;"></i>
                    Reports
                </div>
            </div>
            <div id="reports-submenu" style="display: none;">
                <a href="#" class="list-group-item list-group-item-action ps-4" onclick="openBoroscopeView(); return false;">
                    <i class="bi bi-camera-video"></i> Borescope
                </a>
                <a href="#" class="list-group-item list-group-item-action ps-4" onclick="openEngineReportsView(); return false;">
                    <i class="bi bi-clock-history"></i> Engine Reports
                </a>
                <a href="#" class="list-group-item list-group-item-action ps-4" onclick="openPurchaseOrdersView(); return false;">
                    <i class="bi bi-receipt"></i> Purchase Orders
                </a>
                <a href="#" class="list-group-item list-group-item-action ps-4" onclick="openFakeInstalledView(); return false;">
                    <i class="bi bi-exclamation-circle"></i> Fake Installed
                </a>
                <a href="#" class="list-group-item list-group-item-action ps-4" onclick="openNameplateTrackerView(); return false;">
                    <i class="bi bi-tags"></i> Nameplate Tracker
                </a>
            </div>
            
            <div class="text-uppercase text-muted small mt-4 mb-2 px-3">
                <div class="neon-header" style="cursor: pointer; user-select: none;" onclick="toggleActionsMenu()">
                    <i class="bi bi-chevron-down" id="actions-chevron" style="transition: transform 0.3s;"></i>
                    Actions
                </div>
            </div>
            <div id="actions-submenu" style="display: block;">
                <a href="#" class="list-group-item list-group-item-action ps-4" onclick="openInstallView(); return false;"><i class="bi bi-arrow-up-circle"></i> Installation</a>
                <a href="#" class="list-group-item list-group-item-action ps-4" onclick="openRemoveView(); return false;"><i class="bi bi-arrow-down-circle"></i> Remove</a>
                <a href="#" class="list-group-item list-group-item-action ps-4" onclick="openRepairView(); return false;"><i class="bi bi-wrench"></i> Repair</a>
                <a href="#" class="list-group-item list-group-item-action ps-4" onclick="openAtlbView(); return false;"><i class="bi bi-journal-richtext"></i> Utilization (ATLB)</a>
                <a href="#" class="list-group-item list-group-item-action ps-4" onclick="openEngParamView(); return false;"><i class="bi bi-sliders"></i> ENG Parameters</a>
                <a href="#" class="list-group-item list-group-item-action ps-4" onclick="openUtilizationParamView(); return false;"><i class="bi bi-bar-chart-line"></i> Utilization Parameters</a>
                <a href="#" class="list-group-item list-group-item-action ps-4" onclick="openPartsView(); return false;">
                    <i class="bi bi-box-seam"></i> Parts Removal/Installation
                </a>
                <a href="#" class="list-group-item list-group-item-action ps-4" onclick="openGSSModal(); return false;">
                    <i class="bi bi-123"></i> GSS Registry
                </a>
            </div>
            
            <!-- LOGISTICS GROUP (COLLAPSIBLE) -->
            <div class="text-uppercase text-muted small mt-4 mb-2 px-3">
                <div class="neon-header" style="cursor: pointer; user-select: none;" onclick="toggleLogisticsMenu()">
                    <i class="bi bi-chevron-right" id="logistics-chevron" style="transition: transform 0.3s;"></i>
                    Logistics
                </div>
            </div>
            <div id="logistics-submenu" style="display: none;">
                <a href="#" class="list-group-item list-group-item-action ps-4" onclick="openShipmentView(); return false;">
                    <i class="bi bi-truck"></i> Engine Shipment
                </a>
                <a href="#" class="list-group-item list-group-item-action ps-4" onclick="openStoreBalanceView(); return false;">
                    <i class="bi bi-collection"></i> Store Balance
                </a>
            </div>
                
            
        </div>
    </div>

    <!-- Success Notification Modal -->
    <div class="modal fade" id="successModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title"><i class="bi bi-check-circle-fill me-2"></i>Success</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center py-4">
                    <i class="bi bi-check-circle text-success" style="font-size: 3rem;"></i>
                    <p class="mt-3 mb-0" id="successMessage">Operation completed successfully!</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-success" data-bs-dismiss="modal">OK</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Error Notification Modal -->
    <div class="modal fade" id="errorModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="false">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title"><i class="bi bi-exclamation-triangle-fill me-2"></i>Error</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center py-4">
                    <i class="bi bi-x-circle text-danger" style="font-size: 3rem;"></i>
                    <p class="mt-3 mb-0" id="errorMessage">An error occurred!</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- TABLE PREVIEW MODAL (поверх истории) -->
    <div class="modal fade table-preview-modal" id="tablePreviewModal" aria-hidden="true" data-bs-backdrop="true" data-bs-keyboard="true" style="z-index: 1065;">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header" id="tablePreviewHeader" style="background: linear-gradient(135deg, #667eea, #764ba2); color: white;">
                    <h5 class="modal-title" id="tablePreviewTitle"><i class="bi bi-table me-2"></i>Table Preview</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="tablePreviewBody">
                    <div class="text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="text-muted mt-3">Loading table data...</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ENGINE HISTORY TIMELINE MODAL -->
    <div class="modal fade" id="engineHistoryModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header bg-info text-white">
                    <h5 class="modal-title"><i class="bi bi-clock-history me-2"></i>Engine Full History Timeline</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="engineHistoryBody">
                    <div class="text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="text-muted mt-3">Loading engine history...</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <div id="page-content-wrapper" class="w-100">
        
        <nav class="navbar navbar-light bg-white border-bottom px-4 py-2">
            <div class="d-flex align-items-center gap-3">
                <button class="btn btn-outline-secondary btn-sm" id="menu-toggle"><i class="bi bi-list fs-5"></i></button>
                <div style="display: flex; align-items: center; gap: 10px; font-weight: 600; color: #1e293b; font-size: 0.95rem;">
                    <i class="bi bi-airplane" style="font-size: 1.2rem; color: #0066cc;"></i>
                </div>
            </div>
            <div class="flex-grow-1"></div>
            <div class="d-flex align-items-center gap-3">
                <!-- DB Status Indicator -->
                <div style="display: flex; align-items: center; gap: 6px;">
                    <div style="width: 10px; height: 10px; background: #22c55e; border-radius: 50%; box-shadow: 0 0 8px rgba(34, 197, 94, 0.6);"></div>
                </div>
                <!-- Spacer -->
                <div style="width: 1px; height: 24px; background: rgba(0,0,0,0.1);"></div>
                <!-- User Controls -->
                <button id="add-user-btn" class="user-icon-btn" title="Users" style="display:none; border: none;">
                    <i class="bi bi-person-plus"></i>
                </button>
                <button id="settings-btn" class="user-icon-btn" title="Settings" style="border: none; background: transparent;">
                    <i class="bi bi-gear" style="font-size: 1.1rem;"></i>
                </button>
                <button id="notifications-btn" class="user-icon-btn" title="Notifications" style="border: none; background: transparent; position: relative;">
                    <i class="bi bi-bell" style="font-size: 1.1rem;"></i>
                    <span id="notification-count" class="notification-badge">0</span>
                </button>
                <button id="user-profile-btn" class="user-icon-btn" title="Profile" style="border: none; border-radius: 10px; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 0.85rem;">
                    <span id="user-initials">AA</span>
                </button>
            </div>
        </nav>

        <!-- User Management Modal -->
        <div class="modal fade" id="user-manage-modal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-lg modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title"><i class="bi bi-people me-2"></i>User Management</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="row g-3">
                            <div class="col-md-5">
                                <h6 class="mb-3">Create / Edit User</h6>
                                <form id="user-form">
                                    <input type="hidden" id="user-id">
                                    <div class="mb-2">
                                        <label class="form-label">Имя *</label>
                                        <input type="text" class="form-control" id="user-first-name" required>
                                    </div>
                                    <div class="mb-2">
                                        <label class="form-label">Фамилия *</label>
                                        <input type="text" class="form-control" id="user-last-name" required>
                                    </div>
                                    <div class="mb-2">
                                        <label class="form-label">Логин (только англ. буквы/цифры) *</label>
                                        <input type="text" class="form-control" id="user-username" required>
                                    </div>
                                    <div class="mb-2">
                                        <label class="form-label">Пароль *</label>
                                        <input type="password" class="form-control" id="user-password" required>
                                    </div>
                                    <div class="mb-2">
                                        <label class="form-label">Позиция</label>
                                        <input type="text" class="form-control" id="user-position" placeholder="Engineer, Manager...">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Роль *</label>
                                        <select class="form-select" id="user-role" required>
                                            <option value="viewer">Viewer</option>
                                            <option value="user">User</option>
                                            <option value="admin">Admin</option>
                                        </select>
                                    </div>
                                    <div class="d-flex gap-2">
                                        <button type="submit" class="btn btn-primary" id="user-submit-btn">Create User</button>
                                        <button type="button" class="btn btn-secondary" id="user-reset-btn">Reset</button>
                                    </div>
                                </form>
                            </div>
                            <div class="col-md-7">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <h6 class="mb-0">Активные пользователи</h6>
                                    <button class="btn btn-outline-primary btn-sm" id="refresh-users-btn"><i class="bi bi-arrow-repeat"></i></button>
                                </div>
                                <div class="table-responsive" style="max-height: 360px;">
                                    <table class="table table-sm align-middle">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Имя</th>
                                                <th>Фамилия</th>
                                                <th>Логин</th>
                                                <th>Роль</th>
                                                <th class="text-end">Действия</th>
                                            </tr>
                                        </thead>
                                        <tbody id="user-table-body"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
           
        <div class="container-fluid p-4">
        
                <!-- Edit Column Name Modal -->
                <div class="modal fade" id="edit-column-modal" tabindex="-1" aria-hidden="true">
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content">
                            <div class="modal-header bg-primary text-white">
                                <h5 class="modal-title"><i class="bi bi-pencil-square me-2"></i>Edit Column Name</h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <form id="edit-column-form" onsubmit="event.preventDefault(); submitEditColumn();">
                                    <input type="hidden" id="edit-column-id">
                                    <input type="hidden" id="edit-column-key">
                                    <div class="mb-3">
                                        <label for="edit-column-name" class="form-label">Column Name</label>
                                        <input type="text" class="form-control" id="edit-column-name" placeholder="Enter new column name" required autofocus>
                                        <div class="form-text">Enter the new name for this column</div>
                                    </div>
                                </form>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-danger btn-sm" onclick="deleteColumnFromModal()">
                                    <i class="bi bi-trash me-1"></i>Delete Column
                                </button>
                                <div class="flex-grow-1"></div>
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                <button type="button" class="btn btn-primary" onclick="submitEditColumn()">
                                    <i class="bi bi-check-circle me-1"></i>Save Changes
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
        
            <!-- Add Custom Column Modal -->
            <div class="modal fade" id="add-column-modal" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-header bg-success text-white">
                            <h5 class="modal-title"><i class="bi bi-plus-circle me-2"></i>Add New Column</h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <form id="add-column-form" onsubmit="event.preventDefault(); submitAddColumn();">
                                <div class="mb-3">
                                    <label for="new-column-name" class="form-label">Column Name</label>
                                    <input type="text" class="form-control" id="new-column-name" placeholder="Enter column name" required autofocus>
                                    <div class="form-text">Enter the name for the new custom column</div>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="button" class="btn btn-success" onclick="submitAddColumn()">
                                <i class="bi bi-check-circle me-1"></i>Add Column
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Add/Edit Event Modal (Calendar) -->
            <div class="modal fade" id="event-modal" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog modal-lg modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-header bg-primary text-white">
                            <h5 class="modal-title" id="event-modal-title">
                                <i class="bi bi-calendar-plus me-2"></i>Add New Event
                            </h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <form id="event-form">
                                <input type="hidden" id="event-id" value="">
                                
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="event-date" class="form-label">Date <span class="text-danger">*</span></label>
                                        <input type="date" class="form-control" id="event-date" required>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="event-time" class="form-label">Time (optional)</label>
                                        <input type="time" class="form-control" id="event-time">
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="event-type" class="form-label">Event Type <span class="text-danger">*</span></label>
                                        <select class="form-select" id="event-type" required>
                                            <option value="SHIPMENT">🚚 Shipment</option>
                                            <option value="MEETING">🤝 Meeting</option>
                                            <option value="INSPECTION">🔍 Inspection</option>
                                            <option value="MAINTENANCE">🔧 Maintenance</option>
                                            <option value="DEADLINE">⏰ Deadline</option>
                                            <option value="OTHER">📋 Other</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="event-priority" class="form-label">Priority</label>
                                        <select class="form-select" id="event-priority">
                                            <option value="LOW">Low</option>
                                            <option value="MEDIUM" selected>Medium</option>
                                            <option value="HIGH">High</option>
                                            <option value="URGENT">Urgent</option>
                                        </select>
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label for="event-title" class="form-label">Title <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="event-title" placeholder="e.g., Engine shipment to Baku" required>
                                </div>

                                <div class="mb-3">
                                    <label for="event-description" class="form-label">Description</label>
                                    <textarea class="form-control" id="event-description" rows="3" placeholder="Additional details..."></textarea>
                                </div>

                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="event-serial" class="form-label">Engine S/N (optional)</label>
                                        <input type="text" class="form-control" id="event-serial" placeholder="PCE-123456">
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="event-location" class="form-label">Location (optional)</label>
                                        <input type="text" class="form-control" id="event-location" placeholder="Baku, Dubai, etc.">
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="event-from" class="form-label">From (optional)</label>
                                        <input type="text" class="form-control" id="event-from" placeholder="Origin">
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="event-to" class="form-label">To (optional)</label>
                                        <input type="text" class="form-control" id="event-to" placeholder="Destination">
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="event-status" class="form-label">Status</label>
                                        <select class="form-select" id="event-status">
                                            <option value="PLANNED" selected>Planned</option>
                                            <option value="IN_PROGRESS">In Progress</option>
                                            <option value="COMPLETED">Completed</option>
                                            <option value="CANCELLED">Cancelled</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="event-created-by" class="form-label">Created By</label>
                                        <input type="text" class="form-control" id="event-created-by" placeholder="Your name">
                                    </div>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-success" id="event-complete-btn" style="display: none;" onclick="markEventCompleted()">
                                <i class="bi bi-check2-circle me-1"></i>Mark Done
                            </button>
                            <button type="button" class="btn btn-danger" id="event-delete-btn" style="display: none;" onclick="deleteEvent()">
                                <i class="bi bi-trash me-1"></i>Delete
                            </button>
                            <div class="flex-grow-1"></div>
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="button" class="btn btn-primary" onclick="saveEvent()">
                                <i class="bi bi-check-circle me-1"></i>Save Event
                            </button>
                        </div>
                    </div>
                </div>
            </div>
           
            <div class="container-fluid p-4">
            
            <!-- КНОПКА-ДВИГАТЕЛЬ (START) -->
            <div id="engine-btn-wrapper" class="engine-btn-container">
                <div class="engine-btn-core">
                    <button type="button" id="engine-toggle-btn" class="btn-engine-start" onclick="handleEngineButtonClick(event)">
                        <span class="engine-fan">
                            <span class="fan-blade blade-1"></span>
                            <span class="fan-blade blade-2"></span>
                            <span class="fan-blade blade-3"></span>
                            <span class="fan-blade blade-4"></span>
                            <span class="fan-blade blade-5"></span>
                            <span class="fan-blade blade-6"></span>
                            <span class="fan-hub"></span>
                        </span>
                    </button>
                    <div class="engine-btn-menu" id="engine-btn-menu">
                        <button type="button" class="engine-menu-item engine-menu-item-manuals" style="--angle: -90deg;" onclick="toggleManualsSubmenu()">
                            <i class="bi bi-journal-bookmark-fill"></i>
                            <span>Manuals</span>
                        </button>
                        <button type="button" class="engine-menu-item engine-menu-item-reports" style="--angle: 150deg;" onclick="toggleReportsSubmenu()">
                            <i class="bi bi-graph-up"></i>
                            <span>Reports</span>
                        </button>
                        <button type="button" class="engine-menu-item engine-menu-item-borescope-reports" style="--angle: 210deg;" onclick="toggleBoroscopeReportsSubmenu()">
                            <i class="bi bi-camera-reels"></i>
                            <span>Borescope<br>Reports</span>
                        </button>
                        <button type="button" class="engine-menu-item engine-menu-item-folders" style="--angle: 30deg;" onclick="handleEngineMenuSelection('folders')">
                            <i class="bi bi-folder2-open"></i>
                            <span>Folders</span>
                        </button>

                        <!-- SECOND LEVEL RADIAL MENU for Reports -->
                        <div class="reports-radial-menu" id="reports-radial-menu">
                            <button type="button" class="reports-menu-item reports-menu-item-borescope" style="--angle: 0deg;" onclick="showBoroscopeReport()">
                                <i class="bi bi-stethoscope"></i>
                                <span>Borescope</span>
                            </button>
                            <button type="button" class="reports-menu-item reports-menu-item-engine-reports" style="--angle: 90deg;" onclick="showEngineReportsView()">
                                <i class="bi bi-file-earmark-text"></i>
                                <span>Engine Reports</span>
                            </button>
                            <button type="button" class="reports-menu-item reports-menu-item-purchase" style="--angle: 180deg;" onclick="showPurchaseOrdersView()">
                                <i class="bi bi-cart-check"></i>
                                <span>Purchase Orders</span>
                            </button>
                            <button type="button" class="reports-menu-item reports-menu-item-nameplate" style="--angle: 270deg;" onclick="showNameplateTrackerView()">
                                <i class="bi bi-tag"></i>
                                <span>Nameplate</span>
                            </button>
                        </div>

                        <!-- SECOND LEVEL RADIAL MENU for Manuals -->
                        <div class="manuals-radial-menu" id="manuals-radial-menu">
                            <button type="button" class="manuals-menu-item manuals-menu-item-boeing" style="--angle: 0deg;" onclick="openManualsBoeing()">
                                <i class="bi bi-file-pdf"></i>
                                <span>747-200</span>
                            </button>
                            <button type="button" class="manuals-menu-item manuals-menu-item-gecards" style="--angle: 180deg;" onclick="openManualsGECards()">
                                <i class="bi bi-card-text"></i>
                                <span>GE Cards</span>
                            </button>
                        </div>

                        <!-- THIRD LEVEL RADIAL MENU for Aircraft Selection -->
                        <div class="aircraft-selector-menu" id="aircraft-selector-menu">
                            <button type="button" class="aircraft-menu-item aircraft-item-bar" style="--angle: 0deg;" onclick="selectAircraft('ER-BAR')">
                                <i class="bi bi-airplane"></i>
                                <span>ER-BAR</span>
                            </button>
                            <button type="button" class="aircraft-menu-item aircraft-item-baq" style="--angle: 120deg;" onclick="selectAircraft('ER-BAQ')">
                                <i class="bi bi-airplane"></i>
                                <span>ER-BAQ</span>
                            </button>
                            <button type="button" class="aircraft-menu-item aircraft-item-bat" style="--angle: 240deg;" onclick="selectAircraft('ER-BAT')">
                                <i class="bi bi-airplane"></i>
                                <span>ER-BAT</span>
                            </button>
                        </div>

                        <!-- FOURTH LEVEL RADIAL MENU for Positions Selection -->
                        <div class="positions-selector-menu" id="positions-selector-menu">
                            <button type="button" class="position-menu-item position-item-all" style="--angle: 0deg;" onclick="loadBoroscopeReportData(window.selectedAircraft, 'ALL')">
                                <i class="bi bi-asterisk"></i>
                                <span>ALL</span>
                            </button>
                            <button type="button" class="position-menu-item position-item-1" style="--angle: 72deg;" onclick="loadBoroscopeReportData(window.selectedAircraft, 1)">
                                <i class="bi bi-1-circle-fill"></i>
                                <span>Position 1</span>
                            </button>
                            <button type="button" class="position-menu-item position-item-2" style="--angle: 144deg;" onclick="loadBoroscopeReportData(window.selectedAircraft, 2)">
                                <i class="bi bi-2-circle-fill"></i>
                                <span>Position 2</span>
                            </button>
                            <button type="button" class="position-menu-item position-item-3" style="--angle: 216deg;" onclick="loadBoroscopeReportData(window.selectedAircraft, 3)">
                                <i class="bi bi-3-circle-fill"></i>
                                <span>Position 3</span>
                            </button>
                            <button type="button" class="position-menu-item position-item-4" style="--angle: 288deg;" onclick="loadBoroscopeReportData(window.selectedAircraft, 4)">
                                <i class="bi bi-4-circle-fill"></i>
                                <span>Position 4</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 1. ГЛАВНЫЙ ЭКРАН (Скрыт по умолчанию или показан - настроим в JS) -->
            <div id="dashboard-widgets" class="dashboard-content">      
                 
            
                <div class="row g-3 mb-4" id="locations-container">
                <div class="col-12"><div class="spinner-border text-primary spinner-sm"></div> Loading locations...</div>
            </div>
            
            <div class="row g-3 mb-4">
                <div class="col-md-3">
                    <button class="btn-dashboard btn-status-sv w-100" onclick="openTableModal('SV')">
                        <span class="label">Serviceable (SV)</span>
                        <span class="count" id="cnt-sv">0</span>
                        <i class="bi bi-check-circle-fill"></i>
                    </button>
                </div>
                <div class="col-md-3">
                    <button class="btn-dashboard btn-status-us w-100" onclick="openTableModal('US')">
                        <span class="label">Unserviceable (US)</span>
                        <span class="count" id="cnt-us">0</span>
                        <i class="bi bi-x-circle-fill"></i>
                    </button>
                </div>
                <div class="col-md-3">
                    <button class="btn-dashboard btn-status-rem w-100" onclick="openTableModal('REMOVED')">
                        <span class="label">Removed from AC</span>
                        <span class="count" id="cnt-rem">0</span>
                        <i class="bi bi-arrow-down-left-circle-fill"></i>
                    </button>
                </div>
                <div class="col-md-3">
                    <button class="btn-dashboard btn-status-inst w-100" onclick="openTableModal('INSTALLED')">
                        <span class="label">Installed on AC</span>
                        <span class="count" id="cnt-inst">0</span>
                        <i class="bi bi-airplane-engines-fill"></i>
                    </button>
                </div>
            </div>
            
            <!-- Central chevron button -->
            <div class="row justify-content-center mb-3">
                <div class="col-auto">
                    <button class="btn btn-link p-0" title="Показать детализацию" onclick="toggleCondition2Breakdown()" style="font-size: 1.2rem; color: rgba(108, 117, 125, 0.5); transition: all 0.3s;">
                        <i id="chev-condition2" class="bi bi-chevron-down"></i>
                    </button>
                </div>
            </div>
            
            <!-- Condition 2 breakdown cards (5 cards) -->
            <div class="row g-3 mb-4" id="subcards-condition2" style="display:none"></div>
        </div>
        <div id="view-install" style="display: none;">
                <h4 class="mb-3 text-primary"><i class="bi bi-arrow-up-circle"></i> Installation Action</h4>
                
                <ul class="nav nav-tabs mb-4">
                    <li class="nav-item">
                        <button class="nav-link active" id="tab-inst-info-btn" onclick="switchInstallTab('info')">Вся информация</button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link" id="tab-inst-entry-btn" onclick="switchInstallTab('entry')">Ввести данные</button>
                    </li>
                </ul>

                <!-- ИСПРАВЛЕНИЕ: Уникальный ID для Installation -->
                <div id="tab-inst-info">
                    <div class="card shadow-sm">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <!-- Поле поиска (с уникальным ID) -->
                                <div class="input-group" style="max-width: 300px;">
                                    <span class="input-group-text bg-white text-muted"><i class="bi bi-search"></i></span>
                                    <input type="text" class="form-control border-start-0 ps-0" id="inst-search-input" placeholder="Search all columns..." onkeyup="filterInstallTable()">
                                </div>
                                
                                <!-- Кнопки (с правильными функциями) -->
                                <div>
                                    <button class="btn btn-sm btn-primary" onclick="loadInstallHistory()"><i class="bi bi-arrow-clockwise"></i> Refresh</button>
                                    <button class="btn btn-sm btn-warning ms-2" id="btn-install-edit" onclick="toggleEditModeTable('install')"><i class="bi bi-pencil-square"></i> Edit</button>
                                    <button class="btn btn-sm btn-success ms-2 d-none" id="btn-install-save" onclick="saveEditModeTable('install')"><i class="bi bi-check-lg"></i> Save Changes</button>
                                    <button class="btn btn-sm btn-secondary ms-2 d-none" id="btn-install-cancel" onclick="cancelEditModeTable('install')"><i class="bi bi-x-lg"></i> Cancel</button>
                                    <button class="btn btn-circle btn-success d-none" id="add-row-install" onclick="addEmptyRowTable('install')" title="Add Row"><i class="bi bi-plus-lg"></i></button>
                                </div>
                            </div>

                            <table class="table table-hover table-bordered table-sm" id="install-table">
                                <thead class="table-light">
                                    <tr>
                                        <th class="delete-col-install" style="width: 40px; display: none;"><i class="bi bi-trash"></i></th>
                                        <th>Date</th>
                                        <th>Orig SN</th>
                                        <th>Current SN</th>
                                        <th>Install To</th>
                                        <th>Pos</th>
                                        <th>Loc From</th>
                                        <th>TT (Engine)</th>
                                        <th>TC (Engine)</th>
                                        <th>TTSN (Aircraft)</th>
                                        <th>TCSN (Aircraft)</th>
                                        <th>Supplier</th>
                                        <th>Remarks</th>
                                    </tr>
                                </thead>
                                <tbody id="install-history-body">
                                    </tbody>
                            </table>
                        </div>
                    </div>
                </div>


        <div id="tab-inst-entry" style="display: none;">
                    <div class="row">
                        <div class="col-md-8">
                            <div class="card shadow-sm border-0">
                                <div class="card-header bg-white fw-bold">New Installation Event</div>
                                <div class="card-body">
                                    <form id="form-install">
                                        <div class="row mb-3">
                                            <div class="col-md-3">
                                                <label class="form-label small fw-bold">Date <span class="text-danger">*</span></label>
                                                <input type="date" class="form-control" id="in-date" required>
                                            </div>
                                            <div class="col-md-3">
                                                <label class="form-label small fw-bold">GSS ID <span class="text-danger">*</span></label>
                                                <input class="form-control" list="gss-options" id="in-gss-input" placeholder="Type GSS ID..." required>
                                                <datalist id="gss-options">
                                                    <!-- Сюда JS загрузит варианты GSS ID -->
                                                </datalist>
                                            </div>
                                            <div class="col-md-3">
                                                <label class="form-label small fw-bold">Engine (Orig SN) <span class="text-danger">*</span></label>
                                                
                                                <!-- ЗАМЕНА: Вместо select используем input + datalist -->
                                                <input class="form-control" list="engine-options" id="in-engine-input" placeholder="Type to search SN..." required>
                                                <datalist id="engine-options">
                                                    <!-- Сюда JS загрузит варианты -->
                                                </datalist>
                                                
                                                <!-- Скрытое поле, куда мы запишем ID двигателя для отправки на сервер -->
                                                <input type="hidden" id="in-engine-id">
                                            </div>
                                            <div class="col-md-3">
                                                <label class="form-label small fw-bold">Current SN</label>
                                                <!-- Убрали readonly и bg-light, теперь можно писать -->
                                                <input type="text" class="form-control" id="in-cur-sn" placeholder="Enter Current SN">
                                            </div>
                                        </div>

                                        <div class="row mb-3">
                                            <div class="col-md-4">
                                                <label class="form-label small fw-bold">Install To (AC) <span class="text-danger">*</span></label>
                                                <select class="form-select" id="in-ac" required>
                                                    <option value="1">ER-BAT</option>
                                                    <option value="2">ER-BAR</option>
                                                    <option value="3">ER-BAQ</option>
                                                </select>
                                            </div>
                                            <div class="col-md-4">
                                                <label class="form-label small fw-bold">Position <span class="text-danger">*</span></label>
                                                <!-- Добавили позиции 3 и 4 -->
                                                <select class="form-select" id="in-pos" required>
                                                    <option value="1">1</option>
                                                    <option value="2">2</option>
                                                    <option value="3">3</option>
                                                    <option value="4">4</option>
                                                </select>
                                            </div>
                                            <div class="col-md-4">
                                                <label class="form-label small fw-bold">Location From</label>
                                                <!-- Убрали readonly и bg-light -->
                                                <input type="text" class="form-control" id="in-loc-from" placeholder="Enter Location">
                                            </div>
                                        </div>

                                        <div class="row mb-3">
                                            <div class="col-md-6">
                                                <label class="form-label small fw-bold">TTSN (Engine) <span class="text-danger">*</span></label>
                                                <input type="text" class="form-control" id="in-tt" required placeholder="e.g. 10399:34 or 10399.57">
                                                <small class="text-muted">Format: HH:MM or decimal</small>
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label small fw-bold">TCSN (Engine) <span class="text-danger">*</span></label>
                                                <input type="number" class="form-control" id="in-tc" required>
                                            </div>
                                        </div>

                                        <div class="row mb-3">
                                            <div class="col-md-6">
                                                <label class="form-label small fw-bold">TTSN (Aircraft)</label>
                                                <input type="text" class="form-control" id="in-ac-ttsn" placeholder="e.g. 103999:34 or 103999.57">
                                                <small class="text-muted">Format: HH:MM or decimal</small>
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label small fw-bold">TCSN (Aircraft)</label>
                                                <input type="number" class="form-control" id="in-ac-tcsn" placeholder="Optional">
                                            </div>
                                        </div>

                                        <div class="mb-4">
                                            <label class="form-label small fw-bold">Supplier</label>
                                            <input type="text" class="form-control" id="in-supplier" placeholder="Enter Supplier">
                                        </div>

                                        <div class="mb-4">
                                            <label class="form-label small fw-bold">Remarks</label>
                                            <textarea class="form-control" id="in-rem" rows="2"></textarea>
                                        </div>

                                        <div class="d-flex justify-content-end gap-2">
                                            <button type="button" class="btn btn-light border" onclick="switchInstallTab('info')">Cancel</button>
                                            <button type="button" class="btn btn-success px-4" onclick="submitInstallForm()">Save Record</button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>      
          
        <div id="view-shipment" style="display: none;">
                <h4 class="mb-3 text-primary"><i class="bi bi-truck"></i> Engine Shipment Action</h4>
                
                <ul class="nav nav-tabs mb-4">
                    <li class="nav-item">
                        <button class="nav-link active" id="tab-ship-info-btn" onclick="switchShipmentTab('info')">История отгрузок</button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link" id="tab-ship-entry-btn" onclick="switchShipmentTab('entry')">Создать отгрузку</button>
                    </li>
                </ul>

                <!-- TAB 1: History -->
                <div id="tab-ship-info">
                    <div class="card shadow-sm">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <!-- Поле поиска -->
                                <div class="input-group" style="max-width: 300px;">
                                    <span class="input-group-text bg-white text-muted"><i class="bi bi-search"></i></span>
                                    <input type="text" class="form-control border-start-0 ps-0" id="ship-search-input" placeholder="Search..." onkeyup="filterTable('shipment-history-body', 'ship-search-input')">
                                </div>
                                
                                <!-- Кнопки -->
                                <div>
                                    <button class="btn btn-sm btn-primary" onclick="loadShipmentHistory()"><i class="bi bi-arrow-clockwise"></i> Refresh</button>
                                    <button class="btn btn-sm btn-warning ms-2" id="btn-shipment-edit" onclick="toggleEditModeTable('shipment')"><i class="bi bi-pencil-square"></i> Edit</button>
                                    <button class="btn btn-sm btn-success ms-2 d-none" id="btn-shipment-save" onclick="saveEditModeTable('shipment')"><i class="bi bi-check-lg"></i> Save Changes</button>
                                    <button class="btn btn-sm btn-secondary ms-2 d-none" id="btn-shipment-cancel" onclick="cancelEditModeTable('shipment')"><i class="bi bi-x-lg"></i> Cancel</button>
                                    <button class="btn btn-circle btn-success d-none" id="add-row-shipment" onclick="addEmptyRowTable('shipment')" title="Add Row"><i class="bi bi-plus-lg"></i></button>
                                </div>
                            </div>
                            <table class="table table-hover table-bordered table-sm">
                                <thead class="table-light">
                                    <tr>
                                        <th class="delete-col-shipment" style="width: 40px; display: none;"><i class="bi bi-trash"></i></th>
                                        <th>Date</th>
                                        <th>Engine SN</th>
                                        <th>Engine Model</th>
                                        <th>GSS ID</th>
                                        <th>From</th>
                                        <th>To (Destination)</th>
                                        <th>Remarks / Waybill</th>
                                    </tr>
                                </thead>
                                <tbody id="shipment-history-body"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- TAB 2: New Entry -->
                <div id="tab-ship-entry" style="display: none;">
                    <div class="row">
                        <div class="col-md-8">
                            <div class="card shadow-sm border-0">
                                <div class="card-header bg-white fw-bold">New Shipment</div>
                                <div class="card-body">
                                    <form id="form-shipment">
                                        <div class="row mb-3">
                                            <div class="col-md-3">
                                                <label class="form-label small fw-bold">Date <span class="text-danger">*</span></label>
                                                <input type="date" class="form-control" id="ship-date" required>
                                            </div>
                                            <div class="col-md-3">
                                                <label class="form-label small fw-bold">Engine <span class="text-danger">*</span></label>
                                                <input class="form-control" list="engine-options-ship" id="ship-engine-input" placeholder="Search Engine..." required>
                                                <datalist id="engine-options-ship"></datalist>
                                                <input type="hidden" id="ship-engine-id">
                                            </div>
                                            <div class="col-md-3">
                                                <label class="form-label small fw-bold">Engine Model</label>
                                                <input type="text" class="form-control" id="ship-engine-model" placeholder="e.g. CFM56">
                                            </div>
                                            <div class="col-md-3">
                                                <label class="form-label small fw-bold">GSS ID</label>
                                                <input type="text" class="form-control" id="ship-gss-id" placeholder="e.g. GSS-12345">
                                            </div>
                                        </div>

                                        <div class="row mb-3">
                                            <div class="col-md-4">
                                                <label class="form-label small fw-bold">From (Location)</label>
                                                <input type="text" class="form-control" id="ship-loc-from">
                                            </div>
                                            <div class="col-md-4">
                                                <label class="form-label small fw-bold">Destination (To) <span class="text-danger">*</span></label>
                                                <select class="form-select" id="ship-dest" required>
                                                    <!-- Заполнится JS -->
                                                </select>
                                            </div>
                                            <div class="col-md-4">
                                                <label class="form-label small fw-bold">Waybill #</label>
                                                <input type="text" class="form-control" id="ship-wb" placeholder="e.g. AWB-123456">
                                            </div>
                                        </div>

                                        <div class="mb-4">
                                            <label class="form-label small fw-bold">Remarks</label>
                                            <textarea class="form-control" id="ship-rem" rows="2"></textarea>
                                        </div>

                                        <div class="d-flex justify-content-end gap-2">
                                            <button type="button" class="btn btn-light border" onclick="switchShipmentTab('info')">Cancel</button>
                                            <button type="button" class="btn btn-success px-4" onclick="submitShipmentForm()">Confirm Shipment</button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>        

         <!-- 4. REMOVE VIEW -->
        <div id="view-remove" style="display: none;">
                <h4 class="mb-3 text-danger"><i class="bi bi-arrow-down-circle"></i> Remove Engine</h4>
                
                <ul class="nav nav-tabs mb-4">
                    <li class="nav-item">
                        <button class="nav-link active" id="tab-rem-info-btn" onclick="switchRemoveTab('info')">История снятий</button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link" id="tab-rem-entry-btn" onclick="switchRemoveTab('entry')">Снять двигатель</button>
                    </li>
                </ul>

                <!-- Tab Info -->
                <div id="tab-rem-info">
                    <div class="card shadow-sm">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <!-- Поле поиска -->
                                <div class="input-group" style="max-width: 300px;">
                                    <span class="input-group-text bg-white text-muted"><i class="bi bi-search"></i></span>
                                    <input type="text" class="form-control border-start-0 ps-0" id="rem-search-input" placeholder="Search..." onkeyup="filterTable('remove-history-body', 'rem-search-input')">
                                </div>
                                
                                <!-- Кнопки -->
                                <div>
                                    <button class="btn btn-sm btn-primary" onclick="loadRemoveHistory()"><i class="bi bi-arrow-clockwise"></i> Refresh</button>
                                    <button class="btn btn-sm btn-warning ms-2" id="btn-remove-edit" onclick="toggleEditModeTable('remove')"><i class="bi bi-pencil-square"></i> Edit</button>
                                    <button class="btn btn-sm btn-success ms-2 d-none" id="btn-remove-save" onclick="saveEditModeTable('remove')"><i class="bi bi-check-lg"></i> Save Changes</button>
                                    <button class="btn btn-sm btn-secondary ms-2 d-none" id="btn-remove-cancel" onclick="cancelEditModeTable('remove')"><i class="bi bi-x-lg"></i> Cancel</button>
                                    <button class="btn btn-circle btn-success d-none" id="add-row-remove" onclick="addEmptyRowTable('remove')" title="Add Row"><i class="bi bi-plus-lg"></i></button>
                                </div>
                            </div>
                            <table class="table table-hover table-bordered table-sm">
                                <thead class="table-light">
                                    <tr>
                                        <th class="delete-col-remove" style="width: 40px; display: none;"><i class="bi bi-trash"></i></th>
                                        <th>Date</th>
                                        <th>Engine SN</th>
                                        <th>Removed From (AC)</th>
                                        <th>Sent To (Loc)</th>
                                        <th>Reason / Remarks</th>
                                    </tr>
                                </thead>
                                <tbody id="remove-history-body"></tbody>
                            </table>
                        </div>
                    </div>
                </div>    

                <!-- Tab Entry -->
                <div id="tab-rem-entry" style="display: none;">
                    <div class="row">
                        <div class="col-md-8">
                            <div class="card shadow-sm border-0">
                                <div class="card-header bg-white fw-bold text-danger">Remove Engine from Wing</div>
                                <div class="card-body">
                                    <form id="form-remove">
                                        <div class="row mb-3">
                                            <div class="col-md-4">
                                                <label class="form-label small fw-bold">Date <span class="text-danger">*</span></label>
                                                <input type="date" class="form-control" id="rem-date" required>
                                            </div>
                                            <div class="col-md-4">
                                                <label class="form-label small fw-bold">Engine (On Wing) <span class="text-danger">*</span></label>
                                                <input class="form-control" list="engine-options-rem" id="rem-engine-input" placeholder="Select Installed Engine..." required>
                                                <datalist id="engine-options-rem"></datalist>
                                                <input type="hidden" id="rem-engine-id">
                                            </div>
                                            <div class="col-md-4">
                                                <label class="form-label small fw-bold">GSS ID</label>
                                                <input type="text" class="form-control" id="rem-gss-id" readonly style="background-color: #e9ecef; cursor: default;">
                                                <small class="text-muted">Автоматически определяется по двигателю</small>
                                            </div>
                                        </div>

                                        <div class="row mb-3">
                                            <div class="col-md-12">
                                                <label class="form-label small fw-bold">Current Position</label>
                                                <input type="text" class="form-control" id="rem-loc-from">
                                            </div>
                                        </div>

                                        <div class="row mb-3">
                                            <div class="col-md-6">
                                                <label class="form-label small fw-bold">From A/C <span class="text-danger">*</span></label>
                                                <select class="form-select" id="rem-aircraft" required disabled>
                                                    <option value="" selected>Select engine first...</option>
                                                </select>
                                                <small class="text-muted">Автоматически определяется по двигателю</small>
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label small fw-bold">Send To (Location) <span class="text-danger">*</span></label>
                                                <select class="form-select" id="rem-dest" required></select>
                                            </div>
                                        </div>

                                        <div class="row mb-3">
                                            <div class="col-md-6">
                                                <label class="form-label small fw-bold">TTSN (Engine) <span class="text-danger">*</span></label>
                                                <input type="text" class="form-control" id="rem-ttsn" required placeholder="e.g. 10399:34 or 10399.57">
                                                <small class="text-muted">Format: HH:MM or decimal</small>
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label small fw-bold">TCSN (Engine) <span class="text-danger">*</span></label>
                                                <input type="number" class="form-control" id="rem-tcsn" required>
                                            </div>
                                        </div>

                                        <div class="row mb-3">
                                            <div class="col-md-6">
                                                <label class="form-label small fw-bold">TTSN (Aircraft)</label>
                                                <input type="text" class="form-control" id="rem-ttsn-ac" placeholder="e.g. 103999:34 or 103999.57">
                                                <small class="text-muted">Format: HH:MM or decimal</small>
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label small fw-bold">TCSN (Aircraft)</label>
                                                <input type="number" class="form-control" id="rem-tcsn-ac">
                                            </div>
                                        </div>

                                        <div class="row mb-3">
                                            <div class="col-md-12">
                                                <label class="form-label small fw-bold">Condition 1 at Removal</label>
                                                <select class="form-select" id="rem-condition-1">
                                                    <option value="SV">SV (Serviceable)</option>
                                                    <option value="US">US (Unserviceable)</option>
                                                    <option value="Scrap">Scrap</option>
                                                </select>
                                            </div>
                                        </div>

                                        <div class="row mb-3">
                                            <div class="col-md-12">
                                                <label class="form-label small fw-bold">Reason</label>
                                                <input type="text" class="form-control" id="rem-reason" placeholder="e.g. End of Lease, Repair...">
                                            </div>
                                        </div>

                                        <div class="row mb-3">
                                            <div class="col-md-12">
                                                <label class="form-label small fw-bold">Installed Plate SN</label>
                                                <input type="text" class="form-control" id="rem-installed-plate-sn" placeholder="SN of nameplate being installed on removed engine...">
                                                <small class="text-muted">Серийник шильдика, который установят на этот снятый двигатель</small>
                                            </div>
                                        </div>

                                        <div class="row mb-3">
                                            <div class="col-md-12">
                                                <label class="form-label small fw-bold">Remarks</label>
                                                <textarea class="form-control" id="rem-remarks" rows="3"></textarea>
                                            </div>
                                        </div>

                                        <div class="d-flex justify-content-end gap-2">
                                            <button type="button" class="btn btn-light border" onclick="switchRemoveTab('info')">Cancel</button>
                                            <button type="button" class="btn btn-danger px-4" onclick="submitRemoveForm()">Confirm Removal</button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 5. ENGINE REPORTS VIEW -->
            <div id="view-engine-reports" style="display: none;">
                <h4 class="mb-3 text-info"><i class="bi bi-clock-history"></i> Engine Reports - Full History</h4>
                <p class="text-muted">Click on any engine to view its complete history timeline (installations, removals, repairs, parts, utilization).</p>
                
                <div class="card shadow-sm">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
                            <div class="d-flex gap-2">
                                <div class="input-group" style="max-width: 300px;">
                                    <span class="input-group-text bg-white text-muted" title="Search by Serial Number"><i class="bi bi-search"></i></span>
                                    <input type="text" class="form-control border-start-0 ps-0" id="engine-reports-search" placeholder="Search by S/N..." onkeyup="filterEngineReports()">
                                </div>
                                
                                <div class="input-group" style="max-width: 300px;">
                                    <span class="input-group-text bg-white text-muted" title="Search by GSS ID"><i class="bi bi-tag-fill"></i></span>
                                    <input type="text" class="form-control border-start-0 ps-0" id="engine-reports-gss-search" placeholder="Search by GSS ID..." onkeyup="filterEngineReports()">
                                </div>
                            </div>
                            <a href="#" class="btn btn-sm btn-primary" onclick="loadEngineReportsList(); return false;" role="button"><i class="bi bi-arrow-clockwise"></i> Refresh</a>
                        </div>
                        
                        <table class="table table-hover table-bordered table-sm">
                            <thead class="table-light">
                                <tr>
                                    <th style="width: 50px;">#</th>
                                    <th>Original S/N</th>
                                    <th>Current S/N</th>
                                    <th>GSS ID</th>
                                    <th>Status</th>
                                    <th>Aircraft</th>
                                    <th>Location</th>
                                    <th>TT</th>
                                    <th>TC</th>
                                    <th style="width: 120px;">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="engine-reports-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- 6. BORESCOPE VIEW -->
            <div id="view-borescope" style="display: none;">
                <h4 class="mb-3 text-info"><i class="bi bi-camera-video"></i> Borescope Inspections</h4>
                
                <ul class="nav nav-tabs mb-4">
                    <li class="nav-item">
                        <button class="nav-link active" id="tab-bore-info-btn" onclick="switchBoroscopeTab('info')">История инспекций</button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link" id="tab-bore-entry-btn" onclick="switchBoroscopeTab('entry')">Внести данные</button>
                    </li>
                </ul>

                <!-- TAB 1: History -->
                <div id="tab-bore-info">
                    <div class="card shadow-sm">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <div class="input-group" style="max-width: 300px;">
                                    <span class="input-group-text bg-white text-muted"><i class="bi bi-search"></i></span>
                                    <input type="text" class="form-control border-start-0 ps-0" id="bore-search-input" placeholder="Search..." onkeyup="filterTable('borescope-history-body', 'bore-search-input')">
                                </div>
                                
                                <div>
                                    <a href="#" class="btn btn-sm btn-primary" onclick="loadBoroscopeHistory(); return false;" role="button"><i class="bi bi-arrow-clockwise"></i> Refresh</a>
                                    <button class="btn btn-sm btn-warning ms-2" id="btn-borescope-edit" onclick="toggleEditModeTable('borescope')"><i class="bi bi-pencil-square"></i> Edit</button>
                                    <button class="btn btn-sm btn-success ms-2 d-none" id="btn-borescope-save" onclick="saveEditModeTable('borescope')"><i class="bi bi-check-lg"></i> Save Changes</button>
                                    <button class="btn btn-sm btn-secondary ms-2 d-none" id="btn-borescope-cancel" onclick="cancelEditModeTable('borescope')"><i class="bi bi-x-lg"></i> Cancel</button>
                                    <button class="btn btn-circle btn-success d-none" id="add-row-borescope" onclick="addEmptyRowTable('borescope')" title="Add Row"><i class="bi bi-plus-lg"></i></button>
                                </div>
                            </div>
                            <table class="table table-hover table-bordered table-sm">
                                <thead class="table-light">
                                    <tr>
                                        <th class="delete-col-borescope" style="width: 40px; display: none;"><i class="bi bi-trash"></i></th>
                                        <th>Дата</th>
                                        <th>Самолет</th>
                                        <th>Серийник</th>
                                        <th>Позиция</th>
                                        <th>Work Type</th>
                                        <th>GSS ID</th>
                                        <th>Кем выполнен</th>
                                        <th>Comment</th>
                                        <th>Документ Link</th>
                                    </tr>
                                </thead>
                                <tbody id="borescope-history-body"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- TAB 2: Entry -->
                <div id="tab-bore-entry" style="display: none;">
                    <div class="row">
                        <div class="col-md-8">
                            <div class="card shadow-sm border-0">
                                <div class="card-header bg-white fw-bold text-info">New Borescope Inspection</div>
                                <div class="card-body">
                                    <form id="form-borescope">
                                        <div class="row mb-3">
                                            <div class="col-md-2">
                                                <label class="form-label small fw-bold">Дата <span class="text-danger">*</span></label>
                                                <input type="date" class="form-control" id="bore-date" required>
                                            </div>
                                            <div class="col-md-2">
                                                <label class="form-label small fw-bold">Время</label>
                                                <input type="time" class="form-control" id="bore-time" placeholder="HH:MM">
                                            </div>
                                            <div class="col-md-3">
                                                <label class="form-label small fw-bold">Orig SN <span class="text-danger">*</span></label>
                                                <input type="text" class="form-control" id="bore-orig-sn" placeholder="Original S/N" required onchange="onOrigSNChange()" list="bore-orig-sn-list">
                                                <datalist id="bore-orig-sn-list"></datalist>
                                            </div>
                                            <div class="col-md-2">
                                                <label class="form-label small fw-bold">Current SN</label>
                                                <input type="text" class="form-control" id="bore-current-sn" placeholder="Current S/N" readonly>
                                            </div>
                                            <div class="col-md-3">
                                                <label class="form-label small fw-bold">GSS ID</label>
                                                <input type="text" class="form-control" id="bore-gss" placeholder="GSS-xxxxx">
                                            </div>
                                        </div>

                                        <div class="row mb-3">
                                            <div class="col-md-4">
                                                <label class="form-label small fw-bold">Самолет</label>
                                                <select class="form-select" id="bore-aircraft" disabled>
                                                    <option value="">-- будет заполнено --</option>
                                                </select>
                                            </div>
                                            <div class="col-md-3">
                                                <label class="form-label small fw-bold">Позиция</label>
                                                <select class="form-select" id="bore-position" disabled>
                                                    <option value="">-- будет заполнено --</option>
                                                    <option value="1">Позиция 1</option>
                                                    <option value="2">Позиция 2</option>
                                                    <option value="3">Позиция 3</option>
                                                    <option value="4">Позиция 4</option>
                                                </select>
                                            </div>
                                            <div class="col-md-3">
                                                <label class="form-label small fw-bold">Work Type <span class="text-danger">*</span></label>
                                                <div class="d-flex gap-1">
                                                    <select class="form-select" id="bore-work-type" required style="flex: 1;">
                                                        <option value="">-- Select --</option>
                                                    </select>
                                                    <button type="button" class="btn btn-sm btn-outline-success" onclick="openAddWorkTypeModal()" title="Add new work type" style="padding: 0.25rem 0.5rem;">
                                                        <i class="bi bi-plus-lg"></i>
                                                    </button>
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <label class="form-label small fw-bold">Кем выполнен <span class="text-danger">*</span></label>
                                                <input type="text" class="form-control" id="bore-inspector" placeholder="Inspector name" required>
                                            </div>
                                        </div>

                                        <div class="mb-3">
                                            <label class="form-label small fw-bold">Comment</label>
                                            <textarea class="form-control" id="bore-comment" rows="2" placeholder="Notes, findings, etc."></textarea>
                                        </div>

                                        <div class="mb-4">
                                            <label class="form-label small fw-bold">Документ Link</label>
                                            <input type="url" class="form-control" id="bore-link" placeholder="https://...">
                                            <small class="text-muted">Ссылка на боре-скоп репорт</small>
                                        </div>

                                        <!-- Borescope Report Block -->
                                        <div id="boroscope-report-block" class="mb-4"></div>

                                        <!-- Inspection Photos Table -->
                                        <div id="inspection-photos-section" class="mb-4">
                                            <h6 class="mb-3">Inspection Photos</h6>
                                            <table class="table table-bordered" id="inspection-photos-table">
                                                <thead>
                                                    <tr>
                                                        <th style="width: 30%;">Label (HPT/LPT/etc)</th>
                                                        <th style="width: 30%;">Photo 1</th>
                                                        <th style="width: 30%;">Photo 2</th>
                                                        <th style="width: 10%;">Action</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="inspection-photos-tbody">
                                                    <!-- Rows will be added dynamically -->
                                                </tbody>
                                            </table>
                                            <button type="button" class="btn btn-sm btn-success" onclick="addInspectionPhotoRow()">
                                                <i class="bi bi-plus-lg"></i> Add Row
                                            </button>
                                        </div>

                                        <div class="d-flex justify-content-end gap-2">
                                            <button type="button" class="btn btn-light border" onclick="switchBoroscopeTab('info')">Cancel</button>
                                            <button type="button" class="btn btn-info px-4" onclick="submitBoroscopeForm()">Save Inspection</button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 6. PURCHASE ORDERS VIEW -->
            <div id="view-purchase-orders" style="display: none;">
                <h4 class="mb-3 text-success"><i class="bi bi-receipt"></i> Purchase Orders</h4>
                
                <ul class="nav nav-tabs mb-4">
                    <li class="nav-item">
                        <button class="nav-link active" id="tab-po-info-btn" onclick="switchPurchaseOrdersTab('info')">Order History</button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link" id="tab-po-entry-btn" onclick="switchPurchaseOrdersTab('entry')">Add Entry</button>
                    </li>
                </ul>

                <!-- TAB 1: History -->
                <div id="tab-po-info">
                    <div class="card shadow-sm">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <div class="input-group" style="max-width: 300px;">
                                    <span class="input-group-text bg-white text-muted"><i class="bi bi-search"></i></span>
                                    <input type="text" class="form-control border-start-0 ps-0" id="po-search-input" placeholder="Search..." onkeyup="filterTable('purchase-orders-history-body', 'po-search-input')">
                                </div>
                                
                                <div>
                                    <a href="#" class="btn btn-sm btn-primary" onclick="loadPurchaseOrdersHistory(); return false;" role="button"><i class="bi bi-arrow-clockwise"></i> Refresh</a>
                                    <button class="btn btn-sm btn-warning ms-2" id="btn-purchase-orders-edit" onclick="toggleEditModeTable('purchase-orders')"><i class="bi bi-pencil-square"></i> Edit</button>
                                    <button class="btn btn-sm btn-success ms-2 d-none" id="btn-purchase-orders-save" onclick="saveEditModeTable('purchase-orders')"><i class="bi bi-check-lg"></i> Save Changes</button>
                                    <button class="btn btn-sm btn-secondary ms-2 d-none" id="btn-purchase-orders-cancel" onclick="cancelEditModeTable('purchase-orders')"><i class="bi bi-x-lg"></i> Cancel</button>
                                    <button class="btn btn-circle btn-success d-none" id="add-row-purchase-orders" onclick="addEmptyRowTable('purchase-orders')" title="Add Row"><i class="bi bi-plus-lg"></i></button>
                                </div>
                            </div>
                            <table class="table table-hover table-bordered table-sm">
                                <thead class="table-light">
                                    <tr id="purchase-orders-header-row">
                                        <th class="delete-col-purchase-orders" style="width: 40px; display: none;"><i class="bi bi-trash"></i></th>
                                        <th ondblclick="editColumnName(this, 'date')">Date</th>
                                        <th ondblclick="editColumnName(this, 'name')">Item Name</th>
                                        <th ondblclick="editColumnName(this, 'part_number')">PN</th>
                                        <th ondblclick="editColumnName(this, 'serial_number')">SN</th>
                                        <th ondblclick="editColumnName(this, 'price')">Price</th>
                                        <th ondblclick="editColumnName(this, 'purpose')">Purchase Purpose</th>
                                        <th ondblclick="editColumnName(this, 'aircraft')">Aircraft</th>
                                        <th ondblclick="editColumnName(this, 'ro_number')">RO#</th>
                                        <th ondblclick="editColumnName(this, 'link')">Link</th>
                                        <th id="add-column-header-purchase-orders" style="width: 1%; white-space: nowrap; padding: 5px; background: transparent; border: none; display: none;">
                                            <button id="add-column-btn-purchase-orders" class="btn btn-sm btn-success d-none" onclick="addCustomColumn()" title="Add Column">
                                                <i class="bi bi-plus-lg"></i>
                                            </button>
                                            <button id="delete-column-btn-purchase-orders" class="btn btn-sm btn-danger d-none ms-1" onclick="deleteSelectedCustomColumn()" title="Delete Selected Column" disabled>
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </th>
                                    </tr>
                                </thead>
                                <tbody id="purchase-orders-history-body"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- TAB 2: Entry -->
                <div id="tab-po-entry" style="display: none;">
                    <div class="row">
                        <div class="col-md-8">
                            <div class="card shadow-sm border-0">
                                <div class="card-header bg-white fw-bold text-success">New Purchase Order</div>
                                <div class="card-body">
                                    <form id="form-purchase-order">
                                        <div class="row mb-3">
                                            <div class="col-md-4">
                                                <label class="form-label small fw-bold">Date <span class="text-danger">*</span></label>
                                                <input type="date" class="form-control" id="po-date" required>
                                            </div>
                                            <div class="col-md-8">
                                                <label class="form-label small fw-bold">Item Name <span class="text-danger">*</span></label>
                                                <input type="text" class="form-control" id="po-name" placeholder="Item name" required>
                                            </div>
                                        </div>

                                        <div class="row mb-3">
                                            <div class="col-md-4">
                                                <label class="form-label small fw-bold">PN</label>
                                                <input type="text" class="form-control" id="po-pn" placeholder="Part Number">
                                            </div>
                                            <div class="col-md-4">
                                                <label class="form-label small fw-bold">SN</label>
                                                <input type="text" class="form-control" id="po-sn" placeholder="Serial Number">
                                            </div>
                                            <div class="col-md-4">
                                                <label class="form-label small fw-bold">Price</label>
                                                <input type="number" step="0.01" class="form-control" id="po-price" placeholder="0.00">
                                            </div>
                                        </div>

                                        <div class="row mb-3">
                                            <div class="col-md-6">
                                                <label class="form-label small fw-bold">Purchase Purpose <span class="text-danger">*</span></label>
                                                <input type="text" class="form-control" id="po-purpose" placeholder="Reason / objective" required>
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label small fw-bold">Aircraft <span class="text-danger">*</span></label>
                                                <select class="form-select" id="po-aircraft" required>
                                                    <option value="">Select...</option>
                                                </select>
                                            </div>
                                        </div>

                                        <div class="row mb-3">
                                            <div class="col-md-6">
                                                <label class="form-label small fw-bold">RO# <span class="text-danger">*</span></label>
                                                <input type="text" class="form-control" id="po-ro-number" placeholder="RO-xxxxx" required>
                                                <small class="text-muted">Tracking number / approval</small>
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label small fw-bold">Link</label>
                                                <input type="url" class="form-control" id="po-link" placeholder="https://...">
                                                <small class="text-muted">Link to signed file</small>
                                            </div>
                                        </div>

                                        <div class="d-flex justify-content-end gap-2">
                                            <button type="button" class="btn btn-light border" onclick="switchPurchaseOrdersTab('info')">Cancel</button>
                                            <button type="button" class="btn btn-success px-4" onclick="submitPurchaseOrderForm()">Save Purchase Order</button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 7. FAKE INSTALLED VIEW -->
            <div id="view-fake-installed" style="display: none;">
                <h4 class="mb-3 text-danger"><i class="bi bi-exclamation-circle"></i> Fake Installed Tracker</h4>
                
                <div class="card shadow-sm mb-3">
                    <div class="card-body">
                        <div class="row g-2 align-items-end">
                            <div class="col-md-4">
                                <label class="form-label small">🔍 Filter by Engine SN:</label>
                                <input type="text" class="form-control" id="fake-filter-sn" onkeyup="loadFakeInstalled()">
                            </div>
                            <div class="col-md-auto">
                                <button class="btn btn-sm btn-primary" onclick="loadFakeInstalled()"><i class="bi bi-arrow-clockwise"></i> Refresh</button>
                                <button class="btn btn-sm btn-success" onclick="showFakeInstalledForm()"><i class="bi bi-plus-lg"></i> Add</button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- TABLE -->
                <div class="table-responsive card shadow-sm">
                    <table class="table table-sm table-hover mb-0">
                        <thead class="table-dark sticky-top">
                            <tr>
                                <th data-key="idx" style="width: 80px;" ondblclick="beginHeaderEdit(event)">#</th>
                                <th data-key="documented_date" ondblclick="beginHeaderEdit(event)">Date</th>
                                <th data-key="engine_original_sn" ondblclick="beginHeaderEdit(event)">Engine (Original SN)</th>
                                <th data-key="engine_current_sn" ondblclick="beginHeaderEdit(event)">Current SN</th>
                                <th data-key="aircraft_tail" ondblclick="beginHeaderEdit(event)">Aircraft</th>
                                <th data-key="position" ondblclick="beginHeaderEdit(event)">Pos</th>
                                <th data-key="documented_reason" ondblclick="beginHeaderEdit(event)">Reason</th>
                                <th data-key="documented_pair" ondblclick="beginHeaderEdit(event)">Documented</th>
                                <th data-key="actual_notes" ondblclick="beginHeaderEdit(event)">Reality</th>
                                <th data-key="actions" style="width: 120px;">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="fake-installed-table">
                            <tr><td colspan="10" class="text-center text-muted py-3">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- FAKE INSTALLED FORM MODAL -->
            <div class="modal fade" id="fakeInstalledModal" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header bg-danger text-white">
                            <h5 class="modal-title"><i class="bi bi-exclamation-circle me-2"></i>Add Fake Installed</h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <form id="form-fake-installed">
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label class="form-label">Engine S/N (Original) <span class="text-danger">*</span></label>
                                        <input type="text" class="form-control" id="fake-engine-sn" required>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">Engine Current S/N</label>
                                        <input type="text" class="form-control" id="fake-engine-current-sn">
                                    </div>
                                </div>
                                
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label class="form-label">Aircraft</label>
                                        <select class="form-select" id="fake-aircraft">
                                            <option value="">Not specified</option>
                                            <option value="ER-BAT">ER-BAT</option>
                                            <option value="ER-BAR">ER-BAR</option>
                                            <option value="ER-BAQ">ER-BAQ</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">Position</label>
                                        <select class="form-select" id="fake-position">
                                            <option value="">Not specified</option>
                                            <option value="1">1</option>
                                            <option value="2">2</option>
                                            <option value="3">3</option>
                                            <option value="4">4</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">Documented Date <span class="text-danger">*</span></label>
                                    <input type="date" class="form-control" id="fake-date" required>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">Documented Reason</label>
                                    <input type="text" class="form-control" id="fake-reason">
                                </div>
                                
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label class="form-label">Documented Old SN</label>
                                        <input type="text" class="form-control" id="fake-old-sn">
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">Documented New SN</label>
                                        <input type="text" class="form-control" id="fake-new-sn">
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">Reality (what actually happened)</label>
                                    <textarea class="form-control" id="fake-notes" rows="3"></textarea>
                                </div>
                                
                                <div class="d-flex justify-content-end gap-2">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                    <button type="button" class="btn btn-danger" onclick="saveFakeInstalled()">Save</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Fake Installed Save Toolbar (shown in edit mode) -->
            <div id="fake-edit-toolbar" class="d-none position-sticky top-0 py-2 bg-light border-bottom" style="z-index:1066;">
                <div class="container-fluid d-flex justify-content-end gap-2">
                    <button class="btn btn-sm btn-secondary" onclick="cancelFakeEdits()">Cancel</button>
                    <button class="btn btn-sm btn-primary" onclick="saveFakeEdits()">Save</button>
                </div>
            </div>

            <!-- 7B. NAMEPLATE TRACKER VIEW -->
            <div id="view-nameplate-tracker" style="display: none;">
                <h4 class="mb-3 text-info"><i class="bi bi-tags"></i> Nameplate Tracker</h4>
                <div class="row mb-3">
                    <div class="col-md-3">
                        <input type="text" class="form-control form-control-sm" 
                               id="nameplate-filter-sn">
                    </div>
                    <div class="col-md-3">
                        <input type="text" class="form-control form-control-sm" 
                               id="nameplate-filter-gss">
                    </div>
                    <div class="col-md-2">
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" id="nameplate-filter-active" checked>
                            <label class="form-check-label" for="nameplate-filter-active">Active Only</label>
                        </div>
                    </div>
                    <div class="col-md-4 text-end">
                        <button class="btn btn-sm btn-outline-secondary" onclick="loadNameplateTracker()">
                            <i class="bi bi-arrow-clockwise"></i> Refresh
                        </button>
                        <button class="btn btn-sm btn-success" onclick="openNpActionModal()">
                            <i class="bi bi-plus-circle"></i> Add
                        </button>
                    </div>
                </div>

                <div class="table-responsive mb-4 np-table-wrap">
                    <table class="table table-sm table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>#</th>
                                <th>Nameplate S/N</th>
                                <th>Engine Model</th>
                                <th>GSS ID</th>
                                <th>Orig S/N</th>
                                <th>Aircraft</th>
                                <th>Pos</th>
                                <th>Installed</th>
                                <th>Removed</th>
                                <th>Location</th>
                                <th>Action</th>
                                <th>Notes</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="nameplate-table-body">
                            <tr><td colspan="13" class="text-center text-muted">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>

                <!-- Actions Modal (NEW DESIGN: 3-column layout) -->
                <div class="modal fade" id="npActionsModal" tabindex="-1">
                    <div class="modal-dialog modal-xl">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Nameplate Action</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="row g-3">
                                    <!-- LEFT COLUMN: Date, Aircraft, Plate 1 -->
                                    <div class="col-md-4 border-end pe-3">
                                        <h6 class="text-muted mb-3">Details</h6>
                                        <div class="mb-2">
                                            <label class="form-label form-label-sm">Date *</label>
                                            <input type="date" class="form-control form-control-sm" id="np-date" required>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label form-label-sm">Aircraft *</label>
                                            <select class="form-select form-select-sm" id="np-aircraft">
                                                <option value="">- Select -</option>
                                                <option value="ER-BAT">ER-BAT</option>
                                                <option value="ER-BAR">ER-BAR</option>
                                                <option value="ER-BAQ">ER-BAQ</option>
                                            </select>
                                        </div>
                                        
                                        <div class="bg-light p-2 rounded mb-3">
                                            <h6 class="mb-2 text-primary">Plate 1</h6>
                                            <div class="mb-2">
                                                <label class="form-label form-label-sm">Model</label>
                                                <input type="text" class="form-control form-control-sm" id="np-plate1-model" readonly>
                                            </div>
                                            <div class="mb-2">
                                                <label class="form-label form-label-sm">Current SN *</label>
                                                <input type="text" class="form-control form-control-sm" id="np-plate1-sn" onchange="loadPlate1Engines()" placeholder="Select engine on this aircraft...">
                                                <small class="text-danger" id="np-plate1-warning" style="display: none;">⚠️ SN not found</small>
                                            </div>
                                            <div class="mb-2">
                                                <label class="form-label form-label-sm">Original SN</label>
                                                <input type="text" class="form-control form-control-sm" id="np-plate1-orig-sn" readonly>
                                            </div>
                                            <div class="mb-2">
                                                <label class="form-label form-label-sm">GSS ID</label>
                                                <input type="text" class="form-control form-control-sm" id="np-plate1-gss" readonly>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- CENTER COLUMN: Action Selection -->
                                    <div class="col-md-2 d-flex flex-column justify-content-center align-items-center">
                                        <label class="form-label form-label-sm text-muted mb-2">Action</label>
                                        <select class="form-select form-select-sm text-center" id="np-action-type" onchange="switchActionUI()" style="font-weight: bold;">
                                            <option value="swap">SWAP</option>
                                            <option value="remove">REMOVE</option>
                                            <option value="install">INSTALL</option>
                                        </select>
                                    </div>
                                    
                                    <!-- RIGHT COLUMN: Context (changes by action) -->
                                    <div class="col-md-6 ps-3">
                                        <!-- SWAP Context -->
                                        <div id="np-context-swap" style="display: none;">
                                            <h6 class="text-muted mb-3">Swap With</h6>
                                            <div class="bg-light p-2 rounded">
                                                <h6 class="mb-2 text-primary">Plate 2</h6>
                                                <div class="mb-2">
                                                    <label class="form-label form-label-sm">Model</label>
                                                    <input type="text" class="form-control form-control-sm" id="np-plate2-model" readonly>
                                                </div>
                                                <div class="mb-2">
                                                    <label class="form-label form-label-sm">Current SN *</label>
                                                    <input type="text" class="form-control form-control-sm" id="np-plate2-sn" onchange="loadPlate2Engines()" placeholder="Select engine on other aircraft...">
                                                    <small class="text-danger" id="np-plate2-warning" style="display: none;">⚠️ SN not found</small>
                                                </div>
                                                <div class="mb-2">
                                                    <label class="form-label form-label-sm">Original SN</label>
                                                    <input type="text" class="form-control form-control-sm" id="np-plate2-orig-sn" readonly>
                                                </div>
                                                <div class="mb-2">
                                                    <label class="form-label form-label-sm">GSS ID</label>
                                                    <input type="text" class="form-control form-control-sm" id="np-plate2-gss" readonly>
                                                </div>
                                            </div>
                                            
                                            <!-- Swap Preview Summary -->
                                            <div id="np-swap-preview" class="mt-3 p-3 rounded" style="display: none; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                                                <h6 class="mb-2" style="font-weight: bold; border-bottom: 2px solid rgba(255,255,255,0.3); padding-bottom: 8px;">📋 Swap Result Preview</h6>
                                                <div id="np-swap-preview-content" style="font-size: 0.9rem; line-height: 1.8;"></div>
                                            </div>
                                        </div>
                                        
                                        <!-- REMOVE Context -->
                                        <div id="np-context-remove" style="display: none;">
                                            <h6 class="text-muted mb-3">Removal Details</h6>
                                            <div class="mb-2">
                                                <label class="form-label form-label-sm">From Aircraft</label>
                                                <input type="text" class="form-control form-control-sm" id="np-remove-ac" readonly>
                                            </div>
                                            <div class="mb-2">
                                                <label class="form-label form-label-sm">From Position</label>
                                                <input type="text" class="form-control form-control-sm" id="np-remove-pos" readonly>
                                            </div>
                                            <div class="mb-2">
                                                <label class="form-label form-label-sm">Reason</label>
                                                <input type="text" class="form-control form-control-sm" id="np-remove-reason">
                                            </div>
                                            <div class="mb-2">
                                                <label class="form-label form-label-sm">Sent To</label>
                                                <select class="form-select form-select-sm" id="np-remove-sent-to">
                                                    <option value="">- Select -</option>
                                                    <option value="Storage">Storage</option>
                                                    <option value="Shop">Shop</option>
                                                    <option value="Repair">Repair</option>
                                                    <option value="Scrap">Scrap</option>
                                                </select>
                                            </div>
                                            <div class="mb-2">
                                                <label class="form-label form-label-sm">Available</label>
                                                <select class="form-select form-select-sm" id="np-remove-available">
                                                    <option value="Yes">Yes</option>
                                                    <option value="No">No</option>
                                                </select>
                                            </div>
                                        </div>
                                        
                                        <!-- INSTALL Context -->
                                        <div id="np-context-install" style="display: none;">
                                            <h6 class="text-muted mb-3">Installation Details</h6>
                                            <div class="mb-2">
                                                <label class="form-label form-label-sm">On Aircraft *</label>
                                                <select class="form-select form-select-sm" id="np-install-ac">
                                                    <option value="">- Select -</option>
                                                    <option value="ER-BAT">ER-BAT</option>
                                                    <option value="ER-BAR">ER-BAR</option>
                                                    <option value="ER-BAQ">ER-BAQ</option>
                                                </select>
                                            </div>
                                            <div class="mb-2">
                                                <label class="form-label form-label-sm">On Position *</label>
                                                <select class="form-select form-select-sm" id="np-install-pos">
                                                    <option value="">- Select -</option>
                                                    <option value="1">1</option>
                                                    <option value="2">2</option>
                                                    <option value="3">3</option>
                                                    <option value="4">4</option>
                                                </select>
                                            </div>
                                            <div class="mb-2">
                                                <label class="form-label form-label-sm">Reason</label>
                                                <input type="text" class="form-control form-control-sm" id="np-install-reason">
                                            </div>
                                            <div class="mb-2">
                                                <label class="form-label form-label-sm">Took From</label>
                                                <select class="form-select form-select-sm" id="np-install-from">
                                                    <option value="">- Select -</option>
                                                    <option value="Storage">Storage</option>
                                                    <option value="Repair">Repair</option>
                                                    <option value="Maintenance">Maintenance</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                <button type="button" class="btn btn-success" id="np-save-btn" onclick="saveNameplateAction()">Save</button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Datalist for engine SN autocomplete -->
                <datalist id="engine-sn-list"></datalist>
            </div>

            <!-- Nameplate Tracker Modal Form -->
            <div class="modal fade" id="nameplateTrackerModal" tabindex="-1">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Nameplate Tracker Record</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <form id="nameplate-form">
                                <input type="hidden" id="nameplate-id">
                                <div class="row mb-2">
                                    <div class="col-md-6">
                                        <label class="form-label">Nameplate S/N *</label>
                                        <input type="text" class="form-control form-control-sm" id="nameplate-sn" required>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">Engine Model</label>
                                        <input type="text" class="form-control form-control-sm" id="nameplate-engine-model">
                                    </div>
                                </div>
                                <div class="row mb-2">
                                    <div class="col-md-6">
                                        <label class="form-label">GSS ID</label>
                                        <input type="text" class="form-control form-control-sm" id="nameplate-gss-id">
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">Original S/N</label>
                                        <input type="text" class="form-control form-control-sm" id="nameplate-orig-sn">
                                    </div>
                                </div>
                                <div class="row mb-2">
                                    <div class="col-md-6">
                                        <label class="form-label">Aircraft Tail</label>
                                        <select class="form-select form-select-sm" id="nameplate-aircraft">
                                            <option value="">-</option>
                                            <option value="ER-BAT">ER-BAT</option>
                                            <option value="ER-BAR">ER-BAR</option>
                                            <option value="ER-BAQ">ER-BAQ</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">Position</label>
                                        <select class="form-select form-select-sm" id="nameplate-position">
                                            <option value="">-</option>
                                            <option value="1">1</option>
                                            <option value="2">2</option>
                                            <option value="3">3</option>
                                            <option value="4">4</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="row mb-2">
                                    <div class="col-md-6">
                                        <label class="form-label">Installed Date *</label>
                                        <input type="date" class="form-control form-control-sm" id="nameplate-installed" required>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">Removed Date</label>
                                        <input type="date" class="form-control form-control-sm" id="nameplate-removed">
                                    </div>
                                </div>
                                <div class="row mb-2">
                                    <div class="col-md-6">
                                        <label class="form-label">Location Type</label>
                                        <select class="form-select form-select-sm" id="nameplate-location">
                                            <option value="">-</option>
                                            <option value="Aircraft">Aircraft</option>
                                            <option value="Shop">Shop</option>
                                            <option value="Storage">Storage</option>
                                            <option value="Scrap">Scrap</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">Performed By</label>
                                        <input type="text" class="form-control form-control-sm" id="nameplate-performed-by">
                                    </div>
                                </div>
                                <div class="mb-2">
                                    <label class="form-label">Action Note</label>
                                    <input type="text" class="form-control form-control-sm" id="nameplate-action-note">
                                </div>
                                <div class="mb-2">
                                    <label class="form-label">Notes</label>
                                    <textarea class="form-control form-control-sm" id="nameplate-notes" rows="2"></textarea>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="button" class="btn btn-primary" onclick="saveNameplateTracker()">Save</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 8. REPAIR VIEW -->
            <div id="view-repair" style="display: none;">
                <h4 class="mb-3 text-warning"><i class="bi bi-wrench"></i> Repair Action</h4>
                
                <ul class="nav nav-tabs mb-4">
                    <li class="nav-item"><button class="nav-link active" id="tab-rep-info-btn" onclick="switchRepairTab('info')">История ремонтов</button></li>
                    <li class="nav-item"><button class="nav-link" id="tab-rep-entry-btn" onclick="switchRepairTab('entry')">Внести данные</button></li>
                </ul>

                <!-- TAB 1: History -->
                <div id="tab-rep-info">
                    <div class="card shadow-sm">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <!-- Поле поиска -->
                                <div class="input-group" style="max-width: 300px;">
                                    <span class="input-group-text bg-white text-muted"><i class="bi bi-search"></i></span>
                                    <input type="text" class="form-control border-start-0 ps-0" id="repair-search-input" placeholder="Search..." onkeyup="filterTable('repair-history-body', 'repair-search-input')">
                                </div>
                                
                                <!-- Кнопки -->
                                <div>
                                    <button class="btn btn-sm btn-primary" onclick="loadRepairHistory()"><i class="bi bi-arrow-clockwise"></i> Refresh</button>
                                    <button class="btn btn-sm btn-warning ms-2" id="btn-repair-edit" onclick="toggleEditModeTable('repair')"><i class="bi bi-pencil-square"></i> Edit</button>
                                    <button class="btn btn-sm btn-success ms-2 d-none" id="btn-repair-save" onclick="saveEditModeTable('repair')"><i class="bi bi-check-lg"></i> Save Changes</button>
                                    <button class="btn btn-sm btn-secondary ms-2 d-none" id="btn-repair-cancel" onclick="cancelEditModeTable('repair')"><i class="bi bi-x-lg"></i> Cancel</button>
                                    <button class="btn btn-circle btn-success d-none" id="add-row-repair" onclick="addEmptyRowTable('repair')" title="Add Row"><i class="bi bi-plus-lg"></i></button>
                                </div>
                            </div>
                            <table class="table table-hover table-bordered table-sm text-center">
                                <thead class="table-light">
                                    <tr>
                                        <th class="delete-col-repair" style="width: 40px; display: none;"><i class="bi bi-trash"></i></th>
                                        <th>Date</th><th>Engine</th><th>Vendor (Shop)</th><th>WO / Doc</th><th>TT / TC</th><th>Photo</th><th>Remarks</th>
                                    </tr>
                                </thead>
                                <tbody id="repair-history-body"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- TAB 2: Entry -->
                <div id="tab-rep-entry" style="display: none;">
                    <div class="card shadow-sm border-0">
                        <div class="card-header bg-white fw-bold text-warning">Record Repair Event</div>
                        <div class="card-body">
                            <form id="form-repair">
                                <div class="row mb-3">
                                    <div class="col-md-3">
                                        <label class="small fw-bold">Date *</label>
                                        <input type="date" class="form-control" id="rep-date" required>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="small fw-bold">Orig. SN *</label>
                                        <input class="form-control" list="engine-options-rep" id="rep-engine-input" placeholder="Search..." required>
                                        <datalist id="engine-options-rep"></datalist>
                                        <input type="hidden" id="rep-engine-id">
                                    </div>
                                    <div class="col-md-3">
                                        <label class="small fw-bold">Current SN</label>
                                        <input type="text" class="form-control" id="rep-cur-sn" readonly>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="small fw-bold">Current Status</label>
                                        <input type="text" class="form-control" id="rep-status-view" readonly>
                                    </div>
                                </div>

                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label class="small fw-bold">Vendor (Location/Shop) *</label>
                                        <input type="text" class="form-control" id="rep-vendor" placeholder="e.g. Lufthansa Technik">
                                    </div>
                                    <div class="col-md-3">
                                        <label class="small fw-bold">TT (Confirmed)</label>
                                        <input type="number" step="0.1" class="form-control" id="rep-tt">
                                    </div>
                                    <div class="col-md-3">
                                        <label class="small fw-bold">TC (Confirmed)</label>
                                        <input type="number" class="form-control" id="rep-tc">
                                    </div>
                                </div>

                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label class="small fw-bold">Work Order #</label>
                                        <input type="text" class="form-control" id="rep-wo" placeholder="WO-123456">
                                    </div>
                                    <div class="col-md-6">
                                        <label class="small fw-bold">Photo Link</label>
                                        <input type="text" class="form-control" id="rep-photo" placeholder="http://...">
                                    </div>
                                </div>

                                <div class="mb-4">
                                    <label class="small fw-bold">Remarks</label>
                                    <textarea class="form-control" id="rep-rem" rows="2"></textarea>
                                </div>

                                <div class="d-flex justify-content-end gap-2">
                                    <button type="button" class="btn btn-light border" onclick="switchRepairTab('info')">Cancel</button>
                                    <button type="button" class="btn btn-warning px-4" onclick="submitRepairForm()">Save (Set SV)</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>   
           <!-- 10. PARTS VIEW -->
            <div id="view-parts" style="display: none;">
                <h4 class="mb-3 text-secondary"><i class="bi bi-box-seam"></i> Parts Management</h4>
                
                <ul class="nav nav-tabs mb-4">
                    <li class="nav-item"><button class="nav-link active" id="tab-parts-list-btn" onclick="switchPartsTab('list')"><span data-parts-title="logistics">Parts Removal/Installation</span></button></li>
                    <li class="nav-item"><button class="nav-link" id="tab-parts-add-btn" onclick="switchPartsTab('add')">Внести данные (Action)</button></li>
                </ul>

                <!-- TAB 1: STORE BALANCE / HISTORY -->
                <div id="tab-parts-list">
                    <div class="card shadow-sm">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <!-- Поле поиска -->
                                <div class="input-group" style="max-width: 300px;">
                                    <span class="input-group-text bg-white text-muted"><i class="bi bi-search"></i></span>
                                    <input type="text" class="form-control border-start-0 ps-0" id="parts-search-input" placeholder="Search..." onkeyup="filterTable('parts-history-body', 'parts-search-input')">
                                </div>
                                
                                <!-- Кнопки -->
                                <div>
                                    <button class="btn btn-sm btn-primary" onclick="loadPartsHistory()"><i class="bi bi-arrow-clockwise"></i> Refresh</button>
                                    <button class="btn btn-sm btn-warning ms-2" id="btn-parts-edit" onclick="toggleEditModeTable('parts')"><i class="bi bi-pencil-square"></i> Edit</button>
                                    <button class="btn btn-sm btn-success ms-2 d-none" id="btn-parts-save" onclick="saveEditModeTable('parts')"><i class="bi bi-check-lg"></i> Save Changes</button>
                                    <button class="btn btn-sm btn-secondary ms-2 d-none" id="btn-parts-cancel" onclick="cancelEditModeTable('parts')"><i class="bi bi-x-lg"></i> Cancel</button>
                                    <button class="btn btn-circle btn-success d-none ms-2" id="add-row-parts" onclick="addEmptyRowTable('parts')" title="Add Row"><i class="bi bi-plus-lg"></i></button>
                                </div>
                            </div>
                            <div class="table-responsive">
                                <table class="table table-hover table-bordered table-sm" style="font-size: 0.85rem;">
                                    <thead class="table-light">
                                        <tr>
                                            <th class="delete-col-parts" style="width: 40px; display: none;"><i class="bi bi-trash"></i></th>
                                            <th>Date</th>
                                            <th>Action</th>
                                            <th>Part Name</th>
                                            <th>P/N</th>
                                            <th>S/N</th>
                                            <th>QTY</th>
                                            <th>From (Orig/GSS)</th>
                                            <th>To (Orig/GSS)</th>
                                            <th>Location</th>
                                            <th>Reason</th>
                                        </tr>
                                    </thead>
                                    <tbody id="parts-history-body"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- TAB 2: ADD PART ACTION -->
                <div id="tab-parts-add" style="display: none;">
                    <div class="card shadow-sm border-0">
                        <div class="card-header bg-white fw-bold">Parts Movement</div>
                        <div class="card-body">
                            <form id="form-parts">
                                <div class="row mb-3">
                                    <div class="col-md-3">
                                        <label class="small fw-bold">Date *</label>
                                        <input type="date" class="form-control" id="part-date">
                                    </div>
                                    <div class="col-md-3">
                                        <label class="small fw-bold">Action *</label>
                                        <select class="form-select" id="part-action" onchange="updatePartFormFields()">
                                            <option value="" selected disabled>Select Action...</option>
                                            <option value="INSTALLED">INSTALLED</option>
                                            <option value="REMOVED">REMOVED</option>
                                            <option value="SWAP">SWAP</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="small fw-bold">Part Name *</label>
                                        <input type="text" class="form-control" id="part-name" list="part-name-options" autocomplete="off" oninput="updatePartPNFromName()">
                                        <datalist id="part-name-options"></datalist>
                                    </div>
                                </div>

                                <div class="row mb-3">
                                    <div class="col-md-4"><label class="small fw-bold">P/N *</label><input type="text" class="form-control" id="part-pn" list="part-pn-options" autocomplete="off"><datalist id="part-pn-options"></datalist></div>
                                    <div class="col-md-4"><label class="small fw-bold">S/N *</label><input type="text" class="form-control" id="part-sn"></div>
                                    <div class="col-md-2"><label class="small fw-bold">QTY</label><input type="number" class="form-control" id="part-qty" value="1"></div>
                                    <div class="col-md-2"><label class="small fw-bold">Location</label><input type="text" class="form-control" id="part-loc" placeholder="City/Shop"></div>
                                </div>

                                <!-- DYNAMIC FIELDS (FROM / TO) -->
                                <div class="row mb-3" id="part-dynamic-fields" style="background: #f8f9fa; padding: 10px; border-radius: 5px;">
                                    <p class="small text-muted mb-2">Select Action to see fields</p>
                                </div>

                                <div class="mb-3">
                                    <label class="small fw-bold">Reason / Remarks</label>
                                    <textarea class="form-control" id="part-rem" rows="2"></textarea>
                                </div>

                                <div class="d-flex justify-content-end">
                                    <button type="button" class="btn btn-secondary me-2" onclick="switchPartsTab('list')">Cancel</button>
                                    <button type="button" class="btn btn-primary px-4" onclick="submitPartForm()">Save Record</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>  
            <!-- 10B. STORE BALANCE VIEW -->
            <div id="view-store-balance" style="display: none;">
                <h4 class="mb-3 text-primary"><i class="bi bi-collection"></i> <span data-parts-title="store">Store Balance</span></h4>

                <ul class="nav nav-tabs mb-4">
                    <li class="nav-item"><button class="nav-link active" id="tab-store-list-btn" onclick="switchStoreBalanceTab('list')">Inventory</button></li>
                    <li class="nav-item"><button class="nav-link" id="tab-store-add-btn" onclick="switchStoreBalanceTab('add')">Add Item</button></li>
                </ul>

                <!-- TAB 1: INVENTORY -->
                <div id="tab-store-list">
                    <div class="card shadow-sm">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <div class="input-group" style="max-width: 300px;">
                                    <span class="input-group-text bg-white text-muted"><i class="bi bi-search"></i></span>
                                    <input type="text" class="form-control border-start-0 ps-0" id="store-search-input" placeholder="Search..." onkeyup="filterTable('store-balance-body', 'store-search-input')">
                                </div>
                                <div>
                                    <button class="btn btn-sm btn-primary" onclick="loadStoreBalance()"><i class="bi bi-arrow-clockwise"></i> Refresh</button>
                                    <button class="btn btn-sm btn-warning ms-2" id="btn-store-balance-edit" onclick="toggleEditModeTable('store-balance')"><i class="bi bi-pencil-square"></i> Edit</button>
                                    <button class="btn btn-sm btn-success ms-2 d-none" id="btn-store-balance-save" onclick="saveEditModeTable('store-balance')"><i class="bi bi-check-lg"></i> Save Changes</button>
                                    <button class="btn btn-sm btn-secondary ms-2 d-none" id="btn-store-balance-cancel" onclick="cancelEditModeTable('store-balance')"><i class="bi bi-x-lg"></i> Cancel</button>
                                    <button class="btn btn-circle btn-success d-none ms-2" id="add-row-store-balance" onclick="addEmptyRowTable('store-balance')" title="Add Row"><i class="bi bi-plus-lg"></i></button>
                                </div>
                            </div>
                            <div class="table-responsive">
                                <table class="table table-hover table-bordered table-sm align-middle" style="font-size: 0.85rem;">
                                    <thead class="table-light">
                                        <tr>
                                            <th class="delete-col-store-balance" style="width: 40px; display: none;"><i class="bi bi-trash"></i></th>
                                            <th>Received</th>
                                            <th>Part Name</th>
                                            <th>P/N</th>
                                            <th>S/N</th>
                                            <th>Condition</th>
                                            <th>Qty</th>
                                            <th>R.O#</th>
                                            <th>Location</th>
                                            <th>Status</th>
                                            <th>Delivered to</th>
                                            <th>Remarks</th>
                                        </tr>
                                    </thead>
                                    <tbody id="store-balance-body"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- TAB 2: ADD ITEM -->
                <div id="tab-store-add" style="display: none;">
                    <div class="card shadow-sm border-0">
                        <div class="card-header bg-white fw-bold text-primary">Register Store Item</div>
                        <div class="card-body">
                            <form id="form-store-part">
                                <div class="row mb-3">
                                    <div class="col-md-3">
                                        <label class="small fw-bold">Received Date</label>
                                        <input type="date" class="form-control" id="store-date">
                                    </div>
                                    <div class="col-md-5">
                                        <label class="small fw-bold">Part Name *</label>
                                        <input type="text" class="form-control" id="store-name" placeholder="e.g. Fuel Pump">
                                    </div>
                                    <div class="col-md-4">
                                        <label class="small fw-bold">Part Number (P/N) *</label>
                                        <input type="text" class="form-control" id="store-pn" placeholder="123-456-789">
                                    </div>
                                </div>

                                <div class="row mb-3">
                                    <div class="col-md-4">
                                        <label class="small fw-bold">Serial Number (S/N)</label>
                                        <input type="text" class="form-control" id="store-sn" placeholder="Optional">
                                    </div>
                                    <div class="col-md-3">
                                        <label class="small fw-bold">Condition</label>
                                        <div class="d-flex gap-1">
                                            <select class="form-control" id="store-condition" style="flex: 1;">
                                                <option value="">-- Select --</option>
                                            </select>
                                            <button type="button" class="btn btn-sm btn-outline-success" onclick="openAddConditionModal()" title="Add new condition status" style="padding: 0.25rem 0.5rem;">
                                                <i class="bi bi-plus-lg"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="col-md-2">
                                        <label class="small fw-bold">Quantity *</label>
                                        <input type="number" class="form-control" id="store-qty" value="1" min="0">
                                    </div>
                                    <div class="col-md-3">
                                        <label class="small fw-bold">R.O#</label>
                                        <input type="text" class="form-control" id="store-unit" placeholder="EA / SET / KIT">
                                    </div>
                                </div>

                                <div class="row mb-3">
                                    <div class="col-md-4">
                                        <label class="small fw-bold">Location</label>
                                        <input type="text" class="form-control" id="store-location" placeholder="Warehouse / City">
                                    </div>
                                    <div class="col-md-4">
                                        <label class="small fw-bold">Status</label>
                                        <input type="text" class="form-control" id="store-shelf" placeholder="Aisle / Rack">
                                    </div>
                                    <div class="col-md-4">
                                        <label class="small fw-bold">Delivered to</label>
                                        <input type="text" class="form-control" id="store-owner" placeholder="Customer / Tail">
                                    </div>
                                </div>

                                <div class="mb-4">
                                    <label class="small fw-bold">Remarks</label>
                                    <textarea class="form-control" id="store-remarks" rows="2" placeholder="Notes..."></textarea>
                                </div>

                                <div class="d-flex justify-content-end gap-2">
                                    <button type="button" class="btn btn-light border" onclick="switchStoreBalanceTab('list')">Cancel</button>
                                    <button type="button" class="btn btn-primary px-4" onclick="submitStoreBalanceForm()">Save Item</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <!-- GSS REGISTRY VIEW -->
            <div id="view-gss" style="display: none;">
                <h4 class="mb-3 text-primary"><i class="bi bi-123"></i> GSS ID Registry</h4>
                <p class="text-muted">Internal Company ID Management</p>

                <div class="row">
                    <!-- LEFT: Range Generator -->
                    <div class="col-md-7 mb-4">
                        <div class="card shadow">
                            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                                <h5 class="mb-0"><i class="bi bi-sliders"></i> GSS ID Range</h5>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="show-assigned-toggle" onchange="toggleShowAssigned()">
                                    <label class="form-check-label text-white">Show assigned</label>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="row mb-3">
                                    <div class="col-md-4">
                                        <label class="form-label fw-bold">From:</label>
                                        <input type="number" id="gss-from" class="form-control" value="200" min="1">
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label fw-bold">To:</label>
                                        <input type="number" id="gss-to" class="form-control" value="229" min="1">
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">&nbsp;</label>
                                        <button class="btn btn-primary w-100" onclick="generateGSSRange()">
                                            <i class="bi bi-arrow-clockwise"></i> Generate (max 30)
                                        </button>
                                    </div>
                                </div>

                                <div class="alert alert-info mb-3">
                                    <i class="bi bi-info-circle"></i> 
                                    <strong>Legend:</strong>
                                    <span class="ms-2">🔴 Red = Available</span>
                                    <span class="ms-2">🟢 Green = Assigned</span>
                                    <span class="ms-2">🔵 Blue = Selected</span>
                                </div>

                                <div id="gss-grid-container" class="gss-grid">
                                    <div class="text-muted text-center w-100">Click "Generate" to load GSS IDs</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- RIGHT: Assignment Form -->
                    <div class="col-md-5 mb-4">
                        <div class="card shadow">
                            <div class="card-header bg-success text-white">
                                <h5 class="mb-0"><i class="bi bi-plus-circle"></i> Assign GSS ID</h5>
                            </div>
                            <div class="card-body">
                                <div class="alert alert-info mb-3" id="selected-gss-display">
                                    <strong>Selected GSS ID:</strong> 
                                    <span id="selected-gss-number" class="fs-4">-</span>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label fw-bold">Original SN <span class="text-danger">*</span></label>
                                    <select id="gss-original-sn" class="form-control" required>
                                        <option value="">-- Select Engine --</option>
                                    </select>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label fw-bold">Current SN (optional)</label>
                                    <select id="gss-current-sn" class="form-control">
                                        <option value="">-- Same as Original --</option>
                                    </select>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label fw-bold"><i class="bi bi-camera"></i> Photo</label>
                                    <div class="btn-group w-100 mb-2">
                                        <button type="button" class="btn btn-outline-primary" onclick="showPhotoOption('upload')">
                                            <i class="bi bi-upload"></i> Upload File
                                        </button>
                                        <button type="button" class="btn btn-outline-primary" onclick="showPhotoOption('url')">
                                            <i class="bi bi-link"></i> Paste URL
                                        </button>
                                    </div>

                                    <div id="photo-upload-option" style="display:none;">
                                        <input type="file" id="gss-photo-file" class="form-control" accept="image/*" onchange="previewPhoto()">
                                    </div>

                                    <div id="photo-url-option" style="display:none;">
                                        <input type="url" id="gss-photo-url" class="form-control" placeholder="https://example.com/photo.jpg" onchange="previewPhotoURL()">
                                    </div>

                                    <div id="photo-preview" class="mt-2" style="display:none;">
                                        <img id="photo-preview-img" src="" alt="Preview" style="max-width:100%; max-height:200px; border-radius:8px;">
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label fw-bold"><i class="bi bi-chat-left-text"></i> Remarks</label>
                                    <textarea id="gss-remarks" class="form-control" rows="3" placeholder="Any additional notes..."></textarea>
                                </div>

                                <button class="btn btn-success w-100 mb-2" onclick="assignGSSID()">
                                    <i class="bi bi-check-lg"></i> Assign GSS ID
                                </button>

                                <button class="btn btn-secondary w-100" onclick="clearGSSForm()">
                                    <i class="bi bi-x-lg"></i> Clear Form
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- History Table -->
                <div class="card shadow mt-4">
                    <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center" style="margin-bottom: 0; padding-bottom: 12px;">
                        <h5 class="mb-0"><i class="bi bi-clock-history"></i> GSS Assignment History</h5>
                        <button class="btn btn-sm btn-outline-light" onclick="loadGSSHistory()">
                            <i class="bi bi-arrow-clockwise"></i> Refresh
                        </button>
                    </div>
                    
                    <table class="table table-striped table-hover mb-0">
                        <thead class="table-dark">
                            <tr>
                                <th>GSS ID</th>
                                <th>Photo</th>
                                <th>Original SN</th>
                                <th>Current SN</th>
                                <th>Model</th>
                                <th>Location</th>
                                <th>Assigned By</th>
                                <th>Date</th>
                                <th>Remarks</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="gss-history-tbody">
                            <tr><td colspan="10" class="text-center text-muted">No assignments yet</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- 11. ATLB VIEW (UTILIZATION) -->
            <div id="view-atlb" style="display: none;">
                <h4 class="mb-3 text-info"><i class="bi bi-journal-richtext"></i> Aircraft Technical Log Book</h4>
                
                <ul class="nav nav-tabs mb-4">
                    <li class="nav-item"><button class="nav-link active" id="tab-atlb-entry-btn" onclick="switchAtlbTab('entry')">Внести данные</button></li>
                    <li class="nav-item"><button class="nav-link" id="tab-atlb-list-btn" onclick="switchAtlbTab('list')">Utilization Table</button></li>
                </ul>

                <!-- TAB 1: ENTRY FORM -->
                <div id="tab-atlb-entry">
                    <div class="card shadow-sm border-0">
                        <div class="card-body" style="background-color: #f8f9fa;">
                            
                            <form id="form-atlb">
                                <!-- HEADER: AC INFO -->
                                <div class="row mb-3">
                                    <div class="col-md-3">
                                        <label class="small fw-bold">A/C Reg No</label>
                                        <select class="form-select" id="atlb-ac" onchange="updateAcInfo()"></select>
                                    </div>
                                    <div class="col-md-2">
                                        <label class="small fw-bold">A/C MSN</label>
                                        <input type="text" class="form-control bg-light" id="atlb-msn" readonly>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="small fw-bold">Current TTSN / TCSN</label>
                                        <input type="text" class="form-control bg-light text-center fw-bold" id="atlb-stats" readonly>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="border p-2 bg-white rounded">
                                            <div class="text-muted small mb-1">Last data</div>
                                            <div class="d-flex gap-2">
                                                <input type="text" class="form-control form-control-sm" id="atlb-last-date" placeholder="Last Date" readonly>
                                                <input type="text" class="form-control form-control-sm" id="atlb-last-sheet" placeholder="Last Sheet" readonly>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                
                                <!-- ROW 2: DATE, ROUTE & CHECKBOXES -->
                                <div class="row mb-3 align-items-end">
                                    <div class="col-md-2">
                                        <label class="small fw-bold">Date</label>
                                        <input type="date" class="form-control" id="atlb-date">
                                    </div>
                                    <div class="col-md-2">
                                        <label class="small fw-bold">ATLB Sheet No</label>
                                        <input type="text" class="form-control" id="atlb-no" list="atlb-no-suggestions">
                                        <datalist id="atlb-no-suggestions"></datalist>
                                    </div>
                                    
                                    <!-- Flight Leg теперь просто поля, на одном уровне -->
                                    <div class="col-md-2">
                                        <label class="small fw-bold">From</label>
                                        <input type="text" class="form-control" id="atlb-from" placeholder="ICAO">
                                    </div>
                                    <div class="col-md-2">
                                        <label class="small fw-bold">To</label>
                                        <input type="text" class="form-control" id="atlb-to" placeholder="ICAO">
                                    </div>

                                    <!-- Чекбоксы -->
                                    <div class="col-md-4">
                                        <div class="d-flex gap-3 pb-2"> <!-- pb-2 для выравнивания с инпутами -->
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="atlb-cancel">
                                                <label class="form-check-label small">Cancelled</label>
                                            </div>
                                            <div class="form-check">
                                                <!-- Добавили Maintenance Only с функцией блокировки -->
                                                <input class="form-check-input" type="checkbox" id="atlb-maint-only" onchange="toggleFlightTimes()">
                                                <label class="form-check-label small fw-bold text-danger">Maintenance Only</label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                    
                                </div>

                                <!-- ROW 3: TIMES (BLOCK & FLIGHT) -->
                                <div class="row mb-3">
                                    <!-- BLOCK TIME -->
                                    <div class="col-md-6">
                                        <div class="border p-3 bg-white rounded">
                                            <h6 class="small fw-bold border-bottom pb-1 mb-2">Block Time</h6>
                                            <div class="row g-2">
                                                <div class="col-4">
                                                    <label class="small text-muted">Out (HH:MM)</label>
                                                    <input type="time" class="form-control" id="time-out" onchange="calcTime('block')">
                                                </div>
                                                <div class="col-4">
                                                    <label class="small text-muted">In (HH:MM)</label>
                                                    <input type="time" class="form-control" id="time-in" onchange="calcTime('block')">
                                                </div>
                                                <div class="col-4">
                                                    <label class="small text-primary fw-bold">Time</label>
                                                    <input type="text" class="form-control border-primary fw-bold" id="time-block-res" readonly>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- FLIGHT TIME -->
                                    <div class="col-md-6">
                                        <div class="border p-3 bg-white rounded">
                                            <h6 class="small fw-bold border-bottom pb-1 mb-2">Flight Time</h6>
                                            <div class="row g-2">
                                                <div class="col-4">
                                                    <label class="small text-muted">Off (HH:MM)</label>
                                                    <input type="time" class="form-control" id="time-off" onchange="calcTime('flight')">
                                                </div>
                                                <div class="col-4">
                                                    <label class="small text-muted">On (HH:MM)</label>
                                                    <input type="time" class="form-control" id="time-on" onchange="calcTime('flight')">
                                                </div>
                                                <div class="col-4">
                                                    <label class="small text-success fw-bold">Time</label>
                                                    <input type="text" class="form-control border-success fw-bold" id="time-flight-res" readonly>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- ROW 4: MAINTENANCE & CYCLES -->
                                <div class="row mb-3">
                                    <div class="col-md-8">
                                        <div class="border p-2 bg-white rounded">
                                            <label class="small fw-bold">Maintenance</label>
                                            <select class="form-select" id="atlb-maint">
                                                <option value="">Select...</option>
                                                <option>Daily Check</option>
                                                <option>PF Check</option>
                                                <option>TR Check</option>
                                                <option>Daily & PF/TR Check</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                     
                                </div>

                                <!-- ROW 5: FLUIDS -->
                                <div class="row mb-4">
                                    <div class="col-md-6">
                                        <div class="border p-2 bg-white rounded">
                                            <label class="small fw-bold">Oil Uplift</label>
                                            <div class="d-flex gap-2">
                                                <input type="number" class="form-control form-control-sm" placeholder="Eng 1" id="oil-1">
                                                <input type="number" class="form-control form-control-sm" placeholder="Eng 2" id="oil-2">
                                                <input type="number" class="form-control form-control-sm" placeholder="Eng 3" id="oil-3">
                                                <input type="number" class="form-control form-control-sm" placeholder="Eng 4" id="oil-4">
                                                <input type="number" class="form-control form-control-sm" placeholder="APU" id="oil-apu">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="border p-2 bg-white rounded">
                                            <label class="small fw-bold">Hydraulic Uplift</label>
                                            <div class="d-flex gap-2">
                                                <input type="number" class="form-control form-control-sm" placeholder="Sys 1" id="hyd-1">
                                                <input type="number" class="form-control form-control-sm" placeholder="Sys 2" id="hyd-2">
                                                <input type="number" class="form-control form-control-sm" placeholder="Sys 3" id="hyd-3">
                                                <input type="number" class="form-control form-control-sm" placeholder="Sys 4" id="hyd-4">
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="d-flex justify-content-between">
                                    <button type="button" class="btn btn-outline-secondary" onclick="switchAtlbTab('list')">Show utilization table</button>
                                    <div>
                                        <button type="button" class="btn btn-light border me-2">Clear</button>
                                        <button type="button" class="btn btn-success px-5" onclick="submitAtlbForm()">SAVE</button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- TAB 2: LIST -->
                <div id="tab-atlb-list" style="display: none;">
                    <div class="card shadow-sm">
                        <div class="card-body">
                            <div class="d-flex justify-content-end mb-2">
                                <button class="btn btn-success btn-sm me-2"><i class="bi bi-file-earmark-excel"></i> Export Excel</button>
                                <button class="btn btn-primary btn-sm" onclick="loadAtlbHistory()">Refresh</button>
                            </div>
                            <div class="table-responsive">
                                <table class="table table-bordered table-hover table-sm text-center" style="font-size: 0.8rem;">
                                    <thead class="table-secondary align-middle">
                                        <tr>
                                            <th rowspan="2" data-col="date">Date 
                                                <i class="bi bi-funnel-fill filter-icon" id="filter-icon-atlb-date" data-bs-toggle="dropdown"></i>
                                                <div class="dropdown-menu filter-dropdown-menu" id="filter-menu-atlb-date"></div>
                                            </th>
                                            <th rowspan="2" data-col="tail">A/C 
                                                <i class="bi bi-funnel-fill filter-icon" id="filter-icon-atlb-tail" data-bs-toggle="dropdown"></i>
                                                <div class="dropdown-menu filter-dropdown-menu" id="filter-menu-atlb-tail"></div>
                                            </th>
                                            <th rowspan="2" data-col="ref">ATLB Sheet 
                                                <i class="bi bi-funnel-fill filter-icon" id="filter-icon-atlb-ref" data-bs-toggle="dropdown"></i>
                                                <div class="dropdown-menu filter-dropdown-menu" id="filter-menu-atlb-ref"></div>
                                            </th>
                                            <th rowspan="2" data-col="route">Flight Leg 
                                                <i class="bi bi-funnel-fill filter-icon" id="filter-icon-atlb-route" data-bs-toggle="dropdown"></i>
                                                <div class="dropdown-menu filter-dropdown-menu" id="filter-menu-atlb-route"></div>
                                            </th>
        
                                            <th colspan="3">Block Time</th>
                                            <th colspan="3">Flight Time</th>

        
                                            <th rowspan="2" data-col="cycles">Cycles 
                                                <i class="bi bi-funnel-fill filter-icon" id="filter-icon-atlb-cycles" data-bs-toggle="dropdown"></i>
                                                <div class="dropdown-menu filter-dropdown-menu" id="filter-menu-atlb-cycles"></div>
                                            </th>
                                            <th rowspan="2">TTSN</th>
                                            <th rowspan="2">TCSN</th>
                                            <th colspan="5">Oil Service</th>
                                            <th colspan="4">Hyd Service</th>
                                            <th rowspan="2">Maintenance</th>
                                            <th rowspan="2" data-col="user">User 
                                                <i class="bi bi-funnel-fill filter-icon" id="filter-icon-atlb-user" data-bs-toggle="dropdown"></i>
                                                <div class="dropdown-menu filter-dropdown-menu" id="filter-menu-atlb-user"></div>
                                            </th>
                                        </tr>
                                        <tr>
                                            <th>Out</th>
                                            <th>In</th>
                                            <th>Time</th>
                                            <th>Off</th>
                                            <th>On</th>
                                            <th>Time</th>
                                            <th data-col="eng1">Eng1</th>
                                            <th data-col="eng2">Eng2</th>
                                            <th data-col="eng3">Eng3</th>
                                            <th data-col="eng4">Eng4</th>
                                            <th data-col="eng_apu">APU</th>
                                            <th data-col="hyd1">Hsys1</th>
                                            <th data-col="hyd2">Hsys2</th>
                                            <th data-col="hyd3">Hsys3</th>
                                            <th data-col="hyd4">Hsys4</th>
                                        </tr>
                                    </thead>
                                    <tbody id="atlb-history-body"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            <!-- 12. ENGINE PARAMETERS VIEW -->
            <div id="view-eng-param" style="display: none;">
                <h4 class="mb-3 text-info"><i class="bi bi-sliders"></i> Engine Parameters Entry</h4>
                
                <ul class="nav nav-tabs mb-4">
                    <li class="nav-item"><button class="nav-link active" id="tab-param-entry-btn" onclick="switchParamTab('entry')">Enter Parameters</button></li>
                    <li class="nav-item"><button class="nav-link" id="tab-param-history-btn" onclick="switchParamTab('history')">История</button></li>
                </ul>
                
                <!-- TAB 1: ENTRY FORM -->
                <div id="tab-param-entry">
                    <div class="card shadow-sm border-0">
                        <div class="card-body">
                            <form id="form-eng-param">
                            <!-- HEADER -->
                            <div class="row mb-4">
                                <div class="col-md-3">
                                    <label class="small fw-bold">Date *</label>
                                    <input type="date" class="form-control" id="param-date" required>
                                </div>
                                <div class="col-md-3">
                                    <label class="small fw-bold">Aircraft *</label>
                                    <select class="form-select" id="param-ac" required onchange="loadEnginePositions()">
                                        <option value="">Select A/C...</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label class="small fw-bold">Engine Position *</label>
                                    <select class="form-select" id="param-position" required>
                                        <option value="">Select position...</option>
                                        <option value="1">Position 1</option>
                                        <option value="2">Position 2</option>
                                        <option value="3">Position 3</option>
                                        <option value="4">Position 4</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label class="small fw-bold">Engine S/N</label>
                                    <input type="text" class="form-control" id="param-engine-sn" readonly placeholder="Select position first">
                                </div>
                            </div>

                            <!-- TAKEOFF SECTION -->
                            <div class="border p-3 mb-3 rounded bg-light">
                                <h6 class="text-primary fw-bold border-bottom pb-2 mb-3">Takeoff Data</h6>
                                
                                <div class="row mb-2">
                                    <div class="col-md-3">
                                        <label class="small fw-bold">Type</label>
                                        <select class="form-select" id="param-type-to" disabled>
                                            <option value="Takeoff" selected>Takeoff</option>
                                        </select>
                                    </div>
                                    
                                    <div class="col-md-9">
                                        <div class="row">
                                            <div class="col-md-3">
                                                <label class="small text-muted">N1</label>
                                                <input type="number" step="0.1" class="form-control" id="to-n1" placeholder="e.g. 95.5">
                                            </div>
                                            <div class="col-md-3">
                                                <label class="small text-muted">N2</label>
                                                <input type="number" step="0.1" class="form-control" id="to-n2" placeholder="e.g. 98.2">
                                            </div>
                                            <div class="col-md-3">
                                                <label class="small text-muted">EGT (°C)</label>
                                                <input type="number" step="1" class="form-control" id="to-egt" placeholder="e.g. 650">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- CRUISE SECTION -->
                            <div class="border p-3 mb-4 rounded bg-light">
                                <h6 class="text-success fw-bold border-bottom pb-2 mb-3">Cruise Data</h6>
                                
                                <div class="row mb-2">
                                    <div class="col-md-3">
                                        <label class="small fw-bold">Type</label>
                                        <select class="form-select" id="param-type-cr" disabled>
                                            <option value="Cruise" selected>Cruise</option>
                                        </select>
                                    </div>
                                    
                                    <div class="col-md-9">
                                        <div class="row">
                                            <div class="col-md-3">
                                                <label class="small text-muted">N1</label>
                                                <input type="number" step="0.1" class="form-control" id="cr-n1" placeholder="e.g. 85.0">
                                            </div>
                                            <div class="col-md-3">
                                                <label class="small text-muted">N2</label>
                                                <input type="number" step="0.1" class="form-control" id="cr-n2" placeholder="e.g. 92.0">
                                            </div>
                                            <div class="col-md-3">
                                                <label class="small text-muted">EGT (°C)</label>
                                                <input type="number" step="1" class="form-control" id="cr-egt" placeholder="e.g. 580">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="d-flex justify-content-end gap-2">
                                <button type="button" class="btn btn-secondary" onclick="openDashboardView()">Cancel</button>
                                <button type="button" class="btn btn-primary px-4" onclick="submitEngParams()">Save Parameters</button>
                            </div>
                        </form>
                    </div>
                </div>
                </div>
                
                <!-- TAB 2: HISTORY TABLE -->
                <div id="tab-param-history" style="display: none;">
                    <div class="card shadow-sm">
                        <div class="card-body">
                            <div class="d-flex justify-content-end mb-2">
                                <button class="btn btn-sm btn-primary" onclick="loadParameterHistory()"><i class="bi bi-arrow-clockwise"></i> Refresh</button>
                                <button class="btn btn-sm btn-warning ms-2" id="btn-param-edit" onclick="toggleEditModeTable('param')"><i class="bi bi-pencil-square"></i> Edit</button>
                                <button class="btn btn-sm btn-success ms-2 d-none" id="btn-param-save" onclick="saveEditModeTable('param')"><i class="bi bi-check-lg"></i> Save Changes</button>
                                <button class="btn btn-sm btn-secondary ms-2 d-none" id="btn-param-cancel" onclick="cancelEditModeTable('param')"><i class="bi bi-x-lg"></i> Cancel</button>
                                <button class="btn btn-circle btn-success d-none" id="add-row-param" onclick="addEmptyRowTable('param')" title="Add Row"><i class="bi bi-plus-lg"></i></button>
                            </div>
                            <table class="table table-hover table-bordered table-sm text-center" id="param-history-table">
                                <thead class="table-light">
                                    <tr>
                                        <th class="delete-col-param" style="display: none;"><i class="bi bi-trash"></i></th>
                                        <th>Date</th>
                                        <th>Aircraft</th>
                                        <th>Position</th>
                                        <th>Engine S/N</th>
                                        <th>N1 TO</th>
                                        <th>N2 TO</th>
                                        <th>EGT TO</th>
                                        <th>N1 CR</th>
                                        <th>N2 CR</th>
                                        <th>EGT CR</th>
                                        <th>Created At</th>
                                    </tr>
                                </thead>
                                <tbody id="param-history-body">
                                    <tr><td colspan="12" class="text-muted">Loading...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- UTILIZATION PARAMETERS VIEW -->
            <div id="view-utilization-param" style="display: none;">
                <h4 class="mb-3 text-info"><i class="bi bi-bar-chart-line"></i> Utilization Parameters</h4>
                
                <ul class="nav nav-tabs mb-4">
                    <li class="nav-item"><button class="nav-link active" id="tab-util-param-entry-btn" onclick="switchUtilParamTab('entry')">Внести данные</button></li>
                    <li class="nav-item"><button class="nav-link" id="tab-util-param-history-btn" onclick="switchUtilParamTab('history')">История</button></li>
                </ul>
                
                <!-- TAB 1: ENTRY FORM -->
                <div id="tab-util-param-entry">
                    <div class="card shadow-sm border-0">
                        <div class="card-body">
                            <form id="form-util-param">
                                <div class="row mb-4">
                                    <div class="col-md-2">
                                        <label class="small fw-bold">Дата *</label>
                                        <input type="date" class="form-control" id="util-param-date" required>
                                        <small class="text-muted">По умолчанию сегодняшняя дата</small>
                                    </div>
                                    <div class="col-md-2">
                                        <label class="small fw-bold">Самолет *</label>
                                        <select class="form-select" id="util-param-ac" required onchange="onUtilAircraftChange()">
                                            <option value="">Выберите самолет...</option>
                                            <option value="ER-BAT">ER-BAT</option>
                                            <option value="ER-BAR">ER-BAR</option>
                                            <option value="ER-BAQ">ER-BAQ</option>
                                        </select>
                                    </div>
                                    <div class="col-md-2">
                                        <label class="small fw-bold">Позиция *</label>
                                        <select class="form-select" id="util-param-position" required onchange="onUtilPositionChange()">
                                            <option value="">Выберите позицию...</option>
                                            <option value="1">1</option>
                                            <option value="2">2</option>
                                            <option value="3">3</option>
                                            <option value="4">4</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <!-- Информация о всех позициях для справки -->
                                <div id="all-positions-info" class="row mb-3" style="display: none;">
                                    <div class="col-12">
                                        <div class="alert alert-info" style="background: #e7f3ff; border: 1px solid #0066cc; padding: 12px;">
                                            <h6 class="mb-2">Двигатели на самолете:</h6>
                                            <div id="positions-info-content" style="display: flex; gap: 15px; flex-wrap: wrap;"></div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row mb-4">
                                    <div class="col-md-3">
                                        <label class="small fw-bold">Orig SN (выбранной позиции)</label>
                                        <input type="text" class="form-control" id="util-param-orig-sn" readonly style="background-color: #f5f5f5;">
                                    </div>
                                    <div class="col-md-3">
                                        <label class="small fw-bold">GSS ID (выбранной позиции)</label>
                                        <input type="text" class="form-control" id="util-param-gss-sn" readonly style="background-color: #f5f5f5;">
                                    </div>
                                </div>
                                <div class="row mb-4">
                                    <div class="col-md-2">
                                        <label class="small fw-bold">TTSN *</label>
                                        <input type="number" step="0.1" class="form-control" id="util-param-ttsn" required placeholder="Введите TTSN">
                                    </div>
                                    <div class="col-md-2">
                                        <label class="small fw-bold">TCSN *</label>
                                        <input type="number" class="form-control" id="util-param-tcsn" required placeholder="Введите TCSN">
                                    </div>
                                </div>
                                
                                <!-- PERIOD FIELDS (always enabled and required) -->
                                <div class="row mb-4" id="period-fields">
                                    <div class="col-md-6">
                                        <label class="small fw-bold">Date From *</label>
                                        <input type="date" class="form-control" id="util-param-date-from" required>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="small fw-bold">Date To *</label>
                                        <input type="date" class="form-control" id="util-param-date-to" required>
                                    </div>
                                </div>
                                
                                <div class="d-flex justify-content-end gap-2 mb-4">
                                    <button type="button" class="btn btn-secondary" onclick="openDashboardView()">Отмена</button>
                                    <button type="button" class="btn btn-primary px-4" onclick="submitUtilParams()">Сохранить</button>
                                </div>
                            </form>
                            
                            <!-- SECTION 2: TOTAL AIRCRAFT UTILIZATION -->
                            <hr class="my-5">
                            <h5 class="mb-4 text-primary"><i class="bi bi-airplane"></i> Total Aircraft Utilization</h5>
                            <form id="form-aircraft-util">
                                <div class="row mb-3">
                                    <div class="col-md-4">
                                        <label class="small fw-bold">Date Aircraft *</label>
                                        <select class="form-select" id="aircraft-util-ac" required onchange="onAircraftUtilChange()">
                                            <option value="">Выберите самолет...</option>
                                            <option value="ER-BAT">ER-BAT</option>
                                            <option value="ER-BAR">ER-BAR</option>
                                            <option value="ER-BAQ">ER-BAQ</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="small fw-bold">Date *</label>
                                        <input type="date" class="form-control" id="aircraft-util-date" required>
                                        <small class="text-muted">По умолчанию сегодняшняя дата</small>
                                    </div>
                                </div>
                                
                                <div class="row mb-3">
                                    <div class="col-md-4">
                                        <label class="small fw-bold">Total A/C TTSN *</label>
                                        <input type="text" class="form-control" id="aircraft-util-ttsn" required placeholder="e.g. 103999:34 or 103999.57">
                                        <small class="text-muted">Format: HH:MM or decimal</small>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="small fw-bold">Total A/C TCSN *</label>
                                        <input type="number" class="form-control" id="aircraft-util-tcsn" required placeholder="Введите TCSN самолета">
                                    </div>
                                </div>
                                
                                <div class="d-flex justify-content-end gap-2">
                                    <button type="button" class="btn btn-success px-4" onclick="submitAircraftUtil()"><i class="bi bi-check-lg"></i> Сохранить</button>
                                </div>
                            </form>
                            </form>
                        </div>
                    </div>
                </div>
                
                <!-- TAB 2: HISTORY TABLE -->
                <div id="tab-util-param-history" style="display: none;">
                    <!-- SUB-TABS: Periodic and Aircraft Util History -->
                    <ul class="nav nav-tabs mb-3">
                        <li class="nav-item"><button class="nav-link active" id="tab-util-param-periodic-btn" onclick="switchUtilHistoryTab('periodic')">Периодичный налет</button></li>
                        <li class="nav-item"><button class="nav-link" id="tab-util-param-aircraft-btn" onclick="switchUtilHistoryTab('aircraft')">Общий налет самолёта</button></li>
                    </ul>
                    
                    <!-- SUB-TAB 1: Periodic Utilization History -->
                    <div id="tab-util-param-periodic" class="card shadow-sm">
                        <div class="card-body">
                            <div class="d-flex justify-content-end mb-2">
                                <button class="btn btn-sm btn-primary" onclick="loadUtilParamHistory()"><i class="bi bi-arrow-clockwise"></i> Обновить</button>
                                <button class="btn btn-sm btn-warning ms-2" id="btn-util-param-edit" onclick="toggleEditModeTable('util-param')"><i class="bi bi-pencil-square"></i> Edit</button>
                                <button class="btn btn-sm btn-success ms-2 d-none" id="btn-util-param-save" onclick="saveEditModeTable('util-param')"><i class="bi bi-check-lg"></i> Save Changes</button>
                                <button class="btn btn-sm btn-secondary ms-2 d-none" id="btn-util-param-cancel" onclick="cancelEditModeTable('util-param')"><i class="bi bi-x-lg"></i> Cancel</button>
                                <button class="btn btn-circle btn-success d-none" id="add-row-util-param" onclick="addEmptyRowTable('util-param')" title="Add Row"><i class="bi bi-plus-lg"></i></button>
                            </div>
                            <table class="table table-hover table-bordered table-sm text-center" id="util-param-history-table">
                                <thead class="table-light">
                                    <tr>
                                        <th class="delete-col-util-param" style="display: none;"><i class="bi bi-trash"></i></th>
                                        <th>Дата</th>
                                        <th>Самолет</th>
                                        <th>Позиция</th>
                                        <th>Orig SN</th>
                                        <th>GSS ID</th>
                                        <th>TTSN</th>
                                        <th>TCSN</th>
                                        <th>Period</th>
                                        <th>Date From</th>
                                        <th>Date To</th>
                                        <th>Создано</th>
                                    </tr>
                                </thead>
                                <tbody id="util-param-history-body">
                                    <tr><td colspan="12" class="text-muted">Нет данных</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- SUB-TAB 2: Aircraft Utilization History -->
                    <div id="tab-util-param-aircraft" style="display: none;" class="card shadow-sm">
                        <div class="card-body">
                            <div class="d-flex justify-content-end mb-2">
                                <button class="btn btn-sm btn-primary" onclick="loadAircraftUtilHistory()"><i class="bi bi-arrow-clockwise"></i> Обновить</button>
                            </div>
                            <table class="table table-hover table-bordered table-sm text-center" id="aircraft-util-history-table">
                                <thead class="table-light">
                                    <tr>
                                        <th>Дата</th>
                                        <th>Самолет</th>
                                        <th>Total A/C TTSN</th>
                                        <th>Total A/C TCSN</th>
                                        <th>Сохранено</th>
                                    </tr>
                                </thead>
                                <tbody id="aircraft-util-history-body">
                                    <tr><td colspan="5" class="text-muted">Нет данных</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- UTILIZATION HISTORY MODAL -->
            <div id="utilization-history-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; justify-content: center; align-items: center;">
                <div style="background: white; border-radius: 8px; max-width: 900px; max-height: 80vh; overflow: auto; box-shadow: 0 4px 20px rgba(0,0,0,0.3); padding: 20px; position: relative;">
                    <button onclick="closeUtilizationHistoryModal()" style="position: absolute; top: 10px; right: 10px; background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #999;">&times;</button>
                    <h5 class="mb-3"><i class="bi bi-bar-chart-line"></i> Utilization Parameters History</h5>
                    <div id="utilization-history-modal-content">
                        <table class="table table-sm table-bordered table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>Дата</th>
                                    <th>Самолет</th>
                                    <th>TTSN</th>
                                    <th>TCSN</th>
                                    <th>Period</th>
                                    <th>Date From</th>
                                    <th>Date To</th>
                                    <th>Создано</th>
                                </tr>
                            </thead>
                            <tbody id="utilization-history-modal-body">
                                <tr><td colspan="8" class="text-muted">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- 11. UTILIZATION VIEW -->
            <div id="view-util" style="display: none;">
                <h4 class="mb-3 text-info"><i class="bi bi-speedometer2"></i> Aircraft Utilization (ATLB)</h4>
                
                <ul class="nav nav-tabs mb-4">
                    <li class="nav-item"><button class="nav-link active" id="tab-util-list-btn" onclick="switchUtilTab('list')">Flight History</button></li>
                    <li class="nav-item"><button class="nav-link" id="tab-util-entry-btn" onclick="switchUtilTab('entry')">Enter Flight Data</button></li>
                </ul>

                <!-- TAB 1: HISTORY TABLE -->
                                
                <div id="tab-util-list">
                    <div class="card shadow-sm">
                        <div class="card-body">
                            <div class="d-flex justify-content-end mb-2">
                                <button class="btn btn-sm btn-primary" onclick="loadUtilHistory()"><i class="bi bi-arrow-clockwise"></i> Refresh</button>
                                <button class="btn btn-sm btn-warning ms-2" id="btn-util-edit" onclick="toggleEditModeTable('util')"><i class="bi bi-pencil-square"></i> Edit</button>
                                <button class="btn btn-sm btn-success ms-2 d-none" id="btn-util-save" onclick="saveEditModeTable('util')"><i class="bi bi-check-lg"></i> Save Changes</button>
                                <button class="btn btn-sm btn-secondary ms-2 d-none" id="btn-util-cancel" onclick="cancelEditModeTable('util')"><i class="bi bi-x-lg"></i> Cancel</button>
                                <button class="btn btn-circle btn-success d-none" id="add-row-util" onclick="addEmptyRowTable('util')" title="Add Row"><i class="bi bi-plus-lg"></i></button>
                            </div>
                            <table class="table table-hover table-bordered table-sm text-center" id="util-table">
                                <thead class="table-light">
                                    <tr>
                                        <th class="delete-col-util" style="width: 40px; display: none;"><i class="bi bi-trash"></i></th>
                                        <!-- Добавляем data-col для идентификации столбца -->
                                        <th data-col="date">Date <i class="bi bi-funnel-fill filter-icon" id="filter-icon-date" data-bs-toggle="dropdown"></i>
                                            <div class="dropdown-menu filter-dropdown-menu" id="filter-menu-date"></div>
                                        </th>
                                        <th data-col="aircraft">Aircraft <i class="bi bi-funnel-fill filter-icon" id="filter-icon-aircraft" data-bs-toggle="dropdown"></i>
                                            <div class="dropdown-menu filter-dropdown-menu" id="filter-menu-aircraft"></div>
                                        </th>
                                        <th data-col="route">Route <i class="bi bi-funnel-fill filter-icon" id="filter-icon-route" data-bs-toggle="dropdown"></i>
                                            <div class="dropdown-menu filter-dropdown-menu" id="filter-menu-route"></div>
                                        </th>
                                        <th data-col="time">Flight Time <i class="bi bi-funnel-fill filter-icon" id="filter-icon-time" data-bs-toggle="dropdown"></i>
                                            <div class="dropdown-menu filter-dropdown-menu" id="filter-menu-time"></div>
                                        </th>
                                        <th data-col="cycles">Cycles <i class="bi bi-funnel-fill filter-icon" id="filter-icon-cycles" data-bs-toggle="dropdown"></i>
                                            <div class="dropdown-menu filter-dropdown-menu" id="filter-menu-cycles"></div>
                                        </th>
                                        <th data-col="ref">ATLB Ref <i class="bi bi-funnel-fill filter-icon" id="filter-icon-ref" data-bs-toggle="dropdown"></i>
                                            <div class="dropdown-menu filter-dropdown-menu" id="filter-menu-ref"></div>
                                        </th>
                                    </tr>
                                </thead>
                                <tbody id="util-history-body"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
              

                <!-- TAB 2: DATA ENTRY FORM -->
                <div id="tab-util-entry" style="display: none;">
                    <div class="card shadow-sm border-0">
                        <div class="card-header bg-white fw-bold text-info">New Flight Entry</div>
                        <div class="card-body">
                            <form id="form-util">
                                <!-- ВЕРХНИЙ БЛОК (САМОЛЕТ И ДАТА) -->
                                <div class="row mb-3">
                                    <div class="col-md-3">
                                        <label class="small fw-bold">Date *</label>
                                        <input type="date" class="form-control" id="util-date" required>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="small fw-bold">Aircraft Reg No *</label>
                                        <select class="form-select" id="util-ac" required></select>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="small fw-bold">ATLB Sheet No</label>
                                        <input type="text" class="form-control" id="util-atlb">
                                    </div>
                                    <div class="col-md-3">
                                        <label class="small fw-bold">Current TTSN / TCSN</label>
                                        <input type="text" class="form-control bg-light" id="util-current-stats" readonly placeholder="Select AC...">
                                    </div>
                                </div>

                                <!-- СРЕДНИЙ БЛОК (МАРШРУТ) -->
                                <div class="p-3 mb-3" style="background-color: #f8f9fa; border-radius: 5px;">
                                    <h6 class="text-muted border-bottom pb-2">Flight Leg</h6>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <label class="small fw-bold">From</label>
                                            <input type="text" class="form-control" id="util-from" placeholder="ICAO (e.g. UAAA)">
                                        </div>
                                        <div class="col-md-6">
                                            <label class="small fw-bold">To</label>
                                            <input type="text" class="form-control" id="util-to" placeholder="ICAO (e.g. UAFM)">
                                        </div>
                                    </div>
                                </div>

                                <!-- НИЖНИЙ БЛОК (ВРЕМЯ) -->
                                <div class="row mb-4">
                                    <div class="col-md-6">
                                        <label class="small fw-bold text-primary">Flight Time (Hours) *</label>
                                        <input type="number" step="0.01" class="form-control border-primary" id="util-fh" placeholder="e.g. 2.50">
                                        <small class="text-muted">Block time or Airborne time</small>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="small fw-bold text-primary">Cycles (Landings) *</label>
                                        <input type="number" class="form-control border-primary" id="util-fc" value="1">
                                    </div>
                                </div>

                                <div class="row mb-3">
                                    <div class="col-12">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="util-maintenance">
                                            <label class="form-check-label small fw-bold" for="util-maintenance">Maintenance (No Flight Time)</label>
                                        </div>
                                        <small class="text-muted">При отметке налет и циклы не увеличиваются, но запись сохраняется.</small>
                                    </div>
                                </div>

                                <div class="d-flex justify-content-end gap-2">
                                    <button type="button" class="btn btn-light border" onclick="switchUtilTab('list')">Cancel</button>
                                    <button type="button" class="btn btn-info text-white px-4" onclick="submitUtilForm()">SAVE</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
            <!-- 7. MASTER ENGINE VIEW (MAIN) -->
            <div id="view-main-engine" style="display: none;">
                <h4 class="mb-3 text-primary"><i class="bi bi-database-fill"></i> Master Engine List</h4>
                
                <ul class="nav nav-tabs mb-4">
                    <li class="nav-item"><button class="nav-link active" id="tab-main-list-btn" onclick="switchMainTab('list')">Список двигателей</button></li>
                    <li class="nav-item"><button class="nav-link" id="tab-main-add-btn" onclick="switchMainTab('add')">Добавить двигатель</button></li>
                </ul>

                <!-- TAB 1: LIST & EDIT -->
                <div id="tab-main-list">
                    <div class="card shadow-sm">
                        <div class="card-body">
                            <!-- Поиск и Кнопки управления -->
                            <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
                                <div class="input-group" style="max-width: 350px;">
                                    <span class="input-group-text bg-white text-muted"><i class="bi bi-search"></i></span>
                                    <input type="text" class="form-control border-start-0 ps-0" id="main-engine-search" placeholder="Search S/N, Model, GSS, Location, Remarks..." onkeyup="filterTable('main-engine-body', 'main-engine-search')" title="Search by Serial Number, Model, GSS ID, Location, Remarks, or Removed From">
                                </div>
                                
                                <div class="d-flex gap-2" style="overflow-x: auto; flex-wrap: nowrap;">
                                    <button class="btn btn-sm btn-primary" onclick="loadMainTable()"><i class="bi bi-arrow-clockwise"></i> Refresh</button>
                                    <button class="btn btn-sm btn-warning" id="btn-main-edit" onclick="toggleEditMode()"><i class="bi bi-pencil-square"></i> Edit Table</button>
                                    <button class="btn btn-sm btn-info" id="btn-main-filter" onclick="toggleEngineFilter()" title="Filter"><i class="bi bi-funnel"></i> Filter</button>
                                    <button class="btn btn-sm btn-danger d-none" id="btn-main-delete-selected" onclick="bulkDeleteSelected()"><i class="bi bi-trash3"></i> Delete Selected</button>
                                    <button class="btn btn-sm btn-success d-none" id="btn-main-save" onclick="saveEditMode()"><i class="bi bi-check-lg"></i> Save Changes</button>
                                    <button class="btn btn-sm btn-secondary d-none" id="btn-main-cancel" onclick="cancelEditMode()"><i class="bi bi-x-lg"></i> Cancel</button>
                                </div>
                            </div>
                            
                            <div class="table-responsive" style="max-height: 80vh; overflow: auto; position: relative;">
                                <table class="table table-bordered table-hover table-sm text-center align-middle" style="font-size: 0.85rem; min-width: 100%; position: relative; z-index: 1;">
                                    <thead class="table-dark" style="position: sticky; top: 0; z-index: 10;">
                                        <tr>
                                            <th class="delete-col" style="width: 50px; min-width: 50px; display: none;">
                                                <div class="bulk-controls">
                                                    <input type="checkbox" id="select-all-delete" class="form-check-input select-all" onchange="toggleSelectAllRows(this)">
                                                    <i class="bi bi-trash text-danger" title="Delete / Select"></i>
                                                </div>
                                            </th>
                                            <th style="min-width: 50px;"><i class="bi bi-list-ol"></i></th>
                                            <th style="min-width: 80px;">Model</th>
                                            <th style="min-width: 100px;">Current SN</th>
                                            <th style="min-width: 100px;">Orig. ESN</th>
                                            <th style="min-width: 80px;">GSS ID</th>
                                            <th style="min-width: 70px;">Price</th>
                                            <th style="min-width: 90px;">Status</th>
                                            <th style="min-width: 100px;">Condition 1</th>
                                            <th style="min-width: 120px;">Condition 2</th>
                                            <th style="min-width: 50px;">TT</th>
                                            <th style="min-width: 50px;">TC</th>
                                            <th style="min-width: 120px;">Current Location</th>
                                            <th style="min-width: 100px;">Moved From</th>
                                            <th style="min-width: 100px;">Removed From</th>
                                            <th style="min-width: 150px;">Remarks</th>
                                            <th style="min-width: 70px;">Links/Photo</th>
                                        </tr>
                                    </thead>
                                    <tbody id="main-engine-body"></tbody>
                                </table>
                                <!-- Кнопка Плюс внизу таблицы (появляется при Edit) -->
                                <div id="add-row-btn" class="text-center p-2 border-top d-none" style="cursor: pointer; background: #f8f9fa;" onclick="addEmptyRow()">
                                    <i class="bi bi-plus-circle fs-4 text-success"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Выдвижная панель фильтра -->
                <div id="engine-filter-panel" class="position-fixed" style="right: -400px; top: 0; width: 400px; height: 100vh; background: white; border-left: 1px solid #ddd; box-shadow: -2px 0 8px rgba(0,0,0,0.1); z-index: 9999; transition: right 0.3s ease; padding: 20px; overflow-y: auto;">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h5 class="mb-0">Filter Engines</h5>
                        <button class="btn btn-close" onclick="toggleEngineFilter()"></button>
                    </div>
                    
                    <div class="mb-4">
                        <label class="small fw-bold d-block mb-2">User (Created By)</label>
                        <select class="form-select" id="engine-user-filter" onchange="filterEnginesByUser()">
                            <option value="">All Users</option>
                        </select>
                    </div>
                    
                    <div class="mb-4">
                        <label class="small fw-bold d-block mb-2">Date</label>
                        <input type="date" class="form-control" id="engine-date-filter" onchange="filterEnginesByDate()">
                    </div>
                    
                    <div class="mb-4">
                        <label class="small fw-bold d-block mb-2">Status</label>
                        <select class="form-select" id="engine-status-filter" onchange="filterEnginesByStatus()">
                            <option value="">All Status</option>
                            <option value="INSTALLED">INSTALLED</option>
                            <option value="REMOVED">REMOVED</option>
                            <option value="-">- (Unassigned)</option>
                        </select>
                    </div>
                    
                    <div class="mb-4">
                        <label class="small fw-bold d-block mb-2">Model</label>
                        <input type="text" class="form-control" id="engine-model-filter" onchange="applyEngineFilters()" placeholder="e.g. CF6-80">
                    </div>
                    
                    <div class="mb-4">
                        <label class="small fw-bold d-block mb-2">Orig. ESN</label>
                        <input type="text" class="form-control" id="engine-esn-filter" onchange="applyEngineFilters()" placeholder="Search ESN">
                    </div>

                    <div class="mb-4">
                        <label class="small fw-bold d-block mb-2">GSS ID</label>
                        <input type="text" class="form-control" id="engine-gss-filter" onchange="applyEngineFilters()" placeholder="Search GSS ID">
                    </div>
                    
                    <div class="mb-4">
                        <label class="small fw-bold d-block mb-2">Location (Moved From)</label>
                        <input type="text" class="form-control" id="engine-location-filter" onchange="applyEngineFilters()" placeholder="Search location">
                    </div>

                    <div class="mb-4">
                        <label class="small fw-bold d-block mb-2">Removed From (AC)</label>
                        <input type="text" class="form-control" id="engine-removed-filter" onchange="applyEngineFilters()" placeholder="Search removed from">
                    </div>

                    <div class="mb-4">
                        <label class="small fw-bold d-block mb-2">TT Range</label>
                        <div class="d-flex gap-2">
                            <input type="number" class="form-control" id="engine-tt-min" onchange="applyEngineFilters()" placeholder="Min">
                            <input type="number" class="form-control" id="engine-tt-max" onchange="applyEngineFilters()" placeholder="Max">
                        </div>
                    </div>

                    <div class="mb-4">
                        <label class="small fw-bold d-block mb-2">TC Range</label>
                        <div class="d-flex gap-2">
                            <input type="number" class="form-control" id="engine-tc-min" onchange="applyEngineFilters()" placeholder="Min">
                            <input type="number" class="form-control" id="engine-tc-max" onchange="applyEngineFilters()" placeholder="Max">
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <label class="small fw-bold d-block mb-2">Remarks</label>
                        <input type="text" class="form-control" id="engine-remarks-filter" onchange="applyEngineFilters()" placeholder="Search remarks">
                    </div>

                    <div class="form-check mb-4">
                        <input class="form-check-input" type="checkbox" id="engine-has-photo" onchange="applyEngineFilters()">
                        <label class="form-check-label" for="engine-has-photo">With Photo only</label>
                    </div>
                    
                    <div class="d-flex gap-2">
                        <button class="btn btn-sm btn-primary w-100" onclick="applyEngineFilters()">Apply Filters</button>
                        <button class="btn btn-sm btn-outline-secondary w-100" onclick="clearEngineFilters()">Clear All</button>
                    </div>
                </div>
                <div id="engine-filter-overlay" class="position-fixed" style="display: none; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.3); z-index: 999;" onclick="toggleEngineFilter()"></div>

                <!-- TAB 2: ADD NEW -->
                <div id="tab-main-add" style="display: none;">
                    <div class="card shadow-sm border-0">
                        <div class="card-header bg-white fw-bold text-primary">Ввод основных данных</div>
                        <div class="card-body">
                            <form id="form-main-add">
                                <div class="row mb-3">
                                    <div class="col-md-3"><label class="small fw-bold">Date</label><input type="date" class="form-control" id="m-date"></div>
                                    <div class="col-md-3"><label class="small fw-bold">Model</label><input type="text" class="form-control" id="m-model" placeholder="e.g. CF6-80"></div>
                                    <div class="col-md-3"><label class="small fw-bold">Orig. ESN *</label><input type="text" class="form-control" id="m-esn" required></div>
                                    <div class="col-md-3"><label class="small fw-bold">Current SN</label><input type="text" class="form-control" id="m-current-sn" placeholder="If different from Orig."></div>
                                </div>
                                <div class="row mb-3">
                                    <div class="col-md-3"><label class="small fw-bold">GSS ID</label><input type="text" class="form-control" id="m-gssid"></div>
                                </div>
                                <div class="row mb-3">
                                    <div class="col-md-3">
                                        <label class="small fw-bold">Status <small class="text-muted">(auto-assigned)</small></label>
                                        <select class="form-select" id="m-status" disabled>
                                            <option value="">- (Not Active)</option>
                                            <option value="INSTALLED">INSTALLED</option>
                                            <option value="REMOVED">REMOVED</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="small fw-bold">Current Location *</label>
                                        <select class="form-select" id="m-location" required>
                                            <option value="" disabled selected>Select Location...</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3"><label class="small fw-bold">TT</label><input type="number" step="0.1" class="form-control" id="m-tt" value="0"></div>
                                    <div class="col-md-3"><label class="small fw-bold">TC</label><input type="number" class="form-control" id="m-tc" value="0"></div>
                                    <div class="col-md-3"><label class="small fw-bold">Price</label><input type="number" step="0.01" class="form-control" id="m-price" placeholder="0.00"></div>
                                </div>
                                <div class="row mb-3">
                                    <div class="col-md-3"><label class="small fw-bold">Photo (Link)</label><input type="text" class="form-control" id="m-photo" placeholder="http://..."></div>
                                </div>
                                <div class="row mb-3">
                                    <div class="col-md-6"><label class="small fw-bold">Moved From (Loc/Shop)</label><input type="text" class="form-control" id="m-moved"></div>
                                    <div class="col-md-6"><label class="small fw-bold">Removed From (AC)</label><input type="text" class="form-control" id="m-removed"></div>
                                </div>
                                <div class="row mb-3">
                                    <div class="col-md-3">
                                        <label class="small fw-bold">Condition 1 (Operational)</label>
                                        <select class="form-select" id="m-condition-1">
                                            <option value="-">- (Unknown)</option>
                                            <option value="SV" selected>SV (Serviceable)</option>
                                            <option value="US">US (Unserviceable)</option>
                                            <option value="Scrap">Scrap</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="small fw-bold">Condition 2 (Physical)</label>
                                        <select class="form-select" id="m-condition-2">
                                            <option value="-">- (Unknown)</option>
                                            <option value="New" selected>New</option>
                                            <option value="Overhauled">Overhauled</option>
                                            <option value="Repaired">Repaired</option>
                                            <option value="Inspected tested">Inspected tested</option>
                                            <option value="As removed">As removed</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="mb-3"><label class="small fw-bold">Remarks</label><textarea class="form-control" id="m-rem" rows="2"></textarea></div>
                                
                                <div class="d-flex justify-content-end gap-2">
                                    <button type="button" class="btn btn-light border" onclick="switchMainTab('list')">Cancel</button>
                                    <button type="button" class="btn btn-success px-4" onclick="submitMainEngine()">Save Record</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
            <!-- ОБЕРТКА ДЛЯ ФЛОТА -->
            <div id="fleet-section" class="px-4">
                <!-- Заголовок тоже прячем -->
                <h6 class="text-muted text-uppercase mb-3 mt-4">ON WING (Fleet)</h6>
                
                <div class="row g-3" id="fleet-container">
                    <div class="col-12"><div class="spinner-border text-primary spinner-sm"></div> Loading fleet...</div>
                </div>

                <!-- === PARTS CARDS SECTION === -->
                <div class="parts-cards-section">
                    <h6 class="text-muted text-uppercase mb-3">PARTS MANAGEMENT</h6>
                    <div class="parts-dashboard-grid">
                        <div id="parts-cards-container" class="parts-cards-grid"></div>

                        <!-- Schedule Cards -->
                        <div class="schedule-cards-grid">
                            <!-- Boroscope Inspections Card -->
                            <div class="schedule-card-wrapper">
                                <div class="parts-card-3d card-green" onclick="openBoroscopeModal()" style="cursor: pointer;">
                                    <div class="parts-card-icon">
                                        <i class="bi bi-camera-video"></i>
                                    </div>
                                    <div class="parts-card-content">
                                        <div class="parts-card-title">Boroscope Inspections</div>
                                        <div class="parts-card-subtitle" id="boroscope-last-date">No inspections yet</div>
                                    </div>
                                    <div class="parts-card-count" id="boroscope-count">0</div>
                                </div>
                            </div>

                            <!-- Schedule Status Card -->
                            <div class="schedule-card-wrapper">
                                <div class="parts-card-3d" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); box-shadow: 0 10px 40px rgba(245, 158, 11, 0.3); cursor: pointer;" onclick="openSchedulesModal()">
                                    <div class="parts-card-icon">
                                        <i class="bi bi-calendar-event"></i>
                                    </div>
                                    <div class="parts-card-content">
                                        <div class="parts-card-title">Schedule Status</div>
                                        <div class="parts-card-subtitle">Manage deliveries</div>
                                    </div>
                                    <div id="schedule-status-count" class="parts-card-count">0</div>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>

                <!-- CALENDAR SECTION (Scheduled Events) -->
                <div id="calendar-section" class="mt-5">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <div>
                            <h6 class="text-muted text-uppercase mb-0">
                                <i class="bi bi-calendar-event me-2"></i>Schedule & Calendar
                            </h6>
                            <p class="text-muted small mb-0">Manage shipments, meetings, inspections, and deadlines</p>
                        </div>
                        <div>
                            <button class="btn btn-primary btn-sm" onclick="openAddEventModal()">
                                <i class="bi bi-plus-circle me-1"></i>Add Event
                            </button>
                        </div>
                    </div>

                    <!-- Calendar Navigation -->
                    <div class="card shadow-sm mb-3">
                        <div class="card-body py-2">
                            <div class="d-flex justify-content-between align-items-center">
                                <button class="btn btn-sm btn-outline-secondary" onclick="navigateMonth(-1)">
                                    <i class="bi bi-chevron-left"></i> Previous
                                </button>
                                <h5 class="mb-0" id="calendar-month-year">January 2026</h5>
                                <button class="btn btn-sm btn-outline-secondary" onclick="navigateMonth(1)">
                                    Next <i class="bi bi-chevron-right"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Calendar Grid -->
                    <div id="calendar-grid-container" class="calendar-grid-container">
                        <div class="spinner-border text-primary"></div>
                        Loading calendar...
                    </div>
                </div>

                <!-- RECENT ACTIONS SECTION (всегда сразу ПОД флотом) -->
                <div id="recent-actions-section" class="mt-5">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="text-muted text-uppercase mb-0">
                            <i class="bi bi-clock-history me-2"></i>Recent Actions
                        </h6>
                    </div>

                    <div class="card shadow-sm border-0">
                        <div class="card-body p-0">
                            <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                                <table class="table table-hover table-sm mb-0">
                                    <thead class="table-light sticky-top">
                                        <tr>
                                            <th style="width: 15%;">Date & Time</th>
                                            <th style="width: 15%;">User</th>
                                            <th style="width: 12%;">Action</th>
                                            <th style="width: 12%;">Entity</th>
                                            <th>Description</th>
                                            <th style="width: 8%;">Details</th>
                                        </tr>
                                    </thead>
                                    <tbody id="recent-actions-body">
                                        <tr>
                                            <td colspan="6" class="text-center text-muted py-4">
                                                <i class="bi bi-clock-history fs-3 d-block mb-2"></i>
                                                Loading recent actions...
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

<div class="modal fade" id="dataModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header bg-dark text-white">
                <h5 class="modal-title" id="modalTitle">Table Info</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-0">
                <div class="table-responsive">
                    <table class="table table-striped table-hover table-custom mb-0">
                        <thead id="modalTableHead">
                            </thead>
                        <tbody id="modalTableBody">
                            </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="exportModalToExcel()">Export to Excel</button>
            </div>
        </div>
    </div>
</div>

        <!-- SETTINGS MODAL -->
        <div class="modal fade" id="settings-modal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-lg modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header bg-dark text-white">
                        <h5 class="modal-title"><i class="bi bi-gear me-2"></i>Settings</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <ul class="nav nav-tabs mb-3" id="settings-tabs">
                            <li class="nav-item">
                                <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#settings-interface">
                                    <i class="bi bi-speedometer2 me-2"></i>Interface
                                </button>
                            </li>
                            <li class="nav-item">
                                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#settings-parts">
                                    <i class="bi bi-box-seam me-2"></i>Parts Management
                                </button>
                            </li>
                            <li class="nav-item">
                                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#settings-recent">
                                    <i class="bi bi-clock-history me-2"></i>Recent Actions
                                </button>
                            </li>
                        </ul>
                        <div class="tab-content">
                            <div class="tab-pane fade show active" id="settings-interface">
                                <h6 class="mb-3">Appearance</h6>
                                <div class="form-check form-switch mb-4">
                                    <input class="form-check-input" type="checkbox" id="theme-toggle" onchange="toggleTheme()">
                                    <label class="form-check-label" for="theme-toggle">
                                        <strong><i class="bi bi-sun-fill me-2"></i>Light Background</strong> - Change dashboard and table backgrounds
                                    </label>
                                </div>
                                <hr class="my-3">
                                <h6 class="mb-3">Dashboard Customization</h6>
                                <div class="form-check form-switch mb-3">
                                    <input class="form-check-input" type="checkbox" id="dashboard-edit-toggle" onchange="toggleDashboardEditMode()">
                                    <label class="form-check-label" for="dashboard-edit-toggle">
                                        <strong>Enable Edit Mode</strong> - Drag, rename, delete
                                    </label>
                                </div>
                                <div id="dashboard-edit-section" style="display: none;">
                                    <div class="alert alert-info small">
                                        <i class="bi bi-info-circle me-2"></i>
                                        Drag to reorder • Click edit to rename • Click trash to delete • Saves automatically
                                    </div>
                                    
                                    <!-- ACCORDION FOR SUBGROUPS -->
                                    <div class="accordion" id="dashboard-accordion">
                                        <!-- CITY SUBGROUP -->
                                        <div class="accordion-item">
                                            <h2 class="accordion-header">
                                                <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-city">
                                                    <i class="bi bi-geo-alt me-2"></i><strong>City Locations</strong>
                                                </button>
                                            </h2>
                                            <div id="collapse-city" class="accordion-collapse collapse show" data-bs-parent="#dashboard-accordion">
                                                <div class="accordion-body p-2">
                                                    <div class="d-flex justify-content-end mb-2">
                                                        <button class="btn btn-sm btn-success" onclick="addNewLocation()">
                                                            <i class="bi bi-plus-lg me-1"></i>Add Location
                                                        </button>
                                                    </div>
                                                    <div id="locations-edit-list" class="list-group list-group-flush" style="max-height: 200px; overflow-y: auto;">
                                                        <!-- Populated by JS -->
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- STATUS SUBGROUP -->
                                        <div class="accordion-item">
                                            <h2 class="accordion-header">
                                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-status">
                                                    <i class="bi bi-tags me-2"></i><strong>Status Buttons</strong> <small class="text-muted ms-2">(order only)</small>
                                                </button>
                                            </h2>
                                            <div id="collapse-status" class="accordion-collapse collapse" data-bs-parent="#dashboard-accordion">
                                                <div class="accordion-body p-2">
                                                    <div id="status-edit-list" class="list-group list-group-flush">
                                                        <!-- Populated by JS -->
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- FLEET SUBGROUP -->
                                        <div class="accordion-item">
                                            <h2 class="accordion-header">
                                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-fleet">
                                                    <i class="bi bi-airplane me-2"></i><strong>Fleet (Aircraft)</strong>
                                                </button>
                                            </h2>
                                            <div id="collapse-fleet" class="accordion-collapse collapse" data-bs-parent="#dashboard-accordion">
                                                <div class="accordion-body p-2">
                                                    <div class="d-flex justify-content-end mb-2">
                                                        <button class="btn btn-sm btn-success" onclick="addNewAircraft()">
                                                            <i class="bi bi-plus-lg me-1"></i>Add Aircraft
                                                        </button>
                                                    </div>
                                                    <div id="fleet-edit-list" class="list-group list-group-flush" style="max-height: 200px; overflow-y: auto;">
                                                        <!-- Populated by JS -->
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <button class="btn btn-sm btn-warning mt-3" onclick="resetDashboardDefaults()">
                                        <i class="bi bi-arrow-counterclockwise me-2"></i>Reset All to Defaults
                                    </button>
                                </div>
                            </div>
                            <div class="tab-pane fade" id="settings-parts">
                                <h6 class="mb-3">Parts Management</h6>
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label class="small fw-bold">Card title: Logistics</label>
                                        <input type="text" class="form-control" id="parts-logistics-title-input" placeholder="Parts Removal/Installation">
                                    </div>
                                    <div class="col-md-6">
                                        <label class="small fw-bold">Card title: Store Balance</label>
                                        <input type="text" class="form-control" id="parts-store-title-input" placeholder="Store Balance">
                                    </div>
                                    <div class="col-md-12">
                                        <label class="small fw-bold">Card height</label>
                                        <input type="range" class="form-range" min="160" max="260" step="10" id="parts-card-height" oninput="updatePartsCardHeightLabel(this.value)">
                                        <div class="d-flex justify-content-between small text-muted">
                                            <span>Current: <span id="parts-card-height-value">200px</span></span>
                                            <span>Range: 160-260px</span>
                                        </div>
                                    </div>
                                    <div class="col-md-12">
                                        <label class="small fw-bold">Card width (per card)</label>
                                        <input type="range" class="form-range" min="35" max="100" step="5" id="parts-card-width" oninput="updatePartsCardWidthLabel(this.value)">
                                        <div class="d-flex justify-content-between small text-muted">
                                            <span>Current: <span id="parts-card-width-value">50%</span></span>
                                            <span>Range: 35-100%</span>
                                        </div>
                                    </div>
                                    <div class="col-12 d-flex flex-wrap gap-2">
                                        <button class="btn btn-primary btn-sm" onclick="savePartsSettingsFromForm()"><i class="bi bi-save me-1"></i>Save Parts Settings</button>
                                        <button class="btn btn-outline-secondary btn-sm" onclick="resetPartsSettings()"><i class="bi bi-arrow-counterclockwise me-1"></i>Reset Parts Defaults</button>
                                    </div>
                                    <div class="col-12">
                                        <div class="alert alert-light border small mb-0">
                                            Renames sync across sidebar, cards, modals, and tabs; size is applied instantly.
                                        </div>
                                    </div>
                                </div>
                                <hr>
                                <h6 class="mb-2">Custom Cards</h6>
                                <div class="row g-3 align-items-end">
                                    <div class="col-md-4">
                                        <label class="small fw-bold">Card title</label>
                                        <input type="text" class="form-control" id="parts-custom-title" placeholder="e.g. Parts Add">
                                    </div>
                                    <div class="col-md-3">
                                        <label class="small fw-bold">Color</label>
                                        <input type="color" class="form-control form-control-color" id="parts-custom-color" value="#2563eb" title="Pick card color">
                                    </div>
                                    <div class="col-md-3">
                                        <label class="small fw-bold">Target</label>
                                        <select class="form-select" id="parts-custom-target">
                                            <option value="parts-modal">Parts Removal/Installation modal</option>
                                            <option value="parts-view">Parts Removal/Installation table</option>
                                            <option value="parts-add">Parts Removal/Installation – Add tab</option>
                                            <option value="store-modal">Store Balance modal</option>
                                            <option value="store-view">Store Balance table</option>
                                            <option value="store-add">Store Balance – Add tab</option>
                                        </select>
                                    </div>
                                    <div class="col-md-2">
                                        <label class="small fw-bold">Width %</label>
                                        <input type="number" class="form-control" id="parts-custom-width" min="35" max="100" step="5" value="50">
                                    </div>
                                    <div class="col-md-12 d-flex gap-2">
                                        <button class="btn btn-success btn-sm" onclick="addCustomPartsCard()"><i class="bi bi-plus-lg me-1"></i>Add Card</button>
                                        <button class="btn btn-outline-secondary btn-sm" onclick="clearCustomCardForm()">Clear</button>
                                    </div>
                                    <div class="col-12">
                                        <div id="parts-custom-list" class="list-group small"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="tab-pane fade" id="settings-recent">
                                <h6 class="mb-3">Recent Actions Cleanup</h6>
                                <p class="small text-muted mb-3">Delete activity log entries older than the selected window.</p>
                                <div class="d-flex flex-wrap gap-2 mb-3">
                                    <button class="btn btn-outline-danger btn-sm" onclick="purgeRecentActions('1d')">Older than 1 day</button>
                                    <button class="btn btn-outline-danger btn-sm" onclick="purgeRecentActions('3d')">Older than 3 days</button>
                                    <button class="btn btn-outline-danger btn-sm" onclick="purgeRecentActions('7d')">Older than 1 week</button>
                                    <button class="btn btn-outline-danger btn-sm" onclick="purgeRecentActions('30d')">Older than 1 month</button>
                                    <button class="btn btn-danger btn-sm" onclick="purgeRecentActions('all')"><i class="bi bi-trash3 me-1"></i>Delete all</button>
                                </div>
                                <div class="alert alert-light border small" id="recent-actions-summary">Recent actions not loaded yet.</div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // Define noCache early so it's available to all functions
    window.noCache = window.noCache || (() => `?t=${new Date().getTime()}`);
    
    // --- 1. Sidebar Toggle ---

    const wrapper = document.getElementById("wrapper");
    
    // Логика Сэндвича
    document.getElementById("menu-toggle").onclick = function(e) {
        e.preventDefault();
        wrapper.classList.toggle("toggled");
    };

    // Логика кнопки Dashboard
    // Логика кнопки Dashboard (ИСПРАВЛЕННАЯ)
function openDashboardView() {
        hideAllViews(); // Сначала все скрываем

        const widgets = document.getElementById('dashboard-widgets');
        const fleet = document.getElementById('fleet-section');
        const btnWrapper = document.getElementById('engine-btn-wrapper');

        // Показываем блоки дашборда
        widgets.style.display = 'block';
        fleet.style.display = 'block';
        
        // Сбрасываем классы анимации сворачивания, если они были
        widgets.classList.remove('dashboard-collapsed');
        fleet.classList.remove('dashboard-collapsed');
        widgets.classList.add('dashboard-expanded');
        fleet.classList.add('dashboard-expanded');

        // --- ВАЖНО: Показываем кнопку двигателя ТОЛЬКО здесь ---
        if (btnWrapper) {
            btnWrapper.style.display = 'flex'; 
        }

        // Сброс состояния
        isDashboardOpen = true; 
        const btn = document.querySelector('.btn-engine-start');
        if(btn) btn.classList.add('active'); // Кнопка горит, т.к. дашборд открыт
        toggleEngineMenu(false);
        
        updateHistory('dashboard');

        // Обновить данные дашборда при открытии
        if (typeof loadDashboardData === 'function') {
            loadDashboardData();
        }
    
}
    // --- Notification Functions ---
    function showSuccessNotification(message) {
        const toast = document.createElement('div');
        toast.className = 'toast align-items-center text-white bg-success border-0';
        toast.setAttribute('role', 'alert');
        toast.setAttribute('aria-live', 'assertive');
        toast.setAttribute('aria-atomic', 'true');
        toast.innerHTML = `<div class="d-flex"><div class="toast-body">${message}</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button></div>`;
        const container = document.getElementById('toastContainer') || document.body;
        container.appendChild(toast);
        const bsToast = new bootstrap.Toast(toast);
        bsToast.show();
        setTimeout(() => toast.remove(), 5000);
    }

    function showErrorNotification(message) {
        const toast = document.createElement('div');
        toast.className = 'toast align-items-center text-white bg-danger border-0';
        toast.setAttribute('role', 'alert');
        toast.setAttribute('aria-live', 'assertive');
        toast.setAttribute('aria-atomic', 'true');
        toast.innerHTML = `<div class="d-flex"><div class="toast-body">${message}</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button></div>`;
        const container = document.getElementById('toastContainer') || document.body;
        container.appendChild(toast);
        const bsToast = new bootstrap.Toast(toast);
        bsToast.show();
        setTimeout(() => toast.remove(), 5000);
    }

    // --- 2. Data Loading & Initialization ---
    let globalEngines = [];
    let globalFleet = [];
    let installableEngines;
    let localTestShipments = []; // Временное хранилище для отгрузок
    let localTestInstalls = [];  // Временное хранилище для установок
    const DELETED_ENGINE_STORAGE_KEY = 'engine-deleted-ids';

    function getDeletedEngineIds() {
        try {
            const raw = localStorage.getItem(DELETED_ENGINE_STORAGE_KEY);
            const parsed = raw ? JSON.parse(raw) : [];
            return Array.isArray(parsed) ? parsed : [];
        } catch (e) {
            console.warn('Cannot read deleted engine ids from storage', e);
            return [];
        }
    }

    function markEngineDeleted(engineId) {
        if (!engineId) return;
        const ids = getDeletedEngineIds();
        if (!ids.includes(engineId)) {
            ids.push(engineId);
            try { localStorage.setItem(DELETED_ENGINE_STORAGE_KEY, JSON.stringify(ids)); } catch (e) { console.warn('Cannot persist deleted engine ids', e); }
        }
    }
    
    function clearDeletedEngineIds() {
        try { 
            localStorage.removeItem(DELETED_ENGINE_STORAGE_KEY);
            console.log('✅ Cleared all deleted engine IDs from storage');
            // Перезагружаем таблицу после очистки
            if (document.getElementById('view-main-engine').style.display === 'block') {
                loadMainTable();
            }
        } catch (e) { 
            console.warn('Cannot clear deleted engine ids', e); 
        }
    }
    
    // Делаем функцию доступной в консоли браузера
    window.clearDeletedEngineIds = clearDeletedEngineIds;
    window.getDeletedEngineIds = getDeletedEngineIds;
    
    window.onload = async function() {
        loadSavedTheme();
        await loadDashboardData();
    };


    //яяааааааааааааааааааааааааааааааааааа
    
    function hideAllViews() {
        const views = [
            'dashboard-widgets', // <--- ЭТОТ ID ОБЯЗАТЕЛЕН
            'fleet-section', 
            'view-install', 
            'view-shipment', 
            'view-remove',
            'view-add-engine',
            'view-main-engine',
            'view-repair',
            'view-parts',
            'view-store-balance',
            'view-util',
            'view-atlb',
            'view-eng-param',
            'view-utilization-param',
            'view-borescope',
            'view-engine-reports',
            'view-purchase-orders',
            'view-fake-installed',
            'view-nameplate-tracker',
            'view-gss'
        ];
        
        views.forEach(id => {
            const el = document.getElementById(id);
            if (el) el.style.display = 'none';
        });

        // --- ВАЖНО: Скрываем кнопку двигателя при уходе с дашборда ---
        const btnWrapper = document.getElementById('engine-btn-wrapper');
        if (btnWrapper) {
            btnWrapper.style.display = 'none';
        }
    }
    // -------------------------------

    // --- HISTORY MANAGEMENT (Кнопка Назад) ---
    
    // 1. Функция для обновления URL без перезагрузки
    function updateHistory(viewName) {
        // Если мы уже на этой странице, не дублируем историю
        if (history.state && history.state.view === viewName) return;
        
        const url = new URL(window.location);
        url.hash = viewName; // Ставим #shipment, #install и т.д.
        history.pushState({ view: viewName }, '', url);
    }

    // 2. Слушаем нажатие кнопки "Назад" в браузере
    window.onpopstate = function(event) {
        if (event.state && event.state.view) {
            restoreView(event.state.view);
        } else {
            // Если истории нет (вернулись в начало), открываем Дашборд
            openDashboardView();
        }
    };

    // 3. Функция восстановления окна по имени
    // 3. Функция восстановления окна по имени (ИСПРАВЛЕННАЯ)
function restoreView(viewName) {
    // 1. Скрываем ВСЁ с помощью общей функции (чтобы не перечислять вручную)
    hideAllViews();

    // 2. Открываем нужное
    if (viewName === 'dashboard') {
        openDashboardView(); // Используем основную функцию, она сама все покажет
    } else if (viewName === 'shipment') {
        document.getElementById('view-shipment').style.display = 'block';
        loadShipmentHistory();
    } else if (viewName === 'install') {
        document.getElementById('view-install').style.display = 'block';
        loadInstallHistory();
    } else if (viewName === 'remove') {
        document.getElementById('view-remove').style.display = 'block';
        loadRemoveHistory();
    } else if (viewName === 'add-engine') {
        document.getElementById('view-add-engine').style.display = 'block';
    } else if (viewName === 'master') {
        document.getElementById('view-main-engine').style.display = 'block';
        loadMainTable();
    } else if (viewName === 'repair') {
        document.getElementById('view-repair').style.display = 'block';
        loadRepairHistory();
    } else if (viewName === 'parts') {
        document.getElementById('view-parts').style.display = 'block';
        loadPartsHistory();
    } else if (viewName === 'store-balance') {
        document.getElementById('view-store-balance').style.display = 'block';
        switchStoreBalanceTab('list');
        loadStoreBalance();
    } else if (viewName === 'util') {
        document.getElementById('view-util').style.display = 'block';
        loadUtilHistory();
    } else if (viewName === 'atlb') {
        document.getElementById('view-atlb').style.display = 'block';
        // ИЗМЕНЕНИЕ: Здесь тоже ставим 'entry'
        switchAtlbTab('entry');;
    } else if (viewName === 'eng-param') { // Добавляем новое окно в историю
        openEngParamView();
    } else if (viewName === 'gss') {
        openGSSModal();
    }
}

// ============ Tooltip для Previous Current SN при Installation ============
let currentTooltipTimeout;
async function showInstallTooltip(event, engineId) {
    clearTimeout(currentTooltipTimeout);
    
    try {
        // Загружаем historию этого двигателя
        const res = await fetch(`/api/history/INSTALL?engine_id=${engineId}`);
        const history = res.ok ? await res.json() : [];
        
        if (history.length === 0) {
            return;
        }
        
        // Берем последнюю (самую свежую) установку
        const lastInstall = history[0];
        const previousCurrentSn = lastInstall.current_sn || '-';
        
        // Создаем tooltip
        const tooltip = document.createElement('div');
        tooltip.id = 'install-tooltip';
        tooltip.style.cssText = `
            position: fixed;
            background: rgba(0, 0, 0, 0.9);
            color: #fff;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 12px;
            z-index: 10000;
            pointer-events: none;
            white-space: nowrap;
            max-width: 300px;
        `;
        tooltip.innerHTML = `<strong>Current S/N:</strong> ${previousCurrentSn}`;
        
        document.body.appendChild(tooltip);
        
        // Позиционируем tooltip
        const rect = event.target.getBoundingClientRect();
        tooltip.style.left = (rect.left + rect.width / 2 - tooltip.offsetWidth / 2) + 'px';
        tooltip.style.top = (rect.top - 35) + 'px';
        
    } catch (e) {
        console.warn('Error loading install history for tooltip:', e);
    }
}

function hideInstallTooltip() {
    clearTimeout(currentTooltipTimeout);
    currentTooltipTimeout = setTimeout(() => {
        const tooltip = document.getElementById('install-tooltip');
        if (tooltip) {
            tooltip.remove();
        }
    }, 200);
}

    let _dashboardLoading = false;
    async function loadDashboardData() {
    if (_dashboardLoading) {
        console.log('Dashboard already loading, skipping duplicate call');
        return;
    }
    _dashboardLoading = true;
    
    try {
        // 2.1 Load Stats
        const statsRes = await fetch('/api/dashboard/stats');
        if (!statsRes.ok) {
            throw new Error(`Failed to fetch stats: ${statsRes.status} ${statsRes.statusText}`);
        }
        const stats = await statsRes.json();
        console.log('Stats:', stats); // Для отладки
        document.getElementById('cnt-sv').innerText = stats.SV || 0;
        document.getElementById('cnt-us').innerText = stats.US || 0;
        document.getElementById('cnt-inst').innerText = stats.INSTALLED || 0;
        document.getElementById('cnt-rem').innerText = stats.REMOVED || 0;

        // 2.2 Load Locations Buttons (Dynamic)
        const locRes = await fetch('/api/locations');
        if (!locRes.ok) {
            throw new Error(`Failed to fetch locations: ${locRes.status} ${locRes.statusText}`);
        }
        const locations = await locRes.json();
        console.log('Locations:', locations); // Для отладки
        window.globalLocations = locations; // Сохраняем в глобальную переменную для модалов
        const locContainer = document.getElementById('locations-container');
        locContainer.innerHTML = '';
        
        locations.forEach(loc => {
            locContainer.innerHTML += `
                <div class="col-md-2 col-sm-4" data-location-id="${loc.id}">
                    <button class="btn-dashboard w-100" onclick="openLocationModal('${loc.id}', '${loc.name}')">
                        <span class="label">${loc.name}</span>
                        <span class="count">${loc.engine_count}</span>
                        <i class="bi bi-geo-alt-fill"></i>
                    </button>
                </div>
            `;
        });

        // 2.3 Load Fleet Cards (BAR, BAT, BAQ) - NEW PROFESSIONAL DESIGN
        let aircraftDetails = [];
        try {
            const fleetRes = await fetch('/api/dashboard/aircraft-details');
            if (fleetRes.ok) {
                aircraftDetails = await fleetRes.json();
                console.log('Aircraft Details:', aircraftDetails);
            } else {
                console.warn('New API not available, using fallback...');
                // Fallback to old API
                const oldRes = await fetch('/api/fleet');
                if (oldRes.ok) {
                    const oldFleet = await oldRes.json();
                    // Convert old format to new format
                    aircraftDetails = oldFleet.map((ac, idx) => ({
                        aircraft_id: idx + 1,
                        tail_number: ac.tail_number,
                        model: ac.model || 'N/A',
                        total_time: 0,
                        total_cycles: 0,
                        positions: ac.engines.map(eng => ({
                            engine_id: 1,
                            original_sn: eng.original_sn,
                            current_sn: eng.current_sn,
                            model: 'N/A',
                            total_tsn: eng.tt || 0,
                            total_csn: eng.tc || 0,
                            tsn_on_aircraft: 0,
                            csn_on_aircraft: 0,
                            n1_takeoff: eng.n1_to,
                            n1_cruise: eng.n1_cr,
                            n2_takeoff: eng.n2_to,
                            n2_cruise: eng.n2_cr,
                            install_date: 'N/A',
                            last_update: 'N/A'
                        }))
                    }));
                }
            }
        } catch (err) {
            console.error('Error fetching aircraft data:', err);
        }
        // Keep a global reference for modal lookups
        try { globalFleet = aircraftDetails; } catch (e) { /* ignore */ }
        
        const fleetContainer = document.getElementById('fleet-container');
        fleetContainer.innerHTML = '';
        
        // Теперь всегда показываем карточки, даже с нулевыми данными
        if (aircraftDetails.length === 0) {
            console.warn('No aircraft data from API, but cards will still be displayed');
        }

        aircraftDetails.forEach(ac => {
            const cardId = `aircraft-${ac.aircraft_id}`;
            const positionsId = `positions-${ac.aircraft_id}`;
            const chevronId = `chevron-${ac.aircraft_id}`;
            
            let positionsListHTML = '';
            const positions = ac.positions || [null, null, null, null];
            
            // Создаем список позиций для аккордеона
            positions.forEach((pos, index) => {
                const posNum = index + 1;
                const posDetailId = `pos-detail-${ac.aircraft_id}-${posNum}`;
                
                // БЕЗ фильтра - просто показываем то, что вернул бэкенд
                // Бэкенд уже отфильтровал и вернул только INSTALLED двигатели
                
                const statusText = pos === null ? 'No Engine' : pos.current_sn;
                const statusClass = pos === null ? 'empty' : 'installed';
                
                positionsListHTML += `
                    <div class="position-item" data-position="${posNum}" data-aircraft-id="${ac.aircraft_id}">
                        <div class="position-item-header">
                            <span class="position-label">Position ${posNum}</span>
                            <span class="position-status ${statusClass}">${statusText}</span>
                        </div>
                        <div class="position-details" id="${posDetailId}" style="display: none;">
                            ${pos === null ? `
                                <div class="empty-position-details">
                                    <i class="bi bi-inbox"></i>
                                    <p>No Engine Installed</p>
                                </div>
                            ` : `
                                ${pos.util_date_from && pos.util_date_to && pos.util_ttsn !== null && pos.util_tcsn !== null ? `
                                    <div class="position-period-info">
                                        <div class="period-label">Period: ${pos.util_date_from} — ${pos.util_date_to}</div>
                                        <div class="period-stats">
                                            <div><strong>${pos.util_ttsn}</strong> TTSN hrs</div>
                                            <div><strong>${pos.util_tcsn}</strong> TCSN cyc</div>
                                        </div>
                                    </div>
                                ` : ''}
                                <div class="engine-info-grid">
                                    <div class="info-row">
                                        <span class="info-label">Orig. ESN:</span>
                                        <span class="info-value">${pos.original_sn}</span>
                                    </div>
                                    <div class="info-row">
                                        <span class="info-label">Current S/N:</span>
                                        <span class="info-value">${pos.current_sn}</span>
                                    </div>
                                    <div class="info-row">
                                        <span class="info-label">GSS ID:</span>
                                        <span class="info-value">${pos.gss_sn}</span>
                                    </div>
                                    <div class="info-row">
                                        <span class="info-label">Supplier:</span>
                                        <span class="info-value">${pos.supplier || '-'}</span>
                                    </div>
                                    <div class="info-row">
                                        <span class="info-label">TSN on A/C:</span>
                                        <span class="info-value">${formatFlightTime(pos.tsn_on_aircraft || 0)} hrs</span>
                                    </div>
                                    <div class="info-row">
                                        <span class="info-label">CSN on A/C:</span>
                                        <span class="info-value">${pos.csn_on_aircraft || 0} cyc</span>
                                    </div>
                                    <div class="info-row">
                                        <span class="info-label">Total TSN:</span>
                                        <span class="info-value">${pos.total_tsn} hrs</span>
                                    </div>
                                    <div class="info-row">
                                        <span class="info-label">Total CSN:</span>
                                        <span class="info-value">${pos.total_csn} cyc</span>
                                    </div>
                                    <div class="info-row">
                                        <span class="info-label">N1 Takeoff:</span>
                                        <span class="info-value">${pos.n1_takeoff !== null ? pos.n1_takeoff + '%' : 'N/A'}</span>
                                    </div>
                                    <div class="info-row">
                                        <span class="info-label">N1 Cruise:</span>
                                        <span class="info-value">${pos.n1_cruise !== null ? pos.n1_cruise + '%' : 'N/A'}</span>
                                    </div>
                                    <div class="info-row">
                                        <span class="info-label">N2 Takeoff:</span>
                                        <span class="info-value">${pos.n2_takeoff !== null ? pos.n2_takeoff + '%' : 'N/A'}</span>
                                    </div>
                                    <div class="info-row">
                                        <span class="info-label">N2 Cruise:</span>
                                        <span class="info-value">${pos.n2_cruise !== null ? pos.n2_cruise + '%' : 'N/A'}</span>
                                    </div>
                                    <div class="info-row">
                                        <span class="info-label">EGT Takeoff:</span>
                                        <span class="info-value">${pos.egt_takeoff !== null ? pos.egt_takeoff + '°C' : 'N/A'}</span>
                                    </div>
                                    <div class="info-row">
                                        <span class="info-label">EGT Cruise:</span>
                                        <span class="info-value">${pos.egt_cruise !== null ? pos.egt_cruise + '°C' : 'N/A'}</span>
                                    </div>
                                    <div class="info-row">
                                        <span class="info-label">Installed:</span>
                                        <span class="info-value">${pos.install_date}</span>
                                    </div>
                                    <div class="info-row">
                                        <span class="info-label">Param Date:</span>
                                        <span class="info-value">${pos.param_date || 'N/A'}</span>
                                    </div>
                                </div>
                            `}
                        </div>
                    </div>
                `;
            });
            
            fleetContainer.insertAdjacentHTML('beforeend', `
                <div class="col-lg-4 col-md-6">
                    <div class="aircraft-card" id="${cardId}" data-aircraft-id="${ac.aircraft_id}" data-tail-number="${ac.tail_number}" style="cursor: pointer;">
                        <div class="aircraft-visual-main">
                            <video id="engine-video-${ac.aircraft_id}" class="engine-video" src="/static/engine-fan.mp4" preload="auto" autoplay loop muted playsinline></video>
                        </div>
                        
                        <div class="aircraft-card-header">
                            <div class="aircraft-name">${ac.tail_number}</div>
                            <div class="aircraft-stats">
                                <div class="aircraft-hours">${formatFlightTime(ac.total_time || 0)} hrs</div>
                                <div class="aircraft-hours-label">Total Time</div>
                                <div class="aircraft-hours" style="font-size: 0.9rem; margin-top: 4px;">${ac.total_cycles || 0} cyc</div>
                            </div>
                        </div>
                        ${ac.last_data_date ? `
                        <div style="padding: 6px 14px 0 14px; color: #17a2b8; font-size: 0.75rem; cursor: pointer; opacity: 0.9;" 
                             onclick="openUtilizationHistoryModal('${ac.tail_number}')" title="Click to view history">
                            <i class="bi bi-calendar-check"></i> Last data: ${ac.last_data_date}
                        </div>
                        ` : ''}
                        
                        <div class="chevron-toggle-top" data-aircraft-id="${ac.aircraft_id}">
                            <i class="bi bi-chevron-down" id="${chevronId}"></i>
                        </div>
                        
                        <div class="engine-positions" id="${positionsId}">
                            ${positionsListHTML}
                        </div>
                    </div>
                </div>
            `);
        });
        
        // Добавляем обработчики для аккордеона позиций
        document.querySelectorAll('.position-item').forEach(item => {
            item.addEventListener('click', function(e) {
                e.stopPropagation();
                const posNum = this.getAttribute('data-position');
                const aircraftId = this.getAttribute('data-aircraft-id');
                const detailsId = `pos-detail-${aircraftId}-${posNum}`;
                const details = document.getElementById(detailsId);
                const isHidden = details.style.display === 'none';
                
                // Закрыть все остальные позиции
                document.querySelectorAll(`[data-aircraft-id="${aircraftId}"] .position-details`).forEach(d => {
                    d.style.display = 'none';
                });
                
                // Открыть текущую
                if (isHidden) {
                    details.style.display = 'block';
                }
            });
        });
        
        // Добавляем обработчики событий для всех кнопок-шевронов после создания HTML
        document.querySelectorAll('.chevron-toggle-top').forEach(toggle => {
            toggle.addEventListener('click', function(e) {
                e.stopPropagation(); // Prevent card click
                const aircraftId = this.getAttribute('data-aircraft-id');
                toggleEnginePositions(aircraftId);
            });
        });

        // Добавляем обработчики клика на карточки самолетов для открытия модального окна
        document.querySelectorAll('.aircraft-card').forEach(card => {
            card.addEventListener('click', function(e) {
                // Ignore clicks on chevron, utilization history, and interactive elements
                if (e.target.closest('.chevron-toggle-top') || 
                    e.target.closest('[onclick*="openUtilizationHistoryModal"]') ||
                    e.target.closest('.engine-positions')) {
                    return;
                }
                
                const aircraftId = this.getAttribute('data-aircraft-id');
                const tailNumber = this.getAttribute('data-tail-number');
                openEngineDetailsModal(aircraftId, tailNumber);
            });
        });
        
        // Initialize 3D engines for all aircraft cards
        initializeAllEngines();

        ensureEngineVideosPlaying();
        
        // Load recent actions
        await loadRecentActions();
        
        // Update Parts Cards Counts
        await updatePartsCardCounts();
        
        // Load and display boroscope schedule reminders
        displayBoroscopeReminders();
        
    } catch (error) {
        console.error('Error loading dashboard data:', error);
        alert('Failed to load dashboard data. Check console for details.');
    } finally {
        _dashboardLoading = false;
    }
}

    // --- THREE.JS 3D ENGINE ANIMATION ---
    
    const engineScenes = {}; // Store scenes for each aircraft

    // === RECENT ACTIONS (Activity Log) ===
    // Helper with timeout and graceful fallback
    async function safeFetch(url, options = {}, timeoutMs = 7000) {
        try {
            const controller = new AbortController();
            const id = setTimeout(() => controller.abort(), timeoutMs);
            const res = await fetch(url, { ...options, signal: controller.signal });
            clearTimeout(id);
            return res;
        } catch (e) {
            return null;
        }
    }

    // Универсальная функция обработки ответов от API (поддержка warning/success/error)
    async function handleApiResponse(response, operation = 'Операция') {
        if (!response.ok) {
            const error = await response.json().catch(() => ({detail: 'Техническая ошибка'}));
            throw new Error(error.detail || 'Ошибка сервера');
        }

        const data = await response.json();

        // НОВАЯ СИСТЕМА: Проверяем status в ответе
        if (data.status === 'warning') {
            // 🟡 Бизнес-валидация: показываем желтое предупреждение с подсказкой
            showWarningModal(data.message, data.hint, data.code);
            return null; // Операция не выполнена
        } else if (data.status === 'success') {
            // 🟢 Успех: показываем зеленое уведомление
            showSuccessNotification(data.message);
            return data; // Возвращаем данные для дальнейшей обработки
        } else {
            // 🔵 Старый формат (обратная совместимость): просто data без status
            return data;
        }
    }

    // Функция показа желтого модального окна с предупреждением
    function showWarningModal(message, hint, code) {
        const modal = document.createElement('div');
        modal.style.cssText = `
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.6); z-index: 9999; 
            display: flex; align-items: center; justify-content: center;
        `;
        
        const box = document.createElement('div');
        box.style.cssText = `
            background: #fff; border-radius: 12px; padding: 30px; 
            max-width: 500px; width: 90%; box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        `;
        
        box.innerHTML = `
            <div style="text-align: center;">
                <div style="font-size: 3rem; margin-bottom: 15px;">⚠️</div>
                <h4 style="color: #f59e0b; margin-bottom: 15px;">${message}</h4>
                <p style="color: #6b7280; margin-bottom: 20px; line-height: 1.6;">${hint || ''}</p>
                <button id="modal-close-btn" style="
                    background: #f59e0b; color: #fff; border: none; 
                    padding: 12px 30px; border-radius: 8px; font-size: 1rem; 
                    cursor: pointer; font-weight: 600;
                ">Понятно</button>
            </div>
        `;
        
        modal.appendChild(box);
        document.body.appendChild(modal);
        
        document.getElementById('modal-close-btn').onclick = () => modal.remove();
        modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
    }
    
    // Debounce helper to avoid duplicate calls
    let lastRefreshTime = 0;
    function refreshAfterDataChange() {
        const now = Date.now();
        if (now - lastRefreshTime < 500) return; // Ignore if called within 500ms
        lastRefreshTime = now;
        
        loadRecentActions();
        updateNotificationCount();
    }

    let recentActionsIntervalId = null;
    let repairHistoryIntervalId = null;
    let partsHistoryIntervalId = null;
    let utilHistoryIntervalId = null;
    const recentActionRangeLabels = {
        '1d': 'older than 1 day',
        '3d': 'older than 3 days',
        '7d': 'older than 1 week',
        '30d': 'older than 1 month',
        'all': 'all time'
    };

    async function loadRecentActions() {
        const tbody = document.getElementById('recent-actions-body');
        if (!tbody) return; // not on dashboard yet

        // Show loading state only if table empty
        if (!tbody.children.length) {
            tbody.innerHTML = '<tr><td colspan="6" class="text-muted text-center py-3">Loading recent actions…</td></tr>';
        }

        // Try main endpoint, then fallback without query param
        let res = await safeFetch('/api/recent-actions?limit=50');
        if (!res || !res.ok) res = await safeFetch('/api/recent-actions');

        if (!res || !res.ok) {
            console.error('Error loading recent actions:', res && res.status);
            tbody.innerHTML = '<tr><td colspan="6" class="text-danger text-center py-3">Unable to load recent actions</td></tr>';
            return;
        }

        let actions = [];
        try { actions = await res.json(); } catch { actions = []; }

        window.recentActionsCache = Array.isArray(actions) ? actions : [];
        renderRecentActions();
        updateRecentActionsSummary();
    }

    let recentActionsExpanded = false;

    function renderRecentActions() {
        const tbody = document.getElementById('recent-actions-body');
        if (!tbody) return;
        const actions = window.recentActionsCache || [];
        tbody.innerHTML = '';

        if (!Array.isArray(actions) || actions.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" class="text-muted text-center py-3">No recent actions</td></tr>';
            return;
        }

        // When expanded show all (scroll is handled by container max-height); collapsed shows 2
        const maxVisible = recentActionsExpanded ? actions.length : 2;
        const slice = actions.slice(0, Math.min(maxVisible, actions.length));

        slice.forEach((a, idx) => {
            const tr = document.createElement('tr');
            const dateStr = a.created_at ? new Date(a.created_at).toLocaleString() : '';
            const description = formatActionMessage(a.message);
            tr.innerHTML = `
                <td>${dateStr}</td>
                <td>${a.performed_by || '-'}</td>
                <td><span class="badge bg-${a.action_type === 'created' ? 'success' : a.action_type === 'updated' ? 'primary' : 'danger'}">${a.action_type}</span></td>
                <td>${a.entity_type}</td>
                <td>${description}</td>
                <td><button type="button" class="btn btn-sm btn-outline-secondary recent-action-view" data-idx="${idx}">View</button></td>
            `;
            tbody.appendChild(tr);
        });

        // Toggle row if more items exist or always show toggle when expanded
        if (actions.length > 2) {
            const tr = document.createElement('tr');
            const chevron = recentActionsExpanded ? 'chevron-up' : 'chevron-down';
            tr.innerHTML = `
                <td colspan="6" class="text-center py-1" style="line-height: 1;">
                    <button class="btn btn-sm" style="border: none; background: transparent; padding: 0.1rem 0.35rem;" onclick="toggleRecentActions()" title="${recentActionsExpanded ? 'Свернуть' : 'Развернуть'}">
                        <i class="bi bi-${chevron}" style="font-size: 1.15rem; color: #6c757d; transition: 0.2s;"></i>
                    </button>
                </td>`;
            tbody.appendChild(tr);
        }

        // Add click handlers after rows inserted
        tbody.querySelectorAll('.recent-action-view').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const idx = parseInt(e.currentTarget.getAttribute('data-idx'));
                const all = window.recentActionsCache || [];
                if (!isNaN(idx) && all[idx]) {
                    openActionDetailsModal(all[idx]);
                }
            });
        });
    }

    function toggleRecentActions() {
        recentActionsExpanded = !recentActionsExpanded;
        renderRecentActions();
    }

    function updateRecentActionsSummary() {
        const summary = document.getElementById('recent-actions-summary');
        if (!summary) return;
        const actions = window.recentActionsCache || [];
        if (!actions.length) {
            summary.textContent = 'No recent actions loaded yet.';
            return;
        }
        const latest = actions[0]?.created_at ? new Date(actions[0].created_at).toLocaleString() : 'n/a';
        summary.textContent = `Loaded ${actions.length} items • Latest entry: ${latest}`;
    }

    async function purgeRecentActions(rangeKey) {
        const label = recentActionRangeLabels[rangeKey] || rangeKey;
        if (!confirm(`Delete recent actions ${label}?`)) return;
        try {
            const res = await fetch(`/api/recent-actions?range=${encodeURIComponent(rangeKey)}`, { method: 'DELETE' });
            const payload = await res.json().catch(() => ({}));
            if (!res.ok) {
                throw new Error(payload.detail || res.statusText || 'Delete failed');
            }
            const deleted = typeof payload.deleted === 'number' ? payload.deleted : null;
            await loadRecentActions();
            updateRecentActionsSummary();
            const deletedText = deleted !== null ? ` — removed ${deleted}` : '';
            showSuccessNotification(`Recent actions cleaned (${label})${deletedText}`);
        } catch (err) {
            console.error('Failed to purge recent actions:', err);
            showErrorNotification(`Failed to purge recent actions: ${err.message}`);
        }
    }

        async function openActionDetailsModal(action) {
                const modal = document.getElementById('action-details-modal');
                const content = document.getElementById('action-details-content');
                if (!modal || !content) return;

                // Ensure modal is attached to <body> so parent transforms/overflow don't hide it
                if (modal.parentElement !== document.body) {
                        document.body.appendChild(modal);
                }

                // Force overlay visibility and stacking above everything
                Object.assign(modal.style, {
                        display: 'flex',
                        position: 'fixed',
                        top: '0',
                        left: '0',
                        width: '100%',
                        height: '100%',
                        zIndex: '99999'
                });

                // Initial loading state
                content.innerHTML = '<div class="text-center py-4">Loading related data…</div>';

                // Render specific view by entity type
                await renderActionViewInModal(action, content);
    }

        async function renderActionViewInModal(action, contentEl) {
                const entity = (action.entity_type || '').toLowerCase();

                if (entity.includes('ship')) {
                        await renderShipmentModal(contentEl);
                        return;
                }
                if (entity.includes('install')) {
                        await renderInstallModal(contentEl);
                        return;
                }
                if (entity.includes('remove')) {
                        await renderRemoveModal(contentEl);
                        return;
                }
                if (entity.includes('repair')) {
                        await renderRepairModal(contentEl);
                        return;
                }
                if (entity.includes('part')) {
                        await renderPartsModal(contentEl);
                        return;
                }
                if (entity.includes('engine')) {
                        await renderEnginesListModal(contentEl);
                        return;
                }

                // Fallback: show basic info
                const dateStr = action.created_at ? new Date(action.created_at).toLocaleString() : '';
                const description = formatActionMessage(action.message);
                contentEl.innerHTML = `
                        <div class="mb-2"><strong>Дата и время:</strong> ${dateStr}</div>
                        <div class="mb-2"><strong>Пользователь:</strong> ${action.performed_by || '-'}</div>
                        <div class="mb-2"><strong>Действие:</strong> ${action.action_type}</div>
                        <div class="mb-2"><strong>Сущность:</strong> ${action.entity_type} (ID: ${action.entity_id ?? '-'})</div>
                        <div class="mb-3"><strong>Описание:</strong> ${description}</div>
                        <div class="d-flex justify-content-end gap-2"><button class="btn btn-secondary" onclick="closeActionDetailsModal()">Закрыть</button></div>
                `;
        }

    function formatActionMessage(msg) {
        if (!msg) return '-';
        if (typeof msg === 'string') return msg;
        if (typeof msg === 'object') {
            if (msg.summary) return msg.summary;
            try { return JSON.stringify(msg); } catch { return String(msg); }
        }
        return String(msg);
    }

        async function renderShipmentModal(container) {
                container.innerHTML = '<div class="text-muted">Loading shipment history…</div>';
                let res = await safeFetch('/api/history/SHIP' + window.noCache());
                if (!res || !res.ok) res = await safeFetch('/api/history/SHIP');
                if (!res || !res.ok) { container.innerHTML = '<div class="text-danger">Unable to load shipment records</div>'; return; }
                let data = []; try { data = await res.json(); } catch { data = []; }
                if (!Array.isArray(data) || data.length === 0) { container.innerHTML = '<div class="text-muted">No shipment records</div>'; return; }
                container.innerHTML = `
                        <h5 class="mb-3">Shipment History</h5>
                        <div class="table-responsive" style="max-height:60vh;">
                            <table class="table table-sm align-middle mb-0">
                                <thead><tr><th>Date</th><th>Engine</th><th>From</th><th>To</th><th>Remarks</th></tr></thead>
                                <tbody>
                                    ${data.map(row => `
                                        <tr>
                                            <td>${row.date || '-'}</td>
                                            <td><strong>${row.current_sn || '-'}</strong> <small class="text-muted">(${row.original_sn || '-'})</small></td>
                                            <td>${row.from || '-'}</td>
                                            <td><span class="badge bg-info text-white">${row.to || '-'}</span></td>
                                            <td>${row.remarks || '-'}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                        <div class="d-flex justify-content-end mt-3"><button class="btn btn-secondary" onclick="closeActionDetailsModal()">Закрыть</button></div>
                `;
        }

        async function renderInstallModal(container) {
                container.innerHTML = '<div class="text-muted">Loading installation history…</div>';
                let res = await safeFetch('/api/history/INSTALL' + window.noCache());
                if (!res || !res.ok) res = await safeFetch('/api/history/INSTALL');
                if (!res || !res.ok) { container.innerHTML = '<div class="text-danger">Unable to load installations</div>'; return; }
                let data = []; try { data = await res.json(); } catch { data = []; }
                if (!Array.isArray(data) || data.length === 0) { container.innerHTML = '<div class="text-muted">No installations found</div>'; return; }
                container.innerHTML = `
                        <h5 class="mb-3">Installation History</h5>
                        <div class="table-responsive" style="max-height:60vh;">
                            <table class="table table-sm align-middle mb-0">
                                <thead><tr><th>Date</th><th>Original SN</th><th>Current SN</th><th>Install To</th><th>Position</th><th>From</th><th>TT</th><th>TC</th><th>Remarks</th></tr></thead>
                                <tbody>
                                    ${data.map(row => `
                                        <tr>
                                            <td>${row.date || '-'}</td>
                                            <td>${row.original_sn || '-'}</td>
                                            <td>${row.current_sn || '-'}</td>
                                            <td><span class="badge bg-primary">${row.install_to || '-'}</span></td>
                                            <td>${row.position || '-'}</td>
                                            <td>${row.location_from || '-'}</td>
                                            <td>${row.tt || '-'}</td>
                                            <td>${row.tc || '-'}</td>
                                            <td><small>${row.remarks || '-'}</small></td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                        <div class="d-flex justify-content-end mt-3"><button class="btn btn-secondary" onclick="closeActionDetailsModal()">Закрыть</button></div>
                `;
        }

        async function renderRemoveModal(container) {
                container.innerHTML = '<div class="text-muted">Loading removal history…</div>';
                let res = await safeFetch('/api/history/REMOVE' + window.noCache());
                if (!res || !res.ok) res = await safeFetch('/api/history/REMOVE');
                if (!res || !res.ok) { container.innerHTML = '<div class="text-danger">Unable to load removals</div>'; return; }
                let data = []; try { data = await res.json(); } catch { data = []; }
                if (!Array.isArray(data) || data.length === 0) { container.innerHTML = '<div class="text-muted">No removal records</div>'; return; }
                container.innerHTML = `
                        <h5 class="mb-3">Removal History</h5>
                        <div class="table-responsive" style="max-height:60vh;">
                            <table class="table table-sm align-middle mb-0">
                                <thead><tr><th>Date</th><th>Original SN</th><th>Current SN</th><th>Position</th><th>From</th><th>TT</th><th>TC</th><th>Remarks</th></tr></thead>
                                <tbody>
                                    ${data.map(row => `
                                        <tr>
                                            <td>${row.date || '-'}</td>
                                            <td>${row.original_sn || '-'}</td>
                                            <td>${row.current_sn || '-'}</td>
                                            <td>${row.position || '-'}</td>
                                            <td>${row.location_from || '-'}</td>
                                            <td>${row.tt || '-'}</td>
                                            <td>${row.tc || '-'}</td>
                                            <td><small>${row.remarks || '-'}</small></td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                        <div class="d-flex justify-content-end mt-3"><button class="btn btn-secondary" onclick="closeActionDetailsModal()">Закрыть</button></div>
                `;
        }

        async function renderRepairModal(container) {
                container.innerHTML = '<div class="text-muted">Loading repair history…</div>';
                let res = await safeFetch('/api/history/REPAIR' + window.noCache());
                if (!res || !res.ok) res = await safeFetch('/api/history/REPAIR');
                if (!res || !res.ok) { container.innerHTML = '<div class="text-danger">Unable to load repairs</div>'; return; }
                let data = []; try { data = await res.json(); } catch { data = []; }
                if (!Array.isArray(data) || data.length === 0) { container.innerHTML = '<div class="text-muted">No repair records</div>'; return; }
                container.innerHTML = `
                        <h5 class="mb-3">Repair History</h5>
                        <div class="table-responsive" style="max-height:60vh;">
                            <table class="table table-sm align-middle mb-0">
                                <thead><tr><th>Date</th><th>Engine</th><th>Event</th><th>Provider</th><th>Status</th><th>Remarks</th></tr></thead>
                                <tbody>
                                    ${data.map(row => `
                                        <tr>
                                            <td>${row.date || '-'}</td>
                                            <td>${row.engine_sn || '-'}</td>
                                            <td>${row.event_type || '-'}</td>
                                            <td>${row.provider || '-'}</td>
                                            <td>${row.status || '-'}</td>
                                            <td><small>${row.remarks || '-'}</small></td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                        <div class="d-flex justify-content-end mt-3"><button class="btn btn-secondary" onclick="closeActionDetailsModal()">Закрыть</button></div>
                `;
        }

        async function renderPartsModal(container) {
                container.innerHTML = '<div class="text-muted">Loading parts logistics…</div>';
                let res = await safeFetch('/api/history/PARTS' + window.noCache());
                if (!res || !res.ok) res = await safeFetch('/api/history/PARTS');
                if (!res || !res.ok) { container.innerHTML = '<div class="text-danger">Unable to load parts records</div>'; return; }
                let data = []; try { data = await res.json(); } catch { data = []; }
                if (!Array.isArray(data) || data.length === 0) { container.innerHTML = '<div class="text-muted">No parts records</div>'; return; }
                container.innerHTML = `
                    <h5 class="mb-3"><span data-parts-title="logistics">Parts Removal/Installation</span></h5>
                        <div class="table-responsive" style="max-height:60vh;">
                            <table class="table table-sm align-middle mb-0">
                                <thead><tr><th>Date</th><th>Part</th><th>From</th><th>To</th><th>Qty</th><th>Remarks</th></tr></thead>
                                <tbody>
                                    ${data.map(row => `
                                        <tr>
                                            <td>${row.date || '-'}</td>
                                            <td>${row.part_name || row.part_number || '-'}</td>
                                            <td>${row.from || '-'}</td>
                                            <td>${row.to || '-'}</td>
                                            <td>${row.quantity ?? '-'}</td>
                                            <td><small>${row.remarks || '-'}</small></td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                        <div class="d-flex justify-content-end mt-3"><button class="btn btn-secondary" onclick="closeActionDetailsModal()">Закрыть</button></div>
                `;
                applyPartsSettings();
        }

        async function renderEnginesListModal(container) {
                container.innerHTML = '<div class="text-muted">Loading engines…</div>';
                let res = await safeFetch('/api/engines' + window.noCache());
                if (!res || !res.ok) res = await safeFetch('/api/engines');
                if (!res || !res.ok) { container.innerHTML = '<div class="text-danger">Unable to load engines</div>'; return; }
                let data = []; try { data = await res.json(); } catch { data = []; }
                if (!Array.isArray(data) || data.length === 0) { container.innerHTML = '<div class="text-muted">No engines found</div>'; return; }
                container.innerHTML = `
                        <h5 class="mb-3">Engines</h5>
                        <div class="table-responsive" style="max-height:60vh;">
                            <table class="table table-sm align-middle mb-0">
                                <thead><tr><th>Original SN</th><th>Current SN</th><th>Type</th><th>Status</th><th>Install Date</th></tr></thead>
                                <tbody>
                                    ${data.map(row => `
                                        <tr>
                                            <td>${row.original_sn || '-'}</td>
                                            <td>${row.current_sn || '-'}</td>
                                            <td>${row.engine_type || '-'}</td>
                                            <td>${row.status || '-'}</td>
                                            <td>${row.install_date || '-'}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                        <div class="d-flex justify-content-end mt-3"><button class="btn btn-secondary" onclick="closeActionDetailsModal()">Закрыть</button></div>
                `;
        }

    function closeActionDetailsModal() {
        const modal = document.getElementById('action-details-modal');
        if (modal) modal.style.display = 'none';
    }

    function navigateToAction(targetJsonStr) {
        let target = null; try { target = JSON.parse(targetJsonStr); } catch {}
        if (!target || !target.view) { closeActionDetailsModal(); return; }
        closeActionDetailsModal();
        const v = target.view;
        // Route to corresponding view and focus appropriate tab/section
        if (v === 'install') { hideAllViews(); document.getElementById('view-install').style.display='block'; updateHistory('install'); switchInstallTab(target.tab || 'info'); return; }
        if (v === 'shipment') { hideAllViews(); document.getElementById('view-shipment').style.display='block'; updateHistory('shipment'); switchShipmentTab(target.tab || 'info'); return; }
        if (v === 'remove') { hideAllViews(); document.getElementById('view-remove').style.display='block'; updateHistory('remove'); switchRemoveTab(target.tab || 'info'); return; }
        if (v === 'repair') { hideAllViews(); document.getElementById('view-repair').style.display='block'; updateHistory('repair'); switchRepairTab(target.tab || 'info'); return; }
        if (v === 'utilization_parameter') { openUtilizationParamView(); switchUtilParamTab('history'); return; }
        if (v === 'borescope') { openBoroscopeView(); switchBoroscopeTab(target.tab || 'info'); return; }
        if (v === 'purchase-orders') { openPurchaseOrdersView(); switchPurchaseOrdersTab(target.tab || 'info'); return; }
        if (v === 'store-balance') { openStoreBalanceView(); switchStoreBalanceTab('list'); return; }
        if (v === 'settings-city' || v === 'settings-fleet') {
            const modalEl = document.getElementById('settings-modal');
            const modal = new bootstrap.Modal(modalEl);
            modal.show();
            setTimeout(() => {
                const id = v === 'settings-city' ? 'collapse-city' : 'collapse-fleet';
                const el = document.getElementById(id);
                if (el && !el.classList.contains('show')) new bootstrap.Collapse(el, {toggle:true});
                el?.scrollIntoView({behavior:'smooth', block:'start'});
            }, 250);
            return;
        }
        // Fallback: go to dashboard
        openDashboardView();
    }
    
    function initializeAllEngines() {
        // Find all canvas elements and initialize 3D engines
        document.querySelectorAll('.engine-3d-canvas').forEach(canvas => {
            const aircraftId = canvas.id.replace('engine3d-', '');
            initEngine3D(canvas, aircraftId);
        });
    }
    
    function initEngine3D(canvas, aircraftId) {
        if (!canvas || !THREE) return;
        
        // Scene setup
        const scene = new THREE.Scene();
        const width = canvas.clientWidth || 160;
        const height = canvas.clientHeight || 100;
        
        // Camera - 3/4 perspective view like reference images
        const aspect = width / height;
        const camera = new THREE.PerspectiveCamera(55, aspect, 1, 500);
        camera.position.set(-55, 12, 45);
        camera.lookAt(0, 0, 0);
        
        // OrbitControls - интерактивное вращение мышкой
        const controls = new THREE.OrbitControls(camera, canvas);
        controls.enableDamping = true;
        controls.dampingFactor = 0.05;
        controls.minDistance = 30;
        controls.maxDistance = 150;
        controls.enablePan = false;
        controls.autoRotate = false;
        
        // Renderer with improved quality
        const renderer = new THREE.WebGLRenderer({ 
            canvas: canvas, 
            antialias: true, 
            alpha: true,
            powerPreference: "high-performance"
        });
        renderer.setSize(width, height);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        renderer.setClearColor(0x1a1a1a, 0);
        renderer.shadowMap.enabled = true;
        renderer.shadowMap.type = THREE.PCFSoftShadowMap;
        
        // Professional studio lighting setup
        const ambientLight = new THREE.AmbientLight(0xb0c4de, 0.5);
        scene.add(ambientLight);
        
        const keyLight = new THREE.DirectionalLight(0xffffff, 1.5);
        keyLight.position.set(-70, 50, 60);
        keyLight.castShadow = true;
        scene.add(keyLight);
        
        const fillLight = new THREE.DirectionalLight(0x88bbff, 0.6);
        fillLight.position.set(60, 30, -40);
        scene.add(fillLight);
        
        const rimLight = new THREE.DirectionalLight(0xffddaa, 0.7);
        rimLight.position.set(-40, -15, -50);
        scene.add(rimLight);
        
        const backLight = new THREE.DirectionalLight(0xff8844, 0.4);
        backLight.position.set(80, 10, 0);
        scene.add(backLight);
        
        // Engine Group Container
        const engineGroup = new THREE.Group();
        scene.add(engineGroup);
        
        // PBR Materials - highly realistic finishes based on reference images
        const nacelleBlue = new THREE.MeshStandardMaterial({ 
            color: 0x4a7cb8,
            metalness: 0.6,
            roughness: 0.3,
            envMapIntensity: 0.9
        });
        
        const nacelleLight = new THREE.MeshStandardMaterial({ 
            color: 0x8ab4d4,
            metalness: 0.5,
            roughness: 0.35
        });
        
        const casingDark = new THREE.MeshStandardMaterial({ 
            color: 0x3a3a3a,
            metalness: 0.85,
            roughness: 0.25
        });
        
        const casingLight = new THREE.MeshStandardMaterial({ 
            color: 0xa0a0a0,
            metalness: 0.9,
            roughness: 0.2
        });
        
        const fanBladeMetal = new THREE.MeshStandardMaterial({ 
            color: 0x505050,
            metalness: 0.95,
            roughness: 0.12,
            side: THREE.DoubleSide
        });
        
        const compressorBlade = new THREE.MeshStandardMaterial({ 
            color: 0xb8c8d8,
            metalness: 0.92,
            roughness: 0.08,
            emissive: 0x334455,
            emissiveIntensity: 0.1
        });
        
        const compressorDisk = new THREE.MeshStandardMaterial({ 
            color: 0xa8b8c8,
            metalness: 0.88,
            roughness: 0.15
        });
        
        const shaftTitanium = new THREE.MeshStandardMaterial({ 
            color: 0x707080,
            metalness: 0.95,
            roughness: 0.1
        });
        
        const combustorCasing = new THREE.MeshStandardMaterial({ 
            color: 0x888888,
            metalness: 0.75,
            roughness: 0.35,
            emissive: 0xff4400,
            emissiveIntensity: 0.0
        });
        
        const turbineBlade = new THREE.MeshStandardMaterial({ 
            color: 0xd4a858,
            metalness: 0.9,
            roughness: 0.15,
            emissive: 0xcc8800,
            emissiveIntensity: 0.2
        });
        
        const turbineDisk = new THREE.MeshStandardMaterial({ 
            color: 0xb89858,
            metalness: 0.88,
            roughness: 0.2,
            emissive: 0xaa7700,
            emissiveIntensity: 0.15
        });
        
        const exhaustNozzle = new THREE.MeshStandardMaterial({ 
            color: 0x909090,
            metalness: 0.85,
            roughness: 0.3,
            emissive: 0xff5500,
            emissiveIntensity: 0.0
        });
        
        // OUTER NACELLE COWLING - Large blue casing (cutaway top view)
        const nacelleGroup = new THREE.Group();
        
        // Inlet cowl - large diameter blue section
        const inletGeom = new THREE.CylinderGeometry(16, 15, 10, 48, 1, false, -0.1, Math.PI + 0.2);
        const inlet = new THREE.Mesh(inletGeom, nacelleBlue);
        inlet.rotation.z = Math.PI / 2;
        inlet.position.x = -32;
        nacelleGroup.add(inlet);
        
        // Fan cowl section (lighter blue)
        const fanCowlGeom = new THREE.CylinderGeometry(14.5, 13, 16, 48, 1, false, -0.1, Math.PI + 0.2);
        const fanCowl = new THREE.Mesh(fanCowlGeom, nacelleLight);
        fanCowl.rotation.z = Math.PI / 2;
        fanCowl.position.x = -18;
        nacelleGroup.add(fanCowl);
        
        // Main nacelle body (tapers towards rear)
        const nacelleBodyGeom = new THREE.CylinderGeometry(12, 9, 45, 48, 1, false, -0.1, Math.PI + 0.2);
        const nacelleBody = new THREE.Mesh(nacelleBodyGeom, nacelleBlue);
        nacelleBody.rotation.z = Math.PI / 2;
        nacelleBody.position.x = 8;
        nacelleGroup.add(nacelleBody);
        
        // Inlet lip (polished metal edge)
        const lipGeom = new THREE.TorusGeometry(15.5, 0.6, 20, 48, Math.PI);
        const lip = new THREE.Mesh(lipGeom, casingLight);
        lip.rotation.y = Math.PI / 2;
        lip.rotation.x = Math.PI;
        lip.position.x = -37;
        nacelleGroup.add(lip);
        
        // Cowl separation lines (panel details)
        for (let i = 0; i < 3; i++) {
            const lineGeom = new THREE.TorusGeometry(13.5 - i * 1.5, 0.08, 8, 48, Math.PI);
            const line = new THREE.Mesh(lineGeom, casingDark);
            line.rotation.y = Math.PI / 2;
            line.rotation.x = Math.PI;
            line.position.x = -10 + i * 12;
            nacelleGroup.add(line);
        }
        
        engineGroup.add(nacelleGroup);
        
        // Inner core engine casing (dark gray, structural)
        const coreOuterGeom = new THREE.CylinderGeometry(8.5, 6, 58, 48, 1, false, -0.15, Math.PI + 0.3);
        const coreOuter = new THREE.Mesh(coreOuterGeom, casingDark);
        coreOuter.rotation.z = Math.PI / 2;
        coreOuter.position.x = 0;
        engineGroup.add(coreOuter);
        
        // Bypass duct stators (visible between nacelle and core)
        for (let i = 0; i < 6; i++) {
            const angle = (i / 6) * Math.PI;
            const strutGeom = new THREE.BoxGeometry(12, 0.25, 4);
            const strut = new THREE.Mesh(strutGeom, casingLight);
            strut.position.set(-15, Math.cos(angle) * 11, Math.sin(angle) * 11);
            strut.rotation.z = angle;
            engineGroup.add(strut);
        }
        
        // CENTRAL ROTATING SHAFTS (dual spool design)
        // Low pressure shaft (larger diameter, connects fan to LPT)
        const lpShaftGeom = new THREE.CylinderGeometry(1.4, 1.3, 70, 32);
        const lpShaft = new THREE.Mesh(lpShaftGeom, shaftTitanium);
        lpShaft.rotation.z = Math.PI / 2;
        lpShaft.position.x = 0;
        engineGroup.add(lpShaft);
        
        // High pressure shaft (inside LP shaft, connects HPC to HPT)
        const hpShaftGeom = new THREE.CylinderGeometry(0.9, 0.85, 50, 24);
        const hpShaft = new THREE.Mesh(hpShaftGeom, new THREE.MeshStandardMaterial({ 
            color: 0x505060, metalness: 0.98, roughness: 0.05 
        }));
        hpShaft.rotation.z = Math.PI / 2;
        hpShaft.position.x = 5;
        engineGroup.add(hpShaft);
        
        // 1. MASSIVE INLET FAN - The most visually dominant component
        // Fan disk/hub
        const fanDiskGeom = new THREE.CylinderGeometry(4.5, 5, 5, 48);
        const fanDisk = new THREE.Mesh(fanDiskGeom, casingDark);
        fanDisk.rotation.z = Math.PI / 2;
        fanDisk.position.x = -30;
        engineGroup.add(fanDisk);
        
        // Nose cone spinner (aerodynamic)
        const spinnerGeom = new THREE.ConeGeometry(4.5, 8, 48);
        const spinner = new THREE.Mesh(spinnerGeom, casingLight);
        spinner.rotation.z = -Math.PI / 2;
        spinner.position.x = -35;
        engineGroup.add(spinner);
        
        // Wide-chord fan blades (modern design, 18-22 blades typical)
        const fanBlades = new THREE.Group();
        const numFanBlades = 20;
        for (let i = 0; i < numFanBlades; i++) {
            const angle = (i / numFanBlades) * Math.PI * 2;
            
            // Realistic wide-chord fan blade profile
            const bladeShape = new THREE.Shape();
            bladeShape.moveTo(0, 0);
            bladeShape.lineTo(1.2, 0);
            bladeShape.bezierCurveTo(2, 3, 2.5, 7, 1.8, 11);
            bladeShape.lineTo(0.4, 11);
            bladeShape.bezierCurveTo(0.8, 7, 0.6, 3, 0, 0);
            
            const extrudeSettings = { 
                depth: 0.4, 
                bevelEnabled: true, 
                bevelThickness: 0.08, 
                bevelSize: 0.08,
                bevelSegments: 3
            };
            const bladeGeom = new THREE.ExtrudeGeometry(bladeShape, extrudeSettings);
            const blade = new THREE.Mesh(bladeGeom, fanBladeMetal);
            
            // Position blade radially
            const radius = 5;
            blade.position.set(
                Math.cos(angle) * radius,
                Math.sin(angle) * radius,
                -0.2
            );
            blade.rotation.z = angle - Math.PI / 2;
            blade.rotation.y = Math.PI / 6; // Blade twist/pitch
            
            fanBlades.add(blade);
        }
        fanBlades.rotation.z = Math.PI / 2;
        fanBlades.position.x = -30;
        engineGroup.add(fanBlades);
        
        // 2. LOW PRESSURE COMPRESSOR (Booster) - 4-5 stages, beautiful blue/silver blades
        const lpcStages = [];
        const lpcBladeGroups = [];
        const lpcStatorGroups = [];
        
        for (let i = 0; i < 4; i++) {
            const radius = 7.8 - i * 0.6;
            const posX = -20 + i * 4;
            
            // Rotor disk (rotating)
            const diskGeom = new THREE.CylinderGeometry(radius + 0.3, radius - 0.3, 1.2, 48);
            const disk = new THREE.Mesh(diskGeom, compressorDisk);
            disk.rotation.z = Math.PI / 2;
            disk.position.x = posX;
            engineGroup.add(disk);
            lpcStages.push(disk);
            
            // Rotor blades (attached to disk)
            const rotorGroup = new THREE.Group();
            const numRotorBlades = 38 - i * 4;
            for (let j = 0; j < numRotorBlades; j++) {
                const angle = (j / numRotorBlades) * Math.PI * 2;
                const bladeHeight = radius * 0.65;
                const bladeGeom = new THREE.BoxGeometry(0.4, bladeHeight, 1.4);
                const blade = new THREE.Mesh(bladeGeom, compressorBlade);
                blade.position.set(
                    Math.cos(angle) * (radius * 0.65),
                    Math.sin(angle) * (radius * 0.65),
                    0
                );
                blade.rotation.z = angle;
                blade.rotation.x = -0.18; // Blade stagger angle
                rotorGroup.add(blade);
            }
            rotorGroup.rotation.z = Math.PI / 2;
            rotorGroup.position.x = posX;
            engineGroup.add(rotorGroup);
            lpcBladeGroups.push(rotorGroup);
            
            // Stator vanes (stationary, between stages)
            if (i < 3) {
                const statorGroup = new THREE.Group();
                const numStatorVanes = 42 - i * 4;
                for (let j = 0; j < numStatorVanes; j++) {
                    const angle = (j / numStatorVanes) * Math.PI * 2 + 0.05;
                    const vaneGeom = new THREE.BoxGeometry(0.3, radius * 0.6, 1.1);
                    const vane = new THREE.Mesh(vaneGeom, compressorBlade);
                    vane.position.set(
                        Math.cos(angle) * (radius * 0.7),
                        Math.sin(angle) * (radius * 0.7),
                        0
                    );
                    vane.rotation.z = angle;
                    vane.rotation.x = 0.15; // Opposite angle to rotors
                    statorGroup.add(vane);
                }
                statorGroup.rotation.z = Math.PI / 2;
                statorGroup.position.x = posX + 2;
                engineGroup.add(statorGroup);
                lpcStatorGroups.push(statorGroup);
            }
        }
        
        // 3. HIGH PRESSURE COMPRESSOR - 9-10 stages, highly compressed (blue glow visible)
        const hpcStages = [];
        const hpcBladeGroups = [];
        const hpcStatorGroups = [];
        
        for (let i = 0; i < 9; i++) {
            const radius = 5.5 - i * 0.4;
            const posX = -4 + i * 2;
            
            // HPC rotor disk (smaller, denser)
            const diskGeom = new THREE.CylinderGeometry(radius + 0.2, radius - 0.25, 0.7, 48);
            const disk = new THREE.Mesh(diskGeom, compressorDisk);
            disk.rotation.z = Math.PI / 2;
            disk.position.x = posX;
            engineGroup.add(disk);
            hpcStages.push(disk);
            
            // HPC rotor blades (very dense, many blades)
            const rotorGroup = new THREE.Group();
            const numRotorBlades = 48 - i * 3;
            for (let j = 0; j < numRotorBlades; j++) {
                const angle = (j / numRotorBlades) * Math.PI * 2;
                const bladeHeight = radius * 0.6;
                const bladeGeom = new THREE.BoxGeometry(0.28, bladeHeight, 0.9);
                const blade = new THREE.Mesh(bladeGeom, compressorBlade);
                blade.position.set(
                    Math.cos(angle) * (radius * 0.7),
                    Math.sin(angle) * (radius * 0.7),
                    0
                );
                blade.rotation.z = angle;
                blade.rotation.x = -0.25;
                rotorGroup.add(blade);
            }
            rotorGroup.rotation.z = Math.PI / 2;
            rotorGroup.position.x = posX;
            engineGroup.add(rotorGroup);
            hpcBladeGroups.push(rotorGroup);
            
            // HPC stator vanes
            if (i < 8) {
                const statorGroup = new THREE.Group();
                const numStatorVanes = 52 - i * 3;
                for (let j = 0; j < numStatorVanes; j++) {
                    const angle = (j / numStatorVanes) * Math.PI * 2 + 0.03;
                    const vaneGeom = new THREE.BoxGeometry(0.22, radius * 0.55, 0.75);
                    const vane = new THREE.Mesh(vaneGeom, compressorBlade);
                    vane.position.set(
                        Math.cos(angle) * (radius * 0.75),
                        Math.sin(angle) * (radius * 0.75),
                        0
                    );
                    vane.rotation.z = angle;
                    vane.rotation.x = 0.2;
                    statorGroup.add(vane);
                }
                statorGroup.rotation.z = Math.PI / 2;
                statorGroup.position.x = posX + 1;
                engineGroup.add(statorGroup);
                hpcStatorGroups.push(statorGroup);
            }
        }
        
        // 4. COMBUSTION CHAMBER - Annular combustor (hottest section, orange/yellow glow)
        // Outer combustor casing
        const combustorOuterGeom = new THREE.CylinderGeometry(5.5, 5.2, 8, 48);
        const combustorOuter = new THREE.Mesh(combustorOuterGeom, combustorCasing);
        combustorOuter.rotation.z = Math.PI / 2;
        combustorOuter.position.x = 15;
        engineGroup.add(combustorOuter);
        
        // Inner combustor liner (visible glow)
        const combustorInnerGeom = new THREE.CylinderGeometry(3.8, 3.8, 7, 48);
        const combustorInner = new THREE.Mesh(combustorInnerGeom, combustorCasing);
        combustorInner.rotation.z = Math.PI / 2;
        combustorInner.position.x = 15;
        engineGroup.add(combustorInner);
        
        // Flame tube with glow effect
        const flameTubeGeom = new THREE.CylinderGeometry(4.2, 4.2, 6, 32);
        const flameTube = new THREE.Mesh(flameTubeGeom, new THREE.MeshStandardMaterial({
            color: 0x664400,
            metalness: 0.3,
            roughness: 0.7,
            emissive: 0xff6600,
            emissiveIntensity: 0.0,
            transparent: true,
            opacity: 0.8
        }));
        flameTube.rotation.z = Math.PI / 2;
        flameTube.position.x = 15;
        engineGroup.add(flameTube);
        
        // Fuel nozzles (swirl vanes visible from cutaway)
        const fuelNozzleGroup = new THREE.Group();
        for (let i = 0; i < 18; i++) {
            const angle = (i / 18) * Math.PI * 2;
            const nozzleGeom = new THREE.CylinderGeometry(0.18, 0.25, 2.5, 12);
            const nozzle = new THREE.Mesh(nozzleGeom, shaftTitanium);
            nozzle.position.set(
                12,
                Math.cos(angle) * 4.8,
                Math.sin(angle) * 4.8
            );
            nozzle.rotation.z = angle;
            fuelNozzleGroup.add(nozzle);
            
            // Swirl vanes on each nozzle
            for (let v = 0; v < 6; v++) {
                const vaneAngle = (v / 6) * Math.PI * 2;
                const vaneGeom = new THREE.BoxGeometry(0.05, 0.4, 0.6);
                const vane = new THREE.Mesh(vaneGeom, casingLight);
                vane.position.set(
                    0.5,
                    Math.cos(vaneAngle) * 0.2,
                    Math.sin(vaneAngle) * 0.2
                );
                vane.rotation.x = vaneAngle;
                nozzle.add(vane);
            }
        }
        engineGroup.add(fuelNozzleGroup);
        
        // 5. HIGH PRESSURE TURBINE - 2 stages (golden/bronze, operates at 1600°C+)
        const hptStages = [];
        const hptBladeGroups = [];
        const hptStatorGroups = [];
        
        for (let i = 0; i < 2; i++) {
            const radius = 4.2 - i * 0.25;
            const posX = 20 + i * 2.5;
            
            // HPT disk (robust, golden color from heat)
            const diskGeom = new THREE.CylinderGeometry(radius + 0.2, radius + 0.1, 1.2, 48);
            const disk = new THREE.Mesh(diskGeom, turbineDisk);
            disk.rotation.z = Math.PI / 2;
            disk.position.x = posX;
            engineGroup.add(disk);
            hptStages.push(disk);
            
            // HPT rotor blades (thick, cooled blades)
            const rotorGroup = new THREE.Group();
            const numBlades = 28 - i * 4;
            for (let j = 0; j < numBlades; j++) {
                const angle = (j / numBlades) * Math.PI * 2;
                const bladeGeom = new THREE.BoxGeometry(0.55, radius * 0.7, 1.8);
                const blade = new THREE.Mesh(bladeGeom, turbineBlade);
                blade.position.set(
                    Math.cos(angle) * (radius * 0.6),
                    Math.sin(angle) * (radius * 0.6),
                    0
                );
                blade.rotation.z = angle;
                blade.rotation.x = -0.45; // High deflection angle
                rotorGroup.add(blade);
            }
            rotorGroup.rotation.z = Math.PI / 2;
            rotorGroup.position.x = posX;
            engineGroup.add(rotorGroup);
            hptBladeGroups.push(rotorGroup);
            
            // HPT nozzle guide vanes (NGVs) - stationary
            if (i === 0) {
                const nozzleGroup = new THREE.Group();
                const numNozzles = 32;
                for (let j = 0; j < numNozzles; j++) {
                    const angle = (j / numNozzles) * Math.PI * 2;
                    const nozzleGeom = new THREE.BoxGeometry(0.5, radius * 0.75, 1.5);
                    const nozzle = new THREE.Mesh(nozzleGeom, turbineBlade);
                    nozzle.position.set(
                        Math.cos(angle) * (radius * 0.65),
                        Math.sin(angle) * (radius * 0.65),
                        0
                    );
                    nozzle.rotation.z = angle;
                    nozzle.rotation.x = 0.35;
                    nozzleGroup.add(nozzle);
                }
                nozzleGroup.rotation.z = Math.PI / 2;
                nozzleGroup.position.x = 19;
                engineGroup.add(nozzleGroup);
                hptStatorGroups.push(nozzleGroup);
            }
        }
        
        // 6. LOW PRESSURE TURBINE - 5-7 stages (large diameter, drives fan)
        const lptStages = [];
        const lptBladeGroups = [];
        const lptStatorGroups = [];
        
        for (let i = 0; i < 5; i++) {
            const radius = 7.2 - i * 0.45;
            const posX = 26 + i * 3;
            
            // LPT disk (large, robust construction)
            const diskGeom = new THREE.CylinderGeometry(radius + 0.25, radius + 0.15, 1.4, 48);
            const disk = new THREE.Mesh(diskGeom, turbineDisk);
            disk.rotation.z = Math.PI / 2;
            disk.position.x = posX;
            engineGroup.add(disk);
            lptStages.push(disk);
            
            // LPT rotor blades (longer, more visible)
            const rotorGroup = new THREE.Group();
            const numBlades = 32 - i * 3;
            for (let j = 0; j < numBlades; j++) {
                const angle = (j / numBlades) * Math.PI * 2;
                const bladeHeight = radius * 0.68;
                const bladeGeom = new THREE.BoxGeometry(0.5, bladeHeight, 1.5);
                const blade = new THREE.Mesh(bladeGeom, turbineBlade);
                blade.position.set(
                    Math.cos(angle) * (radius * 0.62),
                    Math.sin(angle) * (radius * 0.62),
                    0
                );
                blade.rotation.z = angle;
                blade.rotation.x = -0.38;
                rotorGroup.add(blade);
            }
            rotorGroup.rotation.z = Math.PI / 2;
            rotorGroup.position.x = posX;
            engineGroup.add(rotorGroup);
            lptBladeGroups.push(rotorGroup);
            
            // LPT stator vanes
            if (i < 4) {
                const statorGroup = new THREE.Group();
                const numVanes = 36 - i * 3;
                for (let j = 0; j < numVanes; j++) {
                    const angle = (j / numVanes) * Math.PI * 2 + 0.04;
                    const vaneGeom = new THREE.BoxGeometry(0.45, radius * 0.62, 1.3);
                    const vane = new THREE.Mesh(vaneGeom, turbineBlade);
                    vane.position.set(
                        Math.cos(angle) * (radius * 0.67),
                        Math.sin(angle) * (radius * 0.67),
                        0
                    );
                    vane.rotation.z = angle;
                    vane.rotation.x = 0.32;
                    statorGroup.add(vane);
                }
                statorGroup.rotation.z = Math.PI / 2;
                statorGroup.position.x = posX + 1.5;
                engineGroup.add(statorGroup);
                lptStatorGroups.push(statorGroup);
            }
        }
        
        // 7. EXHAUST SECTION - Hot, glowing exit nozzle
        // Exhaust cone (tail cone/plug)
        const tailConeGeom = new THREE.CylinderGeometry(2, 4.5, 14, 48);
        const tailCone = new THREE.Mesh(tailConeGeom, exhaustNozzle);
        tailCone.rotation.z = Math.PI / 2;
        tailCone.position.x = 43;
        engineGroup.add(tailCone);
        
        // Exhaust struts (structural support for tail cone)
        const strutGroup = new THREE.Group();
        for (let i = 0; i < 6; i++) {
            const angle = (i / 6) * Math.PI * 2;
            const strutGeom = new THREE.BoxGeometry(12, 0.35, 1.2);
            const strut = new THREE.Mesh(strutGeom, casingLight);
            strut.position.set(
                43,
                Math.cos(angle) * 6.5,
                Math.sin(angle) * 6.5
            );
            strut.rotation.z = angle;
            strutGroup.add(strut);
        }
        engineGroup.add(strutGroup);
        
        // Exhaust nozzle outer ring
        const nozzleRingGeom = new THREE.CylinderGeometry(8.5, 9, 3, 48);
        const nozzleRing = new THREE.Mesh(nozzleRingGeom, exhaustNozzle);
        nozzleRing.rotation.z = Math.PI / 2;
        nozzleRing.position.x = 48;
        engineGroup.add(nozzleRing);
        
        // Hot exhaust gas plume (glowing particles)
        const exhaustPlume = new THREE.Group();
        for (let i = 0; i < 30; i++) {
            const size = 0.5 + Math.random() * 0.7;
            const particleGeom = new THREE.SphereGeometry(size, 10, 10);
            const hue = 0.08 + Math.random() * 0.08; // Orange to yellow
            const flameMat = new THREE.MeshBasicMaterial({ 
                color: new THREE.Color().setHSL(hue, 1, 0.6),
                transparent: true,
                opacity: 0.4 + Math.random() * 0.3
            });
            const particle = new THREE.Mesh(particleGeom, flameMat);
            
            // Position in exhaust stream
            particle.position.x = 50 + i * 1.5 + Math.random();
            const radialDist = (i / 30) * 4; // Expanding cone
            const angle = Math.random() * Math.PI * 2;
            particle.position.y = Math.cos(angle) * radialDist;
            particle.position.z = Math.sin(angle) * radialDist;
            
            particle.userData.offset = Math.random() * Math.PI * 2;
            particle.userData.speed = 0.6 + Math.random() * 0.6;
            particle.userData.baseX = particle.position.x;
            particle.userData.baseY = particle.position.y;
            particle.userData.baseZ = particle.position.z;
            
            exhaustPlume.add(particle);
        }
        engineGroup.add(exhaustPlume);
        
        // Heat shimmer effect (additional transparent particles)
        const heatShimmer = new THREE.Group();
        for (let i = 0; i < 15; i++) {
            const shimmerGeom = new THREE.SphereGeometry(0.8, 8, 8);
            const shimmerMat = new THREE.MeshBasicMaterial({
                color: 0xffaa44,
                transparent: true,
                opacity: 0.15
            });
            const shimmer = new THREE.Mesh(shimmerGeom, shimmerMat);
            shimmer.position.x = 52 + i * 2;
            shimmer.position.y = (Math.random() - 0.5) * 6;
            shimmer.position.z = (Math.random() - 0.5) * 6;
            shimmer.userData.offset = Math.random() * Math.PI * 2;
            heatShimmer.add(shimmer);
        }
        engineGroup.add(heatShimmer);
        
        // Add subtle rotating motion blur effect to fan
        const fanBlurGroup = new THREE.Group();
        for (let blur = 0; blur < 3; blur++) {
            const blurFan = fanBlades.clone();
            blurFan.rotation.x = (blur * Math.PI) / 12;
            blurFan.children.forEach(blade => {
                blade.material = blade.material.clone();
                blade.material.transparent = true;
                blade.material.opacity = 0.15 - blur * 0.05;
            });
            fanBlurGroup.add(blurFan);
        }
        engineGroup.add(fanBlurGroup);
        
        // Store all animation components
        engineScenes[aircraftId] = {
            scene,
            camera,
            renderer,
            controls,
            lpShaft,
            hpShaft,
            spinner,
            fanBlades,
            lpcStages,
            lpcBladeGroups,
            hpcStages,
            hpcBladeGroups,
            flameTube,
            hptStages,
            hptBladeGroups,
            lptStages,
            lptBladeGroups,
            exhaustPlume,
            heatShimmer,
            time: 0
        };
        
        // Start animation
        animateEngine(aircraftId);
    }
    
    function animateEngine(aircraftId) {
        const data = engineScenes[aircraftId];
        if (!data) return;
        
        const animate = () => {
            requestAnimationFrame(animate);
            
            // Обновляем OrbitControls
            if (data.controls) {
                data.controls.update();
            }
            
            data.time += 0.016;
            
            // N1 Spool (Low Pressure) - Fan, LPC, LPT rotate together (~3500 RPM)
            const n1Speed = 0.05;
            data.lpShaft.rotation.x += n1Speed;
            data.spinner.rotation.x += n1Speed;
            data.fanBlades.rotation.x += n1Speed;
            
            data.lpcStages.forEach(stage => {
                stage.rotation.x += n1Speed;
            });
            data.lpcBladeGroups.forEach(group => {
                group.rotation.x += n1Speed;
            });
            
            data.lptStages.forEach(stage => {
                stage.rotation.x -= n1Speed; // Turbines rotate opposite
            });
            data.lptBladeGroups.forEach(group => {
                group.rotation.x -= n1Speed;
            });
            
            // N2 Spool (High Pressure) - HPC and HPT rotate together (~12000 RPM)
            const n2Speed = 0.18;
            data.hpShaft.rotation.x += n2Speed;
            
            data.hpcStages.forEach(stage => {
                stage.rotation.x += n2Speed;
            });
            data.hpcBladeGroups.forEach(group => {
                group.rotation.x += n2Speed;
            });
            
            data.hptStages.forEach(stage => {
                stage.rotation.x -= n2Speed;
            });
            data.hptBladeGroups.forEach(group => {
                group.rotation.x -= n2Speed;
            });
            
            // Combustion chamber glow (realistic flame intensity)
            const combustionPulse = Math.sin(data.time * 7) * 0.25 + 
                                   Math.sin(data.time * 11.3) * 0.2 + 
                                   Math.sin(data.time * 15.7) * 0.15 + 0.6;
            data.flameTube.material.emissiveIntensity = combustionPulse;
            
            // Exhaust plume animation (hot gas flow)
            data.exhaustPlume.children.forEach((particle, i) => {
                const offset = particle.userData.offset;
                const speed = particle.userData.speed;
                
                // Turbulent swirling motion
                const swirl = data.time * 5 * speed + offset;
                const radialDist = (i / 30) * 4 + Math.sin(swirl) * 0.8;
                const angle = swirl * 0.3;
                
                particle.position.y = Math.cos(angle) * radialDist;
                particle.position.z = Math.sin(angle) * radialDist;
                
                // Flow downstream
                particle.position.x += 0.2 * speed;
                if (particle.position.x > 95) {
                    particle.position.x = particle.userData.baseX;
                }
                
                // Flickering and fading
                const fade = Math.max(0, 1 - (particle.position.x - 50) / 45);
                particle.material.opacity = (0.4 + Math.sin(swirl * 2) * 0.3) * fade;
                
                // Color evolution (orange -> yellow -> white as it cools)
                const progression = (particle.position.x - 50) / 45;
                const hue = Math.max(0.05, 0.12 - progression * 0.07);
                const saturation = Math.max(0.3, 1 - progression * 0.7);
                const lightness = 0.5 + progression * 0.3;
                particle.material.color.setHSL(hue, saturation, lightness);
            });
            
            // Heat shimmer effect
            data.heatShimmer.children.forEach((shimmer, i) => {
                const offset = shimmer.userData.offset;
                shimmer.position.y += Math.sin(data.time * 6 + offset) * 0.1;
                shimmer.position.z += Math.cos(data.time * 6 + offset) * 0.1;
                shimmer.material.opacity = 0.1 + Math.sin(data.time * 8 + offset) * 0.08;
            });
            
            // Dynamic camera movement for cinematic effect
            data.camera.position.y = 12 + Math.sin(data.time * 0.5) * 2;
            data.camera.position.z = 45 + Math.cos(data.time * 0.4) * 3;
            data.camera.position.x = -55 + Math.sin(data.time * 0.3) * 2;
            data.camera.lookAt(0, 0, 0);
            
            data.renderer.render(data.scene, data.camera);
        };
        
        animate();
    }
    
    // Handle window resize for responsive canvas
    window.addEventListener('resize', () => {
        Object.keys(engineScenes).forEach(aircraftId => {
            const data = engineScenes[aircraftId];
            const canvas = data.renderer.domElement;
            const width = canvas.clientWidth || 160;
            const height = canvas.clientHeight || 100;
            
            const aspect = width / height;
            data.camera.aspect = aspect;
            data.camera.updateProjectionMatrix();
            
            data.renderer.setSize(width, height);
        });
    });

    // --- 3. MODAL LOGIC (The "Magic" part) ---
    
    // A. Open Status Table (SV, US, REMOVED...)
    async function openTableModal(status) {
        // Fetch specific engines
        const res = await fetch(`/api/engines?status=${status}`);
        const engines = await res.json();
        
        // Для INSTALLED добавляем колонки с данными самолета
        if (status === 'INSTALLED') {
            setupModal(`Engines Status: ${status}`, 
                ['GSS SN', 'Orig SN', 'Current SN', 'Location', 'TT (Engine)', 'TC (Engine)', 'TTSN (Aircraft)', 'TCSN (Aircraft)'],
                engines.map(e => `
                    <tr>
                        <td>${e.gss_sn || '-'}</td>
                        <td>${e.original_sn}</td>
                        <td><strong>${e.current_sn}</strong></td>
                        <td>${e.location}</td>
                        <td>${e.tt}</td>
                        <td>${e.tc}</td>
                        <td>${e.ac_ttsn !== null && e.ac_ttsn !== undefined ? e.ac_ttsn : '-'}</td>
                        <td>${e.ac_tcsn !== null && e.ac_tcsn !== undefined ? e.ac_tcsn : '-'}</td>
                    </tr>
                `)
            );
        } else {
            setupModal(`Engines Status: ${status}`, 
                ['GSS SN', 'Orig SN', 'Current SN', 'Location', 'TT', 'TC'],
                engines.map(e => `
                    <tr>
                        <td>${e.gss_sn || '-'}</td>
                        <td>${e.original_sn}</td>
                        <td><strong>${e.current_sn}</strong></td>
                        <td>${e.location}</td>
                        <td>${e.tt}</td>
                        <td>${e.tc}</td>
                    </tr>
                `)
            );
        }
    }

    async function openCondition2Modal(base, cond2) {
        // If base is 'ALL', don't filter by status, only by condition_2
        let url = '/api/engines';
        const params = new URLSearchParams();
        if (base !== 'ALL') {
            params.append('status', base);
        }
        if (cond2) {
            params.append('condition2', cond2);
        }
        if (params.toString()) {
            url += '?' + params.toString();
        }
        
        const res = await fetch(url);
        const engines = await res.json();
        setupModal(`${base} - ${cond2}`,
            ['GSS SN','Orig SN','Current SN','Location','TT','TC'],
            engines.length ? engines.map(e => `
                <tr>
                    <td>${e.gss_sn || '-'}</td>
                    <td>${e.original_sn}</td>
                    <td><strong>${e.current_sn}</strong></td>
                    <td>${e.location}</td>
                    <td>${e.tt}</td>
                    <td>${e.tc}</td>
                </tr>
            `) : '<tr><td colspan="6" class="text-center text-muted">No engines</td></tr>'
        );
    }

    async function toggleCondition2Breakdown() {
        const container = document.getElementById('subcards-condition2');
        const chev = document.getElementById('chev-condition2');
        const isHidden = container.style.display === 'none' || !container.style.display;
        if (isHidden) {
            chev.classList.remove('bi-chevron-down');
            chev.classList.add('bi-chevron-up');
            container.style.display = 'flex';
            await loadCondition2Breakdown();
        } else {
            chev.classList.remove('bi-chevron-up');
            chev.classList.add('bi-chevron-down');
            container.style.display = 'none';
        }
    }

    async function loadCondition2Breakdown() {
        // Load stats for all condition_2 types across all engines
        const res = await fetch('/api/engines');
        const engines = await res.json();
        const stats = {};
        engines.forEach(e => {
            const key = e.condition_2 || 'New';
            stats[key] = (stats[key] || 0) + 1;
        });
        // Count Scraped separately from condition_1
        const scrapRes = await fetch('/api/engines?status=SCRAP');
        const scrapEngines = await scrapRes.json();
        stats['Scrap'] = scrapEngines.length;
        
        const container = document.getElementById('subcards-condition2');
        const types = [
            { key: 'Scrap', label: 'Scrapped', cls: 'btn-status-scrap', icon: 'bi-trash-fill', clickBase: 'SCRAP' },
            { key: 'New', label: 'New', cls: 'btn-cond-new', icon: 'bi-stars', clickBase: 'ALL' },
            { key: 'Overhauled', label: 'Overhauled', cls: 'btn-cond-overhauled', icon: 'bi-tools', clickBase: 'ALL' },
            { key: 'Inspected tested', label: 'Inspected Tested', cls: 'btn-cond-inspected', icon: 'bi-search', clickBase: 'ALL' },
            { key: 'AS', label: 'AS (removed)', cls: 'btn-cond-as', icon: 'bi-tag', clickBase: 'ALL' }
        ];
        container.innerHTML = types.map(t => {
            const clickHandler = t.key === 'Scrap' 
                ? `openTableModal('SCRAP')` 
                : `openCondition2Modal('ALL','${t.key}')`;
            return `
                <div class="col">
                    <button class="btn-dashboard btn-dashboard-sub ${t.cls} w-100" onclick="${clickHandler}">
                        <span class="label">${t.label}</span>
                        <span class="count">${stats[t.key] || 0}</span>
                        <i class="bi ${t.icon}"></i>
                    </button>
                </div>
            `;
        }).join('');
    }

    // B. Open Location Table (FRU, SHJ...)
    async function openLocationModal(locId, locName) {
        // Загружаем все двигатели и фильтруем по локации
        const res = await fetch(`/api/engines`);
        const allEngines = await res.json();
        
        // Фильтруем по имени локации (бэкенд возвращает location как текст)
        const filtered = allEngines.filter(e => {
            // Проверяем, содержит ли location имя локации (например "SHJ")
            return e.location && e.location.includes(locName);
        });

        if(filtered.length === 0) {
            setupModal(`Location: ${locName}`, 
                ['GSS SN', 'Orig SN', 'Current SN', 'Status', 'Condition 1', 'Condition 2'],
                '<tr><td colspan="6" class="text-center text-muted">No engines at this location</td></tr>'
            );
            return;
        }

        setupModal(`Location: ${locName}`,
            ['Model', 'GSS SN', 'Orig SN', 'Current SN', 'Status', 'Condition 1', 'Condition 2'],
            filtered.map(e => `
                <tr>
                    <td>${e.model || '-'}</td>
                    <td>${e.gss_sn || '-'}</td>
                    <td>${e.original_sn}</td>
                    <td><strong>${e.current_sn}</strong></td>
                    <td><span class="badge bg-secondary">${e.status}</span></td>
                    <td><span class="badge ${e.condition_1 === 'SV' ? 'bg-success' : e.condition_1 === 'US' ? 'bg-danger' : 'bg-secondary'}">${e.condition_1 || '-'}</span></td>
                    <td><span class="badge bg-info">${e.condition_2 || '-'}</span></td>
                </tr>
            `)
        );
    }

    // Toggle Engine Positions Expansion
    function toggleEnginePositions(aircraftId) {
        const positions = document.getElementById(`positions-${aircraftId}`);
        const chevron = document.getElementById(`chevron-${aircraftId}`);
        
        if (!positions || !chevron) {
            console.error(`Elements not found for aircraft ${aircraftId}`);
            return;
        }
        
        if (positions.classList.contains('expanded')) {
            // Сворачиваем
            positions.classList.remove('expanded');
            chevron.classList.remove('bi-chevron-up');
            chevron.classList.add('bi-chevron-down');
        } else {
            // Разворачиваем
            positions.classList.add('expanded');
            chevron.classList.remove('bi-chevron-down');
            chevron.classList.add('bi-chevron-up');
        }
    }

    // === ENGINE DETAILS MODAL FUNCTIONS ===
    
    let currentSelectedEnginePos = null;
    let currentEngineData = null;

    // Open Engine Details Modal
    async function openEngineDetailsModal(aircraftId, tailNumber) {
        const modal = document.getElementById('engine-details-modal');
        const modalContent = document.getElementById('engine-modal-content');
        const modalAircraftName = document.getElementById('modal-aircraft-name');
        const modalAircraftInfo = document.getElementById('modal-aircraft-info');

        if (!modalAircraftName || !modal) {
            console.warn('Modal elements not found');
            return;
        }

        // Find aircraft in globalFleet
        let aircraft = (globalFleet || []).find(a => String(a.aircraft_id) === String(aircraftId) || a.tail_number === tailNumber);
        // Fallback: open modal even if not found
        if (!aircraft) {
            aircraft = {
                aircraft_id: aircraftId || 'N/A',
                tail_number: tailNumber || 'N/A',
                model: 'Boeing 747-200',
                total_time: 0,
                total_cycles: 0,
                positions: [null, null, null, null]
            };
        }

        // Set aircraft info
        modalAircraftName.textContent = aircraft.tail_number || 'Aircraft';
        modalAircraftName.style.cursor = 'pointer';
        
        // Add click handler for dropdown
        modalAircraftName.onclick = () => showAircraftDropdown();
        
        // Per requirements: fixed company and model display
        if (modalAircraftInfo) {
            modalAircraftInfo.textContent = `Boeing 747-200 • GSS`;
        }

        // Show modal
        modal.style.display = 'block';

        // Load latest borescope inspections
        let borescopeData = [];
        try {
            const cacheBust = (typeof noCache === 'function') ? noCache() : '';
            const res = await fetch(`/api/history/BORESCOPE${cacheBust}`);
            if (res.ok) {
                borescopeData = await res.json();
            }
        } catch (e) {
            console.warn('Failed to load borescope history:', e);
        }
        if (Array.isArray(borescopeData)) {
            borescopeData.forEach(b => {
                if (b.inspection_report && typeof b.inspection_report === 'string') {
                    try { b.inspection_report = JSON.parse(b.inspection_report); } catch { /* ignore */ }
                }
            });
        }

        // Prepare engine data from positions
        const positions = aircraft.positions || [null, null, null, null];
        const engines = positions.map((pos, index) => {
            if (!pos) {
                return {
                    position: `ENG ${index + 1}`,
                    engine_id: null,
                    original_sn: null,
                    current_sn: null,
                    gss_id: null,
                    supplier: null,
                    utilization: 'N/A',
                    install_date: 'N/A',
                    last_borescope: 'N/A',
                    borescope: null,
                    total_time: 0,
                    total_cycles: 0,
                    tsn_on_aircraft: 0,
                    csn_on_aircraft: 0
                };
            }
            
            return {
                position: `ENG ${index + 1}`,
                engine_id: pos.engine_id || null,
                original_sn: pos.original_sn || 'N/A',
                current_sn: pos.current_sn || pos.original_sn || 'N/A',
                gss_id: pos.gss_sn || 'N/A',
                supplier: pos.supplier || 'N/A',
                utilization: pos.tsn_on_aircraft ? `${pos.tsn_on_aircraft} hrs` : 'N/A',
                install_date: pos.install_date || 'N/A',
                last_borescope: 'N/A',
                borescope: null,
                total_time: pos.total_tsn || 0,
                total_cycles: pos.total_csn || 0,
                tsn_on_aircraft: pos.tsn_on_aircraft || 0,
                csn_on_aircraft: pos.csn_on_aircraft || 0,
                param_date: pos.param_date || 'N/A',
                n1_takeoff: pos.n1_takeoff,
                n1_cruise: pos.n1_cruise,
                n2_takeoff: pos.n2_takeoff,
                n2_cruise: pos.n2_cruise,
                egt_takeoff: pos.egt_takeoff,
                egt_cruise: pos.egt_cruise
            };
        });

        // Attach latest borescope per position
        if (Array.isArray(borescopeData) && borescopeData.length > 0) {
            engines.forEach((engine, index) => {
                if (!engine || !engine.current_sn) return;
                const posNum = index + 1;
                const serials = [engine.current_sn, engine.original_sn].map(s => (s || '').trim()).filter(Boolean);
                const latest = borescopeData
                    .filter(b => {
                        const bAircraft = (b.aircraft || '').trim();
                        const bPos = (b.position || '').toString().trim();
                        const bSn = (b.serial_number || '').trim();
                        return bAircraft === (aircraft.tail_number || '') &&
                               bPos === String(posNum) &&
                               serials.includes(bSn);
                    })
                    .sort((a, b) => new Date(b.date) - new Date(a.date))[0];
                if (latest) {
                    engine.last_borescope = latest.date || 'N/A';
                    engine.borescope = latest;
                }
            });
        }

        currentEngineData = { engines };
        renderEngineDetails(currentEngineData);
    }

    // Close Engine Details Modal
    function closeEngineDetailsModal() {
        const modal = document.getElementById('engine-details-modal');
        modal.style.display = 'none';
        currentSelectedEnginePos = null;
        currentEngineData = null;
    }

    // Show aircraft dropdown in modal
    function showAircraftDropdown() {
        const modalAircraftName = document.getElementById('modal-aircraft-name');
        if (!modalAircraftName) {
            console.warn('Aircraft name element not found');
            return;
        }
        
        let dropdown = document.getElementById('aircraft-dropdown');
        
        // Если dropdown уже есть, просто переключаем видимость
        if (dropdown) {
            dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
            return;
        }
        
        // Создаем dropdown
        dropdown = document.createElement('div');
        dropdown.id = 'aircraft-dropdown';
        dropdown.style.cssText = `
            position: absolute;
            top: 100%;
            left: 0;
            background: #1f2937;
            border: 1px solid #475569;
            border-radius: 8px;
            min-width: 200px;
            max-height: 300px;
            overflow-y: auto;
            z-index: 1001;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
            margin-top: 5px;
        `;
        
        // Добавляем самолеты в список
        const aircraftList = globalFleet || [];
        aircraftList.forEach(aircraft => {
            const option = document.createElement('div');
            option.style.cssText = `
                padding: 10px 15px;
                cursor: pointer;
                color: #cbd5e1;
                border-bottom: 1px solid #334155;
                transition: background 0.2s;
            `;
            option.textContent = aircraft.tail_number;
            option.onmouseover = () => option.style.background = '#334155';
            option.onmouseout = () => option.style.background = 'transparent';
            option.onclick = () => {
                // Переключаемся на выбранный самолет
                dropdown.style.display = 'none';
                openEngineDetailsModal(aircraft.aircraft_id, aircraft.tail_number);
            };
            dropdown.appendChild(option);
        });
        
        // Добавляем dropdown возле названия самолета
        const container = modalAircraftName.parentElement;
        if (container) {
            container.style.position = 'relative';
            container.appendChild(dropdown);
        }
    }

    // Render engine details (positions grid + parameters)
    function renderEngineDetails(data) {
        const modalContent = document.getElementById('engine-modal-content');
        
        if (!data || !data.engines || data.engines.length === 0) {
            modalContent.innerHTML = `
                <div class="engine-error">
                    <i class="bi bi-info-circle"></i>
                    <p>No engine data available</p>
                </div>
            `;
            return;
        }

        // Build positions grid (top row with clickable cards)
        let positionsHTML = '<div class="engine-positions-grid">';
        
        data.engines.forEach((engine, index) => {
            const isEmpty = !engine.original_sn && !engine.current_sn;
            const isSelected = index === (currentSelectedEnginePos || 0);
            
            positionsHTML += `
                <div class="engine-pos-card ${isEmpty ? 'empty' : ''} ${isSelected ? 'selected' : ''}" 
                     onclick="${isEmpty ? '' : `selectEnginePosition(${index})`}">
                    <div class="engine-pos-title">${engine.position || `ENG ${index + 1}`}</div>
                    ${isEmpty ? 
                        '<div class="engine-pos-empty-text">Empty Position</div>' :
                        `<div class="engine-pos-sn">SN: ${engine.current_sn || engine.original_sn}</div>`
                    }
                </div>
            `;
        });
        
        positionsHTML += '</div>';

        // Select first non-empty engine by default
        if (currentSelectedEnginePos === null) {
            currentSelectedEnginePos = data.engines.findIndex(e => e.original_sn || e.current_sn);
            if (currentSelectedEnginePos === -1) currentSelectedEnginePos = 0;
        }

        // Build action buttons bar (middle)
        let currentEngineId = data.engines[currentSelectedEnginePos]?.engine_id || null;
        let currentGSSId = data.engines[currentSelectedEnginePos]?.gss_id || 'N/A';
        const selectorHTML = `
            <div class="engine-selector-bar">
                <button class="engine-action-btn" onclick="showEngineSection('history', ${currentSelectedEnginePos})">
                    <i class="bi bi-clock-history"></i> Engine History
                </button>
                <button class="engine-action-btn" onclick="showEngineSection('analytics', ${currentSelectedEnginePos})">
                    <i class="bi bi-graph-up"></i> Analytics
                </button>
                <button class="engine-action-btn" onclick="sendEngineReport(${currentSelectedEnginePos})">
                    <i class="bi bi-envelope"></i> Send Email
                </button>
            </div>
        `;

        // Build three information panels (bottom)
        const e = data.engines[currentSelectedEnginePos] || {};
        const fmt = v => (v === null || v === undefined || v === '' ? 'N/A' : v);
        const fmtNum = (v, unit) => (v || v === 0) ? `${v} ${unit}` : 'N/A';
        const tsnAC = (e.tsn_on_aircraft !== undefined && e.tsn_on_aircraft !== null) ? `${e.tsn_on_aircraft} hrs` : 'N/A';
        const csnAC = (e.csn_on_aircraft !== undefined && e.csn_on_aircraft !== null) ? `${e.csn_on_aircraft} cyc` : 'N/A';

        const leftPanel = `
            <div class="engine-panel">
                <div class="panel-title">Engine Information</div>
                <div class="panel-row"><div class="row-label">Current SN</div><div class="row-value">${fmt(e.current_sn)}</div></div>
                <div class="panel-row"><div class="row-label">Original SN</div><div class="row-value">${fmt(e.original_sn)}</div></div>
                <div class="panel-row"><div class="row-label">GSS ID</div><div class="row-value">${fmt(e.gss_id)}</div></div>
                <div class="panel-row"><div class="row-label">Supplier</div><div class="row-value">${fmt(e.supplier)}</div></div>
                <div class="panel-row"><div class="row-label">Installed Date</div><div class="row-value">${fmt(e.install_date)}</div></div>
            </div>`;

        const centerPanel = `
            <div class="engine-panel">
                <div class="panel-title">Time & Cycles</div>
                <div class="panel-row"><div class="row-label">TSN (on A/C)</div><div class="row-value blue">${tsnAC}</div></div>
                <div class="panel-row"><div class="row-label">CSN (on A/C)</div><div class="row-value cyan">${csnAC}</div></div>
                <div class="panel-divider"></div>
                <div class="panel-title small">Last Borescope Inspection</div>
                <div class="panel-row"><div class="row-label">Date</div><div class="row-value">${fmt(e.last_borescope)}</div></div>
                <div class="panel-row"><div class="row-label">Report</div><div class="row-value">${e.borescope ? `<a href=\"#\" class=\"report-link\" onclick=\"loadBoroscopeReportData(document.getElementById('modal-aircraft-name').textContent, ${currentSelectedEnginePos + 1}); return false;\">View</a>` : '<span class="text-muted">N/A</span>'}</div></div>
            </div>`;

        const rightPanel = `
            <div class="engine-panel">
                <div class="panel-title">Engine Parameters</div>
                <div class="panel-row"><div class="row-label">N1 Takeoff</div><div class="row-value">${fmtNum(e.n1_takeoff, '%')}</div></div>
                <div class="panel-row"><div class="row-label">N1 Cruise</div><div class="row-value">${fmtNum(e.n1_cruise, '%')}</div></div>
                <div class="panel-row"><div class="row-label">N2 Takeoff</div><div class="row-value">${fmtNum(e.n2_takeoff, '%')}</div></div>
                <div class="panel-row"><div class="row-label">N2 Cruise</div><div class="row-value">${fmtNum(e.n2_cruise, '%')}</div></div>
                <div class="panel-row"><div class="row-label">EGT Takeoff</div><div class="row-value">${fmtNum(e.egt_takeoff, '°C')}</div></div>
                <div class="panel-row"><div class="row-label">EGT Cruise</div><div class="row-value">${fmtNum(e.egt_cruise, '°C')}</div></div>
                <div class="panel-divider"></div>
                <div class="panel-row"><div class="row-label">Last Updated</div><div class="row-value">${fmt(e.param_date)}</div></div>
            </div>`;

        const panelsHTML = `<div class="engine-info-sections engine-section active" id="details-section-${currentSelectedEnginePos}">${leftPanel}${centerPanel}${rightPanel}</div>`;

        // Engine History Section
        const historyHTML = `
            <div class="engine-section" id="history-section-${currentSelectedEnginePos}">
                <div class="engine-history-section">
                    <div style="text-align: center; padding: 20px; color: #94a3b8;">
                        <i class="bi bi-hourglass-split" style="font-size: 2rem; display: block; margin-bottom: 10px;"></i>
                        Loading history...
                    </div>
                </div>
            </div>
        `;

        // Analytics Section
        const analyticsHTML = `
            <div class="engine-section" id="analytics-section-${currentSelectedEnginePos}">
                <div class="analytics-section">
                    <div class="analytics-tabs">
                        <button class="tab-btn active" onclick="switchAnalyticsTab('n1', ${currentSelectedEnginePos})">N1 Graph</button>
                        <button class="tab-btn" onclick="switchAnalyticsTab('n2', ${currentSelectedEnginePos})">N2 Graph</button>
                        <button class="tab-btn" onclick="switchAnalyticsTab('egt', ${currentSelectedEnginePos})">EGT Graph</button>
                        <button class="tab-btn" onclick="switchAnalyticsTab('swaps', ${currentSelectedEnginePos})">Engine Swaps</button>
                    </div>
                    
                    <div id="n1-tab-${currentSelectedEnginePos}" class="tab-content active">
                        <div class="chart-filters">
                            <label class="filter-checkbox"><input type="checkbox" checked onchange="updateChart('n1', ${currentSelectedEnginePos})"> N1 Takeoff</label>
                            <label class="filter-checkbox"><input type="checkbox" checked onchange="updateChart('n1', ${currentSelectedEnginePos})"> N1 Cruise</label>
                        </div>
                        <div class="chart-container"><canvas id="n1-chart-${currentSelectedEnginePos}"></canvas></div>
                    </div>

                    <div id="n2-tab-${currentSelectedEnginePos}" class="tab-content">
                        <div class="chart-filters">
                            <label class="filter-checkbox"><input type="checkbox" checked onchange="updateChart('n2', ${currentSelectedEnginePos})"> N2 Takeoff</label>
                            <label class="filter-checkbox"><input type="checkbox" checked onchange="updateChart('n2', ${currentSelectedEnginePos})"> N2 Cruise</label>
                        </div>
                        <div class="chart-container"><canvas id="n2-chart-${currentSelectedEnginePos}"></canvas></div>
                    </div>

                    <div id="egt-tab-${currentSelectedEnginePos}" class="tab-content">
                        <div class="chart-filters">
                            <label class="filter-checkbox"><input type="checkbox" checked onchange="updateChart('egt', ${currentSelectedEnginePos})"> EGT Takeoff</label>
                            <label class="filter-checkbox"><input type="checkbox" checked onchange="updateChart('egt', ${currentSelectedEnginePos})"> EGT Cruise</label>
                        </div>
                        <div class="chart-container"><canvas id="egt-chart-${currentSelectedEnginePos}"></canvas></div>
                    </div>

                    <div id="swaps-tab-${currentSelectedEnginePos}" class="tab-content">
                        <div class="chart-container"><canvas id="swaps-chart-${currentSelectedEnginePos}"></canvas></div>
                        <p style="color: #cbd5e1; text-align: center; margin-top: 10px;">Engine replacements per position over time</p>
                    </div>
                </div>
            </div>
        `;

        // Combine and render
        modalContent.innerHTML = positionsHTML + selectorHTML + panelsHTML + historyHTML + analyticsHTML;
        
        // Load history data
        loadEngineHistory(currentSelectedEnginePos);
    }

    function openLatestBorescopeReport(enginePos) {
        if (!currentEngineData || !currentEngineData.engines || !currentEngineData.engines[enginePos]) return;
        const engine = currentEngineData.engines[enginePos];
        if (!engine.borescope) {
            showErrorNotification('No borescope report available for this engine');
            return;
        }

        const modal = document.getElementById('borescope-mini-modal');
        const title = document.getElementById('borescope-mini-title');
        const content = document.getElementById('borescope-mini-content');

        if (!modal || !title || !content) return;

        title.textContent = `Borescope Report • ${engine.position || ''}`;

        let inspectionReport = engine.borescope.inspection_report;
        if (typeof inspectionReport === 'string') {
            try { inspectionReport = JSON.parse(inspectionReport); } catch { inspectionReport = null; }
        }

        let photosHtml = '<div class="borescope-mini-photos">';
        const photos = inspectionReport && Array.isArray(inspectionReport.photos) ? inspectionReport.photos : [];
        if (photos.length > 0) {
            photos.forEach(photo => {
                photosHtml += `
                    <div class="borescope-mini-photo">
                        <div class="borescope-mini-label">${photo.label || 'Photo'}</div>
                        <div class="borescope-mini-imgs">
                            ${photo.photo1 ? `<img src="${photo.photo1}" onclick="openBorescopePhoto('${photo.photo1}');" />` : ''}
                            ${photo.photo2 ? `<img src="${photo.photo2}" onclick="openBorescopePhoto('${photo.photo2}');" />` : ''}
                        </div>
                    </div>
                `;
            });
        } else {
            photosHtml += '<div class="text-muted">No photos available</div>';
        }
        photosHtml += '</div>';

        content.innerHTML = `
            <div class="borescope-mini-meta">
                <div><strong>Date:</strong> ${engine.borescope.date || 'N/A'}</div>
                <div><strong>Inspector:</strong> ${engine.borescope.inspector || 'N/A'}</div>
                <div><strong>Work Type:</strong> ${engine.borescope.work_type || 'N/A'}</div>
                <div><strong>Comment:</strong> ${engine.borescope.comment || 'N/A'}</div>
            </div>
            ${photosHtml}
        `;

        modal.style.display = 'flex';
    }

    function closeLatestBorescopeReport() {
        const modal = document.getElementById('borescope-mini-modal');
        if (modal) modal.style.display = 'none';
    }


    // Select an engine position
    function selectEnginePosition(index) {
        if (!currentEngineData || !currentEngineData.engines[index]) return;
        
        currentSelectedEnginePos = index;
        renderEngineDetails(currentEngineData);
    }

    // Show engine section (History, Analytics) - Details всегда видна
    function showEngineSection(sectionType, enginePos) {
        // Toggle History и Analytics sections (Details всегда видна)
        const modal = document.getElementById('engine-modal-content');
        const historySection = document.getElementById(`history-section-${enginePos}`);
        const analyticsSection = document.getElementById(`analytics-section-${enginePos}`);
        const button = event.target.closest('.engine-action-btn');
        
        if (sectionType === 'history' && historySection) {
            // Toggle history section
            const isActive = historySection.classList.contains('active');
            if (isActive) {
                // Скрыть
                historySection.classList.remove('active');
                button?.classList.remove('active');
            } else {
                // Показать и скрыть analytics
                historySection.classList.add('active');
                if (analyticsSection) analyticsSection.classList.remove('active');
                button?.classList.add('active');
                // Убрать active с analytics кнопки
                const analyticsBtn = modal?.querySelector('[onclick*="showEngineSection(\'analytics\'"]');
                analyticsBtn?.classList.remove('active');
            }
        } else if (sectionType === 'analytics' && analyticsSection) {
            // Toggle analytics section
            const isActive = analyticsSection.classList.contains('active');
            if (isActive) {
                // Скрыть
                analyticsSection.classList.remove('active');
                button?.classList.remove('active');
            } else {
                // Показать и скрыть history
                analyticsSection.classList.add('active');
                if (historySection) historySection.classList.remove('active');
                button?.classList.add('active');
                // Убрать active с history кнопки
                const historyBtn = modal?.querySelector('[onclick*="showEngineSection(\'history\'"]');
                historyBtn?.classList.remove('active');
            }
        }
    }

    // Switch analytics tabs
    function switchAnalyticsTab(tabName, enginePos) {
        const modal = document.getElementById('engine-modal-content');
        
        // Hide all tabs
        modal.querySelectorAll(`#n1-tab-${enginePos}, #n2-tab-${enginePos}, #egt-tab-${enginePos}, #swaps-tab-${enginePos}`).forEach(t => {
            t.classList.remove('active');
        });
        
        // Update tab buttons
        modal.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        
        // Show selected tab
        const tabId = `${tabName}-tab-${enginePos}`;
        const tab = document.getElementById(tabId);
        if (tab) tab.classList.add('active');
        
        event.target.classList.add('active');
        
        // Initialize chart if not already done
        setTimeout(() => initializeChart(tabName, enginePos), 100);
    }

    // Load engine history from backend
    async function loadEngineHistory(enginePos) {
        try {
            const e = currentEngineData.engines[enginePos];
            const aircraftId = document.querySelector('[data-aircraft-id]')?.getAttribute('data-aircraft-id');
            
            if (!e.engine_id || !aircraftId) {
                console.warn('Missing engine ID or aircraft ID for history');
                return;
            }

            // For now, show placeholder
            const historySection = document.getElementById(`history-section-${enginePos}`);
            if (historySection) {
                historySection.innerHTML = `
                    <div class="engine-history-section">
                        <h4 style="color: #e2e8f0; margin-bottom: 16px;">Engine: ${e.current_sn} (GSS: ${e.gss_id})</h4>
                        <div class="history-item install">
                            <div class="history-date">2024-01-15</div>
                            <div class="history-action install">INSTALL</div>
                            <div class="history-detail">Installed on aircraft ER-BAQ, Position 1L<br>TT: 45,000 hrs | TC: 12,500 cyc</div>
                        </div>
                        <div class="history-item boroscope">
                            <div class="history-date">2024-06-15</div>
                            <div class="history-action">BOROSCOPE</div>
                            <div class="history-detail">Boroscope inspection completed - Status: OK</div>
                        </div>
                        <div class="history-item">
                            <div class="history-date">2024-07-20</div>
                            <div class="history-action">PARAMETER</div>
                            <div class="history-detail">ENG Parameters updated: N1: 92.5%, N2: 95.3%, EGT: 850°C</div>
                        </div>
                    </div>
                `;
            }
        } catch (err) {
            console.error('Error loading engine history:', err);
        }
    }

    // Initialize chart for analytics
    async function initializeChart(chartType, enginePos) {
        try {
            const e = currentEngineData.engines[enginePos];
            const aircraftCard = document.querySelector('[data-aircraft-id]');
            const aircraftId = aircraftCard?.getAttribute('data-aircraft-id');
            
            if (!e.engine_id || !aircraftId) {
                console.warn('Missing data for chart');
                return;
            }

            // Fetch parameters data - ВСЕ данные из истории
            const response = await fetch(`/api/aircraft/${aircraftId}/engines/${e.engine_id}/parameters-data?months=999`);
            if (!response.ok) throw new Error('Failed to load parameters');
            
            const data = await response.json();
            console.log(`Chart ${chartType} - Loaded ${data.parameters.length} data points`, data.parameters);
            
            const canvasId = `${chartType}-chart-${enginePos}`;
            const canvas = document.getElementById(canvasId);
            
            if (!canvas) {
                console.warn(`Canvas ${canvasId} not found`);
                return;
            }

            const ctx = canvas.getContext('2d');
            
            // Destroy existing chart if any
            if (window.engineCharts && window.engineCharts[canvasId]) {
                window.engineCharts[canvasId].destroy();
            }
            if (!window.engineCharts) window.engineCharts = {};

            let datasets = [];
            let labels = data.parameters.map(p => p.date);  // Даты как labels для категорий

            // Преобразуем данные используя простой формат для category scale
            if (chartType === 'n1') {
                datasets = [
                    { 
                        label: 'N1 Takeoff', 
                        data: data.parameters.map(p => p.n1_takeoff), 
                        borderColor: '#3b82f6', 
                        backgroundColor: 'transparent',
                        tension: 0.4,
                        fill: false,
                        pointRadius: 5,
                        pointHoverRadius: 7,
                        pointBackgroundColor: '#3b82f6',
                        pointBorderColor: '#ffffff',
                        pointBorderWidth: 2
                    },
                    { 
                        label: 'N1 Cruise', 
                        data: data.parameters.map(p => p.n1_cruise), 
                        borderColor: '#00d9ff', 
                        backgroundColor: 'transparent',
                        tension: 0.4,
                        fill: false,
                        pointRadius: 5,
                        pointHoverRadius: 7,
                        pointBackgroundColor: '#00d9ff',
                        pointBorderColor: '#ffffff',
                        pointBorderWidth: 2
                    }
                ];
            } else if (chartType === 'n2') {
                datasets = [
                    { 
                        label: 'N2 Takeoff', 
                        data: data.parameters.map(p => p.n2_takeoff), 
                        borderColor: '#10b981', 
                        backgroundColor: 'transparent',
                        tension: 0.4,
                        fill: false,
                        pointRadius: 5,
                        pointHoverRadius: 7,
                        pointBackgroundColor: '#10b981',
                        pointBorderColor: '#ffffff',
                        pointBorderWidth: 2
                    },
                    { 
                        label: 'N2 Cruise', 
                        data: data.parameters.map(p => p.n2_cruise), 
                        borderColor: '#86efac', 
                        backgroundColor: 'transparent',
                        tension: 0.4,
                        fill: false,
                        pointRadius: 5,
                        pointHoverRadius: 7,
                        pointBackgroundColor: '#86efac',
                        pointBorderColor: '#ffffff',
                        pointBorderWidth: 2
                    }
                ];
            } else if (chartType === 'egt') {
                datasets = [
                    { 
                        label: 'EGT Takeoff', 
                        data: data.parameters.map(p => p.egt_takeoff), 
                        borderColor: '#f59e0b', 
                        backgroundColor: 'transparent',
                        tension: 0.4,
                        fill: false,
                        pointRadius: 5,
                        pointHoverRadius: 7,
                        pointBackgroundColor: '#f59e0b',
                        pointBorderColor: '#ffffff',
                        pointBorderWidth: 2
                    },
                    { 
                        label: 'EGT Cruise', 
                        data: data.parameters.map(p => p.egt_cruise), 
                        borderColor: '#ef4444', 
                        backgroundColor: 'transparent',
                        tension: 0.4,
                        fill: false,
                        pointRadius: 5,
                        pointHoverRadius: 7,
                        pointBackgroundColor: '#ef4444',
                        pointBorderColor: '#ffffff',
                        pointBorderWidth: 2
                    }
                ];
            } else if (chartType === 'swaps') {
                labels = Object.keys(data.monthly_swaps || {});
                datasets = [{
                    label: 'Engine Replacements',
                    data: labels.map(m => data.monthly_swaps[m] || 0),
                    borderColor: '#a78bfa',
                    backgroundColor: 'rgba(167, 139, 250, 0.1)',
                    tension: 0.1
                }];
            }

            const chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: datasets.map(ds => ({
                        ...ds,
                        borderWidth: 2,
                        fill: false
                    }))
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        legend: {
                            display: true,
                            labels: { 
                                color: '#cbd5e1', 
                                font: { size: 12, weight: 'bold' },
                                padding: 15
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(15, 23, 42, 0.95)',
                            titleColor: '#e2e8f0',
                            bodyColor: '#cbd5e1',
                            borderColor: '#475569',
                            borderWidth: 1,
                            padding: 12,
                            displayColors: true,
                            callbacks: {
                                title: function(context) {
                                    return context[0].label;
                                },
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null && context.parsed.y !== undefined) {
                                        label += context.parsed.y.toFixed(1);
                                        if (chartType === 'egt') {
                                            label += '°C';
                                        } else if (chartType === 'n1' || chartType === 'n2') {
                                            label += '%';
                                        }
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            grace: '10%',
                            grid: { 
                                color: 'rgba(148, 163, 184, 0.1)',
                                drawBorder: true,
                                borderColor: '#475569'
                            },
                            ticks: { 
                                color: '#94a3b8',
                                font: { size: 11 },
                                callback: function(value) {
                                    if (chartType === 'egt') {
                                        return value + '°C';
                                    } else if (chartType === 'n1' || chartType === 'n2') {
                                        return value + '%';
                                    }
                                    return value;
                                }
                            },
                            title: {
                                display: true,
                                text: chartType === 'egt' ? 'Temperature (°C)' : 'Percentage (%)',
                                color: '#94a3b8',
                                font: { size: 12, weight: 'bold' }
                            }
                        },
                        x: {
                            type: 'category',
                            grid: { 
                                color: 'rgba(148, 163, 184, 0.05)',
                                drawBorder: true,
                                borderColor: '#475569'
                            },
                            ticks: { 
                                color: '#94a3b8',
                                font: { size: 10 },
                                maxRotation: 45,
                                minRotation: 0,
                                autoSkip: true,
                                maxTicksLimit: 12
                            },
                            title: {
                                display: true,
                                text: 'Date',
                                color: '#94a3b8',
                                font: { size: 12, weight: 'bold' }
                            }
                        }
                    }
                }
            });

            window.engineCharts[canvasId] = chart;
        } catch (err) {
            console.error('Error initializing chart:', err);
        }
    }

    // Update chart with filters
    function updateChart(chartType, enginePos) {
        console.log(`Update ${chartType} chart for engine ${enginePos}`);
    }

    // Send engine report via email
    async function sendEngineReport(enginePos) {
        try {
            const e = currentEngineData.engines[enginePos];
            const aircraftCard = document.querySelector('[data-aircraft-id]');
            const aircraftId = aircraftCard?.getAttribute('data-aircraft-id');
            
            if (!e.engine_id || !aircraftId) {
                alert('Missing data for report');
                return;
            }

            const recipientEmail = prompt(`Send engine report for ${e.current_sn} to email:\n\n(Enter recipient email address)`);
            if (!recipientEmail) return;

            // Validate email
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(recipientEmail)) {
                alert('Invalid email address');
                return;
            }

            // Show loading
            const btn = event.target;
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="bi bi-hourglass-split"></i> Sending...';
            btn.disabled = true;

            // Send report
            const response = await fetch(`/api/aircraft/${aircraftId}/engines/${e.engine_id}/send-report`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    recipient_email: recipientEmail,
                    subject: `Engine Report: ${e.current_sn}`,
                    aircraft_id: aircraftId,
                    engine_id: e.engine_id
                })
            });

            const result = await response.json();

            if (response.ok && result.status === 'success') {
                alert(`✅ ${result.message}`);
            } else {
                alert(`⚠️ ${result.message || 'Failed to send report'}`);
            }

            btn.innerHTML = originalText;
            btn.disabled = false;
        } catch (err) {
            console.error('Error sending report:', err);
            alert('Error sending report');
        }
    }

    // Close modal on ESC key
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
            closeEngineDetailsModal();
        }
    });

    // Close modal on background click
    document.addEventListener('click', (e) => {
        const modal = document.getElementById('engine-details-modal');
        if (e.target === modal) {
            closeEngineDetailsModal();
        }
    });

    // C. Open Aircraft Table (THE BIG ONE)
    async function openAircraftModal(tailNumber) {
        // Fetch fresh data from API instead of using stale globalFleet
        try {
            const res = await fetch(`/api/aircraft/${tailNumber}`);
            if (!res.ok) {
                showErrorNotification(`Failed to load aircraft data: ${res.status}`);
                return;
            }
            const ac = await res.json();
            
            // Columns requested: Date, Pos, Orig SN, GSS SN, Current SN, Loc From, TT, TC, N1 TO, N1 CR, N2 TO, N2 CR, Remarks
            const headers = [
                'Date', 'Pos', 'Orig SN', 'GSS SN', 'Current SN', 'Loc From', 
                'TT', 'TC', 'N1 TO', 'N1 CR', 'N2 TO', 'N2 CR', 'Remarks'
            ];

            // Build rows from positions data
            let rows = [];
            if (ac.positions && ac.positions.length > 0) {
                rows = ac.positions.map(pos => {
                    if (!pos) {
                        return `<tr><td colspan="13" class="text-center text-muted">No engine installed</td></tr>`;
                    }
                    return `
                        <tr>
                            <td>${pos.install_date}</td>
                            <td><strong>${pos.position}</strong></td>
                            <td>${pos.original_sn}</td>
                            <td>${pos.gss_sn}</td>
                            <td class="text-primary fw-bold">${pos.current_sn}</td>
                            <td>${pos.location || '-'}</td>
                            <td>${formatFlightTime(pos.total_tsn)}</td>
                            <td>${pos.total_csn}</td>
                            <td class="param-col">${pos.n1_takeoff !== null && pos.n1_takeoff !== undefined ? pos.n1_takeoff + '%' : '-'}</td>
                            <td class="param-col">${pos.n1_cruise !== null && pos.n1_cruise !== undefined ? pos.n1_cruise + '%' : '-'}</td>
                            <td class="param-col">${pos.n2_takeoff !== null && pos.n2_takeoff !== undefined ? pos.n2_takeoff + '%' : '-'}</td>
                            <td class="param-col">${pos.n2_cruise !== null && pos.n2_cruise !== undefined ? pos.n2_cruise + '%' : '-'}</td>
                            <td>-</td>
                        </tr>
                    `;
                });
            }

            if (rows.length === 0 || rows.every(r => r.includes('No engine installed'))) {
                rows = [`<tr><td colspan="13" class="text-center text-muted">No engines installed</td></tr>`];
            }

            setupModal(`Aircraft: ${tailNumber} (On Wing)`, headers, rows);
        } catch (err) {
            console.error('Error fetching aircraft modal data:', err);
            showErrorNotification(`Error loading aircraft data: ${err.message}`);
        }
    }

    // Helper to Show Modal
    function setupModal(title, headers, rowsHtml) {
        document.getElementById('modalTitle').innerText = title;
        
        // Set Headers
        const thead = document.getElementById('modalTableHead');
        thead.innerHTML = '<tr>' + headers.map(h => `<th>${h}</th>`).join('') + '</tr>';
        
        // Set Body
        const tbody = document.getElementById('modalTableBody');
        tbody.innerHTML = Array.isArray(rowsHtml) ? rowsHtml.join('') : rowsHtml;
        
        // Show
        const modal = new bootstrap.Modal(document.getElementById('dataModal'));
        modal.show();
    }

    // Export Modal Table to Excel
    function exportModalToExcel() {
        try {
            // Get modal title for filename
            const modalTitle = document.getElementById('modalTitle').innerText || 'export';
            const filename = modalTitle.replace(/[^a-zA-Z0-9]/g, '_') + '.xlsx';
            
            // Get table headers
            const thead = document.getElementById('modalTableHead');
            const tbody = document.getElementById('modalTableBody');
            
            if (!thead || !tbody) {
                alert('No data to export');
                return;
            }
            
            // Create workbook
            const wb = XLSX.utils.book_new();
            
            // Extract headers
            const headers = Array.from(thead.querySelectorAll('th')).map(th => th.textContent.trim());
            
            // Extract rows (clean HTML from badges/spans)
            const rows = Array.from(tbody.querySelectorAll('tr')).map(tr => {
                return Array.from(tr.querySelectorAll('td')).map(td => {
                    // Get text content, strip HTML tags
                    return td.textContent.trim();
                });
            });
            
            // Combine headers + rows
            const wsData = [headers, ...rows];
            
            // Create worksheet
            const ws = XLSX.utils.aoa_to_sheet(wsData);
            
            // Auto-size columns
            const colWidths = headers.map((h, i) => {
                const maxLen = Math.max(
                    h.length,
                    ...rows.map(r => (r[i] || '').toString().length)
                );
                return { wch: Math.min(maxLen + 2, 30) };
            });
            ws['!cols'] = colWidths;
            
            // Add worksheet to workbook
            XLSX.utils.book_append_sheet(wb, ws, 'Data');
            
            // Download file
            XLSX.writeFile(wb, filename);
            
            console.log('Excel exported:', filename);
        } catch (err) {
            console.error('Export error:', err);
            alert('Export failed: ' + err.message);
        }
    }

// --- INSTALLATION MODULE LOGIC ---

    // 1. Открытие раздела Installation (из меню Actions)
    async function openInstallView() {
        // Скрываем все экраны аккуратно через общий хелпер
        hideAllViews();
        document.getElementById('view-install').style.display = 'block';
        updateHistory('install');
        // Загружаем историю по умолчанию
        await loadInstallHistory();
    }

    // 2. Переключение вкладок (Вся информация / Ввести данные)
    function switchInstallTab(tabName) {
        if (tabName === 'info') {
            document.getElementById('tab-inst-info').style.display = 'block';
            document.getElementById('tab-inst-entry').style.display = 'none';
            document.getElementById('tab-inst-info-btn').classList.add('active');
            document.getElementById('tab-inst-entry-btn').classList.remove('active');
            loadInstallHistory(); // Обновляем таблицу
        } else {
            document.getElementById('tab-inst-info').style.display = 'none';
            document.getElementById('tab-inst-entry').style.display = 'block';
            document.getElementById('tab-inst-info-btn').classList.remove('active');
            document.getElementById('tab-inst-entry-btn').classList.add('active');
            prepareInstallForm(); // Загружаем список двигателей
        }
    }

    // 3. Загрузка Истории (Таблица)
    async function loadInstallHistory() {
        const tbody = document.getElementById('install-history-body');
        if (!tbody) return;
        tbody.innerHTML = '<tr><td colspan="17" class="text-center text-muted py-3">Loading…</td></tr>';

        let res = await safeFetch('/api/history/INSTALL' + window.noCache());
        if (!res || !res.ok) res = await safeFetch('/api/history/INSTALL');

        if (!res || !res.ok) {
            console.error('Error loading installation history', res && res.status);
            tbody.innerHTML = '<tr><td colspan="13" class="text-center text-danger py-3">Unable to load installations</td></tr>';
            return;
        }

        let serverData = [];
        try { serverData = await res.json(); } catch { serverData = []; }

        // Загружаем Remove actions для проверки
        let removeData = [];
        try {
            const removeRes = await safeFetch('/api/history/REMOVE' + window.noCache());
            if (removeRes && removeRes.ok) {
                removeData = await removeRes.json();
                console.log('Remove data loaded:', removeData);
            }
        } catch (e) {
            console.warn('Could not load remove history for marking', e);
        }

        tbody.innerHTML = '';
        if (!Array.isArray(serverData) || serverData.length === 0) {
            tbody.innerHTML = '<tr><td colspan="13" class="text-center text-muted">No installations found</td></tr>';
            return;
        }

        serverData.sort((a, b) => (b.id || 0) - (a.id || 0));
        serverData.forEach(row => {
            // Улучшенная логика зачеркивания с Fallback (Engine ID -> GSS ID -> Legacy)
            const wasRemoved = removeData.some(rem => {
                // 1. По дате: Снятие должно быть ПОЗЖЕ или в тот же день, что и Установка
                if (new Date(rem.date) < new Date(row.date)) return false;

                // 2. Идентификация двигателя:
                
                // A. Engine ID (Самый надежный - первичный ключ неизменен)
                if (row.engine_id && rem.engine_id) {
                    return row.engine_id == rem.engine_id;
                }
                
                // B. GSS ID (Если Engine ID нет - fallback)
                if (row.gss_id && rem.gss_id && 
                    row.gss_id !== '-' && rem.gss_id !== '-' &&
                    row.gss_id.trim() !== '' && rem.gss_id.trim() !== '') {
                    if (row.gss_id.trim() == rem.gss_id.trim()) return true;
                }

                // C. Legacy Match (fallback)
                const remSN = (rem.current_sn || rem.original_sn || '').trim();
                const installCurrentSN = (row.current_sn || '').trim();
                
                // "AC: ER-BAR (Pos 4)" -> "ER-BAR"
                // Также очищаем регистр и пробелы
                let remFrom = rem.from ? rem.from.replace(/^AC:\s*/i, '').replace(/\s*\(Pos\s+\d+\)/i, '').trim() : '';
                // Если remFrom пустой или '-', ставим пустую строку для унификации
                if (remFrom === '-') remFrom = '';

                // То же самое для install_to
                let installTo = row.install_to ? row.install_to.trim() : '';
                
                if (remSN.toUpperCase() === installCurrentSN.toUpperCase()) {
                    // Если самолет совпадает ИЛИ если в записи о снятии нет данных о самолете (пусто или '-')
                    if (remFrom.toUpperCase() === installTo.toUpperCase() || remFrom === '') {
                        return true;
                    }
                }
                
                return false;
            });
            
            // Стили для снятого двигателя
            const badgeClass = wasRemoved ? 'bg-secondary text-decoration-line-through opacity-50 text-white' : 'bg-primary text-white';
            
            tbody.innerHTML += `
                <tr data-log-id="${row.id || 0}" data-user="${row.user || row.created_by || ''}">
                    <td class="delete-col-install" style="display: none;">
                        <button class="btn btn-sm btn-danger" onclick="deleteHistoryRecord('INSTALL', ${row.id || 0}, '${row.original_sn}')" title="Delete">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                    <td>${row.date}</td>
                    <td>${row.original_sn}</td>
                    <td>${row.current_sn}</td>
                    <td><span class="badge ${badgeClass}" style="color: #ffffff !important;">${row.install_to}</span></td>
                    <td>${row.position}</td>
                    <td>${row.location_from}</td>
                    <td>${row.tt}</td>
                    <td>${row.tc}</td>
                    <td>${row.ac_ttsn ?? '-'}</td>
                    <td>${row.ac_tcsn ?? '-'}</td>
                    <td>${row.supplier || '-'}</td>
                    <td><small>${row.remarks||'-'}</small></td>
                </tr>
            `;
        });

        // Включаем редактирование по двойному клику: переводим таблицу в Edit и фокусируем ячейку
        bindPurchaseOrdersInlineEdit();
    }

    function bindPurchaseOrdersInlineEdit() {
        const tbody = document.getElementById('purchase-orders-history-body');
        if (!tbody) return;
        if (tbody._inlineEditBound) return; // уже привязано

        tbody.addEventListener('dblclick', (ev) => {
            const cell = ev.target.closest('td');
            if (!cell || !tbody.contains(cell)) return;
            // игнорируем колонку удаления и пустую последнюю ячейку с плюсом
            if (cell.classList.contains('delete-col-purchase-orders')) return;
            if (cell.style && cell.style.border === 'none' && cell.style.background === 'transparent') return;

            const row = cell.parentElement;
            const colIndex = Array.from(row.children).indexOf(cell);

            // Разрешаем работу только если уже включен режим Edit
            if (!isEditingActive('purchase-orders')) return; // Выходим, если режим редактирования не активен

            // Фокусируем соответствующий инпут в кликнутой ячейке
            const targetCell = row.children[colIndex];
            const input = targetCell.querySelector('input, select');
            if (input) {
                input.focus();
                if (typeof input.select === 'function') input.select();
            }
        });

        tbody._inlineEditBound = true;
    }

// ============ ШАГ 2-4: Функции для GSS ID и Engine datalists ============

// Глобальные обработчики для повторного подвешивания
let gssInputHandler = function() {
    if (window.installableEngines) {
        onGssInputChange(window.installableEngines);
    }
};

let engineInputHandler = function() {
    if (!window.installableEngines) return;
    const selectedEngine = window.installableEngines.find(e => e.original_sn === this.value);
    if (!selectedEngine) {
        showErrorNotification('Engine not found! Please select from the list of available engines.');
        this.value = '';
        document.getElementById('in-engine-id').value = '';
        document.getElementById('in-cur-sn').value = '';
    } else {
        // Проверяем, что двигатель уже INSTALLED - это недопустимо для Installation
        if (selectedEngine.status === 'INSTALLED') {
            const aircraftInfo = selectedEngine.aircraft ? ` on aircraft ${selectedEngine.aircraft}` : ' on some aircraft';
            showErrorNotification(`❌ Engine ${selectedEngine.original_sn} CANNOT be installed! This engine is already INSTALLED${aircraftInfo}. Please select a different engine or remove this one first.`);
            this.value = '';
            document.getElementById('in-engine-id').value = '';
            document.getElementById('in-cur-sn').value = '';
            return;
        }
        // Проверяем пригодность по condition_1 (SV / US / SCRAPED)
        if (selectedEngine.condition_1 !== 'SV') {
            showErrorNotification(`❌ Engine ${selectedEngine.original_sn} cannot be installed! condition_1 is ${selectedEngine.condition_1}, must be SV (Serviceable).`);
            this.value = '';
            document.getElementById('in-engine-id').value = '';
            document.getElementById('in-cur-sn').value = '';
            return;
        }
        // Если GSS пусто и у двигателя есть GSS - автозаполняем
        const gssField = document.getElementById('in-gss-input');
        if (!gssField.value.trim() && selectedEngine.gss_sn) {
            gssField.value = selectedEngine.gss_sn;
        }
        document.getElementById('in-engine-id').value = selectedEngine.id;
        // Current SN не заполняем автоматически - только ручной ввод!
    }
};

// ШАГ 2: Заполнить datalist с GSS ID
function loadGSSDatalist(engines) {
    const gssMap = new Map(); // Уникальные GSS ID с их двигателями
    const gssOptions = document.getElementById('gss-options');
    gssOptions.innerHTML = '';
    
    engines.forEach(eng => {
        if (eng.gss_sn) {
            if (!gssMap.has(eng.gss_sn)) {
                gssMap.set(eng.gss_sn, eng); // Берем первый двигатель с этим GSS
            }
        }
    });
    
    Array.from(gssMap.entries()).sort().forEach(([gssId, eng]) => {
        const option = document.createElement('option');
        option.value = gssId;
        // Формат: "GSS: ID | Orig: SN | Current: SN"
        const display = `GSS: ${gssId} | Orig: ${eng.original_sn} | Current: ${eng.current_sn || 'N/A'}`;
        option.text = display;
        gssOptions.appendChild(option);
    });
}

// ШАГ 3: Заполнить datalist с Engine (с опциональной фильтрацией по GSS)
function loadEngineDatalist(engines, filterGss = null) {
    const engineOptions = document.getElementById('engine-options');
    engineOptions.innerHTML = '';
    
    let filtered = engines;
    if (filterGss) {
        filtered = engines.filter(e => e.gss_sn === filterGss);
    }
    
    filtered.forEach(eng => {
        const option = document.createElement('option');
        option.value = eng.original_sn;
        // Формат: "Orig: SN | GSS: ID | Current: SN"
        const display = `Orig: ${eng.original_sn} | GSS: ${eng.gss_sn || 'N/A'} | Current: ${eng.current_sn || 'N/A'}`;
        option.text = display;
        engineOptions.appendChild(option);
    });
}

// ШАГ 4: Обработчик для поля GSS ID (фильтрует Engine, автозаполняет если одно совпадение)
function onGssInputChange(engines) {
    const gssValue = document.getElementById('in-gss-input').value.trim();
    if (!gssValue) {
        // Если GSS пусто - показываем все двигатели
        loadEngineDatalist(engines, null);
        return;
    }
    
    // Фильтруем двигатели по GSS ID
    const matchingEngines = engines.filter(e => e.gss_sn === gssValue);
    
    if (matchingEngines.length === 0) {
        loadEngineDatalist(engines, null);
    } else if (matchingEngines.length === 1) {
        // Если один двигатель - автозаполняем поле Engine
        loadEngineDatalist(engines, gssValue);
        const singleEngine = matchingEngines[0];
        document.getElementById('in-engine-input').value = singleEngine.original_sn;
        document.getElementById('in-engine-id').value = singleEngine.id;
    } else {
        // Если несколько - показываем отфильтрованные
        loadEngineDatalist(engines, gssValue);
    }
}

    // 5. Отправка формы (Save)
// 4. Подготовка формы (Загрузка SV двигателей)
    async function prepareInstallForm() {
        // Всегда грузим свежие данные без кеша, чтобы список был актуальным
        let res = await safeFetch('/api/engines' + window.noCache());
        
        let allEngines = [];
        try { allEngines = res && res.ok ? await res.json() : []; } catch { allEngines = []; }
        const deletedIds = getDeletedEngineIds();
        
        // Загружаем ВСЕ двигатели (кроме удаленных)
        allEngines = Array.isArray(allEngines)
            ? allEngines.filter(e => !deletedIds.includes(e.id))
            : [];
        
        // Отбираем только пригодные для установки двигатели:
        // condition_1 === 'SV' И status !== 'INSTALLED' И status !== 'SCRAPED'
        const installableEngines = allEngines.filter(e => 
            e.condition_1 === 'SV' && 
            e.status !== 'INSTALLED' && 
            e.status !== 'SCRAPED'
        );
        
        window.installableEngines = installableEngines; // Сохраняем в глобальную переменную
        
        // ШАГ 2: Загружаем GSS datalist из пригодных двигателей
        loadGSSDatalist(installableEngines);
        
        // ШАГ 3: Загружаем Engine datalist только из пригодных двигателей
        loadEngineDatalist(installableEngines, null);
        
        // ШАГ 4: Подвешиваем обработчик для GSS ID (используем глобальный обработчик)
        const gssInput = document.getElementById('in-gss-input');
        gssInput.removeEventListener('input', gssInputHandler);
        gssInput.addEventListener('input', gssInputHandler);
        
        // ШАГ 5: Подвешиваем обработчик для Engine (используем глобальный обработчик)
        const engineInput = document.getElementById('in-engine-input');
        engineInput.removeEventListener('change', engineInputHandler);
        engineInput.addEventListener('change', engineInputHandler);
    }
    // Guard flag to prevent double-submit
    let _installSubmitting = false;
    // 5. Отправка формы (Save)
    // === FLIGHT TIME FORMAT CONVERSION FUNCTIONS ===
    // Converts HH:MM format to decimal hours (e.g., "103999:34" -> 103999.567)
    function parseFlightTime(input) {
        if (!input || input === '') return null;
        
        const str = String(input).trim();
        
        // Check if input contains colon (HH:MM format)
        if (str.includes(':')) {
            const parts = str.split(':');
            if (parts.length !== 2) {
                throw new Error(`Invalid time format: ${input}. Use HH:MM or decimal`);
            }
            
            const hours = parseFloat(parts[0]);
            const minutes = parseFloat(parts[1]);
            
            if (isNaN(hours) || isNaN(minutes)) {
                throw new Error(`Invalid time format: ${input}. Hours and minutes must be numbers`);
            }
            
            if (minutes < 0 || minutes >= 60) {
                throw new Error(`Invalid minutes: ${minutes}. Must be 0-59`);
            }
            
            // Convert to decimal: hours + (minutes / 60)
            return hours + (minutes / 60);
        }
        
        // Otherwise treat as decimal number
        const decimal = parseFloat(str);
        if (isNaN(decimal)) {
            throw new Error(`Invalid number: ${input}`);
        }
        
        return decimal;
    }
    
    // Converts decimal hours to HH:MM format (e.g., 103999.567 -> "103999:34")
    function formatFlightTime(decimalHours) {
        if (decimalHours === null || decimalHours === undefined) return '';
        
        const hours = Math.floor(decimalHours);
        const minutes = Math.round((decimalHours - hours) * 60);
        
        return `${hours}:${String(minutes).padStart(2, '0')}`;
    }

    async function submitInstallForm() {
        if (_installSubmitting) { return; }
        
        const date = document.getElementById('in-date').value;
        const gssInputVal = document.getElementById('in-gss-input').value.trim();
        const engInputVal = document.getElementById('in-engine-input').value;
        const engId = document.getElementById('in-engine-id').value;
        const acId = document.getElementById('in-ac').value;
        const acText = document.getElementById('in-ac').options[document.getElementById('in-ac').selectedIndex]?.text;
        
        // Валидация обязательных полей ДО установки флага
        if(!date || !acId || document.getElementById('in-tt').value === "" || document.getElementById('in-tc').value === "") { 
            showErrorNotification("Please fill in all required fields (*)");
            return; 
        }
        
        // ✓ Проверка что GSS ID заполнен (обязательное поле)
        if(!gssInputVal) {
            showErrorNotification("GSS ID is required. Please select a GSS ID from the list.");
            return;
        }
        
        // ✓ Проверка что двигатель выбран из списка
        if(!engId || engId === '0' || engId === '' || !engInputVal) {
            showErrorNotification("Engine is required. Please select an engine from the list.");
            return;
        }
        
        // Проверка что выбранный двигатель есть в списке доступных
        const selectedEngine = window.installableEngines.find(e => e.id === parseInt(engId));
        if (!selectedEngine) {
            showErrorNotification("Selected engine not found in available engines list!");
            return;
        }
        
        // ✓ Проверка что двигатель не INSTALLED
        if (selectedEngine.status === 'INSTALLED') {
            const aircraftInfo = selectedEngine.aircraft ? ` on aircraft ${selectedEngine.aircraft}` : '';
            showErrorNotification(`❌ Engine ${selectedEngine.original_sn} cannot be installed! This engine is already INSTALLED${aircraftInfo}.`);
            return;
        }
        
        // ✓ Проверка пригодности двигателя по condition_1 (только SV)
        if (selectedEngine.condition_1 !== 'SV') {
            showErrorNotification(`❌ Engine ${selectedEngine.original_sn} cannot be installed! condition_1 is ${selectedEngine.condition_1}, must be SV (Serviceable).`);
            return;
        }
        
        // ✓ Мягкая проверка соответствия GSS ↔ Engine (предупреждение, не блокировка)
        if (selectedEngine.gss_sn && selectedEngine.gss_sn !== gssInputVal) {
            console.warn(`⚠️ WARNING: Selected GSS (${gssInputVal}) does not match engine GSS (${selectedEngine.gss_sn}). This is allowed but unusual.`);
        }
        
        // ВСЕ ПРОВЕРКИ ПРОЙДЕНЫ - устанавливаем флаг и показываем загрузку
        _installSubmitting = true;
        const saveBtn = document.querySelector('#tab-inst-entry .btn.btn-success');
        if (saveBtn) { saveBtn.disabled = true; saveBtn.dataset._orig = saveBtn.innerHTML; saveBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Saving...'; }
        
        // Parse flight time inputs (support HH:MM and decimal formats)
        let ttValue, acTtsnValue;
        try {
            ttValue = parseFlightTime(document.getElementById('in-tt').value);
            const acTtsnInput = document.getElementById('in-ac-ttsn').value;
            acTtsnValue = acTtsnInput !== '' ? parseFlightTime(acTtsnInput) : null;
        } catch (e) {
            showErrorNotification(e.message);
            _installSubmitting = false;
            if (saveBtn) { saveBtn.disabled = false; saveBtn.innerHTML = saveBtn.dataset._orig || 'Save Record'; }
            return;
        }
        
        const payload = {
            date: date, 
            engine_id: parseInt(engId),
            aircraft_id: parseInt(acId),
            position: parseInt(document.getElementById('in-pos').value),
            tt: ttValue,
            tc: parseInt(document.getElementById('in-tc').value),
            ac_ttsn: acTtsnValue,
            ac_tcsn: document.getElementById('in-ac-tcsn').value !== '' ? parseInt(document.getElementById('in-ac-tcsn').value, 10) : null,
            remarks: document.getElementById('in-rem').value,
            supplier: document.getElementById('in-supplier').value || null,
            current_sn: document.getElementById('in-cur-sn').value || null
        };
        
        try {
            const res = await fetch('/api/actions/install', { 
                method: 'POST', 
                headers: {'Content-Type': 'application/json'}, 
                body: JSON.stringify(payload)
            });
            
            const result = await handleApiResponse(res, 'Installation');
            if (!result) return; // Операция не выполнена (warning)

            // Очистка формы
            document.getElementById('form-install').reset(); 
            
            // Переключение на вкладку истории
            document.getElementById('tab-inst-info').style.display = 'block';
            document.getElementById('tab-inst-entry').style.display = 'none';
            document.getElementById('tab-inst-info-btn').classList.add('active');
            document.getElementById('tab-inst-entry-btn').classList.remove('active');

            // Обновляем таблицу с сервера
            await loadInstallHistory();
            
            // Обновляем Dashboard карточки (важно для отражения новых установок)
            if (typeof loadDashboardData === 'function') {
                await loadDashboardData();
            }
            
            // Обновляем главную таблицу двигателей (Master Engine List) чтобы показать правильные статусы
            if (typeof loadMainTable === 'function') {
                await loadMainTable();
            }
            
            // Обновляем Recent Actions
            refreshAfterDataChange();
            
        } catch(e) { 
            showErrorNotification("Error: " + e.message);
        } finally {
            _installSubmitting = false;
            if (saveBtn) { saveBtn.disabled = false; saveBtn.innerHTML = saveBtn.dataset._orig || 'Save Record'; }
        }
    }
        // ------------------------------------------------------------------------------------

// --- SIDEBAR MENU TOGGLES ---
    function toggleReportsMenu(forceState) {
        const submenu = document.getElementById('reports-submenu');
        const chevron = document.getElementById('reports-chevron');
        if (!submenu || !chevron) {
            return;
        }

        const isCurrentlyHidden = submenu.style.display === 'none' || submenu.style.display === '';
        const shouldOpen = typeof forceState === 'boolean' ? forceState : isCurrentlyHidden;

        if (shouldOpen) {
            submenu.style.display = 'block';
            chevron.classList.remove('bi-chevron-right');
            chevron.classList.add('bi-chevron-down');
        } else {
            submenu.style.display = 'none';
            chevron.classList.remove('bi-chevron-down');
            chevron.classList.add('bi-chevron-right');
        }
        localStorage.setItem('reports-menu-open', shouldOpen ? 'true' : 'false');
    }

    function toggleActionsMenu(forceState) {
        const submenu = document.getElementById('actions-submenu');
        const chevron = document.getElementById('actions-chevron');
        if (!submenu || !chevron) {
            return;
        }

        const isCurrentlyHidden = submenu.style.display === 'none';
        const shouldOpen = typeof forceState === 'boolean' ? forceState : isCurrentlyHidden;

        if (shouldOpen) {
            submenu.style.display = 'block';
            chevron.classList.remove('bi-chevron-right');
            chevron.classList.add('bi-chevron-down');
        } else {
            submenu.style.display = 'none';
            chevron.classList.remove('bi-chevron-down');
            chevron.classList.add('bi-chevron-right');
        }
        localStorage.setItem('actions-menu-open', shouldOpen ? 'true' : 'false');
    }

    function toggleLogisticsMenu(forceState) {
        const submenu = document.getElementById('logistics-submenu');
        const chevron = document.getElementById('logistics-chevron');
        if (!submenu || !chevron) {
            return;
        }

        const isCurrentlyHidden = submenu.style.display === 'none' || submenu.style.display === '';
        const shouldOpen = typeof forceState === 'boolean' ? forceState : isCurrentlyHidden;

        if (shouldOpen) {
            submenu.style.display = 'block';
            chevron.classList.remove('bi-chevron-right');
            chevron.classList.add('bi-chevron-down');
        } else {
            submenu.style.display = 'none';
            chevron.classList.remove('bi-chevron-down');
            chevron.classList.add('bi-chevron-right');
        }
        localStorage.setItem('logistics-menu-open', shouldOpen ? 'true' : 'false');
    }

    async function openShipmentView() {
        // ИСПРАВЛЕНИЕ: Используем hideAllViews(), чтобы корректно скрыть всё лишнее
        hideAllViews();
        
        document.getElementById('view-shipment').style.display = 'block';
        updateHistory('shipment');
        await loadShipmentHistory();
    }

// --- BORESCOPE MODULE LOGIC ---

    async function openBoroscopeView() {
        hideAllViews();
        document.getElementById('view-borescope').style.display = 'block';
        updateHistory('borescope');
        await loadBoroscopeHistory();
    }

// --- ENGINE REPORTS MODULE LOGIC ---
    async function openEngineReportsView() {
        hideAllViews();
        document.getElementById('view-engine-reports').style.display = 'block';
        updateHistory('engine-reports');
        await loadEngineReportsList();
    }

    async function loadEngineReportsList() {
        const tbody = document.getElementById('engine-reports-body');
        if (!tbody) return;
        tbody.innerHTML = '<tr><td colspan="10" class="text-center text-muted py-3">Loading engines...</td></tr>';

        let res = await safeFetch('/api/engines' + window.noCache());
        if (!res || !res.ok) res = await safeFetch('/api/engines');

        if (!res || !res.ok) {
            tbody.innerHTML = '<tr><td colspan="10" class="text-center text-danger py-3">Unable to load engines</td></tr>';
            return;
        }

        let engines = [];
        try { engines = await res.json(); } catch { engines = []; }

        if (!Array.isArray(engines) || engines.length === 0) {
            tbody.innerHTML = '<tr><td colspan="10" class="text-center text-muted">No engines found</td></tr>';
            return;
        }

        engines.sort((a, b) => (b.id || 0) - (a.id || 0));
        tbody.innerHTML = '';
        engines.forEach((eng, idx) => {
            const statusClass = {
                'SV': 'success',
                'INSTALLED': 'primary',
                'USV': 'warning',
                'REPAIR': 'danger',
                'SCRAP': 'dark'
            }[eng.status] || 'secondary';

            tbody.innerHTML += `
                <tr style="cursor: pointer;" onclick="showEngineHistoryTimeline(${eng.id}, '${eng.original_sn}')">
                    <td>${idx + 1}</td>
                    <td><strong>${eng.original_sn}</strong></td>
                    <td>${eng.current_sn}</td>
                    <td>${eng.gss_sn || '-'}</td>
                    <td><span class="badge bg-${statusClass}">${eng.status}</span></td>
                    <td>${eng.aircraft || '-'}</td>
                    <td>${eng.location}</td>
                    <td>${eng.tt || 0}</td>
                    <td>${eng.tc || 0}</td>
                    <td>
                        <button class="btn btn-sm btn-info" onclick="event.stopPropagation(); showEngineHistoryTimeline(${eng.id}, '${eng.original_sn}')">
                            <i class="bi bi-clock-history"></i> View Timeline
                        </button>
                    </td>
                </tr>
            `;
        });
    }

    async function showEngineHistoryTimeline(engineId, serialNumber) {
        const modal = new bootstrap.Modal(document.getElementById('engineHistoryModal'));
        const modalBody = document.getElementById('engineHistoryBody');
        
        modalBody.innerHTML = `
            <div class="text-center py-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="text-muted mt-3">Loading full history for engine ${serialNumber}...</p>
            </div>
        `;
        
        modal.show();

        // Параллельно загружаем данные двигателя и его историю
        let engineRes = await safeFetch(`/api/engines/${engineId}` + window.noCache());
        let historyRes = await safeFetch(`/api/engines/${engineId}/history` + window.noCache());
        if (!engineRes || !engineRes.ok || !historyRes || !historyRes.ok) {
            modalBody.innerHTML = `
                <div class="timeline-no-data">
                    <i class="bi bi-exclamation-triangle text-warning" style="font-size: 3rem;"></i>
                    <p class="mt-3">Unable to load engine history. Please try again.</p>
                </div>
            `;
            return;
        }

        let engine = {};
        let history = [];
        try {
            engine = await engineRes.json();
            history = await historyRes.json();
            console.log('🔍 Engine data:', engine);
            console.log('🔍 Engine history items:', history.length, 'events');
            if (history.length > 0) console.log('🔍 First event:', history[0]);
        } catch {
            engine = {};
            history = [];
            console.error('❌ Error parsing engine/history JSON');
        }

        if (!Array.isArray(history) || history.length === 0) {
            modalBody.innerHTML = `
                <div class="timeline-header">
                    <h5>Engine ${serialNumber} - ${engine.current_sn || 'N/A'}</h5>
                    <div class="engine-meta">
                        <span><i class="bi bi-speedometer2"></i> TT: ${engine.tt || 0} hrs</span>
                        <span><i class="bi bi-arrow-repeat"></i> TC: ${engine.tc || 0} cycles</span>
                        <span><i class="bi bi-geo-alt"></i> ${engine.location || 'Unknown'}</span>
                    </div>
                </div>
                <div class="timeline-no-data">
                    <i class="bi bi-inbox text-muted" style="font-size: 3rem;"></i>
                    <p class="mt-3">No history records found for this engine.</p>
                </div>
            `;
            return;
        }

        // Сортируем историю по дате хронологически (старые события внизу, новые вверху в виде восходящей шкалы)
        history.sort((a, b) => new Date(a.date) - new Date(b.date));

        // Группируем по типу действия для иконок
        const actionIcons = {
            'INSTALL': '<i class="bi bi-arrow-up-circle"></i>',
            'REMOVE': '<i class="bi bi-arrow-down-circle"></i>',
            'REPAIR': '<i class="bi bi-wrench"></i>',
            'SHIP': '<i class="bi bi-truck"></i>',
            'PART': '<i class="bi bi-puzzle"></i>',
            'PART_ACTION': '<i class="bi bi-puzzle"></i>',
            'PART_INSTALLED': '<i class="bi bi-puzzle-fill"></i>',
            'ATLB': '<i class="bi bi-airplane"></i>',
            'FLIGHT': '<i class="bi bi-airplane"></i>',
            'INSPECT': '<i class="bi bi-eyeglass"></i>',
            'ENG_PARAM': '<i class="bi bi-gear"></i>',
            'UTIL_PARAM': '<i class="bi bi-bar-chart"></i>'
        };

        const actionLabels = {
            'INSTALL': 'Installation',
            'REMOVE': 'Removal',
            'REPAIR': 'Repair',
            'SHIP': 'Shipment',
            'PART': 'Part Installed',
            'PART_ACTION': 'Part Action',
            'PART_INSTALLED': 'Part Installed on Engine',
            'ATLB': 'Flight Log (ATLB)',
            'FLIGHT': 'Flight Log',
            'INSPECT': 'Engine Inspection/Created',
            'ENG_PARAM': 'Engine Parameters Update',
            'UTIL_PARAM': 'Utilization Update'
        };

        const actionClasses = {
            'INSTALL': 'install',
            'REMOVE': 'remove',
            'REPAIR': 'repair',
            'SHIP': 'ship',
            'PART': 'part',
            'PART_ACTION': 'part',
            'PART_INSTALLED': 'part',
            'ATLB': 'atlb',
            'FLIGHT': 'atlb',
            'INSPECT': 'inspect',
            'ENG_PARAM': 'param',
            'UTIL_PARAM': 'param'
        };

        let timelineHTML = `
            <div class="timeline-container">
                <div class="timeline-header">
                    <h5>Full History Timeline - Engine ${serialNumber}</h5>
                    <div class="engine-meta">
                        <span><i class="bi bi-card-text"></i> Current S/N: ${engine.current_sn || 'N/A'}</span>
                        <span><i class="bi bi-speedometer2"></i> Total Time: ${engine.tt || 0} hrs</span>
                        <span><i class="bi bi-arrow-repeat"></i> Total Cycles: ${engine.tc || 0}</span>
                        <span><i class="bi bi-geo-alt"></i> Location: ${engine.location || 'Unknown'}</span>
                        <span><i class="bi bi-tag"></i> Status: <span class="badge bg-info">${engine.status || 'N/A'}</span></span>
                    </div>
                </div>
                <div style="position: relative;">
                    <div class="timeline-line"></div>
        `;

        history.forEach((event, idx) => {
            const actionType = event.action_type || 'UNKNOWN';
            const icon = actionIcons[actionType] || '<i class="bi bi-question-circle"></i>';
            const label = actionLabels[actionType] || actionType;
            const cssClass = actionClasses[actionType] || 'param';
            
            let detailsHTML = '';
            if (actionType === 'INSTALL') {
                detailsHTML = `
                    <div class="timeline-details">
                        <strong>Aircraft:</strong> ${event.install_to || 'N/A'}<br>
                        <strong>Position:</strong> ${event.position || 'N/A'}<br>
                        <strong>Location From:</strong> ${event.location_from || 'N/A'}<br>
                        <strong>TT at Install:</strong> ${event.tt || 0} hrs | <strong>TC:</strong> ${event.tc || 0}
                        ${event.remarks ? `<br><strong>Remarks:</strong> ${event.remarks}` : ''}
                    </div>
                `;
            } else if (actionType === 'REMOVE') {
                detailsHTML = `
                    <div class="timeline-details">
                        <strong>From Aircraft:</strong> ${event.aircraft || 'N/A'}<br>
                        <strong>Destination:</strong> ${event.destination || 'N/A'}<br>
                        <strong>TT at Removal:</strong> ${event.tt || 0} hrs | <strong>TC:</strong> ${event.tc || 0}
                        ${event.remarks ? `<br><strong>Remarks:</strong> ${event.remarks}` : ''}
                    </div>
                `;
            } else if (actionType === 'REPAIR') {
                detailsHTML = `
                    <div class="timeline-details">
                        <strong>Station:</strong> ${event.station || 'N/A'}<br>
                        <strong>Defect:</strong> ${event.defect || 'N/A'}<br>
                        <strong>Correction:</strong> ${event.correction || 'N/A'}
                        ${event.remarks ? `<br><strong>Remarks:</strong> ${event.remarks}` : ''}
                    </div>
                `;
            } else if (actionType === 'PART' || actionType === 'PART_INSTALLED') {
                detailsHTML = `
                    <div class="timeline-details">
                        <strong>Part Number:</strong> ${event.part_number || 'N/A'}<br>
                        <strong>Part Name:</strong> ${event.part_name || 'N/A'}<br>
                        <strong>S/N:</strong> ${event.part_sn || 'N/A'}
                        ${event.remarks ? `<br><strong>Remarks:</strong> ${event.remarks}` : ''}
                    </div>
                `;
            } else if (actionType === 'ATLB' || actionType === 'FLIGHT') {
                detailsHTML = `
                    <div class="timeline-details">
                        <strong>Aircraft:</strong> ${event.aircraft || 'N/A'}<br>
                        <strong>Flight Hours:</strong> ${event.flight_hours || 0}<br>
                        <strong>Cycles:</strong> ${event.cycles || 0}
                        ${event.remarks ? `<br><strong>Remarks:</strong> ${event.remarks}` : ''}
                    </div>
                `;
            } else if (actionType === 'SHIP') {
                detailsHTML = `
                    <div class="timeline-details">
                        <strong>From Location:</strong> ${event.aircraft || 'N/A'}<br>
                        <strong>To Location:</strong> ${event.destination || 'N/A'}<br>
                        ${event.remarks ? `<strong>Waybill/Details:</strong> ${event.remarks}` : ''}
                    </div>
                `;
            } else if (actionType === 'INSPECT') {
                detailsHTML = `
                    <div class="timeline-details">
                        <strong>Location:</strong> ${event.destination || 'N/A'}<br>
                        <strong>TT:</strong> ${event.tt || 0} hrs | <strong>TC:</strong> ${event.tc || 0}
                        ${event.remarks ? `<br><strong>Details:</strong> ${event.remarks}` : ''}
                    </div>
                `;
            } else if (actionType === 'PART_ACTION') {
                detailsHTML = `
                    <div class="timeline-details">
                        <strong>Action:</strong> ${event.aircraft || 'N/A'}<br>
                        <strong>Part Name:</strong> ${event.destination || 'N/A'}<br>
                        ${event.remarks ? `<strong>Details:</strong> ${event.remarks}` : ''}
                    </div>
                `;
            } else {
                detailsHTML = `
                    <div class="timeline-details">
                        ${event.remarks ? `<strong>Details:</strong> ${event.remarks}` : '<em>No additional details</em>'}
                    </div>
                `;
            }

            timelineHTML += `
                <div class="timeline-event">
                    <div class="timeline-date">${event.date || 'Unknown date'}</div>
                    <div class="timeline-icon ${cssClass}">${icon}</div>
                    <div class="timeline-content" onclick="navigateToTableFromTimeline('${actionType}', '${serialNumber}')" title="Click to view ${label} table">
                        <h6>${label} <span class="badge bg-secondary">#${idx + 1}</span></h6>
                        ${detailsHTML}
                    </div>
                </div>
            `;
        });

        timelineHTML += `
                </div>
            </div>
        `;

        modalBody.innerHTML = timelineHTML;
    }

    // Функция для открытия таблицы в модальном окне поверх истории
    async function navigateToTableFromTimeline(actionType, serialFilter) {
        const modal = new bootstrap.Modal(document.getElementById('tablePreviewModal'), { backdrop: true, keyboard: true, focus: true });
        const modalBody = document.getElementById('tablePreviewBody');
        const modalTitle = document.getElementById('tablePreviewTitle');
        const modalHeader = document.getElementById('tablePreviewHeader');

        // Настройка заголовка и стиля в зависимости от типа
        const typeConfig = {
            'INSTALL': { 
                title: 'Installation History', 
                icon: 'bi-arrow-up-circle', 
                color: 'linear-gradient(135deg, #11998e, #38ef7d)',
                endpoint: '/api/history/INSTALL'
            },
            'REMOVE': { 
                title: 'Removal History', 
                icon: 'bi-arrow-down-circle', 
                color: 'linear-gradient(135deg, #ee0979, #ff6a00)',
                endpoint: '/api/history/REMOVE'
            },
            'REPAIR': { 
                title: 'Repair History', 
                icon: 'bi-wrench', 
                color: 'linear-gradient(135deg, #f093fb, #f5576c)',
                endpoint: '/api/history/REPAIR'
            },
            'SHIP': { 
                title: 'Shipment History', 
                icon: 'bi-truck', 
                color: 'linear-gradient(135deg, #8e44ad, #3498db)',
                endpoint: '/api/history/SHIP'
            },
            'PART': { 
                title: 'Parts History', 
                icon: 'bi-puzzle', 
                color: 'linear-gradient(135deg, #4facfe, #00f2fe)',
                endpoint: '/api/parts/history'
            },
            'PART_ACTION': { 
                title: 'Parts History', 
                icon: 'bi-puzzle', 
                color: 'linear-gradient(135deg, #4facfe, #00f2fe)',
                endpoint: '/api/parts/history'
            },
            'PART_INSTALLED': { 
                title: 'Parts History', 
                icon: 'bi-puzzle-fill', 
                color: 'linear-gradient(135deg, #4facfe, #00f2fe)',
                endpoint: '/api/parts/history'
            },
            'ATLB': { 
                title: 'Utilization History (ATLB)', 
                icon: 'bi-airplane', 
                color: 'linear-gradient(135deg, #43e97b, #38f9d7)',
                endpoint: '/api/history/ATLB'
            },
            'FLIGHT': { 
                title: 'Flight History', 
                icon: 'bi-airplane', 
                color: 'linear-gradient(135deg, #43e97b, #38f9d7)',
                endpoint: '/api/history/FLIGHT'
            },
            'ENG_PARAM': { 
                title: 'Engine Parameters History', 
                icon: 'bi-gear', 
                color: 'linear-gradient(135deg, #fa709a, #fee140)',
                endpoint: null
            },
            'UTIL_PARAM': { 
                title: 'Utilization Parameters History', 
                icon: 'bi-bar-chart', 
                color: 'linear-gradient(135deg, #fa709a, #fee140)',
                endpoint: '/api/utilization-parameters'
            },
            'INSPECT': { 
                title: 'Engine Inspection History', 
                icon: 'bi-eyeglass', 
                color: 'linear-gradient(135deg, #f39c12, #e67e22)',
                endpoint: '/api/engines'
            }
        };

        const config = typeConfig[actionType.toUpperCase()] || {
            title: 'History',
            icon: 'bi-table',
            color: 'linear-gradient(135deg, #667eea, #764ba2)',
            endpoint: '/api/engines'
        };

        // Устанавливаем заголовок и стиль
        modalTitle.innerHTML = `<i class="bi ${config.icon} me-2"></i>${config.title}`;
        modalHeader.style.background = config.color;

        // Показываем загрузку
        modalBody.innerHTML = `
            <div class="text-center py-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="text-muted mt-3">Loading ${config.title.toLowerCase()}...</p>
            </div>
        `;

        modal.show();
        // Raise backdrop behind preview modal so it sits above history
        setTimeout(() => {
            const backdrops = document.querySelectorAll('.modal-backdrop');
            const bd = backdrops[backdrops.length - 1];
            if (bd) bd.style.zIndex = '1060';
        }, 0);

        // Загружаем данные
        try {
            if (!config.endpoint) {
                modalBody.innerHTML = '<div class="text-muted py-3">No dedicated history for this type.</div>';
                modal.show();
                return;
            }
            const res = await safeFetch(config.endpoint + window.noCache());
            if (!res || !res.ok) throw new Error('Failed to load data');
            
            let data = await res.json();
            // Клиентская фильтрация по серийному номеру двигателя, если задан
            if (serialFilter) {
                const sf = String(serialFilter).trim().toLowerCase();
                const matchesSerial = (obj) => {
                    const fields = [
                        obj.engine_sn,
                        obj.current_sn,
                        obj.original_sn,
                        obj.engine_current_sn,
                        obj.engine_original_sn,
                        obj.to_esn,
                        obj.from_esn
                    ].filter(Boolean).map(v => String(v).toLowerCase());
                    return fields.some(v => v === sf);
                };
                if (Array.isArray(data)) {
                    data = data.filter(matchesSerial);
                }
            }
            
            // Генерируем таблицу в зависимости от типа
            let tableHTML = generateTableForType(actionType.toUpperCase(), data);
            modalBody.innerHTML = tableHTML;
            
        } catch (error) {
            modalBody.innerHTML = `
                <div class="text-center py-5">
                    <i class="bi bi-exclamation-triangle text-warning" style="font-size: 3rem;"></i>
                    <p class="mt-3 text-muted">Unable to load ${config.title.toLowerCase()}.</p>
                    <p class="text-muted small">${error.message}</p>
                </div>
            `;
        }
    }

    // Функция для генерации HTML таблицы в зависимости от типа
    function generateTableForType(actionType, data) {
        if (!Array.isArray(data) || data.length === 0) {
            return `
                <div class="text-center py-5">
                    <i class="bi bi-inbox text-muted" style="font-size: 3rem;"></i>
                    <p class="mt-3 text-muted">No records found</p>
                </div>
            `;
        }

        let tableHTML = '<div class="table-responsive"><table class="table table-hover table-striped">';

        switch(actionType) {
            case 'INSTALL':
                tableHTML += `
                    <thead class="table-dark">
                        <tr>
                            <th>#</th>
                            <th>Date</th>
                            <th>Engine S/N</th>
                            <th>Aircraft</th>
                            <th>Position</th>
                            <th>Location From</th>
                            <th>TT</th>
                            <th>TC</th>
                            <th>Remarks</th>
                        </tr>
                    </thead>
                    <tbody>
                `;
                data.forEach((item, idx) => {
                    tableHTML += `
                        <tr>
                            <td>${idx + 1}</td>
                            <td>${item.date || '-'}</td>
                            <td><strong>${item.engine_sn || '-'}</strong></td>
                            <td>${item.aircraft || '-'}</td>
                            <td>${item.position || '-'}</td>
                            <td>${item.location_from || '-'}</td>
                            <td>${item.tt || 0}</td>
                            <td>${item.tc || 0}</td>
                            <td>${item.remarks || '-'}</td>
                        </tr>
                    `;
                });
                break;

            case 'REMOVE':
                tableHTML += `
                    <thead class="table-dark">
                        <tr>
                            <th>#</th>
                            <th>Date</th>
                            <th>Engine S/N</th>
                            <th>Aircraft</th>
                            <th>Position</th>
                            <th>Destination</th>
                            <th>TT</th>
                            <th>TC</th>
                            <th>Remarks</th>
                        </tr>
                    </thead>
                    <tbody>
                `;
                data.forEach((item, idx) => {
                    tableHTML += `
                        <tr>
                            <td>${idx + 1}</td>
                            <td>${item.date || '-'}</td>
                            <td><strong>${item.engine_sn || '-'}</strong></td>
                            <td>${item.aircraft || '-'}</td>
                            <td>${item.position || '-'}</td>
                            <td>${item.destination || '-'}</td>
                            <td>${item.tt || 0}</td>
                            <td>${item.tc || 0}</td>
                            <td>${item.remarks || '-'}</td>
                        </tr>
                    `;
                });
                break;

            case 'REPAIR':
                tableHTML += `
                    <thead class="table-dark">
                        <tr>
                            <th>#</th>
                            <th>Date</th>
                            <th>Engine S/N</th>
                            <th>Station</th>
                            <th>Defect</th>
                            <th>Correction</th>
                            <th>Remarks</th>
                        </tr>
                    </thead>
                    <tbody>
                `;
                data.forEach((item, idx) => {
                    tableHTML += `
                        <tr>
                            <td>${idx + 1}</td>
                            <td>${item.date || '-'}</td>
                            <td><strong>${item.engine_sn || '-'}</strong></td>
                            <td>${item.station || '-'}</td>
                            <td>${item.defect || '-'}</td>
                            <td>${item.correction || '-'}</td>
                            <td>${item.remarks || '-'}</td>
                        </tr>
                    `;
                });
                break;

            case 'SHIP':
                tableHTML += `
                    <thead class="table-dark">
                        <tr>
                            <th>#</th>
                            <th>Date</th>
                            <th>Engine S/N</th>
                            <th>From</th>
                            <th>To</th>
                            <th>Waybill</th>
                        </tr>
                    </thead>
                    <tbody>
                `;
                data.forEach((item, idx) => {
                    tableHTML += `
                        <tr>
                            <td>${idx + 1}</td>
                            <td>${item.date || '-'}</td>
                            <td><strong>${item.engine_sn || '-'}</strong></td>
                            <td>${item.location_from || '-'}</td>
                            <td>${item.location_to || '-'}</td>
                            <td>${item.waybill || '-'}</td>
                        </tr>
                    `;
                });
                break;

            case 'PART':
            case 'PART_ACTION':
            case 'PART_INSTALLED':
                tableHTML += `
                    <thead class="table-dark">
                        <tr>
                            <th>#</th>
                            <th>Date</th>
                            <th>Part Number</th>
                            <th>Part Name</th>
                            <th>S/N</th>
                            <th>Engine S/N</th>
                            <th>Remarks</th>
                        </tr>
                    </thead>
                    <tbody>
                `;
                data.forEach((item, idx) => {
                    tableHTML += `
                        <tr>
                            <td>${idx + 1}</td>
                            <td>${item.date || '-'}</td>
                            <td><strong>${item.part_number || '-'}</strong></td>
                            <td>${item.part_name || '-'}</td>
                            <td>${item.part_sn || '-'}</td>
                            <td>${item.engine_sn || '-'}</td>
                            <td>${item.remarks || '-'}</td>
                        </tr>
                    `;
                });
                break;

            case 'ATLB':
            case 'FLIGHT':
                tableHTML += `
                    <thead class="table-dark">
                        <tr>
                            <th>#</th>
                            <th>Date</th>
                            <th>Engine S/N</th>
                            <th>Aircraft</th>
                            <th>Flight Hours</th>
                            <th>Cycles</th>
                            <th>Remarks</th>
                        </tr>
                    </thead>
                    <tbody>
                `;
                data.forEach((item, idx) => {
                    tableHTML += `
                        <tr>
                            <td>${idx + 1}</td>
                            <td>${item.date || '-'}</td>
                            <td><strong>${item.engine_sn || '-'}</strong></td>
                            <td>${item.aircraft || '-'}</td>
                            <td>${item.flight_hours || 0}</td>
                            <td>${item.cycles || 0}</td>
                            <td>${item.remarks || '-'}</td>
                        </tr>
                    `;
                });
                break;

            case 'ENG_PARAM':
                tableHTML += `
                    <thead class="table-dark">
                        <tr>
                            <th>#</th>
                            <th>Date</th>
                            <th>Engine S/N</th>
                            <th>Parameter</th>
                            <th>Value</th>
                            <th>Remarks</th>
                        </tr>
                    </thead>
                    <tbody>
                `;
                data.forEach((item, idx) => {
                    tableHTML += `
                        <tr>
                            <td>${idx + 1}</td>
                            <td>${item.date || '-'}</td>
                            <td><strong>${item.engine_sn || '-'}</strong></td>
                            <td>${item.parameter || '-'}</td>
                            <td>${item.value || '-'}</td>
                            <td>${item.remarks || '-'}</td>
                        </tr>
                    `;
                });
                break;

            case 'UTIL_PARAM':
                tableHTML += `
                    <thead class="table-dark">
                        <tr>
                            <th>#</th>
                            <th>Date</th>
                            <th>Engine S/N</th>
                            <th>TT</th>
                            <th>TC</th>
                            <th>Remarks</th>
                        </tr>
                    </thead>
                    <tbody>
                `;
                data.forEach((item, idx) => {
                    tableHTML += `
                        <tr>
                            <td>${idx + 1}</td>
                            <td>${item.date || '-'}</td>
                            <td><strong>${item.engine_sn || '-'}</strong></td>
                            <td>${item.tt || 0}</td>
                            <td>${item.tc || 0}</td>
                            <td>${item.remarks || '-'}</td>
                        </tr>
                    `;
                });
                break;

            case 'INSPECT':
                tableHTML += `
                    <thead class="table-dark">
                        <tr>
                            <th>#</th>
                            <th>Original S/N</th>
                            <th>Current S/N</th>
                            <th>Status</th>
                            <th>Location</th>
                            <th>TT</th>
                            <th>TC</th>
                        </tr>
                    </thead>
                    <tbody>
                `;
                data.forEach((item, idx) => {
                    tableHTML += `
                        <tr>
                            <td>${idx + 1}</td>
                            <td><strong>${item.original_sn || '-'}</strong></td>
                            <td>${item.current_sn || '-'}</td>
                            <td><span class="badge bg-info">${item.status || '-'}</span></td>
                            <td>${item.location || '-'}</td>
                            <td>${item.tt || 0}</td>
                            <td>${item.tc || 0}</td>
                        </tr>
                    `;
                });
                break;

            default:
                tableHTML += `
                    <thead class="table-dark">
                        <tr>
                            <th>#</th>
                            <th>Data</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td colspan="2">Unknown data type</td>
                        </tr>
                    </tbody>
                `;
        }

        tableHTML += '</tbody></table></div>';
        return tableHTML;
    }

    function switchBoroscopeTab(tabName) {
        if (tabName === 'info') {
            document.getElementById('tab-bore-info').style.display = 'block';
            document.getElementById('tab-bore-entry').style.display = 'none';
            document.getElementById('tab-bore-info-btn').classList.add('active');
            document.getElementById('tab-bore-entry-btn').classList.remove('active');
            loadBoroscopeHistory();
        } else {
            document.getElementById('tab-bore-info').style.display = 'none';
            document.getElementById('tab-bore-entry').style.display = 'block';
            document.getElementById('tab-bore-info-btn').classList.remove('active');
            document.getElementById('tab-bore-entry-btn').classList.add('active');
            prepareBoroscopeForm();
        }
    }

    async function loadBoroscopeHistory() {
        const tbody = document.getElementById('borescope-history-body');
        if (!tbody) return;
        tbody.innerHTML = '<tr><td colspan="9" class="text-center text-muted py-3">Loading…</td></tr>';

        let res = await safeFetch('/api/history/BORESCOPE' + window.noCache());
        if (!res || !res.ok) res = await safeFetch('/api/history/BORESCOPE');

        if (!res || !res.ok) {
            console.error('Error loading borescope history', res && res.status);
            tbody.innerHTML = '<tr><td colspan="9" class="text-center text-danger py-3">Unable to load borescope history</td></tr>';
            return;
        }

        let serverData = [];
        try { serverData = await res.json(); } catch { serverData = []; }

        tbody.innerHTML = '';
        if (!Array.isArray(serverData) || serverData.length === 0) {
            tbody.innerHTML = '<tr><td colspan="9" class="text-center text-muted py-3">No borescope inspections found</td></tr>';
            return;
        }

        serverData.sort((a, b) => (b.id || 0) - (a.id || 0));
        serverData.forEach(row => {
            // Парсим inspection_report если это строка JSON
            if (row.inspection_report && typeof row.inspection_report === 'string') {
                try {
                    row.inspection_report = JSON.parse(row.inspection_report);
                } catch (e) {
                    row.inspection_report = null;
                }
            }
            
            const linkHtml = row.link ? `<a href="${row.link}" target="_blank" class="btn btn-sm btn-outline-primary" onclick="event.stopPropagation();"><i class="bi bi-link-45deg"></i></a>` : '-';
            
            // Format date with time if available
            let dateDisplay = row.date;
            if (row.date && row.date.includes(' ')) {
                const [datePart, timePart] = row.date.split(' ');
                dateDisplay = `${datePart}<br><small class="text-muted">${timePart}</small>`;
            }
            
            // Проверяем есть ли фото
            const hasPhotos = row.inspection_report && Array.isArray(row.inspection_report.photos) && row.inspection_report.photos.length > 0;
            const photoIcon = hasPhotos ? `<i class="bi bi-image text-info" title="${row.inspection_report.photos.length} photo(s)"></i>` : '';
            
            tbody.innerHTML += `
                <tr data-log-id="${row.id || 0}" data-user="${row.user || row.created_by || row.inspector || ''}" data-link="${row.link || ''}" style="cursor: pointer;" onclick="highlightRow(this)" title="Click to view details">
                    <td class="delete-col-borescope" style="display: none;">
                        <button class="btn btn-sm btn-danger" onclick="deleteHistoryRecord('BORESCOPE', ${row.id || 0}, ''); event.stopPropagation();" title="Delete">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                    <td>${dateDisplay}</td>
                    <td>${row.aircraft || '-'}</td>
                    <td>${row.serial_number || '-'}</td>
                    <td>${row.position || '-'}</td>
                    <td>${row.work_type || 'All Engine'}</td>
                    <td>${row.gss_id || '-'}</td>
                    <td>${row.inspector || '-'}</td>
                    <td>${row.comment || '-'}</td>
                    <td data-key="link">${linkHtml}</td>
                </tr>
            `;
        });
    }

    // Показать полный report при клике на строку
    async function showBoroscopeInspectionDetails(rowId) {
        // Загружаем данные инспекции с сервера
        const res = await safeFetch(`/api/history/BORESCOPE${window.noCache()}`);
        if (!res || !res.ok) {
            showErrorNotification('Failed to load inspection details');
            return;
        }
        
        const inspections = await res.json();
        let inspection = inspections.find(i => i.id === rowId);
        
        if (!inspection) {
            showErrorNotification('Inspection not found');
            return;
        }
        
        // Парсим inspection_report если это строка JSON
        if (inspection.inspection_report && typeof inspection.inspection_report === 'string') {
            try {
                inspection.inspection_report = JSON.parse(inspection.inspection_report);
            } catch (e) {
                console.warn('Failed to parse inspection_report:', e);
                inspection.inspection_report = null;
            }
        }
        
        // DEBUG логирование
        console.log('\n' + '='.repeat(60));
        console.log('--- BOROSCOPE DETAILS ---');
        console.log('='.repeat(60));
        console.log('Inspection ID:', rowId);
        console.log('Full inspection object:', inspection);
        console.log('inspection_report type:', typeof inspection.inspection_report);
        console.log('inspection_report value:', inspection.inspection_report);
        
        if (inspection.inspection_report) {
            console.log('inspection_report.photos:', inspection.inspection_report.photos);
            if (Array.isArray(inspection.inspection_report.photos)) {
                console.log('Photos array length:', inspection.inspection_report.photos.length);
                inspection.inspection_report.photos.forEach((p, i) => {
                    console.log(`  Photo ${i}:`, {
                        label: p.label,
                        photo1_length: p.photo1 ? p.photo1.length : 0,
                        photo2_length: p.photo2 ? p.photo2.length : 0
                    });
                });
            } else {
                console.log('❌ WARNING: photos is NOT an array!');
            }
        } else {
            console.log('❌ WARNING: inspection_report is null/undefined!');
        }
        console.log('='.repeat(60));
        
        // Загружаем данные двигателя используя ТУ ЖЕ ЛОГИКУ что на форме
        let reportHtml = '';
        let engineData = null;
        
        try {
            // 1. Загружаем список двигателей
            const engineRes = await safeFetch(`/api/engines${window.noCache()}`);
            if (engineRes && engineRes.ok) {
                const engines = await engineRes.json();
                const engine = engines.find(e => 
                    e.original_sn === inspection.serial_number || 
                    e.current_sn === inspection.serial_number
                );
                
                if (engine) {
                    // 2. Загружаем историю INSTALL используя НОВУЮ логику
                    const installRes = await safeFetch(`/api/history/INSTALL${window.noCache()}`);
                    if (installRes && installRes.ok) {
                        const allInstallations = await installRes.json();
                        
                        // Фильтруем установки для этого двигателя (используем ПРАВИЛЬНЫЕ имена полей!)
                        const engineInstalls = allInstallations.filter(inst => {
                            const matchSN = (inst.original_sn === engine.original_sn || 
                                           inst.current_sn === engine.current_sn ||
                                           inst.original_sn === engine.current_sn ||
                                           inst.current_sn === engine.original_sn);
                            return matchSN && inst.install_to === engine.aircraft;
                        }).sort((a, b) => new Date(b.date) - new Date(a.date));
                        
                        const latestInstall = engineInstalls.length > 0 ? engineInstalls[0] : null;
                        
                        // Сохраняем как на форме
                        if (latestInstall) {
                            engineData = {
                                engine: engine,
                                installation: latestInstall,
                                selectedSN: inspection.serial_number
                            };
                        }
                    }
                }
            }
        } catch (err) {
            console.error('Error loading engine data:', err);
        }
        
        // Формируем HTML используя ТУ ЖЕ СТРУКТУРУ что на форме
        reportHtml = `
            <div class="border rounded p-3 bg-light mb-4">
                <h5 class="mb-3">Boroscope Report Summary</h5>
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>Date:</strong> <span>${inspection.date || '—'}</span></p>
                        <p><strong>Orig S/N:</strong> <span>${inspection.serial_number || '—'}</span></p>
                        <p><strong>GSS ID:</strong> <span>${inspection.gss_id || '—'}</span></p>
                        <p><strong>Aircraft:</strong> <span style="font-weight: bold; color: #0066cc;">${inspection.aircraft || '—'}</span></p>
                        <p><strong>Position:</strong> <span>${inspection.position || '—'}</span></p>
                    </div>
                    <div class="col-md-6">
        `;
        
        if (engineData && engineData.installation) {
            const inst = engineData.installation;
            const eng = engineData.engine;
            
            // Вычисляем TSN/CSN на самолете ИСПОЛЬЗУЯ ТУ ЖЕ ЛОГИКУ
            const tsnAtInstall = inst.snapshot_tt || 0;
            const csnAtInstall = inst.snapshot_tc || 0;
            const totalTsn = eng.total_tsn || 0;
            const totalCsn = eng.total_csn || 0;
            
            const tsnOnAC = totalTsn - tsnAtInstall;
            const csnOnAC = totalCsn - csnAtInstall;
            
            reportHtml += `
                        <p><strong>Installation Date:</strong> <span style="color: #d9534f;">${inst.date || '—'}</span></p>
                        <p><strong>Supplier:</strong> <span>${inst.location_from || inst.supplier || '—'}</span></p>
            `;
        } else {
            reportHtml += `
                        <p class="text-muted">Engine not currently installed on aircraft</p>
                        <p class="text-muted">Only Serial Number and GSS ID available</p>
            `;
        }
        
        reportHtml += `
                    </div>
                </div>
            </div>
        `;
        
        // Добавляем Comment и Link если есть
        if (inspection.comment || inspection.link) {
            reportHtml += `
                <div class="border rounded p-3 bg-white mb-3">
                    <h6 class="mb-2">Additional Information</h6>
            `;
            if (inspection.comment) {
                reportHtml += `<p><strong>Comment:</strong> ${inspection.comment}</p>`;
            }
            if (inspection.link) {
                reportHtml += `<p><strong>Link:</strong> <a href="${inspection.link}" target="_blank">${inspection.link}</a></p>`;
            }
            reportHtml += `</div>`;
        }
        
        // Добавляем фото если есть
        let photosHtml = '';
        
        console.log('\n🖼️ BUILDING PHOTOS HTML:');
        console.log('  inspection_report exists?', !!inspection.inspection_report);
        console.log('  photos is array?', Array.isArray(inspection.inspection_report?.photos));
        console.log('  photos length:', inspection.inspection_report?.photos?.length || 0);
        
        if (inspection.inspection_report && Array.isArray(inspection.inspection_report.photos) && inspection.inspection_report.photos.length > 0) {
            console.log('  ✅ Building photos section...');
            photosHtml = `
                <div class="border rounded p-3 bg-white">
                    <h5 class="mb-3">Inspection Photos</h5>
            `;
            
            inspection.inspection_report.photos.forEach((photoRow, idx) => {
                console.log(`    Processing photo row ${idx}:`, {
                    label: photoRow.label,
                    has_photo1: !!photoRow.photo1,
                    has_photo2: !!photoRow.photo2
                });
                
                if (!photoRow.label && !photoRow.photo1 && !photoRow.photo2) {
                    console.log(`    Skipping empty photo row ${idx}`);
                    return;
                }
                
                photosHtml += `
                    <div class="mb-4">
                        <h6 class="text-primary">${photoRow.label || `Photo Set ${idx + 1}`}</h6>
                        <div class="row">
                `;
                
                if (photoRow.photo1) {
                    photosHtml += `
                        <div class="col-md-6 mb-2">
                            <div class="border rounded p-2">
                                <img src="${photoRow.photo1}" class="img-fluid rounded" style="max-height: 300px; width: 100%; object-fit: contain; cursor: pointer;" 
                                     onclick="openBorescopePhoto(this.src)" title="Click to view full size">
                                <p class="text-center text-muted small mt-1">Photo 1</p>
                            </div>
                        </div>
                    `;
                }
                
                if (photoRow.photo2) {
                    photosHtml += `
                        <div class="col-md-6 mb-2">
                            <div class="border rounded p-2">
                                <img src="${photoRow.photo2}" class="img-fluid rounded" style="max-height: 300px; width: 100%; object-fit: contain; cursor: pointer;" 
                                     onclick="openBorescopePhoto(this.src)" title="Click to view full size">
                                <p class="text-center text-muted small mt-1">Photo 2</p>
                            </div>
                        </div>
                    `;
                }
                
                photosHtml += '</div></div>';
            });
            
            photosHtml += '</div>';
            console.log('  ✅ Photos HTML built successfully');
        } else {
            console.log('  ❌ No photos to display');
            if (!inspection.inspection_report) {
                console.log('     Reason: inspection_report is null/undefined');
            } else if (!Array.isArray(inspection.inspection_report.photos)) {
                console.log('     Reason: photos is not an array');
            } else {
                console.log('     Reason: photos array is empty');
            }
        }
        
        // Создаем модальное окно
        const modal = document.createElement('div');
        modal.className = 'modal fade';
        modal.id = `inspection-details-modal-${rowId}`;
        modal.tabIndex = '-1';
        modal.innerHTML = `
            <div class="modal-dialog modal-xl">
                <div class="modal-content">
                    <div class="modal-header bg-info text-white">
                        <h5 class="modal-title">Boroscope Inspection Report - ID: ${rowId}</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body" style="max-height: 80vh; overflow-y: auto;">
                        ${reportHtml}
                        ${photosHtml}
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
        const bsModal = new bootstrap.Modal(modal);
        bsModal.show();
        
        // Очищаем модальное окно когда оно закрывается
        modal.addEventListener('hidden.bs.modal', () => modal.remove());
    }

    window.openBorescopePhoto = function (src) {
        const overlay = document.getElementById('borescope-photo-overlay');
        const img = document.getElementById('borescope-photo-img');
        if (overlay && img) {
            img.src = src;
            overlay.style.display = 'flex';
            document.body.style.overflow = 'hidden';
        }
    }

    window.closeBorescopePhoto = function () {
        const overlay = document.getElementById('borescope-photo-overlay');
        if (!overlay) return;
        overlay.style.display = 'none';
        document.body.style.overflow = '';
    }

    // Выделить строку при клике
    function highlightRow(row) {
        // Удаляем выделение с предыдущих строк
        document.querySelectorAll('#borescope-history-body tr').forEach(r => {
            r.style.background = '';
        });
        // Выделяем текущую строку
        row.style.background = '#e7f1ff';
        
        // Проверяем режим Edit: если кнопка Edit скрыта (содержит d-none) - мы В РЕЖИМЕ EDIT
        const editBtn = document.getElementById('btn-borescope-edit');
        const isEditMode = editBtn && editBtn.classList.contains('d-none');
        
        // Показываем детали инспекции ТОЛЬКО вне режима Edit
        if (!isEditMode) {
            // Вне режима Edit: показываем модальное окно с репортом
            const rowId = parseInt(row.getAttribute('data-log-id'));
            if (rowId) {
                showBoroscopeInspectionDetails(rowId);
            }
        }
        // В режиме Edit: ничего не делаем, только выделяем строку (чтобы можно было выбрать через чекбокс)
    }

    // Очистить и вернуться из режима редактирования borescope
    function clearBoroscopeForm() {
        document.getElementById('form-borescope').reset();
        clearBoroscopeReport();
        clearInspectionPhotosTable();
        
        // Сбрасываем Aircraft и Position в начальное состояние
        const acSelect = document.getElementById('bore-aircraft');
        const posSelect = document.getElementById('bore-position');
        
        if (acSelect) {
            acSelect.innerHTML = '<option value="">-- будет заполнено --</option>';
            acSelect.disabled = true;
        }
        
        if (posSelect) {
            posSelect.value = '';
            posSelect.disabled = true;
        }
    }

    async function prepareBoroscopeForm() {
        // Aircraft теперь автозаполняется при выборе Orig SN
        const acSelect = document.getElementById('bore-aircraft');
        if (acSelect) {
            acSelect.innerHTML = '<option value="">-- будет заполнено --</option>';
            acSelect.disabled = true;
        }

        // ✅ ИСПОЛЬЗУЕМ ТОЛЬКО /api/engines (ТЕКУЩИЕ установки!)
        try {
            const engineRes = await fetch('/api/engines' + window.noCache());
            if (!engineRes.ok) throw new Error('Failed to load engines');
            
            const engines = await engineRes.json();
            
            const origSnList = document.getElementById('bore-orig-sn-list');
            if (origSnList) {
                const origSnMap = new Map();
                
                if (Array.isArray(engines)) {
                    engines.forEach(engine => {
                        const originalSN = engine.original_sn ? String(engine.original_sn).trim() : null;
                        const currentSN = engine.current_sn ? String(engine.current_sn).trim() : null;
                        const isInstalled = engine.aircraft && engine.position;
                        
                        // ✅ В датализте только ORIGINAL SN (как value)
                        // Если установлен - показываем информацию об установке и Current SN
                        if (originalSN && !origSnMap.has(originalSN)) {
                            if (isInstalled) {
                                // Пример: "747-474 (ER-BAR Pos 1) [Current: 121-212]"
                                const label = currentSN 
                                    ? `${originalSN} (${engine.aircraft} Pos ${engine.position}) [Current: ${currentSN}]`
                                    : `${originalSN} (${engine.aircraft} Pos ${engine.position})`;
                                
                                origSnMap.set(originalSN, {
                                    value: originalSN,
                                    label: label,
                                    aircraft: engine.aircraft,
                                    position: engine.position,
                                    currentSN: currentSN
                                });
                            } else {
                                // Не установлен - просто Orig SN
                                origSnMap.set(originalSN, {
                                    value: originalSN,
                                    label: originalSN,
                                    aircraft: null,
                                    position: null,
                                    currentSN: null
                                });
                            }
                        }
                    });
                }
                
                // Сохраняем для использования в onOrigSNChange()
                window.boroscopeOrigSnData = origSnMap;
                
                // Добавляем в датализт
                origSnList.innerHTML = '';
                Array.from(origSnMap.values())
                    .sort((a, b) => a.label.localeCompare(b.label))
                    .forEach(item => {
                        const option = document.createElement('option');
                        option.value = item.value;
                        option.label = item.label;
                        option.textContent = item.label;
                        origSnList.appendChild(option);
                    });
                
                console.log('✅ Borescope Orig SN datalist updated with', origSnMap.size, 'engines');
            }
        } catch (err) {
            console.warn('Error loading engine serials for Borescope:', err);
        }
        
        // Добавляем обработчики для обновления report
        const dateField = document.getElementById('bore-date');
        const gssField = document.getElementById('bore-gss');
        const posField = document.getElementById('bore-position');
        
        if (dateField) dateField.addEventListener('change', updateBoroscopeReport);
        if (gssField) gssField.addEventListener('change', updateBoroscopeReport);
        if (posField) posField.addEventListener('change', updateBoroscopeReport);
    }

    async function submitBoroscopeForm() {
        if (window.borescopeSaveInProgress) return;
        window.borescopeSaveInProgress = true;
        const saveBtn = document.querySelector('button[onclick="submitBoroscopeForm()"]');
        if (saveBtn) {
            saveBtn.disabled = true;
            saveBtn.dataset.originalText = saveBtn.innerText;
            saveBtn.innerText = 'Saving...';
        }
        const date = document.getElementById('bore-date').value;
        const time = document.getElementById('bore-time').value;
        const aircraft = document.getElementById('bore-aircraft').value;
        const origSN = document.getElementById('bore-orig-sn').value;
        const currentSN = document.getElementById('bore-current-sn').value;
        const positionField = document.getElementById('bore-position');
        const position = positionField ? positionField.value : '';
        const workType = document.getElementById('bore-work-type').value;
        const gss = document.getElementById('bore-gss').value;
        const inspector = document.getElementById('bore-inspector').value;
        const comment = document.getElementById('bore-comment').value;
        const link = document.getElementById('bore-link').value;
        
        // Валидация обязательных полей
        if (!date || !origSN || !workType || !inspector) {
            showErrorNotification("Заполните обязательные поля: Date, Orig SN, Work Type, Inspector");
            window.borescopeSaveInProgress = false;
            const saveBtn = document.querySelector('button[onclick="submitBoroscopeForm()"]');
            if (saveBtn) {
                saveBtn.disabled = false;
                if (saveBtn.dataset.originalText) {
                    saveBtn.innerText = saveBtn.dataset.originalText;
                    delete saveBtn.dataset.originalText;
                }
            }
            return;
        }
        
        // Combine date and time if time is provided
        const dateTimeValue = time ? `${date} ${time}` : date;
        
        console.log('\n' + '='.repeat(60));
        console.log('--- SAVING BOROSCOPE (R2 STORAGE) ---');
        console.log('='.repeat(60));
        
        // Создаем FormData для отправки файлов
        const formData = new FormData();
        formData.append('date', dateTimeValue);
        formData.append('aircraft', aircraft);
        formData.append('serial_number', origSN);  // Backend ожидает serial_number
        formData.append('position', position);
        formData.append('work_type', workType);
        formData.append('gss_id', gss || '');
        formData.append('inspector', inspector);
        formData.append('comment', comment || '');
        formData.append('link', link || '');
        
        // Собираем фото и лейблы из таблицы
        const photoRows = document.querySelectorAll('#inspection-photos-tbody tr');
        const labels = [];
        let photoCount = 0;
        
        console.log('📸 PHOTO COLLECTION:');
        console.log(`  Table rows: ${photoRows.length}`);
        
        photoRows.forEach((row, rowIdx) => {
            const rowId = parseInt(row.getAttribute('data-row-id'));
            const labelInput = row.querySelector('input[data-type="label"]');
            const label = labelInput ? labelInput.value.trim() : '';
            
            labels.push(label);
            
            // Находим файлы для этой строки в inspectionPhotosData
            const photo1Data = inspectionPhotosData.find(p => p.rowId === rowId && p.photoNum === 1);
            const photo2Data = inspectionPhotosData.find(p => p.rowId === rowId && p.photoNum === 2);
            
            console.log(`  Row ${rowIdx} (rowId=${rowId}):`);
            console.log(`    Label: "${label}"`);
            console.log(`    photo1: ${photo1Data ? 'exists' : 'null'}`);
            console.log(`    photo2: ${photo2Data ? 'exists' : 'null'}`);
            
            // Добавляем файлы в FormData
            if (photo1Data && photo1Data.file) {
                formData.append('photos', photo1Data.file, photo1Data.file.name);
                photoCount++;
                console.log(`      → Added photo1: ${photo1Data.file.name}`);
            }
            if (photo2Data && photo2Data.file) {
                formData.append('photos', photo2Data.file, photo2Data.file.name);
                photoCount++;
                console.log(`      → Added photo2: ${photo2Data.file.name}`);
            }
        });
        
        // Добавляем лейблы как JSON строку
        formData.append('photo_labels', JSON.stringify(labels));
        
        console.log(`\n📤 Total photos to upload: ${photoCount}`);
        console.log('='.repeat(60));
        
        try {
            const res = await fetch('/api/history/BORESCOPE', {
                method: 'POST',
                body: formData  // НЕ указываем Content-Type, браузер сам установит с boundary
            });
            
            if (!res.ok) {
                const error = await res.json();
                throw new Error(error.detail || 'Failed to save borescope inspection');
            }
            
            // Успешно сохранено
            showSuccessNotification("Borescope inspection saved successfully!");
            
            // Очищаем форму
            document.getElementById('form-borescope').reset();
            clearInspectionPhotosTable();
            
            // Переключаемся на вкладку истории
            switchBoroscopeTab('info');
            
            // Перезагружаем таблицу с новыми данными
            await loadBoroscopeHistory();
            
        } catch (error) {
            showErrorNotification(`Error: ${error.message}`);
            console.error('Borescope save error:', error);
        } finally {
            window.borescopeSaveInProgress = false;
            const saveBtn = document.querySelector('button[onclick="submitBoroscopeForm()"]');
            if (saveBtn) {
                saveBtn.disabled = false;
                if (saveBtn.dataset.originalText) {
                    saveBtn.innerText = saveBtn.dataset.originalText;
                    delete saveBtn.dataset.originalText;
                }
            }
        }
    }

    // Обработчик выбора самолета
    async function onAircraftChange() {
        const aircraft = document.getElementById('bore-aircraft').value;
        if (!aircraft) return;
        
        // При выборе самолета можем загрузить его параметры для расчета TSN/CSN
        try {
            const res = await fetch(`/api/dashboard/aircraft-details${window.noCache()}`);
            if (!res.ok) return;
            const aircrafts = await res.json();
            const selectedAc = aircrafts.find(a => a.tail_number === aircraft);
            if (selectedAc) {
                // Сохраняем данные самолета в window для использования при выборе SN
                window.boroscopeSelectedAircraft = selectedAc;
            }
        } catch (e) {
            console.log('Could not load aircraft details for Borescope');
        }
    }

    // ✅ НОВАЯ функция: Обработчик выбора Orig SN
    async function onOrigSNChange() {
        const origSN = document.getElementById('bore-orig-sn').value;
        const currentSnField = document.getElementById('bore-current-sn');
        const posSelect = document.getElementById('bore-position');
        const gssField = document.getElementById('bore-gss');
        const aircraftSelect = document.getElementById('bore-aircraft');
        
        // Очищаем поля
        if (currentSnField) currentSnField.value = '';
        if (posSelect) {
            posSelect.value = '';
            posSelect.disabled = true;
        }
        if (aircraftSelect) {
            aircraftSelect.value = '';
            aircraftSelect.disabled = true;
        }
        if (gssField) gssField.value = '';
        
        if (!origSN) {
            clearBoroscopeReport();
            return;
        }
        
        try {
            // 1. Получаем данные из датализта (уже загружены)
            const origSnData = window.boroscopeOrigSnData?.get(origSN);
            if (!origSnData) {
                console.warn('Orig SN not found in datalist:', origSN);
                clearBoroscopeReport();
                return;
            }
            
            // 2. Ищем двигатель в API
            const engRes = await fetch(`/api/engines${noCache()}`);
            if (!engRes.ok) throw new Error('Failed to load engines');
            const engines = await engRes.json();
            
            const engine = engines.find(e => e.original_sn === origSN);
            if (!engine) {
                console.warn('Engine not found for Orig SN:', origSN);
                clearBoroscopeReport();
                return;
            }

            // 3. Автозаполняем Current SN
            if (currentSnField && engine.current_sn) {
                currentSnField.value = engine.current_sn;
            }

            // 4. Автоподстановка GSS ID
            if (gssField) {
                gssField.value = engine.gss_sn || engine.gss_id || '';
            }
            
            // 5. Для Report Summary загружаем данные об установке
            let installationData = null;
            if (engine.aircraft && engine.position) {
                try {
                    const installRes = await fetch(`/api/history/INSTALL${noCache()}`);
                    if (installRes.ok) {
                        const installations = await installRes.json();
                        // Ищем установку этого двигателя на ТЕКУЩИЙ самолет
                        installationData = installations
                            .filter(inst => {
                                return (inst.original_sn === engine.original_sn || 
                                        inst.current_sn === engine.current_sn ||
                                        inst.original_sn === engine.current_sn ||
                                        inst.current_sn === engine.original_sn) &&
                                       inst.install_to === engine.aircraft;
                            })
                            .sort((a, b) => new Date(b.date) - new Date(a.date))[0];
                    }
                } catch (e) {
                    console.warn('Could not load installation history:', e);
                }
            }
            
            // 6. Сохраняем данные для использования в report
            window.boroscopeEngineData = {
                engine: engine,
                installation: installationData,
                selectedOrigSN: origSN
            };
            
            // 7. Проверяем текущую установку
            const isInstalled = engine.aircraft && engine.position;
            
            if (aircraftSelect) {
                if (isInstalled) {
                    aircraftSelect.innerHTML = `<option value="${engine.aircraft}">${engine.aircraft}</option>`;
                    aircraftSelect.value = engine.aircraft;
                    aircraftSelect.disabled = true;
                } else {
                    aircraftSelect.innerHTML = '<option value="">-- не установлен --</option>';
                    aircraftSelect.value = '';
                    aircraftSelect.disabled = true;
                }
            }
            
            if (posSelect) {
                if (isInstalled) {
                    posSelect.value = String(engine.position);
                    posSelect.disabled = true;
                } else {
                    posSelect.value = '';
                    posSelect.disabled = true;
                }
            }
            
            console.log('✅ Orig SN Selected:', origSN);
            console.log('   Current SN:', engine.current_sn);
            console.log('   Aircraft:', engine.aircraft, 'Position:', engine.position);
            
            // 8. Обновляем report блок
            updateBoroscopeReport();
            
        } catch (error) {
            console.error('Error loading engine data for Borescope:', error);
            window.boroscopeEngineData = null;
            updateBoroscopeReport();
        }
    }

    // Функция обновления Boroscope Report блока
    function updateBoroscopeReport() {
        const reportDiv = document.getElementById('boroscope-report-block');
        if (!reportDiv) return;
        
        const date = document.getElementById('bore-date').value;
        const origSN = document.getElementById('bore-orig-sn').value;
        const currentSN = document.getElementById('bore-current-sn').value;
        const gssId = document.getElementById('bore-gss').value;
        const position = document.getElementById('bore-position').value;
        const aircraft = document.getElementById('bore-aircraft').value;
        
        const engineData = window.boroscopeEngineData;
        
        let html = `
            <div class="border rounded p-3 bg-light mb-4">
                <h5 class="mb-3">Borescope Report Summary</h5>
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>Date:</strong> <span id="report-date">${date || '—'}</span></p>
                        <p><strong>Orig S/N:</strong> <span id="report-orig-sn">${origSN || '—'}</span></p>
                        <p><strong>Current S/N:</strong> <span id="report-current-sn">${currentSN || '—'}</span></p>
                        <p><strong>GSS ID:</strong> <span id="report-gss">${gssId || '—'}</span></p>
                        <p><strong>Aircraft:</strong> <span id="report-aircraft" style="font-weight: bold; color: #0066cc;">${aircraft || '—'}</span></p>
                        <p><strong>Position:</strong> <span id="report-position">${position || '—'}</span></p>
                    </div>
                    <div class="col-md-6">
        `;
        
        if (engineData && engineData.installation) {
            const inst = engineData.installation;
            const eng = engineData.engine;
            
            // ✅ Показываем дату установки и поставщика (Aircraft и Position уже показаны выше)
            html += `
                        <p><strong>Installation Date:</strong> <span style="color: #d9534f;">${inst.date || '—'}</span></p>
                        <p><strong>Supplier:</strong> <span>${inst.location_from || inst.supplier || '—'}</span></p>
            `;
        } else if (engineData && engineData.engine) {
            // Двигатель найден но не установлен на самолет
            html += `
                        <p class="text-muted">Engine not currently installed on aircraft</p>
                        <p class="text-muted">Only Serial Number and GSS ID available</p>
            `;
        } else {
            html += `
                        <p class="text-muted">Select an engine to see details</p>
            `;
        }
        
        html += `
                    </div>
                </div>
            </div>
        `;
        
        reportDiv.innerHTML = html;
    }

    // Функция очистки report
    function clearBoroscopeReport() {
        const reportDiv = document.getElementById('boroscope-report-block');
        if (reportDiv) {
            reportDiv.innerHTML = '';
        }
        window.boroscopeEngineData = null;
    }

    // === INSPECTION PHOTOS TABLE FUNCTIONS ===
    
    let inspectionPhotosData = []; // Массив для хранения фото

    // Добавить строку в таблицу
    function addInspectionPhotoRow() {
        const tbody = document.getElementById('inspection-photos-tbody');
        if (!tbody) return;
        
        const rowId = Date.now(); // Уникальный ID строки
        const row = document.createElement('tr');
        row.setAttribute('data-row-id', rowId);
        
        row.innerHTML = `
            <td>
                <input type="text" class="form-control form-control-sm" placeholder="HPT, LPT, etc" data-row-id="${rowId}" data-type="label">
            </td>
            <td>
                <div class="inspection-photo-cell" onclick="selectPhoto(${rowId}, 1)">
                    <div class="inspection-photo-placeholder">
                        <i class="bi bi-image" style="font-size: 2rem;"></i><br>
                        Click or drag photo
                    </div>
                </div>
                <input type="file" id="photo-input-${rowId}-1" accept="image/*" style="display: none;" onchange="handlePhotoSelect(${rowId}, 1, event)">
            </td>
            <td>
                <div class="inspection-photo-cell" onclick="selectPhoto(${rowId}, 2)">
                    <div class="inspection-photo-placeholder">
                        <i class="bi bi-image" style="font-size: 2rem;"></i><br>
                        Click or drag photo
                    </div>
                </div>
                <input type="file" id="photo-input-${rowId}-2" accept="image/*" style="display: none;" onchange="handlePhotoSelect(${rowId}, 2, event)">
            </td>
            <td>
                <button type="button" class="btn btn-sm btn-danger" onclick="removeInspectionPhotoRow(${rowId})">
                    <i class="bi bi-trash"></i>
                </button>
            </td>
        `;
        
        tbody.appendChild(row);
        
        // Добавляем drag-and-drop для этой строки
        setupDragAndDrop(rowId);
    }

    // Настройка drag-and-drop для ячеек фото
    function setupDragAndDrop(rowId) {
        [1, 2].forEach(photoNum => {
            const cell = document.querySelector(`tr[data-row-id="${rowId}"] td:nth-child(${photoNum + 1}) .inspection-photo-cell`);
            if (!cell) return;
            
            cell.addEventListener('dragover', (e) => {
                e.preventDefault();
                cell.style.borderColor = '#0d6efd';
                cell.style.background = '#e7f1ff';
            });
            
            cell.addEventListener('dragleave', (e) => {
                e.preventDefault();
                cell.style.borderColor = '#ccc';
                cell.style.background = '#f8f9fa';
            });
            
            cell.addEventListener('drop', (e) => {
                e.preventDefault();
                cell.style.borderColor = '#ccc';
                cell.style.background = '#f8f9fa';
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handlePhotoFile(rowId, photoNum, files[0]);
                }
            });
        });
    }

    // Открыть диалог выбора файла
    function selectPhoto(rowId, photoNum) {
        const input = document.getElementById(`photo-input-${rowId}-${photoNum}`);
        if (input) input.click();
    }

    // Обработка выбора фото
    function handlePhotoSelect(rowId, photoNum, event) {
        const file = event.target.files[0];
        if (file) {
            handlePhotoFile(rowId, photoNum, file);
        }
    }

    // Обработка файла фото (сохранение File объекта + preview)
    function handlePhotoFile(rowId, photoNum, file) {
        if (!file.type.startsWith('image/')) {
            showErrorNotification('Please select an image file');
            return;
        }
        
        // Ограничение размера (например, 5MB)
        if (file.size > 5 * 1024 * 1024) {
            showErrorNotification('Image size must be less than 5MB');
            return;
        }
        
        // Сохраняем File объект напрямую (не конвертируем в base64)
        const existingIndex = inspectionPhotosData.findIndex(p => p.rowId === rowId && p.photoNum === photoNum);
        if (existingIndex >= 0) {
            inspectionPhotosData[existingIndex].file = file;
        } else {
            inspectionPhotosData.push({ rowId, photoNum, file });
        }
        
        // Создаем превью через URL.createObjectURL
        const previewUrl = URL.createObjectURL(file);
        updatePhotoPreview(rowId, photoNum, previewUrl);
        
        console.log(`✅ Photo added: rowId=${rowId}, photoNum=${photoNum}, file=${file.name}`);
    }

    // Обновление превью фото
    function updatePhotoPreview(rowId, photoNum, previewUrl) {
        const cell = document.querySelector(`tr[data-row-id="${rowId}"] td:nth-child(${photoNum + 1}) .inspection-photo-cell`);
        if (!cell) return;
        
        cell.classList.add('has-photo');
        cell.innerHTML = `
            <img src="${previewUrl}" class="inspection-photo-preview" alt="Photo ${photoNum}">
            <button type="button" class="inspection-photo-remove" onclick="removePhoto(${rowId}, ${photoNum}); event.stopPropagation();">
                <i class="bi bi-x"></i>
            </button>
        `;
    }

    // Удалить фото
    function removePhoto(rowId, photoNum) {
        // Удаляем из массива
        const index = inspectionPhotosData.findIndex(p => p.rowId === rowId && p.photoNum === photoNum);
        if (index >= 0) {
            inspectionPhotosData.splice(index, 1);
        }
        
        // Восстанавливаем placeholder
        const cell = document.querySelector(`tr[data-row-id="${rowId}"] td:nth-child(${photoNum + 1}) .inspection-photo-cell`);
        if (!cell) return;
        
        cell.classList.remove('has-photo');
        cell.innerHTML = `
            <div class="inspection-photo-placeholder">
                <i class="bi bi-image" style="font-size: 2rem;"></i><br>
                Click or drag photo
            </div>
        `;
    }

    // Удалить всю строку
    function removeInspectionPhotoRow(rowId) {
        const row = document.querySelector(`tr[data-row-id="${rowId}"]`);
        if (row) row.remove();
        
        // Удаляем фото этой строки из массива
        inspectionPhotosData = inspectionPhotosData.filter(p => p.rowId !== rowId);
    }

    // Собрать данные таблицы для отправки
    function getInspectionPhotosTableData() {
        const tbody = document.getElementById('inspection-photos-tbody');
        if (!tbody) return [];
        
        const rows = tbody.querySelectorAll('tr');
        const data = [];
        
        rows.forEach(row => {
            const rowId = parseInt(row.getAttribute('data-row-id'));
            const labelInput = row.querySelector('input[data-type="label"]');
            const label = labelInput ? labelInput.value.trim() : '';
            
            // Находим фото для этой строки
            const photo1 = inspectionPhotosData.find(p => p.rowId === rowId && p.photoNum === 1);
            const photo2 = inspectionPhotosData.find(p => p.rowId === rowId && p.photoNum === 2);
            
            if (label || photo1 || photo2) {
                data.push({
                    label: label,
                    photo1: photo1 ? photo1.base64 : null,
                    photo2: photo2 ? photo2.base64 : null
                });
            }
        });
        
        return data;
    }

    // Очистить таблицу фото
    function clearInspectionPhotosTable() {
        const tbody = document.getElementById('inspection-photos-tbody');
        if (tbody) tbody.innerHTML = '';
        inspectionPhotosData = [];
    }

// --- PURCHASE ORDERS MODULE LOGIC ---

    let customColumns = []; // Хранилище пользовательских колонок

    async function openPurchaseOrdersView() {
        hideAllViews();
        document.getElementById('view-purchase-orders').style.display = 'block';
        updateHistory('purchase-orders');
        await loadCustomColumns();
        await loadPurchaseOrdersHistory();
    }

    function switchPurchaseOrdersTab(tabName) {
        if (tabName === 'info') {
            document.getElementById('tab-po-info').style.display = 'block';
            document.getElementById('tab-po-entry').style.display = 'none';
            document.getElementById('tab-po-info-btn').classList.add('active');
            document.getElementById('tab-po-entry-btn').classList.remove('active');
            loadPurchaseOrdersHistory();
        } else {
            document.getElementById('tab-po-info').style.display = 'none';
            document.getElementById('tab-po-entry').style.display = 'block';
            document.getElementById('tab-po-info-btn').classList.remove('active');
            document.getElementById('tab-po-entry-btn').classList.add('active');
            preparePurchaseOrderForm();
        }
    }

    async function loadPurchaseOrdersHistory() {
        const tbody = document.getElementById('purchase-orders-history-body');
        if (!tbody) {
            console.error('❌ purchase-orders-history-body not found');
            return;
        }
        
        // Убедимся, что customColumns это массив
        if (!customColumns) customColumns = [];
        
        // Определяем количество колонок (10 базовых + пользовательские + кнопка плюс)
        const totalCols = 10 + (customColumns.length || 0) + 1;
        tbody.innerHTML = `<tr><td colspan="${totalCols}" class="text-center text-muted py-3">Loading…</td></tr>`;

        console.log('🔄 Fetching purchase orders...');
        const url = '/api/history/PURCHASE_ORDER?t=' + Date.now();
        console.log('URL:', url);
        let res = await fetch(url, {
            method: 'GET',
            cache: 'no-store',
            headers: {
                'Cache-Control': 'no-cache, no-store, must-revalidate',
                'Pragma': 'no-cache',
                'Expires': '0'
            }
        });
        console.log('📡 Response received:', res ? res.status : 'null', res ? res.statusText : '');

        if (!res || !res.ok) {
            console.error('❌ Error loading purchase orders', res && res.status);
            tbody.innerHTML = `<tr><td colspan="${totalCols}" class="text-center text-danger py-3">Unable to load purchase orders</td></tr>`;
            return;
        }

        let serverData = [];
        try { 
            const text = await res.text();
            console.log('📄 Raw response:', text.substring(0, 500));
            serverData = JSON.parse(text); 
            console.log('📦 Parsed data:', serverData);
        } catch (e) { 
            console.error('❌ JSON parse error:', e);
            serverData = []; 
        }
        
        console.log('📊 Purchase orders data:', serverData);
        
        // Load custom column data for all purchase orders
        let customDataMap = {};
        if (customColumns && customColumns.length > 0) {
            try {
                const customDataRes = await fetch('/api/purchase-order-custom-data' + noCache());
                if (customDataRes.ok) {
                    const customDataArray = await customDataRes.json();
                    // Group by purchase_order_id
                    customDataArray.forEach(item => {
                        if (!customDataMap[item.purchase_order_id]) {
                            customDataMap[item.purchase_order_id] = {};
                        }
                        customDataMap[item.purchase_order_id][item.column_key] = item.value;
                    });
                }
            } catch (error) {
                console.error('⚠️ Error loading custom column data:', error);
            }
        }

        tbody.innerHTML = '';
        if (!Array.isArray(serverData) || serverData.length === 0) {
            console.warn('⚠️ No purchase orders found');
            tbody.innerHTML = `<tr><td colspan="${totalCols}" class="text-center text-muted py-3">No purchase orders found</td></tr>`;
            return;
        }

        serverData.sort((a, b) => (b.id || 0) - (a.id || 0));
        serverData.forEach(row => {
            const linkHtml = row.link ? `<a href="${row.link}" target="_blank" class="btn btn-sm btn-outline-success"><i class="bi bi-link-45deg"></i></a>` : '-';
            const priceText = row.price !== null && row.price !== undefined ? row.price : '-';
            
            // Собираем HTML для пользовательских колонок
            let customColsHtml = '';
            if (customColumns && Array.isArray(customColumns)) {
                customColumns.forEach(col => {
                    const value = (customDataMap[row.id] && customDataMap[row.id][col.column_key]) || '';
                    customColsHtml += `<td data-column-key="${col.column_key}">${value}</td>`;
                });
            }
            
            tbody.innerHTML += `
                <tr data-log-id="${row.id || 0}" data-user="${row.user || row.created_by || ''}">
                    <td class="delete-col-purchase-orders" style="display: none;">
                        <button class="btn btn-sm btn-danger" onclick="deleteHistoryRecord('PURCHASE_ORDER', ${row.id || 0}, '')" title="Delete">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                    <td>${row.date}</td>
                    <td>${row.name || '-'}</td>
                    <td>${row.part_number || '-'}</td>
                    <td>${row.serial_number || '-'}</td>
                    <td>${priceText}</td>
                    <td>${row.purpose || '-'}</td>
                    <td>${row.aircraft || '-'}</td>
                    <td>${row.ro_number || '-'}</td>
                    <td>${linkHtml}</td>
                    ${customColsHtml}
                </tr>
            `;
        });
        console.log(`✅ Rendered ${serverData.length} purchase orders`);
    }

    async function preparePurchaseOrderForm() {
        try {
            // Инициализируем дату на сегодня
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('po-date').value = today;
            
            const acRes = await fetch('/api/dashboard/aircraft-details' + noCache());
            if (!acRes.ok) throw new Error('Failed to fetch aircraft');
            
            const aircrafts = await acRes.json();
            
            const acSelect = document.getElementById('po-aircraft');
            acSelect.innerHTML = '<option value="">Select...</option>';
            
            if (Array.isArray(aircrafts)) {
                aircrafts.forEach(ac => {
                    acSelect.innerHTML += `<option value="${ac.tail_number}">${ac.tail_number}</option>`;
                });
            }
        } catch (err) {
            console.error('Error loading aircraft for Purchase Orders:', err);
            // Fallback - добавляем стандартные самолеты
            const acSelect = document.getElementById('po-aircraft');
            acSelect.innerHTML = `
                <option value="">Select...</option>
                <option value="ER-BAT">ER-BAT</option>
                <option value="ER-BAR">ER-BAR</option>
                <option value="ER-BAQ">ER-BAQ</option>
            `;
        }
    }

    async function submitPurchaseOrderForm() {
        const date = document.getElementById('po-date').value;
        const name = document.getElementById('po-name').value;
        const pn = document.getElementById('po-pn').value;
        const sn = document.getElementById('po-sn').value;
        const price = document.getElementById('po-price').value;
        const purpose = document.getElementById('po-purpose').value;
        const aircraft = document.getElementById('po-aircraft').value;
        const roNumber = document.getElementById('po-ro-number').value;
        const link = document.getElementById('po-link').value;
        
        // Валидация обязательных полей
        if (!date || !name || !purpose || !aircraft || !roNumber) {
            showErrorNotification("Please fill all required fields: Date, Item Name, Purpose, Aircraft, RO Number");
            return;
        }
        
        const payload = {
            date: date,
            name: name,
            part_number: pn || '',
            serial_number: sn || '',
            price: price ? parseFloat(price) : null,
            purpose: purpose,
            aircraft: aircraft,
            ro_number: roNumber,
            link: link || ''
        };
        
        try {
            const res = await fetch('/api/history/PURCHASE_ORDER', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            });
            
            let errorMsg = '';
            if (!res.ok) {
                try {
                    const error = await res.json();
                    errorMsg = error.detail || `HTTP ${res.status}`;
                } catch {
                    errorMsg = `HTTP ${res.status}: ${res.statusText}`;
                }
                throw new Error(errorMsg);
            }
            
            // Успешно сохранено
            showSuccessNotification("Purchase order saved successfully!");
            console.log("✅ Purchase order saved, refreshing list...");
            
            // Очищаем форму
            document.getElementById('form-purchase-order').reset();
            
            // Небольшая задержка, чтобы убедиться, что БД обновилась
            await new Promise(resolve => setTimeout(resolve, 500));
            
            // Перезагружаем таблицу с новыми данными
            console.log("📥 Loading purchase orders...");
            await loadPurchaseOrdersHistory();
            console.log("✅ Purchase orders loaded");
            
            // Переключаемся на вкладку истории (БЕЗ повторной загрузки)
            document.getElementById('tab-po-info').style.display = 'block';
            document.getElementById('tab-po-entry').style.display = 'none';
            document.getElementById('tab-po-info-btn').classList.add('active');
            document.getElementById('tab-po-entry-btn').classList.remove('active');
            
        } catch (error) {
            showErrorNotification(`Error: ${error.message}`);
            console.error('Purchase order save error:', error);
        }
    }

    // --- CUSTOM COLUMNS MANAGEMENT ---
    
    async function loadCustomColumns() {
        try {
            const res = await fetch('/api/custom-columns/purchase_orders' + noCache());
            if (!res.ok) throw new Error('Failed to load custom columns');
            customColumns = await res.json();
            
            // Обновляем заголовки таблицы
            updateTableHeaders();
        } catch (error) {
            console.error('Error loading custom columns:', error);
            customColumns = [];
        }
    }
    
    function updateTableHeaders() {
        const headerRow = document.getElementById('purchase-orders-header-row');
        if (!headerRow) return;
        
        // Обновляем встроенные заголовки если у них есть переименованные версии в customColumns
        const builtInKeys = ['date', 'name', 'part_number', 'serial_number', 'price', 'purpose', 'aircraft', 'ro_number', 'link'];
        
        builtInKeys.forEach(key => {
            const override = customColumns.find(c => c.column_key === key);
            if (override) {
                // Ищем встроенную колонку по ondblclick атрибуту
                const allThs = Array.from(headerRow.querySelectorAll('th'));
                for (let i = 0; i < allThs.length; i++) {
                    const ondblclick = allThs[i].getAttribute('ondblclick') || '';
                    if (ondblclick.includes(`editColumnName(this, '${key}')`)) {
                        allThs[i].textContent = override.column_label;
                        break;
                    }
                }
            }
        });
        
        // Удаляем старые пользовательские заголовки (только те что с data-custom-column)
        const existingCustomHeaders = headerRow.querySelectorAll('[data-custom-column]');
        existingCustomHeaders.forEach(th => th.remove());
        
        // Находим кнопку плюс (последнюю ячейку)
        const plusButton = headerRow.querySelector('th:last-child');
        
        // Добавляем новые пользовательские заголовки перед кнопкой плюс (только реальные кастомные)
        const realCustomCols = customColumns.filter(col => !builtInKeys.includes(col.column_key));
        realCustomCols.forEach(col => {
            const th = document.createElement('th');
            th.setAttribute('data-custom-column', col.column_key);
            th.setAttribute('data-column-id', col.id);
            th.ondblclick = function() { editCustomColumnName(this, col.id, col.column_key); };
            
            // Создаем checkbox для выбора столбца (скрыт по умолчанию)
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.className = 'form-check-input column-select-checkbox me-2 d-none';
            checkbox.setAttribute('data-column-id', col.id);
            checkbox.setAttribute('data-column-label', col.column_label);
            checkbox.onchange = checkColumnSelection;
            
            th.appendChild(checkbox);
            th.appendChild(document.createTextNode(col.column_label));
            th.style.cursor = 'pointer';
            th.title = 'Double-click to edit';
            headerRow.insertBefore(th, plusButton);
        });
    }
    
    function checkColumnSelection() {
        const checkboxes = document.querySelectorAll('.column-select-checkbox');
        const anyChecked = Array.from(checkboxes).some(cb => cb.checked);
        const deleteBtn = document.getElementById('delete-column-btn-purchase-orders');
        
        if (deleteBtn) {
            deleteBtn.disabled = !anyChecked;
        }
    }
    
    async function deleteSelectedCustomColumn() {
        const checkboxes = document.querySelectorAll('.column-select-checkbox:checked');
        
        if (checkboxes.length === 0) {
            showErrorNotification('Please select a column to delete');
            return;
        }
        
        const checkbox = checkboxes[0]; // Берем первый выбранный
        const columnId = checkbox.getAttribute('data-column-id');
        const columnLabel = checkbox.getAttribute('data-column-label');
        
        if (!confirm(`Delete column "${columnLabel}"? All data in this column will be permanently lost!`)) {
            return;
        }
        
        try {
            const res = await fetch(`/api/custom-columns/${columnId}`, {
                method: 'DELETE'
            });
            
            if (!res.ok) throw new Error('Failed to delete column');
            
            // Удаляем из локального массива
            const index = customColumns.findIndex(c => c.id === parseInt(columnId));
            if (index > -1) {
                customColumns.splice(index, 1);
            }
            
            // Обновляем таблицу
            updateTableHeaders();
            await loadPurchaseOrdersHistory();
            
            showSuccessNotification(`Column "${columnLabel}" deleted successfully!`);
        } catch (error) {
            showErrorNotification(`Error deleting column: ${error.message}`);
            console.error('Error deleting custom column:', error);
        }
    }
    
    async function addCustomColumn() {
        // Открываем модальное окно
        const modal = new bootstrap.Modal(document.getElementById('add-column-modal'));
        modal.show();
        
        // Очищаем поле ввода и устанавливаем фокус
        setTimeout(() => {
            const input = document.getElementById('new-column-name');
            input.value = '';
            input.focus();
        }, 500);
    }
    
    async function submitAddColumn() {
        const input = document.getElementById('new-column-name');
        const columnName = input.value.trim();
        
        if (!columnName) {
            input.focus();
            return;
        }
        
        try {
            const res = await fetch('/api/custom-columns/purchase_orders', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    column_label: columnName,
                    column_order: customColumns.length
                })
            });
            
            if (!res.ok) throw new Error('Failed to create column');
            
            const newColumn = await res.json();
            customColumns.push(newColumn);
                        // Закрываем модальное окно
                        const modal = bootstrap.Modal.getInstance(document.getElementById('add-column-modal'));
                        modal.hide();
            
            
            updateTableHeaders();
            await loadPurchaseOrdersHistory();
            
            showSuccessNotification(`Column "${columnName}" added successfully!`);
        } catch (error) {
            showErrorNotification(`Error adding column: ${error.message}`);
            console.error('Error adding custom column:', error);
        }
    }
    
    function editColumnName(th, columnKey) {
        // Разрешаем реакцию только в режиме редактирования
        if (!isEditingActive('purchase-orders')) return;
        // Для встроенных колонок также открываем модальное окно редактирования
        // Сохраняем ссылку на элемент th для дальнейшего обновления
        window.currentEditingHeader = th;
        
        // Открываем модальное окно
        const modal = new bootstrap.Modal(document.getElementById('edit-column-modal'));
        modal.show();
        
        // Заполняем форму текущими значениями
        setTimeout(() => {
            document.getElementById('edit-column-id').value = ''; // Для встроенных колонок не будет реального id
            document.getElementById('edit-column-key').value = columnKey;
            const input = document.getElementById('edit-column-name');
            input.value = th.textContent;
            input.focus();
            input.select();
        }, 500);
    }
    
    async function editCustomColumnName(th, columnId, columnKey) {
        // Разрешаем переименование только в режиме редактирования
        if (!isEditingActive('purchase-orders')) return;
        // Сохраняем ссылку на элемент th для дальнейшего обновления
        window.currentEditingHeader = th;
        
        // Открываем модальное окно
        const modal = new bootstrap.Modal(document.getElementById('edit-column-modal'));
        modal.show();
        
        // Заполняем форму текущими значениями
        setTimeout(() => {
            document.getElementById('edit-column-id').value = columnId;
            document.getElementById('edit-column-key').value = columnKey;
            const input = document.getElementById('edit-column-name');
            input.value = th.textContent;
            input.focus();
            input.select();
        }, 500);
    }
    
    async function submitEditColumn() {
        const columnIdVal = document.getElementById('edit-column-id').value;
        const columnKey = document.getElementById('edit-column-key').value;
        const input = document.getElementById('edit-column-name');
        const newName = input.value.trim();
        const currentName = window.currentEditingHeader.textContent;
        
        if (!newName || newName === currentName) {
            const modal = bootstrap.Modal.getInstance(document.getElementById('edit-column-modal'));
            modal.hide();
            return;
        }
        
        try {
            // Для встроенных колонок (когда columnId пустой) создаем или обновляем запись
            const isBuiltIn = !columnIdVal;
            let apiUrl, method, payload;
            
            if (isBuiltIn) {
                // Создаем или обновляем CustomColumn для встроенной колонки
                // Сначала проверяем, существует ли уже запись
                const existingCustomCol = customColumns.find(c => c.column_key === columnKey);
                
                if (existingCustomCol) {
                    apiUrl = `/api/custom-columns/${existingCustomCol.id}`;
                    method = 'PUT';
                } else {
                    apiUrl = `/api/custom-columns/purchase_orders`;
                    method = 'POST';
                }
            } else {
                apiUrl = `/api/custom-columns/${columnIdVal}`;
                method = 'PUT';
            }
            
            payload = {
                column_label: newName
            };
            
            if (isBuiltIn && method === 'POST') {
                payload.column_order = customColumns.length;
            }
            
            const res = await fetch(apiUrl, {
                method: method,
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            });
            
            if (!res.ok) throw new Error('Failed to update column');
            
            const result = await res.json();
            
            // Если это новая запись для встроенной колонки, добавляем её в customColumns
            if (isBuiltIn && method === 'POST') {
                customColumns.push(result);
            }
            
            // Обновляем в локальном массиве для встроенных колонок
            if (isBuiltIn) {
                const col = customColumns.find(c => c.column_key === columnKey);
                if (col) col.column_label = newName;
            } else {
                const col = customColumns.find(c => c.id === parseInt(columnIdVal));
                if (col) col.column_label = newName;
            }
            
            // Обновляем заголовок в таблице
            window.currentEditingHeader.textContent = newName;
            
            // Закрываем модальное окно
            const modal = bootstrap.Modal.getInstance(document.getElementById('edit-column-modal'));
            modal.hide();
            
            showSuccessNotification(`Column renamed to "${newName}" successfully!`);
        } catch (error) {
            showErrorNotification(`Error updating column: ${error.message}`);
            console.error('Error updating column:', error);
        }
    }

    async function deleteColumnFromModal() {
        const columnIdVal = document.getElementById('edit-column-id').value;
        const columnKey = document.getElementById('edit-column-key').value;
        const columnName = document.getElementById('edit-column-name').value;
        
        const isBuiltIn = !columnIdVal;
        
        // Для встроенных колонок запрещаем удаление
        if (isBuiltIn) {
            showErrorNotification('Built-in columns cannot be deleted. You can only rename them.');
            return;
        }

        const columnId = parseInt(columnIdVal, 10);
        if (!Number.isFinite(columnId)) {
            showErrorNotification('Cannot delete column: missing column id. Please reload and try again.');
            return;
        }

        if (!confirm(`Are you sure you want to delete column "${columnName}"?\n\nThis will remove the column and all its data permanently.`)) {
            return;
        }

        try {
            const res = await fetch(`/api/custom-columns/${columnId}`, {
                method: 'DELETE'
            });

            if (!res.ok) {
                const err = await res.json().catch(() => ({}));
                throw new Error(err.detail || 'Failed to delete column');
            }

            // Удаляем из локального массива
            const index = customColumns.findIndex(c => c.id === columnId);
            if (index > -1) customColumns.splice(index, 1);

            // Закрываем модальное окно
            const modal = bootstrap.Modal.getInstance(document.getElementById('edit-column-modal'));
            modal.hide();

            // Обновляем таблицу
            updateTableHeaders();
            await loadPurchaseOrdersHistory();

            showSuccessNotification(`Column "${columnName}" deleted successfully!`);
        } catch (error) {
            showErrorNotification(`Error deleting column: ${error.message}`);
            console.error('Error deleting custom column:', error);
        }
    }
// --- SHIPMENT MODULE LOGIC ---

    async function openShipmentView() {
        hideAllViews();
        document.getElementById('view-shipment').style.display = 'block';
        updateHistory('shipment');
        await loadShipmentHistory();
    }

    function switchShipmentTab(tabName) {
        if (tabName === 'info') {
            document.getElementById('tab-ship-info').style.display = 'block';
            document.getElementById('tab-ship-entry').style.display = 'none';
            document.getElementById('tab-ship-info-btn').classList.add('active');
            document.getElementById('tab-ship-entry-btn').classList.remove('active');
            loadShipmentHistory();
        } else {
            document.getElementById('tab-ship-info').style.display = 'none';
            document.getElementById('tab-ship-entry').style.display = 'block';
            document.getElementById('tab-ship-info-btn').classList.remove('active');
            document.getElementById('tab-ship-entry-btn').classList.add('active');
            prepareShipmentForm();
        }
    }

    async function loadShipmentHistory() {
        const tbody = document.getElementById('shipment-history-body');
        if (!tbody) return;
        tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted py-3">Loading…</td></tr>';

        let res = await safeFetch('/api/history/SHIP' + noCache());
        if (!res || !res.ok) res = await safeFetch('/api/history/SHIP');

        if (!res || !res.ok) {
            console.error('Error loading shipment history', res && res.status);
            tbody.innerHTML = '<tr><td colspan="8" class="text-center text-danger py-3">Unable to load shipment records</td></tr>';
            return;
        }

        let data = [];
        try { data = await res.json(); } catch { data = []; }

        tbody.innerHTML = '';
        if (!Array.isArray(data) || data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">No shipment records</td></tr>';
            return;
        }

        data.sort((a, b) => (b.id || 0) - (a.id || 0));
        data.forEach(row => {
            const identifier = `${row.current_sn || row.original_sn || 'Engine'}`;
            const safeIdentifier = escapeHtml(identifier);
            tbody.innerHTML += `
                <tr data-log-id="${row.id || row.log_id || 0}">
                    <td class="delete-col delete-col-shipment" style="display: none;">
                        <button class="btn btn-sm btn-danger" data-identifier="${safeIdentifier}" onclick="deleteHistoryRecord('SHIP', ${row.id || row.log_id || 0}, this.dataset.identifier || '')" title="Delete">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                    <td>${row.date}</td>
                    <td><strong>${row.current_sn}</strong> <small class="text-muted">(${row.original_sn})</small></td>
                    <td>${row.engine_model || '-'}</td>
                    <td>${row.gss_id || '-'}</td>
                    <td>${row.from}</td>
                    <td><span class="badge bg-info text-white">${row.to}</span></td>
                    <td>${row.remarks || '-'}</td>
                </tr>
            `;
        });
    }

// Обновленная функция подготовки формы
    async function prepareShipmentForm() {
        let engRes = await safeFetch('/api/engines' + noCache());
        if (!engRes || !engRes.ok) engRes = await safeFetch('/api/engines');
        
        let engines = [];
        try { engines = engRes && engRes.ok ? await engRes.json() : []; } catch { engines = []; }
        
        // ИСПРАВЛЕНО: Теперь мы ищем правильный datalist для Shipments
        const datalist = document.getElementById('engine-options-ship');
        if(datalist) {
            datalist.innerHTML = ''; 
            engines.forEach(eng => {
                // Показываем в списке SN и где он сейчас лежит
                datalist.innerHTML += `<option value="${eng.original_sn}">${eng.current_sn} (Сейчас: ${eng.location})</option>`;
            });
        }

        // Логика при вводе двигателя
        document.getElementById('ship-engine-input').oninput = function() {
            // 1. Удаляем русские буквы на лету
            this.value = this.value.replace(/[а-яА-ЯёЁ]/g, '');
            
            const val = this.value;
            const found = engines.find(e => e.original_sn === val);
            
            if (found) {
                // Проверяем статус - INSTALLED двигатели нельзя отправлять (они на крыльях)
                if(found.status === 'INSTALLED') {
                    showErrorNotification(`❌ Engine ${found.original_sn} has status INSTALLED (On Wing). Cannot ship installed engines - remove from aircraft first.`);
                    this.value = '';
                    document.getElementById('ship-engine-id').value = '';
                    document.getElementById('ship-loc-from').value = '';
                    return;
                }
                
                // Если нашли в базе — ставим реальные данные
                document.getElementById('ship-engine-id').value = found.id;
                document.getElementById('ship-loc-from').value = found.location;
            } else {
                // Если не нашли — очищаем ID, но текст оставляем (для теста)
                document.getElementById('ship-engine-id').value = '';
                // Поле "Откуда" можно заполнить вручную
            }
        };

        // Загружаем список локаций (Куда)
        let locRes = await safeFetch('/api/locations' + noCache());
        if (!locRes || !locRes.ok) locRes = await safeFetch('/api/locations');
        
        let locations = [];
        try { locations = locRes && locRes.ok ? await locRes.json() : []; } catch { locations = []; }
        const sel = document.getElementById('ship-dest');
        sel.innerHTML = '';
        locations.forEach(loc => {
            sel.innerHTML += `<option value="${loc.id}">${loc.name} - ${loc.city}</option>`;
        });
    }

   
    async function submitShipmentForm() {
        const date = document.getElementById('ship-date').value;
        const engInputVal = document.getElementById('ship-engine-input').value;
        const engId = document.getElementById('ship-engine-id').value || 0;
        const engineModel = document.getElementById('ship-engine-model').value;
        const gssId = document.getElementById('ship-gss-id').value;
        const destId = document.getElementById('ship-dest').value;
        // Получаем текст назначения для отображения
        const destText = document.getElementById('ship-dest').options[document.getElementById('ship-dest').selectedIndex]?.text || "Dest";

        if(!date || !engInputVal || !destId) {
            alert("Пожалуйста, заполните поля: Дата, Двигатель и Назначение.");
            return;
        }

        const payload = {
            date: date,
            engine_id: parseInt(engId),
            engine_model: engineModel,
            gss_id: gssId,
            to_location_id: parseInt(destId),
            waybill: document.getElementById('ship-wb').value,
            remarks: document.getElementById('ship-rem').value
        };

        try {
            const res = await fetch('/api/actions/ship', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            });

            const result = await handleApiResponse(res, 'Shipment');
            if (!result) return; // Операция не выполнена (warning)

            // Очистка и переключение
            document.getElementById('form-shipment').reset();
            document.getElementById('ship-engine-id').value = '';
            
            document.getElementById('tab-ship-info').style.display = 'block';
            document.getElementById('tab-ship-entry').style.display = 'none';
            document.getElementById('tab-ship-info-btn').classList.add('active');
            document.getElementById('tab-ship-entry-btn').classList.remove('active');
            
            await loadShipmentHistory();
            refreshAfterDataChange();

        } catch(e) {
            alert("Ошибка соединения");
        }
    }  
// --- REMOVE MODULE LOGIC ---
    let localTestRemoves = []; // Временное хранилище

    async function openRemoveView() {
        hideAllViews();
        document.getElementById('view-remove').style.display = 'block';
        updateHistory('remove');
        await loadRemoveHistory();
    }
    
    function switchRemoveTab(tab) {
        if(tab === 'info') {
            document.getElementById('tab-rem-info').style.display = 'block';
            document.getElementById('tab-rem-entry').style.display = 'none';
            document.getElementById('tab-rem-info-btn').classList.add('active');
            document.getElementById('tab-rem-entry-btn').classList.remove('active');
            loadRemoveHistory();
        } else {
            document.getElementById('tab-rem-info').style.display = 'none';
            document.getElementById('tab-rem-entry').style.display = 'block';
            document.getElementById('tab-rem-info-btn').classList.remove('active');
            document.getElementById('tab-rem-entry-btn').classList.add('active');
            prepareRemoveForm();
        }
    }

    async function loadRemoveHistory() {
        const tbody = document.getElementById('remove-history-body');
        if (!tbody) return;
        tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted py-3">Loading…</td></tr>';

        let res = await safeFetch('/api/history/REMOVE' + noCache());
        if (!res || !res.ok) res = await safeFetch('/api/history/REMOVE');

        let serverData = [];
        try { 
            serverData = res && res.ok ? await res.json() : []; 
            console.log('🔍 REMOVE History from server:', serverData);
        } catch { 
            console.warn('⚠️ Error parsing REMOVE history:', arguments);
            serverData = []; 
        }
        
        const allData = [...localTestRemoves, ...serverData];
        console.log('📊 All REMOVE data (local + server):', allData);
        
        tbody.innerHTML = '';
        if(allData.length === 0) {
            console.warn('⚠️ No REMOVE history found');
            tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">No history found</td></tr>';
            return;
        }
        
        console.log('✅ Rendering REMOVE history - ' + allData.length + ' records');
        allData.sort((a, b) => (b.id || 0) - (a.id || 0));
        allData.forEach(row => {
            const isTest = row.isTest ? 'table-warning' : '';
            const ttsnText = row.ttsn !== null && row.ttsn !== undefined ? `${row.ttsn}` : '-';
            const tcsnText = row.tcsn !== null && row.tcsn !== undefined ? `${row.tcsn}` : '-';
            const ttsnAcText = row.ttsn_ac !== null && row.ttsn_ac !== undefined ? `${row.ttsn_ac}` : '-';
            const tcsnAcText = row.tcsn_ac !== null && row.tcsn_ac !== undefined ? `${row.tcsn_ac}` : '-';
            const remarksRemovalText = row.remarks_removal ? `${row.remarks_removal}` : '-';
            const conditionText = row.condition_1_at_removal || '-';
            const gssIdText = row.gss_id || '-';
            const installedPlateText = row.installed_plate_sn || row.current_sn || '-';
            
            console.log('📝 Rendering row:', row);
            
            tbody.innerHTML += `
                <tr class="${isTest}" data-log-id="${row.id || 0}" data-user="${row.user || row.created_by || ''}" onclick="toggleRemovalDetails(this)" style="cursor: pointer;">
                    <td class="delete-col-remove" style="display: none;">
                        <button class="btn btn-sm btn-danger" onclick="deleteHistoryRecord('REMOVE', ${row.id || 0}, '${row.current_sn || row.original_sn}'); event.stopPropagation();" title="Delete">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                    <td>${row.date}</td>
                    <td><strong>${row.current_sn || row.original_sn}</strong></td>
                    <td>${row.to_aircraft || row.from || '-'}</td>
                    <td><span class="badge bg-success text-white" style="color: #ffffff !important;">${row.to || '-'}</span></td>
                    <td>${row.remarks||'-'}</td>
                </tr>
                <tr class="removal-details-row" style="display: none;">
                    <td colspan="6" class="bg-light p-4">
                        <div class="container-fluid">
                            <h6 class="mb-3 border-bottom pb-2"><i class="bi bi-info-circle"></i> Engine Removal Details</h6>
                            
                            <div class="row mb-3">
                                <div class="col-md-3"><strong>Date:</strong> <span class="badge bg-info text-white">${row.date || '-'}</span></div>
                                <div class="col-md-3"><strong>Original SN:</strong> <span class="text-monospace">${row.original_sn || '-'}</span></div>
                                <div class="col-md-3"><strong>Current SN:</strong> <span class="text-monospace">${row.current_sn || '-'}</span></div>
                                <div class="col-md-3"><strong>GSS ID:</strong> <span class="badge bg-primary text-white">${gssIdText}</span></div>
                            </div>
                            
                            <div class="row mb-3">
                                <div class="col-md-4"><strong>From Aircraft:</strong> <span class="badge bg-secondary text-white">${row.to_aircraft || '-'}</span></div>
                                <div class="col-md-4"><strong>From Location:</strong> <span class="badge bg-secondary text-white">${row.from || '-'}</span></div>
                                <div class="col-md-4"><strong>Sent To:</strong> <span class="badge bg-success text-white">${row.to || '-'}</span></div>
                            </div>
                            
                            <div class="row mb-3">
                                <div class="col-md-3"><strong>TTSN (Engine):</strong> <span class="badge bg-warning text-white">${ttsnText}</span></div>
                                <div class="col-md-3"><strong>TCSN (Engine):</strong> <span class="badge bg-warning text-white">${tcsnText}</span></div>
                                <div class="col-md-3"><strong>TTSN (Aircraft):</strong> <span class="badge bg-warning text-white">${ttsnAcText}</span></div>
                                <div class="col-md-3"><strong>TCSN (Aircraft):</strong> <span class="badge bg-warning text-white">${tcsnAcText}</span></div>
                            </div>
                            
                            <div class="row mb-3">
                                <div class="col-md-4"><strong>Condition 1:</strong> <span class="badge bg-info text-white">${conditionText}</span></div>
                                <div class="col-md-4"><strong>Installed Plate SN:</strong> <span class="text-monospace">${installedPlateText}</span></div>
                                <div class="col-md-4"><strong>Reason:</strong> <span>${row.comments || '-'}</span></div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-12">
                                    <strong>Remarks:</strong>
                                    <p class="border-start ps-3 text-muted">${remarksRemovalText}</p>
                                </div>
                            </div>
                        </div>
                    </td>
                </tr>`;
        });
    }

    function toggleRemovalDetails(row) {
        const detailsRow = row.nextElementSibling;
        if (detailsRow && detailsRow.classList.contains('removal-details-row')) {
            detailsRow.style.display = detailsRow.style.display === 'none' ? 'table-row' : 'none';
        }
    }

    async function prepareRemoveForm() {
        // Загружаем ВСЕ двигатели для поиска, но снимать можем только INSTALLED
        let engRes = await safeFetch('/api/engines' + noCache());
        if (!engRes || !engRes.ok) engRes = await safeFetch('/api/engines');
        
        let engines = [];
        try { engines = engRes && engRes.ok ? await engRes.json() : []; } catch { engines = []; }
        
        // Грузим список самолетов
        let acRes = await safeFetch('/api/fleet' + noCache());
        if (!acRes || !acRes.ok) acRes = await safeFetch('/api/fleet');
        
        let aircrafts = [];
        try { aircrafts = acRes && acRes.ok ? await acRes.json() : []; } catch { aircrafts = []; }
        
        const datalist = document.getElementById('engine-options-rem');
        if(datalist) {
            datalist.innerHTML = '';
            engines.filter(e => e.status === 'INSTALLED').forEach(eng => {
                // Подсказка, где двигатель
                const locInfo = eng.location.includes('Pos') ? eng.location : "Storage"; 
                datalist.innerHTML += `<option value="${eng.original_sn}">${eng.current_sn} (${locInfo})</option>`;
            });
        }

        // Заполняем выпадающий список самолетов
        const acSelect = document.getElementById('rem-aircraft');
        acSelect.innerHTML = '<option value="" selected>Select engine first...</option>';
        aircrafts.forEach(ac => {
            acSelect.innerHTML += `<option value="${ac.tail_number}">${ac.tail_number} - ${ac.model}</option>`;
        });

        // Автозаполнение при вводе + Фильтр Кириллицы + Определение самолета
        const remEngineInput = document.getElementById('rem-engine-input');
        
        // Фильтр кириллицы при вводе
        remEngineInput.addEventListener('input', function() {
            this.value = this.value.replace(/[а-яА-ЯёЁ]/g, ''); // Убираем русские
        });
        
        // Валидация при выборе двигателя
        remEngineInput.addEventListener('change', function() {
            const val = this.value.trim();
            
            if (!val) {
                document.getElementById('rem-engine-id').value = '';
                document.getElementById('rem-loc-from').value = '';
                document.getElementById('rem-gss-id').value = '';
                document.getElementById('rem-aircraft').value = '';
                document.getElementById('rem-aircraft').disabled = true;
                document.getElementById('rem-aircraft').classList.remove('border-success');
                return;
            }
            
            const found = engines.find(e => e.original_sn === val || e.current_sn === val);
            
            if(!found) {
                showErrorNotification(`❌ Engine "${val}" not found in INSTALLED engines list. Please check the serial number or add the engine first.`);
                this.value = '';
                document.getElementById('rem-engine-id').value = '';
                document.getElementById('rem-loc-from').value = '';
                document.getElementById('rem-gss-id').value = '';
                document.getElementById('rem-aircraft').value = '';
                document.getElementById('rem-aircraft').disabled = true;
                document.getElementById('rem-aircraft').classList.remove('border-success');
                return;
            }
            
            // Проверяем статус двигателя
            if(found.status !== 'INSTALLED') {
                showErrorNotification(`❌ Engine ${found.original_sn} cannot be removed! Current status: ${found.status}. Only INSTALLED engines can be removed.`);
                this.value = '';
                document.getElementById('rem-engine-id').value = '';
                document.getElementById('rem-loc-from').value = '';
                document.getElementById('rem-gss-id').value = '';
                document.getElementById('rem-aircraft').value = '';
                document.getElementById('rem-aircraft').disabled = true;
                document.getElementById('rem-aircraft').classList.remove('border-success');
                return;
            }
            
            // Проверяем что двигатель установлен на самолете
            if(!found.aircraft_id || !found.aircraft) {
                showErrorNotification(`❌ Engine ${found.original_sn} is not linked to any aircraft! Cannot remove uninstalled engine. System error - please contact support.`);
                this.value = '';
                document.getElementById('rem-engine-id').value = '';
                document.getElementById('rem-loc-from').value = '';
                document.getElementById('rem-gss-id').value = '';
                document.getElementById('rem-aircraft').value = '';
                document.getElementById('rem-aircraft').disabled = true;
                document.getElementById('rem-aircraft').classList.remove('border-success');
                return;
            }
            
            // Все проверки пройдены - заполняем поля
            document.getElementById('rem-engine-id').value = found.id;
            document.getElementById('rem-loc-from').value = found.location;
            document.getElementById('rem-gss-id').value = found.gss_sn || '-';
            
            const acSelect = document.getElementById('rem-aircraft');
            acSelect.value = found.aircraft;
            acSelect.disabled = false;
            acSelect.classList.add('border-success'); // Зеленая рамка = определено автоматически
        });

        // Грузим локации (куда снять)
        const locRes = await fetch('/api/locations' + noCache());
        const locations = await locRes.json();
        const sel = document.getElementById('rem-dest');
        sel.innerHTML = '';
        locations.forEach(loc => {
            sel.innerHTML += `<option value="${loc.id}">${loc.name}</option>`;
        });
    }

    let _removeSubmitting = false;
    async function submitRemoveForm() {
        if (_removeSubmitting) { return; }
        _removeSubmitting = true;
        const saveBtn = document.querySelector('#tab-rem-entry .btn.btn-danger.px-4');
        if (saveBtn) { saveBtn.disabled = true; saveBtn.dataset._orig = saveBtn.innerHTML; saveBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Saving...'; }
        const date = document.getElementById('rem-date').value;
        const engInput = document.getElementById('rem-engine-input').value;
        const engId = document.getElementById('rem-engine-id').value || 0;
        const destId = document.getElementById('rem-dest').value;
        const destText = document.getElementById('rem-dest').options[document.getElementById('rem-dest').selectedIndex]?.text || "Dest";

        if(!date || !engInput || !destId) { 
            showErrorNotification("Please fill in all required fields: date, engine, and destination location."); 
            return; 
        }
        
        // Проверяем что двигатель выбран из списка (существует в базе)
        if(!engId || engId === '0' || engId === '') {
            showErrorNotification("Please select an engine from the list. Engine must exist in Master Engine List.");
            return;
        }
        
        // Проверяем что двигатель установлен на самолете
        const engineCheckResponse = await fetch('/api/engines');
        const allEngines = await engineCheckResponse.json();
        const selectedEngine = allEngines.find(e => e.id === parseInt(engId));
        
        if (!selectedEngine) {
            showErrorNotification('Selected engine not found in database!');
            return;
        }
        
        if (selectedEngine.status !== 'INSTALLED') {
            showErrorNotification(`Engine ${selectedEngine.original_sn} cannot be removed! Current status: ${selectedEngine.status}. Only INSTALLED engines can be removed.`);
            return;
        }
        
        if (!selectedEngine.aircraft_id) {
            showErrorNotification(`Engine ${selectedEngine.original_sn} is not installed on any aircraft!`);
            return;
        }

        // Parse flight time inputs
        let ttsnValue, ttsnAcValue;
        try {
            ttsnValue = parseFlightTime(document.getElementById('rem-ttsn').value);
            const ttsnAcInput = document.getElementById('rem-ttsn-ac').value;
            ttsnAcValue = ttsnAcInput ? parseFlightTime(ttsnAcInput) : null;
        } catch (e) {
            showErrorNotification(e.message);
            return;
        }
        
        const payload = {
            date: date,
            engine_id: parseInt(engId),
            to_location_id: parseInt(destId),
            reason: document.getElementById('rem-reason').value,
            ttsn: ttsnValue,
            tcsn: parseInt(document.getElementById('rem-tcsn').value) || null,
            ttsn_ac: ttsnAcValue,
            tcsn_ac: parseInt(document.getElementById('rem-tcsn-ac').value) || null,
            remarks: document.getElementById('rem-remarks').value,
            condition_1: document.getElementById('rem-condition-1').value,
            installed_plate_sn: document.getElementById('rem-installed-plate-sn').value || null,
            current_sn: document.getElementById('rem-installed-plate-sn').value || null  // Отправляем как current_sn
        };

        try {
            const res = await fetch('/api/actions/remove', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload)});
            
            const result = await handleApiResponse(res, 'Remove');
            if (!result) return; // Операция не выполнена (warning)

            document.getElementById('form-remove').reset();
            
            document.getElementById('tab-rem-info').style.display = 'block';
            document.getElementById('tab-rem-entry').style.display = 'none';
            document.getElementById('tab-rem-info-btn').classList.add('active');
            document.getElementById('tab-rem-entry-btn').classList.remove('active');
            
            await loadRemoveHistory();
            
            // Обновляем Dashboard карточки (важно для отражения удаления двигателей)
            if (typeof loadDashboardData === 'function') {
                await loadDashboardData();
            }
            
            // Обновляем главную таблицу двигателей (Master Engine List) чтобы показать правильные статусы
            if (typeof loadMainTable === 'function') {
                await loadMainTable();
            }
            
            refreshAfterDataChange();

        } catch(e) { 
            alert("❌ Error: " + e.message); 
        } finally {
            _removeSubmitting = false;
            if (saveBtn) { saveBtn.disabled = false; saveBtn.innerHTML = saveBtn.dataset._orig || 'Confirm Removal'; }
        }
    }    
// --- MASTER ENGINE LOGIC ---
    let isMainEdit = false;

    async function openMainEngineView() {
        hideAllViews();
        document.getElementById('view-main-engine').style.display = 'block';
        updateHistory('master');
        
        // Сбрасываем фильтры и загружаем таблицу
        clearEngineFilters();
        await loadMainTable();
    }

    function switchMainTab(t) {
        if(isMainEdit && t === 'add') { alert("Сначала сохраните изменения (Save Changes)!"); return; }
        document.getElementById('tab-main-list').style.display = t==='list'?'block':'none';
        document.getElementById('tab-main-add').style.display = t==='add'?'block':'none';
        document.getElementById('tab-main-list-btn').className = t==='list'?'nav-link active':'nav-link';
        document.getElementById('tab-main-add-btn').className = t==='add'?'nav-link active':'nav-link';
        
        // Если переключились на список - убедимся что видны ВСЕ двигатели (сбросим фильтры)
        if(t === 'list') {
            clearEngineFilters();
            renderEngineTable(allEnginesData);
        }
        
        // Если переключились на вкладку добавления - загружаем локации
        if(t === 'add') loadLocationsForForm();
    }

    // Сохраняем полный список двигателей для фильтрации
    let allEnginesData = [];
    let engineFilterState = { date: '', status: '', user: '', model: '', esn: '', gss: '', location: '', removed: '', ttMin: '', ttMax: '', tcMin: '', tcMax: '', remarks: '', hasPhoto: false };
    
    function toggleEngineFilter() {
        const panel = document.getElementById('engine-filter-panel');
        const overlay = document.getElementById('engine-filter-overlay');
        const isOpen = panel.style.right === '0px';
        
        if(isOpen) {
            panel.style.right = '-400px';
            overlay.style.display = 'none';
        } else {
            panel.style.right = '0px';
            overlay.style.display = 'block';
            if(Array.isArray(allEnginesData) && allEnginesData.length > 0) {
                updateUsersList(); // Загружаем список пользователей при открытии фильтра
            }
        }
    }
    
    function updateUsersList() {
        const users = new Set(allEnginesData.filter(e => e.performed_by).map(e => e.performed_by));
        const userSelect = document.getElementById('engine-user-filter');
        const currentVal = userSelect.value;
        
        // Сохраняем уже существующие опции
        const options = userSelect.querySelectorAll('option');
        const existingUsers = new Set();
        for(let i = 1; i < options.length; i++) {
            existingUsers.add(options[i].value);
        }
        
        // Добавляем новых пользователей
        users.forEach(user => {
            if(!existingUsers.has(user)) {
                const opt = document.createElement('option');
                opt.value = user;
                opt.textContent = user;
                userSelect.appendChild(opt);
            }
        });
        
        // Восстанавливаем выбранное значение
        userSelect.value = currentVal;
    }
    
    function applyEngineFilters() {
        const dateVal = document.getElementById('engine-date-filter').value;
        const statusVal = document.getElementById('engine-status-filter').value;
        const userVal = document.getElementById('engine-user-filter').value;
        const modelVal = document.getElementById('engine-model-filter').value.toLowerCase();
        const esnVal = document.getElementById('engine-esn-filter').value.toLowerCase();
        const gssVal = document.getElementById('engine-gss-filter').value.toLowerCase();
        const locVal = document.getElementById('engine-location-filter').value.toLowerCase();
        const removedVal = document.getElementById('engine-removed-filter').value.toLowerCase();
        const ttMin = parseFloat(document.getElementById('engine-tt-min').value) || null;
        const ttMax = parseFloat(document.getElementById('engine-tt-max').value) || null;
        const tcMin = parseFloat(document.getElementById('engine-tc-min').value) || null;
        const tcMax = parseFloat(document.getElementById('engine-tc-max').value) || null;
        const remarksVal = document.getElementById('engine-remarks-filter').value.toLowerCase();
        const hasPhoto = document.getElementById('engine-has-photo').checked;
        
        engineFilterState = { date: dateVal, status: statusVal, user: userVal, model: modelVal, esn: esnVal, gss: gssVal, location: locVal, removed: removedVal, ttMin, ttMax, tcMin, tcMax, remarks: remarksVal, hasPhoto };
        
        let filtered = allEnginesData;
        
        if(dateVal) {
            filtered = filtered.filter(eng => {
                const engDate = eng.install_date ? eng.install_date.split('T')[0] : '';
                return engDate === dateVal;
            });
        }
        
        if(statusVal) {
            filtered = filtered.filter(eng => eng.status === statusVal);
        }
        
        if(userVal) {
            filtered = filtered.filter(eng => eng.performed_by === userVal);
        }
        
        if(modelVal) {
            filtered = filtered.filter(eng => (eng.model || '').toLowerCase().includes(modelVal));
        }
        
        if(esnVal) {
            filtered = filtered.filter(eng => (eng.original_sn || '').toLowerCase().includes(esnVal));
        }
        if(gssVal) {
            filtered = filtered.filter(eng => (eng.gss_sn || '').toLowerCase().includes(gssVal));
        }
        
        if(locVal) {
            filtered = filtered.filter(eng => (eng.location || '').toLowerCase().includes(locVal));
        }
        if(removedVal) {
            filtered = filtered.filter(eng => (eng.removed_from || '').toLowerCase().includes(removedVal));
        }
        if(ttMin !== null) {
            filtered = filtered.filter(eng => (typeof eng.tt === 'number' ? eng.tt : parseFloat(eng.tt) || 0) >= ttMin);
        }
        if(ttMax !== null) {
            filtered = filtered.filter(eng => (typeof eng.tt === 'number' ? eng.tt : parseFloat(eng.tt) || 0) <= ttMax);
        }
        if(tcMin !== null) {
            filtered = filtered.filter(eng => (typeof eng.tc === 'number' ? eng.tc : parseFloat(eng.tc) || 0) >= tcMin);
        }
        if(tcMax !== null) {
            filtered = filtered.filter(eng => (typeof eng.tc === 'number' ? eng.tc : parseFloat(eng.tc) || 0) <= tcMax);
        }
        if(hasPhoto) {
            filtered = filtered.filter(eng => !!eng.photo_url);
        }
        
        if(remarksVal) {
            filtered = filtered.filter(eng => (eng.remarks || '').toLowerCase().includes(remarksVal));
        }
        
        renderEngineTable(filtered);
    }
    
    function filterEnginesByDate() {
        applyEngineFilters();
    }
    
    function filterEnginesByStatus() {
        applyEngineFilters();
    }
    
    function filterEnginesByUser() {
        applyEngineFilters();
    }
    
    function clearEngineFilters() {
        document.getElementById('engine-date-filter').value = '';
        document.getElementById('engine-status-filter').value = '';
        document.getElementById('engine-user-filter').value = '';
        document.getElementById('engine-model-filter').value = '';
        document.getElementById('engine-esn-filter').value = '';
        document.getElementById('engine-gss-filter').value = '';
        document.getElementById('engine-location-filter').value = '';
        document.getElementById('engine-removed-filter').value = '';
        document.getElementById('engine-tt-min').value = '';
        document.getElementById('engine-tt-max').value = '';
        document.getElementById('engine-tc-min').value = '';
        document.getElementById('engine-tc-max').value = '';
        document.getElementById('engine-remarks-filter').value = '';
        document.getElementById('engine-has-photo').checked = false;
        engineFilterState = { date: '', status: '', user: '', model: '', esn: '', gss: '', location: '', removed: '', ttMin: '', ttMax: '', tcMin: '', tcMax: '', remarks: '', hasPhoto: false };
        renderEngineTable(allEnginesData);
    }
    
    async function loadMainTable() {
        const tb = document.getElementById('main-engine-body');
        tb.innerHTML = '<tr><td colspan="17" class="text-center"><div class="spinner-border spinner-border-sm text-primary"></div> Loading...</td></tr>';
        
        try {
            console.log('Fetching engines from API...');
            const res = await fetch('/api/engines' + noCache());
            console.log('API response status:', res.status);
            
            if (!res.ok) {
                throw new Error(`API returned ${res.status}`);
            }
            
            const engines = await res.json();
            console.log('Engines received:', engines);
            
            if (!Array.isArray(engines)) {
                throw new Error('API did not return an array');
            }
            
            const deletedIds = getDeletedEngineIds();
            console.log('Deleted IDs from storage:', deletedIds);
            
            // Фильтруем ТОЛЬКО если есть удаленные ID
            let filteredEngines = engines;
            if (deletedIds && deletedIds.length > 0) {
                filteredEngines = engines.filter(eng => {
                    const isDeleted = deletedIds.includes(eng.id);
                    if (isDeleted) console.log('Filtering out engine ID', eng.id);
                    return !isDeleted;
                });
            }
            
            console.log('Filtered engines:', filteredEngines);
            
            allEnginesData = filteredEngines;
            renderEngineTable(filteredEngines);
        } catch(e) {
            console.error('Loading error двигателей:', e);
            tb.innerHTML = '<tr><td colspan="17" class="text-center text-danger">Error loading engines: ' + e.message + '</td></tr>';
        }
    }
    
    function getCondition1BadgeColor(condition) {
        const colorMap = {
            'SV': 'bg-success',
            'US': 'bg-danger',
            'Scrap': 'bg-dark',
            '-': 'bg-light'
        };
        return colorMap[condition] || 'bg-light';
    }
    
    function getCondition2BadgeColor(condition) {
        const colorMap = {
            'New': 'bg-success',
            'Overhauled': 'bg-primary',
            'Repaired': 'bg-warning',
            'Inspected tested': 'bg-info',
            'As removed': 'bg-secondary',
            'AS': 'bg-secondary',
            '-': 'bg-light'
        };
        return colorMap[condition] || 'bg-light';
    }
    
    function renderEngineTable(engines) {
        const tb = document.getElementById('main-engine-body');
        
        console.log('renderEngineTable called with', engines.length, 'engines');
        
        // ПОЛНОСТЬЮ ОЧИЩАЕМ таблицу
        tb.innerHTML = '';
        
        if(engines.length === 0) {
            tb.innerHTML = '<tr><td colspan="17" class="text-center text-muted">No engines found. Add your first engine!</td></tr>';
            console.log('No engines, displaying empty message');
            return;
        }
        
        // Сортируем по ID в обратном порядке (последние добавленные сверху)
        engines.sort((a, b) => (b.id || 0) - (a.id || 0));
        
        let rowsHTML = '';
        
        engines.forEach((eng, idx) => {
            console.log(`Processing engine ${idx + 1}:`, eng);
            
            let badge = 'bg-secondary';
            let statusText = eng.status || '-';
            if(eng.status === 'SV') badge = 'bg-success';
            if(eng.status === 'US') badge = 'bg-danger';
            if(eng.status === 'INSTALLED') badge = 'bg-primary';
            if(eng.status === 'REMOVED') badge = 'bg-warning';
            if(!eng.status || eng.status === '') { badge = 'bg-light'; statusText = '-'; }

            const photo = eng.photo_url ? `<a href="${eng.photo_url}" target="_blank"><i class="bi bi-image"></i></a>` : '-';
            const model = eng.model || '-';
            const location = eng.location || '-';
            const movedFrom = eng.from_location || '-';
            const remarks = eng.remarks || '-';
            const removedFrom = eng.removed_from || '-';
            const installDate = eng.install_date || '-';
            const currentSN = eng.current_sn || eng.original_sn || '-';
            const originalSN = eng.original_sn || '-';
            const gssSN = eng.gss_sn || '-';
            const tt = eng.tt || 0;
            const tc = eng.tc || 0;
            const price = eng.price || '-';
            const condition1 = eng.condition_1 || '-';
            const condition2 = eng.condition_2 || '-';

            rowsHTML += `
                <tr data-engine-id="${eng.id}" 
                    data-original-sn="${originalSN}" 
                    data-current-sn="${currentSN}" 
                    data-gss-sn="${gssSN}" 
                    data-model="${model}" 
                    data-status="${eng.status}"
                    data-condition-1="${condition1}"
                    data-condition-2="${condition2}"
                    data-tt="${tt}"
                    data-tc="${tc}"
                    data-price="${price}"
                    data-location="${location}"
                    data-moved-from="${movedFrom}"
                    data-remarks="${remarks}"
                    data-removed-from="${removedFrom}"
                    data-photo="${eng.photo_url || ''}"
                    data-install-date="${installDate}">
                    <td class="delete-col" style="display: none;">
                        <div class="select-controls">
                            <input type="checkbox" class="form-check-input row-select-delete" title="Select row" />
                            <button class="btn btn-sm btn-danger trash-btn" onclick="deleteEngine(${eng.id}, '${originalSN}')" title="Delete">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </td>
                    <td data-key="date" class="text-center fw-bold">${idx + 1}</td>
                    <td data-key="model">${model}</td>
                    <td data-key="csn" class="fw-bold text-primary">${currentSN}</td>
                    <td data-key="esn">${originalSN}</td>
                    <td data-key="gss" style="cursor: pointer;" 
                        onmouseover="showGSSTooltip(event, '${gssSN}')" 
                        onmouseleave="hideGSSTooltip()"
                        onmousemove="if(gssTooltip) { gssTooltip.style.left = (event.clientX + 15) + 'px'; gssTooltip.style.top = (event.clientY + 15) + 'px'; }">${gssSN}</td>
                    <td data-key="price">${price}</td>
                    <td data-key="status">
                        ${eng.status === 'REMOVED' ? 
                            `<span class="badge ${badge} text-white" 
                                   style="color: #ffffff !important;"
                                   data-bs-toggle="tooltip" 
                                   data-bs-placement="top" 
                                   data-bs-html="true"
                                   title="<strong>GSS ID:</strong> ${gssSN}<br><strong>Original SN:</strong> ${originalSN}<br><strong>Previous Current SN:</strong> ${currentSN}<br><strong>Removed From:</strong> ${removedFrom || 'N/A'}<br><strong>Installed Plate:</strong> ${eng.installed_plate_sn || 'N/A'}"
                                   style="cursor: help;">
                               ${statusText}
                             </span>` 
                            : `<span class="badge ${badge} text-white" style="color: #ffffff !important;">${statusText}</span>`
                        }
                    </td>
                    <td data-key="condition-1"><span class="badge ${getCondition1BadgeColor(condition1)} text-white" style="color: #ffffff !important;">${condition1}</span></td>
                    <td data-key="condition-2"><span class="badge ${getCondition2BadgeColor(condition2)} text-white" style="color: #ffffff !important;">${condition2}</span></td>
                    <td data-key="tt">${tt}</td>
                    <td data-key="tc">${tc}</td>
                    <td data-key="location" data-location-id="${eng.location_id || ''}">${location}</td>
                    <td data-key="moved">${movedFrom}</td>
                    <td data-key="removed">${removedFrom}</td>
                    <td data-key="rem">${remarks}</td>
                    <td data-key="photo">${photo}</td>
                </tr>
            `;
        });
        
        tb.innerHTML = rowsHTML;
        console.log('Table rendered with', engines.length, 'rows');
        
        // Initialize Bootstrap tooltips for REMOVED status badges
        document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach(tooltipEl => {
            new bootstrap.Tooltip(tooltipEl);
        });
    }

    // --- EDIT MODE LOGIC ---
    function toggleEditMode() {
        isMainEdit = true;
        // Переключаем видимость кнопок
        document.getElementById('btn-main-edit').classList.add('d-none');
        document.getElementById('btn-main-save').classList.remove('d-none');
        document.getElementById('btn-main-cancel').classList.remove('d-none');
        const btnDelSel = document.getElementById('btn-main-delete-selected');
        if (btnDelSel) btnDelSel.classList.remove('d-none');
        document.getElementById('add-row-btn').classList.remove('d-none'); // Показываем плюс

        // Показываем колонку с корзинами
        document.querySelectorAll('.delete-col').forEach(el => el.style.display = 'table-cell');
        const selAll = document.getElementById('select-all-delete');
        if (selAll) selAll.checked = false;

        // Превращаем ячейки в поля ввода
        const rows = document.querySelectorAll('#main-engine-body tr');
        rows.forEach(tr => {
            tr.classList.add('editing-row');
            
            // Получаем данные из data-атрибутов строки
            const rowData = {
                date: tr.getAttribute('data-install-date') || '',
                model: tr.getAttribute('data-model') || '-',
                currentSN: tr.getAttribute('data-current-sn') || '',
                originalSN: tr.getAttribute('data-original-sn') || '',
                gssSN: tr.getAttribute('data-gss-sn') || '',
                status: tr.getAttribute('data-status') || 'SV',
                condition1: tr.getAttribute('data-condition-1') || '-',
                condition2: tr.getAttribute('data-condition-2') || '-',
                tt: tr.getAttribute('data-tt') || '0',
                tc: tr.getAttribute('data-tc') || '0',
                price: tr.getAttribute('data-price') || '0',
                location: tr.getAttribute('data-location') || 'SHJ',
                movedFrom: tr.getAttribute('data-moved-from') || '',
                remarks: tr.getAttribute('data-remarks') || '',
                removedFrom: tr.getAttribute('data-removed-from') || '',
                photo: tr.getAttribute('data-photo') || ''
            };
            
            Array.from(tr.children).forEach(td => {
                const key = td.getAttribute('data-key');
                if(!key) return; // Пропускаем delete-col
                
                let inputHTML = '';
                
                if (key === 'date') {
                    inputHTML = `<input type="date" class="editing-input" value="${rowData.date && rowData.date !== '-' ? rowData.date : ''}">`;
                } else if (key === 'model') {
                    inputHTML = `<input type="text" class="editing-input" value="${rowData.model}">`;
                } else if (key === 'csn') {
                    inputHTML = `<input type="text" class="editing-input" value="${rowData.currentSN || rowData.originalSN}">`;
                } else if (key === 'esn') {
                    inputHTML = `<input type="text" class="editing-input" value="${rowData.originalSN}">`;
                } else if (key === 'gss') {
                    inputHTML = `<input type="text" class="editing-input" value="${rowData.gssSN}">`;
                } else if (key === 'price') {
                    inputHTML = `<input type="number" class="editing-input" step="0.01" value="${rowData.price}">`;
                } else if (key === 'status') {
                    inputHTML = `
                        <select class="editing-input">
                            <option value="" ${!rowData.status || rowData.status === '-' ? 'selected' : ''}>-</option>
                            <option value="INSTALLED" ${rowData.status === 'INSTALLED' ? 'selected' : ''}>INSTALLED</option>
                            <option value="REMOVED" ${rowData.status === 'REMOVED' ? 'selected' : ''}>REMOVED</option>
                        </select>`;
                } else if (key === 'condition-1') {
                    inputHTML = `
                        <select class="editing-input">
                            <option value="-" ${rowData.condition1 === '-' || !rowData.condition1 ? 'selected' : ''}>-</option>
                            <option value="SV" ${rowData.condition1 === 'SV' ? 'selected' : ''}>SV</option>
                            <option value="US" ${rowData.condition1 === 'US' ? 'selected' : ''}>US</option>
                            <option value="Scrap" ${rowData.condition1 === 'Scrap' ? 'selected' : ''}>Scrap</option>
                        </select>`;
                } else if (key === 'condition-2') {
                    inputHTML = `
                        <select class="editing-input">
                            <option value="-" ${rowData.condition2 === '-' || !rowData.condition2 ? 'selected' : ''}>-</option>
                            <option value="New" ${rowData.condition2 === 'New' ? 'selected' : ''}>New</option>
                            <option value="Overhauled" ${rowData.condition2 === 'Overhauled' ? 'selected' : ''}>Overhauled</option>
                            <option value="Repaired" ${rowData.condition2 === 'Repaired' ? 'selected' : ''}>Repaired</option>
                            <option value="Inspected tested" ${rowData.condition2 === 'Inspected tested' ? 'selected' : ''}>Inspected tested</option>
                            <option value="As removed" ${rowData.condition2 === 'As removed' || rowData.condition2 === 'AS' ? 'selected' : ''}>As removed</option>
                        </select>`;
                } else if (key === 'tt') {
                    inputHTML = `<input type="number" class="editing-input" value="${rowData.tt}">`;
                } else if (key === 'tc') {
                    inputHTML = `<input type="number" class="editing-input" value="${rowData.tc}">`;
                } else if (key === 'location') {
                    const locationId = td.getAttribute('data-location-id') || '';
                    inputHTML = `<select class="editing-input location-select" data-location-id="${locationId}"></select>`;
                } else if (key === 'moved') {
                    const value = rowData.movedFrom || tr.getAttribute('data-moved-from') || '';
                    inputHTML = `<input type="text" class="editing-input" value="${value}">`;
                } else if (key === 'removed') {
                    inputHTML = `<input type="text" class="editing-input" value="${rowData.removedFrom}">`;
                } else if (key === 'rem') {
                    inputHTML = `<input type="text" class="editing-input" value="${rowData.remarks}">`;
                } else if (key === 'photo') {
                    inputHTML = `<input type="text" class="editing-input" value="${rowData.photo}" placeholder="Link">`;
                } else {
                    const oldVal = td.innerText;
                    inputHTML = `<input type="text" class="editing-input" value="${oldVal}">`;
                }
                
                td.innerHTML = inputHTML;
            });
        });
        
        // Загружаем location dropdown для всех location-select
        loadLocationSelectsInTable();
    }
    
    async function loadLocationSelectsInTable() {
        try {
            const res = await fetch('/api/locations');
            if (!res.ok) return;
            const locations = await res.json();
            
            document.querySelectorAll('.location-select').forEach(select => {
                const currentLocationId = select.getAttribute('data-location-id');
                select.innerHTML = '<option value="">- Select -</option>';
                locations.forEach(loc => {
                    const selected = loc.id == currentLocationId ? 'selected' : '';
                    select.innerHTML += `<option value="${loc.id}" ${selected}>${loc.name}</option>`;
                });
            });
        } catch (err) {
            console.error('Failed to load locations:', err);
        }
    }

    function addEmptyRow() {
        // Добавляет пустую строку для заполнения вручную
        const tb = document.getElementById('main-engine-body');
        const newRow = document.createElement('tr');
        newRow.className = 'editing-row table-success';
        newRow.setAttribute('data-engine-id', '0'); // Новая строка, ID = 0
        
        newRow.innerHTML = `
            <td class="delete-col" style="display: table-cell;">
                <button class="btn btn-sm btn-danger" onclick="this.closest('tr').remove()" title="Delete">
                    <i class="bi bi-trash"></i>
                </button>
            </td>
            <td data-key="date"><input type="date" class="editing-input"></td>
            <td data-key="model"><input type="text" class="editing-input"></td>
            <td data-key="csn"><input type="text" class="editing-input" placeholder="Current SN"></td>
            <td data-key="esn"><input type="text" class="editing-input" placeholder="Orig. SN"></td>
            <td data-key="gss"><input type="text" class="editing-input" placeholder="GSS ID"></td>
            <td data-key="price"><input type="number" class="editing-input" step="0.01" value=""></td>
            <td data-key="status"><select class="editing-input"><option value="">-</option><option>INSTALLED</option><option>REMOVED</option></select></td>
            <td data-key="condition-1"><select class="editing-input"><option value="-">-</option><option>SV</option><option>US</option><option>Scrap</option></select></td>
            <td data-key="condition-2"><select class="editing-input"><option value="-">-</option><option>New</option><option>Overhauled</option><option>Repaired</option><option>Inspected tested</option><option>As removed</option></select></td>
            <td data-key="tt"><input type="number" class="editing-input" value="0"></td>
            <td data-key="tc"><input type="number" class="editing-input" value="0"></td>
            <td data-key="location"><select class="editing-input location-select"></select></td>
            <td data-key="moved"><input type="text" class="editing-input"></td>
            <td data-key="removed"><input type="text" class="editing-input"></td>
            <td data-key="rem"><input type="text" class="editing-input"></td>
            <td data-key="photo"><input type="text" class="editing-input"></td>
        `;
        tb.appendChild(newRow);
        loadLocationSelectsInTable();
    }

    async function saveEditMode() {
        // Собираем данные из всех строк
        const rows = document.querySelectorAll('#main-engine-body tr.editing-row');
        const updatePromises = [];
        const createPromises = [];
        
        for (const tr of rows) {
            const cells = tr.querySelectorAll('td');
            if(cells.length === 0) continue;
            
            const engineId = tr.getAttribute('data-engine-id');
            
            // Берем значения по data-key вместо жестких индексов
            const dateInput = tr.querySelector('td[data-key="date"] .editing-input');
            const modelInput = tr.querySelector('td[data-key="model"] .editing-input');
            const csnInput = tr.querySelector('td[data-key="csn"] .editing-input');
            const esnInput = tr.querySelector('td[data-key="esn"] .editing-input');
            const gssInput = tr.querySelector('td[data-key="gss"] .editing-input');
            const priceInput = tr.querySelector('td[data-key="price"] .editing-input');
            const statusInput = tr.querySelector('td[data-key="status"] .editing-input');
            const condition1Input = tr.querySelector('td[data-key="condition-1"] .editing-input');
            const condition2Input = tr.querySelector('td[data-key="condition-2"] .editing-input');
            const ttInput = tr.querySelector('td[data-key="tt"] .editing-input');
            const tcInput = tr.querySelector('td[data-key="tc"] .editing-input');
            const locationInput = tr.querySelector('td[data-key="location"] .editing-input');
            const movedInput = tr.querySelector('td[data-key="moved"] .editing-input');
            const removedInput = tr.querySelector('td[data-key="removed"] .editing-input');
            const remarksInput = tr.querySelector('td[data-key="rem"] .editing-input');
            const photoInput = tr.querySelector('td[data-key="photo"] .editing-input');
            
            const originalSN = esnInput ? esnInput.value.trim() : '';
            const currentSN = csnInput ? csnInput.value.trim() : '';
            
            if (!originalSN) continue; // Пропускаем пустые строки
            
            const engineData = {
                date: dateInput ? dateInput.value : '',
                model: modelInput ? modelInput.value : '',
                current_sn: currentSN || originalSN,
                original_sn: originalSN,
                gss_sn: gssInput ? gssInput.value || originalSN : originalSN,
                price: priceInput ? parseFloat(priceInput.value) || null : null,
                status: statusInput ? (statusInput.value ? statusInput.value.trim() : '-') : '-',
                condition_1: condition1Input ? (condition1Input.value ? condition1Input.value.trim() : '-') : '-',
                condition_2: condition2Input ? (condition2Input.value ? condition2Input.value.trim() : '-') : '-',
                total_time: ttInput ? parseFloat(ttInput.value) || 0 : 0,
                total_cycles: tcInput ? parseInt(tcInput.value) || 0 : 0,
                location_id: locationInput ? parseInt(locationInput.value) || null : null,
                from_location: movedInput ? movedInput.value || null : null,
                removed_from: removedInput ? removedInput.value || null : null,
                remarks: remarksInput ? remarksInput.value : '',
                photo_url: photoInput ? photoInput.value : ''
            };
            
            console.log('Saving engine:', engineId, engineData);
            
            if (engineId === '0') {
                // Новая запись - создаем через POST
                createPromises.push(
                    fetch(`/api/engines?user_id=${currentUser.id}`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(engineData)
                    }).then(async (response) => {
                        if (!response.ok) {
                            let errorMsg = 'Create failed';
                            try {
                                const error = await response.json();
                                const errorDetail = error.detail || response.statusText;
                                
                                // Проверяем дублирование Original SN
                                if (errorDetail.includes('duplicate key') && errorDetail.includes('original_sn')) {
                                    const match = errorDetail.match(/Key \(original_sn\)=\(([^)]+)\)/);
                                    const duplicateSN = match ? match[1] : originalSN;
                                    errorMsg = `❌ Cannot create: Original SN "${duplicateSN}" already exists!\n\n💡 Each engine must have a unique Original SN.`;
                                } else {
                                    errorMsg += `: ${errorDetail}`;
                                }
                            } catch {
                                errorMsg += `: ${response.status} ${response.statusText}`;
                            }
                            throw new Error(errorMsg);
                        }
                        return response;
                    })
                );
            } else {
                // Существующая запись - обновляем через PUT
                updatePromises.push(
                    fetch(`/api/engines/${engineId}`, {
                        method: 'PUT',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(engineData)
                    }).then(async (response) => {
                        if (!response.ok) {
                            let errorMsg = `Update failed for engine ${engineId}`;
                            try {
                                const error = await response.json();
                                const errorDetail = error.detail || response.statusText;
                                
                                // Проверяем дублирование Original SN
                                if (errorDetail.includes('duplicate key') && errorDetail.includes('original_sn')) {
                                    const match = errorDetail.match(/Key \(original_sn\)=\(([^)]+)\)/);
                                    const duplicateSN = match ? match[1] : originalSN;
                                    errorMsg = `❌ Cannot save: Original SN "${duplicateSN}" already exists in another engine!\n\n💡 Each engine must have a unique Original SN.`;
                                } else {
                                    errorMsg += `: ${errorDetail}`;
                                }
                            } catch {
                                errorMsg += `: ${response.status} ${response.statusText}`;
                            }
                            throw new Error(errorMsg);
                        }
                        return response;
                    })
                );
            }
        }
        
        try {
            // Выполняем все запросы
            const allPromises = [...createPromises, ...updatePromises];
            
            if (allPromises.length === 0) {
                showErrorNotification('No changes to save. Please edit at least one record.');
                return;
            }
            
            await Promise.all(allPromises);
            
            // Показываем уведомление СРАЗУ после успешного сохранения
            showSuccessNotification(`Successfully saved ${allPromises.length} engine record(s)!`);
            
            // Выходим из режима редактирования
            isMainEdit = false;
            document.getElementById('btn-main-edit').classList.remove('d-none');
            document.getElementById('btn-main-save').classList.add('d-none');
            document.getElementById('btn-main-cancel').classList.add('d-none');
            const btnDelSel = document.getElementById('btn-main-delete-selected');
            if (btnDelSel) btnDelSel.classList.add('d-none');
            document.getElementById('add-row-btn').classList.add('d-none');
            document.querySelectorAll('.delete-col').forEach(el => el.style.display = 'none');
            
            // Даем серверу время обновить данные, затем перезагружаем таблицу
            await new Promise(resolve => setTimeout(resolve, 100));
            
            // Сохраняем параметры фильтра перед перезагрузкой
            const savedFilters = {
                userFilter: document.getElementById('engine-user-filter')?.value || '',
                dateFilter: document.getElementById('engine-date-filter')?.value || '',
                statusFilter: document.getElementById('engine-status-filter')?.value || '',
                modelFilter: document.getElementById('engine-model-filter')?.value || '',
                esnFilter: document.getElementById('engine-esn-filter')?.value || '',
                gssFilter: document.getElementById('engine-gss-filter')?.value || '',
                locationFilter: document.getElementById('engine-location-filter')?.value || '',
                removedFilter: document.getElementById('engine-removed-filter')?.value || '',
                ttMin: document.getElementById('engine-tt-min')?.value || '',
                ttMax: document.getElementById('engine-tt-max')?.value || '',
                tcMin: document.getElementById('engine-tc-min')?.value || '',
                tcMax: document.getElementById('engine-tc-max')?.value || '',
                remarksFilter: document.getElementById('engine-remarks-filter')?.value || '',
                hasPhoto: document.getElementById('engine-has-photo')?.checked || false,
                searchFilter: document.getElementById('main-engine-search')?.value || ''
            };
            
            await loadMainTable();
            
            // Переприменяем фильтры если были установлены
            if (Object.values(savedFilters).some(v => v !== '' && v !== false)) {
                // Восстанавливаем значения фильтров
                if (savedFilters.userFilter && document.getElementById('engine-user-filter')) 
                    document.getElementById('engine-user-filter').value = savedFilters.userFilter;
                if (savedFilters.dateFilter && document.getElementById('engine-date-filter'))
                    document.getElementById('engine-date-filter').value = savedFilters.dateFilter;
                if (savedFilters.statusFilter && document.getElementById('engine-status-filter'))
                    document.getElementById('engine-status-filter').value = savedFilters.statusFilter;
                if (savedFilters.modelFilter && document.getElementById('engine-model-filter'))
                    document.getElementById('engine-model-filter').value = savedFilters.modelFilter;
                if (savedFilters.esnFilter && document.getElementById('engine-esn-filter'))
                    document.getElementById('engine-esn-filter').value = savedFilters.esnFilter;
                if (savedFilters.gssFilter && document.getElementById('engine-gss-filter'))
                    document.getElementById('engine-gss-filter').value = savedFilters.gssFilter;
                if (savedFilters.locationFilter && document.getElementById('engine-location-filter'))
                    document.getElementById('engine-location-filter').value = savedFilters.locationFilter;
                if (savedFilters.removedFilter && document.getElementById('engine-removed-filter'))
                    document.getElementById('engine-removed-filter').value = savedFilters.removedFilter;
                if (savedFilters.ttMin && document.getElementById('engine-tt-min'))
                    document.getElementById('engine-tt-min').value = savedFilters.ttMin;
                if (savedFilters.ttMax && document.getElementById('engine-tt-max'))
                    document.getElementById('engine-tt-max').value = savedFilters.ttMax;
                if (savedFilters.tcMin && document.getElementById('engine-tc-min'))
                    document.getElementById('engine-tc-min').value = savedFilters.tcMin;
                if (savedFilters.tcMax && document.getElementById('engine-tc-max'))
                    document.getElementById('engine-tc-max').value = savedFilters.tcMax;
                if (savedFilters.remarksFilter && document.getElementById('engine-remarks-filter'))
                    document.getElementById('engine-remarks-filter').value = savedFilters.remarksFilter;
                if (document.getElementById('engine-has-photo'))
                    document.getElementById('engine-has-photo').checked = savedFilters.hasPhoto;
                
                // Восстанавливаем простой поиск
                if (savedFilters.searchFilter && document.getElementById('main-engine-search')) {
                    document.getElementById('main-engine-search').value = savedFilters.searchFilter;
                    filterTable('main-engine-body', 'main-engine-search');
                }
                
                // Переприменяем фильтры
                applyEngineFilters();
            }
            
            await loadDashboardData();
            
        } catch (error) {
            showErrorNotification(`Error saving data: ${error.message}`);
            console.error('Save error:', error);
        }
    }

    function cancelEditMode() {
        isMainEdit = false;
        document.getElementById('btn-main-edit').classList.remove('d-none');
        document.getElementById('btn-main-save').classList.add('d-none');
        document.getElementById('btn-main-cancel').classList.add('d-none');
        const btnDelSel = document.getElementById('btn-main-delete-selected');
        if (btnDelSel) btnDelSel.classList.add('d-none');
        document.getElementById('add-row-btn').classList.add('d-none');
        
        // Скрываем колонку с корзинами
        document.querySelectorAll('.delete-col').forEach(el => el.style.display = 'none');
        const selAll = document.getElementById('select-all-delete');
        if (selAll) selAll.checked = false;
        
        // Проверяем есть ли активные фильтры и переприменяем их если нужно
        const statusFilter = document.getElementById('engine-status-filter')?.value || '';
        if (statusFilter || document.getElementById('engine-model-filter')?.value || 
            document.getElementById('engine-gss-filter')?.value) {
            applyEngineFilters(); // Переприменяем фильтры если были
        } else {
            loadMainTable(); // Иначе загружаем всё
        }
    }

    // Выделение всех чекбоксов в колонке удаления
    function toggleSelectAllRows(master) {
        const boxes = document.querySelectorAll('#main-engine-body .row-select-delete');
        boxes.forEach(cb => cb.checked = master.checked);
    }

    // Пакетное удаление выбранных двигателей
    async function bulkDeleteSelected() {
        const selected = Array.from(document.querySelectorAll('#main-engine-body tr'))
            .map(tr => ({
                tr,
                id: parseInt(tr.getAttribute('data-engine-id') || '0', 10),
                sn: tr.getAttribute('data-original-sn') || ''
            }))
            .filter(x => x.id > 0 && x.tr.querySelector('.row-select-delete')?.checked);

        if (selected.length === 0) {
            showErrorNotification('Выберите хотя бы одну строку для удаления.');
            return;
        }

        const sample = selected.slice(0, 5).map(x => x.sn || x.id).join(', ');
        const more = selected.length > 5 ? ` … +${selected.length - 5}` : '';
        const okConfirm = confirm(`Удалить выбранные записи?\n\nВсего: ${selected.length}\nПримеры: ${sample}${more}\n\nЭто действие нельзя отменить.`);
        if (!okConfirm) return;

        try {
            const results = await Promise.allSettled(
                selected.map(x => fetch(`/api/engines/${x.id}?user_id=${currentUser.id}`, { method: 'DELETE' }))
            );
            const ok = results.filter(r => r.status === 'fulfilled' && r.value.ok).length;
            const failed = results.length - ok;

            results.forEach((r, idx) => {
                if (r.status === 'fulfilled' && r.value.ok) {
                    markEngineDeleted(selected[idx].id);
                }
            });

            await loadMainTable();
            await loadDashboardData();

            if (ok > 0) showSuccessNotification(`Удалено: ${ok}. Ошибок: ${failed}.`);
            if (failed > 0) showErrorNotification(`Не удалось удалить ${failed} записи. Возможно, некоторые двигатели установлены (INSTALLED).`);
        } catch (e) {
            showErrorNotification('Ошибка пакетного удаления: ' + e.message);
            console.error('bulk delete error', e);
        }
    }

    // Функция удаления двигателя с подтверждением
    async function deleteEngine(engineId, engineSN) {
        // Создаем красивое модальное окно подтверждения
        const confirmed = confirm(
            `⚠️ ВНИМАНИЕ!\n\n` +
            `Вы действительно хотите удалить двигатель?\n\n` +
            `Serial Number: ${engineSN}\n` +
            `Engine ID: ${engineId}\n\n` +
            `Это действие НЕЛЬЗЯ отменить!\n\n` +
            `Нажмите OK для удаления или Cancel для отмены.`
        );
        
        if (!confirmed) {
            return; // Пользователь нажал "Отмена"
        }
        
        try {
            // Отправляем запрос на удаление
            const res = await fetch(`/api/engines/${engineId}?user_id=${currentUser.id}`, {
                method: 'DELETE'
            });
            
            if (!res.ok) {
                const error = await res.json();
                throw new Error(error.detail || 'Ошибка удаления');
            }
            
            alert('✅ Двигатель успешно удален!');
            markEngineDeleted(engineId);
            
            // Обновляем таблицу и Dashboard
            await loadMainTable();
            await loadDashboardData();
            
        } catch (e) {
            alert('❌ Ошибка при удалении: ' + e.message);
            console.error('Delete error:', e);
        }
    }

    // Функция удаления записи из истории (Install, Shipment, Remove, Repair, Parts, Flight)
    async function deleteHistoryRecord(actionType, logId, identifier) {
        const typeNames = {
            'INSTALL': 'Installation',
            'SHIP': 'Shipment',
            'REMOVE': 'Removal',
            'REPAIR': 'Repair',
            'PARTS': 'Parts',
            'PART_ACTION': 'Parts',
            'FLIGHT': 'Flight',
            'STORE_BALANCE': 'Store Item',
            'BORESCOPE': 'Borescope',
            'PURCHASE_ORDER': 'Purchase Order'
        };
        const typeName = typeNames[actionType] || 'Record';
        if (!logId || String(logId) === '0') {
            showErrorNotification('Unable to delete: invalid record identifier.');
            return false;
        }
        
        // Создаем красивое модальное окно подтверждения
        return new Promise((resolve) => {
            const modal = document.createElement('div');
            modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 9999; display: flex; align-items: center; justify-content: center;';
            
            modal.innerHTML = `
                <div style="background: white; border-radius: 12px; padding: 30px; max-width: 500px; box-shadow: 0 10px 40px rgba(0,0,0,0.3);">
                    <div style="text-align: center; margin-bottom: 20px;">
                        <i class="bi bi-exclamation-triangle-fill" style="font-size: 48px; color: #dc3545;"></i>
                    </div>
                    <h4 style="text-align: center; color: #dc3545; margin-bottom: 15px;">⚠️ Confirm Deletion</h4>
                    <p style="text-align: center; font-size: 16px; color: #333; margin-bottom: 10px;">
                        Are you sure you want to delete this <strong>${typeName}</strong> record?
                    </p>
                    <p style="text-align: center; font-size: 14px; color: #666; margin-bottom: 5px;">
                        <strong>Engine/Item:</strong> ${identifier}
                    </p>
                    <p style="text-align: center; font-size: 14px; color: #dc3545; margin-bottom: 25px; padding: 15px; background: #fff3cd; border-radius: 8px; border-left: 4px solid #dc3545;">
                        ⚠️ <strong>Warning:</strong> This record will be permanently deleted from the database and removed from all views. This action cannot be undone!
                    </p>
                    <div style="display: flex; gap: 15px; justify-content: center;">
                        <button id="confirm-delete-no" style="padding: 10px 30px; background: #6c757d; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 16px;">
                            ❌ Cancel
                        </button>
                        <button id="confirm-delete-yes" style="padding: 10px 30px; background: #dc3545; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 16px;">
                            ✅ Yes, Delete
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            document.getElementById('confirm-delete-yes').onclick = async () => {
                document.body.removeChild(modal);
                
                try {
                    // Get current user name from localStorage
                    const currentUser = localStorage.getItem('currentUser') || 'User';
                    
                    let deleteUrl = `/api/history/${actionType}/${logId}?deleted_by=${encodeURIComponent(currentUser)}`;
                    if (actionType === 'STORE_BALANCE') {
                        deleteUrl = `/api/store-balance/${logId}?deleted_by=${encodeURIComponent(currentUser)}`;
                    } else if (actionType === 'PARTS') {
                        // Parts history uses PART_ACTION in backend
                        deleteUrl = `/api/history/PART_ACTION/${logId}?deleted_by=${encodeURIComponent(currentUser)}`;
                    }

                    const res = await fetch(deleteUrl, {
                        method: 'DELETE'
                    });
                    
                    if (!res.ok) {
                        const error = await res.json();
                        throw new Error(error.detail || 'Delete failed');
                    }
                    
                    showSuccessNotification(`✅ ${typeName} record successfully deleted!`);
                    
                    // Обновляем соответствующую таблицу
                    if (actionType === 'INSTALL') await loadInstallHistory();
                    if (actionType === 'SHIP') await loadShipmentHistory();
                    if (actionType === 'REMOVE') await loadRemoveHistory();
                    if (actionType === 'REPAIR') await loadRepairHistory();
                    if (actionType === 'PARTS' || actionType === 'PART_ACTION') await loadPartsHistory();
                    if (actionType === 'FLIGHT') await loadUtilHistory();
                    if (actionType === 'STORE_BALANCE') await loadStoreBalance();
                    if (actionType === 'BORESCOPE') {
                        await loadBoroscopeHistory();
                        // Update dashboard card after deleting borescope record
                        console.log('🔄 Updating boroscope card after deletion...');
                        await updateBoroscopeCard();
                        console.log('✅ Boroscope card updated');
                    }
                    if (actionType === 'PURCHASE_ORDER') await loadPurchaseOrdersHistory();
                    
                    // Обновляем дашборд если это установка/снятие
                    if (actionType === 'INSTALL' || actionType === 'REMOVE') {
                        await loadDashboardData();
                    }
                    
                    resolve(true);
                } catch (e) {
                    showErrorNotification(`❌ Error deleting record: ${e.message}`);
                    console.error('Delete history error:', e);
                    resolve(false);
                }
            };
            
            document.getElementById('confirm-delete-no').onclick = () => {
                document.body.removeChild(modal);
                resolve(false);
            };
            
            // Закрытие по клику вне модального окна
            modal.onclick = (e) => {
                if (e.target === modal) {
                    document.body.removeChild(modal);
                    resolve(false);
                }
            };
        });
    }

    // Универсальная функция переключения режима удаления для любой таблицы
    function toggleDeleteMode(tableName) {
        const deleteBtn = document.getElementById(`btn-${tableName}-delete`);
        const deleteDoneBtn = document.getElementById(`btn-${tableName}-delete-done`);
        const deleteCols = document.querySelectorAll(`.delete-col-${tableName}`);
        const tbody = document.getElementById(tableConfigs[tableName]?.bodyId || `${tableName}-history-body`);
        const rows = tbody ? Array.from(tbody.querySelectorAll('tr')) : [];

        if (!deleteBtn || !deleteDoneBtn) {
            console.warn(`toggleDeleteMode: buttons missing for table ${tableName}`);
            return;
        }
        
        if (deleteBtn.classList.contains('d-none')) {
            // Выход из режима удаления
            deleteBtn.classList.remove('d-none');
            deleteDoneBtn.classList.add('d-none');
            deleteCols.forEach(el => el.style.display = 'none');
            rows.forEach(row => row.classList.remove('editing-row'));
        } else {
            // Вход в режим удаления
            deleteBtn.classList.add('d-none');
            deleteDoneBtn.classList.remove('d-none');
            deleteCols.forEach(el => el.style.display = 'table-cell');
            rows.forEach(row => row.classList.add('editing-row'));
        }
    }

    // Универсальная функция фильтрации таблиц
    function filterTable(tableBodyId, searchInputId) {
        const input = document.getElementById(searchInputId);
        const filter = input.value.toLowerCase();
        const tbody = document.getElementById(tableBodyId);
        const rows = tbody.getElementsByTagName('tr');
        
        for (let i = 0; i < rows.length; i++) {
            const row = rows[i];
            const text = row.textContent || row.innerText;
            
            if (text.toLowerCase().indexOf(filter) > -1) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        }
    }

    function escapeHtml(value) {
        if (value === undefined || value === null) return '';
        return value
            .toString()
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#39;');
    }

    // ============ УНИВЕРСАЛЬНЫЕ ФУНКЦИИ РЕДАКТИРОВАНИЯ ТАБЛИЦ ============
    
    // Конфигурация для каждой таблицы
    const tableConfigs = {
        'install': {
            bodyId: 'install-history-body',
            columns: ['date', 'original_sn', 'current_sn', 'install_to', 'position', 'location_from', 'tt', 'tc', 'ac_ttsn', 'ac_tcsn', 'supplier', 'remarks'],
            columnTypes: {
                date: 'date',
                position: 'number',
                tt: 'number',
                tc: 'number',
                ac_ttsn: 'number',
                ac_tcsn: 'number',
                
            },
            reloadFunction: loadInstallHistory,
            hasDeleteCol: true
        },
        'shipment': {
            bodyId: 'shipment-history-body',
            columns: ['date', 'current_sn', 'from', 'to', 'remarks'],
            columnTypes: {
                date: 'date'
            },
            reloadFunction: loadShipmentHistory,
            hasDeleteCol: true
        },
        'remove': {
            bodyId: 'remove-history-body',
            columns: ['date', 'current_sn', 'from', 'to', 'remarks'],
            columnTypes: {
                date: 'date'
            },
            reloadFunction: loadRemoveHistory,
            hasDeleteCol: true,
            allowRowCreation: false  // Запрещаем создание через Edit Mode
        },
        'repair': {
            bodyId: 'repair-history-body',
            columns: ['date', 'current_sn', 'vendor', 'wo', 'tt_tc', 'photo', 'remarks'],
            columnTypes: {
                date: 'date'
            },
            reloadFunction: loadRepairHistory,
            hasDeleteCol: true
        },
        'util': {
            bodyId: 'util-history-body',
            columns: ['date', 'aircraft', 'route', 'added_tt', 'added_tc', 'ref'],
            columnTypes: {
                date: 'date',
                added_tt: 'number',
                added_tc: 'number'
            },
            reloadFunction: loadUtilHistory,
            hasDeleteCol: true  // Теперь у Utilization есть delete-col
        },
        'param': {
            bodyId: 'param-history-body',
            columns: ['date', 'aircraft', 'position', 'engine_sn', 'n1_to', 'n2_to', 'egt_to', 'n1_cr', 'n2_cr', 'egt_cr', 'created_at'],
            columnTypes: {
                date: 'date',
                position: 'number',
                n1_to: 'number',
                n2_to: 'number',
                egt_to: 'number',
                n1_cr: 'number',
                n2_cr: 'number',
                egt_cr: 'number'
            },
            reloadFunction: loadParameterHistory,
            hasDeleteCol: true
        },
        'borescope': {
            bodyId: 'borescope-history-body',
            columns: ['date', 'aircraft', 'serial_number', 'position', 'work_type', 'gss_id', 'inspector', 'comment', 'link'],
            columnTypes: {
                date: 'date'
            },
            reloadFunction: loadBoroscopeHistory,
            hasDeleteCol: true
        },
        'purchase-orders': {
            bodyId: 'purchase-orders-history-body',
            columns: ['date', 'name', 'part_number', 'serial_number', 'price', 'purpose', 'aircraft', 'ro_number', 'link'],
            columnTypes: {
                date: 'date',
                price: 'number'
            },
            reloadFunction: loadPurchaseOrdersHistory,
            hasDeleteCol: true
        },
        'store-balance': {
            bodyId: 'store-balance-body',
            columns: ['received_date', 'part_name', 'part_number', 'serial_number', 'condition', 'quantity', 'unit', 'location', 'shelf', 'owner', 'remarks'],
            columnTypes: {
                received_date: 'date',
                quantity: 'number',
                condition: 'select'
            },
            selectOptions: {
                condition: [] // Будет заполняться динамически из API
            },
            reloadFunction: loadStoreBalance,
            hasDeleteCol: true
        },
        'parts': {
            bodyId: 'parts-history-body',
            columns: ['date', 'action', 'part_name', 'part_number', 'serial_number', 'quantity', 'from_esn', 'to_esn', 'location', 'reason'],
            columnTypes: {
                date: 'date',
                quantity: 'number'
            },
            reloadFunction: loadPartsHistory,
            hasDeleteCol: true
        },
        'util-param': {
            bodyId: 'util-param-history-body',
            columns: ['date', 'aircraft', 'position', 'orig_sn', 'gss_sn', 'ttsn', 'tcsn', 'period', 'date_from', 'date_to', 'created_at'],
            columnTypes: {
                date: 'date',
                ttsn: 'number',
                tcsn: 'number',
                date_from: 'date',
                date_to: 'date'
            },
            reloadFunction: loadUtilParamHistory,
            hasDeleteCol: true
        }
    };

    // Helper: convert DD.MM.YYYY or other formats to YYYY-MM-DD for input[type="date"]
    function convertToISODate(dateStr) {
        if (!dateStr || dateStr === '-') return '';
        // If already in ISO format (YYYY-MM-DD)
        if (/^\d{4}-\d{2}-\d{2}$/.test(dateStr)) return dateStr;
        // If DD.MM.YYYY format
        if (/^\d{2}\.\d{2}\.\d{4}$/.test(dateStr)) {
            const [day, month, year] = dateStr.split('.');
            return `${year}-${month}-${day}`;
        }
        // Try parsing as Date object
        try {
            const d = new Date(dateStr);
            if (!isNaN(d.getTime())) {
                const year = d.getFullYear();
                const month = String(d.getMonth() + 1).padStart(2, '0');
                const day = String(d.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            }
        } catch (e) {}
        return '';
    }

    // Mapping table names to backend action types for delete endpoints
    const tableActionTypeMap = {
        'install': 'INSTALL',
        'shipment': 'SHIP',
        'remove': 'REMOVE',
        'repair': 'REPAIR',
        'util': 'FLIGHT',
        'param': 'PARAMETER',
        'util-param': 'PARAMETER',
        'borescope': 'BORESCOPE',
        'purchase-orders': 'PURCHASE_ORDER',
        'store-balance': 'STORE_BALANCE',
        'parts': 'PARTS'
    };

    // Helper: check if a table is currently in Edit mode
    function isEditingActive(tableName) {
        const saveBtn = document.getElementById(`btn-${tableName}-save`);
        return !!(saveBtn && !saveBtn.classList.contains('d-none'));
        }

    function ensureSelectionStylesInjected() {
        if (document.getElementById('row-select-styles')) return;
        const style = document.createElement('style');
        style.id = 'row-select-styles';
        style.textContent = `
            .row-select { appearance: none; -webkit-appearance: none; width: 18px; height: 18px; border: 2px solid #6c757d; border-radius: 50%; display: inline-block; position: relative; cursor: pointer; vertical-align: middle; margin-right: 6px; }
            .row-select:checked { background-color: #dc3545; border-color: #dc3545; }
            .row-select:checked::after { content: ''; position: absolute; top: 50%; left: 50%; width: 6px; height: 6px; background: #fff; border-radius: 50%; transform: translate(-50%, -50%); }
            .row-select-disabled { opacity: 0.4; cursor: not-allowed; }
            /* Ensure delete columns have enough space for circle + trash */
            .delete-col, [class^='delete-col-'] { min-width: 64px; }
            /* Align contents neatly side by side */
            td.delete-col, td[class^='delete-col-'] { display: flex; align-items: center; justify-content: center; gap: 6px; }
        `;
        document.head.appendChild(style);
    }

    function getDeleteUrlForAction(actionType, id) {
        if (actionType === 'STORE_BALANCE') return `/api/store-balance/${id}`;
        if (actionType === 'PARTS') return `/api/history/PART_ACTION/${id}`;
        return `/api/history/${actionType}/${id}`;
    }

    function updateDeleteSelectedButtonState(tableName) {
        const btn = document.getElementById(`btn-${tableName}-delete-selected`);
        if (!btn) return;
        const config = tableConfigs[tableName];
        if (!config) { btn.disabled = true; return; }
        const tbody = document.getElementById(config.bodyId);
        if (!tbody) { btn.disabled = true; return; }
        const anySelected = !!tbody.querySelector('.row-select:checked');
        btn.disabled = !anySelected;
    }

    function insertDeleteSelectedButton(tableName) {
        const saveBtn = document.getElementById(`btn-${tableName}-save`);
        if (!saveBtn) return;
        let delBtn = document.getElementById(`btn-${tableName}-delete-selected`);
        if (!delBtn) {
            delBtn = document.createElement('button');
            delBtn.id = `btn-${tableName}-delete-selected`;
            delBtn.className = 'btn btn-sm btn-danger ms-2 d-none';
            delBtn.innerHTML = '<i class="bi bi-trash3"></i> Delete Selected';
            delBtn.onclick = () => bulkDeleteSelected(tableName);
            saveBtn.parentNode.insertBefore(delBtn, saveBtn.nextSibling);
        }
        // Show it for supported tables only
        if (tableActionTypeMap[tableName]) delBtn.classList.remove('d-none');
        updateDeleteSelectedButtonState(tableName);
    }

    function attachRowSelectionControls(tableName) {
        const config = tableConfigs[tableName];
        if (!config) return;
        const tbody = document.getElementById(config.bodyId);
        if (!tbody) return;
        const rows = tbody.querySelectorAll('tr');
        rows.forEach(row => {
            const id = row.getAttribute('data-log-id') || row.getAttribute('data-id');
            const delCell = row.querySelector(`.delete-col-${tableName}`);
            if (!delCell) return;
            if (delCell.querySelector('.row-select')) return; // already attached
            const cb = document.createElement('input');
            cb.type = 'checkbox';
            cb.className = 'row-select';
            cb.title = 'Select row';
            if (!id || id === '0') {
                cb.disabled = true;
                cb.classList.add('row-select-disabled');
            }
            cb.addEventListener('change', () => updateDeleteSelectedButtonState(tableName));
            delCell.insertBefore(cb, delCell.firstChild);
        });
        updateDeleteSelectedButtonState(tableName);
    }

    async function bulkDeleteSelected(tableName) {
        const config = tableConfigs[tableName];
        if (!config) return;
        const actionType = tableActionTypeMap[tableName];
        if (!actionType) {
            showErrorNotification('Bulk delete is not supported for this table.');
            return;
        }
        const tbody = document.getElementById(config.bodyId);
        const selected = Array.from(tbody.querySelectorAll('.row-select:checked'));
        if (selected.length === 0) {
            showErrorNotification('Please select at least one row to delete.');
            return;
        }
        
        const ids = selected.map(cb => {
            const tr = cb.closest('tr');
            return (tr && (tr.getAttribute('data-log-id') || tr.getAttribute('data-id')));
        }).filter(id => id && id !== '0');
        
        if (ids.length === 0) {
            showErrorNotification('Selected rows are not deletable.');
            return;
        }

        const confirmed = confirm(`Delete ${ids.length} selected record(s)? This cannot be undone.`);
        if (!confirmed) return;
        
        try {
            const deletions = ids.map(id => {
                // Utilization Parameters have a dedicated endpoint
                if (tableName === 'util-param') {
                    return fetch(`/api/utilization-parameters/${id}`, { method: 'DELETE' });
                }
                return fetch(getDeleteUrlForAction(actionType, id), { method: 'DELETE' });
            });
            
            const results = await Promise.allSettled(deletions);
            const failed = results.filter(r => r.status === 'rejected' || (r.status === 'fulfilled' && r.value && !r.value.ok));
            if (failed.length > 0) {
                showErrorNotification(`Some deletions failed: ${failed.length}/${ids.length}`);
            } else {
                showSuccessNotification(`Deleted ${ids.length} record(s).`);
            }

            // Reload data for the table
            await config.reloadFunction();
            // If still in edit mode, re-show delete column and reattach selectors
            const saveBtn = document.getElementById(`btn-${tableName}-save`);
            const isStillEditing = saveBtn && !saveBtn.classList.contains('d-none');
            if (isStillEditing) {
                const deleteCols = document.querySelectorAll(`.delete-col-${tableName}`);
                deleteCols.forEach(el => el.style.display = 'table-cell');
                attachRowSelectionControls(tableName);
            }
            // Update dashboard where applicable
            if (actionType === 'INSTALL' || actionType === 'REMOVE') {
                await loadDashboardData();
            }
        } catch (e) {
            console.error('Bulk delete error:', e);
            showErrorNotification(`Bulk delete error: ${e.message}`);
        } finally {
            updateDeleteSelectedButtonState(tableName);
        }
    }

    // Включить режим редактирования таблицы
    function toggleEditModeTable(tableName) {
        const config = tableConfigs[tableName];
        if (!config) return;

        // Для store-balance загружаем динамические condition'ы перед редактированием
        if (tableName === 'store-balance') {
            loadConditionStatuses().then(() => {
                if (window.conditionStatuses && window.conditionStatuses.length > 0) {
                    tableConfigs['store-balance'].selectOptions.condition = window.conditionStatuses.map(status => ({
                        value: status.name,
                        label: status.name,
                        color: status.color
                    }));
                }
                performEditModeToggle(tableName);
            });
        } else {
            performEditModeToggle(tableName);
        }
    }

    function performEditModeToggle(tableName) {
        const config = tableConfigs[tableName];

        const editBtn = document.getElementById(`btn-${tableName}-edit`);
        const saveBtn = document.getElementById(`btn-${tableName}-save`);
        const cancelBtn = document.getElementById(`btn-${tableName}-cancel`);
        const addBtn = document.getElementById(`add-row-${tableName}`);
        const tbody = document.getElementById(config.bodyId);
        
        // Переключаем кнопки
        editBtn.classList.add('d-none');
        saveBtn.classList.remove('d-none');
        cancelBtn.classList.remove('d-none');
        if (addBtn) {
            if (config.allowRowCreation === false) {
                addBtn.classList.add('d-none');
            } else {
                addBtn.classList.remove('d-none');
            }
        }
        
        // Показываем колонку с корзинами
        const deleteCols = document.querySelectorAll(`.delete-col-${tableName}`);
        deleteCols.forEach(el => el.style.display = 'table-cell');
        // Add selection UI and button
        ensureSelectionStylesInjected();
        insertDeleteSelectedButton(tableName);
        attachRowSelectionControls(tableName);
        
        // Показываем кнопку + для добавления пользовательских колонок (только для purchase-orders)
        if (tableName === 'purchase-orders') {
            const addColumnBtn = document.getElementById('add-column-btn-purchase-orders');
            if (addColumnBtn) addColumnBtn.classList.remove('d-none');
            const deleteColumnBtn = document.getElementById('delete-column-btn-purchase-orders');
            if (deleteColumnBtn) deleteColumnBtn.classList.remove('d-none');
            const addColumnHeader = document.getElementById('add-column-header-purchase-orders');
            if (addColumnHeader) addColumnHeader.style.display = 'table-cell';
            
            // Показываем чекбоксы для выбора пользовательских столбцов
            const checkboxes = document.querySelectorAll('.column-select-checkbox');
            checkboxes.forEach(cb => cb.classList.remove('d-none'));
        }
        
        // Превращаем каждую ячейку в редактируемое поле
        const rows = tbody.querySelectorAll('tr');
        rows.forEach(row => {
            // Пропускаем строки "No data"
            if (row.cells.length === 1 && row.cells[0].colSpan > 1) return;
            
            row.classList.add('editing-row');
            const cells = Array.from(row.children);
            let dataColumnIndex = 0; // Счетчик для data-колонок (исключая delete-col)
            
            cells.forEach((cell) => {
                // Пропускаем колонку удаления (первую с классом delete-col-*)
                if (cell.classList.contains(`delete-col-${tableName}`)) return;
                
                // Проверяем, является ли это пользовательской колонкой
                const customColumnKey = cell.getAttribute('data-column-key');
                if (customColumnKey) {
                    // Это пользовательская колонка
                    const cleanValue = cell.textContent.trim();
                    cell.innerHTML = `<input type="text" class="editing-input" data-custom-column="${customColumnKey}" value="${cleanValue}">`;
                    dataColumnIndex++;
                    return;
                }
                
                // Пропускаем пустую ячейку с кнопкой плюс (последнюю без границ)
                if (cell.style.background === 'transparent' && cell.style.border === 'none') return;
                
                const columnName = config.columns[dataColumnIndex];
                if (!columnName) return; // Если колонка не определена в конфиге
                
                const columnType = config.columnTypes[columnName] || 'text';
                
                // Для числовых полей берем data-атрибут, для остальных - текст без форматирования
                // Для select полей: проверяем data-value атрибут (для condition с span)
                let cleanValue = '';
                if (columnType === 'select') {
                    const span = cell.querySelector('[data-value]');
                    if (span) {
                        cleanValue = span.getAttribute('data-value');
                    } else {
                        cleanValue = cell.innerText.trim();
                    }
                } else {
                    cleanValue = cell.textContent.trim();
                }
                
                // Для столбца Link извлекаем URL из data-link или href
                if (cell.hasAttribute('data-key') && cell.getAttribute('data-key') === 'link') {
                    const linkValue = row.getAttribute('data-link') || '';
                    cell.innerHTML = `<input type="text" class="editing-input" value="${linkValue}" placeholder="https://...">`;
                    dataColumnIndex++;
                    return;
                }
                
                // Убираем форматирование для числовых полей (%, °C, hrs, cyc и т.д.)
                if (columnType === 'number') {
                    cleanValue = cleanValue.replace(/[%°C\shrs\scyc\s-]/g, '').trim();
                    cell.innerHTML = `<input type="number" class="editing-input" value="${cleanValue}" step="0.01">`;
                } else if (columnType === 'date') {
                    const isoDate = convertToISODate(cleanValue);
                    cell.innerHTML = `<input type="date" class="editing-input" value="${isoDate}">`;
                } else if (columnType === 'select' && config.selectOptions && config.selectOptions[columnName]) {
                    const options = config.selectOptions[columnName];
                    let selectHtml = `<select class="editing-input">`;
                    selectHtml += `<option value="">-- Select --</option>`;
                    options.forEach(opt => {
                        const selected = opt.value === cleanValue ? 'selected' : '';
                        selectHtml += `<option value="${opt.value}" ${selected}>${opt.label}</option>`;
                    });
                    selectHtml += `</select>`;
                    cell.innerHTML = selectHtml;
                } else {
                    cell.innerHTML = `<input type="text" class="editing-input" value="${cleanValue}">`;
                }
                
                dataColumnIndex++;
            });
        });
    }

    // Добавить пустую строку
    function addEmptyRowTable(tableName) {
        const config = tableConfigs[tableName];
        if (!config) return;
        if (config.allowRowCreation === false) {
            showErrorNotification('This table cannot create records from Edit mode. Please use the form above.');
            return;
        }
        
        const tbody = document.getElementById(config.bodyId);
        const newRow = document.createElement('tr');
        newRow.classList.add('editing-row', 'table-success'); // Подсвечиваем зеленым
        newRow.setAttribute('data-log-id', '0'); // Новая строка, ID = 0
        
        // Добавляем delete-col (ВИДИМУЮ в режиме Edit), если она есть в конфиге
        if (config.hasDeleteCol !== false) {
            const deleteCell = document.createElement('td');
            deleteCell.className = `delete-col delete-col-${tableName}`;
            deleteCell.style.display = 'table-cell'; // Показываем сразу, так как мы в режиме Edit
            deleteCell.innerHTML = `
                <button class="btn btn-sm btn-danger" onclick="this.closest('tr').remove()" title="Delete">
                    <i class="bi bi-trash"></i>
                </button>
            `;
            newRow.appendChild(deleteCell);
        }
        
        // Добавляем ячейки для каждой колонки
        config.columns.forEach(columnName => {
            const cell = document.createElement('td');
            const columnType = config.columnTypes[columnName] || 'text';
            
            if (columnType === 'date') {
                cell.innerHTML = `<input type="date" class="editing-input">`;
            } else if (columnType === 'number') {
                cell.innerHTML = `<input type="number" class="editing-input" value="0" step="0.01">`;
            } else if (columnType === 'select' && config.selectOptions && config.selectOptions[columnName]) {
                const options = config.selectOptions[columnName];
                let selectHtml = `<select class="editing-input">`;
                selectHtml += `<option value="">-- Select --</option>`;
                options.forEach(opt => {
                    selectHtml += `<option value="${opt.value}">${opt.label}</option>`;
                });
                selectHtml += `</select>`;
                cell.innerHTML = selectHtml;
            } else {
                cell.innerHTML = `<input type="text" class="editing-input" placeholder="${columnName}">`;
            }
            
            newRow.appendChild(cell);
        });
        
        // Добавляем пустые ячейки для пользовательских колонок (только для purchase-orders)
        if (tableName === 'purchase-orders' && customColumns) {
            customColumns.forEach(col => {
                const cell = document.createElement('td');
                cell.setAttribute('data-column-key', col.column_key);
                cell.innerHTML = `<input type="text" class="editing-input" data-custom-column="${col.column_key}" placeholder="${col.column_label}">`;
                newRow.appendChild(cell);
            });
            
            // Добавляем пустую ячейку для кнопки плюс
            const emptyCell = document.createElement('td');
            emptyCell.style.background = 'transparent';
            emptyCell.style.border = 'none';
            newRow.appendChild(emptyCell);
        }
        
        tbody.appendChild(newRow);
    }

    // Сохранить изменения таблицы
    async function saveEditModeTable(tableName) {
        const config = tableConfigs[tableName];
        if (!config) return;
        
        // Специальная обработка для util-param (работает с API)
        if (tableName === 'util-param') {
            const tbody = document.getElementById(config.bodyId);
            const rows = tbody.querySelectorAll('tr.editing-row');
            const updatePromises = [];
            
            for (const row of rows) {
                const inputs = row.querySelectorAll('.editing-input');
                if (inputs.length === 0) continue;
                
                const dataId = row.getAttribute('data-id');
                const values = Array.from(inputs).map(inp => inp.value);
                
                // Колонки в таблице util-param идут так:
                // 0: date, 1: aircraft, 2: position, 3: orig_sn, 4: gss_sn, 5: ttsn, 6: tcsn, 7: period, 8: date_from, 9: date_to, 10: created_at
                const itemData = {
                    date: values[0] || new Date().toISOString().split('T')[0],
                    aircraft: values[1] || '',
                    position: parseInt(values[2]) || null,
                    ttsn: parseFloat(values[5]) || 0,
                    tcsn: parseInt(values[6]) || 0,
                    period: values[7] === 'Да' || values[7] === 'true',
                    date_from: values[8] && values[8] !== '-' ? values[8] : null,
                    date_to: values[9] && values[9] !== '-' ? values[9] : null
                };
                
                // Обновляем через API
                updatePromises.push(
                    fetch(`/api/utilization-parameters/${dataId}`, {
                        method: 'PUT',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(itemData)
                    })
                );
            }
            
            try {
                await Promise.all(updatePromises);
                
                showSuccessNotification('Данные успешно сохранены в базу данных!');
            } catch (err) {
                console.error('Error saving util-param:', err);
                showErrorNotification('Ошибка сохранения: ' + err.message);
            }
            
            // Выходим из режима редактирования
            const editBtn = document.getElementById('btn-util-param-edit');
            const saveBtn = document.getElementById('btn-util-param-save');
            const cancelBtn = document.getElementById('btn-util-param-cancel');
            const addBtn = document.getElementById('add-row-util-param');
            
            editBtn.classList.remove('d-none');
            saveBtn.classList.add('d-none');
            cancelBtn.classList.add('d-none');
            if (addBtn) addBtn.classList.add('d-none');
            
            const deleteCols = document.querySelectorAll('.delete-col-util-param');
            deleteCols.forEach(el => el.style.display = 'none');
            
            await loadUtilParamHistory();
            return;
        }
        
        const tbody = document.getElementById(config.bodyId);
        const rows = tbody.querySelectorAll('tr.editing-row');
        const updatePromises = [];
        const createPromises = [];
        const validationErrors = []; // Собираем все ошибки валидации
        
        for (const row of rows) {
            const inputs = row.querySelectorAll('.editing-input');
            if (inputs.length === 0) continue;
            
            const logId = row.getAttribute('data-log-id');
            const rowData = {};
            
            inputs.forEach((input, index) => {
                const columnName = config.columns[index];
                rowData[columnName] = input.value;
            });
            
            console.log('=== Processing row ===');
            console.log('Row data:', rowData);
            console.log('Log ID:', logId);
            console.log('Table name:', tableName);
            
            if (tableName === 'store-balance') {
                const sanitize = (val) => (val || '').trim();
                const quantityVal = rowData.quantity === undefined || rowData.quantity === null || rowData.quantity === ''
                    ? 0
                    : parseInt(rowData.quantity, 10);

                if (Number.isNaN(quantityVal)) {
                    validationErrors.push('Store Balance row: Quantity must be a number.');
                    continue;
                }

                const payload = {
                    received_date: sanitize(rowData.received_date) || null,
                    part_name: sanitize(rowData.part_name),
                    part_number: sanitize(rowData.part_number),
                    serial_number: sanitize(rowData.serial_number),
                    condition: sanitize(rowData.condition),
                    quantity: quantityVal,
                    unit: sanitize(rowData.unit),
                    location: sanitize(rowData.location),
                    shelf: sanitize(rowData.shelf),
                    owner: sanitize(rowData.owner),
                    remarks: sanitize(rowData.remarks)
                };

                if (!payload.part_name) {
                    validationErrors.push('Store Balance row: Part Name is required.');
                    continue;
                }

                if (!payload.part_number) {
                    validationErrors.push('Store Balance row: P/N is required.');
                    continue;
                }

                if (payload.quantity < 0) {
                    validationErrors.push('Store Balance row: Quantity cannot be negative.');
                    continue;
                }

                if (logId === '0') {
                    createPromises.push(
                        fetch('/api/store-balance', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        }).then(async (response) => {
                            if (!response.ok) {
                                const error = await response.json().catch(() => ({}));
                                throw new Error(`Create failed for Store Balance: ${error.detail || response.statusText}`);
                            }
                            return response;
                        })
                    );
                } else {
                    updatePromises.push(
                        fetch(`/api/store-balance/${logId}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        }).then(async (response) => {
                            if (!response.ok) {
                                const error = await response.json().catch(() => ({}));
                                throw new Error(`Update failed for Store Balance ${logId}: ${error.detail || response.statusText}`);
                            }
                            return response;
                        })
                    );
                }

                continue;
            }

            // Определяем action_type по tableName
            const actionTypeMap = {
                'install': 'INSTALL',
                'shipment': 'SHIP',
                'remove': 'REMOVE',
                'repair': 'REPAIR',
                'borescope': 'BORESCOPE',
                'purchase-orders': 'PURCHASE_ORDER',
                'param': 'PARAMETER'
            };
            
            const actionType = actionTypeMap[tableName];
            if (!actionType) {
                console.error(`Unknown table name: ${tableName}`);
                continue;
            }
            
            // Преобразуем rowData в формат для API (универсально для разных таблиц)
            let apiData = {};
            
            if (tableName === 'purchase-orders') {
                // Специальный маппинг для Purchase Orders
                apiData = {
                    date: rowData.date || null,
                    name: rowData.name || null,
                    part_number: rowData.part_number || null,
                    serial_number: rowData.serial_number || null,
                    price: rowData.price ? parseFloat(rowData.price) : null,
                    purpose: rowData.purpose || null,
                    aircraft: rowData.aircraft || null,
                    ro_number: rowData.ro_number || null,
                    link: rowData.link || null
                };
                
                // Collect custom column data
                const customDataInputs = row.querySelectorAll('input[data-custom-column]');
                if (customDataInputs.length > 0 && logId !== '0') {
                    const customData = {};
                    customDataInputs.forEach(input => {
                        const columnKey = input.getAttribute('data-custom-column');
                        customData[columnKey] = input.value || '';
                    });
                    
                    // Save custom column data for this Purchase Order (only for existing records)
                    updatePromises.push(
                        fetch('/api/purchase-order-custom-data', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                purchase_order_id: parseInt(logId),
                                custom_data: customData
                            })
                        }).then(async (response) => {
                            if (!response.ok) {
                                const error = await response.json().catch(() => ({}));
                                throw new Error(`Failed to save custom column data for PO ${logId}: ${error.detail || response.statusText}`);
                            }
                            return response;
                        })
                    );
                }
            } else if (tableName === 'install') {
                // Маппинг для Install history (использует спец поля action log)
                apiData = {
                    date: rowData.date || null,
                    from_location: rowData.location_from || null,
                    to_aircraft: rowData.install_to || null,
                    position: rowData.position ? parseInt(rowData.position) : null,
                    snapshot_tt: rowData.tt ? parseFloat(rowData.tt) : null,
                    snapshot_tc: rowData.tc ? parseInt(rowData.tc) : null,
                    ac_ttsn: rowData.ac_ttsn ? parseFloat(rowData.ac_ttsn) : null,
                    ac_tcsn: rowData.ac_tcsn ? parseInt(rowData.ac_tcsn) : null,
                    comments: rowData.remarks || null,
                    supplier: rowData.supplier || null,
                    original_sn: rowData.original_sn || null,
                    current_sn: rowData.current_sn || null
                };
            } else if (tableName === 'borescope') {
                // Специальный маппинг для Borescope
                apiData = {
                    date: rowData.date || null,
                    to_aircraft: rowData.aircraft || null,
                    from_location: rowData.serial_number || null,  // serial_number
                    position: rowData.position ? parseInt(rowData.position) : null,
                    to_location: rowData.gss_id || null,  // gss_id
                    work_type: rowData.work_type || null,
                    inspector: rowData.inspector || null,
                    comment: rowData.comment || null,
                    file_url: rowData.link || null
                };
            } else {
                // Универсальный маппинг для остальных таблиц
                apiData = {
                    date: rowData.date || null,
                    from_location: rowData.from || rowData.location_from || rowData.original_sn || rowData.current_sn || rowData.vendor || null,
                    to_location: rowData.to || rowData.install_to || null,
                    to_aircraft: rowData.aircraft || null,
                    position: rowData.position ? parseInt(rowData.position) : null,
                    snapshot_tt: rowData.tt ? parseFloat(rowData.tt) : null,
                    snapshot_tc: rowData.tc ? parseInt(rowData.tc) : null,
                    comments: rowData.remarks || rowData.wo || null,
                    file_url: rowData.photo || null
                };
            }
            
            if (logId === '0') {
                if (config.allowRowCreation === false) {
                    showErrorNotification('Adding new rows directly in this table is not supported. Please use the input form.');
                    continue;
                }
                // Новая запись - создаем через POST
                let createData = {};
                
                if (tableName === 'purchase-orders') {
                    // Валидация обязательных полей
                    if (!rowData.date || !rowData.name || !rowData.purpose || !rowData.aircraft || !rowData.ro_number) {
                        console.error('Missing required fields for Purchase Order:', rowData);
                        validationErrors.push('❌ Purchase Order row: Required fields are date, item name, purpose, aircraft, RO number (PN/SN/Price/Link are optional).');
                        continue;
                    }
                    createData = {
                        date: rowData.date,
                        name: rowData.name,
                        part_number: rowData.part_number || '',
                        serial_number: rowData.serial_number || '',
                        price: rowData.price ? parseFloat(rowData.price) : null,
                        purpose: rowData.purpose,
                        aircraft: rowData.aircraft,
                        ro_number: rowData.ro_number,
                        link: rowData.link || ''
                    };
                } else if (tableName === 'borescope') {
                    // Валидация обязательных полей
                    if (!rowData.date || !rowData.aircraft || !rowData.serial_number || !rowData.position || !rowData.inspector) {
                        console.error('Missing required fields for Borescope:', rowData);
                        validationErrors.push('❌ Borescope row: Required fields are date, aircraft, serial_number, position, inspector (gss_id/link/comment/work_type are optional)');
                        continue;
                    }
                    createData = {
                        date: rowData.date,
                        aircraft: rowData.aircraft,
                        serial_number: rowData.serial_number,
                        position: String(rowData.position),
                        work_type: rowData.work_type || 'All Engine',
                        gss_id: rowData.gss_id || '',
                        inspector: rowData.inspector,
                        comment: rowData.comment || '',
                        link: rowData.link || ''
                    };
                } else if (tableName === 'install') {
                    if (!rowData.date) {
                        validationErrors.push('Installation row: Date is required.');
                        continue;
                    }
                    if (!rowData.original_sn && !rowData.current_sn) {
                        validationErrors.push('Installation row: Provide Original SN or Current SN to identify the engine.');
                        continue;
                    }
                    if (!rowData.install_to) {
                        validationErrors.push('Installation row: Aircraft (Install To) is required.');
                        continue;
                    }
                    if (!rowData.position) {
                        validationErrors.push('Installation row: Position is required.');
                        continue;
                    }
                    
                    // ВАЖНО: Проверяем что двигатель существует в Master Engine List
                    const engineCheckResponse = await fetch('/api/engines');
                    const allEngines = await engineCheckResponse.json();
                    const engineExists = allEngines.some(e => 
                        e.original_sn === rowData.original_sn || 
                        e.current_sn === rowData.current_sn ||
                        e.original_sn === rowData.current_sn ||
                        e.current_sn === rowData.original_sn
                    );
                    
                    if (!engineExists) {
                        validationErrors.push(`❌ Installation row: Engine with SN "${rowData.original_sn || rowData.current_sn}" NOT FOUND in Master Engine List!\n\n⚠️ Please add the engine to the database first (Master Engine List tab) before creating installation records.`);
                        continue;
                    }
                    
                    createData = {
                        date: rowData.date,
                        engine_original_sn: rowData.original_sn || null,
                        engine_current_sn: rowData.current_sn || null,
                        from_location: rowData.location_from || '',
                        to_aircraft: rowData.install_to,
                        position: rowData.position ? parseInt(rowData.position) : null,
                        snapshot_tt: rowData.tt ? parseFloat(rowData.tt) : null,
                        snapshot_tc: rowData.tc ? parseInt(rowData.tc) : null,
                        ac_ttsn: rowData.ac_ttsn ? parseFloat(rowData.ac_ttsn) : null,
                        ac_tcsn: rowData.ac_tcsn ? parseInt(rowData.ac_tcsn) : null,
                        comments: rowData.remarks || ''
                    };
                } else if (tableName === 'parts') {
                    createData = {
                        date: rowData.date || new Date().toISOString().split('T')[0],
                        action: rowData.action || 'INSTALLED',
                        part_name: rowData.part_name || 'Part',
                        part_number: rowData.part_number || 'N/A',
                        serial_number: rowData.serial_number || 'N/A',
                        quantity: parseInt(rowData.quantity) || 1,
                        location: rowData.location || '',
                        from_esn: rowData.from_esn || '-',
                        to_esn: rowData.to_esn || '-',
                        reason: rowData.reason || ''
                    };
                    
                    console.log('Creating new Parts record:', createData);
                    
                    createPromises.push(
                        fetch('/api/actions/part', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify(createData)
                        }).then(async (response) => {
                            if (!response.ok) {
                                const error = await response.json().catch(() => ({}));
                                throw new Error(`Create failed for Parts: ${error.detail || response.statusText}`);
                            }
                            return response;
                        })
                    );
                    continue;
                } else {
                    // Для других таблиц пока не поддерживаем создание
                    console.warn(`Creating new records for ${tableName} not supported yet`);
                    continue;
                }
                
                console.log('Creating new record:', createData);
                
                if (tableName === 'purchase-orders') {
                    // For Purchase Orders, we need to save the PO first and then save custom columns
                    createPromises.push(
                        fetch(`/api/history/${actionType}`, {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify(createData)
                        }).then(async (response) => {
                            if (!response.ok) {
                                const error = await response.json();
                                throw new Error(`Create failed for ${actionType}: ${error.detail || response.statusText}`);
                            }
                            const createdPO = await response.json();
                            
                            // Now check if there are custom column values to save
                            const customDataInputs = row.querySelectorAll('input[data-custom-column]');
                            if (customDataInputs.length > 0 && createdPO.id) {
                                const customData = {};
                                customDataInputs.forEach(input => {
                                    const columnKey = input.getAttribute('data-custom-column');
                                    const value = input.value || '';
                                    if (value) {  // Only save non-empty values
                                        customData[columnKey] = value;
                                    }
                                });
                                
                                if (Object.keys(customData).length > 0) {
                                    // Save custom column data for the newly created Purchase Order
                                    return fetch('/api/purchase-order-custom-data', {
                                        method: 'POST',
                                        headers: { 'Content-Type': 'application/json' },
                                        body: JSON.stringify({
                                            purchase_order_id: createdPO.id,
                                            custom_data: customData
                                        })
                                    }).then(async (customResponse) => {
                                        if (!customResponse.ok) {
                                            const error = await customResponse.json().catch(() => ({}));
                                            console.error(`Failed to save custom column data for new PO ${createdPO.id}: ${error.detail || customResponse.statusText}`);
                                        }
                                        return customResponse;
                                    });
                                }
                            }
                            return response;
                        })
                    );
                } else {
                    createPromises.push(
                        fetch(`/api/history/${actionType}`, {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify(createData)
                        }).then(async (response) => {
                            if (!response.ok) {
                                const error = await response.json();
                                throw new Error(`Create failed for ${actionType}: ${error.detail || response.statusText}`);
                            }
                            return response;
                        })
                    );
                }
            } else {
                // Существующая запись - обновляем через PUT
                if (tableName === 'parts') {
                    // Parts Logistics has special update structure (JSON in comments)
                    const sanitize = (val) => (val || '').trim();
                    const partsPayload = {
                        date: sanitize(rowData.date),
                        from_location: sanitize(rowData.action),
                        to_location: sanitize(rowData.part_name),
                        comments: JSON.stringify({
                            part_name: sanitize(rowData.part_name),
                            part_number: sanitize(rowData.part_number),
                            serial_number: sanitize(rowData.serial_number),
                            quantity: parseInt(rowData.quantity) || 0,
                            from_esn: sanitize(rowData.from_esn),
                            to_esn: sanitize(rowData.to_esn),
                            location: sanitize(rowData.location),
                            reason: sanitize(rowData.reason)
                        })
                    };
                    updatePromises.push(
                        fetch(`/api/history/PART_ACTION/${logId}`, {
                            method: 'PUT',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify(partsPayload)
                        }).then(async (response) => {
                            if (!response.ok) {
                                const error = await response.json().catch(() => ({}));
                                throw new Error(`Update failed for Parts ${logId}: ${error.detail || response.statusText}`);
                            }
                            return response;
                        })
                    );
                } else {
                    updatePromises.push(
                        fetch(`/api/history/${actionType}/${logId}`, {
                            method: 'PUT',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify(apiData)
                        }).then(async (response) => {
                            if (!response.ok) {
                                const error = await response.json();
                                throw new Error(`Update failed for ${actionType} ${logId}: ${error.detail || response.statusText}`);
                            }
                            return response;
                        })
                    );
                }
            }
        }
        
        // Показываем все ошибки валидации ПЕРЕД сохранением
        if (validationErrors.length > 0) {
            const errorMessage = validationErrors.join('\n\n');
            showErrorNotification(errorMessage);
            return; // Останавливаем сохранение
        }
        
        try {
            const allPromises = [...createPromises, ...updatePromises];
            
            if (allPromises.length === 0) {
                // Если нет изменений, просто выходим из режима редактирования
                console.log('No valid changes detected, exiting edit mode');
                const editBtn = document.getElementById(`btn-${tableName}-edit`);
                const saveBtn = document.getElementById(`btn-${tableName}-save`);
                const cancelBtn = document.getElementById(`btn-${tableName}-cancel`);
                const addBtn = document.getElementById(`add-row-${tableName}`);
                
                editBtn.classList.remove('d-none');
                saveBtn.classList.add('d-none');
                cancelBtn.classList.add('d-none');
                if (addBtn) addBtn.classList.add('d-none');
                const delSelBtn = document.getElementById(`btn-${tableName}-delete-selected`);
                if (delSelBtn) delSelBtn.classList.add('d-none');
                
                const deleteCols = document.querySelectorAll(`.delete-col-${tableName}`);
                deleteCols.forEach(el => el.style.display = 'none');
                
                // Скрываем кнопку + для пользовательских колонок
                if (tableName === 'purchase-orders') {
                    const addColumnBtn = document.getElementById('add-column-btn-purchase-orders');
                    if (addColumnBtn) addColumnBtn.classList.add('d-none');
                    const deleteColumnBtn = document.getElementById('delete-column-btn-purchase-orders');
                    if (deleteColumnBtn) deleteColumnBtn.classList.add('d-none');
                    const addColumnHeader = document.getElementById('add-column-header-purchase-orders');
                    if (addColumnHeader) addColumnHeader.style.display = 'none';
                    
                    // Скрываем чекбоксы и снимаем галочки
                    const checkboxes = document.querySelectorAll('.column-select-checkbox');
                    checkboxes.forEach(cb => {
                        cb.classList.add('d-none');
                        cb.checked = false;
                    });
                }
                
                await config.reloadFunction();
                return;
            }
            
            await Promise.all(allPromises);
            
            const totalSaved = allPromises.length;
            const createdCount = createPromises.length;
            const updatedCount = updatePromises.length;
            
            let message = `Successfully saved ${totalSaved} record(s)!`;
            if (createdCount > 0 && updatedCount > 0) {
                message = `Successfully created ${createdCount} and updated ${updatedCount} record(s)!`;
            } else if (createdCount > 0) {
                message = `Successfully created ${createdCount} record(s)!`;
            } else {
                message = `Successfully updated ${updatedCount} record(s)!`;
            }
            
            showSuccessNotification(message);
            
            // Выходим из режима редактирования и перезагружаем таблицу
            const editBtn = document.getElementById(`btn-${tableName}-edit`);
            const saveBtn = document.getElementById(`btn-${tableName}-save`);
            const cancelBtn = document.getElementById(`btn-${tableName}-cancel`);
            const addBtn = document.getElementById(`add-row-${tableName}`);
            
            editBtn.classList.remove('d-none');
            saveBtn.classList.add('d-none');
            cancelBtn.classList.add('d-none');
            if (addBtn) addBtn.classList.add('d-none');
            const delSelBtn2 = document.getElementById(`btn-${tableName}-delete-selected`);
            if (delSelBtn2) delSelBtn2.classList.add('d-none');
            
            const deleteCols = document.querySelectorAll(`.delete-col-${tableName}`);
            deleteCols.forEach(el => el.style.display = 'none');
            
            // Скрываем кнопку + для пользовательских колонок
            if (tableName === 'purchase-orders') {
                const addColumnBtn = document.getElementById('add-column-btn-purchase-orders');
                if (addColumnBtn) addColumnBtn.classList.add('d-none');
                const deleteColumnBtn = document.getElementById('delete-column-btn-purchase-orders');
                if (deleteColumnBtn) deleteColumnBtn.classList.add('d-none');
                const addColumnHeader = document.getElementById('add-column-header-purchase-orders');
                if (addColumnHeader) addColumnHeader.style.display = 'none';
                
                // Скрываем чекбоксы и снимаем галочки
                const checkboxes = document.querySelectorAll('.column-select-checkbox');
                checkboxes.forEach(cb => {
                    cb.classList.add('d-none');
                    cb.checked = false;
                });
            }
            
            console.log(`🔄 Reloading table data for ${tableName}...`);
            await config.reloadFunction();
            console.log(`✅ Table ${tableName} reloaded successfully`);
            
            // Update dashboard card for borescope inspections
            if (tableName === 'borescope') {
                console.log('🔄 Updating boroscope dashboard card...');
                await updateBoroscopeCard();
                console.log('✅ Boroscope card updated');
            }
            
            // Refresh dashboard after editing INSTALL or REMOVE (because they affect aircraft positions)
            if (tableName === 'install' || tableName === 'remove') {
                console.log('🔄 Refreshing dashboard after ' + tableName + ' edit...');
                await loadDashboardData();
                console.log('✅ Dashboard refreshed');
            }
            
        } catch (error) {
            showErrorNotification(`Error saving data: ${error.message}`);
            console.error('❌ Save error:', error);
        }
    }

    // Отменить редактирование таблицы
    function cancelEditModeTable(tableName) {
        const config = tableConfigs[tableName];
        if (!config) return;
        
        const editBtn = document.getElementById(`btn-${tableName}-edit`);
        const saveBtn = document.getElementById(`btn-${tableName}-save`);
        const cancelBtn = document.getElementById(`btn-${tableName}-cancel`);
        const addBtn = document.getElementById(`add-row-${tableName}`);
        
        // Переключаем кнопки обратно
        editBtn.classList.remove('d-none');
        saveBtn.classList.add('d-none');
        cancelBtn.classList.add('d-none');
        if (addBtn) addBtn.classList.add('d-none');
        
        // Скрываем колонку с корзинами
        const deleteCols = document.querySelectorAll(`.delete-col-${tableName}`);
        deleteCols.forEach(el => el.style.display = 'none');
        
        // Скрываем кнопку + для пользовательских колонок
        if (tableName === 'purchase-orders') {
            const addColumnBtn = document.getElementById('add-column-btn-purchase-orders');
            if (addColumnBtn) addColumnBtn.classList.add('d-none');
            const deleteColumnBtn = document.getElementById('delete-column-btn-purchase-orders');
            if (deleteColumnBtn) deleteColumnBtn.classList.add('d-none');
            const addColumnHeader = document.getElementById('add-column-header-purchase-orders');
            if (addColumnHeader) addColumnHeader.style.display = 'none';
            
            // Скрываем чекбоксы и снимаем галочки
            const checkboxes = document.querySelectorAll('.column-select-checkbox');
            checkboxes.forEach(cb => {
                cb.classList.add('d-none');
                cb.checked = false;
            });
        }
        const delSelBtn = document.getElementById(`btn-${tableName}-delete-selected`);
        if (delSelBtn) delSelBtn.classList.add('d-none');
        // Clear any selections if rows remain
        const tbody = document.getElementById(config.bodyId);
        if (tbody) tbody.querySelectorAll('.row-select:checked').forEach(cb => { cb.checked = false; });
        
        // Перезагружаем таблицу с сервера
        config.reloadFunction();
    }

    // ============ КОНЕЦ УНИВЕРСАЛЬНЫХ ФУНКЦИЙ ============

    async function openAddEngineView() { 
        hideAllViews(); 
        document.getElementById('view-add-engine').style.display = 'block'; 
        updateHistory('add-engine');
        
        // Устанавливаем текущую дату по умолчанию
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('m-date').value = today;
        
        await loadLocationsForForm();
    }
    
    // Функция загрузки локаций для формы
    async function loadLocationsForForm() {
        try {
            const res = await fetch('/api/locations' + noCache());
            const locations = await res.json();
            const sel = document.getElementById('m-location');
            if(!sel) return;
            sel.innerHTML = '<option value="" disabled selected>Select Location...</option>';
            locations.forEach(loc => {
                sel.innerHTML += `<option value="${loc.id}">${loc.name} - ${loc.city}</option>`;
            });
        } catch(e) {
            console.error('Loading error локаций:', e);
        }
    }



    let _mainEngineSubmitting = false;
    async function submitMainEngine() {
        if (_mainEngineSubmitting) { return; }
        _mainEngineSubmitting = true;
        const saveBtn = document.querySelector('#tab-main-add .btn.btn-success.px-4');
        if (saveBtn) { saveBtn.disabled = true; saveBtn.dataset._orig = saveBtn.innerHTML; saveBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Saving...'; }
        
        // 1. Собираем значения из полей
        const esn = document.getElementById('m-esn').value.trim();
        const date = document.getElementById('m-date').value;
        const locationId = document.getElementById('m-location').value;
        
        console.log('Form values:', { esn, date, locationId, m_status: document.getElementById('m-status').value });
        
        // Простая валидация
        if(!esn) { 
            alert("Error: Поле 'Orig. ESN' обязательно для заполнения!"); 
            _mainEngineSubmitting = false;
            if (saveBtn) { saveBtn.disabled = false; saveBtn.innerHTML = saveBtn.dataset._orig || 'Save Record'; }
            return; 
        }
        if(!locationId) { 
            alert("Error: Выберите локацию (Current Location)!"); 
            _mainEngineSubmitting = false;
            if (saveBtn) { saveBtn.disabled = false; saveBtn.innerHTML = saveBtn.dataset._orig || 'Save Record'; }
            return; 
        }
        if(/[а-яА-ЯёЁ]/.test(esn)) { 
            alert("Русские буквы в серийном номере запрещены!"); 
            _mainEngineSubmitting = false;
            if (saveBtn) { saveBtn.disabled = false; saveBtn.innerHTML = saveBtn.dataset._orig || 'Save Record'; }
            return; 
        }

        // 2. Создаем объект для отправки на сервер
        const currentSN = document.getElementById('m-current-sn').value.trim();
        const model = document.getElementById('m-model').value.trim();
        const gssId = document.getElementById('m-gssid').value.trim();
        const status = document.getElementById('m-status').value || '';
        const tt = document.getElementById('m-tt').value;
        const tc = document.getElementById('m-tc').value;
        const price = document.getElementById('m-price').value;
        const photoUrl = document.getElementById('m-photo').value.trim();
        const remarks = document.getElementById('m-rem').value.trim();
        const movedFrom = document.getElementById('m-moved').value.trim();
        const removedFrom = document.getElementById('m-removed').value.trim();
        const condition1 = document.getElementById('m-condition-1').value;
        const condition2 = document.getElementById('m-condition-2').value;
        
        const payload = {
            date: date || null,
            original_sn: esn,
            gss_sn: gssId || esn,
            current_sn: currentSN || esn,
            model: model || null,
            status: status,
            location_id: parseInt(locationId),
            total_time: parseFloat(tt) || 0,
            total_cycles: parseInt(tc) || 0,
            price: price ? parseFloat(price) : null,
            photo_url: photoUrl || null,
            remarks: remarks || null,
            from_location: movedFrom || null,
            removed_from: removedFrom || null,
            condition_1: condition1,
            condition_2: condition2
        };

        try {
            // 3. Отправляем на сервер
            console.log('Sending engine data:', payload);
            const res = await fetch(`/api/engines?user_id=${currentUser.id}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            
            console.log('Response status:', res.status, res.statusText);
            
            if(!res.ok) {
                const errorData = await res.json().catch(() => ({}));
                console.error('Server error:', errorData);
                throw new Error(errorData.detail || `HTTP Error ${res.status}`);
            }
            
            const responseData = await res.json();
            console.log('Server response:', responseData);
            
            // Если двигатель успешно создан с ID, очищаем его из списка удаленных (на случай если был там)
            if (responseData.id) {
                const deletedIds = getDeletedEngineIds();
                const idx = deletedIds.indexOf(responseData.id);
                if (idx > -1) {
                    deletedIds.splice(idx, 1);
                    try { 
                        localStorage.setItem(DELETED_ENGINE_STORAGE_KEY, JSON.stringify(deletedIds));
                        console.log('Removed new engine ID', responseData.id, 'from deleted list');
                    } catch (e) { 
                        console.warn('Cannot update deleted engine ids', e); 
                    }
                }
            }
            
            alert("Двигатель успешно добавлен!");
            
            // 4. Очищаем форму
            document.getElementById('form-main-add').reset();
            
            // 5. Обновляем Dashboard и таблицу
            console.log('Saving complete, refreshing data...');
            await loadDashboardData(); // Обновит счетчики на Dashboard
            console.log('Dashboard updated');
            
            await loadMainTable(); // Обновляем таблицу двигателей
            console.log('Main table loaded');
            
            switchMainTab('list'); // Переключаемся на вкладку списка
            console.log('Switched to list tab');
            
            refreshAfterDataChange();
            console.log('Data refresh complete');
            
        } catch(e) {
            console.error('Error details:', e);
            alert("Ошибка при сохранении: " + e.message);
        } finally {
            _mainEngineSubmitting = false;
            if (saveBtn) { saveBtn.disabled = false; saveBtn.innerHTML = saveBtn.dataset._orig || 'Save Record'; }
        }
    }
    // --- REPAIR LOGIC ---
    let localTestRepairs = [];

    async function openRepairView() { 
        hideAllViews(); 
        document.getElementById('view-repair').style.display = 'block'; 
        updateHistory('repair');
        await loadRepairHistory();
    }
    
    function switchRepairTab(t) {
        document.getElementById('tab-rep-info').style.display = t==='info'?'block':'none';
        document.getElementById('tab-rep-entry').style.display = t==='entry'?'block':'none';
        document.getElementById('tab-rep-info-btn').className = t==='info'?'nav-link active':'nav-link';
        document.getElementById('tab-rep-entry-btn').className = t==='entry'?'nav-link active':'nav-link';
        if(t==='info') loadRepairHistory(); else prepareRepairForm();
    }

    async function loadRepairHistory() {
        const tb = document.getElementById('repair-history-body'); 
        if (!tb) return;
        tb.innerHTML = '<tr><td colspan="8" class="text-center text-muted py-3">Loading…</td></tr>';

        let res = await safeFetch('/api/history/REPAIR'+noCache());
        if (!res || !res.ok) res = await safeFetch('/api/history/REPAIR');

        let sData = [];
        try { sData = res && res.ok ? await res.json() : []; } catch { sData = []; }
        
        tb.innerHTML = '';
        if(sData.length===0) {
            tb.innerHTML = '<tr><td colspan="8" class="text-center text-muted">No data</td></tr>';
            return;
        }
        
        sData.sort((a, b) => (b.id || 0) - (a.id || 0));
        sData.forEach(r => {
            const photoLink = r.photo ? `<a href="${r.photo}" target="_blank"><i class="bi bi-image"></i></a>` : '-';
            
            tb.innerHTML += `<tr data-log-id="${r.id || 0}">
                <td class="delete-col-repair" style="display: none;">
                    <button class="btn btn-sm btn-danger" onclick="deleteHistoryRecord('REPAIR', ${r.id || 0}, '${r.current_sn}')" title="Delete">
                        <i class="bi bi-trash"></i>
                    </button>
                </td>
                <td>${r.date}</td><td>${r.current_sn}</td><td>${r.vendor}</td><td>${r.wo}</td>
                <td>${r.tt} / ${r.tc}</td><td>${photoLink}</td><td>${r.remarks||'-'}</td>
            </tr>`;
        });
    }

    async function prepareRepairForm() {
        const res = await fetch('/api/engines'+noCache()); const engs = await res.json();
        const dl = document.getElementById('engine-options-rep'); dl.innerHTML = '';
        engs.forEach(e => dl.innerHTML += `<option value="${e.original_sn}">${e.current_sn} (Status: ${e.status})</option>`);
        
        document.getElementById('rep-engine-input').oninput = function() {
            this.value = this.value.replace(/[а-яА-ЯёЁ]/g, '');
            const f = engs.find(e => e.original_sn === this.value);
            
            // Сброс красной рамки
            document.getElementById('rep-cur-sn').classList.remove('border', 'border-danger');

            if(f) { 
                // Проверяем статус - SV двигатели нельзя отремонтировать
                if(f.status === 'SV') {
                    showErrorNotification(`❌ Engine ${f.original_sn} has status SV (Serviceable) and does not need repair. Only non-SV engines can be repaired.`);
                    this.value = '';
                    document.getElementById('rep-engine-id').value = ''; 
                    document.getElementById('rep-cur-sn').value = '';
                    return;
                }
                
                document.getElementById('rep-engine-id').value = f.id; 
                document.getElementById('rep-cur-sn').value = f.current_sn; 
                document.getElementById('rep-status-view').value = f.status; 
                document.getElementById('rep-tt').value = f.tt; 
                document.getElementById('rep-tc').value = f.tc; 
            } else { 
                document.getElementById('rep-engine-id').value = ''; 
                document.getElementById('rep-cur-sn').value = '';
            }
        };
    }

    let _repairSubmitting = false;
    async function submitRepairForm() {
        if (_repairSubmitting) { return; }
        _repairSubmitting = true;
        const saveBtn = document.querySelector('#tab-rep-entry .btn.btn-warning.px-4');
        if (saveBtn) { saveBtn.disabled = true; saveBtn.dataset._orig = saveBtn.innerHTML; saveBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Saving...'; }
        const date = document.getElementById('rep-date').value;
        const eid = document.getElementById('rep-engine-id').value;
        const vendor = document.getElementById('rep-vendor').value;
        const curSn = document.getElementById('rep-cur-sn').value;
        
        // Строгая проверка: Если поле SN не заполнено (нет в базе) - ошибка
        if (!curSn) {
            alert("Error: Выберите существующий двигатель из списка!");
            document.getElementById('rep-cur-sn').classList.add('border', 'border-danger');
            return;
        }
        if(!date || !vendor) { alert("Заполните дату и вендора"); return; }

        const payload = {
            date: date, engine_id: parseInt(eid), vendor: vendor,
            work_order: document.getElementById('rep-wo').value, 
            tt: parseFloat(document.getElementById('rep-tt').value)||0,
            tc: parseInt(document.getElementById('rep-tc').value)||0,
            photo_url: document.getElementById('rep-photo').value,
            remarks: document.getElementById('rep-rem').value
        };

        try {
            const res = await fetch('/api/actions/repair', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload)});
            
            const result = await handleApiResponse(res, 'Repair');
            if (!result) return; // Операция не выполнена (warning)

            document.getElementById('form-repair').reset();
            switchRepairTab('info');
            await loadRepairHistory();
            refreshAfterDataChange();
        } catch(e) { 
            alert("❌ Error: " + e.message); 
        } finally {
            _repairSubmitting = false;
            if (saveBtn) { saveBtn.disabled = false; saveBtn.innerHTML = saveBtn.dataset._orig || 'Save (Set SV)'; }
        }
    }

    // --- PARTS LOGIC ---
    let localTestParts = [];

    async function openPartsView() {
        hideAllViews();
        document.getElementById('view-parts').style.display = 'block';
        await loadPartsHistory();
        await loadStoreBalanceForPartsForm();
    }

    async function openStoreBalanceView() {
        hideAllViews();
        const view = document.getElementById('view-store-balance');
        if (view) {
            view.style.display = 'block';
        }
        switchStoreBalanceTab('list');
        updateHistory('store-balance');
        await loadConditionStatuses();
        await loadStoreBalance();
    }

    function switchPartsTab(t) {
        document.getElementById('tab-parts-list').style.display = t==='list'?'block':'none';
        document.getElementById('tab-parts-add').style.display = t==='add'?'block':'none';
        document.getElementById('tab-parts-list-btn').className = t==='list'?'nav-link active':'nav-link';
        document.getElementById('tab-parts-add-btn').className = t==='add'?'nav-link active':'nav-link';
        
        // Load store balance data when switching to Add tab
        if (t === 'add') {
            loadStoreBalanceForPartsForm();
        }
    }

    function switchStoreBalanceTab(tab) {
        const listView = document.getElementById('tab-store-list');
        const addView = document.getElementById('tab-store-add');
        const listBtn = document.getElementById('tab-store-list-btn');
        const addBtn = document.getElementById('tab-store-add-btn');

        if (!listView || !addView || !listBtn || !addBtn) return;

        const isList = tab === 'list';
        listView.style.display = isList ? 'block' : 'none';
        addView.style.display = isList ? 'none' : 'block';
        listBtn.className = isList ? 'nav-link active' : 'nav-link';
        addBtn.className = isList ? 'nav-link' : 'nav-link active';
    }

    async function loadStoreBalance() {
        const tbody = document.getElementById('store-balance-body');
        if (!tbody) return;

        try {
            const res = await fetch('/api/store-balance' + noCache());
            if (!res.ok) {
                const error = await res.json().catch(() => ({}));
                throw new Error(error.detail || `HTTP ${res.status}`);
            }

            const data = await res.json();
            tbody.innerHTML = '';

            if (!data || data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="12" class="text-center">No store items recorded</td></tr>';
                return;
            }

            data.sort((a, b) => (b.id || 0) - (a.id || 0));
            data.forEach(item => {
                const identifier = `${item.part_name || 'Item'} (${item.part_number || '-'})`;
                const safeIdentifier = escapeHtml(identifier);
                const fmt = (value) => {
                    if (value === undefined || value === null || value === '') return '-';
                    return escapeHtml(value);
                };
                const fmtNumber = (value) => {
                    if (value === undefined || value === null || value === '') return '-';
                    if (typeof value === 'number' && !Number.isFinite(value)) return '-';
                    return escapeHtml(value);
                };

                // Get condition color from loaded statuses
                const condText = (item.condition || '').trim();
                const condStatus = window.conditionStatuses?.find(s => s.name === condText);
                const condColor = condStatus ? condStatus.color : '#6c757d';
                const condHtml = condText ? `<span class="cond-badge" style="background-color: ${condColor}; color: white !important; padding: 2px 8px; border-radius: 4px; font-size: 0.85em;" data-value="${escapeHtml(condText)}">${escapeHtml(condText)}</span>` : `<span data-value=""></span>`;

                tbody.innerHTML += `
                    <tr data-log-id="${item.id}">
                        <td class="delete-col delete-col-store-balance" style="display: none;">
                            <button class="btn btn-sm btn-danger" data-identifier="${safeIdentifier}" onclick="deleteHistoryRecord('STORE_BALANCE', ${item.id}, this.dataset.identifier || '')" title="Delete">
                                <i class="bi bi-trash"></i>
                            </button>
                        </td>
                        <td>${fmt(item.received_date)}</td>
                        <td>${fmt(item.part_name)}</td>
                        <td>${fmt(item.part_number)}</td>
                        <td>${fmt(item.serial_number)}</td>
                        <td>${condHtml}</td>
                        <td>${fmtNumber(item.quantity)}</td>
                        <td>${fmt(item.unit)}</td>
                        <td>${fmt(item.location)}</td>
                        <td>${fmt(item.shelf)}</td>
                        <td>${fmt(item.owner)}</td>
                        <td>${fmt(item.remarks)}</td>
                    </tr>`;
            });

            // After render, (re)attach column resizers once per header
            attachStoreBalanceColumnResizers();
        } catch (error) {
            console.error('Store balance load error:', error);
            showErrorNotification(`Failed to load store balance: ${error.message}`);
        }
    }

    let _storeBalanceSubmitting = false;
    async function submitStoreBalanceForm() {
        if (_storeBalanceSubmitting) { return; }
        _storeBalanceSubmitting = true;
        const saveBtn = document.querySelector('#tab-store-balance-add .btn.btn-primary.px-4');
        if (saveBtn) { saveBtn.disabled = true; saveBtn.dataset._orig = saveBtn.innerHTML; saveBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Saving...'; }
        const form = document.getElementById('form-store-part');
        if (!form) return;

        const quantityRaw = document.getElementById('store-qty').value;
        const payload = {
            received_date: document.getElementById('store-date').value || null,
            part_name: document.getElementById('store-name').value.trim(),
            part_number: document.getElementById('store-pn').value.trim(),
            serial_number: document.getElementById('store-sn').value.trim(),
            condition: document.getElementById('store-condition').value.trim(),
            quantity: quantityRaw === '' ? 0 : parseInt(quantityRaw, 10),
            unit: document.getElementById('store-unit').value.trim(),
            location: document.getElementById('store-location').value.trim(),
            shelf: document.getElementById('store-shelf').value.trim(),
            owner: document.getElementById('store-owner').value.trim(),
            remarks: document.getElementById('store-remarks').value.trim()
        };

        if (!payload.part_name) {
            showErrorNotification('Store item: Part Name is required.');
            return;
        }

        if (!payload.part_number) {
            showErrorNotification('Store item: P/N is required.');
            return;
        }

        if (Number.isNaN(payload.quantity)) {
            showErrorNotification('Store item: Quantity must be a number.');
            return;
        }

        if (payload.quantity < 0) {
            showErrorNotification('Store item: Quantity cannot be negative.');
            return;
        }

        try {
            const res = await fetch('/api/store-balance', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!res.ok) {
                const error = await res.json().catch(() => ({}));
                throw new Error(error.detail || res.statusText);
            }

            form.reset();
            switchStoreBalanceTab('list');
            await loadStoreBalance();
            showSuccessNotification('✅ Store item saved!');
        } catch (error) {
            console.error('Store balance save error:', error);
            showErrorNotification(`Error saving store item: ${error.message}`);
        } finally {
            _storeBalanceSubmitting = false;
            if (saveBtn) { saveBtn.disabled = false; saveBtn.innerHTML = saveBtn.dataset._orig || 'Save Item'; }
        }
    }

    // Динамические поля (From/To)
    function updatePartFormFields() {
        const action = document.getElementById('part-action').value;
        const container = document.getElementById('part-dynamic-fields');
        container.innerHTML = ''; // Очистить

        // HTML для полей From и To (с автопоиском по двигателям)
        const fromHtml = `
            <div class="col-md-6">
                <label class="small fw-bold text-danger">FROM (Orig ESN / GSS)</label>
                <input class="form-control" list="engine-options-parts" placeholder="Search Engine..." id="part-from-input">
            </div>`;
        
        const toHtml = `
            <div class="col-md-6">
                <label class="small fw-bold text-success">TO (Orig ESN / GSS)</label>
                <input class="form-control" list="engine-options-parts" placeholder="Search Engine..." id="part-to-input">
            </div>`;

        // Логика отображения
        if (action === 'INSTALLED') {
            container.innerHTML = `<div class="row">${toHtml}</div>`;
        } else if (action === 'REMOVED') {
            container.innerHTML = `<div class="row">${fromHtml}</div>`;
        } else if (action === 'SWAP') {
            container.innerHTML = `<div class="row">${fromHtml}${toHtml}</div>`;
        }

        // Загружаем список двигателей в datalist (если его еще нет)
        if(!document.getElementById('engine-options-parts')) {
            const dl = document.createElement('datalist');
            dl.id = 'engine-options-parts';
            // Используем глобальную переменную, если она заполнена, или грузим заново
            // Для упрощения просто добавим пустой, он заполнится при фокусе или загрузке
            document.body.appendChild(dl);
            populatePartsEngineList();
        }
    }

    async function populatePartsEngineList() {
        const res = await fetch('/api/engines' + noCache());
        const engs = await res.json();
        const dl = document.getElementById('engine-options-parts');
        dl.innerHTML = '';
        engs.forEach(e => dl.innerHTML += `<option value="${e.original_sn}">${e.current_sn}</option>`);
    }

    // Store Balance cache for Parts form
    let storeBalanceCache = [];

    async function loadStoreBalanceForPartsForm() {
        try {
            const res = await fetch('/api/store-balance' + noCache());
            if (!res.ok) return;
            
            storeBalanceCache = await res.json();
            
            // Populate datalists
            const nameList = document.getElementById('part-name-options');
            const pnList = document.getElementById('part-pn-options');
            
            if (nameList) {
                nameList.innerHTML = '';
                const uniqueNames = [...new Set(storeBalanceCache.map(p => p.part_name).filter(Boolean))];
                uniqueNames.forEach(name => {
                    nameList.innerHTML += `<option value="${name}">`;
                });
            }
            
            if (pnList) {
                pnList.innerHTML = '';
                const uniquePNs = [...new Set(storeBalanceCache.map(p => p.part_number).filter(Boolean))];
                uniquePNs.forEach(pn => {
                    pnList.innerHTML += `<option value="${pn}">`;
                });
            }
        } catch (err) {
            console.error('Error loading store balance for parts form:', err);
        }
    }

    function updatePartPNFromName() {
        const name = document.getElementById('part-name').value.trim();
        if (!name) return;
        
        // Find matching part in cache
        const match = storeBalanceCache.find(p => p.part_name === name);
        if (match && match.part_number) {
            document.getElementById('part-pn').value = match.part_number;
        }
    }

    async function checkPartInStoreBalance(name, pn) {
        if (!storeBalanceCache || storeBalanceCache.length === 0) {
            // Try to load if cache is empty
            await loadStoreBalanceForPartsForm();
        }
        
        // Check if part exists
        return storeBalanceCache.some(p => 
            (p.part_name && p.part_name.toLowerCase() === name.toLowerCase()) ||
            (p.part_number && p.part_number.toLowerCase() === pn.toLowerCase())
        );
    }

    let _partsSubmitting = false;
    async function submitPartForm() {
        if (_partsSubmitting) { return; }
        _partsSubmitting = true;
        const saveBtn = document.querySelector('#tab-parts-add .btn.btn-primary.px-4');
        if (saveBtn) { saveBtn.disabled = true; saveBtn.dataset._orig = saveBtn.innerHTML; saveBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Saving...'; }
        const date = document.getElementById('part-date').value || new Date().toISOString().split('T')[0];
        const action = document.getElementById('part-action').value || 'INSTALLED';
        const name = document.getElementById('part-name').value || 'Part';
        const pn = document.getElementById('part-pn').value || 'N/A';
        const sn = document.getElementById('part-sn').value || 'N/A';

        // Получаем значения из динамических полей (если они есть)
        const fromVal = document.getElementById('part-from-input') ? document.getElementById('part-from-input').value : '-';
        const toVal = document.getElementById('part-to-input') ? document.getElementById('part-to-input').value : '-';

        // Проверяем наличие запчасти в Store Balance
        const existsInStore = await checkPartInStoreBalance(name, pn);
        
        if (!existsInStore) {
            const confirmed = confirm(`⚠️ Запчасть "${name}" (P/N: ${pn}) не найдена в Store Balance.\n\nВы точно хотите сохранить эту операцию?`);
            if (!confirmed) {
                return; // Отменяем сохранение
            }
        }

        const payload = {
            date: date, action: action, part_name: name, part_number: pn, serial_number: sn,
            quantity: parseInt(document.getElementById('part-qty').value)||1,
            location: document.getElementById('part-loc').value,
            from_esn: fromVal, to_esn: toVal,
            reason: document.getElementById('part-rem').value
        };

        try {
            const res = await fetch('/api/actions/part', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload)});
            
            if (!res.ok) {
                const error = await res.json().catch(() => ({}));
                throw new Error(error.detail || 'Save failed');
            }
            
            document.getElementById('form-parts').reset();
            document.getElementById('part-dynamic-fields').innerHTML = '<p class="small text-muted mb-2">Select Action...</p>';
            switchPartsTab('list');
            await loadPartsHistory();
            refreshAfterDataChange();
            showSuccessNotification('✅ Part action saved!');
        } catch(e) { 
            showErrorNotification(`Error: ${e.message}`);
            console.error('Part save error:', e);
        } finally {
            _partsSubmitting = false;
            if (saveBtn) { saveBtn.disabled = false; saveBtn.innerHTML = saveBtn.dataset._orig || 'Save Record'; }
        }
    }

    async function loadPartsHistory() {
        const tb = document.getElementById('parts-history-body');
        if (!tb) return;
        tb.innerHTML = '<tr><td colspan="11" class="text-center text-muted py-3">Loading…</td></tr>';

        let res = await safeFetch('/api/parts/history' + noCache());
        if (!res || !res.ok) res = await safeFetch('/api/parts/history');
        
        let serverData = [];
        try { serverData = res && res.ok ? await res.json() : []; } catch { serverData = []; }

        tb.innerHTML = '';
        
        if(serverData.length === 0) {
            tb.innerHTML = '<tr><td colspan="11" class="text-center text-muted">No parts history</td></tr>';
            return;
        }

        serverData.forEach(r => {
            let badge = 'bg-secondary';
            if(r.action==='INSTALLED') badge='bg-success';
            if(r.action==='REMOVED') badge='bg-danger';
            if(r.action==='SWAP') badge='bg-warning';

            const safeSerialNumber = escapeHtml(r.serial_number || '');
            tb.innerHTML += `
                <tr data-log-id="${r.id || 0}">
                    <td class="delete-col delete-col-parts" style="display: none;">
                        <button class="btn btn-sm btn-danger" data-identifier="${safeSerialNumber}" onclick="deleteHistoryRecord('PARTS', ${r.id || 0}, this.dataset.identifier || '')" title="Delete">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                    <td>${escapeHtml(r.date)}</td>
                    <td><span class="badge ${badge}">${escapeHtml(r.action)}</span></td>
                    <td>${escapeHtml(r.part_name)}</td>
                    <td>${escapeHtml(r.part_number)}</td>
                    <td>${safeSerialNumber}</td>
                    <td>${escapeHtml(r.quantity)}</td>
                    <td>${escapeHtml(r.from_esn||'-')}</td>
                    <td>${escapeHtml(r.to_esn||'-')}</td>
                    <td>${escapeHtml(r.location||'-')}</td>
                    <td>${escapeHtml(r.reason||'-')}</td>
                </tr>`;
        });
    }
    // --- UTILIZATION LOGIC (UPDATED) ---
    let utilAircraftSummary = [];
    let utilSummaryById = new Map();
    let fullUtilData = []; // Храним полные данные для фильтрации
    let activeFilters = {}; // Храним состояние фильтров

    async function openUtilView() {
        hideAllViews();
        document.getElementById('view-util').style.display = 'block';
        await loadUtilHistory();
    }

    function switchUtilTab(t) {
        document.getElementById('tab-util-list').style.display = t==='list'?'block':'none';
        document.getElementById('tab-util-entry').style.display = t==='entry'?'block':'none';
        document.getElementById('tab-util-list-btn').className = t==='list'?'nav-link active':'nav-link';
        document.getElementById('tab-util-entry-btn').className = t==='entry'?'nav-link active':'nav-link';
        if(t==='list') loadUtilHistory(); else prepareUtilForm();
    }

    async function loadUtilHistory() {
        const tb = document.getElementById('util-history-body'); 
        if (!tb) return;
        tb.innerHTML = '<tr><td colspan="7" class="text-center text-muted py-3">Loading…</td></tr>';

        let res = await safeFetch('/api/history/FLIGHT' + noCache());
        if (!res || !res.ok) res = await safeFetch('/api/history/FLIGHT');
        
        let sData = [];
        try { sData = res && res.ok ? await res.json() : []; } catch { sData = []; }
        fullUtilData = sData;
        
        tb.innerHTML = '';
        
        if(sData.length===0) {
            tb.innerHTML = '<tr><td colspan="7" class="text-center text-muted">No flights recorded</td></tr>';
            return;
        }

        sData.forEach(r => {
            const ttDisplay = (typeof r.added_tt === 'number' && !isNaN(r.added_tt))
                ? r.added_tt.toFixed(2)
                : escapeHtml(r.added_tt ?? '0.00');
            const cyclesDisplay = r.cycles ?? r.added_tc ?? 0;
            const atlbLabel = r.ref ? `<strong>${escapeHtml(r.ref)}</strong>` : '<span class="text-muted">—</span>';
            const totalTtsn = escapeHtml(r.total_ttsn || '0:00');
            const totalTcsn = escapeHtml(String(r.total_tcsn ?? 0));
            const maintenanceBadge = r.maintenance ? '<span class="badge bg-warning text-white">Maintenance</span>' : '';

            tb.innerHTML += `
                <tr data-log-id="${r.id || 0}" class="${r.maintenance ? 'table-warning' : ''}">
                    <td class="delete-col-util" style="display: none;">
                        <button class="btn btn-sm btn-danger" onclick="deleteHistoryRecord('FLIGHT', ${r.id || 0}, '${r.aircraft}')" title="Delete">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                    <td>${r.date}</td>
                    <td><strong>${r.aircraft}</strong></td>
                    <td>${r.route}</td>
                    <td>${ttDisplay}</td>
                    <td>${cyclesDisplay}</td>
                    <td>
                        ${atlbLabel}
                        <div class="text-muted small">TTSN: ${totalTtsn} | TCSN: ${totalTcsn}</div>
                        ${maintenanceBadge}
                    </td>
                </tr>
            `;
        });
    }

    async function ensureUtilSummary(forceReload = false) {
        if (!forceReload && utilAircraftSummary.length > 0) {
            return;
        }

        try {
            const res = await fetch('/api/utilization/summary' + noCache());
            utilAircraftSummary = await res.json();
        } catch (err) {
            console.error('Failed to load utilization summary', err);
            utilAircraftSummary = [];
        }

        utilSummaryById = new Map();
        utilAircraftSummary.forEach(ac => {
            const idKey = String(ac.aircraft_id);
            utilSummaryById.set(idKey, ac);

            const tailNormalized = String(ac.tail_number || '').toUpperCase();
            if (tailNormalized) {
                utilSummaryById.set(tailNormalized, ac);
                const shortTail = tailNormalized.includes('-') ? tailNormalized.split('-').pop() : tailNormalized;
                utilSummaryById.set(shortTail, ac);
            }
        });
    }

    async function prepareUtilForm(selectedId, forceReload = false) {
        await ensureUtilSummary(forceReload);

        const sel = document.getElementById('util-ac');
        sel.innerHTML = '<option value="" disabled selected>Select Aircraft...</option>';

        utilAircraftSummary.forEach(ac => {
            sel.innerHTML += `<option value="${ac.aircraft_id}">${ac.tail_number}</option>`;
        });

        sel.onchange = function() {
            const picked = this.value;
            sel.dataset.selectedId = picked;
            updateUtilFormContext(picked);
        };

        const maintenanceCheckbox = document.getElementById('util-maintenance');
        if (maintenanceCheckbox && !maintenanceCheckbox.dataset.bound) {
            maintenanceCheckbox.addEventListener('change', (e) => setUtilMaintenanceMode(e.target.checked));
            maintenanceCheckbox.dataset.bound = 'true';
        }

        const targetId = selectedId ? String(selectedId) : (sel.dataset.selectedId || '');
        if (targetId && utilSummaryById.has(targetId)) {
            sel.value = targetId;
            sel.dataset.selectedId = targetId;
            updateUtilFormContext(targetId);
        } else {
            const statsField = document.getElementById('util-current-stats');
            statsField.value = '';
            statsField.title = '';
            sel.dataset.selectedId = '';
        }
    }

    function updateUtilFormContext(aircraftId) {
        const statsField = document.getElementById('util-current-stats');
        const atlbInput = document.getElementById('util-atlb');
        const summary = utilSummaryById.get(String(aircraftId));

        if (!summary) {
            statsField.value = '';
            statsField.title = '';
            return;
        }

        const ttInfo = summary.initial_ttsn && summary.initial_ttsn !== summary.current_ttsn
            ? `TT ${summary.current_ttsn} (base ${summary.initial_ttsn})`
            : `TT ${summary.current_ttsn}`;
        const tcInfo = summary.initial_tcsn !== summary.current_tcsn
            ? `TC ${summary.current_tcsn} (base ${summary.initial_tcsn})`
            : `TC ${summary.current_tcsn}`;
        const infoParts = [ttInfo, tcInfo];
        const titleParts = [`Start TT ${summary.initial_ttsn}`, `Start TC ${summary.initial_tcsn}`];
        if (summary.last_atlb_ref) {
            infoParts.push(`ATLB ${summary.last_atlb_ref}`);
        }
        if (summary.next_atlb_ref) {
            infoParts.push(`Next ${summary.next_atlb_ref}`);
        }

        statsField.value = infoParts.join(' | ');
        statsField.title = titleParts.join(' | ');

        if (summary.next_atlb_ref) {
            if (!atlbInput.value || atlbInput.value === summary.last_atlb_ref) {
                atlbInput.value = summary.next_atlb_ref;
            }
        }
    }

    function setUtilMaintenanceMode(isMaintenance) {
        const fhField = document.getElementById('util-fh');
        const fcField = document.getElementById('util-fc');
        if (isMaintenance) {
            fhField.dataset.prevValue = fhField.value;
            fcField.dataset.prevValue = fcField.value;
            fhField.value = '0.00';
            fcField.value = '0';
        } else {
            if (fhField.dataset.prevValue !== undefined) {
                fhField.value = fhField.dataset.prevValue;
                delete fhField.dataset.prevValue;
            }
            if (fcField.dataset.prevValue !== undefined) {
                fcField.value = fcField.dataset.prevValue || '1';
                delete fcField.dataset.prevValue;
            }
        }
        fhField.disabled = isMaintenance;
        fcField.disabled = isMaintenance;
    }

    // === ENGINE PARAMETERS TAB SWITCHING ===
    function switchParamTab(t) {
        document.getElementById('tab-param-entry').style.display = t==='entry'?'block':'none';
        document.getElementById('tab-param-history').style.display = t==='history'?'block':'none';
        document.getElementById('tab-param-entry-btn').className = t==='entry'?'nav-link active':'nav-link';
        document.getElementById('tab-param-history-btn').className = t==='history'?'nav-link active':'nav-link';
        if(t==='history') loadParameterHistory();
    }
    
    async function loadParameterHistory() {
        try {
            // Используем алиас, чтобы избежать конфликтов роутов FastAPI
            const res = await fetch('/api/engine-parameters/history');
            const history = await res.json();
            
            const tbody = document.getElementById('param-history-body');
            tbody.innerHTML = '';
            
            if (history.length === 0) {
                tbody.innerHTML = '<tr><td colspan="12" class="text-muted">No parameter records found</td></tr>';
                return;
            }
            
            history.sort((a, b) => (b.id || 0) - (a.id || 0));
            history.forEach(h => {
                const dateStr = h.date ? new Date(h.date).toLocaleDateString('ru-RU') : 'N/A';
                const createdStr = h.created_at ? new Date(h.created_at).toLocaleString('ru-RU') : 'N/A';
                
                const row = document.createElement('tr');
                row.setAttribute('data-log-id', h.id);
                row.innerHTML = `
                    <td class="delete-col-param" style="display: none;">
                        <button class="btn btn-sm btn-danger" onclick="deleteHistoryRecord('PARAMETER', ${h.id})" title="Delete">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                    <td>${dateStr}</td>
                    <td>${h.aircraft || 'N/A'}</td>
                    <td>Pos ${h.position || 'N/A'}</td>
                    <td>${h.engine_sn}</td>
                    <td>${h.n1_takeoff !== null ? h.n1_takeoff + '%' : 'N/A'}</td>
                    <td>${h.n2_takeoff !== null ? h.n2_takeoff + '%' : 'N/A'}</td>
                    <td>${h.egt_takeoff !== null ? h.egt_takeoff + '°C' : 'N/A'}</td>
                    <td>${h.n1_cruise !== null ? h.n1_cruise + '%' : 'N/A'}</td>
                    <td>${h.n2_cruise !== null ? h.n2_cruise + '%' : 'N/A'}</td>
                    <td>${h.egt_cruise !== null ? h.egt_cruise + '°C' : 'N/A'}</td>
                    <td>${createdStr}</td>
                `;
                tbody.appendChild(row);
            });
        } catch (err) {
            console.error('Error loading parameter history:', err);
            document.getElementById('param-history-body').innerHTML = 
                '<tr><td colspan="12" class="text-danger">Error loading history</td></tr>';
        }
    }

    async function submitUtilForm() {
        const date = document.getElementById('util-date').value;
        const aircraftSelect = document.getElementById('util-ac');
        const aircraftId = aircraftSelect.value;
        const fhRaw = document.getElementById('util-fh').value;
        const fcRaw = document.getElementById('util-fc').value;
        const isMaintenance = document.getElementById('util-maintenance').checked;

        const fh = parseFloat(fhRaw);
        const fc = parseInt(fcRaw);

        if (!date || !aircraftId) {
            alert("Выберите дату и самолет");
            return;
        }

        if (!isMaintenance && (isNaN(fh) || isNaN(fc))) {
            alert("Укажите налет и циклы");
            return;
        }

        const summary = utilSummaryById.get(String(aircraftId));

        const payload = {
            date: date,
            aircraft_id: parseInt(aircraftId, 10),
            aircraft_tail: summary ? summary.tail_number : aircraftSelect.options[aircraftSelect.selectedIndex]?.text,
            flight_from: document.getElementById('util-from').value.trim(),
            flight_to: document.getElementById('util-to').value.trim(),
            flight_hours: isNaN(fh) ? 0 : fh,
            flight_cycles: isNaN(fc) ? 0 : fc,
            atlb_ref: document.getElementById('util-atlb').value.trim(),
            maintenance: isMaintenance
        };

        try {
            const res = await fetch('/api/actions/utilization', {
                method:'POST',
                headers:{'Content-Type':'application/json'},
                body:JSON.stringify(payload)
            });

            if(!res.ok) {
                const err = await res.json().catch(() => null);
                const detail = err?.detail || err?.message || 'Server error';
                throw new Error(detail);
            }

            await prepareUtilForm(payload.aircraft_id, true);
            const fhField = document.getElementById('util-fh');
            const fcField = document.getElementById('util-fc');
            delete fhField.dataset.prevValue;
            delete fcField.dataset.prevValue;
            document.getElementById('form-util').reset();
            setUtilMaintenanceMode(false);
            switchUtilTab('list');
            alert("Налет сохранен");
        } catch(e) {
            console.error('Failed to save utilization', e);
            alert(`Error: ${e.message}`);
        }
    }
    // --- ATLB LOGIC ---
    let aircraftCache = []; // Кэш для хранения данных о самолетах

    async function openAtlbView() {
        hideAllViews();
        document.getElementById('view-atlb').style.display = 'block';
        updateHistory('atlb');
        switchAtlbTab('entry');

        await ensureUtilSummary();
        aircraftCache = utilAircraftSummary;

        const sel = document.getElementById('atlb-ac');
        const previousSelection = sel.dataset.selectedId;
        sel.innerHTML = '<option value="" disabled selected>Select A/C...</option>';

        aircraftCache.forEach(ac => {
            sel.innerHTML += `<option value="${ac.aircraft_id}">${ac.tail_number}</option>`;
        });

        let defaultId = previousSelection && utilSummaryById.has(String(previousSelection))
            ? previousSelection
            : (aircraftCache.length ? String(aircraftCache[0].aircraft_id) : '');

        if (defaultId) {
            sel.value = defaultId;
            sel.dataset.selectedId = defaultId;
            updateAcInfo();
        } else {
            sel.value = '';
            sel.dataset.selectedId = '';
            updateAcInfo();
        }
    }

    function switchAtlbTab(t) {
        document.getElementById('tab-atlb-entry').style.display = t==='entry'?'block':'none';
        document.getElementById('tab-atlb-list').style.display = t==='list'?'block':'none';
        document.getElementById('tab-atlb-entry-btn').className = t==='entry'?'nav-link active':'nav-link';
        document.getElementById('tab-atlb-list-btn').className = t==='list'?'nav-link active':'nav-link';
        if(t==='list') loadAtlbHistory();
    }

    // Автозаполнение при выборе самолета
    function updateAcInfo() {
        const sel = document.getElementById('atlb-ac');
        const aircraftId = sel.value;
        const summary = utilSummaryById.get(String(aircraftId));

        sel.dataset.selectedId = aircraftId || '';

        const msnField = document.getElementById('atlb-msn');
        const statsField = document.getElementById('atlb-stats');
        const lastDateField = document.getElementById('atlb-last-date');
        const lastSheetField = document.getElementById('atlb-last-sheet');
        const atlbNoField = document.getElementById('atlb-no');
        const atlbSuggestionList = document.getElementById('atlb-no-suggestions');

        if (!summary) {
            msnField.value = '';
            statsField.value = '';
            statsField.title = '';
            lastDateField.value = '';
            lastSheetField.value = '';
            if (atlbSuggestionList) {
                atlbSuggestionList.innerHTML = '';
            }
            if (atlbNoField) {
                atlbNoField.value = '';
                atlbNoField.placeholder = '';
            }
            return;
        }

        msnField.value = summary.msn || 'Unknown';

        const statsParts = [`TT ${summary.current_ttsn}`, `TC ${summary.current_tcsn}`];
        statsField.value = statsParts.join(' | ');
        statsField.title = `Start TT ${summary.initial_ttsn} | Start TC ${summary.initial_tcsn}`;

        lastDateField.value = summary.last_entry_date || '—';
        lastSheetField.value = summary.last_atlb_ref || '—';
        if (atlbSuggestionList) {
            atlbSuggestionList.innerHTML = '';
            if (summary.next_atlb_ref) {
                const opt = document.createElement('option');
                opt.value = summary.next_atlb_ref;
                atlbSuggestionList.appendChild(opt);
            }
        }
        atlbNoField.value = '';
        atlbNoField.placeholder = summary.next_atlb_ref || '';
    }

    // Калькулятор времени (самая важная часть)
    function calcTime(type) {
        const t1Str = document.getElementById(type === 'block' ? 'time-out' : 'time-off').value;
        const t2Str = document.getElementById(type === 'block' ? 'time-in' : 'time-on').value;
        const resField = document.getElementById(type === 'block' ? 'time-block-res' : 'time-flight-res');

        if (t1Str && t2Str) {
            const [h1, m1] = t1Str.split(':').map(Number);
            const [h2, m2] = t2Str.split(':').map(Number);
            
            let minutes1 = h1 * 60 + m1;
            let minutes2 = h2 * 60 + m2;
            
            // Если время "Прилета" меньше "Вылета", значит перешли полночь (+24 часа)
            if (minutes2 < minutes1) {
                minutes2 += 24 * 60;
            }
            
            const diff = minutes2 - minutes1;
            const diffH = Math.floor(diff / 60);
            const diffM = diff % 60;
            
            // Форматируем в HH:MM
            const hh = String(diffH).padStart(2, '0');
            const mm = String(diffM).padStart(2, '0');
            resField.value = `${hh}:${mm}`;
        }
    }
    // Функция блокировки времени для Maintenance Only
    function toggleFlightTimes() {
        const isMaint = document.getElementById('atlb-maint-only').checked;
        
        // Список полей времени, которые надо отключить
        const fields = ['time-out', 'time-in', 'time-off', 'time-on'];
        const routeFields = ['atlb-from', 'atlb-to'];

        fields.forEach(id => {
            const el = document.getElementById(id);
            el.disabled = isMaint; // Если галочка стоит -> выключаем
            if (isMaint) el.value = ''; // И очищаем значение
        });

        // Очищаем и расчетные поля
        if (isMaint) {
            document.getElementById('time-block-res').value = '';
            document.getElementById('time-flight-res').value = '';
        }

        routeFields.forEach(id => {
            const el = document.getElementById(id);
            if (!el) return;
            if (isMaint) {
                if (el.dataset.prevValue === undefined) {
                    el.dataset.prevValue = el.value;
                }
                el.value = '';
            } else if (el.dataset.prevValue !== undefined) {
                el.value = el.dataset.prevValue;
                delete el.dataset.prevValue;
            }
            el.disabled = isMaint;
        });
    }

    let _atlbSubmitting = false;
    async function submitAtlbForm() {
        if (_atlbSubmitting) { return; }
        _atlbSubmitting = true;
        const saveBtn = document.querySelector('#tab-atlb-entry .btn.btn-success');
        if (saveBtn) { saveBtn.disabled = true; saveBtn.dataset._orig = saveBtn.innerHTML; saveBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Saving...'; }
        const aircraftSelect = document.getElementById('atlb-ac');
        const aircraftId = aircraftSelect.value;
        if (!aircraftId) { alert('Выберите самолет'); return; }

        const isMaintenanceOnly = document.getElementById('atlb-maint-only').checked;

        const summary = utilSummaryById.get(String(aircraftId));
        const acId = parseInt(aircraftId, 10);

        // Для отправки нам нужно Flight Time
        const ftStr = document.getElementById('time-flight-res').value;
        const btStr = document.getElementById('time-block-res').value;
        
        if (!isMaintenanceOnly && !ftStr) { alert("Заполните время полета (Off/On)"); return; }

        const numberOrZero = (id) => {
            const raw = document.getElementById(id)?.value;
            const parsed = parseFloat(raw);
            return Number.isFinite(parsed) ? parsed : null;
        };

        const payload = {
            date: document.getElementById('atlb-date').value,
            aircraft_id: acId || 1,
            atlb_no: document.getElementById('atlb-no').value,
            from_apt: document.getElementById('atlb-from').value,
            to_apt: document.getElementById('atlb-to').value,
            out_time: document.getElementById('time-out').value,
            in_time: document.getElementById('time-in').value,
            block_time: btStr || (isMaintenanceOnly ? '00:00' : ''),
            off_time: document.getElementById('time-off').value,
            on_time: document.getElementById('time-on').value,
            flight_time: ftStr || (isMaintenanceOnly ? '00:00' : ''),
            cycles: isMaintenanceOnly ? 0 : 1,
            maintenance_type: document.getElementById('atlb-maint').value,
            maintenance_only: isMaintenanceOnly,
            oil_1: numberOrZero('oil-1'),
            oil_2: numberOrZero('oil-2'),
            oil_3: numberOrZero('oil-3'),
            oil_4: numberOrZero('oil-4'),
            oil_apu: numberOrZero('oil-apu'),
            hyd_1: numberOrZero('hyd-1'),
            hyd_2: numberOrZero('hyd-2'),
            hyd_3: numberOrZero('hyd-3'),
            hyd_4: numberOrZero('hyd-4')
            // Масло и гидравлику можно добавить в payload по аналогии
        };

        if (isMaintenanceOnly) {
            payload.from_apt = '';
            payload.to_apt = '';
            payload.out_time = '';
            payload.in_time = '';
            payload.off_time = '';
            payload.on_time = '';
        }

        try {
            console.log('Submitting ATLB payload', payload);
            const res = await fetch('/api/actions/atlb', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload)});
            if(res.ok) {
                alert("ATLB Saved!");
                await ensureUtilSummary(true);
                document.getElementById('form-atlb').reset();
                toggleFlightTimes();
                aircraftSelect.value = String(aircraftId);
                aircraftSelect.dataset.selectedId = String(aircraftId);
                updateAcInfo();
                switchAtlbTab('list');
            } else {
                let errorMessage = '';
                try {
                    errorMessage = await res.text();
                    if (errorMessage) {
                        const maybeJson = JSON.parse(errorMessage);
                        if (maybeJson.detail) {
                            errorMessage = Array.isArray(maybeJson.detail)
                                ? maybeJson.detail.map(item => item.msg || JSON.stringify(item)).join('\n')
                                : String(maybeJson.detail);
                        }
                    }
                } catch (parseErr) {
                    console.warn('Failed to parse error response', parseErr);
                }
                console.error('ATLB save failed', res.status, errorMessage);
                alert(errorMessage || `Ошибка сервера (${res.status})`);
            }
        } catch(e) { alert("Ошибка сети"); }
    }

    function formatLiftValue(value) {
        if (value === null || value === undefined) {
            return '-';
        }
        const num = Number(value);
        if (Number.isNaN(num)) {
            return '-';
        }
        if (num === 0) {
            return '0';
        }
        return Number.isInteger(num) ? num.toString() : num.toFixed(1);
    }

    // --- ENGINE BUTTON LOGIC ---
    let isDashboardOpen = true;
    let engineClickTimer = null;
    let engineClickCount = 0;
    let fanSpinTimeout = null;

    function handleEngineButtonClick(event) {
        event.preventDefault();
        event.stopPropagation();

        const wrapperEl = document.getElementById('engine-btn-wrapper');
        if (wrapperEl && wrapperEl.dataset.dragged === 'true') {
            return;
        }

        // Проверяем если открыто какое субменю - закрываем только его
        const reportsSubmenu = document.getElementById('reports-radial-menu');
        const manualsSubmenu = document.getElementById('manuals-radial-menu');
        const aircraftSubmenu = document.getElementById('aircraft-selector-menu');
        const positionsSubmenu = document.getElementById('positions-selector-menu');
        
        if (reportsSubmenu && reportsSubmenu.classList.contains('show')) {
            hideReportsSubmenu();
            return;
        }
        
        if (manualsSubmenu && manualsSubmenu.classList.contains('show')) {
            hideManualsSubmenu();
            return;
        }

        if (positionsSubmenu && positionsSubmenu.classList.contains('show')) {
            hidePositionsSubmenu();
            // Return to aircraft menu
            const aircraftMenu = document.getElementById('aircraft-selector-menu');
            if (aircraftMenu) aircraftMenu.classList.add('show');
            return;
        }

        if (aircraftSubmenu && aircraftSubmenu.classList.contains('show')) {
            hideBoroscopeReportsSubmenu();
            return;
        }

        engineClickCount += 1;

        if (engineClickTimer) {
            clearTimeout(engineClickTimer);
        }

        engineClickTimer = setTimeout(() => {
            if (engineClickCount === 1) {
                toggleEngineMenu();
            } else if (engineClickCount === 2) {
                toggleEngineMenu(false);
                toggleDashboardEngine();
            } else if (engineClickCount >= 3) {
                toggleEngineMenu(false);
                triggerEngineFanSpin();
            }

            engineClickCount = 0;
            engineClickTimer = null;
        }, 240);
    }

    function triggerEngineFanSpin() {
        const fan = document.querySelector('.engine-fan');
        if (!fan) {
            return;
        }

        fan.classList.add('spin');

        if (fanSpinTimeout) {
            clearTimeout(fanSpinTimeout);
        }

        fanSpinTimeout = setTimeout(() => {
            fan.classList.remove('spin');
            fanSpinTimeout = null;
        }, 2600);
    }

    function toggleEngineMenu(forceState) {
        const menu = document.getElementById('engine-btn-menu');
        const button = document.getElementById('engine-toggle-btn');
        if (!menu || !button) {
            return;
        }

        const shouldOpen = typeof forceState === 'boolean'
            ? forceState
            : !menu.classList.contains('show');

        if (shouldOpen) {
            menu.classList.add('show');
            button.classList.add('menu-open');
        } else {
            menu.classList.remove('show');
            button.classList.remove('menu-open');
            
            // Full cleanup of all submenus when closing main menu
            hideReportsSubmenu();
            hideManualsSubmenu();
            const aircraftMenu = document.getElementById('aircraft-selector-menu');
            const positionsMenu = document.getElementById('positions-selector-menu');
            if (aircraftMenu) { aircraftMenu.style.display = 'none'; aircraftMenu.classList.remove('show'); }
            if (positionsMenu) { positionsMenu.style.display = 'none'; positionsMenu.classList.remove('show'); }
            menu.classList.remove('aircraft-selector-active');
            menu.classList.remove('reports-submenu-active');
        }
    }

    function handleEngineMenuSelection(action) {
        toggleEngineMenu(false);

        if (action === 'reports') {
            const submenu = document.getElementById('reports-submenu');
            if (submenu) {
                if (submenu.style.display === 'none') {
                    toggleReportsMenu();
                }
                submenu.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        } else if (action === 'manuals') {
            // Open Google Drive link
            window.open('https://drive.google.com/drive/folders/1bbJWHMuKwmkOccrHHq6uioA_Re4pukBM?usp=sharing', '_blank');
        } else if (action === 'folders') {
            showSuccessNotification('Folders shortcut activated.');
        }
    }

    // === REPORTS SUBMENU FUNCTIONS ===
    function toggleReportsSubmenu() {
        const submenu = document.getElementById('reports-radial-menu');
        const mainMenu = document.getElementById('engine-btn-menu');
        if (submenu) {
            const isShowing = submenu.classList.contains('show');
            
            if (isShowing) {
                // Close Reports submenu
                submenu.classList.remove('show');
                if (mainMenu) {
                    mainMenu.classList.remove('reports-submenu-active');
                }
            } else {
                // Open Reports submenu
                submenu.classList.add('show');
                if (mainMenu) {
                    mainMenu.classList.add('reports-submenu-active');
                }
            }
        }
    }

    function hideReportsSubmenu() {
        const submenu = document.getElementById('reports-radial-menu');
        const mainMenu = document.getElementById('engine-btn-menu');
        if (submenu) {
            submenu.classList.remove('show');
        }
        if (mainMenu) {
            mainMenu.classList.remove('reports-submenu-active');
        }
    }

    // === MANUALS SUBMENU FUNCTIONS ===
    function toggleManualsSubmenu() {
        const submenu = document.getElementById('manuals-radial-menu');
        if (submenu) {
            submenu.classList.toggle('show');
        }
    }

    function hideManualsSubmenu() {
        const submenu = document.getElementById('manuals-radial-menu');
        if (submenu) {
            submenu.classList.remove('show');
        }
    }

    function openManualsBoeing() {
        hideManualsSubmenu();
        toggleEngineMenu(false);
        // Open Boeing 747-200 manuals
        window.open('#', '_blank');
    }

    function openManualsGECards() {
        hideManualsSubmenu();
        toggleEngineMenu(false);
        // GE Cards - placeholder for now
        alert('GE Cards section coming soon!');
    }

    // === BORESCOPE REPORTS FUNCTIONS ===
    function toggleBoroscopeReportsSubmenu() {
        const submenu = document.getElementById('aircraft-selector-menu');
        const reportsMenu = document.querySelector('.reports-radial-menu');
        const mainMenu = document.getElementById('engine-btn-menu');
        
        if (submenu) {
            const isHidden = submenu.style.display === 'none' || getComputedStyle(submenu).display === 'none';
            submenu.style.display = isHidden ? 'flex' : 'none';
            submenu.classList.toggle('show', isHidden);
            
            // Hide main menu items when showing aircraft menu
            if (mainMenu) {
                mainMenu.classList.toggle('aircraft-selector-active', isHidden);
            }
            
            // Hide Reports menu when showing aircraft menu
            if (reportsMenu) {
                reportsMenu.style.display = isHidden ? 'none' : 'flex';
                reportsMenu.classList.toggle('show', !isHidden);
            }
        }
    }

    function hideBoroscopeReportsSubmenu() {
        const aircraftMenu = document.getElementById('aircraft-selector-menu');
        const positionsMenu = document.getElementById('positions-selector-menu');
        const reportsMenu = document.querySelector('.reports-radial-menu');
        const mainMenu = document.getElementById('engine-btn-menu');
        
        if (aircraftMenu) { aircraftMenu.style.display = 'none'; aircraftMenu.classList.remove('show'); }
        if (positionsMenu) { positionsMenu.style.display = 'none'; positionsMenu.classList.remove('show'); }
        if (reportsMenu) { reportsMenu.style.display = 'flex'; reportsMenu.classList.add('show'); }
        if (mainMenu) {
            mainMenu.classList.remove('aircraft-selector-active');
            mainMenu.classList.add('reports-submenu-active');
        }
    }

    function selectAircraft(aircraft) {
        window.selectedAircraft = aircraft;
        const aircraftMenu = document.getElementById('aircraft-selector-menu');
        const positionsMenu = document.getElementById('positions-selector-menu');
        const mainMenu = document.getElementById('engine-btn-menu');
        
        if (aircraftMenu) { aircraftMenu.style.display = 'none'; aircraftMenu.classList.remove('show'); }
        if (positionsMenu) { positionsMenu.style.display = 'flex'; positionsMenu.classList.add('show'); }
        if (mainMenu) { mainMenu.classList.add('aircraft-selector-active'); }
    }

    function hidePositionsSubmenu() {
        const positionsMenu = document.getElementById('positions-selector-menu');
        const aircraftMenu = document.getElementById('aircraft-selector-menu');
        
        if (positionsMenu) { positionsMenu.style.display = 'none'; positionsMenu.classList.remove('show'); }
        if (aircraftMenu) { aircraftMenu.style.display = 'flex'; aircraftMenu.classList.add('show'); }
    }

    async function loadBoroscopeReportData(aircraft, position) {
        try {
            const positions = position === 'ALL' ? [1, 2, 3, 4] : [position];
            const reportData = {
                aircraft: aircraft,
                positions: []
            };

            // Load all necessary data with error handling (don't fail on 404/405)
            const fetchSafe = (url) => fetch(url).then(r => {
                if (!r.ok) {
                    console.warn(`API ${url} returned ${r.status}, using empty data`);
                    return [];
                }
                return r.json();
            }).catch(e => {
                console.warn(`Failed to fetch ${url}:`, e);
                return [];
            });

            const [engines, installations, utilization, engParams, borescope, dashboardData] = await Promise.all([
                fetchSafe(`/api/engines${noCache()}`),
                fetchSafe(`/api/history/INSTALL${noCache()}`),
                fetchSafe(`/api/aircraft-utilization${noCache()}`),
                fetchSafe(`/api/eng-parameters${noCache()}`),
                fetchSafe(`/api/history/BORESCOPE${noCache()}`),
                fetchSafe(`/api/dashboard/aircraft-details${noCache()}`)
            ]);

            // Handle API responses that wrap data in object
            const utilizationData = Array.isArray(utilization) ? utilization : (utilization.data || []);
            const engParamsData = Array.isArray(engParams) ? engParams : (engParams.data || []);
            const boroscopeData = Array.isArray(borescope) ? borescope : (borescope.data || []);
            const enginesData = Array.isArray(engines) ? engines : (engines.data || []);
            const installationsData = Array.isArray(installations) ? installations : (installations.data || []);

            // Get latest utilization for the aircraft (use defaults if not found)
            const latestUtil = utilizationData
                .filter(u => u.aircraft === aircraft)
                .sort((a, b) => new Date(b.date) - new Date(a.date))[0] || {
                aircraft: aircraft,
                current_total_hrs: 0,
                current_cycles: 0,
                date: new Date().toISOString()
            };

            // Collect data for each position (skip empty positions)
            for (const pos of positions) {
                const posData = await collectPositionData(
                    aircraft, pos, enginesData, installationsData, utilizationData, 
                    engParamsData, boroscopeData, latestUtil, dashboardData
                );
                if (posData) reportData.positions.push(posData);
            }

            if (reportData.positions.length === 0) {
                alert('No engines found for selected position(s)');
                return;
            }

            openBoroscopeReportsModal(reportData);
        } catch (error) {
            console.error('Error loading borescope report data:', error);
            alert('Error loading report data: ' + error.message);
        }
    }

    async function collectPositionData(aircraft, position, engines, installations, utilization, engParams, borescope, latestUtil, dashboardData) {
        try {
            console.log(`\n📍 Collecting data for ${aircraft} Position ${position}`);
            
            // ✅ ПРИОРИТЕТ: используем dashboard данные (там только УСТАНОВЛЕННЫЕ двигатели!)
            const dashboardDataArray = Array.isArray(dashboardData) ? dashboardData : (dashboardData?.data || []);
            const aircraftInDashboard = dashboardDataArray.find(ac => ac.tail_number === aircraft);
            
            // Если самолета нет в dashboard или нет positions для него - пропускаем
            if (!aircraftInDashboard || !aircraftInDashboard.positions) {
                console.log(`⚠️ Aircraft ${aircraft} not found in dashboard data - skipping`);
                return null;
            }
            
            // Ищем двигатель на этой позиции из dashboard (positions - это массив [pos1, pos2, pos3, pos4])
            // Position 1 = index 0, Position 2 = index 1, etc
            const positionIndex = position - 1;
            const engineOnPosition = aircraftInDashboard.positions[positionIndex];
            
            // Если двигателя нет на этой позиции в dashboard - позиция пустая!
            if (!engineOnPosition || !engineOnPosition.original_sn) {
                console.log(`❌ Position ${position} is EMPTY (no engine in dashboard) - skipping`);
                return null;
            }
            
            console.log(`✅ Found engine on position ${position}:`, {
                original_sn: engineOnPosition.original_sn,
                current_sn: engineOnPosition.current_sn,
                tsn_on_aircraft: engineOnPosition.tsn_on_aircraft
            });
            
            // ⚠️ Проверка удаленного двигателя (только при явном флаге)
            if (position === 4 && (engineOnPosition.is_deleted === true || engineOnPosition.deleted === true)) {
                console.log(`❌ Position 4 is marked as DELETED - skipping`);
                return null;
            }
            
            // 2. Ищем ПОСЛЕДНИЙ borescope inspection для этого двигателя
            const matchingSN = (engineOnPosition.current_sn || engineOnPosition.original_sn || '').trim();
            const altSN = (engineOnPosition.original_sn || engineOnPosition.current_sn || '').trim();
            const latestBorescope = borescope && borescope.length > 0 ?
                borescope
                    .filter(b => {
                        // Ищем по Orig SN (как мы сохраняем в inspection.serial_number)
                        return b.serial_number === matchingSN || 
                               b.serial_number === engineOnPosition.original_sn ||
                               b.serial_number === engineOnPosition.current_sn;
                    })
                    .sort((a, b) => new Date(b.date) - new Date(a.date))[0] : null;
            
            console.log(`📸 Borescope inspection:`, latestBorescope ? {
                date: latestBorescope.date,
                work_type: latestBorescope.work_type,
                inspector: latestBorescope.inspector,
                has_photos: !!latestBorescope.inspection_report
            } : 'NOT FOUND');
            
            // 3. Ищем ПОСЛЕДНЮЮ установку для получения информации об установке
            // ✅ ИСПРАВЛЕНО: используем правильные поля из installation records
            const installationRecord = installations
                .filter(inst => 
                    (inst.original_sn === engineOnPosition.original_sn || 
                     inst.current_sn === engineOnPosition.current_sn) &&
                    inst.install_to === aircraft &&
                    (inst.position === position || inst.position === String(position))
                )
                .sort((a, b) => new Date(b.date) - new Date(a.date))[0];
            
            console.log(`📦 Installation record:`, installationRecord ? {
                date: installationRecord.date,
                location_from: installationRecord.location_from,
                ac_ttsn: installationRecord.ac_ttsn,
                ac_tcsn: installationRecord.ac_tcsn
            } : 'NOT FOUND');
            
            // 4. TSN/CSN на самолете (уже есть в engineOnPosition из dashboard!)
            let tsn_on_ac = engineOnPosition.tsn_on_aircraft || 0;
            let csn_on_ac = engineOnPosition.csn_on_aircraft || 0;
            let till_date = latestUtil.date;
            
            console.log(`✅ Using dashboard TSN/CSN:`, { tsn_on_ac, csn_on_ac });
            
            // 5. Ищем ПОСЛЕДНИЕ eng parameters по самолету и позиции (приоритет)
            let latestEngParams = null;
            if (engineOnPosition && (engineOnPosition.n1_takeoff || engineOnPosition.n2_takeoff || engineOnPosition.egt_takeoff)) {
                // Берем прямо из dashboard (самая свежая запись по позиции)
                latestEngParams = {
                    date: engineOnPosition.param_date || 'N/A',
                    n1_takeoff: engineOnPosition.n1_takeoff,
                    n2_takeoff: engineOnPosition.n2_takeoff,
                    egt_takeoff: engineOnPosition.egt_takeoff,
                    n1_cruise: engineOnPosition.n1_cruise,
                    n2_cruise: engineOnPosition.n2_cruise,
                    egt_cruise: engineOnPosition.egt_cruise
                };
            } else if (engParams && engParams.length > 0) {
                latestEngParams = engParams
                    .filter(p => {
                        const ac = (p.aircraft || '').trim();
                        const pos = p.position;
                        if (!ac || !pos) return false;
                        return ac === aircraft && (pos === position || pos === String(position));
                    })
                    .sort((a, b) => new Date(b.date) - new Date(a.date))[0] || null;
            }
            
            // 6. Формируем данные позиции
            return {
                position: position,
                currentSN: engineOnPosition.current_sn,
                originalSN: engineOnPosition.original_sn,
                gssId: engineOnPosition.gss_sn || engineOnPosition.gss_id || 'N/A',
                installDate: installationRecord ? installationRecord.date : '—',
                supplier: installationRecord ? (installationRecord.location_from || '—') : '—',
                tsn: tsn_on_ac,
                csn: csn_on_ac,
                tillDate: till_date,
                engParams: latestEngParams,
                borescope: latestBorescope  // ✅ ПОСЛЕДНИЙ borescope с фотографиями!
            };
        } catch (error) {
            console.error('Error collecting position data:', error);
            return null;
        }
    }

    function openBoroscopeReportsModal(reportData) {
        const modal = document.getElementById('borescope-reports-modal');
        const title = document.getElementById('report-aircraft-title');
        const container = document.getElementById('report-content-container');

        title.textContent = reportData.aircraft;
        
        let html = '';
        for (const posData of reportData.positions) {
            html += generatePositionHTML(posData);
        }

        container.innerHTML = html;
        modal.style.display = 'block';
        window.currentReportData = reportData;
        window.boroscopeReportOpen = true;
    }

    function generatePositionHTML(posData) {
        let html = `
            <div style="border: 2px solid #4fc3f7; border-radius: 8px; padding: 12px 15px; margin-bottom: 8px;">
                <h2 style="color: #4fc3f7; text-decoration: underline; margin: 0 0 10px 0; padding-bottom: 6px; font-size: 16pt; border-bottom: 2px solid #4fc3f7;">POSITION #${posData.position}</h2>
                
                <table style="width: 100%; margin-bottom: 12px; border-collapse: collapse; font-size: 13px;">
                    <tr style="background: #f5f5f5;">
                        <td style="padding: 6px 8px; border: 1px solid #ddd;"><strong style="color: #000;">Current S/N:</strong></td>
                        <td style="padding: 6px 8px; border: 1px solid #ddd; color: #000; font-weight: bold;">${posData.currentSN}</td>
                    </tr>
                    <tr>
                        <td style="padding: 6px 8px; border: 1px solid #ddd;"><strong style="color: #000;">GSS ID:</strong></td>
                        <td style="padding: 6px 8px; border: 1px solid #ddd; color: #000; font-weight: bold;">${posData.gssId || 'N/A'}</td>
                    </tr>
                    <tr>
                        <td style="padding: 6px 8px; border: 1px solid #ddd;"><strong style="color: #000;">Original S/N:</strong></td>
                        <td style="padding: 6px 8px; border: 1px solid #ddd; color: #000; font-weight: bold;">${posData.originalSN}</td>
                    </tr>
                    <tr style="background: #f5f5f5;">
                        <td style="padding: 6px 8px; border: 1px solid #ddd;"><strong style="color: #000;">Installation Date:</strong></td>
                        <td style="padding: 6px 8px; border: 1px solid #ddd; color: #000; font-weight: bold;">${posData.installDate}</td>
                    </tr>
                    <tr>
                        <td style="padding: 6px 8px; border: 1px solid #ddd;"><strong style="color: #000;">Supplier:</strong></td>
                        <td style="padding: 6px 8px; border: 1px solid #ddd; color: #000; font-weight: bold;">${posData.supplier}</td>
                    </tr>
                    <tr style="background: #f5f5f5;">
                        <td style="padding: 6px 8px; border: 1px solid #ddd;"><strong style="color: #000;">TSN and CSN (on A/C):</strong></td>
                        <td style="padding: 6px 8px; border: 1px solid #ddd; color: #000; font-weight: bold;">TSN ${posData.tsn} CSN ${posData.csn} (till: ${posData.tillDate})</td>
                    </tr>
                </table>
        `;

        // ENG Parameters
        if (posData.engParams) {
            html += `
                <h3 style="color: #000; margin: 10px 0 6px 0; font-size: 14px;">ENG Parameters (Date: <span style="color: #0066cc;">${posData.engParams.date || 'N/A'}</span>):</h3>
                <ul style="margin: 4px 0; padding-left: 18px; color: #000; font-size: 12px; line-height: 1.3;">
                    <li>N1 Take Off: <strong>${posData.engParams.n1_takeoff || 'N/A'}</strong>%</li>
                    <li>N1 Cruise: <strong>${posData.engParams.n1_cruise || 'N/A'}</strong>%</li>
                    <li>N2 Take Off: <strong>${posData.engParams.n2_takeoff || 'N/A'}</strong>%</li>
                    <li>N2 Cruise: <strong>${posData.engParams.n2_cruise || 'N/A'}</strong>%</li>
                    <li>EGT Take Off: <strong>${posData.engParams.egt_takeoff || 'N/A'}</strong> C</li>
                    <li>EGT Cruise: <strong>${posData.engParams.egt_cruise || 'N/A'}</strong> C</li>
                </ul>
            `;
        } else {
            html += `
                <h3 style="color: #000; margin: 10px 0 6px 0; font-size: 14px;">ENG Parameters:</h3>
                <p style="color: #999; margin: 0; font-size: 12px;">No ENG parameters data available</p>
            `;
        }

        // Borescope Report
        if (posData.borescope) {
            html += `
                <h3 style="color: #000; margin: 10px 0 6px 0; font-size: 14px;">Borescope Report (Latest: <span style="color: #0066cc;">${posData.borescope.date || 'N/A'}</span>):</h3>
                <p style="color: #000; margin: 2px 0; font-size: 12px;"><strong>Inspector:</strong> <span style="font-weight: bold;">${posData.borescope.inspector || 'N/A'}</span></p>
                <p style="color: #000; margin: 2px 0; font-size: 12px;"><strong>Work Type:</strong> <span style="font-weight: bold;">${posData.borescope.work_type || 'N/A'}</span></p>
                <p style="color: #000; margin: 2px 0; font-size: 12px;"><strong>Comment:</strong> <span style="font-weight: bold;">${posData.borescope.comment || 'N/A'}</span></p>
                
                <h4 style="color: #000; margin: 8px 0 4px 0; font-size: 13px;">PHOTOS:</h4>
            `;

            // Парсим inspection_report если это строка JSON
            let inspectionReport = posData.borescope.inspection_report;
            if (typeof inspectionReport === 'string') {
                try {
                    inspectionReport = JSON.parse(inspectionReport);
                } catch (e) {
                    console.warn('Failed to parse inspection_report:', e);
                    inspectionReport = null;
                }
            }

            // Display photos in table format (Label | Photo 1 | Photo 2)
            if (inspectionReport && typeof inspectionReport === 'object') {
                const photos = inspectionReport.photos || [];
                if (photos.length > 0) {
                    html += '<table style="width: 100%; border-collapse: collapse; margin-top: 6px;">';
                    for (const photo of photos) {
                        html += `
                            <tr style="border: 1px solid #ddd;">
                                <td style="width: 10%; padding: 5px 6px; border-right: 1px solid #ddd; text-align: center; font-weight: bold; color: #000; font-size: 12px;">${photo.label || 'Photo'}</td>
                                <td style="width: 45%; padding: 5px 6px; border-right: 1px solid #ddd; text-align: center;">
                                    ${photo.photo1 ? `<img src="${photo.photo1}" style="max-width: 100%; max-height: 120px; cursor: pointer;" onclick="openBorescopePhoto(this.src);">` : ''}
                                </td>
                                <td style="width: 45%; padding: 5px 6px; text-align: center;">
                                    ${photo.photo2 ? `<img src="${photo.photo2}" style="max-width: 100%; max-height: 120px; cursor: pointer;" onclick="openBorescopePhoto(this.src);">` : ''}
                                </td>
                            </tr>
                        `;
                    }
                    html += '</table>';
                } else {
                    html += '<p style="color: #999; margin: 0; font-size: 12px;">No photos available</p>';
                }
            } else {
                html += '<p style="color: #999; margin: 0; font-size: 12px;">No photos available</p>';
            }
        } else {
            html += `
                <h3 style="color: #000; margin: 10px 0 6px 0; font-size: 14px;">Borescope Report:</h3>
                <p style="color: #999; margin: 0; font-size: 12px;">No borescope inspection data available</p>
            `;
        }

        html += '</div>';
        return html;
    }

    function closeBoroscopeReportsModal() {
        const modal = document.getElementById('borescope-reports-modal');
        if (modal) modal.style.display = 'none';
        window.currentReportData = null;
        window.boroscopeReportOpen = false;
    }

    function closeBoroscopeReportsModalOnBgClick(event) {
        // Закрыть только если клик был на фон (саму модаль), а не на внутреннее содержимое
        if (event.target.id === 'borescope-reports-modal') {
            closeBoroscopeReportsModal();
        }
    }

    async function exportReportToWord() {
        const reportData = window.currentReportData;
        if (!reportData) {
            alert('No report data to export');
            return;
        }

        alert('Preparing document with photos... Please wait.');
        
        const container = document.getElementById('report-content-container');
        let html = container.innerHTML;

        // В Word увеличиваем изображения на 20% (216x158)
        html = html.replace(/<img([^>]*?)>/g, (match, attrs) => {
            if (attrs.includes('width=') || attrs.includes('height=')) {
                return match;
            }
            return `<img${attrs} width="216" height="158">`;
        });
        
        // Удаляем все onclick и data-атрибуты
        html = html.replace(/onclick="[^"]*"/g, '');
        html = html.replace(/data-photo-url="[^"]*"/g, '');
        html = html.replace(/class="borescope-photo"/g, '');

        
        // Находим все img src с R2 URL и заменяем на proxy
        // Паттерн: src="https://pub-...r2.dev/borescope/..."
        const r2UrlPattern = /src="(https:\/\/pub-[^"]+\.r2\.dev\/[^"]+)"/g;
        let match;
        const r2ToProxyMap = new Map();
        
        while ((match = r2UrlPattern.exec(html)) !== null) {
            const originalUrl = match[1];
            const proxyUrl = `/api/borescope-photo-proxy/${encodeURIComponent(originalUrl)}`;
            r2ToProxyMap.set(originalUrl, proxyUrl);
        }
        
        console.log(`Found ${r2ToProxyMap.size} R2 images to replace with proxy`);
        
        // Заменяем все R2 URL на proxy URL
        for (const [originalUrl, proxyUrl] of r2ToProxyMap.entries()) {
            html = html.replace(`src="${originalUrl}"`, `src="${proxyUrl}"`);
            console.log(`Replaced: ${originalUrl.substring(0, 60)}... -> ${proxyUrl.substring(0, 60)}...`);
        }
        
        // Теперь загружаем все изображения (уже через proxy) и конвертируем в base64
        const allImgRegex = /<img[^>]*src="([^"]*)"[^>]*>/g;
        const imageUrls = [];
        
        while ((match = allImgRegex.exec(html)) !== null) {
            imageUrls.push(match[1]);
        }
        
        console.log(`Loading ${imageUrls.length} images through proxy...`);
        
        for (const url of imageUrls) {
            try {
                console.log(`Loading: ${url.substring(0, 80)}...`);
                const response = await fetch(url, { 
                    credentials: 'include'
                });
                
                if (response.ok) {
                    const blob = await response.blob();
                    const reader = new FileReader();
                    
                    await new Promise((resolve) => {
                        reader.onloadend = () => {
                            const base64 = reader.result;
                            html = html.replace(`src="${url}"`, `src="${base64}"`);
                            console.log(`✅ Embedded image: ${url.substring(0, 60)}...`);
                            resolve();
                        };
                        reader.onerror = () => {
                            console.warn(`FileReader error for: ${url}`);
                            resolve();
                        };
                        reader.readAsDataURL(blob);
                    });
                } else {
                    console.warn(`⚠️ Server returned ${response.status} for ${url}`);
                }
            } catch (e) {
                console.warn(`Error loading ${url}: ${e.message}`);
            }
        }
        
        const fullHtml = `
            <html>
                <head>
                    <meta charset="UTF-8">
                    <style>
                        body { font-family: Arial, sans-serif; margin: 10px; }
                        h1 { font-size: 28pt; font-weight: bold; color: black; text-align: center; margin-bottom: 30px; }
                        h2 { 
                            font-size: 16pt; 
                            font-weight: bold; 
                            color: #4fc3f7; 
                            text-decoration: underline; 
                            margin-top: 20px;
                            padding: 20px;
                            border: 6px solid #4fc3f7;
                            border-radius: 5px;
                        }
                        h3, h4 { 
                            color: #000; 
                            margin-top: 15px; 
                            padding: 12px;
                            background: #f0f8ff;
                            border-left: 5px solid #4fc3f7;
                        }
                        table { 
                            width: 100%; 
                            border-collapse: collapse; 
                            margin: 15px 0;
                            border: 5px solid #4fc3f7;
                        }
                        td { 
                            border: 5px solid #4fc3f7; 
                            padding: 20px;
                        }
                        .label { font-weight: bold; }
                        img { 
                            width: 216px !important; 
                            height: 158px !important;
                            display: block;
                            margin: 5px auto;
                            border: 2px solid #e0e0e0;
                            border-radius: 4px;
                        }
                        div[style*="border: 2px solid #4fc3f7"], div[style*="border: 5px solid #4fc3f7"] {
                            border: 6px solid #4fc3f7 !important;
                            padding: 25px !important;
                            margin: 10px 0 !important;
                            width: 100% !important;
                            box-sizing: border-box !important;
                        }
                    </style>
                </head>
                <body>
                    <h1>${reportData.aircraft}</h1>
                    ${html}
                </body>
            </html>
        `;

        const blob = new Blob([fullHtml], { type: 'application/msword' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `Aircraft_Report_${reportData.aircraft}_${new Date().toLocaleDateString()}.doc`;
        link.click();
        URL.revokeObjectURL(url);
        
        console.log('✅ Export complete');
    }

    async function exportReportToPDF() {
        const reportData = window.currentReportData;
        if (!reportData) {
            alert('No report data to export');
            return;
        }

        // Show loading indicator
        const loadingDiv = document.createElement('div');
        loadingDiv.style.cssText = 'position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #333; color: #fff; padding: 20px 40px; border-radius: 8px; z-index: 10000; font-weight: bold; font-size: 16px;';
        loadingDiv.textContent = 'Generating PDF...';
        document.body.appendChild(loadingDiv);

        try {
            const container = document.getElementById('report-content-container');
            if (!container) {
                throw new Error('Report container not found');
            }

            // Clone the container to modify it
            const clonedContainer = container.cloneNode(true);
            
            // Replace all R2 image URLs with proxy URLs and convert to base64
            const images = clonedContainer.querySelectorAll('img');
            console.log('Found images:', images.length);
            
            const imagePromises = Array.from(images).map(async (img) => {
                try {
                    let imgUrl = img.src;
                    console.log('Processing image:', imgUrl);
                    
                    // If it's an R2 URL, extract the path correctly
                    if (imgUrl && imgUrl.includes('pub-5e14ffe')) {
                        // Extract everything after pub-5e14ffe...r2.dev/
                        const match = imgUrl.match(/r2\.dev\/(.+)$/);
                        if (match) {
                            const filePath = match[1];
                            imgUrl = `/api/borescope-photo-proxy/${filePath}`;
                            console.log('Converted to proxy URL:', imgUrl);
                        }
                    }
                    
                    // If it's not a data URL, fetch and convert to base64
                    if (!imgUrl.startsWith('data:')) {
                        const response = await fetch(imgUrl);
                        if (!response.ok) throw new Error(`Failed to fetch image: ${response.status}`);
                        const blob = await response.blob();
                        const reader = new FileReader();
                        return new Promise((resolve) => {
                            reader.onload = () => {
                                img.src = reader.result;
                                console.log('Image converted to base64');
                                resolve();
                            };
                            reader.onerror = () => {
                                console.error('FileReader error');
                                resolve();
                            };
                            reader.readAsDataURL(blob);
                        });
                    }
                } catch (error) {
                    console.warn('Error loading image:', error);
                }
            });
            
            await Promise.all(imagePromises);
            console.log('All images converted to base64');
            
            // Add page breaks between positions - каждая позиция с новой страницы
            const positionDivs = clonedContainer.querySelectorAll('div[style*="border: 2px solid #4fc3f7"]');
            positionDivs.forEach((div, index) => {
                // Первая позиция начинается сразу после титула (не нужен page break)
                // Остальные позиции - с новой страницы
                if (index > 0) {
                    div.style.pageBreakBefore = 'always';
                }
                // Разрешаем контенту распределяться естественно
                div.style.pageBreakInside = 'auto';
            });

            // Create wrapper
            const wrapper = document.createElement('div');
            wrapper.id = 'pdf-wrapper-' + Date.now();
            wrapper.style.cssText = 'background: white; font-family: Arial, sans-serif;';
            
            // Title (большими буквами по центру, первая страница)
            const title = document.createElement('div');
            title.style.cssText = 'text-align: center; padding: 100px 20px 50px 20px; page-break-after: always;';
            title.innerHTML = `<h1 style="font-size: 48pt; font-weight: bold; color: #000; margin: 0; letter-spacing: 3px;">${reportData.aircraft}</h1>`;
            
            // Content wrapper (со второй страницы, с начала страницы)
            const contentWrapper = document.createElement('div');
            contentWrapper.style.cssText = 'padding: 5px 10px;';
            contentWrapper.appendChild(clonedContainer);
            
            wrapper.appendChild(title);
            wrapper.appendChild(contentWrapper);
            
            document.body.appendChild(wrapper);

            const opt = {
                margin: [8, 8, 8, 8],
                filename: `${reportData.aircraft}_report_${new Date().toISOString().split('T')[0]}.pdf`,
                image: { type: 'jpeg', quality: 0.95 },
                html2canvas: { 
                    scale: 2, 
                    logging: true, 
                    useCORS: true, 
                    allowTaint: true,
                    backgroundColor: '#ffffff'
                },
                jsPDF: { 
                    orientation: 'portrait', 
                    unit: 'mm', 
                    format: 'a4',
                    compress: true
                },
                pagebreak: { mode: 'css' }
            };

            console.log('Starting PDF generation...');
            // Generate PDF
            const pdfBlob = await html2pdf().set(opt).from(wrapper).outputPdf('blob');
            
            console.log('PDF generated successfully, size:', pdfBlob.size);
            
            // Clean up
            document.body.removeChild(wrapper);
            document.body.removeChild(loadingDiv);

            // Open PDF in new browser window (standard way)
            const pdfUrl = URL.createObjectURL(pdfBlob);
            const pdfWindow = window.open(pdfUrl, '_blank');
            
            if (!pdfWindow) {
                alert('Could not open PDF. Please check your popup blocker.');
                // Fallback: offer download
                const link = document.createElement('a');
                link.href = pdfUrl;
                link.download = opt.filename;
                link.click();
            }

        } catch (error) {
            console.error('PDF generation error:', error);
            if (document.body.contains(loadingDiv)) {
                document.body.removeChild(loadingDiv);
            }
            alert('Error generating PDF: ' + error.message);
        }
    }

    function printBoroscopeReport() {
        const modal = document.getElementById('borescope-reports-modal');
        const printWindow = window.open('', '', 'height=600,width=800');
        printWindow.document.write(modal.innerHTML);
        printWindow.document.close();
        printWindow.print();
    }

    function showBoroscopeReport() {
        hideReportsSubmenu();
        const engineMenu = document.querySelector('.engine-btn-menu');
        const reportsMenu = document.querySelector('.reports-radial-menu');
        const aircraftMenu = document.getElementById('aircraft-selector-menu');
        const positionsMenu = document.getElementById('positions-selector-menu');

        if (engineMenu) {
            engineMenu.classList.add('aircraft-selector-active');
        }

        if (engineMenu) engineMenu.style.display = 'flex';
        if (reportsMenu) { reportsMenu.style.display = 'none'; reportsMenu.classList.remove('show'); }
        if (positionsMenu) { positionsMenu.style.display = 'none'; positionsMenu.classList.remove('show'); }
        if (aircraftMenu) { aircraftMenu.style.display = 'flex'; aircraftMenu.classList.add('show'); }
    }

    function showEngineReportsView() {
        hideReportsSubmenu();
        toggleEngineMenu(false);
        const submenu = document.getElementById('reports-submenu');
        if (submenu) {
            toggleReportsMenu();
            submenu.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
    }

    function showPurchaseOrdersView() {
        hideReportsSubmenu();
        toggleEngineMenu(false);
        const submenu = document.getElementById('reports-submenu');
        if (submenu) {
            toggleReportsMenu();
            submenu.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
    }

    function showNameplateTrackerView() {
        hideReportsSubmenu();
        toggleEngineMenu(false);
        const submenu = document.getElementById('reports-submenu');
        if (submenu) {
            toggleReportsMenu();
            submenu.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
    }

    // Close submenu when clicking outside
    document.addEventListener('click', function(event) {
        const submenu = document.getElementById('reports-radial-menu');
        const reportsBtn = document.querySelector('.engine-menu-item-reports');
        
        if (submenu && !submenu.contains(event.target) && !reportsBtn.contains(event.target)) {
            hideReportsSubmenu();
        }
    });


    document.addEventListener('click', function(event) {
        const menu = document.getElementById('engine-btn-menu');
        const wrapperEl = document.getElementById('engine-btn-wrapper');
        if (!menu || !wrapperEl) {
            return;
        }

        if (!menu.classList.contains('show')) {
            return;
        }

        if (!wrapperEl.contains(event.target)) {
            toggleEngineMenu(false);
        }
    });

    function toggleDashboardEngine() {
        const btn = document.querySelector('.btn-engine-start');
        const widgets = document.getElementById('dashboard-widgets');
        const fleet = document.getElementById('fleet-section');

        toggleEngineMenu(false);

        isDashboardOpen = !isDashboardOpen; // Переключаем состояние

        if (isDashboardOpen) {
            // --- РАЗВЕРНУТЬ ---
            btn.classList.add('active'); // Включаем подсветку
            
            // Убираем класс сворачивания, добавляем появление
            widgets.classList.remove('dashboard-collapsed');
            fleet.classList.remove('dashboard-collapsed');
            
            widgets.classList.add('dashboard-expanded');
            fleet.classList.add('dashboard-expanded');
        } else {
            // --- СВЕРНУТЬ ---
            btn.classList.remove('active'); // Выключаем подсветку
            
            // Убираем появление, добавляем сворачивание
            widgets.classList.remove('dashboard-expanded');
            fleet.classList.remove('dashboard-expanded');
            
            widgets.classList.add('dashboard-collapsed');
            fleet.classList.add('dashboard-collapsed');
        }
    }

    // Обновим функцию загрузки, чтобы при старте кнопка загоралась
    // Добавьте эту строку в конец функции loadDashboardData():
    // document.getElementById('engine-toggle-btn').classList.add('active');
    // --- ENG PARAMETERS LOGIC ---
    let localTestParams = []; // Хранилище параметров

    let currentEnginesByAircraft = {}; // Хранит двигатели по самолетам

    async function openEngParamView() {
        hideAllViews();
        document.getElementById('view-eng-param').style.display = 'block';
        updateHistory('eng-param');
        
        // Загружаем самолеты
        const sel = document.getElementById('param-ac');
        sel.innerHTML = '<option value="">Select A/C...</option>';
        
        try {
            // Пробуем новый API
            const res = await fetch('/api/dashboard/aircraft-details');
            if (res.ok) {
                const aircrafts = await res.json();
                console.log('Loaded aircraft:', aircrafts);
                
                for (const ac of aircrafts) {
                    sel.innerHTML += `<option value="${ac.tail_number}">${ac.tail_number}</option>`;
                }
            } else {
                throw new Error('API failed');
            }
        } catch (err) {
            console.error('Error loading aircraft, using fallback:', err);
            // Fallback - всегда показываем самолеты
            sel.innerHTML = `
                <option value="">Select A/C...</option>
                <option value="ER-BAT">ER-BAT</option>
                <option value="ER-BAR">ER-BAR</option>
                <option value="ER-BAQ">ER-BAQ</option>
            `;
        }
        
        // Дата сегодня
        document.getElementById('param-date').valueAsDate = new Date();
    }

    async function loadEnginePositions() {
        const aircraft = document.getElementById('param-ac').value;
        const posSelect = document.getElementById('param-position');
        const engineSN = document.getElementById('param-engine-sn');
        
        if (!aircraft) {
            posSelect.value = '';
            engineSN.value = '';
            posSelect.onchange = null;
            return;
        }
        
        // Загружаем установленные двигатели для выбранного самолета
        try {
            const res = await fetch('/api/engines');
            if (!res.ok) throw new Error('Failed to fetch engines');
            
            const allEngines = await res.json();
            console.log('All engines:', allEngines);
            
            // Фильтруем только установленные на выбранном самолете
            const installedEngines = allEngines.filter(e => 
                e.aircraft === aircraft && e.status === 'INSTALLED'
            );
            
            console.log(`Installed engines on ${aircraft}:`, installedEngines);
            
            // Сохраняем для автозаполнения S/N
            currentEnginesByAircraft[aircraft] = installedEngines;
            
            // Если нет установленных двигателей
            if (installedEngines.length === 0) {
                engineSN.value = 'No engines installed on this aircraft';
                alert(`На самолете ${aircraft} нет установленных двигателей. Сначала установите двигатели через Installation.`);
                return;
            }
            
            // Автоматически заполним S/N при выборе позиции
            posSelect.onchange = () => {
                const pos = parseInt(posSelect.value);
                const engine = installedEngines.find(e => e.position === pos);
                if (engine) {
                    engineSN.value = engine.current_sn;
                    console.log(`Selected: Position ${pos} - ${engine.current_sn}`);
                } else {
                    engineSN.value = 'No engine on this position';
                }
            };
            
            // Если выбрана позиция - сразу покажем S/N
            if (posSelect.value) {
                posSelect.onchange();
            }
            
        } catch (err) {
            console.error('Error loading engines:', err);
            engineSN.value = 'Error loading engine data';
        }
    }

    // Логика скрытия полей при смене типа
    function toggleParamFields(section) { // section = 'to' или 'cr'
        const type = document.getElementById(`param-type-${section}`).value;
        const fieldsDiv = document.getElementById(`fields-${section}`);
        
        // Если в секции Takeoff выбрали Cruise -> скрываем поля (или наоборот, как вам удобно)
        // В вашем описании: "если выбираем одно, то на след строке будет то, что не выбрано"
        // Реализуем простую логику: если тип совпадает с названием секции - показываем, нет - скрываем/меняем
        
        // Для простоты: поля всегда видны, просто меняется заголовок или логика сохранения
        // Но если вы хотите прятать:
        /*
        if ( (section === 'to' && type === 'Cruise') || (section === 'cr' && type === 'Takeoff') ) {
             fieldsDiv.style.opacity = '0.5'; // Делаем полупрозрачным
             fieldsDiv.style.pointerEvents = 'none'; // Запрещаем ввод
        } else {
             fieldsDiv.style.opacity = '1';
             fieldsDiv.style.pointerEvents = 'auto';
        }
        */
    }

    let _engParamSubmitting = false;
    async function submitEngParams() {
        if (_engParamSubmitting) { return; }
        _engParamSubmitting = true;
        const saveBtn = document.querySelector('#tab-eng-param-entry .btn.btn-primary.px-4');
        if (saveBtn) { saveBtn.disabled = true; saveBtn.dataset._orig = saveBtn.innerHTML; saveBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Saving...'; }
        console.log('=== submitEngParams called ===');
        console.log('Function exists and running...');
        
        const date = document.getElementById('param-date').value;
        const ac = document.getElementById('param-ac').value;
        const position = document.getElementById('param-position').value;
        
        console.log('Form values:', { date, ac, position });
        
        if(!date || !ac || !position) { 
            showErrorNotification("Please fill in all required fields: Date, Aircraft, and Position");
            return; 
        }

        // Находим двигатель на этой позиции
        try {
            console.log('Fetching engines from /api/engines...');
            const res = await fetch(`/api/engines`);
            
            if (!res.ok) {
                throw new Error(`API error: ${res.status} ${res.statusText}`);
            }
            
            const allEngines = await res.json();
            console.log('All engines:', allEngines);
            console.log('Looking for:', { ac, position: parseInt(position), status: 'INSTALLED' });
            
            const engine = allEngines.find(e => 
                e.aircraft === ac && 
                e.position === parseInt(position) && 
                e.status === 'INSTALLED'
            );
            
            console.log('Found engine:', engine);
            
            if (!engine) {
                showErrorNotification(`No engine installed on ${ac} position ${position}! Please install an engine first via Installation form.`);
                return;
            }

            // Собираем данные параметров
            const params = {
                engine_id: engine.id,
                date: date,  // Передаем дату
                n1_takeoff: parseFloat(document.getElementById('to-n1').value) || null,
                n2_takeoff: parseFloat(document.getElementById('to-n2').value) || null,
                egt_takeoff: parseFloat(document.getElementById('to-egt').value) || null,
                n1_cruise: parseFloat(document.getElementById('cr-n1').value) || null,
                n2_cruise: parseFloat(document.getElementById('cr-n2').value) || null,
                egt_cruise: parseFloat(document.getElementById('cr-egt').value) || null
            };
            
            console.log('Parameters to save:', params);

            // Отправляем на backend
            console.log('Sending to /api/engines/parameters...');
            const saveRes = await fetch('/api/engines/parameters', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(params)
            });

            console.log('Save response status:', saveRes.status);

            if (saveRes.ok) {
                const result = await saveRes.json();
                console.log('Save successful:', result);
                
                // Показываем красивое уведомление
                showSuccessNotification(`Parameters for engine ${engine.current_sn} (${ac} Position ${position}) have been saved successfully!`);
                
                // Очищаем форму
                document.getElementById('form-eng-param').reset();
                document.getElementById('param-date').valueAsDate = new Date();
                
                // Обновляем историю параметров
                await loadParameterHistory();
            } else {
                const err = await saveRes.text();
                console.error('Save failed:', err);
                showErrorNotification(`Failed to save parameters: ${err}`);
            }
            
        } catch (err) {
            console.error('Error in submitEngParams:', err);
            showErrorNotification(`Error saving parameters: ${err.message}`);
        } finally {
            _engParamSubmitting = false;
            if (saveBtn) { saveBtn.disabled = false; saveBtn.innerHTML = saveBtn.dataset._orig || 'Save Parameters'; }
        }
    }
    // === UTILIZATION PARAMETERS LOGIC ===
    let utilizationParamsData = []; // Локальное хранилище данных

    async function openUtilizationParamView() {
        hideAllViews();
        document.getElementById('view-utilization-param').style.display = 'block';
        updateHistory('utilization-param');
        
        // Устанавливаем сегодняшнюю дату по умолчанию для обеих форм
        document.getElementById('util-param-date').valueAsDate = new Date();
        document.getElementById('aircraft-util-date').valueAsDate = new Date();
        
        // Загружаем список самолетов
        await loadAircraftDropdown();
    }
    
    async function loadAircraftDropdown() {
        try {
            const response = await fetch('/api/fleet');
            if (!response.ok) throw new Error('Failed to load fleet');
            
            const fleet = await response.json();
            const dropdown = document.getElementById('util-param-ac');
            
            // Сохраняем текущее значение
            const currentValue = dropdown.value;
            
            // Очищаем и заполняем заново
            dropdown.innerHTML = '<option value="">Выберите самолет...</option>';
            
            fleet.forEach(aircraft => {
                const option = document.createElement('option');
                option.value = aircraft.tail_number;
                option.textContent = aircraft.tail_number;
                dropdown.appendChild(option);
            });
            
            // Восстанавливаем значение если оно было
            if (currentValue) {
                dropdown.value = currentValue;
            }
        } catch (err) {
            console.error('Error loading aircraft dropdown:', err);
        }
    }

    function switchUtilParamTab(tab) {
        document.getElementById('tab-util-param-entry').style.display = tab === 'entry' ? 'block' : 'none';
        document.getElementById('tab-util-param-history').style.display = tab === 'history' ? 'block' : 'none';
        document.getElementById('tab-util-param-entry-btn').className = tab === 'entry' ? 'nav-link active' : 'nav-link';
        document.getElementById('tab-util-param-history-btn').className = tab === 'history' ? 'nav-link active' : 'nav-link';
        if (tab === 'history') {
            loadUtilParamHistory();
            loadAircraftUtilHistory();
        }
    }

    function switchUtilHistoryTab(tab) {
        document.getElementById('tab-util-param-periodic').style.display = tab === 'periodic' ? 'block' : 'none';
        document.getElementById('tab-util-param-aircraft').style.display = tab === 'aircraft' ? 'block' : 'none';
        document.getElementById('tab-util-param-periodic-btn').className = tab === 'periodic' ? 'nav-link active' : 'nav-link';
        document.getElementById('tab-util-param-aircraft-btn').className = tab === 'aircraft' ? 'nav-link active' : 'nav-link';
        if (tab === 'aircraft') {
            loadAircraftUtilHistory();
        }
    }

    async function onUtilAircraftChange() {
        // Clear engine details when aircraft changes
        document.getElementById('util-param-orig-sn').value = '';
        document.getElementById('util-param-gss-sn').value = '';
        
        const aircraft = document.getElementById('util-param-ac').value;
        if (!aircraft) {
            document.getElementById('all-positions-info').style.display = 'none';
            return;
        }
        
        try {
            // Загружаем информацию о всех позициях
            const response = await fetch(`/api/aircraft/${aircraft}`);
            if (!response.ok) throw new Error('Failed to load aircraft');
            
            const aircraft_data = await response.json();
            const infoContainer = document.getElementById('positions-info-content');
            infoContainer.innerHTML = '';
            
            // Показываем все 4 позиции
            for (let pos = 1; pos <= 4; pos++) {
                const engine = aircraft_data.engines && aircraft_data.engines.find(e => e.position === pos);
                if (engine) {
                    infoContainer.innerHTML += `
                        <div style="flex: 1; min-width: 200px; padding: 8px; background: white; border-radius: 4px; border: 1px solid #ddd;">
                            <div style="font-weight: bold; color: #0066cc; margin-bottom: 4px;">Position ${pos}</div>
                            <div style="font-size: 0.85rem;"><strong>Orig SN:</strong> ${engine.original_sn || '-'}</div>
                            <div style="font-size: 0.85rem;"><strong>GSS ID:</strong> ${engine.gss_sn || engine.original_sn || '-'}</div>
                            <div style="font-size: 0.85rem;"><strong>Current S/N:</strong> ${engine.current_sn || '-'}</div>
                        </div>
                    `;
                } else {
                    infoContainer.innerHTML += `
                        <div style="flex: 1; min-width: 200px; padding: 8px; background: #f5f5f5; border-radius: 4px; border: 1px solid #ddd;">
                            <div style="font-weight: bold; color: #999; margin-bottom: 4px;">Position ${pos}</div>
                            <div style="font-size: 0.85rem; color: #999;">No Engine</div>
                        </div>
                    `;
                }
            }
            
            document.getElementById('all-positions-info').style.display = 'block';
        } catch (err) {
            console.error('Error loading aircraft positions:', err);
        }
        
        // Auto-fetch when position is also selected
        if (document.getElementById('util-param-position').value) {
            await onUtilPositionChange();
        }
    }

    async function onUtilPositionChange() {
        const aircraft = document.getElementById('util-param-ac').value;
        const position = parseInt(document.getElementById('util-param-position').value);
        
        // Clear if no aircraft or position selected
        if (!aircraft || !position) {
            document.getElementById('util-param-orig-sn').value = '';
            document.getElementById('util-param-gss-sn').value = '';
            return;
        }
        
        try {
            // Fetch aircraft details to get engine at this position
            const response = await fetch(`/api/aircraft/${aircraft}`);
            if (!response.ok) {
                throw new Error('Failed to load aircraft');
            }
            
            const aircraft_data = await response.json();
            
            // Find engine at the selected position
            const engine = aircraft_data.engines && aircraft_data.engines.find(e => e.position === position);
            
            if (engine) {
                document.getElementById('util-param-orig-sn').value = engine.original_sn || '';
                document.getElementById('util-param-gss-sn').value = engine.gss_sn || engine.original_sn || '';
            } else {
                document.getElementById('util-param-orig-sn').value = '';
                document.getElementById('util-param-gss-sn').value = '';
            }
        } catch (err) {
            console.error('Error fetching engine details:', err);
            document.getElementById('util-param-orig-sn').value = '';
            document.getElementById('util-param-gss-sn').value = '';
        }
    }

    // togglePeriodFields removed - period fields are always enabled now

    let _utilParamSubmitting = false;
    async function submitUtilParams() {
        if (_utilParamSubmitting) { return; }
        _utilParamSubmitting = true;
        const saveBtn = document.querySelector('#tab-util-param-entry .btn.btn-primary.px-4');
        if (saveBtn) { saveBtn.disabled = true; saveBtn.dataset._orig = saveBtn.innerHTML; saveBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Saving...'; }
        const date = document.getElementById('util-param-date').value;
        const aircraft = document.getElementById('util-param-ac').value;
        const position = document.getElementById('util-param-position').value;
        const ttsn = document.getElementById('util-param-ttsn').value;
        const tcsn = document.getElementById('util-param-tcsn').value;
        const dateFrom = document.getElementById('util-param-date-from').value;
        const dateTo = document.getElementById('util-param-date-to').value;

        if (!date || !aircraft || !position || !ttsn || !tcsn || !dateFrom || !dateTo) {
            showErrorNotification('Пожалуйста, заполните все обязательные поля: Дата, Самолет, Позиция, TTSN, TCSN, Date From и Date To');
            return;
        }

        const data = {
            date: date,
            aircraft: aircraft,
            position: parseInt(position),
            ttsn: parseFloat(ttsn),
            tcsn: parseInt(tcsn),
            period: true,
            date_from: dateFrom,
            date_to: dateTo
        };

        // Сохраняем в базу данных через API
        try {
            const response = await fetch('/api/utilization-parameters', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            });
            
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.detail || 'Failed to save');
            }
            
            showSuccessNotification('Данные по Utilization Parameters успешно сохранены в базу данных!');
            
            // Очищаем форму
            document.getElementById('form-util-param').reset();
            document.getElementById('util-param-date').valueAsDate = new Date();
            
            // Обновляем историю
            await loadUtilParamHistory();
            // Обновляем дашборд, чтобы новые TTSN/TCSN применились
            if (typeof loadDashboardData === 'function') {
                await loadDashboardData();
            }
        } catch (err) {
            console.error('Error saving utilization parameters:', err);
            showErrorNotification('Ошибка сохранения: ' + err.message);
        } finally {
            _utilParamSubmitting = false;
            if (saveBtn) { saveBtn.disabled = false; saveBtn.innerHTML = saveBtn.dataset._orig || 'Сохранить'; }
        }
    }

    async function onAircraftUtilChange() {
        const aircraft = document.getElementById('aircraft-util-ac').value;
        if (!aircraft) return;
        
        try {
            const response = await fetch(`/api/aircraft/${aircraft}`);
            if (!response.ok) throw new Error('Failed to load aircraft');
            
            const aircraft_data = await response.json();
            // Можно здесь подтягивать текущие значения TTSN/TCSN если они сохранены
            // Пока оставим пустыми для ввода новых значений
            document.getElementById('aircraft-util-ttsn').value = '';
            document.getElementById('aircraft-util-tcsn').value = '';
        } catch (err) {
            console.error('Error fetching aircraft:', err);
        }
    }

    let _aircraftUtilSubmitting = false;
    async function submitAircraftUtil() {
        if (_aircraftUtilSubmitting) { return; }
        _aircraftUtilSubmitting = true;
        
        const aircraft = document.getElementById('aircraft-util-ac').value;
        const date = document.getElementById('aircraft-util-date').value;
        const ttsnInput = document.getElementById('aircraft-util-ttsn').value;
        const tcsn = document.getElementById('aircraft-util-tcsn').value;
        
        if (!aircraft || !date || !ttsnInput || !tcsn) {
            showErrorNotification('Пожалуйста, заполните все обязательные поля');
            _aircraftUtilSubmitting = false;
            return;
        }
        
        // Parse TTSN input (supports HH:MM and decimal)
        let ttsnValue;
        try {
            ttsnValue = parseFlightTime(ttsnInput);
        } catch (e) {
            showErrorNotification(e.message);
            _aircraftUtilSubmitting = false;
            return;
        }
        
        const saveBtn = document.querySelector('#form-aircraft-util .btn.btn-success');
        if (saveBtn) { saveBtn.disabled = true; saveBtn.dataset._orig = saveBtn.innerHTML; saveBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Saving...'; }
        
        try {
            // Обновляем данные самолёта И сохраняем историю
            const response = await fetch(`/api/aircraft-utilization`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    aircraft: aircraft,
                    date: date,
                    total_time: ttsnValue,
                    total_cycles: parseInt(tcsn)
                })
            });
            
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.detail || 'Failed to save');
            }
            
            showSuccessNotification('Total Aircraft Utilization успешно сохранены!');
            
            // Обновляем историю общего налета
            if (document.getElementById('aircraft-util-history-body')) {
                await loadAircraftUtilHistory();
            }
            
            // Перезагружаем дашборд
            setTimeout(async () => {
                if (typeof loadDashboardData === 'function') {
                    try {
                        await loadDashboardData();
                        console.log('Dashboard updated after aircraft util save');
                    } catch (e) {
                        console.error('Error updating dashboard:', e);
                    }
                }
            }, 300);
            
            // Очищаем форму
            document.getElementById('form-aircraft-util').reset();
            document.getElementById('aircraft-util-date').valueAsDate = new Date();
        } catch (err) {
            console.error('Error saving aircraft utilization:', err);
            showErrorNotification('Ошибка сохранения: ' + err.message);
        } finally {
            _aircraftUtilSubmitting = false;
            if (saveBtn) { saveBtn.disabled = false; saveBtn.innerHTML = saveBtn.dataset._orig || 'Сохранить'; }
        }
    }

    async function loadUtilParamHistory() {
        const tbody = document.getElementById('util-param-history-body');
        tbody.innerHTML = '<tr><td colspan="12" class="text-muted">Loading...</td></tr>';
        
        try {
            const response = await fetch('/api/utilization-parameters');
            if (!response.ok) {
                throw new Error('Failed to load data');
            }
            
            const data = await response.json();
            tbody.innerHTML = '';
            
            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="12" class="text-muted">Нет данных</td></tr>';
                return;
            }

        data.sort((a, b) => (b.id || 0) - (a.id || 0));
        data.forEach((item, index) => {
            const dateStr = new Date(item.date).toLocaleDateString('ru-RU');
            const createdStr = new Date(item.created_at).toLocaleString('ru-RU');
            const periodStr = item.period ? 'Да' : 'Нет';
            const positionStr = item.position ? item.position : '-';
            const origSnStr = item.orig_sn ? item.orig_sn : '-';
            const gssSnStr = item.gss_sn ? item.gss_sn : '-';
            const dateFromStr = item.date_from ? new Date(item.date_from).toLocaleDateString('ru-RU') : '-';
            const dateToStr = item.date_to ? new Date(item.date_to).toLocaleDateString('ru-RU') : '-';

            const row = document.createElement('tr');
            row.setAttribute('data-id', item.id);
            row.setAttribute('data-user', item.user || item.created_by || '');
            row.innerHTML = `
                <td class="delete-col-util-param" style="display: none;">
                    <button class="btn btn-sm btn-danger" onclick="deleteUtilParamRecord(${item.id})" title="Delete">
                        <i class="bi bi-trash"></i>
                    </button>
                </td>
                <td>${dateStr}</td>
                <td>${item.aircraft}</td>
                <td>${positionStr}</td>
                <td>${origSnStr}</td>
                <td>${gssSnStr}</td>
                <td>${item.ttsn}</td>
                <td>${item.tcsn}</td>
                <td>${periodStr}</td>
                <td>${dateFromStr}</td>
                <td>${dateToStr}</td>
                <td>${createdStr}</td>
            `;
            tbody.appendChild(row);
        });
        } catch (err) {
            console.error('Error loading utilization parameters:', err);
            tbody.innerHTML = '<tr><td colspan="12" class="text-danger">Loading error данных</td></tr>';
        }
        attachAllTableResizers();
    }
    
    async function deleteUtilParamRecord(id) {
        if (!confirm('Удалить эту запись из базы данных?')) return;
        
        try {
            const response = await fetch(`/api/utilization-parameters/${id}`, {
                method: 'DELETE'
            });
            
            if (!response.ok) {
                throw new Error('Failed to delete');
            }
            
            showSuccessNotification('Запись удалена из базы данных');
            await loadUtilParamHistory();
            if (typeof loadDashboardData === 'function') {
                await loadDashboardData();
            }
        } catch (err) {
            console.error('Error deleting record:', err);
            showErrorNotification('Ошибка удаления: ' + err.message);
        }
    }

    async function loadAircraftUtilHistory() {
        const tbody = document.getElementById('aircraft-util-history-body');
        if (!tbody) return; // Таблица не на этой странице
        
        tbody.innerHTML = '<tr><td colspan="5" class="text-muted">Loading...</td></tr>';
        
        try {
            const response = await fetch('/api/aircraft-utilization-history');
            if (!response.ok) {
                throw new Error('Failed to load data');
            }
            
            const data = await response.json();
            tbody.innerHTML = '';
            
            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-muted">Нет данных</td></tr>';
                return;
            }

            // Сортируем по дате (новые первыми)
            data.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            data.forEach((item) => {
                const dateStr = new Date(item.date).toLocaleDateString('ru-RU');
                const createdStr = new Date(item.created_at).toLocaleString('ru-RU');

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${dateStr}</td>
                    <td>${item.aircraft_tail_number || item.aircraft}</td>
                    <td>${formatFlightTime(item.total_time || 0)}</td>
                    <td>${item.total_cycles || 0}</td>
                    <td>${createdStr}</td>
                `;
                tbody.appendChild(row);
            });
        } catch (err) {
            console.error('Error loading aircraft utilization history:', err);
            tbody.innerHTML = '<tr><td colspan="5" class="text-danger">Ошибка загрузки данных</td></tr>';
        }
    }

    // === UTILIZATION HISTORY MODAL ===
    async function openUtilizationHistoryModal(tailNumber) {
        const modal = document.getElementById('utilization-history-modal');
        modal.style.display = 'flex';
        
        const tbody = document.getElementById('utilization-history-modal-body');
        tbody.innerHTML = '<tr><td colspan="8" class="text-muted">Loading...</td></tr>';
        
        try {
            const response = await fetch('/api/utilization-parameters');
            if (!response.ok) throw new Error('Failed to load data');
            
            const allData = await response.json();
            const filtered = allData.filter(item => item.aircraft === tailNumber);
            
            tbody.innerHTML = '';
            if (filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-muted">Нет данных для этого борта</td></tr>';
                return;
            }
            
            filtered.forEach(item => {
                const dateStr = new Date(item.date).toLocaleDateString('ru-RU');
                const createdStr = new Date(item.created_at).toLocaleString('ru-RU');
                const periodStr = item.period ? 'Да' : 'Нет';
                const dateFromStr = item.date_from ? new Date(item.date_from).toLocaleDateString('ru-RU') : '-';
                const dateToStr = item.date_to ? new Date(item.date_to).toLocaleDateString('ru-RU') : '-';
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${dateStr}</td>
                    <td>${item.aircraft}</td>
                    <td>${item.ttsn}</td>
                    <td>${item.tcsn}</td>
                    <td>${periodStr}</td>
                    <td>${dateFromStr}</td>
                    <td>${dateToStr}</td>
                    <td>${createdStr}</td>
                `;
                tbody.appendChild(row);
            });
        } catch (err) {
            console.error('Error loading modal history:', err);
            tbody.innerHTML = '<tr><td colspan="8" class="text-danger">Loading error</td></tr>';
        }
    }

    function closeUtilizationHistoryModal() {
        document.getElementById('utilization-history-modal').style.display = 'none';
    }

    // Close modal when clicking outside
    document.addEventListener('click', function(event) {
        const modal = document.getElementById('utilization-history-modal');
        if (modal && event.target === modal) {
            closeUtilizationHistoryModal();
        }
    });

    // Запускаем функцию после загрузки страницы
document.addEventListener("DOMContentLoaded", () => {
    makeElementDraggable(document.getElementById("engine-btn-wrapper"));

    const reportsState = localStorage.getItem('reports-menu-open');
    if (reportsState === 'true') {
        toggleReportsMenu(true);
    } else if (reportsState === 'false') {
        toggleReportsMenu(false);
    }

    const actionsState = localStorage.getItem('actions-menu-open');
    if (actionsState === 'false') {
        toggleActionsMenu(false);
    } else if (actionsState === 'true') {
        toggleActionsMenu(true);
    }

    const logisticsState = localStorage.getItem('logistics-menu-open');
    if (logisticsState === 'true') {
        toggleLogisticsMenu(true);
    } else if (logisticsState === 'false') {
        toggleLogisticsMenu(false);
    }
});

function makeElementDraggable(elmnt) {
    if (!elmnt) return;

    let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
    let isDragging = false; // Флаг: мы тащим или просто кликаем?

    // Обработчик нажатия кнопки мыши
    elmnt.onmousedown = dragMouseDown;

    function dragMouseDown(e) {
        e = e || window.event;
        e.preventDefault();
        
        // Получаем позицию курсора при старте
        pos3 = e.clientX;
        pos4 = e.clientY;
        
        // Считаем, что пока это не драг, а подготовка
        isDragging = false;
        elmnt.dataset.dragged = 'false';

        document.onmouseup = closeDragElement;
        document.onmousemove = elementDrag;
    }

    function elementDrag(e) {
        e = e || window.event;
        e.preventDefault();
        
        // Если мышь сдвинулась, ставим флаг "Это перетаскивание!"
        isDragging = true;
        elmnt.dataset.dragged = 'true';

        // Вычисляем новую позицию
        pos1 = pos3 - e.clientX;
        pos2 = pos4 - e.clientY;
        pos3 = e.clientX;
        pos4 = e.clientY;

        // Устанавливаем новые координаты элементу
        // (Убираем transform, чтобы он не мешал точному позиционированию после первого движения)
        elmnt.style.transform = "none"; 
        elmnt.style.top = (elmnt.offsetTop - pos2) + "px";
        elmnt.style.left = (elmnt.offsetLeft - pos1) + "px";
    }

    function closeDragElement() {
        // Остановка перемещения при отпускании кнопки
        document.onmouseup = null;
        document.onmousemove = null;

        if (elmnt.dataset.dragged === 'true') {
            setTimeout(() => {
                elmnt.dataset.dragged = 'false';
            }, 200);
        }
    }
}

function ensureEngineVideosPlaying() {
    document.querySelectorAll('.engine-video').forEach(video => {
        if (!video) return;

        const attemptPlay = () => {
            try {
                video.load();
            } catch (err) {
                console.warn('Video load issue:', err);
            }

            video.play().catch(() => {
                // Autoplay might still be blocked; we can retry on user interaction
                const handler = () => {
                    video.play().finally(() => {
                        document.removeEventListener('click', handler);
                    });
                };
                document.addEventListener('click', handler, { once: true });
            });
        };

        if (video.readyState >= 2) {
            attemptPlay();
        } else {
            video.addEventListener('loadeddata', attemptPlay, { once: true });
        }
    });
}
// --- ATLB FILTER LOGIC ---
let fullAtlbData = []; // Глобальная переменная для данных ATLB

async function loadAtlbHistory() {
    try {
        const res = await fetch('/api/history/ATLB' + noCache());
        if (!res.ok) {
            throw new Error('Failed to load ATLB history');
        }
        const data = await res.json();
        fullAtlbData = Array.isArray(data) ? data : [];
        initAtlbFilters();
        renderAtlbTable(fullAtlbData);
    } catch (err) {
        console.error('Failed to load ATLB history', err);
        const tb = document.getElementById('atlb-history-body');
        tb.innerHTML = '<tr><td colspan="24" class="text-danger">Error loading ATLB history</td></tr>';
    }
}

function toCellValue(value, dashOnEmpty = true) {
    if (value === undefined || value === null) {
        return dashOnEmpty ? '-' : '';
    }
    const str = String(value).trim();
    const normalized = str.toLowerCase();
    if (!str || normalized === 'undefined' || normalized === 'null') {
        return dashOnEmpty ? '-' : '';
    }
    return escapeHtml(str);
}

function renderAtlbTable(data) {
    const tb = document.getElementById('atlb-history-body');
    tb.innerHTML = '';

    if (!Array.isArray(data) || data.length === 0) {
        tb.innerHTML = '<tr><td colspan="24" class="text-muted">No ATLB records yet</td></tr>';
        return;
    }

    data.sort((a, b) => (b.id || 0) - (a.id || 0));
    data.forEach(r => {
        const maintenanceLabel = toCellValue(r.maintenance || (r.maintenance_only ? 'Maintenance' : ''), true);
        tb.innerHTML += `
            <tr>
                <td>${toCellValue(r.date)}</td>
                <td>${toCellValue(r.tail_number)}</td>
                <td class="fw-bold text-primary">${toCellValue(r.atlb_sheet)}</td>
                <td>${toCellValue(r.flight_leg)}</td>
                <td>${toCellValue(r.block_out)}</td>
                <td>${toCellValue(r.block_in)}</td>
                <td>${toCellValue(r.block_time)}</td>
                <td>${toCellValue(r.flight_off)}</td>
                <td>${toCellValue(r.flight_on)}</td>
                <td class="fw-bold">${toCellValue(r.flight_time_text)}</td>
                <td>${toCellValue(r.cycles ?? '')}</td>
                <td>${toCellValue(r.total_ttsn)}</td>
                <td>${toCellValue(r.total_tcsn)}</td>
                <td>${formatLiftValue(r.oil_1)}</td>
                <td>${formatLiftValue(r.oil_2)}</td>
                <td>${formatLiftValue(r.oil_3)}</td>
                <td>${formatLiftValue(r.oil_4)}</td>
                <td>${formatLiftValue(r.oil_apu)}</td>
                <td>${formatLiftValue(r.hyd_1)}</td>
                <td>${formatLiftValue(r.hyd_2)}</td>
                <td>${formatLiftValue(r.hyd_3)}</td>
                <td>${formatLiftValue(r.hyd_4)}</td>
                <td>${maintenanceLabel}</td>
                <td>${toCellValue(r.user)}</td>
            </tr>
        `;
    });
}

function initAtlbFilters() {
    const columns = [
        { key: 'date', htmlId: 'date' },
        { key: 'tail_number', htmlId: 'tail' },
        { key: 'atlb_sheet', htmlId: 'ref' },
        { key: 'flight_leg', htmlId: 'route' },
        { key: 'cycles', htmlId: 'cycles' },
        { key: 'user', htmlId: 'user' }
    ];

    columns.forEach(({ key: colKey, htmlId }) => {
        const uniqueValues = [...new Set(fullAtlbData.map(item => toCellValue(item[colKey] ?? '-', true)))].sort();

        const menu = document.getElementById(`filter-menu-atlb-${htmlId}`);
        if(!menu) return;

        // Генерируем HTML меню
        // 1. Добавляем поле поиска
        let html = `
            <div class="p-2">
                <input type="text" class="form-control form-control-sm filter-search-input" placeholder="Search..." autofocus>
            </div>
            <div class="filter-checkbox-item">
                <input type="checkbox" class="filter-select-all-atlb" checked id="all-atlb-${colKey}">
                <label for="all-atlb-${colKey}" class="fw-bold text-primary ms-2">Select All</label>
            </div>
            <hr class="my-1">
            <div class="filter-list-container" style="max-height: 200px; overflow-y: auto;">
        `;

        // 2. Генерируем список значений
        uniqueValues.forEach(val => {
            // Очищаем значение для использования в value
            const safeVal = String(val).replace(/"/g, '&quot;');
            html += `
                <div class="filter-checkbox-item filter-item-row">
                    <input type="checkbox" class="filter-val-atlb" data-col="${colKey}" value="${safeVal}" checked>
                    <span class="ms-2 filter-text">${val}</span>
                </div>
            `;
        });

        html += `</div>`; // Закрываем контейнер списка

        menu.innerHTML = html;
        
        // Останавливаем закрытие меню при клике
        menu.onclick = (e) => e.stopPropagation();

        // --- ЛОГИКА ПОИСКА ---
        const searchInput = menu.querySelector('.filter-search-input');
        const listContainer = menu.querySelector('.filter-list-container');
        const itemRows = listContainer.querySelectorAll('.filter-item-row');

        searchInput.oninput = function() {
            const searchText = this.value.toLowerCase();
            itemRows.forEach(row => {
                const text = row.querySelector('.filter-text').innerText.toLowerCase();
                if (text.includes(searchText)) {
                    row.style.display = 'flex';
                } else {
                    row.style.display = 'none';
                }
            });
        };

        // --- ЛОГИКА ЧЕКБОКСОВ ---
        const selectAllCb = menu.querySelector('.filter-select-all-atlb');
        const valCbs = menu.querySelectorAll('.filter-val-atlb');

        selectAllCb.onchange = function() {
            // При клике на "Select All" меняем состояние только ВИДИМЫХ чекбоксов (если работает поиск)
            // Или всех, если хотите поведение как в Excel (обычно Excel выбирает только отфильтрованное)
            // Для простоты пока меняем все:
            valCbs.forEach(cb => {
                // Если строка скрыта поиском, не трогаем её (опционально)
                // Но классический вариант - выбрать/снять всё:
                cb.checked = this.checked;
            });
            applyAtlbFilters();
        };

        valCbs.forEach(cb => {
            cb.onchange = function() {
                if (!this.checked) selectAllCb.checked = false;
                // Проверяем, все ли выбраны
                if (Array.from(valCbs).every(c => c.checked)) selectAllCb.checked = true;
                applyAtlbFilters();
            };
        });
    });
}


function applyAtlbFilters() {
    const columns = [
        { key: 'date', htmlId: 'date' },
        { key: 'tail_number', htmlId: 'tail' },
        { key: 'atlb_sheet', htmlId: 'ref' },
        { key: 'flight_leg', htmlId: 'route' },
        { key: 'cycles', htmlId: 'cycles' },
        { key: 'user', htmlId: 'user' }
    ];

    let filteredData = fullAtlbData;

    columns.forEach(({ key: colKey, htmlId }) => {
        const menu = document.getElementById(`filter-menu-atlb-${htmlId}`);
        if(!menu) return;

        const checkedBoxes = menu.querySelectorAll('.filter-val-atlb:checked');
        const checkedValues = Array.from(checkedBoxes).map(cb => cb.value);
        
        // Фильтрация
        filteredData = filteredData.filter(row => {
            const val = toCellValue(row[colKey] || '-', true);
            return checkedValues.includes(val);
        });

        // Подсветка иконки
        const allBoxes = menu.querySelectorAll('.filter-val-atlb');
        const icon = document.getElementById(`filter-icon-atlb-${htmlId}`);
        if(checkedBoxes.length < allBoxes.length) {
            icon.classList.add('text-primary');
            icon.classList.remove('text-muted');
        } else {
            icon.classList.remove('text-primary');
        }
    });

    renderAtlbTable(filteredData);
    attachAllTableResizers();
}
    // Функция фильтрации для таблицы Installation
    function filterInstallTable() {
        const input = document.getElementById("inst-search-input");
        const filter = input.value.toUpperCase();
        const table = document.getElementById("install-history-body");
        const tr = table.getElementsByTagName("tr");

        for (let i = 0; i < tr.length; i++) {
            if(tr[i].cells.length < 2) continue;
            let textContent = tr[i].textContent || tr[i].innerText;
            if (textContent.toUpperCase().indexOf(filter) > -1) {
                tr[i].style.display = "";
            } else {
                tr[i].style.display = "none";
            }
        }
    }

</script>

<!-- === AUTHENTICATION & USER MANAGEMENT JAVASCRIPT === -->
<script>
// === GLOBAL STATE ===
let currentUser = null;
let editingUserId = null;
let userCache = [];

// === AUTHENTICATION FUNCTIONS ===
async function handleLogin(event) {
    event.preventDefault();
    const username = document.getElementById('login-username').value;
    const password = document.getElementById('login-password').value;
    console.log('🔐 Login attempt:', username);
    try {
        const response = await fetch('/api/auth/login', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({username, password})
        });
        console.log('📡 Response status:', response.status);
        const data = await response.json();
        console.log('📦 Response data:', data);
        if (!response.ok) throw new Error(data.detail || 'Login failed');
        currentUser = data;
        console.log('✅ Login success:', currentUser);
        sessionStorage.setItem('currentUser', JSON.stringify(currentUser));
        const modal = document.getElementById('login-modal');
        if (modal) {
            modal.style.display = 'none';
            modal.classList.remove('show');
            console.log('🚪 Modal hidden');
        }
        initializeUserInterface();
        if (typeof openDashboardView === 'function') {
            console.log('📊 Opening dashboard');
            openDashboardView();
        }
        if (typeof loadDashboardData === 'function') {
            console.log('📈 Loading dashboard data');
            await loadDashboardData();
        }
    } catch (error) {
        console.error('❌ Login error:', error.message);
        const errorDiv = document.getElementById('login-error');
        if (errorDiv) {
            errorDiv.textContent = error.message;
            errorDiv.style.display = 'block';
        }
    }
}

function logout() {
    if (confirm('Are you sure you want to logout?')) {
        currentUser = null;
        sessionStorage.removeItem('currentUser');
        location.reload();
    }
}

function initializeUserInterface() {
    if (!currentUser) {
        console.warn('⚠️ currentUser is null');
        return;
    }
    console.log('👤 Initializing UI for:', currentUser.username, 'role:', currentUser.role);
    const initials = (currentUser.first_name[0] + currentUser.last_name[0]).toUpperCase();
    const userInitials = document.getElementById('user-initials');
    if (userInitials) userInitials.textContent = initials;
    const profileAvatar = document.getElementById('profile-avatar');
    if (profileAvatar) profileAvatar.textContent = initials;
    const profileName = document.getElementById('profile-name');
    if (profileName) profileName.textContent = `${currentUser.first_name} ${currentUser.last_name}`;
    const profilePosition = document.getElementById('profile-position');
    if (profilePosition) profilePosition.textContent = currentUser.position || 'No position';
    const profileRole = document.getElementById('profile-role');
    if (profileRole) profileRole.textContent = currentUser.role;
    if (currentUser.role === 'admin') {
        const btn = document.getElementById('add-user-btn');
        if (btn) {
            btn.style.display = 'flex';
            btn.style.visibility = 'visible';
            console.log('✅ Users button shown (admin)');
        }
    }
    // Apply role-based permissions to UI
    applyRolePermissions();
    loadNotifications();
    updateNotificationCount();
    
    console.log('✨ UI initialization complete');
}

// === ROLE HELPERS & PERMISSIONS ===
function isAdmin() { return currentUser && currentUser.role === 'admin'; }
function isUser() { return currentUser && currentUser.role === 'user'; }
function isViewer() { return currentUser && currentUser.role === 'viewer'; }

function applyRolePermissions() {
    // Hide Users button for non-admins (safety)
    const usersBtn = document.getElementById('add-user-btn');
    if (!isAdmin() && usersBtn) usersBtn.style.display = 'none';

    // Hide Nameplate Tracker for viewers (admin only)
    if (isViewer()) {
        const nameplateTrackerLink = document.querySelector('a[onclick*="openNameplateTrackerView"]');
        if (nameplateTrackerLink) {
            nameplateTrackerLink.style.display = 'none';
        }
    }

    if (isViewer()) {
        // Read-only: disable most inputs/buttons, but allow dashboard/status & engine ring interactions
        const scope = document.getElementById('page-content-wrapper') || document.body;
        scope.querySelectorAll('input, select, textarea, button').forEach(el => {
            const allowIds = ['menu-toggle','notifications-btn','user-profile-btn','settings-btn','engine-toggle-btn'];
            const allowClasses = ['btn-dashboard','engine-menu-item'];
            
            // Проверяем родительский элемент стрелки breakdown
            const isBreakdownChevron = el.querySelector('#chev-condition2') !== null;
            
            const isAllowed = allowIds.includes(el.id) || allowClasses.some(cls => el.classList.contains(cls)) || isBreakdownChevron;
            if (isAllowed) return; // allow viewer to open status tables and engine quick menu
            if (el.closest('#login-modal')) return;
            el.disabled = true;
            el.style.pointerEvents = 'none';
            el.classList.add('disabled');
        });
    } else if (isUser()) {
        // Users can create/edit but cannot delete or manage users
        if (usersBtn) usersBtn.style.display = 'none';
        // Soften/disable delete buttons
        hideDeleteControls();
        // Intercept DELETE requests to backend
        interceptDeletesForNonAdmins();
    }
}

function hideDeleteControls() {
    document.querySelectorAll('.btn-danger, .bi-trash').forEach(el => {
        if (el.tagName === 'BUTTON') {
            el.disabled = true;
            el.style.pointerEvents = 'none';
            el.style.opacity = '0.5';
            el.title = 'Недоступно для вашей роли';
        } else {
            el.style.opacity = '0.4';
        }
    });
}

let fetchWrapped = false;
function interceptDeletesForNonAdmins() {
    if (fetchWrapped) return;
    const origFetch = window.fetch.bind(window);
    window.fetch = async (...args) => {
        try {
            const [url, opts] = args;
            if (!isAdmin() && opts && (opts.method || 'GET').toUpperCase() === 'DELETE') {
                showErrorNotification('Ваша роль не позволяет удалять записи');
                return new Response(null, { status: 403, statusText: 'Forbidden' });
            }
        } catch (e) { /* noop */ }
        return origFetch(...args);
    };
    fetchWrapped = true;
}

// === PROFILE FUNCTIONS ===
document.getElementById('user-profile-btn')?.addEventListener('click', () => {
    const dropdown = document.getElementById('profile-dropdown');
    dropdown.classList.toggle('show');
    document.getElementById('notifications-panel').classList.remove('show');
});

// === SETTINGS FUNCTIONS ===
document.getElementById('settings-btn')?.addEventListener('click', () => {
    const modal = new bootstrap.Modal(document.getElementById('settings-modal'));
    modal.show();
    populateDashboardEditList();
    populatePartsSettingsForm();
    updateRecentActionsSummary();
});

document.getElementById('settings-modal')?.addEventListener('hidden.bs.modal', () => {
    // Reset any unsaved tweaks back to persisted values
    applyPartsSettings();
    populatePartsSettingsForm();
});

const partsSettingsDefaults = {
    storeTitle: 'Store Balance',
    logisticsTitle: 'Parts Removal/Installation',
    cardHeight: 200,
    cardWidth: 49,
    customCards: []
};
let partsSettings = { ...partsSettingsDefaults };

const partsCardTargets = {
    'parts-modal': {
        label: 'Parts Removal/Installation modal',
        icon: 'bi-arrow-left-right',
        run: () => openPartsLogisticsModal()
    },
    'parts-view': {
        label: 'Parts Removal/Installation table',
        icon: 'bi-arrow-left-right',
        run: () => { openPartsView(); switchPartsTab('list'); }
    },
    'parts-add': {
        label: 'Parts Removal/Installation – Add tab',
        icon: 'bi-plus-circle',
        run: () => { openPartsView(); switchPartsTab('add'); }
    },
    'store-modal': {
        label: 'Store Balance modal',
        icon: 'bi-box-seam',
        run: () => openStoreBalanceModal()
    },
    'store-view': {
        label: 'Store Balance table',
        icon: 'bi-box-seam',
        run: () => { openStoreBalanceView(); switchStoreBalanceTab('list'); }
    },
    'store-add': {
        label: 'Store Balance – Add tab',
        icon: 'bi-plus-circle',
        run: () => { openStoreBalanceView(); switchStoreBalanceTab('add'); }
    }
};

function clampNumber(val, min, max) {
    if (!Number.isFinite(val)) return min;
    return Math.min(max, Math.max(min, val));
}

function loadPartsSettings() {
    try {
        const raw = localStorage.getItem('parts-settings');
        const parsed = raw ? JSON.parse(raw) : {};
        const parsedHeight = Number.parseInt(parsed.cardHeight, 10);
        const parsedWidth = Number.parseInt(parsed.cardWidth, 10);
        const customCards = Array.isArray(parsed.customCards) ? parsed.customCards : [];
        partsSettings = {
            storeTitle: parsed.storeTitle || partsSettingsDefaults.storeTitle,
            logisticsTitle: parsed.logisticsTitle || partsSettingsDefaults.logisticsTitle,
            cardHeight: Number.isFinite(parsedHeight) ? clampNumber(parsedHeight, 160, 260) : partsSettingsDefaults.cardHeight,
            cardWidth: Number.isFinite(parsedWidth) ? clampNumber(parsedWidth, 35, 100) : partsSettingsDefaults.cardWidth,
            customCards: customCards.map(normalizeCustomCard)
        };
    } catch (_e) {
        partsSettings = { ...partsSettingsDefaults };
    }
}

function normalizeCustomCard(card, idx) {
    return {
        id: card?.id || `custom-${idx}`,
        title: (card?.title || 'Custom Card').toString().trim() || 'Custom Card',
        color: card?.color || '#2563eb',
        target: partsCardTargets[card?.target] ? card.target : 'parts-modal',
        width: clampNumber(Number.parseInt(card?.width, 10) || partsSettingsDefaults.cardWidth, 35, 100)
    };
}

function persistPartsSettings() {
    localStorage.setItem('parts-settings', JSON.stringify(partsSettings));
}

function getPartsCardsConfig() {
    const baseCards = [
        {
            id: 'store',
            title: partsSettings.storeTitle,
            subtitle: 'View current inventory & stock',
            color: '#667eea',
            target: 'store-modal',
            icon: 'bi-box-seam',
            countId: 'store-balance-count',
            width: partsSettings.cardWidth
        },
        {
            id: 'logistics',
            title: partsSettings.logisticsTitle,
            subtitle: 'Track all parts movements',
            color: '#11998e',
            target: 'parts-modal',
            icon: 'bi-arrow-left-right',
            countId: 'parts-logistics-count',
            width: partsSettings.cardWidth
        }
    ];
    const customCards = (partsSettings.customCards || []).map((card, idx) => normalizeCustomCard(card, idx + 1));
    return [...baseCards, ...customCards];
}

function renderPartsCards() {
    const container = document.getElementById('parts-cards-container');
    if (!container) return;
    container.innerHTML = '';

    getPartsCardsConfig().forEach(card => {
        const wrapper = document.createElement('div');
        wrapper.className = 'parts-card-wrapper';
        const width = clampNumber(card.width || partsSettings.cardWidth, 35, 100);
        wrapper.style.flex = `0 0 ${width}%`;
        wrapper.style.minWidth = '260px';

        const cardEl = document.createElement('div');
        cardEl.className = 'parts-card-3d';
        cardEl.style.background = `linear-gradient(135deg, ${card.color} 0%, ${card.color} 90%)`;
        cardEl.style.boxShadow = '0 10px 40px rgba(0,0,0,0.18)';
        cardEl.onclick = () => handlePartsCardClick(card.target);

        const iconEl = document.createElement('div');
        iconEl.className = 'parts-card-icon';
        iconEl.innerHTML = `<i class="bi ${card.icon || 'bi-stars'}"></i>`;

        const contentEl = document.createElement('div');
        contentEl.className = 'parts-card-content';
        contentEl.innerHTML = `
            <div class="parts-card-title" data-parts-title="${card.id === 'store' ? 'store' : card.id === 'logistics' ? 'logistics' : ''}">${card.title}</div>
            <div class="parts-card-subtitle">${card.subtitle || partsCardTargets[card.target]?.label || 'Open view'}</div>
        `;

        const countEl = document.createElement('div');
        countEl.className = 'parts-card-count';
        if (card.countId) countEl.id = card.countId;
        countEl.textContent = '0';

        cardEl.appendChild(iconEl);
        cardEl.appendChild(contentEl);
        cardEl.appendChild(countEl);
        wrapper.appendChild(cardEl);
        container.appendChild(wrapper);
    });
}

function handlePartsCardClick(targetKey) {
    const handler = partsCardTargets[targetKey]?.run;
    if (handler) handler();
}

function applyPartsSettings() {
    const titles = {
        store: partsSettings.storeTitle,
        logistics: partsSettings.logisticsTitle
    };
    Object.entries(titles).forEach(([key, val]) => {
        document.querySelectorAll(`[data-parts-title="${key}"]`).forEach(el => {
            el.textContent = val;
        });
    });
    document.documentElement.style.setProperty('--parts-card-height', `${partsSettings.cardHeight}px`);
    document.documentElement.style.setProperty('--parts-card-width', `${partsSettings.cardWidth}%`);
    renderPartsCards();
    renderCustomCardsList();
}

function populatePartsSettingsForm() {
    const storeInput = document.getElementById('parts-store-title-input');
    const logisticsInput = document.getElementById('parts-logistics-title-input');
    const heightInput = document.getElementById('parts-card-height');
    const widthInput = document.getElementById('parts-card-width');

    if (storeInput) storeInput.value = partsSettings.storeTitle;
    if (logisticsInput) logisticsInput.value = partsSettings.logisticsTitle;
    if (heightInput) {
        heightInput.value = partsSettings.cardHeight;
        updatePartsCardHeightLabel(partsSettings.cardHeight);
    }
    if (widthInput) {
        widthInput.value = partsSettings.cardWidth;
        updatePartsCardWidthLabel(partsSettings.cardWidth);
    }
    clearCustomCardForm();
    renderCustomCardsList();
}

function updatePartsCardHeightLabel(value) {
    const label = document.getElementById('parts-card-height-value');
    if (label) label.textContent = `${value}px`;
    document.documentElement.style.setProperty('--parts-card-height', `${value}px`);
}

function updatePartsCardWidthLabel(value) {
    const label = document.getElementById('parts-card-width-value');
    if (label) label.textContent = `${value}%`;
    document.documentElement.style.setProperty('--parts-card-width', `${value}%`);
}

function addCustomPartsCard() {
    const titleInput = document.getElementById('parts-custom-title');
    const colorInput = document.getElementById('parts-custom-color');
    const targetSelect = document.getElementById('parts-custom-target');
    const widthInput = document.getElementById('parts-custom-width');

    const title = (titleInput?.value || '').trim();
    const color = colorInput?.value || '#2563eb';
    const target = targetSelect?.value || 'parts-modal';
    const width = clampNumber(Number.parseInt(widthInput?.value, 10) || partsSettings.cardWidth, 35, 100);

    const newCard = normalizeCustomCard({
        id: `custom-${Date.now()}`,
        title: title || 'Custom Card',
        color,
        target,
        width
    }, (partsSettings.customCards || []).length + 1);

    partsSettings.customCards = [...(partsSettings.customCards || []), newCard];
    persistPartsSettings();
    applyPartsSettings();
    populatePartsSettingsForm();
    showSuccessNotification('Custom card added');
}

function renderCustomCardsList() {
    const list = document.getElementById('parts-custom-list');
    if (!list) return;
    const cards = partsSettings.customCards || [];
    if (!cards.length) {
        list.innerHTML = '<div class="list-group-item text-muted">No custom cards yet</div>';
        return;
    }
    list.innerHTML = cards.map(card => {
        const targetLabel = partsCardTargets[card.target]?.label || card.target;
        return `
            <div class="list-group-item d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center gap-2">
                    <span class="rounded-circle d-inline-block" style="width:14px;height:14px;background:${card.color};"></span>
                    <div>
                        <div><strong>${card.title}</strong></div>
                        <div class="text-muted">${targetLabel} • ${card.width}% width</div>
                    </div>
                </div>
                <button class="btn btn-sm btn-outline-danger" onclick="removeCustomCard('${card.id}')"><i class="bi bi-trash"></i></button>
            </div>`;
    }).join('');
}

function removeCustomCard(id) {
    partsSettings.customCards = (partsSettings.customCards || []).filter(c => c.id !== id);
    persistPartsSettings();
    applyPartsSettings();
    populatePartsSettingsForm();
}

function clearCustomCardForm() {
    const titleInput = document.getElementById('parts-custom-title');
    const colorInput = document.getElementById('parts-custom-color');
    const targetSelect = document.getElementById('parts-custom-target');
    const widthInput = document.getElementById('parts-custom-width');
    if (titleInput) titleInput.value = '';
    if (colorInput) colorInput.value = '#2563eb';
    if (targetSelect) targetSelect.value = 'parts-modal';
    if (widthInput) widthInput.value = partsSettings.cardWidth;
}

function savePartsSettingsFromForm() {
    const storeInput = document.getElementById('parts-store-title-input');
    const logisticsInput = document.getElementById('parts-logistics-title-input');
    const heightInput = document.getElementById('parts-card-height');
    const widthInput = document.getElementById('parts-card-width');

    const newHeightRaw = heightInput ? Number.parseInt(heightInput.value, 10) : partsSettingsDefaults.cardHeight;
    const newWidthRaw = widthInput ? Number.parseInt(widthInput.value, 10) : partsSettingsDefaults.cardWidth;
    const clampedHeight = Number.isFinite(newHeightRaw) ? clampNumber(newHeightRaw, 160, 260) : partsSettingsDefaults.cardHeight;
    const clampedWidth = Number.isFinite(newWidthRaw) ? clampNumber(newWidthRaw, 35, 100) : partsSettingsDefaults.cardWidth;

    partsSettings = {
        ...partsSettings,
        storeTitle: (storeInput?.value || partsSettingsDefaults.storeTitle).trim() || partsSettingsDefaults.storeTitle,
        logisticsTitle: (logisticsInput?.value || partsSettingsDefaults.logisticsTitle).trim() || partsSettingsDefaults.logisticsTitle,
        cardHeight: clampedHeight,
        cardWidth: clampedWidth
    };

    persistPartsSettings();
    applyPartsSettings();
    populatePartsSettingsForm();
    showSuccessNotification('Parts settings saved');
}

function resetPartsSettings() {
    if (!confirm('Reset parts titles, sizes, and custom cards to defaults?')) return;
    partsSettings = { ...partsSettingsDefaults };
    persistPartsSettings();
    applyPartsSettings();
    populatePartsSettingsForm();
}

loadPartsSettings();
applyPartsSettings();

let dashboardEditMode = localStorage.getItem('dashboard-edit-mode') === 'true';

function toggleTheme() {
    const isLightBg = document.getElementById('theme-toggle').checked;
    
    if (isLightBg) {
        document.body.classList.add('light-bg');
        localStorage.setItem('app-theme', 'light');
    } else {
        document.body.classList.remove('light-bg');
        localStorage.setItem('app-theme', 'dark');
    }
}

function loadSavedTheme() {
    const savedTheme = localStorage.getItem('app-theme');
    const toggle = document.getElementById('theme-toggle');
    
    if (savedTheme === 'light') {
        document.body.classList.add('light-bg');
        if (toggle) toggle.checked = true;
    }
}

function toggleDashboardEditMode() {
    dashboardEditMode = document.getElementById('dashboard-edit-toggle').checked;
    localStorage.setItem('dashboard-edit-mode', dashboardEditMode);
    const section = document.getElementById('dashboard-edit-section');
    section.style.display = dashboardEditMode ? 'block' : 'none';
    if (dashboardEditMode) {
        enableLocationDragDrop();
    } else {
        disableLocationDragDrop();
    }
}

function populateDashboardEditList() {
    populateCityList();
    populateStatusList();
    populateFleetList();
}

function populateCityList() {
    const list = document.getElementById('locations-edit-list');
    const container = document.getElementById('locations-container');
    const buttons = container.querySelectorAll('.col-md-2[data-location-id]');
    
    list.innerHTML = '';
    buttons.forEach((btn, idx) => {
        const nameEl = btn.querySelector('.label');
        const name = nameEl ? nameEl.textContent : `Location ${idx}`;
        const item = document.createElement('div');
        item.className = 'list-group-item d-flex justify-content-between align-items-center py-2';
        item.draggable = true;
        item.setAttribute('data-location-idx', idx);
        item.setAttribute('data-type', 'city');
        item.style.cursor = 'grab';
        item.innerHTML = `
            <span><i class="bi bi-geo-alt text-primary me-2"></i><strong>${name}</strong></span>
            <div class="btn-group btn-group-sm">
                <button class="btn btn-outline-info" onclick="renameLocation(${idx})" title="Rename">
                    <i class="bi bi-pencil"></i>
                </button>
                <button class="btn btn-outline-danger" onclick="deleteLocation(${idx})" title="Delete">
                    <i class="bi bi-trash"></i>
                </button>
            </div>
        `;
        
        // Add drag event listeners
        item.addEventListener('dragstart', handleSettingsDragStart);
        item.addEventListener('dragover', handleSettingsDragOver);
        item.addEventListener('drop', handleSettingsDrop);
        item.addEventListener('dragend', handleSettingsDragEnd);
        
        list.appendChild(item);
    });
}

function populateStatusList() {
    const list = document.getElementById('status-edit-list');
    const statusButtons = [
        {name: 'Serviceable (SV)', icon: 'check-circle-fill', color: 'success'},
        {name: 'Unserviceable (US)', icon: 'x-circle-fill', color: 'danger'},
        {name: 'Removed from AC', icon: 'arrow-down-left-circle-fill', color: 'warning'},
        {name: 'Installed on AC', icon: 'airplane-engines-fill', color: 'info'}
    ];
    
    list.innerHTML = '';
    statusButtons.forEach((status, idx) => {
        const item = document.createElement('div');
        item.className = 'list-group-item d-flex justify-content-between align-items-center py-2';
        item.draggable = true;
        item.setAttribute('data-type', 'status');
        item.style.cursor = 'grab';
        item.innerHTML = `
            <span><i class="bi bi-${status.icon} text-${status.color} me-2"></i><strong>${status.name}</strong></span>
            <span class="badge bg-secondary">Drag to reorder</span>
        `;
        
        // Add drag event listeners
        item.addEventListener('dragstart', handleSettingsDragStart);
        item.addEventListener('dragover', handleSettingsDragOver);
        item.addEventListener('drop', handleSettingsDrop);
        item.addEventListener('dragend', handleSettingsDragEnd);
        
        list.appendChild(item);
    });
}

async function populateFleetList() {
    const list = document.getElementById('fleet-edit-list');
    
    try {
        const response = await fetch('/api/fleet');
        if (!response.ok) throw new Error('Failed to load fleet');
        
        const fleet = await response.json();
        list.innerHTML = '';
        
        fleet.forEach((aircraft, idx) => {
            const item = document.createElement('div');
            item.className = 'list-group-item d-flex justify-content-between align-items-center py-2';
            item.draggable = true;
            item.setAttribute('data-aircraft-id', aircraft.id);
            item.setAttribute('data-type', 'fleet');
            item.style.cursor = 'grab';
            item.innerHTML = `
                <span><i class="bi bi-airplane text-primary me-2"></i><strong>${aircraft.tail_number}</strong> <small class="text-muted">(${aircraft.model || 'N/A'})</small></span>
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-info" onclick="renameAircraft(${aircraft.id})" title="Edit">
                        <i class="bi bi-pencil"></i>
                    </button>
                    <button class="btn btn-outline-danger" onclick="deleteAircraft(${aircraft.id})" title="Delete">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
            `;
            
            // Add drag event listeners
            item.addEventListener('dragstart', handleSettingsDragStart);
            item.addEventListener('dragover', handleSettingsDragOver);
            item.addEventListener('drop', handleSettingsDrop);
            item.addEventListener('dragend', handleSettingsDragEnd);
            
            list.appendChild(item);
        });
    } catch (err) {
        console.error('Error loading fleet:', err);
        list.innerHTML = '<div class="list-group-item text-danger">Error loading fleet</div>';
    }
}

async function addNewAircraft() {
    if (!isAdmin()) {
        showErrorNotification('Only admins can add aircraft');
        return;
    }
    
    const tailNumber = prompt('Enter aircraft tail number (e.g., ER-BAX):');
    if (!tailNumber) return;
    
    const model = prompt('Enter aircraft model (e.g., Boeing 747-200):') || '';
    const msn = prompt('Enter MSN (optional):') || '';
    
    try {
        const response = await fetch(`/api/aircrafts?user_id=${currentUser.id}`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                tail_number: tailNumber,
                model: model,
                msn: msn,
                total_time: 0,
                total_cycles: 0
            })
        });
        
        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || 'Failed to create aircraft');
        }
        
        showSuccessNotification(`Aircraft ${tailNumber} added successfully`);
        await populateFleetList();
        await loadDashboardData();
        await loadAircraftDropdown(); // Refresh utilization parameters dropdown
    } catch (err) {
        console.error('Error adding aircraft:', err);
        showErrorNotification('Error: ' + err.message);
    }
}

async function addNewLocation() {
    if (!isAdmin()) {
        showErrorNotification('Only admins can add locations');
        return;
    }
    
    const name = prompt('Enter location code (e.g., SHJ, DXB):');
    if (!name) return;
    
    const city = prompt('Enter city name (e.g., Sharjah):') || name;
    
    try {
        const response = await fetch(`/api/locations?user_id=${currentUser.id}`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                name: name.toUpperCase(),
                city: city
            })
        });
        
        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || 'Failed to create location');
        }
        
        showSuccessNotification(`Location ${name} added successfully`);
        await populateLocationsList();
        await loadDashboardData();
        await loadLocationDropdown(); // Refresh engine dropdown
    } catch (err) {
        console.error('Error adding location:', err);
        showErrorNotification('Error: ' + err.message);
    }
}

async function renameAircraft(aircraftId) {
    if (!isAdmin()) {
        showErrorNotification('Only admins can edit aircraft');
        return;
    }
    
    const newTailNumber = prompt('Enter new tail number:');
    if (!newTailNumber) return;
    
    const newModel = prompt('Enter new model (optional):');
    
    try {
        const response = await fetch(`/api/aircrafts/${aircraftId}`, {
            method: 'PUT',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                tail_number: newTailNumber,
                model: newModel || undefined
            })
        });
        
        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || 'Failed to update aircraft');
        }
        
        showSuccessNotification(`Aircraft updated successfully`);
        await populateFleetList();
        await loadDashboardData();
        await loadAircraftDropdown(); // Refresh utilization parameters dropdown
    } catch (err) {
        console.error('Error updating aircraft:', err);
        showErrorNotification('Error: ' + err.message);
    }
}

async function deleteAircraft(aircraftId) {
    if (!isAdmin()) {
        showErrorNotification('Only admins can delete aircraft');
        return;
    }
    
    if (!confirm('Delete this aircraft? This cannot be undone!')) return;
    
    try {
        const response = await fetch(`/api/aircrafts/${aircraftId}?user_id=${currentUser.id}`, {
            method: 'DELETE'
        });
        
        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || 'Failed to delete aircraft');
        }
        
        showSuccessNotification('Aircraft deleted successfully');
        await populateFleetList();
        await loadDashboardData();
        await loadAircraftDropdown(); // Refresh utilization parameters dropdown
    } catch (err) {
        console.error('Error deleting aircraft:', err);
        showErrorNotification('Error: ' + err.message);
    }
}

function enableLocationDragDrop() {
    const container = document.getElementById('locations-container');
    const items = container.querySelectorAll('.col-md-2');
    items.forEach(item => {
        item.style.cursor = 'grab';
        item.draggable = true;
        item.addEventListener('dragstart', handleDragStart);
        item.addEventListener('dragover', handleDragOver);
        item.addEventListener('drop', handleDrop);
    });
}

function disableLocationDragDrop() {
    const container = document.getElementById('locations-container');
    const items = container.querySelectorAll('.col-md-2');
    items.forEach(item => {
        item.style.cursor = 'default';
        item.draggable = false;
        item.removeEventListener('dragstart', handleDragStart);
        item.removeEventListener('dragover', handleDragOver);
        item.removeEventListener('drop', handleDrop);
    });
}

let draggedElement = null;

function handleDragStart(e) {
    draggedElement = this;
    this.style.opacity = '0.5';
}

function handleDragOver(e) {
    if (e.preventDefault) e.preventDefault();
    e.dataTransfer.dropEffect = 'move';
    return false;
}

function handleDrop(e) {
    if (e.stopPropagation) e.stopPropagation();
    if (draggedElement !== this) {
        const container = document.getElementById('locations-container');
        const allItems = [...container.querySelectorAll('.col-md-2')];
        const draggedIdx = allItems.indexOf(draggedElement);
        const targetIdx = allItems.indexOf(this);
        if (draggedIdx < targetIdx) {
            this.parentNode.insertBefore(draggedElement, this.nextSibling);
        } else {
            this.parentNode.insertBefore(draggedElement, this);
        }
        saveDashboardLayout();
    }
    draggedElement.style.opacity = '1';
    draggedElement = null;
    return false;
}

// Drag-drop handlers for Settings modal
let settingsDraggedItem = null;

function handleSettingsDragStart(e) {
    settingsDraggedItem = this;
    this.style.opacity = '0.4';
    this.style.cursor = 'grabbing';
    e.dataTransfer.effectAllowed = 'move';
}

function handleSettingsDragOver(e) {
    if (e.preventDefault) e.preventDefault();
    e.dataTransfer.dropEffect = 'move';
    
    // Add visual feedback
    if (settingsDraggedItem && this !== settingsDraggedItem) {
        const rect = this.getBoundingClientRect();
        const midpoint = rect.top + rect.height / 2;
        if (e.clientY < midpoint) {
            this.style.borderTop = '3px solid #007bff';
            this.style.borderBottom = '';
        } else {
            this.style.borderBottom = '3px solid #007bff';
            this.style.borderTop = '';
        }
    }
    
    return false;
}

function handleSettingsDrop(e) {
    if (e.stopPropagation) e.stopPropagation();
    if (e.preventDefault) e.preventDefault();
    
    // Remove visual feedback
    this.style.borderTop = '';
    this.style.borderBottom = '';
    
    if (settingsDraggedItem && settingsDraggedItem !== this) {
        // Determine drop position
        const rect = this.getBoundingClientRect();
        const midpoint = rect.top + rect.height / 2;
        
        if (e.clientY < midpoint) {
            // Insert before
            this.parentNode.insertBefore(settingsDraggedItem, this);
        } else {
            // Insert after
            this.parentNode.insertBefore(settingsDraggedItem, this.nextSibling);
        }
        
        // Save the new order based on type
        const type = settingsDraggedItem.getAttribute('data-type');
        if (type === 'city') {
            saveLocationOrder();
        } else if (type === 'status') {
            saveStatusOrder();
        } else if (type === 'fleet') {
            saveFleetOrder();
        }
    }
    
    return false;
}

function handleSettingsDragEnd(e) {
    this.style.opacity = '1';
    this.style.cursor = 'grab';
    
    // Remove all visual feedback
    const lists = ['locations-edit-list', 'status-edit-list', 'fleet-edit-list'];
    lists.forEach(listId => {
        const list = document.getElementById(listId);
        if (list) {
            list.querySelectorAll('.list-group-item').forEach(item => {
                item.style.borderTop = '';
                item.style.borderBottom = '';
            });
        }
    });
    
    settingsDraggedItem = null;
}

function saveLocationOrder() {
    const list = document.getElementById('locations-edit-list');
    const items = list.querySelectorAll('.list-group-item');
    const newOrder = [];
    
    items.forEach((item, idx) => {
        const locationIdx = item.getAttribute('data-location-idx');
        newOrder.push(parseInt(locationIdx));
    });
    
    // Reorder the actual location buttons on dashboard
    const container = document.getElementById('locations-container');
    const buttons = [...container.querySelectorAll('.col-md-2[data-location-id]')];
    
    newOrder.forEach((oldIdx, newIdx) => {
        container.appendChild(buttons[oldIdx]);
    });
    
    saveDashboardLayout();
    loadDashboardData(); // Refresh to show new order
}

function saveStatusOrder() {
    // Status order is UI only for now
    console.log('Status order saved (UI only)');
}

function saveFleetOrder() {
    // Fleet order - could be saved to backend in future
    console.log('Fleet order saved (local only)');
}

async function renameLocation(idx) {
    // Only admin can rename
    if (!isAdmin()) {
        showErrorNotification('Only admins can rename locations');
        return;
    }
    
    const container = document.getElementById('locations-container');
    const item = container.querySelectorAll('.col-md-2')[idx];
    const nameEl = item.querySelector('.label');
    const oldName = nameEl.textContent;
    const newName = prompt('Enter new location name:', oldName);
    
    if (!newName || newName === oldName) return;
    
    try {
        // Get location ID from data attribute (we'll need to add this)
        const locId = item.getAttribute('data-location-id');
        if (!locId) {
            showErrorNotification('Location ID not found');
            return;
        }
        
        const response = await fetch(`/api/locations/${locId}`, {
            method: 'PUT',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ name: newName })
        });
        
        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || 'Failed to update location');
        }
        
        // Update UI
        nameEl.textContent = newName;
        saveDashboardLayout();
        populateDashboardEditList();
        
        // Reload dashboard data to sync everywhere
        if (typeof loadDashboardData === 'function') {
            await loadDashboardData();
        }
        
        showSuccessNotification(`Location renamed to ${newName}`);
    } catch (err) {
        console.error('Error renaming location:', err);
        showErrorNotification('Error: ' + err.message);
    }
}

async function deleteLocation(idx) {
    if (!isAdmin()) {
        showErrorNotification('Only admins can delete locations');
        return;
    }
    
    const container = document.getElementById('locations-container');
    const item = container.querySelectorAll('.col-md-2[data-location-id]')[idx];
    const locationId = item.getAttribute('data-location-id');
    const locationName = item.querySelector('.label').textContent;
    
    if (!confirm(`Delete location "${locationName}"? This cannot be undone!`)) return;
    
    try {
        const response = await fetch(`/api/locations/${locationId}`, {
            method: 'DELETE'
        });
        
        if (!response.ok) {
            let message = '';
            try {
                const ct = response.headers.get('content-type') || '';
                if (ct.includes('application/json')) {
                    const error = await response.json();
                    message = (error && (error.detail || error.message)) || '';
                } else {
                    message = (await response.text()) || '';
                }
            } catch (_) {
                // swallow parse errors, fallback to status
            }
            if (!message) message = `${response.status} ${response.statusText}`;
            throw new Error(message);
        }
        
        showSuccessNotification('Location deleted successfully');
        // Ensure any custom overlays are closed so UI remains interactive
        try {
            document.getElementById('filter-overlay')?.classList.remove('active');
            document.getElementById('filter-panel')?.classList.remove('open');
        } catch (_e) {}
        await loadDashboardData();  // This reloads locations from API
        populateCityList();  // Then refresh the settings list from updated DOM
    } catch (err) {
        console.error('Error deleting location:', err);
        showErrorNotification('Error: ' + err.message);
        // Also close any overlays if an error modal masked the page
        try {
            document.getElementById('filter-overlay')?.classList.remove('active');
            document.getElementById('filter-panel')?.classList.remove('open');
        } catch (_e) {}
    }
}

function saveDashboardLayout() {
    const container = document.getElementById('locations-container');
    const buttons = container.querySelectorAll('.col-md-2');
    const layout = [];
    buttons.forEach(btn => {
        const nameEl = btn.querySelector('.label');
        const countEl = btn.querySelector('.count');
        layout.push({
            name: nameEl ? nameEl.textContent : '',
            count: countEl ? countEl.textContent : '0'
        });
    });
    localStorage.setItem('dashboard-layout', JSON.stringify(layout));
}

function resetDashboardDefaults() {
    if (confirm('Reset dashboard to default layout?')) {
        localStorage.removeItem('dashboard-layout');
        localStorage.removeItem('dashboard-edit-mode');
        dashboardEditMode = false;
        document.getElementById('dashboard-edit-toggle').checked = false;
        document.getElementById('dashboard-edit-section').style.display = 'none';
        location.reload();
    }
}

function editProfile() {
    alert('Profile editing coming soon!');
}

async function changePassword() {
    const oldPassword = prompt('Enter current password:');
    if (!oldPassword) return;
    const newPassword = prompt('Enter new password:');
    if (!newPassword) return;
    const confirmPassword = prompt('Confirm new password:');
    if (newPassword !== confirmPassword) {
        alert('Passwords do not match!');
        return;
    }
    try {
        const response = await fetch(`/api/users/${currentUser.id}/change-password`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({old_password: oldPassword, new_password: newPassword})
        });
        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail);
        }
        alert('Password changed successfully!');
    } catch (error) {
        alert('Error: ' + error.message);
    }
}

// === NOTIFICATIONS FUNCTIONS ===
document.getElementById('notifications-btn')?.addEventListener('click', () => {
    const panel = document.getElementById('notifications-panel');
    panel.classList.toggle('show');
    document.getElementById('profile-dropdown').classList.remove('show');
    if (panel.classList.contains('show')) loadNotifications();
});

async function loadNotifications() {
    try {
        const response = await fetch('/api/notifications');
        if (!response.ok) return;
        const notifications = await response.json();
        const list = document.getElementById('notifications-list');
        if (notifications.length === 0) {
            list.innerHTML = '<div class="text-center text-muted py-4">No notifications</div>';
            return;
        }
        list.innerHTML = notifications.map(n => `
            <div class="notification-item ${n.is_read ? '' : 'unread'}" onclick="markNotificationRead(${n.id})">
                <div class="d-flex justify-content-between">
                    <strong>${n.entity_type}</strong>
                    <span class="badge bg-${getActionBadgeColor(n.action_type)}">${n.action_type}</span>
                </div>
                <div>${n.message}</div>
                <div class="notification-time">by ${n.performed_by} • ${formatNotificationTime(n.created_at)}</div>
            </div>
        `).join('');
    } catch (error) {
        console.error('Error loading notifications:', error);
    }
}

async function updateNotificationCount() {
    try {
        const response = await safeFetch('/api/notifications/unread-count');
        if (!response || !response.ok) return;
        const data = await response.json();
        const badge = document.getElementById('notification-count');
        if (data.count > 0) {
            badge.textContent = data.count > 99 ? '99+' : data.count;
            badge.classList.add('show');
        } else {
            badge.classList.remove('show');
        }
    } catch (error) {
        // Silently fail - notification count is not critical
    }
}

async function markNotificationRead(id) {
    try {
        await fetch(`/api/notifications/${id}/read`, {method: 'PUT'});
        loadNotifications();
        updateNotificationCount();
    } catch (error) {
        console.error('Error marking notification:', error);
    }
}

async function markAllNotificationsRead() {
    try {
        await fetch('/api/notifications/mark-all-read', {method: 'PUT'});
        loadNotifications();
        updateNotificationCount();
    } catch (error) {
        console.error('Error marking all notifications:', error);
    }
}

// Debounced refresh function - called only after data changes, never from intervals
function refreshAfterDataChange() {
    const now = Date.now();
    if (now - lastRefreshTime < 500) return; // Debounce: ignore calls within 500ms
    lastRefreshTime = now;
    loadRecentActions();
    updateNotificationCount();
}

function getActionBadgeColor(action) {
    switch(action) {
        case 'created': return 'success';
        case 'updated': return 'info';
        case 'deleted': return 'danger';
        default: return 'secondary';
    }
}

function formatNotificationTime(timestamp) {
    const date = new Date(timestamp);
    const now = new Date();
    const diff = now - date;
    const minutes = Math.floor(diff / 60000);
    if (minutes < 1) return 'Just now';
    if (minutes < 60) return `${minutes}m ago`;
    const hours = Math.floor(minutes / 60);
    if (hours < 24) return `${hours}h ago`;
    const days = Math.floor(hours / 24);
    if (days < 7) return `${days}d ago`;
    return date.toLocaleDateString();
}

// === USER MANAGEMENT ===
document.getElementById('add-user-btn')?.addEventListener('click', openUserManager);
document.getElementById('refresh-users-btn')?.addEventListener('click', loadUsersList);
document.getElementById('user-form')?.addEventListener('submit', submitUserForm);
document.getElementById('user-reset-btn')?.addEventListener('click', resetUserForm);

async function openUserManager() {
    if (!isAdmin()) {
        showErrorNotification('Только админ может управлять пользователями');
        return;
    }
    resetUserForm();
    await loadUsersList();
    const modalEl = document.getElementById('user-manage-modal');
    if (modalEl) {
        const modal = new bootstrap.Modal(modalEl);
        modal.show();
    }
}

function resetUserForm() {
    editingUserId = null;
    document.getElementById('user-id').value = '';
    document.getElementById('user-first-name').value = '';
    document.getElementById('user-last-name').value = '';
    document.getElementById('user-username').value = '';
    document.getElementById('user-password').value = '';
    document.getElementById('user-position').value = '';
    document.getElementById('user-role').value = 'viewer';
    document.getElementById('user-submit-btn').textContent = 'Create User';
}

function validateUsername(username) {
    return /^[A-Za-z0-9]+$/.test(username);
}

async function submitUserForm(event) {
    event.preventDefault();
    const first_name = document.getElementById('user-first-name').value.trim();
    const last_name = document.getElementById('user-last-name').value.trim();
    const username = document.getElementById('user-username').value.trim();
    const password = document.getElementById('user-password').value;
    const position = document.getElementById('user-position').value.trim();
    const role = document.getElementById('user-role').value;
    if (!validateUsername(username)) {
        showErrorNotification('Логин: только английские буквы и цифры.');
        return;
    }
    const payload = { first_name, last_name, username, position, role };
    if (!editingUserId) {
        payload.password = password;
    } else if (password) {
        payload.password = password;
    }
    try {
        let response;
        if (editingUserId) {
            response = await fetch(`/api/users/${editingUserId}?user_id=${currentUser.id}`, {
                method: 'PUT',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            });
        } else {
            response = await fetch(`/api/users?user_id=${currentUser.id}`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            });
        }
        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || 'Operation failed');
        }
        showSuccessNotification(editingUserId ? 'Пользователь обновлен' : 'Пользователь создан');
        await loadUsersList();
        resetUserForm();
    } catch (error) {
        showErrorNotification(error.message);
    }
}

async function loadUsersList() {
    try {
        const response = await fetch('/api/users');
        if (!response.ok) throw new Error('Не удалось загрузить пользователей');
        userCache = await response.json();
        renderUsersTable(userCache);
    } catch (error) {
        showErrorNotification(error.message);
    }
}

function renderUsersTable(users) {
    const tbody = document.getElementById('user-table-body');
    if (!tbody) return;
    tbody.innerHTML = users.map(u => `
        <tr>
            <td>${u.first_name}</td>
            <td>${u.last_name}</td>
            <td>${u.username}</td>
            <td><span class="badge bg-${u.role === 'admin' ? 'danger' : u.role === 'user' ? 'primary' : 'secondary'}">${u.role}</span></td>
            <td class="text-end">
                <button class="btn btn-outline-secondary btn-sm me-1" onclick="editUser(${u.id})"><i class="bi bi-pencil"></i></button>
                <button class="btn btn-outline-warning btn-sm me-1" onclick="resetUserPassword(${u.id})"><i class="bi bi-key"></i></button>
                <button class="btn btn-outline-danger btn-sm" onclick="deleteUser(${u.id})"><i class="bi bi-trash"></i></button>
            </td>
        </tr>
    `).join('');
}

function editUser(id) {
    const user = userCache.find(u => u.id === id);
    if (!user) return;
    editingUserId = id;
    document.getElementById('user-id').value = id;
    document.getElementById('user-first-name').value = user.first_name;
    document.getElementById('user-last-name').value = user.last_name;
    document.getElementById('user-username').value = user.username;
    document.getElementById('user-position').value = user.position || '';
    document.getElementById('user-role').value = user.role;
    document.getElementById('user-password').value = '';
    document.getElementById('user-submit-btn').textContent = 'Save User';
}

async function resetUserPassword(id) {
    const oldPassword = prompt('Введите текущий пароль пользователя');
    if (oldPassword === null) return;
    const newPassword = prompt('Введите новый пароль');
    if (!newPassword) return;
    try {
        const response = await fetch(`/api/users/${id}/change-password`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ old_password: oldPassword, new_password: newPassword })
        });
        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || 'Не удалось сменить пароль');
        }
        showSuccessNotification('Пароль обновлен');
    } catch (error) {
        showErrorNotification(error.message);
    }
}

async function deleteUser(id) {
    const target = userCache?.find(u => u.id === id);
    if (target && (target.role === 'admin' || target.username === 'admin')) {
        showErrorNotification('Нельзя удалить администратора');
        return;
    }
    if (currentUser && currentUser.id === id) {
        showErrorNotification('Нельзя удалить самого себя');
        return;
    }
    if (!confirm('Удалить пользователя?')) return;
    try {
        const response = await fetch(`/api/users/${id}?user_id=${currentUser.id}`, { method: 'DELETE' });
        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || 'Не удалось удалить пользователя');
        }
        showSuccessNotification('Пользователь удален');
        await loadUsersList();
    } catch (error) {
        showErrorNotification(error.message);
    }
}

// === UNIVERSAL TABLE FILTER SYSTEM ===
let currentFilterTable = null;
let currentFilterData = [];
let panelActiveFilters = {};

function openFilterPanel(tableName) {
    // Check if tableConfigs is defined
    if (typeof tableConfigs === 'undefined') {
        showErrorNotification('Filter system not ready. Please try again.');
        return;
    }
    
    currentFilterTable = tableName;
    const config = tableConfigs[tableName];
    if (!config) {
        showErrorNotification('Table configuration not found.');
        return;
    }
    
    const tbody = document.getElementById(config.bodyId);
    if (!tbody) {
        showErrorNotification('Table not found. Please open the table first.');
        return;
    }
    
    // Collect all data from table rows
    const rows = Array.from(tbody.querySelectorAll('tr'));
    currentFilterData = rows.map(row => {
        const cells = Array.from(row.querySelectorAll('td'));
        const rowData = { element: row, values: {} };
        
        // Extract user from data attribute if exists
        rowData.values.user = row.getAttribute('data-user') || '';
        
        // Extract column values
        let colIndex = 0;
        cells.forEach(cell => {
            // Skip delete column
            if (cell.classList.contains('delete-col') || 
                cell.className.includes('delete-col-')) return;
            
            const columnName = config.columns[colIndex];
            if (columnName) {
                rowData.values[columnName] = cell.textContent.trim();
                colIndex++;
            }
        });
        
        return rowData;
    });
    
    // Build filter fields
    const container = document.getElementById('filter-fields-container');
    let html = '';
    
    // User field first
    html += `
        <div class="filter-field">
            <label><i class="bi bi-person-fill me-1"></i>User</label>
            <input type="text" id="filter-user" placeholder="Filter by user..." 
                   value="${panelActiveFilters.user || ''}" oninput="filterTableRealtime()">
        </div>
    `;
    
    // Other columns
    config.columns.forEach(col => {
        const label = col.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
        html += `
            <div class="filter-field">
                <label><i class="bi bi-funnel me-1"></i>${label}</label>
                <input type="text" id="filter-${col}" placeholder="Filter ${label}..." 
                       value="${panelActiveFilters[col] || ''}" oninput="filterTableRealtime()">
            </div>
        `;
    });
    
    container.innerHTML = html;
    
    // Show panel
    document.getElementById('filter-overlay').classList.add('active');
    document.getElementById('filter-panel').classList.add('open');
    
    // Apply existing filters
    if (Object.keys(panelActiveFilters).length > 0) {
        applyTableFilter();
    }
}

function closeFilterPanel() {
    document.getElementById('filter-overlay').classList.remove('active');
    document.getElementById('filter-panel').classList.remove('open');
}

function filterTableRealtime() {
    // Real-time filtering as user types
    applyTableFilter();
}

function applyTableFilter() {
    if (!currentFilterTable || currentFilterData.length === 0) return;
    
    const config = tableConfigs[currentFilterTable];
    if (!config) return;
    
    // Collect filter values
    panelActiveFilters = {};
    
    const userInput = document.getElementById('filter-user');
    if (userInput && userInput.value.trim()) {
        panelActiveFilters.user = userInput.value.trim().toLowerCase();
    }
    
    config.columns.forEach(col => {
        const input = document.getElementById(`filter-${col}`);
        if (input && input.value.trim()) {
            panelActiveFilters[col] = input.value.trim().toLowerCase();
        }
    });
    
    // Apply filters to data
    currentFilterData.forEach(item => {
        let matches = true;
        
        // Check user filter
        if (panelActiveFilters.user) {
            const userVal = (item.values.user || '').toLowerCase();
            if (!userVal.includes(panelActiveFilters.user)) {
                matches = false;
            }
        }
        
        // Check column filters
        for (const col in panelActiveFilters) {
            if (col === 'user') continue;
            const filterVal = panelActiveFilters[col];
            const cellVal = (item.values[col] || '').toLowerCase();
            if (!cellVal.includes(filterVal)) {
                matches = false;
                break;
            }
        }
        
        // Show/hide row
        item.element.style.display = matches ? '' : 'none';
    });
    
    // Show notification
    const visibleCount = currentFilterData.filter(item => 
        item.element.style.display !== 'none').length;
    const totalCount = currentFilterData.length;
    
    if (visibleCount < totalCount) {
        const filterCount = Object.keys(panelActiveFilters).length;
        console.log(`✅ Filter applied: ${visibleCount}/${totalCount} rows match ${filterCount} filter(s)`);
    }
}

function resetTableFilter() {
    if (!currentFilterTable || currentFilterData.length === 0) return;
    
    // Clear all inputs
    document.querySelectorAll('#filter-fields-container input').forEach(input => {
        input.value = '';
    });
    
    // Clear active filters
    panelActiveFilters = {};
    
    // Show all rows
    currentFilterData.forEach(item => {
        item.element.style.display = '';
    });
    
    showSuccessNotification('Filters cleared - showing all data');
}

// Add filter buttons to all tables
function addFilterButtons() {
    // Check if tableConfigs is defined
    if (typeof tableConfigs === 'undefined') {
        console.warn('tableConfigs not defined yet, skipping filter buttons');
        return;
    }
    
    Object.keys(tableConfigs).forEach(tableName => {
        const editBtn = document.getElementById(`btn-${tableName}-edit`);
        if (!editBtn) return;
        
        // Check if filter button already exists
        if (document.getElementById(`btn-${tableName}-filter`)) return;
        
        const filterBtn = document.createElement('button');
        filterBtn.id = `btn-${tableName}-filter`;
        filterBtn.className = 'btn btn-sm btn-info btn-filter-toggle';
        filterBtn.innerHTML = '<i class="bi bi-funnel-fill"></i>';
        filterBtn.title = 'Filter table data';
        filterBtn.onclick = () => openFilterPanel(tableName);
        
        // Insert after edit button
        editBtn.parentNode.insertBefore(filterBtn, editBtn.nextSibling);
    });
}

// === STORE CONDITION COLOR HANDLER ===
function initStoreConditionColorHandler() {
    const conditionSelect = document.getElementById('store-condition');
    if (!conditionSelect) return;
    
    const colorMap = {
        'SV - NGV (SENT)': 'sv-sent',
        'UNDER REPAIRING': 'under-repair',
        'Delivered in Roma Italy': 'delivered-roma',
        'NO CAPABILITY': 'no-capability',
        'US - SHJ': 'us-shj'
    };
    
    function updateConditionColor() {
        // Удаляем все классы цветов
        Object.values(colorMap).forEach(className => {
            conditionSelect.classList.remove(className);
        });
        
        // Добавляем класс для выбранного значения
        const selectedValue = conditionSelect.value;
        if (colorMap[selectedValue]) {
            conditionSelect.classList.add(colorMap[selectedValue]);
        }
    }
    
    // Обновляем цвет при загрузке и при изменении
    conditionSelect.addEventListener('change', updateConditionColor);
    updateConditionColor(); // Initial color on load
}

// Universal column resize system with localStorage persistence
function attachColumnResizers(tbodySelector, storageKey) {
    const tbody = document.querySelector(tbodySelector);
    if (!tbody) return;
    
    const table = tbody.closest('table');
    if (!table) return;

    const thead = table.tHead;
    if (!thead || !thead.rows.length) return;
    const headerCells = Array.from(thead.rows[0].cells);
    
    // Load saved widths from localStorage
    const savedWidths = JSON.parse(localStorage.getItem(storageKey) || '{}');

    headerCells.forEach((th, index) => {
        // Restore saved width if exists
        if (savedWidths[index]) {
            th.style.width = savedWidths[index] + 'px';
        }
        
        // Prevent duplicating resizers
        const existing = th.querySelector('.col-resizer');
        if (existing) existing.remove();
        
        const resizer = document.createElement('div');
        resizer.className = 'col-resizer';
        th.appendChild(resizer);

        let startX = 0;
        let startWidth = 0;
        
        function onMouseMove(e) {
            const dx = e.clientX - startX;
            const newW = Math.max(50, startWidth + dx);
            th.style.width = newW + 'px';
        }
        
        function onMouseUp() {
            document.removeEventListener('mousemove', onMouseMove);
            document.removeEventListener('mouseup', onMouseUp);
            
            // Save all column widths to localStorage
            const widths = {};
            headerCells.forEach((cell, idx) => {
                widths[idx] = cell.getBoundingClientRect().width;
            });
            localStorage.setItem(storageKey, JSON.stringify(widths));
        }
        
        resizer.addEventListener('mousedown', (e) => {
            e.preventDefault();
            startX = e.clientX;
            startWidth = th.getBoundingClientRect().width;
            document.addEventListener('mousemove', onMouseMove);
            document.addEventListener('mouseup', onMouseUp);
        });
    });
}

// Attach resizers to all tables after they load data
function attachAllTableResizers() {
    // Wait a bit for tables to render
    setTimeout(() => {
        attachColumnResizers('#install-history-body', 'colWidth-install');
        attachColumnResizers('#shipment-history-body', 'colWidth-shipment');
        attachColumnResizers('#remove-history-body', 'colWidth-remove');
        attachColumnResizers('#repair-history-body', 'colWidth-repair');
        attachColumnResizers('#util-history-body', 'colWidth-util');
        attachColumnResizers('#param-history-body', 'colWidth-param');
        attachColumnResizers('#util-param-history-body', 'colWidth-util-param');
        attachColumnResizers('#atlb-history-body', 'colWidth-atlb');
        attachColumnResizers('#borescope-history-body', 'colWidth-borescope');
        attachColumnResizers('#purchase-orders-history-body', 'colWidth-purchase');
        attachColumnResizers('#store-balance-body', 'colWidth-store');
        attachColumnResizers('#parts-history-body', 'colWidth-parts');
    }, 100);
}

// Legacy function redirects to new system
function attachStoreBalanceColumnResizers() {
    attachColumnResizers('#store-balance-body', 'colWidth-store');
}

// === INITIALIZATION ===
document.addEventListener('DOMContentLoaded', () => {
    console.log('🔧 DOMContentLoaded event fired');
    
    // ===== ПРИМЕНИТЬ БЕЛЫЙ ТЕКСТ КО ВСЕМ БЕЙДЖАМ =====
    // Принудительно переопределяем стили для бейджей
    const badgeStyleFix = document.createElement('style');
    badgeStyleFix.textContent = `
        .badge { color: #ffffff !important; }
        .badge * { color: #ffffff !important; }
        [class*="bg-success"], [class*="bg-danger"], [class*="bg-primary"], 
        [class*="bg-warning"], [class*="bg-info"], [class*="bg-secondary"],
        [class*="bg-light"], [class*="bg-dark"] { 
            color: #ffffff !important; 
        }
        .text-dark { color: #ffffff !important; }
        span[class*="bg-"] { color: #ffffff !important; }
    `;
    document.head.appendChild(badgeStyleFix);
    
    // Мутация обсервер для новых бейджей
    const observer = new MutationObserver((mutations) => {
        mutations.forEach(() => {
            document.querySelectorAll('.badge, [class*="bg-success"], [class*="bg-danger"], [class*="bg-primary"]').forEach(el => {
                el.style.color = '#ffffff !important';
            });
        });
    });
    observer.observe(document.body, { 
        childList: true, 
        subtree: true, 
        attributes: true, 
        attributeFilter: ['class', 'style'] 
    });
    
    // Initialize resizers after short delay
    setTimeout(() => {
        attachAllTableResizers();
        // Add filter buttons after everything is loaded
        setTimeout(() => addFilterButtons(), 1000);
    }, 500);
    
    const savedUser = sessionStorage.getItem('currentUser');
    if (savedUser) {
        console.log('📝 User session found');
        currentUser = JSON.parse(savedUser);
        const modal = document.getElementById('login-modal');
        if (modal) {
            modal.style.display = 'none';
            modal.classList.remove('show');
        }
        const preloader = document.getElementById('aviation-preloader');
        if (preloader) {
            preloader.style.display = 'none';
            preloader.style.pointerEvents = 'none';
        }
        initializeUserInterface();
        
        // Открываем дашборд и загружаем данные
        setTimeout(() => {
            if (typeof openDashboardView === 'function') {
                openDashboardView();
            }
            if (typeof loadDashboardData === 'function') {
                loadDashboardData();
            }
        }, 100);
    } else {
        console.log('🔓 No session - login modal should be visible');
        // Don't manually show modal here - preloader already handles it
    }
    const form = document.getElementById('login-form');
    console.log('🎯 Login form element:', form);
    if (form) {
        form.addEventListener('submit', handleLogin);
        console.log('✅ Login form listener attached');
    } else {
        console.error('❌ Login form not found!');
        initStoreConditionColorHandler();
    }
    document.addEventListener('click', (e) => {
        if (!e.target.closest('.user-icon-btn') && !e.target.closest('.profile-dropdown')) {
            const profileDropdown = document.getElementById('profile-dropdown');
            if (profileDropdown) profileDropdown.classList.remove('show');
        }
        if (!e.target.closest('.user-icon-btn') && !e.target.closest('.notifications-panel')) {
            const notifyPanel = document.getElementById('notifications-panel');
            if (notifyPanel) notifyPanel.classList.remove('show');
        }
    });
});

async function sendNotification(actionType, entityType, entityId, message) {
    if (!currentUser) return;
    try {
        const performedBy = `${currentUser.first_name} ${currentUser.last_name}`;
        console.log(`Notification: ${actionType} ${entityType} by ${performedBy}`);
    } catch (error) {
        console.error('Error sending notification:', error);
    }
}

// === PARTS CARDS MODALS ===
async function openStoreBalanceModal() {
    const modal = document.getElementById('store-balance-modal');
    modal.classList.add('show');
    
    // Load Store Balance data
    const tbody = document.getElementById('modal-store-balance-body');
    tbody.innerHTML = '<tr><td colspan="11" class="text-center">Loading...</td></tr>';
    
    try {
        const res = await fetch('/api/store-balance' + noCache());
        if (!res.ok) throw new Error('Failed to load');
        
        const data = await res.json();
        tbody.innerHTML = '';
        
        if (!data || data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="11" class="text-center">No items in store</td></tr>';
            return;
        }
        
        data.forEach(item => {
            const fmt = (v) => v || '-';
            
            // Get condition color from loaded statuses
            const condText = (item.condition || '').trim();
            const condStatus = window.conditionStatuses?.find(s => s.name === condText);
            const condColor = condStatus ? condStatus.color : '#6c757d';
            const condHtml = condText ? `<span class="cond-badge" style="background-color: ${condColor}; color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.85em;">${escapeHtml(condText)}</span>` : '-';
            
            tbody.innerHTML += `
                <tr>
                    <td>${fmt(item.received_date)}</td>
                    <td>${fmt(item.part_name)}</td>
                    <td>${fmt(item.part_number)}</td>
                    <td>${fmt(item.serial_number)}</td>
                    <td>${condHtml}</td>
                    <td>${fmt(item.quantity)}</td>
                    <td>${fmt(item.unit)}</td>
                    <td>${fmt(item.location)}</td>
                    <td>${fmt(item.shelf)}</td>
                    <td>${fmt(item.owner)}</td>
                    <td>${fmt(item.remarks)}</td>
                </tr>`;
        });
    } catch (err) {
        tbody.innerHTML = '<tr><td colspan="11" class="text-center text-danger">Error loading data</td></tr>';
    }
}

function closeStoreBalanceModal() {
    document.getElementById('store-balance-modal').classList.remove('show');
}

async function openPartsLogisticsModal() {
    const modal = document.getElementById('parts-logistics-modal');
    modal.classList.add('show');
    
    // Load Parts History data
    const tbody = document.getElementById('modal-parts-logistics-body');
    tbody.innerHTML = '<tr><td colspan="10" class="text-center">Loading...</td></tr>';
    
    try {
        const res = await fetch('/api/parts/history' + noCache());
        if (!res.ok) throw new Error('Failed to load');
        
        const data = await res.json();
        tbody.innerHTML = '';
        
        if (!data || data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="10" class="text-center">No parts movements recorded</td></tr>';
            return;
        }
        
        data.sort((a, b) => (b.id || 0) - (a.id || 0));
        data.forEach(item => {
            const fmt = (v) => v || '-';
            tbody.innerHTML += `
                <tr>
                    <td>${fmt(item.date)}</td>
                    <td><span class="badge bg-info">${fmt(item.action)}</span></td>
                    <td>${fmt(item.part_name)}</td>
                    <td>${fmt(item.part_number)}</td>
                    <td>${fmt(item.serial_number)}</td>
                    <td>${fmt(item.quantity)}</td>
                    <td>${fmt(item.from_esn)}</td>
                    <td>${fmt(item.to_esn)}</td>
                    <td>${fmt(item.location)}</td>
                    <td>${fmt(item.reason)}</td>
                </tr>`;
        });
    } catch (err) {
        tbody.innerHTML = '<tr><td colspan="10" class="text-center text-danger">Error loading data</td></tr>';
    }
}

function closePartsLogisticsModal() {
    document.getElementById('parts-logistics-modal').classList.remove('show');
}

function filterModalTable(tableId, searchId) {
    const search = document.getElementById(searchId).value.toLowerCase();
    const tbody = document.getElementById(tableId);
    const rows = tbody.getElementsByTagName('tr');
    
    for (let row of rows) {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(search) ? '' : 'none';
    }
}

// Update card counts on dashboard load
async function updatePartsCardCounts() {
    try {
        // Store Balance count
        const sbRes = await fetch('/api/store-balance' + noCache());
        if (sbRes.ok) {
            const sbData = await sbRes.json();
            document.getElementById('store-balance-count').textContent = sbData.length || 0;
        }
        
        // Parts Logistics count
        const plRes = await fetch('/api/parts/history' + noCache());
        if (plRes.ok) {
            const plData = await plRes.json();
            document.getElementById('parts-logistics-count').textContent = plData.length || 0;
        }
    } catch (err) {
        console.error('Error updating parts counts:', err);
    }
}
</script>

<!-- Universal Filter Panel -->
<div id="filter-overlay" class="filter-overlay" onclick="closeFilterPanel()"></div>
<div id="filter-panel" class="filter-panel">
    <div class="filter-panel-header">
        <h4><i class="bi bi-funnel-fill me-2"></i>Filter Data</h4>
        <button class="filter-panel-close" onclick="closeFilterPanel()">×</button>
    </div>
    <div id="filter-fields-container"></div>
    <div class="filter-actions">
        <button class="filter-reset" onclick="resetTableFilter()">
            <i class="bi bi-arrow-clockwise me-1"></i>Reset
        </button>
        <button class="filter-apply" onclick="applyTableFilter()">
            <i class="bi bi-check-circle me-1"></i>Apply
        </button>
    </div>
</div>

<!-- Store Balance Modal -->
<div id="store-balance-modal" class="parts-modal-overlay" onclick="if(event.target === this) closeStoreBalanceModal()">
    <div class="parts-modal-content">
        <div class="parts-modal-header">
            <h4><i class="bi bi-box-seam me-2"></i><span data-parts-title="store">Store Balance</span> - Inventory</h4>
            <button class="parts-modal-close" onclick="closeStoreBalanceModal()">×</button>
        </div>
        <div class="parts-modal-body">
            <div class="mb-3">
                <input type="text" class="form-control" id="modal-store-search" placeholder="🔍 Filter by part name, P/N, S/N, condition..." onkeyup="filterModalTable('modal-store-balance-body', 'modal-store-search')">
            </div>
            <div class="table-responsive">
                <table class="table table-hover table-sm">
                    <thead class="table-light">
                        <tr>
                            <th>Received</th>
                            <th>Part Name</th>
                            <th>P/N</th>
                            <th>S/N</th>
                            <th>Condition</th>
                            <th>Qty</th>
                            <th>R.O#</th>
                            <th>Location</th>
                            <th>Status</th>
                            <th>Delivered to</th>
                            <th>Remarks</th>
                        </tr>
                    </thead>
                    <tbody id="modal-store-balance-body"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Parts Logistics Modal -->
<div id="parts-logistics-modal" class="parts-modal-overlay" onclick="if(event.target === this) closePartsLogisticsModal()">
    <div class="parts-modal-content">
        <div class="parts-modal-header green">
            <h4><i class="bi bi-arrow-left-right me-2"></i><span data-parts-title="logistics">Parts Removal/Installation</span> - All Movements</h4>
            <button class="parts-modal-close" onclick="closePartsLogisticsModal()">×</button>
        </div>
        <div class="parts-modal-body">
            <div class="mb-3">
                <input type="text" class="form-control" id="modal-parts-search" placeholder="🔍 Filter by date, action, part name..." onkeyup="filterModalTable('modal-parts-logistics-body', 'modal-parts-search')">
            </div>
            <div class="table-responsive">
                <table class="table table-hover table-sm">
                    <thead class="table-light">
                        <tr>
                            <th>Date</th>
                            <th>Action</th>
                            <th>Part Name</th>
                            <th>P/N</th>
                            <th>S/N</th>
                            <th>Qty</th>
                            <th>From ESN</th>
                            <th>To ESN</th>
                            <th>Location</th>
                            <th>Reason</th>
                        </tr>
                    </thead>
                    <tbody id="modal-parts-logistics-body"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
// ============================================================================
// === FAKE INSTALLED JS (Ð½ÐµÐ·Ð°Ð²Ð¸ÑÐ¸Ð¼Ñ‹Ð¹ Ð¼Ð¾Ð´ÑƒÐ»ÑŒ) ===
// ============================================================================

async function openFakeInstalledView() {
    hideAllViews();
    document.getElementById('view-fake-installed').style.display = 'block';
    updateHistory('fake-installed');
    ensureFakeToolbar();
    await applyFakeHeaders();
    await loadFakeInstalled();
    setupHeaderDblClick();
}

async function loadFakeInstalled() {
    const filterSn = document.getElementById('fake-filter-sn').value.trim();
    const tbody = document.getElementById('fake-installed-table');
    
    tbody.innerHTML = '<tr><td colspan="10" class="text-center text-muted py-3">Loading...</td></tr>';
    
    try {
        let url = '/api/fake-installed';
        if (filterSn) {
            url += `?engine_sn=${encodeURIComponent(filterSn)}`;
        }
        
        const res = await safeFetch(url);
        if (!res || !res.ok) throw new Error('Failed to load');
        
        const data = await res.json();
        
        if (!Array.isArray(data) || data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="10" class="text-center text-muted">No records</td></tr>';
            return;
        }
        
        tbody.innerHTML = '';
        data.sort((a, b) => (b.id || 0) - (a.id || 0));
        data.forEach((r, idx) => {
            tbody.innerHTML += `
                <tr>
                    <td><small>${idx + 1}</small></td>
                    <td><small>${r.documented_date || '-'}</small></td>
                    <td><strong>${r.engine_original_sn}</strong></td>
                    <td><small>${r.engine_current_sn || '-'}</small></td>
                    <td><small>${r.aircraft_tail || '-'}</small></td>
                    <td><small>${r.position || '-'}</small></td>
                    <td><small>${r.documented_reason || '-'}</small></td>
                    <td><small>${r.old_engine_sn || '-'} â†’ ${r.new_engine_sn || '-'}</small></td>
                    <td><small>${r.actual_notes ? (r.actual_notes.substring(0, 20) + '...') : '-'}</small></td>
                    <td>
                        <button class="btn btn-xs btn-info" onclick="editFakeInstalled(${r.id})" title="Edit">📝</button>
                        <button class="btn btn-xs btn-danger" onclick="deleteFakeInstalled(${r.id})" title="Delete">🗑️</button>
                    </td>
                </tr>
            `;
        });
    } catch (err) {
        console.error('Error loading fake installed:', err);
        tbody.innerHTML = '<tr><td colspan="10" class="text-center text-danger">Loading error</td></tr>';
    }
}

function showFakeInstalledForm() {
    document.getElementById('form-fake-installed').reset();
    document.getElementById('fake-engine-sn').focus();
    const modal = new bootstrap.Modal(document.getElementById('fakeInstalledModal'));
    modal.show();
}

async function saveFakeInstalled() {
    const data = {
        engine_original_sn: document.getElementById('fake-engine-sn').value.trim(),
        engine_current_sn: document.getElementById('fake-engine-current-sn').value.trim(),
        aircraft_tail: document.getElementById('fake-aircraft').value.trim(),
        position: document.getElementById('fake-position').value ? parseInt(document.getElementById('fake-position').value) : null,
        documented_date: document.getElementById('fake-date').value,
        documented_reason: document.getElementById('fake-reason').value.trim(),
        old_engine_sn: document.getElementById('fake-old-sn').value.trim(),
        new_engine_sn: document.getElementById('fake-new-sn').value.trim(),
        actual_notes: document.getElementById('fake-notes').value.trim(),
        created_by: 'User'
    };
    
    if (!data.engine_original_sn || !data.documented_date) {
        alert('Please fill required fields: Engine S/N and Date');
        return;
    }
    
    try {
        const res = await fetch('/api/fake-installed', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        
        if (!res.ok) throw new Error('Save failed');
        
        bootstrap.Modal.getInstance(document.getElementById('fakeInstalledModal')).hide();
        showSuccessNotification('Record added!');
        await loadFakeInstalled();
    } catch (err) {
        showErrorNotification('Error: ' + err.message);
    }
}

async function deleteFakeInstalled(id) {
    if (!confirm('Delete this record?')) return;
    
    try {
        const res = await fetch(`/api/fake-installed/${id}`, { method: 'DELETE' });
        if (!res.ok) throw new Error('Delete failed');
        
        showSuccessNotification('Record deleted!');
        await loadFakeInstalled();
    } catch (err) {
        showErrorNotification('Error: ' + err.message);
    }
}

let __fakeEditState = null;

function ensureFakeToolbar() {
    if (document.getElementById('fake-edit-toolbar')) return;
    const toolbar = document.createElement('div');
    toolbar.id = 'fake-edit-toolbar';
    toolbar.className = 'd-none position-sticky top-0 py-2 bg-light border-bottom';
    toolbar.style.zIndex = '1066';
    toolbar.innerHTML = '<div class="container-fluid d-flex justify-content-end gap-2">\
        <button class="btn btn-sm btn-secondary" onclick="cancelFakeEdits()">Cancel</button>\
        <button class="btn btn-sm btn-primary" onclick="saveFakeEdits()">Save</button>\
    </div>';
    const host = document.getElementById('view-fake-installed');
    host.parentNode.insertBefore(toolbar, host);
}

function showFakeToolbar(show) {
    const el = document.getElementById('fake-edit-toolbar');
    if (el) el.classList.toggle('d-none', !show);
}

async function editFakeInstalled(id) {
    if (__fakeEditState) return; // one edit at a time
    const btn = document.querySelector(`button[onclick="editFakeInstalled(${id})"]`);
    if (!btn) return;
    const tr = btn.closest('tr');
    if (!tr) return;
    __fakeEditState = { type: 'row', tr, id, originalHTML: tr.innerHTML };

    const tds = Array.from(tr.querySelectorAll('td'));
    const getText = (i) => (tds[i]?.innerText || '').trim();
    const pairText = (getText(7) || '');
    const pair = pairText.includes('→') ? pairText.split('→') : pairText.split('â†’');
    const oldSn = (pair[0] || '').trim();
    const newSn = (pair[1] || '').trim();

    // Build editable row
    tr.innerHTML = `
        <td>${getText(0)}</td>
        <td><input id="fkedit-date" type="date" class="form-control form-control-sm" value="${getText(1) !== '-' ? getText(1) : ''}"></td>
        <td><input id="fkedit-osn" type="text" class="form-control form-control-sm" value="${getText(2)}"></td>
        <td><input id="fkedit-csn" type="text" class="form-control form-control-sm" value="${getText(3) !== '-' ? getText(3) : ''}"></td>
        <td>
            <select id="fkedit-ac" class="form-select form-select-sm">
                <option value=""></option>
                <option value="ER-BAT" ${getText(4)==='ER-BAT'?'selected':''}>ER-BAT</option>
                <option value="ER-BAR" ${getText(4)==='ER-BAR'?'selected':''}>ER-BAR</option>
                <option value="ER-BAQ" ${getText(4)==='ER-BAQ'?'selected':''}>ER-BAQ</option>
            </select>
        </td>
        <td>
            <select id="fkedit-pos" class="form-select form-select-sm">
                <option value=""></option>
                <option value="1" ${getText(5)==='1'?'selected':''}>1</option>
                <option value="2" ${getText(5)==='2'?'selected':''}>2</option>
                <option value="3" ${getText(5)==='3'?'selected':''}>3</option>
                <option value="4" ${getText(5)==='4'?'selected':''}>4</option>
            </select>
        </td>
        <td><input id="fkedit-reason" type="text" class="form-control form-control-sm" value="${getText(6) !== '-' ? getText(6) : ''}"></td>
        <td>
            <div class="d-flex gap-1">
                <input id="fkedit-old" type="text" class="form-control form-control-sm" placeholder="old" value="${oldSn==='-'?'':oldSn}">
                <span class="align-self-center">→</span>
                <input id="fkedit-new" type="text" class="form-control form-control-sm" placeholder="new" value="${newSn==='-'?'':newSn}">
            </div>
        </td>
        <td><input id="fkedit-notes" type="text" class="form-control form-control-sm" value="${getText(8) !== '-' ? getText(8).replace(/…$/, '') : ''}"></td>
        <td>
            <button class="btn btn-xs btn-secondary" onclick="cancelFakeEdits()" title="Cancel">↩</button>
            <button class="btn btn-xs btn-primary" onclick="saveFakeEdits()" title="Save">✔</button>
        </td>`;

    showFakeToolbar(true);
}

function cancelFakeEdits() {
    if (!__fakeEditState) return;
    if (__fakeEditState.type === 'row') {
        __fakeEditState.tr.innerHTML = __fakeEditState.originalHTML;
    }
    __fakeEditState = null;
    showFakeToolbar(false);
}

async function saveFakeEdits() {
    try {
        if (!__fakeEditState) return;
        if (__fakeEditState.type === 'row') {
            const id = __fakeEditState.id;
            const payload = {
                documented_date: document.getElementById('fkedit-date').value || null,
                engine_original_sn: document.getElementById('fkedit-osn').value.trim(),
                engine_current_sn: document.getElementById('fkedit-csn').value.trim(),
                aircraft_tail: document.getElementById('fkedit-ac').value,
                position: (function(){ const v = document.getElementById('fkedit-pos').value; return v?parseInt(v):null; })(),
                documented_reason: document.getElementById('fkedit-reason').value.trim(),
                old_engine_sn: document.getElementById('fkedit-old').value.trim(),
                new_engine_sn: document.getElementById('fkedit-new').value.trim(),
                actual_notes: document.getElementById('fkedit-notes').value.trim()
            };
            const res = await fetch(`/api/fake-installed/${id}`, { method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
            if (!res.ok) throw new Error('Update failed');
            showSuccessNotification('Record updated');
            __fakeEditState = null;
            showFakeToolbar(false);
            await loadFakeInstalled();
        } else if (__fakeEditState.type === 'headers') {
            // Collect header inputs
            const inputs = Array.from(document.querySelectorAll('thead th input[data-key]'));
            const map = {};
            inputs.forEach(inp => { map[inp.getAttribute('data-key')] = inp.value.trim(); });
            const res = await fetch('/api/fake-installed/headers', { method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify(map) });
            if (!res.ok) throw new Error('Header update failed');
            showSuccessNotification('Headers updated');
            __fakeEditState = null;
            showFakeToolbar(false);
            await applyFakeHeaders();
        }
    } catch (e) {
        showErrorNotification('Error: ' + e.message);
    }
}

async function applyFakeHeaders() {
    try {
        const res = await fetch('/api/fake-installed/headers');
        if (!res.ok) return;
        const map = await res.json();
        const thead = document.querySelector('#view-fake-installed thead');
        if (!thead) return;
        const keys = ['idx','documented_date','engine_original_sn','engine_current_sn','aircraft_tail','position','documented_reason','documented_pair','actual_notes','actions'];
        const ths = Array.from(thead.querySelectorAll('th'));
        ths.forEach((th, i) => { const k = keys[i]; th.textContent = map[k] || th.textContent; });
    } catch {}
}

function setupHeaderDblClick() {
    const thead = document.querySelector('#view-fake-installed thead');
    if (!thead) return;
    const keys = ['idx','documented_date','engine_original_sn','engine_current_sn','aircraft_tail','position','documented_reason','documented_pair','actual_notes','actions'];
    Array.from(thead.querySelectorAll('th')).forEach((th, i) => {
        const key = keys[i];
        if (key === 'actions') return;
        th.ondblclick = () => {
            if (__fakeEditState) return;
            const current = th.innerText.trim();
            th.innerHTML = `<input type="text" class="form-control form-control-sm" data-key="${key}" value="${current}">`;
            __fakeEditState = { type: 'headers' };
            showFakeToolbar(true);
        };
    });
}

// ===== NAMEPLATE TRACKER FUNCTIONS =====

async function openNameplateTrackerView() {
    hideAllViews();
    document.getElementById('view-nameplate-tracker').style.display = 'block';
    updateHistory('nameplate-tracker');
    await loadNameplateTracker();
}

async function loadNameplateTracker() {
    const filterSn = document.getElementById('nameplate-filter-sn').value.trim();
    const filterGss = document.getElementById('nameplate-filter-gss').value.trim();
    const activeOnly = document.getElementById('nameplate-filter-active').checked;
    const tbody = document.getElementById('nameplate-table-body');
    
    tbody.innerHTML = '<tr><td colspan="13" class="text-center text-muted py-3">Loading...</td></tr>';
    
    try {
        let url = '/api/nameplate-tracker?';
        const params = [];
        if (filterSn) params.push(`nameplate_sn=${encodeURIComponent(filterSn)}`);
        if (filterGss) params.push(`gss_id=${encodeURIComponent(filterGss)}`);
        if (activeOnly) params.push('active_only=true');
        url += params.join('&');
        
        const res = await safeFetch(url);
        if (!res || !res.ok) throw new Error('Failed to load');
        
        const data = await res.json();
        
        if (!Array.isArray(data) || data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="13" class="text-center text-muted">No records</td></tr>';
            return;
        }
        
        tbody.innerHTML = '';
        data.sort((a, b) => (b.id || 0) - (a.id || 0));
        data.forEach((r, idx) => {
            tbody.innerHTML += `
                <tr>
                    <td><small>${idx + 1}</small></td>
                    <td><strong>${r.nameplate_sn || '-'}</strong></td>
                    <td><small>${r.engine_model || '-'}</small></td>
                    <td><strong>${r.gss_id || '-'}</strong></td>
                    <td><small>${r.engine_orig_sn || '-'}</small></td>
                    <td><small>${r.aircraft_tail || '-'}</small></td>
                    <td><small>${r.position || '-'}</small></td>
                    <td><small>${r.installed_date || '-'}</small></td>
                    <td><small>${r.removed_date || '-'}</small></td>
                    <td><small>${r.location_type || '-'}</small></td>
                    <td><small>${r.action_note || '-'}</small></td>
                    <td><small>${r.notes ? (r.notes.substring(0, 20) + '...') : '-'}</small></td>
                    <td>
                        <button class="btn btn-xs btn-info" onclick="editNameplateTracker(${r.id})" title="Edit">📝</button>
                        <button class="btn btn-xs btn-danger" onclick="deleteNameplateTracker(${r.id})" title="Delete">🗑️</button>
                    </td>
                </tr>
            `;
        });
    } catch (err) {
        console.error('Error loading nameplate tracker:', err);
        tbody.innerHTML = '<tr><td colspan="13" class="text-center text-danger">Loading error</td></tr>';
    }
}

async function loadEngineSNList() {
    try {
        const res = await fetch('/api/engines');
        if (!res.ok) return;
        const engines = await res.json();
        
        const datalist = document.getElementById('engine-sn-list');
        datalist.innerHTML = '';
        
        engines.forEach(eng => {
            if (eng.original_sn) {
                const opt = document.createElement('option');
                opt.value = eng.original_sn;
                opt.textContent = `${eng.original_sn} (GSS: ${eng.gss_sn || 'N/A'})`;
                datalist.appendChild(opt);
            }
            if (eng.current_sn && eng.current_sn !== eng.original_sn) {
                const opt = document.createElement('option');
                opt.value = eng.current_sn;
                opt.textContent = `${eng.current_sn} (GSS: ${eng.gss_sn || 'N/A'})`;
                datalist.appendChild(opt);
            }
        });
    } catch (err) {
        console.error('Failed to load engine SN list:', err);
    }
}

function openNpActionModal() {
    // Clear all fields
    document.getElementById('np-date').value = new Date().toISOString().split('T')[0];
    document.getElementById('np-aircraft').value = '';
    document.getElementById('np-plate1-model').value = '';
    document.getElementById('np-plate1-sn').value = '';
    document.getElementById('np-plate1-orig-sn').value = '';
    document.getElementById('np-plate1-gss').value = '';
    document.getElementById('np-plate2-model').value = '';
    document.getElementById('np-plate2-sn').value = '';
    document.getElementById('np-plate2-orig-sn').value = '';
    document.getElementById('np-plate2-gss').value = '';
    document.getElementById('np-action-type').value = 'swap';
    document.getElementById('np-remove-reason').value = '';
    document.getElementById('np-remove-sent-to').value = '';
    document.getElementById('np-remove-available').value = 'Yes';
    document.getElementById('np-install-reason').value = '';
    document.getElementById('np-install-from').value = '';
    
    // Hide warnings
    const w1 = document.getElementById('np-plate1-warning');
    const w2 = document.getElementById('np-plate2-warning');
    if (w1) w1.style.display = 'none';
    if (w2) w2.style.display = 'none';
    
    // Hide preview
    const preview = document.getElementById('np-swap-preview');
    if (preview) preview.style.display = 'none';
    
    loadEngineSNList(); // Load autocomplete list
    switchActionUI();
    const modal = new bootstrap.Modal(document.getElementById('npActionsModal'));
    modal.show();
    
    // Add event listener for aircraft selection
    setTimeout(() => {
        const aircraftSelect = document.getElementById('np-aircraft');
        if (aircraftSelect) {
            aircraftSelect.addEventListener('change', loadPlate1EnginesForAircraft);
        }
    }, 100);
}

// Load list of INSTALLED engines on selected aircraft for Plate 1 dropdown
async function loadPlate1EnginesForAircraft() {
    const aircraft = document.getElementById('np-aircraft').value;
    if (!aircraft) {
        document.getElementById('np-plate1-sn').value = '';
        return;
    }
    
    try {
        // Load all engines on this aircraft that are INSTALLED
        const res = await fetch(`/api/engines?aircraft=${encodeURIComponent(aircraft)}&status=INSTALLED`);
        if (!res.ok) return;
        
        const engines = await res.json();
        const snInput = document.getElementById('np-plate1-sn');
        
        // Remove old datalist if exists
        const oldList = document.getElementById('plate1-sn-list');
        if (oldList) oldList.remove();
        
        // Create new datalist
        const datalist = document.createElement('datalist');
        datalist.id = 'plate1-sn-list';
        
        engines.forEach(eng => {
            const opt = document.createElement('option');
            opt.value = eng.current_sn || eng.original_sn || '';
            opt.textContent = `${opt.value} (Pos ${eng.position || 'N/A'}) - GSS: ${eng.gss_sn || 'N/A'}`;
            datalist.appendChild(opt);
        });
        
        document.body.appendChild(datalist);
        snInput.setAttribute('list', 'plate1-sn-list');
    } catch (err) {
        console.error('Failed to load Plate 1 engines:', err);
    }
}

function switchActionUI() {
    const action = document.getElementById('np-action-type').value;
    document.getElementById('np-context-swap').style.display = (action === 'swap') ? 'block' : 'none';
    document.getElementById('np-context-remove').style.display = (action === 'remove') ? 'block' : 'none';
    document.getElementById('np-context-install').style.display = (action === 'install') ? 'block' : 'none';
    
    // Hide swap preview when switching away
    if (action !== 'swap') {
        const preview = document.getElementById('np-swap-preview');
        if (preview) preview.style.display = 'none';
    }
}

function updateSwapPreview() {
    const plate1_sn = document.getElementById('np-plate1-sn').value.trim();
    const plate1_orig_sn = document.getElementById('np-plate1-orig-sn').value.trim();
    const plate1_gss = document.getElementById('np-plate1-gss').value.trim();
    
    const plate2_sn = document.getElementById('np-plate2-sn').value.trim();
    const plate2_orig_sn = document.getElementById('np-plate2-orig-sn').value.trim();
    const plate2_gss = document.getElementById('np-plate2-gss').value.trim();
    
    const preview = document.getElementById('np-swap-preview');
    const content = document.getElementById('np-swap-preview-content');
    
    // Show only if BOTH SNs filled AND BOTH GSS IDs filled
    if (!plate1_sn || !plate2_sn || !plate1_gss || !plate2_gss) {
        preview.style.display = 'none';
        return;
    }
    
    // SWAP GSS IDs - show what will happen AFTER swap
    let html = '<div style="background: rgba(255,255,255,0.15); padding: 10px; border-radius: 6px; margin-bottom: 8px;">';
    html += `<strong>🔄 Plate 1:</strong> SN <span style="background: rgba(255,255,255,0.3); padding: 2px 8px; border-radius: 3px; font-weight: bold;">${plate1_sn}</span>`;
    if (plate1_orig_sn) html += ` (Orig: ${plate1_orig_sn})`;
    html += ` → will have GSS ID: <span style="background: #4ade80; color: #000; padding: 2px 8px; border-radius: 3px; font-weight: bold;">${plate2_gss}</span>`;
    html += '</div>';
    
    html += '<div style="background: rgba(255,255,255,0.15); padding: 10px; border-radius: 6px;">';
    html += `<strong>🔄 Plate 2:</strong> SN <span style="background: rgba(255,255,255,0.3); padding: 2px 8px; border-radius: 3px; font-weight: bold;">${plate2_sn}</span>`;
    if (plate2_orig_sn) html += ` (Orig: ${plate2_orig_sn})`;
    html += ` → will have GSS ID: <span style="background: #4ade80; color: #000; padding: 2px 8px; border-radius: 3px; font-weight: bold;">${plate1_gss}</span>`;
    html += '</div>';
    
    content.innerHTML = html;
    preview.style.display = 'block';
}


// Load engines for Plate 1 (currently on selected aircraft) - from datalist when aircraft selected
async function loadPlate1Engines() {
    const aircraft = document.getElementById('np-aircraft').value;
    const sn = document.getElementById('np-plate1-sn').value.trim();
    
    if (!sn) {
        document.getElementById('np-plate1-model').value = '';
        document.getElementById('np-plate1-orig-sn').value = '';
        document.getElementById('np-plate1-gss').value = '';
        return;
    }
    
    try {
        // Fetch engine by current SN
        const res = await fetch(`/api/engine-by-sn/${encodeURIComponent(sn)}`);
        if (!res.ok) throw new Error('Engine not found');
        
        const eng = await res.json();
        
        // Populate fields
        document.getElementById('np-plate1-model').value = eng.model || '';
        document.getElementById('np-plate1-orig-sn').value = eng.original_sn || '';
        document.getElementById('np-plate1-gss').value = eng.gss_id || '';
        document.getElementById('np-plate1-warning').style.display = 'none';
        
        // For remove: populate from aircraft/position
        if (document.getElementById('np-action-type').value === 'remove') {
            document.getElementById('np-remove-ac').value = eng.aircraft_tail || '';
            document.getElementById('np-remove-pos').value = eng.position || '';
        }
        
        // Update swap preview
        updateSwapPreview();
    } catch (err) {
        console.error('Lookup error:', err);
        document.getElementById('np-plate1-model').value = '';
        document.getElementById('np-plate1-orig-sn').value = '';
        document.getElementById('np-plate1-gss').value = '';
        document.getElementById('np-plate1-warning').style.display = 'block';
    }
}

// Load engines for Plate 2 (on OTHER aircraft for swap)
async function loadPlate2Engines() {
    const sn = document.getElementById('np-plate2-sn').value.trim();
    const aircraft1 = document.getElementById('np-aircraft').value;
    
    if (!sn) {
        document.getElementById('np-plate2-model').value = '';
        document.getElementById('np-plate2-orig-sn').value = '';
        document.getElementById('np-plate2-gss').value = '';
        return;
    }
    
    try {
        // Fetch engine by current SN
        const res = await fetch(`/api/engine-by-sn/${encodeURIComponent(sn)}`);
        if (!res.ok) throw new Error('Engine not found');
        
        const eng = await res.json();
        
        // For SWAP: Plate 2 engine should be on DIFFERENT aircraft than Plate 1
        if (aircraft1 && eng.aircraft_tail === aircraft1) {
            throw new Error('Plate 2 engine must be on different aircraft');
        }
        
        // Validate that engine is INSTALLED
        if (eng.status !== 'INSTALLED' || !eng.aircraft_tail) {
            throw new Error('Engine must be INSTALLED on an aircraft');
        }
        
        // Populate fields
        document.getElementById('np-plate2-model').value = eng.model || '';
        document.getElementById('np-plate2-orig-sn').value = eng.original_sn || '';
        document.getElementById('np-plate2-gss').value = eng.gss_id || '';
        document.getElementById('np-plate2-warning').style.display = 'none';
        
        // Update swap preview
        updateSwapPreview();
    } catch (err) {
        console.error('Lookup error:', err);
        document.getElementById('np-plate2-model').value = '';
        document.getElementById('np-plate2-orig-sn').value = '';
        document.getElementById('np-plate2-gss').value = '';
        document.getElementById('np-plate2-warning').style.display = 'block';
    }
}

async function lookupEngineSN(plate) {
    const snEl = document.getElementById(`np-${plate}-sn`);
    const modelEl = document.getElementById(`np-${plate}-model`);
    const gssEl = document.getElementById(`np-${plate}-gss`);
    const warningEl = document.getElementById(`np-${plate}-warning`);
    
    const sn = snEl.value.trim();
    if (!sn) {
        modelEl.value = '';
        gssEl.value = '';
        if (warningEl) warningEl.style.display = 'none';
        return;
    }
    
    try {
        const res = await fetch(`/api/engine-by-sn/${encodeURIComponent(sn)}`);
        if (!res.ok) {
            console.log(`Engine lookup failed for SN: ${sn}, Status: ${res.status}`);
            // Показываем предупреждение под полем, НЕ блокируем ввод
            if (warningEl) warningEl.style.display = 'block';
            modelEl.value = '';
            gssEl.value = '';
            return;
        }
        
        const eng = await res.json();
        console.log('Engine found:', eng);
        
        // Скрываем предупреждение если двигатель найден
        if (warningEl) warningEl.style.display = 'none';
        
        // Заполняем Model (если пусто, показываем GSS ID как fallback)
        modelEl.value = eng.model || eng.gss_id || '';
        gssEl.value = eng.gss_id || '';
        
        // Для remove/install: заполняем aircraft и position
        if (plate === 'plate1' && document.getElementById('np-action-type').value === 'remove') {
            document.getElementById('np-remove-ac').value = eng.aircraft_tail || '';
            document.getElementById('np-remove-pos').value = eng.position || '';
        }
        
        // Update swap preview if in swap mode
        if (document.getElementById('np-action-type').value === 'swap') {
            updateSwapPreview();
        }
    } catch (err) {
        console.error('Lookup error:', err);
        if (warningEl) warningEl.style.display = 'block';
    }
    
    // Always update preview after lookup attempt (even if failed)
    if (document.getElementById('np-action-type').value === 'swap') {
        updateSwapPreview();
    }
}

async function saveNameplateAction() {
    const action = document.getElementById('np-action-type').value;
    const date = document.getElementById('np-date').value;
    const aircraft_from = document.getElementById('np-aircraft').value;
    
    if (!date) {
        alert('Date is required');
        return;
    }
    
    const plate1_sn = document.getElementById('np-plate1-sn').value.trim();
    const plate1_gss = document.getElementById('np-plate1-gss').value.trim();
    
    if (!plate1_sn) {
        alert('Plate 1 SN required');
        return;
    }
    
    const payload = {
        action: action,
        date: date,
        performed_by: 'User',
    };
    
    if (action === 'swap') {
        const plate2_sn = document.getElementById('np-plate2-sn').value.trim();
        const plate2_gss = document.getElementById('np-plate2-gss').value.trim();
        
        if (!plate2_sn) {
            alert('Plate 2 SN required for swap');
            return;
        }
        
        payload.plate1_sn = plate1_sn;
        payload.plate2_sn = plate2_sn;
        payload.aircraft_from = aircraft_from;
    } else if (action === 'remove') {
        payload.plate1_sn = plate1_sn;
        payload.aircraft_from = document.getElementById('np-remove-ac').value;
        payload.position_from = parseInt(document.getElementById('np-remove-pos').value) || null;
        payload.reason = document.getElementById('np-remove-reason').value;
        payload.sent_to = document.getElementById('np-remove-sent-to').value;
    } else if (action === 'install') {
        const install_ac = document.getElementById('np-install-ac').value;
        const install_pos = document.getElementById('np-install-pos').value;
        
        if (!install_ac || !install_pos) {
            alert('Aircraft and Position required for install');
            return;
        }
        
        payload.plate1_sn = plate1_sn;
        payload.aircraft_to = install_ac;
        payload.position_to = parseInt(install_pos);
        payload.reason = document.getElementById('np-install-reason').value;
        payload.took_from = document.getElementById('np-install-from').value;
    }
    
    const btn = document.getElementById('np-save-btn');
    btn.disabled = true;
    
    try {
        const res = await fetch('/api/nameplate-tracker/execute-action', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });
        
        if (!res.ok) {
            const err = await res.text();
            throw new Error(err || 'Save failed');
        }
        
        showSuccessNotification('Action saved successfully');
        
        // Hide preview before closing modal
        const preview = document.getElementById('np-swap-preview');
        if (preview) preview.style.display = 'none';
        
        const modalEl = document.getElementById('npActionsModal');
        const inst = bootstrap.Modal.getInstance(modalEl);
        if (inst) inst.hide();
        
        // Reload tables AND datalist
        await loadNameplateTracker();
        if (typeof loadMainTable === 'function') {
            await loadMainTable();
        }
        // Reload datalist to show updated GSS IDs
        await loadEngineSNList();
    } catch (err) {
        showErrorNotification('Error: ' + err.message);
    } finally {
        btn.disabled = false;
    }
}

function showNameplateTrackerForm(record = null) {
    document.getElementById('nameplate-form').reset();
    
    if (record) {
        document.getElementById('nameplate-id').value = record.id;
        document.getElementById('nameplate-sn').value = record.nameplate_sn || '';
        document.getElementById('nameplate-engine-model').value = record.engine_model || '';
        document.getElementById('nameplate-gss-id').value = record.gss_id || '';
        document.getElementById('nameplate-orig-sn').value = record.engine_orig_sn || '';
        document.getElementById('nameplate-aircraft').value = record.aircraft_tail || '';
        document.getElementById('nameplate-position').value = record.position || '';
        document.getElementById('nameplate-installed').value = record.installed_date || '';
        document.getElementById('nameplate-removed').value = record.removed_date || '';
        document.getElementById('nameplate-location').value = record.location_type || '';
        document.getElementById('nameplate-performed-by').value = record.performed_by || '';
        document.getElementById('nameplate-action-note').value = record.action_note || '';
        document.getElementById('nameplate-notes').value = record.notes || '';
    } else {
        document.getElementById('nameplate-id').value = '';
        document.getElementById('nameplate-sn').focus();
    }
    
    const modal = new bootstrap.Modal(document.getElementById('nameplateTrackerModal'));
    modal.show();
}

async function saveNameplateTracker() {
    const id = document.getElementById('nameplate-id').value;
    const data = {
        nameplate_sn: document.getElementById('nameplate-sn').value.trim(),
        engine_model: document.getElementById('nameplate-engine-model').value.trim(),
        gss_id: document.getElementById('nameplate-gss-id').value.trim(),
        engine_orig_sn: document.getElementById('nameplate-orig-sn').value.trim(),
        aircraft_tail: document.getElementById('nameplate-aircraft').value.trim(),
        position: document.getElementById('nameplate-position').value ? parseInt(document.getElementById('nameplate-position').value) : null,
        installed_date: document.getElementById('nameplate-installed').value,
        removed_date: document.getElementById('nameplate-removed').value || null,
        location_type: document.getElementById('nameplate-location').value.trim(),
        action_note: document.getElementById('nameplate-action-note').value.trim(),
        performed_by: document.getElementById('nameplate-performed-by').value.trim(),
        notes: document.getElementById('nameplate-notes').value.trim()
    };
    
    if (!data.nameplate_sn || !data.installed_date) {
        alert('Please fill required fields: Nameplate S/N and Installed Date');
        return;
    }
    
    try {
        const method = id ? 'PUT' : 'POST';
        const url = id ? `/api/nameplate-tracker/${id}` : '/api/nameplate-tracker';
        
        const res = await fetch(url, {
            method: method,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        
        if (!res.ok) throw new Error('Save failed');
        
        bootstrap.Modal.getInstance(document.getElementById('nameplateTrackerModal')).hide();
        showSuccessNotification(id ? 'Record updated!' : 'Record added!');
        await loadNameplateTracker();
    } catch (err) {
        showErrorNotification('Error: ' + err.message);
    }
}

async function deleteNameplateTracker(id) {
    if (!confirm('Delete this record?')) return;
    
    try {
        const res = await fetch(`/api/nameplate-tracker/${id}`, { method: 'DELETE' });
        if (!res.ok) throw new Error('Delete failed');
        
        showSuccessNotification('Record deleted!');
        await loadNameplateTracker();
    } catch (err) {
        showErrorNotification('Error: ' + err.message);
    }
}

async function editNameplateTracker(id) {
    try {
        const res = await fetch(`/api/nameplate-tracker?nameplate_sn=&gss_id=`);
        if (!res.ok) throw new Error('Failed to load');
        const data = await res.json();
        const record = data.find(r => r.id === id);
        if (!record) throw new Error('Record not found');
        showNameplateTrackerForm(record);
    } catch (err) {
        showErrorNotification('Error: ' + err.message);
    }
}

// ========== CALENDAR FUNCTIONS ==========

let currentCalendarYear = new Date().getFullYear();
let currentCalendarMonth = new Date().getMonth() + 1; // 1-12
let allCalendarEvents = [];

// Auto-load calendar on page load
document.addEventListener('DOMContentLoaded', function() {
    loadCalendarMonth(currentCalendarYear, currentCalendarMonth);
});

function navigateMonth(direction) {
    currentCalendarMonth += direction;
    if (currentCalendarMonth > 12) {
        currentCalendarMonth = 1;
        currentCalendarYear++;
    } else if (currentCalendarMonth < 1) {
        currentCalendarMonth = 12;
        currentCalendarYear--;
    }
    loadCalendarMonth(currentCalendarYear, currentCalendarMonth);
}

async function loadCalendarMonth(year, month) {
    const container = document.getElementById('calendar-grid-container');
    const title = document.getElementById('calendar-month-year');
    
    // Update title
    const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 
                        'July', 'August', 'September', 'October', 'November', 'December'];
    if (title) {
        title.textContent = `${monthNames[month - 1]} ${year}`;
    }
    
    // Show loading
    if (container) {
        container.innerHTML = '<div class="text-center py-5"><div class="spinner-border text-primary"></div><p class="mt-2">Loading calendar...</p></div>';
    }
    
    try {
        // Fetch events for this month
        const res = await fetch(`/api/events/calendar/${year}/${month}`);
        if (!res.ok) throw new Error('Failed to load events');
        allCalendarEvents = await res.json();

        // Also pull boroscope schedules for this month and merge into calendar events
        const lastDay = new Date(year, month, 0).getDate();
        const dateFrom = `${year}-${String(month).padStart(2, '0')}-01`;
        const dateTo = `${year}-${String(month).padStart(2, '0')}-${String(lastDay).padStart(2, '0')}`;
        try {
            const boroRes = await fetch(`/api/boroscope/schedule?date_from=${dateFrom}&date_to=${dateTo}`);
            if (boroRes.ok) {
                const schedules = await boroRes.json();
                const mapped = schedules.map((s, idx) => ({
                    id: -(idx + 1), // synthetic id to avoid collision with real events
                    event_date: s.date,
                    event_time: '',
                    event_type: 'BOROSCOPE',
                    status: (s.status || '').toUpperCase(),
                    title: `Boroscope ${s.aircraft_tail_number} Pos ${s.position}`,
                    priority: 'Normal',
                    description: s.remarks || '',
                    serial_number: s.aircraft_tail_number,
                    location: s.location || '',
                    created_by: s.inspector || 'Inspector'
                }));
                allCalendarEvents = allCalendarEvents.concat(mapped);
            }
        } catch (boroErr) {
            console.warn('Failed to load boroscope schedules for calendar:', boroErr);
        }
        
        renderCalendar(year, month);
    } catch (err) {
        console.error('Error loading calendar:', err);
        if (container) {
            container.innerHTML = `<div class="alert alert-danger">Error loading calendar: ${err.message}</div>`;
        }
    }
}

function renderCalendar(year, month) {
    const container = document.getElementById('calendar-grid-container');
    if (!container) return;
    
    // Calculate calendar grid
    const firstDay = new Date(year, month - 1, 1);
    const lastDay = new Date(year, month, 0);
    const daysInMonth = lastDay.getDate();
    const startDayOfWeek = firstDay.getDay(); // 0 = Sunday
    
    // Previous month days
    const prevMonth = month === 1 ? 12 : month - 1;
    const prevMonthYear = month === 1 ? year - 1 : year;
    const daysInPrevMonth = new Date(prevMonthYear, prevMonth, 0).getDate();
    
    const today = new Date();
    today.setHours(0, 0, 0, 0); // Set to start of day for accurate comparison
    const todayStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
    
    // Build grid HTML
    let html = '<div class="calendar-grid">';
    
    // Header row (days of week)
    const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
    dayNames.forEach(name => {
        html += `<div class="calendar-header-cell">${name}</div>`;
    });
    
    // Previous month days (gray out)
    for (let i = startDayOfWeek - 1; i >= 0; i--) {
        const day = daysInPrevMonth - i;
        html += `<div class="calendar-day-cell other-month"><div class="calendar-day-number">${day}</div></div>`;
    }
    
    // Current month days
    for (let day = 1; day <= daysInMonth; day++) {
        const dateStr = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        const isToday = dateStr === todayStr;
        const dayEvents = allCalendarEvents.filter(e => e.event_date === dateStr);
        
        html += `<div class="calendar-day-cell ${isToday ? 'today' : ''}" onclick="openAddEventModal('${dateStr}')">`;
        html += `<div class="calendar-day-number">${day}</div>`;
        html += `<div class="calendar-events-list">`;
        
        dayEvents.forEach(event => {
            const eventType = event.event_type.toLowerCase();
            // Check if event is completed: COMPLETED status OR shipment with DELIVERED/CANCELLED status
            const isCompleted = event.status === 'COMPLETED' || event.status === 'DELIVERED' || event.status === 'CANCELLED';
            const completedClass = isCompleted ? ' event-completed' : '';

            const isSynthetic = event.id < 0; // Boroscope synthetic events shouldn't open edit modal
            
            // Calculate days until event (only for non-completed events)
            let urgencyClass = '';
            if (!isCompleted) {
                const eventDate = new Date(event.event_date);
                eventDate.setHours(0, 0, 0, 0);
                const daysUntil = Math.ceil((eventDate - today) / (1000 * 60 * 60 * 24));
                if (daysUntil === 1) urgencyClass = ' event-urgent-1day';
                else if (daysUntil === 2) urgencyClass = ' event-urgent-2days';
                else if (daysUntil < 0) urgencyClass = ' event-urgent-1day'; // Past event still urgent if not marked
            }
            
            const timeStr = event.event_time ? `<span class="calendar-event-time">${event.event_time}</span>` : '';
            const icon = isCompleted ? 'bi-check-circle-fill' : 'bi-circle-fill';
            const clickAttr = isSynthetic ? '' : ` onclick="event.stopPropagation(); openEditEventModal(${event.id})"`;
            html += `<div class="calendar-event-badge event-${eventType}${completedClass}${urgencyClass}"${clickAttr} onmouseenter="showEventTooltip(event, ${event.id})" onmouseleave="hideEventTooltip()">`;
            html += `<i class="bi ${icon}"></i>${timeStr} ${event.title}`;
            html += `</div>`;
        });
        
        html += `</div></div>`;
    }
    
    // Next month days (fill remaining cells)
    const totalCells = startDayOfWeek + daysInMonth;
    const remainingCells = 7 - (totalCells % 7);
    if (remainingCells < 7) {
        for (let day = 1; day <= remainingCells; day++) {
            html += `<div class="calendar-day-cell other-month"><div class="calendar-day-number">${day}</div></div>`;
        }
    }
    
    html += '</div>';
    container.innerHTML = html;
}

let eventTooltipTimeout;
function showEventTooltip(mouseEvent, eventId) {
    clearTimeout(eventTooltipTimeout);
    eventTooltipTimeout = setTimeout(() => {
        const event = allCalendarEvents.find(e => e.id === eventId);
        if (!event) return;
        
        // Remove existing tooltip
        const existing = document.querySelector('.event-tooltip');
        if (existing) existing.remove();
        
        // Create tooltip
        const tooltip = document.createElement('div');
        tooltip.className = 'event-tooltip';
        tooltip.innerHTML = `
            <strong>${event.title}</strong>
            <div><i class="bi bi-calendar3"></i> ${event.event_date} ${event.event_time || ''}</div>
            <div><i class="bi bi-tag"></i> ${event.event_type}</div>
            ${event.serial_number ? `<div><i class="bi bi-gear"></i> S/N: ${event.serial_number}</div>` : ''}
            ${event.location ? `<div><i class="bi bi-geo-alt"></i> ${event.location}</div>` : ''}
            ${event.description ? `<div style="margin-top: 4px;">${event.description}</div>` : ''}
            <div style="margin-top: 4px; font-size: 0.75rem; opacity: 0.8;">Created by: ${event.created_by || 'Unknown'}</div>
        `;
        
        document.body.appendChild(tooltip);
        
        // Position tooltip
        const rect = mouseEvent.target.getBoundingClientRect();
        tooltip.style.left = rect.left + 'px';
        tooltip.style.top = (rect.bottom + 5) + 'px';
    }, 300);
}

function hideEventTooltip() {
    clearTimeout(eventTooltipTimeout);
    const tooltip = document.querySelector('.event-tooltip');
    if (tooltip) tooltip.remove();
}

function openAddEventModal(dateStr = null) {
    const modal = new bootstrap.Modal(document.getElementById('event-modal'));
    const title = document.getElementById('event-modal-title');
    const deleteBtn = document.getElementById('event-delete-btn');
    const completeBtn = document.getElementById('event-complete-btn');
    
    // Reset form
    document.getElementById('event-form').reset();
    document.getElementById('event-id').value = '';
    
    // Auto-fill created_by from localStorage
    const currentUser = localStorage.getItem('currentUser') || 'User';
    document.getElementById('event-created-by').value = currentUser;
    
    if (dateStr) {
        document.getElementById('event-date').value = dateStr;
    } else {
        const today = new Date();
        document.getElementById('event-date').value = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
    }
    
    if (title) title.innerHTML = '<i class="bi bi-calendar-plus me-2"></i>Add New Event';
    if (deleteBtn) deleteBtn.style.display = 'none';
    if (completeBtn) completeBtn.style.display = 'none';
    
    modal.show();
}

async function openEditEventModal(eventId) {
    try {
        const res = await fetch(`/api/events/${eventId}`);
        if (!res.ok) throw new Error('Event not found');
        const event = await res.json();
        
        // Fill form
        document.getElementById('event-id').value = event.id;
        document.getElementById('event-date').value = event.event_date;
        document.getElementById('event-time').value = event.event_time || '';
        document.getElementById('event-type').value = event.event_type;
        document.getElementById('event-priority').value = event.priority;
        document.getElementById('event-title').value = event.title;
        document.getElementById('event-description').value = event.description || '';
        document.getElementById('event-serial').value = event.serial_number || '';
        document.getElementById('event-location').value = event.location || '';
        document.getElementById('event-from').value = event.from_location || '';
        document.getElementById('event-to').value = event.to_location || '';
        document.getElementById('event-status').value = event.status;
        document.getElementById('event-created-by').value = event.created_by || '';
        
        const modal = new bootstrap.Modal(document.getElementById('event-modal'));
        const title = document.getElementById('event-modal-title');
        const deleteBtn = document.getElementById('event-delete-btn');
        const completeBtn = document.getElementById('event-complete-btn');
        
        if (title) title.innerHTML = '<i class="bi bi-pencil me-2"></i>Edit Event';
        if (deleteBtn) deleteBtn.style.display = 'block';
        if (completeBtn) completeBtn.style.display = 'block';
        
        modal.show();
    } catch (err) {
        showErrorNotification('Error loading event: ' + err.message);
    }
}

async function saveEvent() {
    const eventId = document.getElementById('event-id').value;
    const formData = {
        event_date: document.getElementById('event-date').value,
        event_time: document.getElementById('event-time').value || null,
        event_type: document.getElementById('event-type').value,
        priority: document.getElementById('event-priority').value,
        title: document.getElementById('event-title').value,
        description: document.getElementById('event-description').value || null,
        serial_number: document.getElementById('event-serial').value || null,
        location: document.getElementById('event-location').value || null,
        from_location: document.getElementById('event-from').value || null,
        to_location: document.getElementById('event-to').value || null,
        status: document.getElementById('event-status').value,
        created_by: document.getElementById('event-created-by').value || 'User'
    };
    
    if (!formData.event_date || !formData.event_type || !formData.title) {
        showErrorNotification('Please fill in all required fields (Date, Type, Title)');
        return;
    }
    
    try {
        const isEdit = eventId && eventId !== '';
        const url = isEdit ? `/api/events/${eventId}` : '/api/events';
        const method = isEdit ? 'PUT' : 'POST';
        
        const res = await fetch(url, {
            method: method,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(formData)
        });
        
        if (!res.ok) {
            const error = await res.json();
            throw new Error(error.detail || 'Failed to save event');
        }
        
        showSuccessNotification(`✅ Event ${isEdit ? 'updated' : 'created'} successfully!`);
        
        // Close modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('event-modal'));
        if (modal) modal.hide();
        
        // Reload calendar
        await loadCalendarMonth(currentCalendarYear, currentCalendarMonth);
    } catch (err) {
        showErrorNotification('Error saving event: ' + err.message);
    }
}

async function deleteEvent() {
    const eventId = document.getElementById('event-id').value;
    if (!eventId) return;
    
    if (!confirm('Are you sure you want to delete this event? This action cannot be undone.')) {
        return;
    }
    
    try {
        // Get current user name from localStorage
        const currentUser = localStorage.getItem('currentUser') || 'User';
        
        const res = await fetch(`/api/events/${eventId}?deleted_by=${encodeURIComponent(currentUser)}`, {
            method: 'DELETE'
        });
        
        if (!res.ok) {
            const error = await res.json();
            throw new Error(error.detail || 'Failed to delete event');
        }
        
        showSuccessNotification('✅ Event deleted successfully!');
        
        // Close modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('event-modal'));
        if (modal) modal.hide();
        
        // Reload calendar
        await loadCalendarMonth(currentCalendarYear, currentCalendarMonth);
    } catch (err) {
        showErrorNotification('Error deleting event: ' + err.message);
    }
}

async function markEventCompleted() {
    const eventId = document.getElementById('event-id').value;
    if (!eventId) return;

    // Reuse form data to keep other fields untouched, only change status
    const formData = {
        event_date: document.getElementById('event-date').value,
        event_time: document.getElementById('event-time').value || null,
        event_type: document.getElementById('event-type').value,
        priority: document.getElementById('event-priority').value,
        title: document.getElementById('event-title').value,
        description: document.getElementById('event-description').value || null,
        serial_number: document.getElementById('event-serial').value || null,
        location: document.getElementById('event-location').value || null,
        from_location: document.getElementById('event-from').value || null,
        to_location: document.getElementById('event-to').value || null,
        status: 'COMPLETED',
        created_by: document.getElementById('event-created-by').value || 'User'
    };

    try {
        const res = await fetch(`/api/events/${eventId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(formData)
        });

        if (!res.ok) {
            const error = await res.json();
            throw new Error(error.detail || 'Failed to mark event completed');
        }

        showSuccessNotification('✅ Event marked as done');

        // Close modal and refresh calendar (completed events hidden)
        const modal = bootstrap.Modal.getInstance(document.getElementById('event-modal'));
        if (modal) modal.hide();
        await loadCalendarMonth(currentCalendarYear, currentCalendarMonth);
    } catch (err) {
        showErrorNotification('Error completing event: ' + err.message);
    }
}

// ========== USER NAME MANAGEMENT ==========

function saveCurrentUser(name) {
    if (name && name.trim()) {
        localStorage.setItem('currentUser', name.trim());
        console.log('✅ User name saved:', name.trim());
    }
}

function loadCurrentUserName() {
    const savedName = localStorage.getItem('currentUser');
    const input = document.getElementById('current-user-input');
    if (input) {
        input.value = savedName || 'admin';
        if (!savedName) {
            // Set default to admin
            localStorage.setItem('currentUser', 'admin');
        }
    }
}

// Load user name on page load
document.addEventListener('DOMContentLoaded', async function() {
    loadCurrentUserName();
    console.log('Page loaded, initializing...');
    
    // АВТОМАТИЧЕСКИ очищаем старые удаленные двигатели при загрузке
    try {
        const deletedIds = getDeletedEngineIds();
        if (deletedIds && deletedIds.length > 0) {
            console.log('Found', deletedIds.length, 'deleted engine IDs in storage:', deletedIds);
            console.log('Auto-clearing deleted engine IDs...');
            localStorage.removeItem('engine-deleted-ids');
            console.log('Deleted engine IDs cleared automatically');
        }
    } catch (e) {
        console.warn('Cannot clear deleted engine ids on init:', e);
    }
    
    // Load all data
    await updateDashboardStats();
    await loadSchedulesData();
    await loadCalendarMonth(currentCalendarYear, currentCalendarMonth);

    // When child modals close, reopen schedules modal with fresh data
    const engModalEl = document.getElementById('engineShipmentModal');
    if (engModalEl) {
        engModalEl.addEventListener('hidden.bs.modal', () => {
            reopenSchedulesAfterChild();
        });
    }
    const partsModalEl = document.getElementById('partsShipmentModal');
    if (partsModalEl) {
        partsModalEl.addEventListener('hidden.bs.modal', () => {
            reopenSchedulesAfterChild();
        });
    }
});


// ============================================================
// LOGISTICS & SCHEDULES FUNCTIONS
// ============================================================

const setTextIfExists = (id, value) => {
    const el = document.getElementById(id);
    if (el) el.textContent = value;
};

// Parse manual SN/PN hints stored in notes
function extractSnPn(notes) {
    if (!notes) return { sn: null, pn: null };
    const snMatch = notes.match(/Orig\s*SN:\s*([^\n]+)/i);
    const pnMatch = notes.match(/PN:\s*([^\n]+)/i);
    return {
        sn: snMatch ? snMatch[1].trim() : null,
        pn: pnMatch ? pnMatch[1].trim() : null
    };
}

function jumpCalendarToDate(isoDate) {
    if (!isoDate) return;
    const dt = new Date(isoDate);
    if (isNaN(dt.getTime())) return;
    currentCalendarYear = dt.getFullYear();
    currentCalendarMonth = dt.getMonth() + 1;
    loadCalendarMonth(currentCalendarYear, currentCalendarMonth);
}

// Update Dashboard Statistics
async function updateDashboardStats() {
    try {
        console.log('📊 Updating dashboard stats...');
        
        // Logistics & Movements
        const movementsRes = await fetch('/api/logistics/movements');
        if (!movementsRes.ok) {
            console.warn('⚠️ Movements fetch error:', movementsRes.status);
            throw new Error('Failed to fetch movements');
        }
        const movements = await movementsRes.json();
        console.log('🚚 Movements:', movements);
        setTextIfExists('engines-transit', movements.engines_transit || 0);
        setTextIfExists('parts-transit', movements.parts_transit || 0);
        setTextIfExists('location-changes', movements.location_changes || 0);
        
        // Boroscope Inspections
        await updateBoroscopeCard();
        
        // Schedule Status
        const statsRes = await fetch('/api/schedules/stats');
        if (!statsRes.ok) {
            console.warn('⚠️ Schedule stats fetch error:', statsRes.status);
            throw new Error('Failed to fetch stats');
        }
        const stats = await statsRes.json();
        console.log('📅 Schedule Stats:', stats);
        setTextIfExists('schedule-planned', stats.on_order || 0);
        setTextIfExists('schedule-transit', stats.in_transit || 0);
        setTextIfExists('schedule-arriving', stats.arriving_soon || 0);
        
        // Update Schedule Status card count (total active shipments)
        setTextIfExists('schedule-status-count', stats.total_active || 0);
        
        console.log('✅ Dashboard stats updated successfully');
    } catch (error) {
        console.error('❌ Failed to update dashboard stats:', error);
        // Set all to 0 on error (already done by setTextIfExists with || 0)
    }
}

// Schedule stats update is done manually after shipment actions (create/edit/delete)
// No auto-update interval needed

// Update Boroscope Card
async function updateBoroscopeCard() {
    try {
        const res = await fetch('/api/history/BORESCOPE' + noCache());
        if (!res.ok) {
            console.error('Failed to fetch boroscope data:', res.status);
            return;
        }
        const inspections = await res.json();
        
        console.log('Boroscope inspections loaded:', inspections.length);
        
        const count = inspections.length || 0;
        setTextIfExists('boroscope-count', count);
        
        if (inspections.length > 0) {
            // Sort by date descending to get the latest
            inspections.sort((a, b) => new Date(b.date) - new Date(a.date));
            const latest = inspections[0];
            const dateStr = latest.date ? new Date(latest.date).toLocaleDateString('ru-RU', { day: '2-digit', month: 'short' }) : 'Unknown';
            setTextIfExists('boroscope-last-date', `Last: ${dateStr}`);
        } else {
            setTextIfExists('boroscope-last-date', 'No inspections yet');
        }
    } catch (error) {
        console.error('Failed to load boroscope stats:', error);
    }
}

// Open Boroscope Modal
function openBoroscopeModal() {
    const modal = document.getElementById('boroscope-modal');
    if (!modal) {
        console.error('Boroscope modal not found');
        return;
    }
    modal.classList.add('active');
    loadBoroscopeModalData();
}

// Open GSS Registry View
function openGSSModal() {
    hideAllViews();
    document.getElementById('view-gss').style.display = 'block';
    updateHistory('gss');
    loadEnginesForGSSDropdown();
    loadGSSHistory();
    // Восстанавливаем сохраненный диапазон GSS с небольшой задержкой
    setTimeout(() => {
        restoreSavedGSSRange();
    }, 100);
}

// Close GSS Registry Modal
function closeGSSModal() {
    document.getElementById('view-gss').style.display = 'none';
    document.getElementById('dashboard-widgets').style.display = 'block';
    clearGSSForm();
}

// Close Boroscope Modal
function closeBoroscopeModal() {
    const modal = document.getElementById('boroscope-modal');
    if (modal) {
        modal.classList.remove('active');
    }
}

// Load Boroscope data into modal
async function loadBoroscopeModalData() {
    try {
        const res = await fetch('/api/history/BORESCOPE' + noCache());
        if (!res.ok) throw new Error('Failed to load boroscope data');
        const inspections = await res.json();
        
        console.log('Modal: Boroscope inspections loaded:', inspections.length);
        
        const tbody = document.getElementById('boroscope-modal-body');
        if (!tbody) return;
        
        tbody.innerHTML = '';
        
        if (inspections.length === 0) {
            tbody.innerHTML = '<tr><td colspan="9" class="text-center text-muted py-4">No inspections found</td></tr>';
            return;
        }
        
        // Sort by date descending
        inspections.sort((a, b) => new Date(b.date) - new Date(a.date));
        
        inspections.forEach(insp => {
            const date = insp.date ? new Date(insp.date).toLocaleDateString('ru-RU') : '-';
            const docLink = insp.link ? `<a href="${insp.link}" target="_blank" class="btn btn-sm btn-outline-primary" style="padding: 0.25rem 0.5rem;"><i class="bi bi-link-45deg"></i></a>` : '<span class="text-muted">-</span>';
            
            tbody.innerHTML += `
                <tr>
                    <td>${date}</td>
                    <td>${insp.aircraft || '-'}</td>
                    <td>${insp.serial_number || '-'}</td>
                    <td class="text-center">${insp.position || '-'}</td>
                    <td>${insp.work_type || '-'}</td>
                    <td>${insp.gss_id || '-'}</td>
                    <td>${insp.inspector || '-'}</td>
                    <td style="max-width: 250px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${insp.comment || ''}">${insp.comment || '-'}</td>
                    <td class="text-center">${docLink}</td>
                </tr>
            `;
        });
    } catch (error) {
        console.error('Failed to load boroscope modal data:', error);
        const tbody = document.getElementById('boroscope-modal-body');
        if (tbody) {
            tbody.innerHTML = '<tr><td colspan="9" class="text-center text-danger py-4">Error loading data</td></tr>';
        }
    }
}

// Open Schedules Modal
function openSchedulesModal() {
    const modal = document.getElementById('schedules-modal');
    modal.classList.add('active');
    switchSchedulesTab('shipments-table'); // Open on table tab by default
    loadSchedulesData();
}

// Close Schedules Modal
function closeSchedulesModal() {
    const modal = document.getElementById('schedules-modal');
    modal.classList.remove('active');
}

// Re-open schedules after child modal closes
function reopenSchedulesAfterChild() {
    openSchedulesModal();
    switchSchedulesTab('shipments-table');
    // These now have debug logging
    loadSchedulesData().then(() => {
        console.log('📦 Schedules table reloaded');
    });
    updateDashboardStats().then(() => {
        console.log('📊 Dashboard stats updated');
    });
}

// Switch between tabs in Schedules Modal
function switchSchedulesTab(tabName) {
    // Hide all tabs
    document.querySelectorAll('.tab-content-schedules').forEach(tab => {
        tab.classList.remove('active');
    });
    document.querySelectorAll('.schedules-tab').forEach(btn => {
        btn.classList.remove('active');
    });
    
    // Show selected tab
    if (tabName === 'type-selector') {
        document.getElementById('tab-type-selector').classList.add('active');
        document.querySelectorAll('.schedules-tab')[0].classList.add('active');
    } else if (tabName === 'shipments-table') {
        document.getElementById('tab-shipments-table').classList.add('active');
        document.querySelectorAll('.schedules-tab')[1].classList.add('active');
        loadSchedulesData();
    }
}

// Load Schedules Data (all shipments)
async function loadSchedulesData() {
    try {
        console.log('📦 Loading schedules data...');
        const res = await fetch('/api/schedules');
        if (!res.ok) throw new Error('Failed to fetch schedules');
        
        const shipments = await res.json();
        console.log('📦 Shipments loaded:', shipments);
        const tbody = document.getElementById('schedules-tbody');
        
        if (shipments.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="7" class="text-center text-muted py-4">
                        <i class="bi bi-inbox fs-3 d-block mb-2"></i>
                        No shipments found. Create your first shipment above.
                    </td>
                </tr>
            `;
            return;
        }
        
        tbody.innerHTML = shipments.map(s => {
            const expectedDate = s.expected_delivery_date ? new Date(s.expected_delivery_date).toLocaleDateString() : 'N/A';
            const { sn, pn } = extractSnPn(s.notes);
            const engineLabel = s.engine_id ? `Engine #${s.engine_id}` : 'Engine (manual)';
            const snPnLabel = [sn ? `SN ${sn}` : null, pn ? `PN ${pn}` : null].filter(Boolean).join(' / ');
            const engineInfo = snPnLabel ? `${engineLabel} [${snPnLabel}]` : engineLabel;
            const qtyInfo = s.shipment_type === 'PARTS' ? `${s.part_quantity}x ${s.part_name}` : engineInfo;
            
            return `
                <tr onclick="viewShipmentDetails(${s.id})">
                    <td>${s.id}</td>
                    <td>${s.shipment_type === 'ENGINE' ? '🛫 ENGINE' : '📦 PARTS'}</td>
                    <td><span class="status-badge status-${s.status}">${s.status}</span></td>
                    <td>${expectedDate}</td>
                    <td>${s.supplier_name || 'N/A'}</td>
                    <td>${qtyInfo}</td>
                    <td>
                        <div class="btn-group btn-group-sm" role="group">
                            <button class="btn btn-warning" title="Edit" onclick="event.stopPropagation(); openEditShipment(${s.id})">
                                <i class="bi bi-pencil-square"></i>
                            </button>
                            <button class="btn btn-outline-primary" title="Change status" onclick="event.stopPropagation(); openStatusModal(${s.id}, '${s.status}')">
                                <i class="bi bi-flag"></i>
                            </button>
                            <button class="btn btn-outline-danger" title="Delete" onclick="event.stopPropagation(); deleteShipment(${s.id})">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `;
        }).join('');
        
    } catch (error) {
        console.error('Failed to load schedules:', error);
        document.getElementById('schedules-tbody').innerHTML = `
            <tr>
                <td colspan="7" class="text-center text-danger py-4">
                    Failed to load shipments. Please try again.
                </td>
            </tr>
        `;
    }
}

// Create Engine Shipment
function createEngineShipment() {
    // Load engines into dropdown
    loadEnginesForShipment();
    // Ensure the schedules modal is hidden so engine modal stacks on top
    closeSchedulesModal();
    // Open modal
    const modal = new bootstrap.Modal(document.getElementById('engineShipmentModal'));
    modal.show();
}

// Load Engines for Shipment
async function loadEnginesForShipment() {
    try {
        console.log('🚀 Loading engines...');
        const res = await fetch('/api/engines');
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        
        const engines = await res.json();
        console.log('🚀 Engines loaded:', engines);
        
        const select = document.getElementById('engine-shipment-engine-id');
        if (!select) {
            console.error('❌ Select element not found');
            return;
        }
        
        if (!Array.isArray(engines)) {
            console.error('❌ Engines is not an array:', engines);
            select.innerHTML = '<option value="">-- No engines (error) --</option>';
            return;
        }
        
        select.innerHTML = '<option value="">-- Select Engine --</option>' + 
            engines.map(e => `<option value="${e.id}">${e.serial_number} (${e.model})</option>`).join('');
    } catch (error) {
        console.error('❌ Failed to load engines:', error);
        const select = document.getElementById('engine-shipment-engine-id');
        if (select) {
            select.innerHTML = '<option value="">-- Error loading engines --</option>';
        }
    }
}

// Submit Engine Shipment
async function submitEngineShipment() {
    try {
        const engineId = document.getElementById('engine-shipment-engine-id').value;
        const engineOrigSn = document.getElementById('engine-shipment-orig-sn').value;
        const enginePn = document.getElementById('engine-shipment-pn').value;
        const departure = document.getElementById('engine-shipment-departure').value;
        const expected = document.getElementById('engine-shipment-expected').value;
        const supplier = document.getElementById('engine-shipment-supplier').value;
        const destination = document.getElementById('engine-shipment-destination').value;
        const tracking = document.getElementById('engine-shipment-tracking').value;
        const notes = document.getElementById('engine-shipment-notes').value;
        
        if (!expected) {
            alert('Please fill in required fields (Expected Delivery)');
            return;
        }
        
        // Compose notes with manual SN/PN if provided
        let combinedNotes = notes || '';
        if (engineOrigSn) {
            combinedNotes += (combinedNotes ? '\n' : '') + `Orig SN: ${engineOrigSn}`;
        }
        if (enginePn) {
            combinedNotes += (combinedNotes ? '\n' : '') + `PN: ${enginePn}`;
        }

        const payload = {
            shipment_type: 'ENGINE',
            status: 'PLANNED',
            engine_id: engineId ? parseInt(engineId) : null,
            destination_location: destination,
            departure_date: departure || null,
            expected_delivery_date: expected,
            supplier_name: supplier,
            tracking_number: tracking,
            notes: combinedNotes,
            created_by: loadCurrentUserName()
        };
        
        const res = await fetch('/api/schedules', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });
        
        if (!res.ok) throw new Error('Failed to create shipment');
        
        showSuccessNotification('✓ Engine shipment created successfully');
        console.log('✅ Engine shipment created');
        
        // Close modal
        bootstrap.Modal.getInstance(document.getElementById('engineShipmentModal')).hide();
        
        // Reload and reopen
        await jumpCalendarToDate(expected);
        reopenSchedulesAfterChild();
        
        // Reset form
        document.getElementById('engine-shipment-form').reset();
        
    } catch (error) {
        console.error('Failed to create engine shipment:', error);
        showErrorNotification('Failed to create engine shipment: ' + error.message);
    }
}

// Create Parts Shipment
function createPartsShipment() {
    // Ensure the schedules modal is hidden so parts modal stacks on top
    closeSchedulesModal();
    // Open modal
    const modal = new bootstrap.Modal(document.getElementById('partsShipmentModal'));
    modal.show();
}

// Submit Parts Shipment
async function submitPartsShipment() {
    try {
        const partName = document.getElementById('parts-shipment-name').value;
        const quantity = document.getElementById('parts-shipment-quantity').value;
        const category = document.getElementById('parts-shipment-category').value;
        const departure = document.getElementById('parts-shipment-departure').value;
        const expected = document.getElementById('parts-shipment-expected').value;
        const supplier = document.getElementById('parts-shipment-supplier').value;
        const tracking = document.getElementById('parts-shipment-tracking').value;
        const notes = document.getElementById('parts-shipment-notes').value;
        
        if (!partName || !quantity || !expected) {
            alert('Please fill in required fields (Part Name, Quantity, Expected Delivery)');
            return;
        }
        
        const payload = {
            shipment_type: 'PARTS',
            status: 'PLANNED',
            part_name: partName,
            part_category: category,
            part_quantity: parseInt(quantity),
            reserved_quantity: parseInt(quantity),
            departure_date: departure || null,
            expected_delivery_date: expected,
            supplier_name: supplier,
            tracking_number: tracking,
            notes: notes,
            created_by: loadCurrentUserName()
        };
        
        const res = await fetch('/api/schedules', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });
        
        if (!res.ok) throw new Error('Failed to create shipment');
        
        showSuccessNotification(`✓ Parts shipment created: ${quantity}x ${partName}`);
        console.log('✅ Parts shipment created');
        
        // Close modal
        bootstrap.Modal.getInstance(document.getElementById('partsShipmentModal')).hide();
        
        // Reload and reopen
        await jumpCalendarToDate(expected);
        reopenSchedulesAfterChild();
        
        // Reset form
        document.getElementById('parts-shipment-form').reset();
        
    } catch (error) {
        console.error('Failed to create parts shipment:', error);
        showErrorNotification('Failed to create parts shipment: ' + error.message);
    }
}

let statusChangeTarget = null;
function openStatusModal(shipmentId, currentStatus) {
    statusChangeTarget = shipmentId;
    const currentEl = document.getElementById('status-current');
    const select = document.getElementById('status-new');
    if (currentEl) currentEl.textContent = `Current: ${currentStatus || 'N/A'}`;
    if (select) select.value = currentStatus || 'PLANNED';
    const modalEl = document.getElementById('statusChangeModal');
    if (modalEl) new bootstrap.Modal(modalEl).show();
}

async function applyStatusChange() {
    const select = document.getElementById('status-new');
    const newStatus = select ? select.value : null;
    if (!statusChangeTarget || !newStatus) return;

    const allowed = ['PLANNED', 'IN_TRANSIT', 'DELIVERED', 'DELAYED', 'CANCELLED'];
    if (!allowed.includes(newStatus)) {
        alert('Invalid status');
        return;
    }

    try {
        const payload = {
            status: newStatus,
            updated_by: loadCurrentUserName()
        };

        if (newStatus === 'DELIVERED') {
            payload.actual_delivery_date = new Date().toISOString();
        }

        const res = await fetch(`/api/schedules/${statusChangeTarget}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });

        if (!res.ok) throw new Error('Failed to update status');

        showSuccessNotification(`✓ Shipment #${statusChangeTarget} status updated to ${newStatus}`);
        console.log('✅ Status updated, refreshing dashboard...');
        
        await loadSchedulesData();
        await updateDashboardStats();
        await loadCalendarMonth(currentCalendarYear, currentCalendarMonth);

        const modalEl = document.getElementById('statusChangeModal');
        if (modalEl) bootstrap.Modal.getInstance(modalEl)?.hide();
    } catch (error) {
        console.error('Failed to change status:', error);
        showErrorNotification('Failed to change status: ' + error.message);
    } finally {
        statusChangeTarget = null;
    }
}

let editShipmentTarget = null;
async function openEditShipment(shipmentId) {
    editShipmentTarget = shipmentId;
    try {
        const res = await fetch(`/api/schedules/${shipmentId}`);
        if (!res.ok) throw new Error('Failed to load shipment');
        const item = await res.json();

        const expectedInput = document.getElementById('edit-expected');
        const departureInput = document.getElementById('edit-departure');
        const supplierInput = document.getElementById('edit-supplier');
        const trackingInput = document.getElementById('edit-tracking');
        const notesInput = document.getElementById('edit-notes');

        if (expectedInput) expectedInput.value = item.expected_delivery_date ? item.expected_delivery_date.slice(0, 16) : '';
        if (departureInput) departureInput.value = item.departure_date ? item.departure_date.slice(0, 16) : '';
        if (supplierInput) supplierInput.value = item.supplier_name || '';
        if (trackingInput) trackingInput.value = item.tracking_number || '';
        if (notesInput) notesInput.value = item.notes || '';

        const modalEl = document.getElementById('editShipmentModal');
        if (modalEl) new bootstrap.Modal(modalEl).show();
    } catch (error) {
        console.error('Failed to load shipment:', error);
        alert('Failed to load shipment');
        editShipmentTarget = null;
    }
}

async function submitShipmentEdit() {
    if (!editShipmentTarget) return;

    const payload = {
        expected_delivery_date: document.getElementById('edit-expected').value || null,
        departure_date: document.getElementById('edit-departure').value || null,
        supplier_name: document.getElementById('edit-supplier').value || null,
        tracking_number: document.getElementById('edit-tracking').value || null,
        notes: document.getElementById('edit-notes').value || null,
        updated_by: loadCurrentUserName()
    };

    try {
        const res = await fetch(`/api/schedules/${editShipmentTarget}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });

        if (!res.ok) throw new Error('Failed to update shipment');

        showSuccessNotification(`✓ Shipment #${editShipmentTarget} updated`);
        console.log('✅ Shipment updated, refreshing dashboard...');
        
        await loadSchedulesData();
        await updateDashboardStats();
        await loadCalendarMonth(currentCalendarYear, currentCalendarMonth);

        const modalEl = document.getElementById('editShipmentModal');
        if (modalEl) bootstrap.Modal.getInstance(modalEl)?.hide();
    } catch (error) {
        console.error('Failed to update shipment:', error);
        alert('Failed to update shipment');
    } finally {
        editShipmentTarget = null;
    }
}

// Delete Shipment
async function deleteShipment(shipmentId) {
    if (!confirm(`Delete Shipment #${shipmentId}?\n\nThis will also remove related calendar events.`)) {
        return;
    }
    
    try {
        const deletedBy = loadCurrentUserName();
        const res = await fetch(`/api/schedules/${shipmentId}?deleted_by=${deletedBy}`, {
            method: 'DELETE'
        });
        
        if (!res.ok) throw new Error('Failed to delete shipment');
        
        showSuccessNotification(`✓ Shipment #${shipmentId} deleted`);
        console.log('✅ Shipment deleted, refreshing dashboard...');
        
        // Reload data
        await loadSchedulesData();
        await updateDashboardStats();
        await loadCalendarMonth(currentCalendarYear, currentCalendarMonth);
        
    } catch (error) {
        console.error('Failed to delete shipment:', error);
        showErrorNotification('Failed to delete shipment: ' + error.message);
    }
}

// View Shipment Details (placeholder for future enhancement)
async function viewShipmentDetails(shipmentId) {
    try {
        const res = await fetch(`/api/schedules/${shipmentId}`);
        if (!res.ok) throw new Error('Failed to fetch shipment');
        
        const shipment = await res.json();
        
        let detailsHtml = `
            <h5>Shipment #${shipment.id} Details</h5>
            <p><strong>Type:</strong> ${shipment.shipment_type}</p>
            <p><strong>Status:</strong> <span class="status-badge status-${shipment.status}">${shipment.status}</span></p>
            <p><strong>Supplier:</strong> ${shipment.supplier_name || 'N/A'}</p>
            <p><strong>Expected Delivery:</strong> ${shipment.expected_delivery_date ? new Date(shipment.expected_delivery_date).toLocaleString() : 'N/A'}</p>
            <p><strong>Tracking:</strong> ${shipment.tracking_number || 'N/A'}</p>
            <p><strong>Notes:</strong> ${shipment.notes || 'None'}</p>
        `;
        
        if (shipment.shipment_type === 'PARTS') {
            detailsHtml += `
                <hr>
                <p><strong>Part Name:</strong> ${shipment.part_name}</p>
                <p><strong>Quantity:</strong> ${shipment.part_quantity}</p>
                <p><strong>Category:</strong> ${shipment.part_category}</p>
            `;
        }
        
        alert(detailsHtml.replace(/<[^>]*>/g, '\n')); // Simple alert (можно заменить на красивый modal)
        
    } catch (error) {
        console.error('Failed to load shipment details:', error);
        alert('Failed to load shipment details');
    }
}

// =========================================
// BOROSCOPE SCHEDULE MODAL FUNCTIONS
// =========================================

// Open Boroscope Schedule Modal
// Populate Location datalist with locations from dashboard
function populateBoroscopeLocationsList() {
    const datalist = document.getElementById('boroscope-location-list');
    if (!datalist) return;
    
    // Очищаем текущие опции
    datalist.innerHTML = '';
    
    // Используем глобальные locations если есть, иначе берем из API
    if (window.globalLocations && window.globalLocations.length > 0) {
        window.globalLocations.forEach(loc => {
            const option = document.createElement('option');
            option.value = loc.city;
            datalist.appendChild(option);
        });
    } else {
        // Fallback: если глобальные locations еще не загружены
        const defaultLocations = ['Shop', 'Hangar', 'Warehouse', 'Field'];
        defaultLocations.forEach(loc => {
            const option = document.createElement('option');
            option.value = loc;
            datalist.appendChild(option);
        });
    }
}

function openBoroscopeScheduleModal() {
    const modal = document.getElementById('boroscope-schedule-modal');
    modal.classList.add('active');
    loadBoroscopeAircraftList();
    populateBoroscopeLocationsList();
    // Reset form
    document.getElementById('boroscope-schedule-form').reset();
    document.getElementById('boroscope-form-message').style.display = 'none';
}

// Close Boroscope Schedule Modal
function closeBoroscopeScheduleModal() {
    const modal = document.getElementById('boroscope-schedule-modal');
    modal.classList.remove('active');
}

// Close on overlay click
document.addEventListener('DOMContentLoaded', function() {
    const boroscopeModal = document.getElementById('boroscope-schedule-modal');
    if (boroscopeModal) {
        const overlay = boroscopeModal.querySelector('.modal-overlay');
        if (overlay) {
            overlay.addEventListener('click', closeBoroscopeScheduleModal);
        }
    }
});

// Load aircraft list for dropdown
async function loadBoroscopeAircraftList() {
    try {
        const res = await fetch('/api/dashboard/aircraft-details');
        if (!res.ok) throw new Error('Failed to fetch aircraft');
        
        const aircrafts = await res.json();
        const select = document.getElementById('boroscope-aircraft');
        
        // Keep placeholder
        select.innerHTML = '<option value="">Select Aircraft...</option>';
        
        // Add aircraft options
        aircrafts.forEach(ac => {
            const option = document.createElement('option');
            option.value = ac.tail_number;
            option.textContent = `${ac.tail_number} (${ac.model || 'Unknown'})`;
            select.appendChild(option);
        });
    } catch (error) {
        console.error('Failed to load aircraft list:', error);
        showErrorNotification('Failed to load aircraft list');
    }
}

// Handle form submission
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('boroscope-schedule-form');
    if (form) {
        form.addEventListener('submit', async function(e) {
            e.preventDefault();
            await submitBoroscopeSchedule();
        });
    }
});

// Submit boroscope schedule
async function submitBoroscopeSchedule() {
    try {
        const date = document.getElementById('boroscope-date').value;
        const aircraft = document.getElementById('boroscope-aircraft').value;
        const position = document.getElementById('boroscope-position').value;
        const inspector = document.getElementById('boroscope-inspector').value;
        const location = document.getElementById('boroscope-location').value;
        const remarks = document.getElementById('boroscope-remarks').value;
        
        // Validation
        if (!date || !aircraft || !position || !inspector) {
            showErrorNotification('Please fill in all required fields');
            return;
        }
        
        const payload = {
            date: date,
            aircraft_tail_number: aircraft,
            position: parseInt(position),
            inspector: inspector,
            location: location || null,
            remarks: remarks || null
        };
        
        console.log('📅 Submitting boroscope schedule:', payload);
        
        const res = await fetch('/api/boroscope/schedule', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(payload)
        });
        
        const result = await res.json();
        
        if (!res.ok) {
            if (result.status === 'warning') {
                showWarningNotification(result.message || 'Boroscope already scheduled');
            } else {
                throw new Error(result.detail || 'Failed to schedule boroscope');
            }
            return;
        }
        
        // Success
        showSuccessNotification('✓ Boroscope inspection scheduled successfully!');
        closeBoroscopeScheduleModal();
        
        // Refresh relevant data
        await updateDashboardStats();
        loadBoroscopeScheduleList();
        await loadCalendarMonth(currentCalendarYear, currentCalendarMonth);
        
    } catch (error) {
        console.error('Error submitting boroscope schedule:', error);
        showErrorNotification('Failed to schedule inspection: ' + error.message);
    }
}

// Load boroscope schedules list (for display/calendar)
async function loadBoroscopeScheduleList(aircraft = null, dateFrom = null, dateTo = null) {
    try {
        let url = '/api/boroscope/schedule';
        const params = new URLSearchParams();
        
        if (aircraft) params.append('aircraft', aircraft);
        if (dateFrom) params.append('date_from', dateFrom);
        if (dateTo) params.append('date_to', dateTo);
        
        if (params.toString()) url += '?' + params.toString();
        
        const res = await fetch(url);
        if (!res.ok) throw new Error('Failed to fetch boroscope schedules');
        
        const schedules = await res.json();
        console.log('📅 Boroscope schedules loaded:', schedules);
        
        return schedules;
    } catch (error) {
        console.error('Failed to load boroscope schedules:', error);
        return [];
    }
}

// Get upcoming boroscope reminders
async function getBoroscopeReminders() {
    try {
        const res = await fetch('/api/boroscope/schedule/upcoming/reminders');
        if (!res.ok) throw new Error('Failed to fetch reminders');
        
        const reminders = await res.json();
        console.log('📅 Boroscope reminders:', reminders);
        
        return reminders;
    } catch (error) {
        console.error('Failed to get boroscope reminders:', error);
        return [];
    }
}

// Add boroscope reminders to notifications panel (once per day)
async function displayBoroscopeReminders() {
    try {
        const today = new Date().toDateString();
        const lastShown = localStorage.getItem('boroscope-reminder-date');
        
        if (lastShown === today) {
            return; // Already shown today
        }
        
        const reminders = await getBoroscopeReminders();
        
        if (reminders.length > 0) {
            // Add to notifications list
            const list = document.getElementById('notifications-list');
            const reminderHTML = reminders.map(r => `
                <div class="notification-item unread" style="border-left: 4px solid #17a2b8;">
                    <div class="d-flex justify-content-between">
                        <strong>📅 Boroscope</strong>
                        <span class="badge bg-info">reminder</span>
                    </div>
                    <div>${r.aircraft} Position ${r.position} - Inspector: ${r.inspector}</div>
                    <div class="notification-time">${r.reminder_type} • ${formatNotificationTime(new Date())}</div>
                </div>
            `).join('');
            
            if (list.textContent.includes('No notifications')) {
                list.innerHTML = reminderHTML;
            } else {
                list.insertAdjacentHTML('afterbegin', reminderHTML);
            }
            
            localStorage.setItem('boroscope-reminder-date', today);
            updateNotificationCount();
        }
    } catch (error) {
        console.error('Error displaying boroscope reminders:', error);
    }
}

</script>

<!-- ============================================================
     SCHEDULES MODAL (Logistics & Shipments Tracking)
     ============================================================ -->
<div id="schedules-modal">
    <div class="schedules-modal-content">
        <div class="schedules-modal-header">
            <h3>📦 Schedules - Logistics & Shipments Tracking</h3>
            <button class="btn-close-modal" onclick="closeSchedulesModal()">✕ Close</button>
        </div>

        <!-- Tabs -->
        <div class="schedules-tabs">
            <button class="schedules-tab active" onclick="switchSchedulesTab('type-selector')">
                Select Type
            </button>
            <button class="schedules-tab" onclick="switchSchedulesTab('shipments-table')">
                Shipments Table
            </button>
        </div>

        <!-- Tab 1: Type Selector -->
        <div id="tab-type-selector" class="tab-content-schedules active">
            <h4 class="mb-4">Select Shipment Type</h4>
            <div class="type-selector-container">
                <button class="btn-type-selector" onclick="createEngineShipment()">
                    <span class="icon">🛫</span>
                    <div class="text-container">
                        <span class="title">Engine</span>
                        <span class="subtitle">Track engines in transit to destinations</span>
                    </div>
                </button>
                
                <button class="btn-type-selector" onclick="createPartsShipment()">
                    <span class="icon">📦</span>
                    <div class="text-container">
                        <span class="title">Parts</span>
                        <span class="subtitle">Track parts shipments (including pre-orders)</span>
                    </div>
                </button>
                
                <button class="btn-type-selector" onclick="openBoroscopeScheduleModal()">
                    <span class="icon">📅</span>
                    <div class="text-container">
                        <span class="title">Boroscope Inspection</span>
                        <span class="subtitle">Schedule engine boroscope inspections</span>
                    </div>
                </button>
            </div>
        </div>

        <!-- Tab 2: Shipments Table -->
        <div id="tab-shipments-table" class="tab-content-schedules">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4 class="mb-0">All Shipments</h4>
                <button class="btn btn-primary" onclick="switchSchedulesTab('type-selector')">
                    + New Shipment
                </button>
            </div>

            <table id="schedules-table">
                <thead>
                    <tr>
                        <th style="width: 60px;">ID</th>
                        <th style="width: 100px;">Type</th>
                        <th style="width: 120px;">Status</th>
                        <th style="width: 140px;">Expected Delivery</th>
                        <th>Supplier</th>
                        <th>Qty/SN</th>
                        <th style="width: 140px;">Actions</th>
                    </tr>
                </thead>
                <tbody id="schedules-tbody">
                    <tr>
                        <td colspan="7" class="text-center text-muted py-4">
                            <i class="bi bi-inbox fs-3 d-block mb-2"></i>
                            No shipments found. Create your first shipment above.
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- BOROSCOPE SCHEDULE MODAL -->
<div id="boroscope-schedule-modal" class="custom-modal">
    <div class="modal-overlay" onclick="closeBoroscopeScheduleModal()"></div>
    <div class="boroscope-modal-content">
        <div class="boroscope-modal-header">
            <h3>📅 Schedule Boroscope Inspection</h3>
            <button class="btn-close-modal" onclick="closeBoroscopeScheduleModal()">✕ Close</button>
        </div>

        <form id="boroscope-schedule-form" class="p-4">
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label">Date <span class="text-danger">*</span></label>
                    <input type="date" class="form-control" id="boroscope-date" required>
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label">Aircraft <span class="text-danger">*</span></label>
                    <select class="form-select" id="boroscope-aircraft" required>
                        <option value="">Select Aircraft...</option>
                    </select>
                </div>
            </div>

            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label">Position <span class="text-danger">*</span></label>
                    <select class="form-select" id="boroscope-position" required>
                        <option value="">Select Position...</option>
                        <option value="1">Position 1</option>
                        <option value="2">Position 2</option>
                        <option value="3">Position 3</option>
                        <option value="4">Position 4</option>
                    </select>
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label">Inspector <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" id="boroscope-inspector" placeholder="Inspector name" required>
                </div>
            </div>

            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label">Location</label>
                    <input type="text" class="form-control" id="boroscope-location" placeholder="Select or enter location" list="boroscope-location-list">
                    <datalist id="boroscope-location-list">
                        <option value="Shop"></option>
                        <option value="Hangar"></option>
                        <option value="Warehouse"></option>
                        <option value="Field"></option>
                    </datalist>
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label">Remarks</label>
                    <textarea class="form-control" id="boroscope-remarks" rows="2" placeholder="Additional notes..."></textarea>
                </div>
            </div>

            <div class="d-flex gap-2 justify-content-end mt-4">
                <button type="button" class="btn btn-secondary" onclick="closeBoroscopeScheduleModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Schedule Inspection</button>
            </div>
        </form>

        <!-- Status message -->
        <div id="boroscope-form-message" class="alert alert-info m-4" style="display: none;"></div>
    </div>
</div>

<!-- ENGINE SHIPMENT MODAL (Two-step) -->
<div class="modal fade" id="engineShipmentModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">🛫 Create Engine Shipment</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="engine-shipment-form">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Select Engine (optional)</label>
                            <select class="form-select" id="engine-shipment-engine-id">
                                <option value="">Manual entry</option>
                            </select>
                            <small class="text-muted">Можно выбрать существующий или заполнить вручную ниже</small>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Orig SN (manual)</label>
                            <input type="text" class="form-control" id="engine-shipment-orig-sn" placeholder="Enter Original SN">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">PN (manual)</label>
                            <input type="text" class="form-control" id="engine-shipment-pn" placeholder="Enter PN">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Destination Location</label>
                            <input type="text" class="form-control" id="engine-shipment-destination" placeholder="Warehouse / Hangar">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Departure Date</label>
                            <input type="datetime-local" class="form-control" id="engine-shipment-departure">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Expected Delivery <span class="text-danger">*</span></label>
                            <input type="datetime-local" class="form-control" id="engine-shipment-expected" required>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Supplier Name</label>
                            <input type="text" class="form-control" id="engine-shipment-supplier">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Tracking Number</label>
                            <input type="text" class="form-control" id="engine-shipment-tracking">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Notes</label>
                        <textarea class="form-control" id="engine-shipment-notes" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="submitEngineShipment()">Create Shipment</button>
            </div>
        </div>
    </div>
</div>

<!-- PARTS SHIPMENT MODAL (Two-step) -->
<div class="modal fade" id="partsShipmentModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">📦 Create Parts Shipment</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="parts-shipment-form">
                    <div class="row">
                        <div class="col-md-8 mb-3">
                            <label class="form-label">Part Name <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="parts-shipment-name" required>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Quantity <span class="text-danger">*</span></label>
                            <input type="number" class="form-control" id="parts-shipment-quantity" required min="1">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Category (purpose)</label>
                        <select class="form-select" id="parts-shipment-category">
                            <option value="Aircraft">Aircraft</option>
                            <option value="Engine">Engine</option>
                            <option value="Office">Office</option>
                        </select>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Departure Date</label>
                            <input type="datetime-local" class="form-control" id="parts-shipment-departure">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Expected Delivery <span class="text-danger">*</span></label>
                            <input type="datetime-local" class="form-control" id="parts-shipment-expected" required>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Supplier Name</label>
                            <input type="text" class="form-control" id="parts-shipment-supplier">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Tracking Number</label>
                            <input type="text" class="form-control" id="parts-shipment-tracking">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Notes</label>
                        <textarea class="form-control" id="parts-shipment-notes" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="submitPartsShipment()">Create Shipment</button>
            </div>
        </div>
    </div>
</div>

    <!-- STATUS CHANGE MODAL -->
    <div class="modal fade" id="statusChangeModal" tabindex="-1">
        <div class="modal-dialog modal-sm modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h6 class="modal-title">Change Status</h6>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-2 small text-muted" id="status-current"></div>
                    <select class="form-select" id="status-new">
                        <option value="PLANNED">PLANNED</option>
                        <option value="IN_TRANSIT">IN_TRANSIT</option>
                        <option value="DELIVERED">DELIVERED</option>
                        <option value="DELAYED">DELAYED</option>
                        <option value="CANCELLED">CANCELLED</option>
                    </select>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary btn-sm" onclick="applyStatusChange()">Update</button>
                </div>
            </div>
        </div>
    </div>

    <!-- EDIT SHIPMENT MODAL -->
    <div class="modal fade" id="editShipmentModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h6 class="modal-title">Edit Shipment</h6>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="edit-shipment-form">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Expected Delivery</label>
                                <input type="datetime-local" class="form-control" id="edit-expected">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Departure</label>
                                <input type="datetime-local" class="form-control" id="edit-departure">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Supplier</label>
                                <input type="text" class="form-control" id="edit-supplier">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Tracking</label>
                                <input type="text" class="form-control" id="edit-tracking">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Notes</label>
                            <textarea class="form-control" id="edit-notes" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-warning btn-sm" onclick="submitShipmentEdit()">Save</button>
                </div>
            </div>
        </div>
    </div>

    <!-- DEBUG UTILITIES - ACCESSIBLE FROM BROWSER CONSOLE -->
    <script>
        // Make cleanup functions globally accessible
        window.engineTools = {
            clearCache: function() {
                try {
                    localStorage.removeItem('engine-deleted-ids');
                    console.log('Engine cache cleared!');
                    // Reload engines if view is open
                    if (typeof loadMainTable === 'function') {
                        loadMainTable();
                        console.log('Engine table reloaded');
                    }
                    return 'Cache cleared and table reloaded';
                } catch (e) {
                    console.error('Error:', e);
                    return 'Error: ' + e.message;
                }
            },
            showCache: function() {
                try {
                    const deleted = localStorage.getItem('engine-deleted-ids');
                    console.log('Cached deleted IDs:', deleted ? JSON.parse(deleted) : []);
                    return deleted ? JSON.parse(deleted) : [];
                } catch (e) {
                    console.error('Error:', e);
                    return 'Error: ' + e.message;
                }
            }
        };
        
        // Shorter alias
        window.etc = window.engineTools;
        
        console.log('Engine Tools Available!');
        console.log('Usage: etc.clearCache() or etc.showCache()');
    </script>

    <script>
        // Condition Statuses Management
        window.conditionStatuses = [];

        async function loadConditionStatuses() {
            try {
                const res = await fetch('/api/condition-statuses');
                if (!res.ok) throw new Error('Failed to load condition statuses');
                window.conditionStatuses = await res.json();
                
                // Update select dropdown
                const select = document.getElementById('store-condition');
                if (select) {
                    select.innerHTML = '<option value="">-- Select --</option>';
                    window.conditionStatuses.forEach(status => {
                        const opt = document.createElement('option');
                        opt.value = status.name;
                        opt.textContent = status.name;
                        opt.style.backgroundColor = status.color;
                        opt.style.color = 'white';
                        opt.dataset.statusId = status.id;
                        select.appendChild(opt);
                    });
                }
                
                // Update status list in modal
                updateConditionStatusList();
            } catch (error) {
                console.error('Error loading condition statuses:', error);
            }
        }

        function updateConditionStatusList() {
            const listContainer = document.getElementById('condition-status-list');
            if (!listContainer) return;
            
            listContainer.innerHTML = '';
            
            if (window.conditionStatuses.length === 0) {
                listContainer.innerHTML = '<div class="text-muted small">No statuses yet</div>';
                return;
            }
            
            window.conditionStatuses.forEach(status => {
                const item = document.createElement('div');
                item.className = 'd-flex align-items-center justify-content-between mb-2 p-2 border rounded';
                item.innerHTML = `
                    <span class="d-flex align-items-center gap-2">
                        <span style="width: 20px; height: 20px; background-color: ${status.color}; border-radius: 3px; display: inline-block;"></span>
                        <span>${status.name}</span>
                    </span>
                    <button type="button" class="btn btn-sm btn-danger" onclick="deleteConditionStatus(${status.id})" style="padding: 2px 6px; font-size: 0.75rem;">
                        <i class="bi bi-x-lg"></i>
                    </button>
                `;
                listContainer.appendChild(item);
            });
        }

        async function deleteConditionStatus(statusId) {
            if (!confirm('Delete this status?')) return;
            
            try {
                const res = await fetch(`/api/condition-statuses/${statusId}`, {
                    method: 'DELETE'
                });
                
                const data = await res.json();
                
                if (data.status === 'error') {
                    showErrorNotification(data.message || 'Failed to delete status');
                    return;
                }
                
                showSuccessNotification('Status deleted successfully!');
                await loadConditionStatuses();
            } catch (error) {
                console.error('Error deleting condition status:', error);
                showErrorNotification('Failed to delete status');
            }
        }

        function openAddConditionModal() {
            const modal = new bootstrap.Modal(document.getElementById('addConditionModal'));
            document.getElementById('new-condition-name').value = '';
            document.getElementById('new-condition-color').value = '#28a745';
            
            updateConditionStatusList();
            modal.show();
        }

        async function saveConditionStatus() {
            const name = document.getElementById('new-condition-name').value.trim();
            const color = document.getElementById('new-condition-color').value;
            
            if (!name) {
                showErrorNotification('Please enter status name');
                return;
            }
            
            try {
                const res = await fetch('/api/condition-statuses', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({name, color})
                });
                
                const data = await res.json();
                
                if (data.status === 'error') {
                    showErrorNotification(data.message || 'Failed to add status');
                    return;
                }
                
                showSuccessNotification(`Status "${name}" added successfully!`);
                document.getElementById('new-condition-name').value = '';
                document.getElementById('new-condition-color').value = '#28a745';
                await loadConditionStatuses();
            } catch (error) {
                console.error('Error saving condition status:', error);
                showErrorNotification('Failed to save status');
            }
        }

        // === WORK TYPES MANAGEMENT ===
        window.workTypes = [];

        async function loadWorkTypes() {
            try {
                const res = await fetch('/api/work-types' + noCache());
                if (!res.ok) throw new Error('Failed to fetch work types');
                
                const data = await res.json();
                window.workTypes = data;
                
                // Update select in Borescope form
                const select = document.getElementById('bore-work-type');
                if (select) {
                    const currentValue = select.value;
                    select.innerHTML = '<option value="">-- Select --</option>';
                    window.workTypes.forEach(wt => {
                        const opt = document.createElement('option');
                        opt.value = wt.name;
                        opt.textContent = wt.name;
                        opt.dataset.workTypeId = wt.id;
                        select.appendChild(opt);
                    });
                    if (currentValue) select.value = currentValue;
                }
                
                // Update work type list in modal
                updateWorkTypeList();
            } catch (error) {
                console.error('Error loading work types:', error);
            }
        }

        function updateWorkTypeList() {
            const listContainer = document.getElementById('work-type-list');
            if (!listContainer) return;
            
            listContainer.innerHTML = '';
            
            if (window.workTypes.length === 0) {
                listContainer.innerHTML = '<div class="text-muted small">No work types yet. Add HPT, LPT, NGV, CC, etc.</div>';
                return;
            }
            
            window.workTypes.forEach(wt => {
                const item = document.createElement('div');
                item.className = 'd-flex align-items-center justify-content-between mb-2 p-2 border rounded';
                item.innerHTML = `
                    <span>${wt.name}</span>
                    <button type="button" class="btn btn-sm btn-danger" onclick="deleteWorkType(${wt.id})" style="padding: 2px 6px; font-size: 0.75rem;">
                        <i class="bi bi-x-lg"></i>
                    </button>
                `;
                listContainer.appendChild(item);
            });
        }

        async function deleteWorkType(workTypeId) {
            if (!confirm('Delete this work type?')) return;
            
            try {
                const res = await fetch(`/api/work-types/${workTypeId}`, {
                    method: 'DELETE'
                });
                
                const data = await res.json();
                
                if (data.status === 'error') {
                    showErrorNotification(data.message || 'Failed to delete work type');
                    return;
                }
                
                showSuccessNotification('Work type deleted successfully!');
                await loadWorkTypes();
            } catch (error) {
                console.error('Error deleting work type:', error);
                showErrorNotification('Failed to delete work type');
            }
        }

        function openAddWorkTypeModal() {
            const modal = new bootstrap.Modal(document.getElementById('addWorkTypeModal'));
            document.getElementById('new-work-type-name').value = '';
            
            updateWorkTypeList();
            modal.show();
        }

        async function saveWorkType() {
            const name = document.getElementById('new-work-type-name').value.trim();
            
            if (!name) {
                showErrorNotification('Please enter work type name');
                return;
            }
            
            try {
                const res = await fetch('/api/work-types', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({name})
                });
                
                const data = await res.json();
                
                if (data.status === 'error') {
                    showErrorNotification(data.message || 'Failed to add work type');
                    return;
                }
                
                showSuccessNotification(`Work type "${name}" added successfully!`);
                
                // Close modal and reload
                await loadWorkTypes();
                document.getElementById('new-work-type-name').value = '';
                bootstrap.Modal.getInstance(document.getElementById('addWorkTypeModal')).hide();
            } catch (error) {
                console.error('Error adding work type:', error);
                showErrorNotification('Failed to add work type');
            }
        }

        // Load statuses on page load
        document.addEventListener('DOMContentLoaded', () => {
            loadConditionStatuses();
            loadWorkTypes();
        });
    </script>

    <script>
        // ============================================
        // GSS REGISTRY FUNCTIONS (GLOBAL SCOPE)
        // ============================================
        let selectedGSSID = null;
        let gssRangeData = [];
        let showAssigned = false;
        const MAX_GSS_RANGE = 30;

        function toggleShowAssigned() {
            showAssigned = document.getElementById('show-assigned-toggle').checked;
            if (gssRangeData.length > 0) {
                generateGSSRange();
            }
        }

        async function generateGSSRange() {
            const from = parseInt(document.getElementById('gss-from').value);
            const to = parseInt(document.getElementById('gss-to').value);

            if (isNaN(from) || isNaN(to)) {
                alert('Please enter valid numbers');
                return;
            }

            if (from > to) {
                alert('Invalid range: FROM must be less than TO');
                return;
            }

            const rangeSize = to - from + 1;
            if (rangeSize > MAX_GSS_RANGE) {
                alert(`Range too large! Maximum ${MAX_GSS_RANGE} numbers at once`);
                return;
            }

            try {
                const response = await fetch(`/api/gss/range?from_id=${from}&to_id=${to}&show_assigned=${showAssigned}&_t=${Date.now()}`);

                if (!response.ok) throw new Error('Failed to fetch GSS range');

                gssRangeData = await response.json();
                
                // Сохраняем диапазон в localStorage
                localStorage.setItem('gss_range_from', from.toString());
                localStorage.setItem('gss_range_to', to.toString());
                
                renderGSSGrid(gssRangeData);
            } catch (error) {
                console.error('Error fetching GSS range:', error);
                alert('Failed to load GSS range');
            }
        }

        // Функция для восстановления сохраненного диапазона
        function restoreSavedGSSRange() {
            const savedFrom = localStorage.getItem('gss_range_from');
            const savedTo = localStorage.getItem('gss_range_to');
            
            const fromInput = document.getElementById('gss-from');
            const toInput = document.getElementById('gss-to');
            
            if (savedFrom && savedTo && fromInput && toInput) {
                fromInput.value = savedFrom;
                toInput.value = savedTo;
                // Автоматически генерируем сохраненный диапазон
                console.log('Restoring GSS range:', savedFrom, '-', savedTo);
                generateGSSRange();
            } else {
                console.log('No saved GSS range found or elements not ready');
            }
        }

        function renderGSSGrid(data) {
            const container = document.getElementById('gss-grid-container');
            container.innerHTML = '';

            if (data.length === 0) {
                container.innerHTML = '<div class="text-center text-muted w-100"><i class="fas fa-check-circle fa-2x mb-2"></i><p>All GSS IDs in this range are assigned!</p></div>';
                return;
            }

            data.forEach(item => {
                const button = document.createElement('button');
                button.textContent = item.gss_id;
                button.className = 'gss-button';
                button.dataset.gssId = item.gss_id;

                if (item.is_assigned) {
                    button.classList.add('assigned');
                    const info = item.engine_info;
                    button.title = `Assigned to:\nOriginal SN: ${info?.original_sn || 'N/A'}\nCurrent SN: ${info?.current_sn || 'Same'}\nModel: ${info?.model || 'N/A'}\nBy: ${info?.assigned_by || 'Unknown'}`;
                    button.disabled = true;
                } else {
                    button.classList.add('available');
                    button.onclick = () => selectGSSID(item.gss_id, button);
                }

                container.appendChild(button);
            });
        }

        function selectGSSID(gssId, buttonElement) {
            selectedGSSID = gssId;

            document.querySelectorAll('.gss-button').forEach(btn => {
                btn.classList.remove('selected');
            });

            buttonElement.classList.add('selected');
            document.getElementById('selected-gss-number').textContent = gssId;

            buttonElement.style.animation = 'pulse 0.5s';
            setTimeout(() => { buttonElement.style.animation = ''; }, 500);
        }

        async function loadEnginesForGSSDropdown() {
            try {
                const response = await fetch('/api/engines');
                const engines = await response.json();

                // Сохраняем engines глобально для использования в onchange
                window.gssEngines = engines;

                const originalSelect = document.getElementById('gss-original-sn');
                const currentSelect = document.getElementById('gss-current-sn');
                const editCurrentSelect = document.getElementById('edit-current-sn');

                originalSelect.innerHTML = '<option value="">-- Select Engine --</option>';
                currentSelect.innerHTML = '<option value="">-- Same as Original --</option>';
                editCurrentSelect.innerHTML = '<option value="">-- Same as Original --</option>';

                engines.forEach(eng => {
                    // Original SN dropdown показывает original_sn
                    const option1 = new Option(`${eng.original_sn} (${eng.model || 'Unknown'})`, eng.id);
                    
                    // Current SN dropdown показывает current_sn (или original_sn если пусто)
                    const currentSnDisplay = (eng.current_sn && eng.current_sn !== '-') ? eng.current_sn : eng.original_sn;
                    const option2 = new Option(`${currentSnDisplay} (${eng.model || 'Unknown'})`, eng.id);
                    const option3 = new Option(`${currentSnDisplay} (${eng.model || 'Unknown'})`, eng.id);

                    originalSelect.add(option1);
                    currentSelect.add(option2);
                    editCurrentSelect.add(option3);
                });

                // Auto-select current SN when original SN is selected
                // Current SN dropdown показывает current_sn выбранного двигателя как текст
                originalSelect.onchange = function() {
                    const selectedEngineId = this.value;
                    if (selectedEngineId && window.gssEngines) {
                        const engine = window.gssEngines.find(e => e.id == selectedEngineId);
                        if (engine && engine.current_sn && engine.current_sn !== '-') {
                            // Просто показываем current_sn в текстовом виде
                            // Current SN dropdown тоже указывает на тот же двигатель
                            currentSelect.value = selectedEngineId;
                        } else {
                            // Если current_sn пустой или "-", оставляем "Same as Original"
                            currentSelect.value = '';
                        }
                    } else {
                        currentSelect.value = '';
                    }
                };
            } catch (error) {
                console.error('Error loading engines:', error);
            }
        }

        function showPhotoOption(type) {
            const uploadDiv = document.getElementById('photo-upload-option');
            const urlDiv = document.getElementById('photo-url-option');

            if (type === 'upload') {
                uploadDiv.style.display = 'block';
                urlDiv.style.display = 'none';
                document.getElementById('gss-photo-url').value = '';
            } else {
                uploadDiv.style.display = 'none';
                urlDiv.style.display = 'block';
                document.getElementById('gss-photo-file').value = '';
            }

            document.getElementById('photo-preview').style.display = 'none';
        }

        function previewPhoto() {
            const file = document.getElementById('gss-photo-file').files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const preview = document.getElementById('photo-preview');
                const img = document.getElementById('photo-preview-img');
                img.src = e.target.result;
                preview.style.display = 'block';
            };
            reader.readAsDataURL(file);
        }

        function previewPhotoURL() {
            const url = document.getElementById('gss-photo-url').value;
            if (!url) return;

            const preview = document.getElementById('photo-preview');
            const img = document.getElementById('photo-preview-img');
            img.src = url;
            preview.style.display = 'block';

            img.onerror = function() {
                alert('Invalid image URL');
                preview.style.display = 'none';
            };
        }

        async function assignGSSID() {
            if (!selectedGSSID) {
                alert('Please select a GSS ID first!');
                return;
            }

            const engineId = document.getElementById('gss-original-sn').value;
            if (!engineId) {
                alert('Please select Original SN!');
                return;
            }

            // Получаем реальный current_sn из данных двигателя
            const selectedEngine = window.gssEngines.find(e => e.id == engineId);
            const actualCurrentSn = selectedEngine ? (selectedEngine.current_sn !== '-' ? selectedEngine.current_sn : null) : null;

            const remarks = document.getElementById('gss-remarks').value;
            const photoUrl = document.getElementById('gss-photo-url').value;
            const photoFile = document.getElementById('gss-photo-file').files[0];

            try {
                const userId = sessionStorage.getItem('user_id') || 1;
                const assignData = {
                    gss_id: selectedGSSID,
                    engine_id: parseInt(engineId),
                    current_sn: actualCurrentSn,
                    photo_url: photoUrl || null,
                    remarks: remarks || null
                };

                const response = await fetch(`/api/gss/assign?user_id=${userId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(assignData)
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Failed to assign GSS ID');
                }

                if (photoFile) {
                    const formData = new FormData();
                    formData.append('file', photoFile);

                    await fetch(`/api/gss/upload-photo/${selectedGSSID}`, {
                        method: 'POST',
                        body: formData
                    });
                }

                showSuccessNotification(`GSS ID ${selectedGSSID} successfully assigned!`);
                clearGSSForm();
                generateGSSRange();
                loadGSSHistory();
            } catch (error) {
                console.error('Error assigning GSS ID:', error);
                showErrorNotification(`Error: ${error.message}`);
            }
        }

        async function loadGSSHistory() {
            try {
                const response = await fetch('/api/gss/history');

                if (!response.ok) throw new Error('Failed to load GSS history');

                const history = await response.json();
                renderGSSHistoryTable(history);
            } catch (error) {
                console.error('Error loading GSS history:', error);
            }
        }

        function renderGSSHistoryTable(data) {
            const tbody = document.getElementById('gss-history-tbody');
            
            if (!tbody) {
                console.error('GSS tbody element not found!');
                return;
            }
            
            // ПРИНУДИТЕЛЬНО перемещаем tbody после thead
            const table = tbody.closest('table');
            const thead = table?.querySelector('thead');
            if (table && thead) {
                // Удаляем tbody из текущего места
                tbody.remove();
                // Вставляем его после thead
                thead.after(tbody);
                console.log('tbody moved after thead');
            }
            
            // Полная очистка tbody
            tbody.innerHTML = '';
            
            if (!data || data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="10" class="text-center text-muted"><i class="fas fa-inbox fa-2x mb-2"></i><p>No GSS assignments yet</p></td></tr>';
                return;
            }

            // Сортируем данные по дате (новые сначала)
            const sortedData = [...data].sort((a, b) => {
                const dateA = new Date(a.assigned_date || 0);
                const dateB = new Date(b.assigned_date || 0);
                return dateB - dateA;
            });

            // Формируем HTML строк
            let rowsHTML = '';
            sortedData.forEach(item => {
                let photoHtml = '-';
                if (item.photo_filename) {
                    photoHtml = `<img src="/uploads/gss_photos/${item.photo_filename}" class="gss-photo-thumb" onclick="viewPhoto('/uploads/gss_photos/${item.photo_filename}')" alt="GSS Photo">`;
                } else if (item.photo_url) {
                    photoHtml = `<img src="${item.photo_url}" class="gss-photo-thumb" onclick="viewPhoto('${item.photo_url}')" alt="GSS Photo">`;
                }

                let remarksHtml = '-';
                if (item.remarks) {
                    remarksHtml = `<i class="fas fa-eye remarks-btn" onclick="viewRemarks(${item.gss_id}, \`${item.remarks.replace(/`/g, '\\`')}\`)" title="View remarks"></i>`;
                }

                rowsHTML += `
                    <tr>
                        <td><strong class="badge bg-primary">${item.gss_id}</strong></td>
                        <td>${photoHtml}</td>
                        <td>${item.original_sn}</td>
                        <td>${item.current_sn || '-'}</td>
                        <td>${item.engine_model || '-'}</td>
                        <td>${item.engine_location || '-'}</td>
                        <td>${item.assigned_by_name}</td>
                        <td>${new Date(item.assigned_date).toLocaleDateString()}</td>
                        <td class="text-center">${remarksHtml}</td>
                        <td>
                            <button class="btn btn-sm btn-warning me-1" onclick="editGSS(${item.gss_id})">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deleteGSS(${item.gss_id})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });

            tbody.innerHTML = rowsHTML;
            console.log('Rendered', sortedData.length, 'rows in GSS history, tbody parent:', tbody.parentElement?.tagName);
        }

        function viewPhoto(photoUrl) {
            const modal = new bootstrap.Modal(document.getElementById('photoViewModal'));
            document.getElementById('modal-photo-img').src = photoUrl;
            modal.show();
        }

        function viewRemarks(gssId, remarks) {
            const modal = new bootstrap.Modal(document.getElementById('remarksViewModal'));
            document.getElementById('remarks-gss-id').textContent = gssId;
            document.getElementById('remarks-content').textContent = remarks;
            modal.show();
        }

        async function editGSS(gssId) {
            try {
                const response = await fetch(`/api/gss/history?gss_id=${gssId}`);

                const data = await response.json();
                if (data.length === 0) return;

                const item = data[0];
                document.getElementById('edit-gss-id').value = item.gss_id;
                document.getElementById('edit-gss-display').value = item.gss_id;
                document.getElementById('edit-original-sn').value = item.original_sn;
                document.getElementById('edit-current-sn').value = item.engine_id || '';
                document.getElementById('edit-photo-url').value = item.photo_url || '';
                document.getElementById('edit-remarks').value = item.remarks || '';

                const modal = new bootstrap.Modal(document.getElementById('editGSSModal'));
                modal.show();
            } catch (error) {
                console.error('Error loading GSS for edit:', error);
            }
        }

        async function saveGSSEdit() {
            const gssId = parseInt(document.getElementById('edit-gss-id').value);
            const currentSn = document.getElementById('edit-current-sn').value;
            const photoUrl = document.getElementById('edit-photo-url').value;
            const remarks = document.getElementById('edit-remarks').value;

            try {
                const response = await fetch(`/api/gss/edit/${gssId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        current_sn: currentSn || null,
                        photo_url: photoUrl || null,
                        remarks: remarks || null
                    })
                });

                if (!response.ok) throw new Error('Failed to update GSS');

                showSuccessNotification('GSS assignment updated successfully!');
                bootstrap.Modal.getInstance(document.getElementById('editGSSModal')).hide();
                generateGSSRange();
                loadGSSHistory();
            } catch (error) {
                console.error('Error updating GSS:', error);
                showErrorNotification('Failed to update GSS assignment');
            }
        }

        async function deleteGSS(gssId) {
            if (!confirm(`Are you sure you want to delete GSS ID ${gssId}? This will free up the number.`)) return;

            try {
                const response = await fetch(`/api/gss/delete/${gssId}`, {
                    method: 'DELETE'
                });

                if (!response.ok) throw new Error('Failed to delete GSS');

                showSuccessNotification(`GSS ID ${gssId} deleted successfully`);
                generateGSSRange();
                loadGSSHistory();
            } catch (error) {
                console.error('Error deleting GSS:', error);
                showErrorNotification('Failed to delete GSS assignment');
            }
        }

        function clearGSSForm() {
            selectedGSSID = null;
            document.getElementById('selected-gss-number').textContent = '-';
            document.getElementById('gss-original-sn').value = '';
            document.getElementById('gss-current-sn').value = '';
            document.getElementById('gss-remarks').value = '';
            document.getElementById('gss-photo-file').value = '';
            document.getElementById('gss-photo-url').value = '';
            document.getElementById('photo-preview').style.display = 'none';
            document.getElementById('photo-upload-option').style.display = 'none';
            document.getElementById('photo-url-option').style.display = 'none';

            document.querySelectorAll('.gss-button').forEach(btn => {
                btn.classList.remove('selected');
            });
        }

        // ============================================
        // GSS TOOLTIP FUNCTIONS
        // ============================================
        let gssTooltip = null;

        async function showGSSTooltip(event, gssId) {
            if (gssId === '-' || !gssId) return;

            try {
                // Загружаем информацию о GSS
                const response = await fetch(`/api/gss/history`);
                if (!response.ok) return;

                const history = await response.json();
                const gssInfo = history.find(item => item.gss_id == gssId);

                if (!gssInfo) return;

                // Создаем tooltip
                if (gssTooltip) {
                    document.body.removeChild(gssTooltip);
                }

                gssTooltip = document.createElement('div');
                gssTooltip.style.cssText = `
                    position: fixed;
                    background: white;
                    border: 2px solid #0d6efd;
                    border-radius: 8px;
                    padding: 12px;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                    z-index: 10000;
                    max-width: 350px;
                    font-size: 13px;
                    pointer-events: none;
                `;

                let photoHtml = '';
                if (gssInfo.photo_filename) {
                    photoHtml = `<img src="/uploads/gss_photos/${gssInfo.photo_filename}" style="width: 100%; max-height: 150px; object-fit: cover; border-radius: 4px; margin-bottom: 8px;" alt="GSS Photo">`;
                } else if (gssInfo.photo_url) {
                    photoHtml = `<img src="${gssInfo.photo_url}" style="width: 100%; max-height: 150px; object-fit: cover; border-radius: 4px; margin-bottom: 8px;" alt="GSS Photo">`;
                }

                // Форматируем дату
                const assignedDate = gssInfo.assigned_date ? new Date(gssInfo.assigned_date).toLocaleDateString('ru-RU', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                }) : '-';

                gssTooltip.innerHTML = `
                    <div style="font-weight: bold; color: #0d6efd; margin-bottom: 8px; font-size: 14px;">
                        <i class="bi bi-tag-fill"></i> GSS ID: ${gssInfo.gss_id}
                    </div>
                    ${photoHtml}
                    <div style="line-height: 1.6;">
                        <div><strong>Original SN:</strong> ${gssInfo.original_sn || '-'}</div>
                        <div><strong>Current SN:</strong> ${gssInfo.current_sn || gssInfo.original_sn || '-'}</div>
                        <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid #dee2e6;">
                            <div><strong>Assigned by:</strong> ${gssInfo.assigned_by_name || 'Unknown'}</div>
                            <div><strong>Date:</strong> ${assignedDate}</div>
                        </div>
                        ${gssInfo.remarks ? `<div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid #dee2e6;"><strong>Remarks:</strong><br><div style="max-height: 100px; overflow-y: auto; padding: 4px; background: #f8f9fa; border-radius: 4px; margin-top: 4px;">${gssInfo.remarks}</div></div>` : ''}
                    </div>
                `;

                document.body.appendChild(gssTooltip);

                // Позиционируем tooltip рядом с курсором
                const x = event.clientX + 15;
                const y = event.clientY + 15;
                
                gssTooltip.style.left = x + 'px';
                gssTooltip.style.top = y + 'px';

                // Проверяем не выходит ли за границы экрана
                const rect = gssTooltip.getBoundingClientRect();
                if (rect.right > window.innerWidth) {
                    gssTooltip.style.left = (event.clientX - rect.width - 15) + 'px';
                }
                if (rect.bottom > window.innerHeight) {
                    gssTooltip.style.top = (event.clientY - rect.height - 15) + 'px';
                }

            } catch (error) {
                console.error('Error loading GSS info:', error);
            }
        }

        function hideGSSTooltip() {
            if (gssTooltip && gssTooltip.parentNode) {
                document.body.removeChild(gssTooltip);
                gssTooltip = null;
            }
        }

        // Load statuses on page load
        document.addEventListener('DOMContentLoaded', () => {
            loadConditionStatuses();
            loadWorkTypes();
        });
    </script>

    <!-- Add Condition Status Modal -->
    <div class="modal fade" id="addConditionModal" tabindex="-1">
        <div class="modal-dialog modal-md">
            <div class="modal-content">
                <div class="modal-header">
                    <h6 class="modal-title">Manage Condition Statuses</h6>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label small fw-bold">Add New Status</label>
                        <div class="row g-2">
                            <div class="col-7">
                                <input type="text" class="form-control form-control-sm" id="new-condition-name" placeholder="e.g. SERVICEABLE">
                            </div>
                            <div class="col-3">
                                <input type="color" class="form-control form-control-color" id="new-condition-color" value="#28a745" style="width: 100%; height: 31px;">
                            </div>
                            <div class="col-2">
                                <button type="button" class="btn btn-sm btn-success w-100" onclick="saveConditionStatus()">Add</button>
                            </div>
                        </div>
                    </div>
                    <hr>
                    <div>
                        <label class="form-label small fw-bold">Existing Statuses</label>
                        <div id="condition-status-list" style="max-height: 300px; overflow-y: auto;"></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-sm btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Work Type Modal -->
    <div class="modal fade" id="addWorkTypeModal" tabindex="-1">
        <div class="modal-dialog modal-md">
            <div class="modal-content">
                <div class="modal-header">
                    <h6 class="modal-title">Manage Work Types</h6>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label small fw-bold">Add New Work Type</label>
                        <div class="row g-2">
                            <div class="col-10">
                                <input type="text" class="form-control form-control-sm" id="new-work-type-name" placeholder="e.g. HPT, LPT, NGV, CC">
                            </div>
                            <div class="col-2">
                                <button type="button" class="btn btn-sm btn-success w-100" onclick="saveWorkType()">Add</button>
                            </div>
                        </div>
                    </div>
                    <hr>
                    <div>
                        <label class="form-label small fw-bold">Existing Work Types</label>
                        <div id="work-type-list" style="max-height: 300px; overflow-y: auto;"></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-sm btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

<!-- Boroscope Inspections Modal -->
<div id="boroscope-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 9999; overflow-y: auto; padding: 20px;">
    <div style="background: white; margin: 0 auto; max-width: 1400px; border-radius: 8px; box-shadow: 0 20px 60px rgba(0,0,0,0.4);">
        <div style="display: flex; justify-content: space-between; align-items: center; padding: 1.5rem 2rem; border-bottom: 2px solid #e9ecef; background: linear-gradient(135deg, #17a2b8 0%, #117a8b 100%); color: white; border-radius: 8px 8px 0 0;">
            <h3 style="margin: 0; display: flex; align-items: center; gap: 12px; font-size: 1.5rem;">
                <i class="bi bi-camera-video" style="font-size: 1.8rem;"></i> 
                <span>Boroscope Inspections</span>
            </h3>
            <button onclick="closeBoroscopeModal()" style="background: rgba(255,255,255,0.2); border: 2px solid white; color: white; padding: 0.5rem 1.2rem; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 1rem; transition: all 0.3s;" onmouseover="this.style.background='white'; this.style.color='#17a2b8'" onmouseout="this.style.background='rgba(255,255,255,0.2)'; this.style.color='white'">
                <i class="bi bi-x-lg"></i> Close
            </button>
        </div>
        
        <div style="padding: 2rem;">
            <div style="overflow-x: auto; border-radius: 6px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                <table class="table table-hover table-bordered mb-0" style="font-size: 0.9rem;">
                    <thead style="background: linear-gradient(135deg, #343a40 0%, #212529 100%); color: white;">
                        <tr>
                            <th style="padding: 1rem; font-weight: 600;">Date</th>
                            <th style="padding: 1rem; font-weight: 600;">Aircraft</th>
                            <th style="padding: 1rem; font-weight: 600;">Serial Number</th>
                            <th style="padding: 1rem; font-weight: 600; text-align: center;">Position</th>
                            <th style="padding: 1rem; font-weight: 600;">Work Type</th>
                            <th style="padding: 1rem; font-weight: 600;">GSS ID</th>
                            <th style="padding: 1rem; font-weight: 600;">Inspector</th>
                            <th style="padding: 1rem; font-weight: 600;">Comment</th>
                            <th style="padding: 1rem; font-weight: 600; text-align: center;">Document</th>
                        </tr>
                    </thead>
                    <tbody id="boroscope-modal-body" style="background: white;">
                        <tr>
                            <td colspan="9" class="text-center" style="padding: 3rem;">
                                <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;"></div>
                                <div style="margin-top: 1rem; color: #6c757d; font-size: 0.95rem;">Loading inspections...</div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>



<style>
#boroscope-modal.active {
    display: block !important;
}
#boroscope-modal table tbody tr {
    transition: background-color 0.2s;
}
#boroscope-modal table tbody tr:hover {
    background-color: #f1f3f5 !important;
}
#boroscope-modal table td {
    padding: 0.75rem 1rem;
    vertical-align: middle;
}

/* ============================================
   GSS REGISTRY STYLES
   ============================================ */

/* Принудительно устанавливаем правильный порядок элементов таблицы */
#gss-history-tbody {
    display: table-row-group;
}

#gss-history-tbody + thead,
thead:has(+ #gss-history-tbody) {
    display: table-header-group;
}

.gss-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(65px, 1fr));
    gap: 10px;
    max-height: 450px;
    overflow-y: auto;
    padding: 20px;
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border-radius: 12px;
    border: 2px solid #dee2e6;
}

.gss-button {
    padding: 14px 10px;
    border: 2px solid #ddd;
    border-radius: 8px;
    font-weight: bold;
    font-size: 15px;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    text-align: center;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.gss-button.available {
    background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
    color: white;
    border-color: #bd2130;
}

.gss-button.available:hover {
    background: linear-gradient(135deg, #c82333 0%, #a71d2a 100%);
    transform: translateY(-3px) scale(1.05);
    box-shadow: 0 6px 12px rgba(220, 53, 69, 0.4);
}

.gss-button.assigned {
    background: linear-gradient(135deg, #28a745 0%, #218838 100%);
    color: white;
    border-color: #1e7e34;
    cursor: help;
    opacity: 0.75;
}

.gss-button.assigned:hover {
    opacity: 1;
    box-shadow: 0 4px 8px rgba(40, 167, 69, 0.3);
}

.gss-button.selected {
    background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
    color: white;
    border-color: #004085;
    transform: scale(1.12);
    box-shadow: 0 8px 16px rgba(0, 123, 255, 0.5);
    z-index: 10;
}

#photo-preview {
    padding: 10px;
    background: #f8f9fa;
    border-radius: 8px;
    text-align: center;
}

#photo-preview-img {
    border: 2px solid #dee2e6;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.gss-photo-thumb {
    width: 50px;
    height: 50px;
    object-fit: cover;
    border-radius: 6px;
    cursor: pointer;
    transition: transform 0.2s;
    border: 2px solid #dee2e6;
}

.gss-photo-thumb:hover {
    transform: scale(1.8);
    z-index: 1000;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
}

.remarks-btn {
    cursor: pointer;
    color: #007bff;
    font-size: 18px;
}

.remarks-btn:hover {
    color: #0056b3;
    transform: scale(1.2);
}

#selected-gss-display {
    border-left: 4px solid #007bff;
}

#selected-gss-number {
    color: #007bff;
    font-weight: bold;
}

.gss-grid::-webkit-scrollbar {
    width: 8px;
}

.gss-grid::-webkit-scrollbar-track {
    background: #e9ecef;
    border-radius: 10px;
}

.gss-grid::-webkit-scrollbar-thumb {
    background: #6c757d;
    border-radius: 10px;
}

.gss-grid::-webkit-scrollbar-thumb:hover {
    background: #495057;
}

@keyframes pulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.15); }
}
</style>

</script>

<!-- GSS Modals -->
<div class="modal fade" id="photoViewModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">GSS Photo</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <img id="modal-photo-img" src="" alt="GSS Photo" style="max-width:100%;">
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="remarksViewModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Remarks - GSS ID <span id="remarks-gss-id"></span></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p id="remarks-content"></p>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="editGSSModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-warning">
                <h5 class="modal-title"><i class="bi bi-pencil"></i> Edit GSS Assignment</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="edit-gss-id">
                
                <div class="mb-3">
                    <label class="form-label fw-bold">GSS ID</label>
                    <input type="text" id="edit-gss-display" class="form-control" disabled>
                </div>

                <div class="mb-3">
                    <label class="form-label fw-bold">Original SN</label>
                    <input type="text" id="edit-original-sn" class="form-control" disabled>
                </div>

                <div class="mb-3">
                    <label class="form-label fw-bold">Current SN</label>
                    <select id="edit-current-sn" class="form-control">
                        <option value="">-- Same as Original --</option>
                    </select>
                </div>

                <div class="mb-3">
                    <label class="form-label fw-bold">Photo URL</label>
                    <input type="url" id="edit-photo-url" class="form-control" placeholder="https://...">
                </div>

                <div class="mb-3">
                    <label class="form-label fw-bold">Remarks</label>
                    <textarea id="edit-remarks" class="form-control" rows="3"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-warning" onclick="saveGSSEdit()">
                    <i class="bi bi-check-lg"></i> Save Changes
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Engine Details Modal -->
<div id="engine-details-modal">
    <div class="engine-details-container">
        <div class="engine-details-header">
            <div>
                <h2 id="modal-aircraft-name">Aircraft Details</h2>
                <div class="aircraft-info" id="modal-aircraft-info"></div>
            </div>
            <button class="btn-close-engine-modal" onclick="closeEngineDetailsModal()">
                <i class="bi bi-x-lg"></i> Close
            </button>
        </div>

        <div id="engine-modal-content">
            <!-- Loading state by default -->
            <div class="engine-loading">
                <div class="spinner"></div>
                <p>Loading engine data...</p>
            </div>
        </div>
    </div>
</div>

<!-- MODAL FOR BORESCOPE REPORTS -->
<div id="borescope-reports-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 10100; overflow-y: auto; padding: 20px;" onclick="closeBoroscopeReportsModalOnBgClick(event)">
    <div style="max-width: 900px; margin: 0 auto; background: white; border-radius: 12px; padding: 40px; box-shadow: 0 10px 40px rgba(0,0,0,0.3);" onclick="event.stopPropagation()">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
            <h1 id="report-aircraft-title" style="font-size: 32px; font-weight: bold; color: #000; margin: 0;"></h1>
            <button onclick="closeBoroscopeReportsModal()" style="background: none; border: none; font-size: 28px; cursor: pointer; color: #999;">×</button>
        </div>
        <div id="report-content-container" style="min-height: 400px;"></div>
        <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 30px;">
            <button onclick="exportReportToWord()" style="padding: 10px 20px; background: #4fc3f7; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold;">Export to Word</button>
            <button onclick="exportReportToPDF()" style="padding: 10px 20px; background: #ff7043; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold;">Export to PDF</button>
            <button onclick="printBoroscopeReport()" style="padding: 10px 20px; background: #66bb6a; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold;">Print</button>
            <button onclick="closeBoroscopeReportsModal()" style="padding: 10px 20px; background: #999; color: white; border: none; border-radius: 6px; cursor: pointer;">Close</button>
        </div>
    </div>
</div>

<!-- COMPACT MODAL FOR LATEST BORESCOPE REPORT -->
<div id="borescope-mini-modal" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.65); z-index: 10050; align-items: center; justify-content: center;" onclick="closeLatestBorescopeReport()">
    <div style="background: #0f172a; color: #e2e8f0; width: 520px; max-width: 92vw; border-radius: 10px; padding: 14px 16px; box-shadow: 0 10px 30px rgba(0,0,0,0.4);" onclick="event.stopPropagation();">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
            <div id="borescope-mini-title" style="font-weight: 700; font-size: 14px; color: #38bdf8;">Borescope Report</div>
            <button onclick="closeLatestBorescopeReport()" style="background: none; border: none; color: #94a3b8; font-size: 20px; cursor: pointer;">×</button>
        </div>
        <div id="borescope-mini-content" style="font-size: 12px;"></div>
    </div>
</div>

<!-- Fullscreen Photo Viewer -->
<div id="borescope-photo-overlay" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.95); z-index: 10200; align-items: center; justify-content: center;">
    <img id="borescope-photo-img" style="max-width: 90%; max-height: 90%; object-fit: contain;" onclick="event.stopPropagation();">
    <button onclick="closeBorescopePhoto()" style="position: absolute; top: 20px; right: 20px; background: none; border: none; color: white; font-size: 36px; cursor: pointer;">×</button>
</div>

<script>
// Initialize photo overlay handlers
document.addEventListener('DOMContentLoaded', function() {
    const photoOverlay = document.getElementById('borescope-photo-overlay');
    if (photoOverlay) {
        // Close on overlay click
        photoOverlay.addEventListener('click', (e) => {
            if (e.target === photoOverlay) closeBorescopePhoto();
        });
        
        // Close on ESC key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && photoOverlay.style.display !== 'none') {
                closeBorescopePhoto();
            }
        });
    }
});
</script>

</body>
</html>