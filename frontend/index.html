<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aviation Engine Management</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #e9eaee; overflow-x: hidden; padding-top: 0; }
        
        /* --- SIDEBAR --- */
        #wrapper { display: flex; width: 100%; align-items: stretch; transition: all 0.3s; padding-top: 0; }
        #sidebar-wrapper {
            min-width: 260px; 
            max-width: 260px;
                min-height: 100vh;
                background-color: #011325; 
                color: #202020;
                transition: margin 0.3s ease-out;
                margin-top: 0;
        }

        /* ENGINE HISTORY TIMELINE STYLES */
        #add-user-btn:hover {
            background: #218838;
        }

        /* Profile Dropdown */
        .profile-dropdown {
            position: fixed;
            top: 65px;
            right: 20px;
            width: 280px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
            display: none;
            z-index: 999;
        }

        .profile-dropdown.show {
            display: block;
            animation: dropdownSlide 0.2s ease;
        }

        @keyframes dropdownSlide {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .profile-header {
            padding: 20px;
            border-bottom: 1px solid #eee;
            text-align: center;
        }

        .profile-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: bold;
            margin: 0 auto 10px;
        }

        .profile-name {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .profile-position {
            font-size: 13px;
            color: #666;
            margin-bottom: 8px;
        }

        .profile-actions {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 12px;
        }

        .profile-actions .btn {
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 13px;
        }

        .profile-links {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .profile-links li {
            border-bottom: 1px solid #f0f0f0;
        }

        .profile-links li:last-child {
            border-bottom: none;
        }

        .profile-links a {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 18px;
            color: #333;
            text-decoration: none;
            transition: background 0.2s, color 0.2s;
        }

        .profile-links a:hover {
            background: #f8f9fa;
            color: #007bff;
        }

        .profile-links i {
            width: 18px;
            text-align: center;
            color: #555;
        }

        .profile-footer {
            padding: 12px 18px;
            background: #f8f9fa;
            border-top: 1px solid #eee;
            text-align: center;
        }

        .profile-footer button {
            width: 100%;
            padding: 8px 12px;
            border-radius: 8px;
        }

        .timeline-container {
            position: relative;
            padding: 20px 0;
            max-width: 1200px;
            margin: 0 auto;
        }

        .timeline-header {
            text-align: center;
            margin-bottom: 30px;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .timeline-header h5 {
            margin: 0;
            font-weight: 600;
        }

        .timeline-header .engine-meta {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-top: 10px;
            font-size: 0.9rem;
        }

        .timeline-line {
            position: absolute;
            left: 50%;
            top: 0;
            bottom: 0;
            width: 3px;
            background: linear-gradient(to bottom, #667eea, #764ba2);
            transform: translateX(-50%);
        }

        .timeline-event {
            position: relative;
            margin-bottom: 30px;
            display: flex;
            align-items: flex-start;
        }

        .timeline-event:nth-child(odd) {
            flex-direction: row;
        }

        .timeline-event:nth-child(even) {
            flex-direction: row-reverse;
        }

        .timeline-date {
            width: 45%;
            text-align: right;
            padding-right: 30px;
            font-weight: 600;
            color: #666;
            padding-top: 15px;
        }

        .timeline-event:nth-child(even) .timeline-date {
            text-align: left;
            padding-left: 30px;
            padding-right: 0;
        }

        .timeline-icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.3rem;
            color: white;
            z-index: 10;
            flex-shrink: 0;
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
        }

        .timeline-icon.install { background: linear-gradient(135deg, #11998e, #38ef7d); }
        .timeline-icon.remove { background: linear-gradient(135deg, #ee0979, #ff6a00); }
        .timeline-icon.repair { background: linear-gradient(135deg, #f093fb, #f5576c); }
        .timeline-icon.ship { background: linear-gradient(135deg, #8e44ad, #3498db); }
        .timeline-icon.part { background: linear-gradient(135deg, #4facfe, #00f2fe); }
        .timeline-icon.atlb { background: linear-gradient(135deg, #43e97b, #38f9d7); }
        .timeline-icon.inspect { background: linear-gradient(135deg, #f39c12, #e67e22); }
        .timeline-icon.param { background: linear-gradient(135deg, #fa709a, #fee140); }

        .timeline-content {
            width: 45%;
            padding: 15px 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 3px 15px rgba(0,0,0,0.1);
            border-left: 4px solid #667eea;
            transition: all 0.3s ease;
        }

        .timeline-event:nth-child(even) .timeline-content {
            border-left: none;
            border-right: 4px solid #667eea;
        }

        .timeline-content:hover {
            box-shadow: 0 5px 25px rgba(0,0,0,0.15);
            transform: translateY(-2px);
        }

        .timeline-content h6 {
            margin: 0 0 8px 0;
            color: #333;
            font-weight: 600;
        }

        .timeline-content .badge {
            font-size: 0.75rem;
            padding: 4px 8px;
        }

        .timeline-details {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #eee;
            font-size: 0.85rem;
            color: #666;
        }

        .timeline-details strong {
            color: #333;
        }

        .timeline-no-data {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        @media (max-width: 768px) {
            .timeline-line { left: 25px; }
            .timeline-event { flex-direction: column !important; }
            .timeline-date, .timeline-content { width: 100%; text-align: left !important; padding-left: 70px !important; padding-right: 0 !important; }
            .timeline-icon { position: absolute; left: 0; }
        }

        /* Sidebar + layout */
        .sidebar-brand { padding: 1.25rem 1rem; font-weight: 700; letter-spacing: 0.3px; border-bottom: 1px solid rgba(255,255,255,0.08); }
        #sidebar-wrapper .list-group-item { background: transparent; color: #c7d1dd; border: none; padding: 12px 18px; font-size: 0.95rem; }
        #sidebar-wrapper .list-group-item:hover { background: rgba(255,255,255,0.08); color: #fff; }
        #sidebar-wrapper .list-group-item i { width: 18px; text-align: center; margin-right: 8px; }
        .btn-neon { background: linear-gradient(135deg, #1f9cff, #6f7bff); color: #fff; border: none; box-shadow: 0 8px 20px rgba(31,156,255,0.35); }
        .btn-neon:hover { filter: brightness(1.05); color: #fff; }

        /* Engine radial button */
        .engine-btn-container { position: fixed; right: 22px; bottom: 22px; z-index: 999; }
        .engine-btn-core { position: relative; width: 88px; height: 88px; }
        .btn-engine-start { width: 88px; height: 88px; border-radius: 50%; border: none; background: radial-gradient(circle at 30% 30%, #7cf5ff, #1b4bff 60%); box-shadow: 0 10px 30px rgba(27,75,255,0.35); position: relative; overflow: hidden; }
        .engine-fan { display: block; position: absolute; inset: 0; animation: fan-spin 2s linear infinite; }
        .fan-blade { position: absolute; width: 8px; height: 32px; background: rgba(255,255,255,0.85); left: 50%; top: 50%; transform-origin: center 100%; border-radius: 6px; }
        .blade-1 { transform: translate(-50%, -100%) rotate(0deg); }
        .blade-2 { transform: translate(-50%, -100%) rotate(60deg); }
        .blade-3 { transform: translate(-50%, -100%) rotate(120deg); }
        .blade-4 { transform: translate(-50%, -100%) rotate(180deg); }
        .blade-5 { transform: translate(-50%, -100%) rotate(240deg); }
        .blade-6 { transform: translate(-50%, -100%) rotate(300deg); }
        .fan-hub { position: absolute; width: 22px; height: 22px; border-radius: 50%; background: #0a1f4d; left: 50%; top: 50%; transform: translate(-50%, -50%); box-shadow: inset 0 0 0 2px rgba(255,255,255,0.7); }
        @keyframes fan-spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .engine-btn-menu { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; pointer-events: none; }
        .engine-menu-item { position: absolute; width: 96px; height: 96px; border-radius: 18px; background: rgba(0,210,255,0.08); border: 1px solid rgba(0,210,255,0.28); color: #ecfaff; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 6px; font-size: 0.85rem; opacity: 0; transform: translate(-50%, -50%) rotate(var(--angle)) translate(0) rotate(calc(-1 * var(--angle))); transition: opacity 0.25s ease, transform 0.25s ease; }
        .engine-btn-menu.show .engine-menu-item { opacity: 1; pointer-events: auto; transform: translate(-50%, -50%) rotate(var(--angle)) translate(120px) rotate(calc(-1 * var(--angle))); }

        /* Dashboard widgets */
        .dashboard-content { background: #f5f7fb; padding: 18px; border-radius: 14px; box-shadow: inset 0 1px 0 rgba(255,255,255,0.6); }
        .btn-dashboard { position: relative; padding: 14px 16px; border-radius: 14px; border: none; display: flex; flex-direction: column; align-items: flex-start; gap: 6px; color: #fff; box-shadow: 0 10px 30px rgba(0,0,0,0.12); transition: transform 0.15s ease, box-shadow 0.15s ease; }
        .btn-dashboard .label { font-weight: 600; font-size: 1rem; }
        .btn-dashboard .count { font-size: 1.4rem; font-weight: 700; }
        .btn-dashboard i { position: absolute; right: 12px; top: 12px; font-size: 1.3rem; opacity: 0.9; }
        .btn-dashboard:hover { transform: translateY(-2px); box-shadow: 0 14px 34px rgba(0,0,0,0.18); color: #fff; }
        .btn-status-sv { background: linear-gradient(135deg, #1fbf75, #0f8d52); }
        .btn-status-us { background: linear-gradient(135deg, #f54b64, #d31027); }
        .btn-status-rem { background: linear-gradient(135deg, #ff9f43, #ff6a00); }
        .btn-status-inst { background: linear-gradient(135deg, #4c6fff, #1b35ff); }

        /* Generic helpers */
        .btn-circle { width: 36px; height: 36px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; padding: 0; }
        .card { border-radius: 14px; }
        .card-header { border-top-left-radius: 14px; border-top-right-radius: 14px; }
        .table thead th { white-space: nowrap; }
        .spinner-sm { width: 1.75rem; height: 1.75rem; }

        /* Scroll containers */
        .table-responsive { border-radius: 10px; }
        .dashboard-collapsed { max-height: 0 !important; overflow: hidden; opacity: 0; transition: all 0.3s ease; }
        .dashboard-expanded { max-height: 2000px; opacity: 1; transition: all 0.3s ease; }
    </style>
</head>
<body>

    <!-- Login Modal -->
    <div id="login-modal" class="login-modal">
        <div class="login-box">
            <h2><i class="bi bi-shield-lock"></i> Aviation MRO Login</h2>
            <div id="login-error" class="login-error"></div>
            <form id="login-form">
                <div class="mb-3">
                    <label class="form-label">Username</label>
                    <input type="text" class="form-control" id="login-username" required autofocus>
                </div>
            
                            <!-- ACTION DETAILS MODAL -->
                            <div id="action-details-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; justify-content: center; align-items: center;">
                                <div style="background: white; border-radius: 8px; max-width: 700px; max-height: 80vh; overflow: auto; box-shadow: 0 4px 20px rgba(0,0,0,0.3); padding: 25px; position: relative;">
                                    <button onclick="closeActionDetailsModal()" style="position: absolute; top: 10px; right: 10px; background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #999;">&times;</button>
                                    <h5 class="mb-4"><i class="bi bi-info-circle me-2"></i>Action Details</h5>
                                    <div id="action-details-content">
                                        <!-- Will be populated by JS -->
                                    </div>
                                </div>
                            </div>
                <div class="mb-3">
                    <label class="form-label">Password</label>
                    <input type="password" class="form-control" id="login-password" required>
                </div>
                <button type="submit" class="btn btn-primary w-100">
                    <i class="bi bi-box-arrow-in-right"></i> Sign In
                </button>
            </form>
            <div class="text-center mt-3">
                <small class="text-muted">Default: admin / admin123</small>
            </div>
        </div>
    </div>

    <!-- Profile Dropdown -->
    <div id="profile-dropdown" class="profile-dropdown">
        <div class="profile-header">
            <div class="profile-avatar" id="profile-avatar">AA</div>
            <div class="profile-name" id="profile-name">Admin User</div>
            <div class="profile-position" id="profile-position">System Administrator</div>
            <span class="profile-role" id="profile-role">admin</span>
        </div>
        <div class="profile-menu">
            <div class="profile-menu-item" onclick="editProfile()">
                <i class="bi bi-person"></i>
                <span>Edit Profile</span>
            </div>
            <div class="profile-menu-item" onclick="changePassword()">
                <i class="bi bi-key"></i>
                <span>Change Password</span>
            </div>
            <div class="profile-menu-item" onclick="logout()">
                <i class="bi bi-box-arrow-right"></i>
                <span>Logout</span>
            </div>
        </div>
    </div>

    <!-- Notifications Panel -->
    <div id="notifications-panel" class="notifications-panel">
        <div class="notifications-header">
            <h5><i class="bi bi-bell"></i> Notifications</h5>
            <a href="#" class="mark-all-read" onclick="markAllNotificationsRead(); return false;">
                Mark all read
            </a>
        </div>
        <div id="notifications-list" class="notifications-list">
            <div class="text-center text-muted py-4">Loading...</div>
        </div>
    </div>

<div id="wrapper">
    <div id="sidebar-wrapper">
        <a href="#" class="sidebar-brand text-white text-decoration-none">
            <i class="bi bi-gear-fill"></i> Engine Management
        </a>
        <div class="list-group list-group-flush">

            <!-- MASTER DATA ENTRY BUTTON -->
            <div class="px-3 mt-3">
                <a href="#" class="btn btn-neon w-100 text-start" onclick="openMainEngineView(); return false;">
                    <i class="bi bi-database-add"></i> Add Engine
                </a>
            </div>
            <!-- REPORTS GROUP (COLLAPSIBLE) -->
            <div class="text-uppercase text-muted small mt-4 mb-2 px-3">
                <div class="neon-header" style="cursor: pointer; user-select: none;" onclick="toggleReportsMenu()">
                    <i class="bi bi-chevron-right" id="reports-chevron" style="transition: transform 0.3s;"></i>
                    Reports
                </div>
            </div>
            <div id="reports-submenu" style="display: none;">
                <a href="#" class="list-group-item list-group-item-action ps-4" onclick="openBoroscopeView(); return false;">
                    <i class="bi bi-camera-video"></i> Borescope
                </a>
                <a href="#" class="list-group-item list-group-item-action ps-4" onclick="openEngineReportsView(); return false;">
                    <i class="bi bi-clock-history"></i> Engine Reports
                </a>
                <a href="#" class="list-group-item list-group-item-action ps-4" onclick="openPurchaseOrdersView(); return false;">
                    <i class="bi bi-receipt"></i> Purchase Orders
                </a>
            </div>
            
            <div class="text-uppercase text-muted small mt-4 mb-2 px-3">
                <div class="neon-header" style="cursor: pointer; user-select: none;" onclick="toggleActionsMenu()">
                    <i class="bi bi-chevron-down" id="actions-chevron" style="transition: transform 0.3s;"></i>
                    Actions
                </div>
            </div>
            <div id="actions-submenu" style="display: block;">
                <a href="#" class="list-group-item list-group-item-action ps-4" onclick="openInstallView(); return false;"><i class="bi bi-arrow-up-circle"></i> Installation</a>
                <a href="#" class="list-group-item list-group-item-action ps-4" onclick="openRemoveView(); return false;"><i class="bi bi-arrow-down-circle"></i> Remove</a>
                <a href="#" class="list-group-item list-group-item-action ps-4" onclick="openRepairView(); return false;"><i class="bi bi-wrench"></i> Repair</a>
                <a href="#" class="list-group-item list-group-item-action ps-4" onclick="openAtlbView(); return false;"><i class="bi bi-journal-richtext"></i> Utilization (ATLB)</a>
                <a href="#" class="list-group-item list-group-item-action ps-4" onclick="openEngParamView(); return false;"><i class="bi bi-sliders"></i> ENG Parameters</a>
                <a href="#" class="list-group-item list-group-item-action ps-4" onclick="openUtilizationParamView(); return false;"><i class="bi bi-bar-chart-line"></i> Utilization Parameters</a>
            </div>
            
            <!-- LOGISTICS GROUP (COLLAPSIBLE) -->
            <div class="text-uppercase text-muted small mt-4 mb-2 px-3">
                <div class="neon-header" style="cursor: pointer; user-select: none;" onclick="toggleLogisticsMenu()">
                    <i class="bi bi-chevron-right" id="logistics-chevron" style="transition: transform 0.3s;"></i>
                    Logistics
                </div>
            </div>
            <div id="logistics-submenu" style="display: none;">
                <a href="#" class="list-group-item list-group-item-action ps-4" onclick="openShipmentView(); return false;">
                    <i class="bi bi-truck"></i> Engine Shipment
                </a>
                <a href="#" class="list-group-item list-group-item-action ps-4" onclick="openPartsView(); return false;">
                    <i class="bi bi-box-seam"></i> <span data-parts-title="logistics">Parts Logistics</span>
                </a>
                <a href="#" class="list-group-item list-group-item-action ps-4" onclick="openStoreBalanceView(); return false;">
                    <i class="bi bi-collection"></i> <span data-parts-title="store">Store Balance</span>
                </a>
            </div>
                
            
        </div>
    </div>

    <!-- Success Notification Modal -->
    <div class="modal fade" id="successModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title"><i class="bi bi-check-circle-fill me-2"></i>Success</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center py-4">
                    <i class="bi bi-check-circle text-success" style="font-size: 3rem;"></i>
                    <p class="mt-3 mb-0" id="successMessage">Operation completed successfully!</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-success" data-bs-dismiss="modal">OK</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Error Notification Modal -->
    <div class="modal fade" id="errorModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title"><i class="bi bi-exclamation-triangle-fill me-2"></i>Error</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center py-4">
                    <i class="bi bi-x-circle text-danger" style="font-size: 3rem;"></i>
                    <p class="mt-3 mb-0" id="errorMessage">An error occurred!</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ENGINE HISTORY TIMELINE MODAL -->
    <div class="modal fade" id="engineHistoryModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header bg-info text-white">
                    <h5 class="modal-title"><i class="bi bi-clock-history me-2"></i>Engine Full History Timeline</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="engineHistoryBody">
                    <div class="text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="text-muted mt-3">Loading engine history...</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <div id="page-content-wrapper" class="w-100">
        
        <nav class="navbar navbar-light bg-white border-bottom px-3 py-3">
            <button class="btn btn-outline-secondary btn-sm" id="menu-toggle"><i class="bi bi-list fs-5"></i></button>
            <div class="flex-grow-1"></div>
            <div class="d-flex align-items-center gap-2">
                <button id="add-user-btn" class="user-icon-btn" title="Users" style="display:none; background: #28a745; color: white; border: none;">
                    <i class="bi bi-person-plus"></i>
                </button>
                <button id="settings-btn" class="user-icon-btn" title="Settings">
                    <i class="bi bi-gear"></i>
                </button>
                <button id="notifications-btn" class="user-icon-btn" title="Notifications">
                    <i class="bi bi-bell"></i>
                    <span id="notification-count" class="notification-badge">0</span>
                </button>
                <button id="user-profile-btn" class="user-icon-btn" title="Profile">
                    <span id="user-initials">AA</span>
                </button>
            </div>
        </nav>

        <!-- User Management Modal -->
        <div class="modal fade" id="user-manage-modal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-lg modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title"><i class="bi bi-people me-2"></i>User Management</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="row g-3">
                            <div class="col-md-5">
                                <h6 class="mb-3">Create / Edit User</h6>
                                <form id="user-form">
                                    <input type="hidden" id="user-id">
                                    <div class="mb-2">
                                        <label class="form-label">Имя *</label>
                                        <input type="text" class="form-control" id="user-first-name" required>
                                    </div>
                                    <div class="mb-2">
                                        <label class="form-label">Фамилия *</label>
                                        <input type="text" class="form-control" id="user-last-name" required>
                                    </div>
                                    <div class="mb-2">
                                        <label class="form-label">Логин (только англ. буквы/цифры) *</label>
                                        <input type="text" class="form-control" id="user-username" required>
                                    </div>
                                    <div class="mb-2">
                                        <label class="form-label">Пароль *</label>
                                        <input type="password" class="form-control" id="user-password" required>
                                    </div>
                                    <div class="mb-2">
                                        <label class="form-label">Позиция</label>
                                        <input type="text" class="form-control" id="user-position" placeholder="Engineer, Manager...">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Роль *</label>
                                        <select class="form-select" id="user-role" required>
                                            <option value="viewer">Viewer</option>
                                            <option value="user">User</option>
                                            <option value="admin">Admin</option>
                                        </select>
                                    </div>
                                    <div class="d-flex gap-2">
                                        <button type="submit" class="btn btn-primary" id="user-submit-btn">Create User</button>
                                        <button type="button" class="btn btn-secondary" id="user-reset-btn">Reset</button>
                                    </div>
                                </form>
                            </div>
                            <div class="col-md-7">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <h6 class="mb-0">Активные пользователи</h6>
                                    <button class="btn btn-outline-primary btn-sm" id="refresh-users-btn"><i class="bi bi-arrow-repeat"></i></button>
                                </div>
                                <div class="table-responsive" style="max-height: 360px;">
                                    <table class="table table-sm align-middle">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Имя</th>
                                                <th>Фамилия</th>
                                                <th>Логин</th>
                                                <th>Роль</th>
                                                <th class="text-end">Действия</th>
                                            </tr>
                                        </thead>
                                        <tbody id="user-table-body"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
           
        <div class="container-fluid p-4">
            
            
            <!-- КНОПКА-ДВИГАТЕЛЬ (START) -->
            <div id="engine-btn-wrapper" class="engine-btn-container">
                <div class="engine-btn-core">
                    <button type="button" id="engine-toggle-btn" class="btn-engine-start" onclick="handleEngineButtonClick(event)">
                        <span class="engine-fan">
                            <span class="fan-blade blade-1"></span>
                            <span class="fan-blade blade-2"></span>
                            <span class="fan-blade blade-3"></span>
                            <span class="fan-blade blade-4"></span>
                            <span class="fan-blade blade-5"></span>
                            <span class="fan-blade blade-6"></span>
                            <span class="fan-hub"></span>
                        </span>
                    </button>
                    <div class="engine-btn-menu" id="engine-btn-menu">
                        <button type="button" class="engine-menu-item engine-menu-item-manuals" style="--angle: -90deg;" onclick="handleEngineMenuSelection('manuals')">
                            <i class="bi bi-journal-bookmark-fill"></i>
                            <span>Manuals</span>
                        </button>
                        <button type="button" class="engine-menu-item engine-menu-item-reports" style="--angle: 150deg;" onclick="handleEngineMenuSelection('reports')">
                            <i class="bi bi-graph-up"></i>
                            <span>Reports</span>
                        </button>
                        <button type="button" class="engine-menu-item engine-menu-item-folders" style="--angle: 30deg;" onclick="handleEngineMenuSelection('folders')">
                            <i class="bi bi-folder2-open"></i>
                            <span>Folders</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- 1. ГЛАВНЫЙ ЭКРАН (Скрыт по умолчанию или показан - настроим в JS) -->
            <div id="dashboard-widgets" class="dashboard-content">      
                 
            
                <div class="row g-3 mb-4" id="locations-container">
                <div class="col-12"><div class="spinner-border text-primary spinner-sm"></div> Loading locations...</div>
            </div>
            
            <div class="row g-3 mb-4">
                <div class="col-md-3">
                    <button class="btn-dashboard btn-status-sv w-100" onclick="openTableModal('SV')">
                        <span class="label">Serviceable (SV)</span>
                        <span class="count" id="cnt-sv">0</span>
                        <i class="bi bi-check-circle-fill"></i>
                    </button>
                </div>
                <div class="col-md-3">
                    <button class="btn-dashboard btn-status-us w-100" onclick="openTableModal('US')">
                        <span class="label">Unserviceable (US)</span>
                        <span class="count" id="cnt-us">0</span>
                        <i class="bi bi-x-circle-fill"></i>
                    </button>
                </div>
                <div class="col-md-3">
                    <button class="btn-dashboard btn-status-rem w-100" onclick="openTableModal('REMOVED')">
                        <span class="label">Removed from AC</span>
                        <span class="count" id="cnt-rem">0</span>
                        <i class="bi bi-arrow-down-left-circle-fill"></i>
                    </button>
                </div>
                <div class="col-md-3">
                    <button class="btn-dashboard btn-status-inst w-100" onclick="openTableModal('INSTALLED')">
                        <span class="label">Installed on AC</span>
                        <span class="count" id="cnt-inst">0</span>
                        <i class="bi bi-airplane-engines-fill"></i>
                    </button>
                </div>
            </div>
        </div>
        <div id="view-install" style="display: none;">
                <h4 class="mb-3 text-primary"><i class="bi bi-arrow-up-circle"></i> Installation Action</h4>
                
                <ul class="nav nav-tabs mb-4">
                    <li class="nav-item">
                        <button class="nav-link active" id="tab-inst-info-btn" onclick="switchInstallTab('info')">Вся информация</button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link" id="tab-inst-entry-btn" onclick="switchInstallTab('entry')">Ввести данные</button>
                    </li>
                </ul>

                <!-- ИСПРАВЛЕНИЕ: Уникальный ID для Installation -->
                <div id="tab-inst-info">
                    <div class="card shadow-sm">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <!-- Поле поиска (с уникальным ID) -->
                                <div class="input-group" style="max-width: 300px;">
                                    <span class="input-group-text bg-white text-muted"><i class="bi bi-search"></i></span>
                                    <input type="text" class="form-control border-start-0 ps-0" id="inst-search-input" placeholder="Search all columns..." onkeyup="filterInstallTable()">
                                </div>
                                
                                <!-- Кнопки (с правильными функциями) -->
                                <div>
                                    <button class="btn btn-sm btn-primary" onclick="loadInstallHistory()"><i class="bi bi-arrow-clockwise"></i> Refresh</button>
                                    <button class="btn btn-sm btn-warning ms-2" id="btn-install-edit" onclick="toggleEditModeTable('install')"><i class="bi bi-pencil-square"></i> Edit</button>
                                    <button class="btn btn-sm btn-success ms-2 d-none" id="btn-install-save" onclick="saveEditModeTable('install')"><i class="bi bi-check-lg"></i> Save Changes</button>
                                    <button class="btn btn-sm btn-secondary ms-2 d-none" id="btn-install-cancel" onclick="cancelEditModeTable('install')"><i class="bi bi-x-lg"></i> Cancel</button>
                                    <button class="btn btn-circle btn-success d-none" id="add-row-install" onclick="addEmptyRowTable('install')" title="Add Row"><i class="bi bi-plus-lg"></i></button>
                                </div>
                            </div>

                            <table class="table table-hover table-bordered table-sm" id="install-table">
                                <thead class="table-light">
                                    <tr>
                                        <th class="delete-col-install" style="width: 40px; display: none;"><i class="bi bi-trash"></i></th>
                                        <th>Date</th>
                                        <th>Orig SN</th>
                                        <th>Current SN</th>
                                        <th>Install To</th>
                                        <th>Pos</th>
                                        <th>Loc From</th>
                                        <th>TT(Engine Flight Hours)</th>
                                        <th>TC(Engine Cycles)</th>
                                        <th>TTSN(A/C)</th>
                                        <th>TCSN(A/C)</th>
                                        <th>Remarks</th>
                                    </tr>
                                </thead>
                                <tbody id="install-history-body">
                                    </tbody>
                            </table>
                        </div>
                    </div>
                </div>


        <div id="tab-inst-entry" style="display: none;">
                    <div class="row">
                        <div class="col-md-8">
                            <div class="card shadow-sm border-0">
                                <div class="card-header bg-white fw-bold">New Installation Event</div>
                                <div class="card-body">
                                    <form id="form-install">
                                        <div class="row mb-3">
                                            <div class="col-md-4">
                                                <label class="form-label small fw-bold">Date <span class="text-danger">*</span></label>
                                                <input type="date" class="form-control" id="in-date" required>
                                            </div>
                                            <div class="col-md-4">
                                                <label class="form-label small fw-bold">Engine (Orig SN) <span class="text-danger">*</span></label>
                                                
                                                <!-- ЗАМЕНА: Вместо select используем input + datalist -->
                                                <input class="form-control" list="engine-options" id="in-engine-input" placeholder="Type to search SN..." required>
                                                <datalist id="engine-options">
                                                    <!-- Сюда JS загрузит варианты -->
                                                </datalist>
                                                
                                                <!-- Скрытое поле, куда мы запишем ID двигателя для отправки на сервер -->
                                                <input type="hidden" id="in-engine-id">
                                            </div>
                                            <div class="col-md-4">
                                                <label class="form-label small fw-bold">Current SN</label>
                                                <!-- Убрали readonly и bg-light, теперь можно писать -->
                                                <input type="text" class="form-control" id="in-cur-sn" placeholder="Enter Current SN">
                                            </div>
                                        </div>

                                        <div class="row mb-3">
                                            <div class="col-md-4">
                                                <label class="form-label small fw-bold">Install To (AC) <span class="text-danger">*</span></label>
                                                <select class="form-select" id="in-ac" required>
                                                    <option value="1">ER-BAT</option>
                                                    <option value="2">ER-BAR</option>
                                                    <option value="3">ER-BAQ</option>
                                                </select>
                                            </div>
                                            <div class="col-md-4">
                                                <label class="form-label small fw-bold">Position <span class="text-danger">*</span></label>
                                                <!-- Добавили позиции 3 и 4 -->
                                                <select class="form-select" id="in-pos" required>
                                                    <option value="1">1</option>
                                                    <option value="2">2</option>
                                                    <option value="3">3</option>
                                                    <option value="4">4</option>
                                                </select>
                                            </div>
                                            <div class="col-md-4">
                                                <label class="form-label small fw-bold">Location From</label>
                                                <!-- Убрали readonly и bg-light -->
                                                <input type="text" class="form-control" id="in-loc-from" placeholder="Enter Location">
                                            </div>
                                        </div>

                                        <div class="row mb-3">
                                            <div class="col-md-6">
                                                <label class="form-label small fw-bold">TT (Engine Flight Hours) <span class="text-danger">*</span></label>
                                                <input type="number" step="0.1" class="form-control" id="in-tt" required>
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label small fw-bold">TC (Engine Cycles) <span class="text-danger">*</span></label>
                                                <input type="number" class="form-control" id="in-tc" required>
                                            </div>
                                        </div>

                                        <div class="row mb-3">
                                            <div class="col-md-6">
                                                <label class="form-label small fw-bold">TTSN(A/C) <span class="text-danger">*</span></label>
                                                <input type="number" step="0.1" class="form-control" id="in-ac-ttsn" required>
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label small fw-bold">TCSN(A/C) <span class="text-danger">*</span></label>
                                                <input type="number" class="form-control" id="in-ac-tcsn" required>
                                            </div>
                                        </div>

                                        <div class="mb-4">
                                            <label class="form-label small fw-bold">Remarks</label>
                                            <textarea class="form-control" id="in-rem" rows="2"></textarea>
                                        </div>

                                        <div class="d-flex justify-content-end gap-2">
                                            <button type="button" class="btn btn-light border" onclick="switchInstallTab('info')">Cancel</button>
                                            <button type="button" class="btn btn-success px-4" onclick="submitInstallForm()">Save Record</button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>      
          
        <div id="view-shipment" style="display: none;">
                <h4 class="mb-3 text-primary"><i class="bi bi-truck"></i> Engine Shipment Action</h4>
                
                <ul class="nav nav-tabs mb-4">
                    <li class="nav-item">
                        <button class="nav-link active" id="tab-ship-info-btn" onclick="switchShipmentTab('info')">История отгрузок</button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link" id="tab-ship-entry-btn" onclick="switchShipmentTab('entry')">Создать отгрузку</button>
                    </li>
                </ul>

                <!-- TAB 1: History -->
                <div id="tab-ship-info">
                    <div class="card shadow-sm">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <!-- Поле поиска -->
                                <div class="input-group" style="max-width: 300px;">
                                    <span class="input-group-text bg-white text-muted"><i class="bi bi-search"></i></span>
                                    <input type="text" class="form-control border-start-0 ps-0" id="ship-search-input" placeholder="Search..." onkeyup="filterTable('shipment-history-body', 'ship-search-input')">
                                </div>
                                
                                <!-- Кнопки -->
                                <div>
                                    <button class="btn btn-sm btn-primary" onclick="loadShipmentHistory()"><i class="bi bi-arrow-clockwise"></i> Refresh</button>
                                    <button class="btn btn-sm btn-warning ms-2" id="btn-shipment-edit" onclick="toggleEditModeTable('shipment')"><i class="bi bi-pencil-square"></i> Edit</button>
                                    <button class="btn btn-sm btn-success ms-2 d-none" id="btn-shipment-save" onclick="saveEditModeTable('shipment')"><i class="bi bi-check-lg"></i> Save Changes</button>
                                    <button class="btn btn-sm btn-secondary ms-2 d-none" id="btn-shipment-cancel" onclick="cancelEditModeTable('shipment')"><i class="bi bi-x-lg"></i> Cancel</button>
                                    <button class="btn btn-circle btn-success d-none" id="add-row-shipment" onclick="addEmptyRowTable('shipment')" title="Add Row"><i class="bi bi-plus-lg"></i></button>
                                </div>
                            </div>
                            <table class="table table-hover table-bordered table-sm">
                                <thead class="table-light">
                                    <tr>
                                        <th class="delete-col-shipment" style="width: 40px; display: none;"><i class="bi bi-trash"></i></th>
                                        <th>Date</th>
                                        <th>Engine SN</th>
                                        <th>From</th>
                                        <th>To (Destination)</th>
                                        <th>Remarks / Waybill</th>
                                    </tr>
                                </thead>
                                <tbody id="shipment-history-body"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- TAB 2: New Entry -->
                <div id="tab-ship-entry" style="display: none;">
                    <div class="row">
                        <div class="col-md-8">
                            <div class="card shadow-sm border-0">
                                <div class="card-header bg-white fw-bold">New Shipment</div>
                                <div class="card-body">
                                    <form id="form-shipment">
                                        <div class="row mb-3">
                                            <div class="col-md-4">
                                                <label class="form-label small fw-bold">Date <span class="text-danger">*</span></label>
                                                <input type="date" class="form-control" id="ship-date" required>
                                            </div>
                                            <div class="col-md-4">
                                                <label class="form-label small fw-bold">Engine <span class="text-danger">*</span></label>
                                                <input class="form-control" list="engine-options-ship" id="ship-engine-input" placeholder="Search Engine..." required>
                                                <datalist id="engine-options-ship"></datalist>
                                                <input type="hidden" id="ship-engine-id">
                                            </div>
                                            <div class="col-md-4">
                                                <label class="form-label small fw-bold">From (Location)</label>
                                                <input type="text" class="form-control" id="ship-loc-from">
                                            </div>
                                        </div>

                                        <div class="row mb-3">
                                            <div class="col-md-6">
                                                <label class="form-label small fw-bold">Destination (To) <span class="text-danger">*</span></label>
                                                <select class="form-select" id="ship-dest" required>
                                                    <!-- Заполнится JS -->
                                                </select>
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label small fw-bold">Waybill #</label>
                                                <input type="text" class="form-control" id="ship-wb" placeholder="e.g. AWB-123456">
                                            </div>
                                        </div>

                                        <div class="mb-4">
                                            <label class="form-label small fw-bold">Remarks</label>
                                            <textarea class="form-control" id="ship-rem" rows="2"></textarea>
                                        </div>

                                        <div class="d-flex justify-content-end gap-2">
                                            <button type="button" class="btn btn-light border" onclick="switchShipmentTab('info')">Cancel</button>
                                            <button type="button" class="btn btn-success px-4" onclick="submitShipmentForm()">Confirm Shipment</button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>        

         <!-- 4. REMOVE VIEW -->
        <div id="view-remove" style="display: none;">
                <h4 class="mb-3 text-danger"><i class="bi bi-arrow-down-circle"></i> Remove Engine</h4>
                
                <ul class="nav nav-tabs mb-4">
                    <li class="nav-item">
                        <button class="nav-link active" id="tab-rem-info-btn" onclick="switchRemoveTab('info')">История снятий</button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link" id="tab-rem-entry-btn" onclick="switchRemoveTab('entry')">Снять двигатель</button>
                    </li>
                </ul>

                <!-- Tab Info -->
                <div id="tab-rem-info">
                    <div class="card shadow-sm">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <!-- Поле поиска -->
                                <div class="input-group" style="max-width: 300px;">
                                    <span class="input-group-text bg-white text-muted"><i class="bi bi-search"></i></span>
                                    <input type="text" class="form-control border-start-0 ps-0" id="rem-search-input" placeholder="Search..." onkeyup="filterTable('remove-history-body', 'rem-search-input')">
                                </div>
                                
                                <!-- Кнопки -->
                                <div>
                                    <button class="btn btn-sm btn-primary" onclick="loadRemoveHistory()"><i class="bi bi-arrow-clockwise"></i> Refresh</button>
                                    <button class="btn btn-sm btn-warning ms-2" id="btn-remove-edit" onclick="toggleEditModeTable('remove')"><i class="bi bi-pencil-square"></i> Edit</button>
                                    <button class="btn btn-sm btn-success ms-2 d-none" id="btn-remove-save" onclick="saveEditModeTable('remove')"><i class="bi bi-check-lg"></i> Save Changes</button>
                                    <button class="btn btn-sm btn-secondary ms-2 d-none" id="btn-remove-cancel" onclick="cancelEditModeTable('remove')"><i class="bi bi-x-lg"></i> Cancel</button>
                                    <button class="btn btn-circle btn-success d-none" id="add-row-remove" onclick="addEmptyRowTable('remove')" title="Add Row"><i class="bi bi-plus-lg"></i></button>
                                </div>
                            </div>
                            <table class="table table-hover table-bordered table-sm">
                                <thead class="table-light">
                                    <tr>
                                        <th class="delete-col-remove" style="width: 40px; display: none;"><i class="bi bi-trash"></i></th>
                                        <th>Date</th>
                                        <th>Engine SN</th>
                                        <th>Removed From (AC)</th>
                                        <th>Sent To (Loc)</th>
                                        <th>Reason / Remarks</th>
                                    </tr>
                                </thead>
                                <tbody id="remove-history-body"></tbody>
                            </table>
                        </div>
                    </div>
                </div>    

                <!-- Tab Entry -->
                <div id="tab-rem-entry" style="display: none;">
                    <div class="row">
                        <div class="col-md-8">
                            <div class="card shadow-sm border-0">
                                <div class="card-header bg-white fw-bold text-danger">Remove Engine from Wing</div>
                                <div class="card-body">
                                    <form id="form-remove">
                                        <div class="row mb-3">
                                            <div class="col-md-4">
                                                <label class="form-label small fw-bold">Date <span class="text-danger">*</span></label>
                                                <input type="date" class="form-control" id="rem-date" required>
                                            </div>
                                            <div class="col-md-4">
                                                <label class="form-label small fw-bold">Engine (On Wing) <span class="text-danger">*</span></label>
                                                <input class="form-control" list="engine-options-rem" id="rem-engine-input" placeholder="Select Installed Engine..." required>
                                                <datalist id="engine-options-rem"></datalist>
                                                <input type="hidden" id="rem-engine-id">
                                            </div>
                                            <div class="col-md-4">
                                                <label class="form-label small fw-bold">Current Position</label>
                                                <input type="text" class="form-control" id="rem-loc-from">
                                            </div>
                                        </div>

                                        <div class="row mb-3">
                                            <div class="col-md-6">
                                                <label class="form-label small fw-bold">From A/C <span class="text-danger">*</span></label>
                                                <select class="form-select" id="rem-aircraft" required disabled>
                                                    <option value="" selected>Select engine first...</option>
                                                </select>
                                                <small class="text-muted">Автоматически определяется по двигателю</small>
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label small fw-bold">Send To (Location) <span class="text-danger">*</span></label>
                                                <select class="form-select" id="rem-dest" required></select>
                                            </div>
                                        </div>

                                        <div class="row mb-3">
                                            <div class="col-md-12">
                                                <label class="form-label small fw-bold">Reason</label>
                                                <input type="text" class="form-control" id="rem-reason" placeholder="e.g. End of Lease, Repair...">
                                            </div>
                                        </div>

                                        <div class="d-flex justify-content-end gap-2">
                                            <button type="button" class="btn btn-light border" onclick="switchRemoveTab('info')">Cancel</button>
                                            <button type="button" class="btn btn-danger px-4" onclick="submitRemoveForm()">Confirm Removal</button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 5. ENGINE REPORTS VIEW -->
            <div id="view-engine-reports" style="display: none;">
                <h4 class="mb-3 text-info"><i class="bi bi-clock-history"></i> Engine Reports - Full History</h4>
                <p class="text-muted">Click on any engine to view its complete history timeline (installations, removals, repairs, parts, utilization).</p>
                
                <div class="card shadow-sm">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <div class="input-group" style="max-width: 300px;">
                                <span class="input-group-text bg-white text-muted"><i class="bi bi-search"></i></span>
                                <input type="text" class="form-control border-start-0 ps-0" id="engine-reports-search" placeholder="Search engine..." onkeyup="filterTable('engine-reports-body', 'engine-reports-search')">
                            </div>
                            <a href="#" class="btn btn-sm btn-primary" onclick="loadEngineReportsList(); return false;" role="button"><i class="bi bi-arrow-clockwise"></i> Refresh</a>
                        </div>
                        
                        <table class="table table-hover table-bordered table-sm">
                            <thead class="table-light">
                                <tr>
                                    <th style="width: 50px;">#</th>
                                    <th>Original S/N</th>
                                    <th>Current S/N</th>
                                    <th>Status</th>
                                    <th>Aircraft</th>
                                    <th>Location</th>
                                    <th>TT</th>
                                    <th>TC</th>
                                    <th style="width: 120px;">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="engine-reports-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- 6. BORESCOPE VIEW -->
            <div id="view-borescope" style="display: none;">
                <h4 class="mb-3 text-info"><i class="bi bi-camera-video"></i> Borescope Inspections</h4>
                
                <ul class="nav nav-tabs mb-4">
                    <li class="nav-item">
                        <button class="nav-link active" id="tab-bore-info-btn" onclick="switchBoroscopeTab('info')">История инспекций</button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link" id="tab-bore-entry-btn" onclick="switchBoroscopeTab('entry')">Внести данные</button>
                    </li>
                </ul>

                <!-- TAB 1: History -->
                <div id="tab-bore-info">
                    <div class="card shadow-sm">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <div class="input-group" style="max-width: 300px;">
                                    <span class="input-group-text bg-white text-muted"><i class="bi bi-search"></i></span>
                                    <input type="text" class="form-control border-start-0 ps-0" id="bore-search-input" placeholder="Search..." onkeyup="filterTable('borescope-history-body', 'bore-search-input')">
                                </div>
                                
                                <div>
                                    <a href="#" class="btn btn-sm btn-primary" onclick="loadBoroscopeHistory(); return false;" role="button"><i class="bi bi-arrow-clockwise"></i> Refresh</a>
                                    <button class="btn btn-sm btn-warning ms-2" id="btn-borescope-edit" onclick="toggleEditModeTable('borescope')"><i class="bi bi-pencil-square"></i> Edit</button>
                                    <button class="btn btn-sm btn-success ms-2 d-none" id="btn-borescope-save" onclick="saveEditModeTable('borescope')"><i class="bi bi-check-lg"></i> Save Changes</button>
                                    <button class="btn btn-sm btn-secondary ms-2 d-none" id="btn-borescope-cancel" onclick="cancelEditModeTable('borescope')"><i class="bi bi-x-lg"></i> Cancel</button>
                                    <button class="btn btn-circle btn-success d-none" id="add-row-borescope" onclick="addEmptyRowTable('borescope')" title="Add Row"><i class="bi bi-plus-lg"></i></button>
                                </div>
                            </div>
                            <table class="table table-hover table-bordered table-sm">
                                <thead class="table-light">
                                    <tr>
                                        <th class="delete-col-borescope" style="width: 40px; display: none;"><i class="bi bi-trash"></i></th>
                                        <th>Дата</th>
                                        <th>Самолет</th>
                                        <th>Серийник</th>
                                        <th>Позиция</th>
                                        <th>GSS ID</th>
                                        <th>Кем выполнен</th>
                                        <th>Документ Link</th>
                                    </tr>
                                </thead>
                                <tbody id="borescope-history-body"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- TAB 2: Entry -->
                <div id="tab-bore-entry" style="display: none;">
                    <div class="row">
                        <div class="col-md-8">
                            <div class="card shadow-sm border-0">
                                <div class="card-header bg-white fw-bold text-info">New Borescope Inspection</div>
                                <div class="card-body">
                                    <form id="form-borescope">
                                        <div class="row mb-3">
                                            <div class="col-md-4">
                                                <label class="form-label small fw-bold">Дата <span class="text-danger">*</span></label>
                                                <input type="date" class="form-control" id="bore-date" required>
                                            </div>
                                            <div class="col-md-4">
                                                <label class="form-label small fw-bold">Самолет <span class="text-danger">*</span></label>
                                                <select class="form-select" id="bore-aircraft" required>
                                                    <option value="">Выберите...</option>
                                                </select>
                                            </div>
                                            <div class="col-md-4">
                                                <label class="form-label small fw-bold">Серийник <span class="text-danger">*</span></label>
                                                <input type="text" class="form-control" id="bore-serial" placeholder="Engine S/N" required>
                                            </div>
                                        </div>

                                        <div class="row mb-3">
                                            <div class="col-md-4">
                                                <label class="form-label small fw-bold">Позиция <span class="text-danger">*</span></label>
                                                <select class="form-select" id="bore-position" required>
                                                    <option value="">Выберите...</option>
                                                    <option value="1">Позиция 1</option>
                                                    <option value="2">Позиция 2</option>
                                                    <option value="3">Позиция 3</option>
                                                    <option value="4">Позиция 4</option>
                                                </select>
                                            </div>
                                            <div class="col-md-4">
                                                <label class="form-label small fw-bold">GSS ID</label>
                                                <input type="text" class="form-control" id="bore-gss" placeholder="GSS-xxxxx">
                                            </div>
                                            <div class="col-md-4">
                                                <label class="form-label small fw-bold">Кем выполнен <span class="text-danger">*</span></label>
                                                <input type="text" class="form-control" id="bore-inspector" placeholder="Inspector name" required>
                                            </div>
                                        </div>

                                        <div class="mb-4">
                                            <label class="form-label small fw-bold">Документ Link</label>
                                            <input type="url" class="form-control" id="bore-link" placeholder="https://...">
                                            <small class="text-muted">Ссылка на боре-скоп репорт</small>
                                        </div>

                                        <div class="d-flex justify-content-end gap-2">
                                            <button type="button" class="btn btn-light border" onclick="switchBoroscopeTab('info')">Cancel</button>
                                            <button type="button" class="btn btn-info px-4" onclick="submitBoroscopeForm()">Save Inspection</button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 6. PURCHASE ORDERS VIEW -->
            <div id="view-purchase-orders" style="display: none;">
                <h4 class="mb-3 text-success"><i class="bi bi-receipt"></i> Purchase Orders</h4>
                
                <ul class="nav nav-tabs mb-4">
                    <li class="nav-item">
                        <button class="nav-link active" id="tab-po-info-btn" onclick="switchPurchaseOrdersTab('info')">Order History</button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link" id="tab-po-entry-btn" onclick="switchPurchaseOrdersTab('entry')">Add Entry</button>
                    </li>
                </ul>

                <!-- TAB 1: History -->
                <div id="tab-po-info">
                    <div class="card shadow-sm">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <div class="input-group" style="max-width: 300px;">
                                    <span class="input-group-text bg-white text-muted"><i class="bi bi-search"></i></span>
                                    <input type="text" class="form-control border-start-0 ps-0" id="po-search-input" placeholder="Search..." onkeyup="filterTable('purchase-orders-history-body', 'po-search-input')">
                                </div>
                                
                                <div>
                                    <a href="#" class="btn btn-sm btn-primary" onclick="loadPurchaseOrdersHistory(); return false;" role="button"><i class="bi bi-arrow-clockwise"></i> Refresh</a>
                                    <button class="btn btn-sm btn-warning ms-2" id="btn-purchase-orders-edit" onclick="toggleEditModeColumnHeaders('purchase-orders')"><i class="bi bi-pencil-square"></i> Edit</button>
                                    <button class="btn btn-sm btn-success ms-2 d-none" id="btn-purchase-orders-save" onclick="saveColumnHeaders('purchase-orders')"><i class="bi bi-check-lg"></i> Save Changes</button>
                                    <button class="btn btn-sm btn-secondary ms-2 d-none" id="btn-purchase-orders-cancel" onclick="cancelColumnHeaders('purchase-orders')"><i class="bi bi-x-lg"></i> Cancel</button>
                                </div>
                            </div>
                            <div style="overflow-x: auto; max-width: 100%; width: 100%;">
                            <table class="table table-hover table-bordered table-sm" style="white-space: nowrap;">
                                <thead class="table-light">
                                    <tr>
                                        <th class="delete-col-purchase-orders" style="width: 40px; display: none;"><i class="bi bi-trash"></i></th>
                                        <th>Date</th>
                                        <th>Item Name</th>
                                        <th>PN</th>
                                        <th>SN</th>
                                        <th>Price</th>
                                        <th>Purchase Purpose</th>
                                        <th>Aircraft</th>
                                        <th>RO#</th>
                                        <th>Link</th>
                                        <th id="po-header-add-btn" style="width: 40px; text-align: center; display: none;"><button class="btn btn-sm btn-success" title="Add new column"><i class="bi bi-plus-circle-fill"></i></button></th>
                                    </tr>
                                </thead>
                                <tbody id="purchase-orders-history-body"></tbody>
                            </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- TAB 2: Entry -->
                <div id="tab-po-entry" style="display: none;">
                    <div class="row">
                        <div class="col-md-8">
                            <div class="card shadow-sm border-0">
                                <div class="card-header bg-white fw-bold text-success">New Purchase Order</div>
                                <div class="card-body">
                                    <form id="form-purchase-order">
                                        <div class="row mb-3">
                                            <div class="col-md-4">
                                                <label class="form-label small fw-bold">Date <span class="text-danger">*</span></label>
                                                <input type="date" class="form-control" id="po-date" required>
                                            </div>
                                            <div class="col-md-8">
                                                <label class="form-label small fw-bold">Item Name <span class="text-danger">*</span></label>
                                                <input type="text" class="form-control" id="po-name" placeholder="Item name" required>
                                            </div>
                                        </div>

                                        <div class="row mb-3">
                                            <div class="col-md-4">
                                                <label class="form-label small fw-bold">PN</label>
                                                <input type="text" class="form-control" id="po-pn" placeholder="Part Number">
                                            </div>
                                            <div class="col-md-4">
                                                <label class="form-label small fw-bold">SN</label>
                                                <input type="text" class="form-control" id="po-sn" placeholder="Serial Number">
                                            </div>
                                            <div class="col-md-4">
                                                <label class="form-label small fw-bold">Price</label>
                                                <input type="number" step="0.01" class="form-control" id="po-price" placeholder="0.00">
                                            </div>
                                        </div>

                                        <div class="row mb-3">
                                            <div class="col-md-6">
                                                <label class="form-label small fw-bold">Purchase Purpose <span class="text-danger">*</span></label>
                                                <input type="text" class="form-control" id="po-purpose" placeholder="Reason / objective" required>
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label small fw-bold">Aircraft <span class="text-danger">*</span></label>
                                                <select class="form-select" id="po-aircraft" required>
                                                    <option value="">Select...</option>
                                                </select>
                                            </div>
                                        </div>

                                        <div class="row mb-3">
                                            <div class="col-md-6">
                                                <label class="form-label small fw-bold">RO# <span class="text-danger">*</span></label>
                                                <input type="text" class="form-control" id="po-ro-number" placeholder="RO-xxxxx" required>
                                                <small class="text-muted">Tracking number / approval</small>
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label small fw-bold">Link</label>
                                                <input type="url" class="form-control" id="po-link" placeholder="https://...">
                                                <small class="text-muted">Link to signed file</small>
                                            </div>
                                        </div>

                                        <div class="d-flex justify-content-end gap-2">
                                            <button type="button" class="btn btn-light border" onclick="switchPurchaseOrdersTab('info')">Cancel</button>
                                            <button type="button" class="btn btn-success px-4" onclick="submitPurchaseOrderForm()">Save Purchase Order</button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 7. REPAIR VIEW -->
            <div id="view-repair" style="display: none;">
                <h4 class="mb-3 text-warning"><i class="bi bi-wrench"></i> Repair Action</h4>
                
                <ul class="nav nav-tabs mb-4">
                    <li class="nav-item"><button class="nav-link active" id="tab-rep-info-btn" onclick="switchRepairTab('info')">История ремонтов</button></li>
                    <li class="nav-item"><button class="nav-link" id="tab-rep-entry-btn" onclick="switchRepairTab('entry')">Внести данные</button></li>
                </ul>

                <!-- TAB 1: History -->
                <div id="tab-rep-info">
                    <div class="card shadow-sm">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <!-- Поле поиска -->
                                <div class="input-group" style="max-width: 300px;">
                                    <span class="input-group-text bg-white text-muted"><i class="bi bi-search"></i></span>
                                    <input type="text" class="form-control border-start-0 ps-0" id="repair-search-input" placeholder="Search..." onkeyup="filterTable('repair-history-body', 'repair-search-input')">
                                </div>
                                
                                <!-- Кнопки -->
                                <div>
                                    <button class="btn btn-sm btn-primary" onclick="loadRepairHistory()"><i class="bi bi-arrow-clockwise"></i> Refresh</button>
                                    <button class="btn btn-sm btn-warning ms-2" id="btn-repair-edit" onclick="toggleEditModeTable('repair')"><i class="bi bi-pencil-square"></i> Edit</button>
                                    <button class="btn btn-sm btn-success ms-2 d-none" id="btn-repair-save" onclick="saveEditModeTable('repair')"><i class="bi bi-check-lg"></i> Save Changes</button>
                                    <button class="btn btn-sm btn-secondary ms-2 d-none" id="btn-repair-cancel" onclick="cancelEditModeTable('repair')"><i class="bi bi-x-lg"></i> Cancel</button>
                                    <button class="btn btn-circle btn-success d-none" id="add-row-repair" onclick="addEmptyRowTable('repair')" title="Add Row"><i class="bi bi-plus-lg"></i></button>
                                </div>
                            </div>
                            <table class="table table-hover table-bordered table-sm text-center">
                                <thead class="table-light">
                                    <tr>
                                        <th class="delete-col-repair" style="width: 40px; display: none;"><i class="bi bi-trash"></i></th>
                                        <th>Date</th><th>Engine</th><th>Vendor (Shop)</th><th>WO / Doc</th><th>TT / TC</th><th>Photo</th><th>Remarks</th>
                                    </tr>
                                </thead>
                                <tbody id="repair-history-body"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- TAB 2: Entry -->
                <div id="tab-rep-entry" style="display: none;">
                    <div class="card shadow-sm border-0">
                        <div class="card-header bg-white fw-bold text-warning">Record Repair Event</div>
                        <div class="card-body">
                            <form id="form-repair">
                                <div class="row mb-3">
                                    <div class="col-md-3">
                                        <label class="small fw-bold">Date *</label>
                                        <input type="date" class="form-control" id="rep-date" required>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="small fw-bold">Orig. SN *</label>
                                        <input class="form-control" list="engine-options-rep" id="rep-engine-input" placeholder="Search..." required>
                                        <datalist id="engine-options-rep"></datalist>
                                        <input type="hidden" id="rep-engine-id">
                                    </div>
                                    <div class="col-md-3">
                                        <label class="small fw-bold">Current SN</label>
                                        <input type="text" class="form-control" id="rep-cur-sn" readonly>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="small fw-bold">Current Status</label>
                                        <input type="text" class="form-control" id="rep-status-view" readonly>
                                    </div>
                                </div>

                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label class="small fw-bold">Vendor (Location/Shop) *</label>
                                        <input type="text" class="form-control" id="rep-vendor" placeholder="e.g. Lufthansa Technik">
                                    </div>
                                    <div class="col-md-3">
                                        <label class="small fw-bold">TT (Confirmed)</label>
                                        <input type="number" step="0.1" class="form-control" id="rep-tt">
                                    </div>
                                    <div class="col-md-3">
                                        <label class="small fw-bold">TC (Confirmed)</label>
                                        <input type="number" class="form-control" id="rep-tc">
                                    </div>
                                </div>

                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label class="small fw-bold">Work Order #</label>
                                        <input type="text" class="form-control" id="rep-wo" placeholder="WO-123456">
                                    </div>
                                    <div class="col-md-6">
                                        <label class="small fw-bold">Photo Link</label>
                                        <input type="text" class="form-control" id="rep-photo" placeholder="http://...">
                                    </div>
                                </div>

                                <div class="mb-4">
                                    <label class="small fw-bold">Remarks</label>
                                    <textarea class="form-control" id="rep-rem" rows="2"></textarea>
                                </div>

                                <div class="d-flex justify-content-end gap-2">
                                    <button type="button" class="btn btn-light border" onclick="switchRepairTab('info')">Cancel</button>
                                    <button type="button" class="btn btn-warning px-4" onclick="submitRepairForm()">Save (Set SV)</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>   
           <!-- 10. PARTS VIEW -->
            <div id="view-parts" style="display: none;">
                <h4 class="mb-3 text-secondary"><i class="bi bi-box-seam"></i> Parts Management</h4>
                
                <ul class="nav nav-tabs mb-4">
                    <li class="nav-item"><button class="nav-link active" id="tab-parts-list-btn" onclick="switchPartsTab('list')"><span data-parts-title="logistics">Parts Logistics</span></button></li>
                    <li class="nav-item"><button class="nav-link" id="tab-parts-add-btn" onclick="switchPartsTab('add')">Внести данные (Action)</button></li>
                </ul>

                <!-- TAB 1: STORE BALANCE / HISTORY -->
                <div id="tab-parts-list">
                    <div class="card shadow-sm">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <!-- Поле поиска -->
                                <div class="input-group" style="max-width: 300px;">
                                    <span class="input-group-text bg-white text-muted"><i class="bi bi-search"></i></span>
                                    <input type="text" class="form-control border-start-0 ps-0" id="parts-search-input" placeholder="Search..." onkeyup="filterTable('parts-history-body', 'parts-search-input')">
                                </div>
                                
                                <!-- Кнопки -->
                                <div>
                                    <button class="btn btn-sm btn-primary" onclick="loadPartsHistory()"><i class="bi bi-arrow-clockwise"></i> Refresh</button>
                                    <button class="btn btn-sm btn-warning ms-2" id="btn-parts-edit" onclick="toggleEditModeTable('parts')"><i class="bi bi-pencil-square"></i> Edit</button>
                                    <button class="btn btn-sm btn-success ms-2 d-none" id="btn-parts-save" onclick="saveEditModeTable('parts')"><i class="bi bi-check-lg"></i> Save Changes</button>
                                    <button class="btn btn-sm btn-secondary ms-2 d-none" id="btn-parts-cancel" onclick="cancelEditModeTable('parts')"><i class="bi bi-x-lg"></i> Cancel</button>
                                    <button class="btn btn-circle btn-success d-none ms-2" id="add-row-parts" onclick="addEmptyRowTable('parts')" title="Add Row"><i class="bi bi-plus-lg"></i></button>
                                </div>
                            </div>
                            <div class="table-responsive">
                                <table class="table table-hover table-bordered table-sm" style="font-size: 0.85rem;">
                                    <thead class="table-light">
                                        <tr>
                                            <th class="delete-col-parts" style="width: 40px; display: none;"><i class="bi bi-trash"></i></th>
                                            <th>Date</th>
                                            <th>Action</th>
                                            <th>Part Name</th>
                                            <th>P/N</th>
                                            <th>S/N</th>
                                            <th>QTY</th>
                                            <th>From (Orig/GSS)</th>
                                            <th>To (Orig/GSS)</th>
                                            <th>Location</th>
                                            <th>Reason</th>
                                        </tr>
                                    </thead>
                                    <tbody id="parts-history-body"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- TAB 2: ADD PART ACTION -->
                <div id="tab-parts-add" style="display: none;">
                    <div class="card shadow-sm border-0">
                        <div class="card-header bg-white fw-bold">Parts Movement</div>
                        <div class="card-body">
                            <form id="form-parts">
                                <div class="row mb-3">
                                    <div class="col-md-3">
                                        <label class="small fw-bold">Date *</label>
                                        <input type="date" class="form-control" id="part-date">
                                    </div>
                                    <div class="col-md-3">
                                        <label class="small fw-bold">Action *</label>
                                        <select class="form-select" id="part-action" onchange="updatePartFormFields()">
                                            <option value="" selected disabled>Select Action...</option>
                                            <option value="INSTALLED">INSTALLED</option>
                                            <option value="REMOVED">REMOVED</option>
                                            <option value="SWAP">SWAP</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="small fw-bold">Part Name *</label>
                                        <input type="text" class="form-control" id="part-name" list="part-name-options" autocomplete="off" oninput="updatePartPNFromName()">
                                        <datalist id="part-name-options"></datalist>
                                    </div>
                                </div>

                                <div class="row mb-3">
                                    <div class="col-md-4"><label class="small fw-bold">P/N *</label><input type="text" class="form-control" id="part-pn" list="part-pn-options" autocomplete="off"><datalist id="part-pn-options"></datalist></div>
                                    <div class="col-md-4"><label class="small fw-bold">S/N *</label><input type="text" class="form-control" id="part-sn"></div>
                                    <div class="col-md-2"><label class="small fw-bold">QTY</label><input type="number" class="form-control" id="part-qty" value="1"></div>
                                    <div class="col-md-2"><label class="small fw-bold">Location</label><input type="text" class="form-control" id="part-loc" placeholder="City/Shop"></div>
                                </div>

                                <!-- DYNAMIC FIELDS (FROM / TO) -->
                                <div class="row mb-3" id="part-dynamic-fields" style="background: #f8f9fa; padding: 10px; border-radius: 5px;">
                                    <p class="small text-muted mb-2">Select Action to see fields</p>
                                </div>

                                <div class="mb-3">
                                    <label class="small fw-bold">Reason / Remarks</label>
                                    <textarea class="form-control" id="part-rem" rows="2"></textarea>
                                </div>

                                <div class="d-flex justify-content-end">
                                    <button type="button" class="btn btn-secondary me-2" onclick="switchPartsTab('list')">Cancel</button>
                                    <button type="button" class="btn btn-primary px-4" onclick="submitPartForm()">Save Record</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>  
            <!-- 10B. STORE BALANCE VIEW -->
            <div id="view-store-balance" style="display: none;">
                <h4 class="mb-3 text-primary"><i class="bi bi-collection"></i> <span data-parts-title="store">Store Balance</span></h4>

                <ul class="nav nav-tabs mb-4">
                    <li class="nav-item"><button class="nav-link active" id="tab-store-list-btn" onclick="switchStoreBalanceTab('list')">Inventory</button></li>
                    <li class="nav-item"><button class="nav-link" id="tab-store-add-btn" onclick="switchStoreBalanceTab('add')">Add Item</button></li>
                </ul>

                <!-- TAB 1: INVENTORY -->
                <div id="tab-store-list">
                    <div class="card shadow-sm">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <div class="input-group" style="max-width: 300px;">
                                    <span class="input-group-text bg-white text-muted"><i class="bi bi-search"></i></span>
                                    <input type="text" class="form-control border-start-0 ps-0" id="store-search-input" placeholder="Search..." onkeyup="filterTable('store-balance-body', 'store-search-input')">
                                </div>
                                <div>
                                    <button class="btn btn-sm btn-primary" onclick="loadStoreBalance()"><i class="bi bi-arrow-clockwise"></i> Refresh</button>
                                    <button class="btn btn-sm btn-warning ms-2" id="btn-store-balance-edit" onclick="toggleEditModeTable('store-balance')"><i class="bi bi-pencil-square"></i> Edit</button>
                                    <button class="btn btn-sm btn-success ms-2 d-none" id="btn-store-balance-save" onclick="saveEditModeTable('store-balance')"><i class="bi bi-check-lg"></i> Save Changes</button>
                                    <button class="btn btn-sm btn-secondary ms-2 d-none" id="btn-store-balance-cancel" onclick="cancelEditModeTable('store-balance')"><i class="bi bi-x-lg"></i> Cancel</button>
                                    <button class="btn btn-circle btn-success d-none ms-2" id="add-row-store-balance" onclick="addEmptyRowTable('store-balance')" title="Add Row"><i class="bi bi-plus-lg"></i></button>
                                </div>
                            </div>
                            <div class="table-responsive">
                                <table class="table table-hover table-bordered table-sm align-middle" style="font-size: 0.85rem;">
                                    <thead class="table-light">
                                        <tr>
                                            <th class="delete-col-store-balance" style="width: 40px; display: none;"><i class="bi bi-trash"></i></th>
                                            <th>Received</th>
                                            <th>Part Name</th>
                                            <th>P/N</th>
                                            <th>S/N</th>
                                            <th>Condition</th>
                                            <th>Qty</th>
                                            <th>R.O#</th>
                                            <th>Location</th>
                                            <th>Status</th>
                                            <th>Delivered to</th>
                                            <th>Remarks</th>
                                        </tr>
                                    </thead>
                                    <tbody id="store-balance-body"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- TAB 2: ADD ITEM -->
                <div id="tab-store-add" style="display: none;">
                    <div class="card shadow-sm border-0">
                        <div class="card-header bg-white fw-bold text-primary">Register Store Item</div>
                        <div class="card-body">
                            <form id="form-store-part">
                                <div class="row mb-3">
                                    <div class="col-md-3">
                                        <label class="small fw-bold">Received Date</label>
                                        <input type="date" class="form-control" id="store-date">
                                    </div>
                                    <div class="col-md-5">
                                        <label class="small fw-bold">Part Name *</label>
                                        <input type="text" class="form-control" id="store-name" placeholder="e.g. Fuel Pump">
                                    </div>
                                    <div class="col-md-4">
                                        <label class="small fw-bold">Part Number (P/N) *</label>
                                        <input type="text" class="form-control" id="store-pn" placeholder="123-456-789">
                                    </div>
                                </div>

                                <div class="row mb-3">
                                    <div class="col-md-4">
                                        <label class="small fw-bold">Serial Number (S/N)</label>
                                        <input type="text" class="form-control" id="store-sn" placeholder="Optional">
                                    </div>
                                    <div class="col-md-3">
                                        <label class="small fw-bold">Condition</label>
                                        <select class="form-control" id="store-condition">
                                            <option value="">-- Select --</option>
                                            <option value="SV - NGV (SENT)">SV - NGV (SENT)</option>
                                            <option value="UNDER REPAIRING">UNDER REPAIRING</option>
                                            <option value="Delivered in Roma Italy">Delivered in Roma Italy</option>
                                            <option value="NO CAPABILITY">NO CAPABILITY</option>
                                            <option value="US - SHJ">US - SHJ</option>
                                        </select>
                                    </div>
                                    <div class="col-md-2">
                                        <label class="small fw-bold">Quantity *</label>
                                        <input type="number" class="form-control" id="store-qty" value="1" min="0">
                                    </div>
                                    <div class="col-md-3">
                                        <label class="small fw-bold">R.O#</label>
                                        <input type="text" class="form-control" id="store-unit" placeholder="EA / SET / KIT">
                                    </div>
                                </div>

                                <div class="row mb-3">
                                    <div class="col-md-4">
                                        <label class="small fw-bold">Location</label>
                                        <input type="text" class="form-control" id="store-location" placeholder="Warehouse / City">
                                    </div>
                                    <div class="col-md-4">
                                        <label class="small fw-bold">Status</label>
                                        <input type="text" class="form-control" id="store-shelf" placeholder="Aisle / Rack">
                                    </div>
                                    <div class="col-md-4">
                                        <label class="small fw-bold">Delivered to</label>
                                        <input type="text" class="form-control" id="store-owner" placeholder="Customer / Tail">
                                    </div>
                                </div>

                                <div class="mb-4">
                                    <label class="small fw-bold">Remarks</label>
                                    <textarea class="form-control" id="store-remarks" rows="2" placeholder="Notes..."></textarea>
                                </div>

                                <div class="d-flex justify-content-end gap-2">
                                    <button type="button" class="btn btn-light border" onclick="switchStoreBalanceTab('list')">Cancel</button>
                                    <button type="button" class="btn btn-primary px-4" onclick="submitStoreBalanceForm()">Save Item</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
            <!-- 11. ATLB VIEW (UTILIZATION) -->
            <div id="view-atlb" style="display: none;">
                <h4 class="mb-3 text-info"><i class="bi bi-journal-richtext"></i> Aircraft Technical Log Book</h4>
                
                <ul class="nav nav-tabs mb-4">
                    <li class="nav-item"><button class="nav-link active" id="tab-atlb-entry-btn" onclick="switchAtlbTab('entry')">Внести данные</button></li>
                    <li class="nav-item"><button class="nav-link" id="tab-atlb-list-btn" onclick="switchAtlbTab('list')">Utilization Table</button></li>
                </ul>

                <!-- TAB 1: ENTRY FORM -->
                <div id="tab-atlb-entry">
                    <div class="card shadow-sm border-0">
                        <div class="card-body" style="background-color: #f8f9fa;">
                            
                            <form id="form-atlb">
                                <!-- HEADER: AC INFO -->
                                <div class="row mb-3">
                                    <div class="col-md-3">
                                        <label class="small fw-bold">A/C Reg No</label>
                                        <select class="form-select" id="atlb-ac" onchange="updateAcInfo()"></select>
                                    </div>
                                    <div class="col-md-2">
                                        <label class="small fw-bold">A/C MSN</label>
                                        <input type="text" class="form-control bg-light" id="atlb-msn" readonly>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="small fw-bold">Current TTSN / TCSN</label>
                                        <input type="text" class="form-control bg-light text-center fw-bold" id="atlb-stats" readonly>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="border p-2 bg-white rounded">
                                            <div class="text-muted small mb-1">Last data</div>
                                            <div class="d-flex gap-2">
                                                <input type="text" class="form-control form-control-sm" id="atlb-last-date" placeholder="Last Date" readonly>
                                                <input type="text" class="form-control form-control-sm" id="atlb-last-sheet" placeholder="Last Sheet" readonly>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                
                                <!-- ROW 2: DATE, ROUTE & CHECKBOXES -->
                                <div class="row mb-3 align-items-end">
                                    <div class="col-md-2">
                                        <label class="small fw-bold">Date</label>
                                        <input type="date" class="form-control" id="atlb-date">
                                    </div>
                                    <div class="col-md-2">
                                        <label class="small fw-bold">ATLB Sheet No</label>
                                        <input type="text" class="form-control" id="atlb-no" list="atlb-no-suggestions">
                                        <datalist id="atlb-no-suggestions"></datalist>
                                    </div>
                                    
                                    <!-- Flight Leg теперь просто поля, на одном уровне -->
                                    <div class="col-md-2">
                                        <label class="small fw-bold">From</label>
                                        <input type="text" class="form-control" id="atlb-from" placeholder="ICAO">
                                    </div>
                                    <div class="col-md-2">
                                        <label class="small fw-bold">To</label>
                                        <input type="text" class="form-control" id="atlb-to" placeholder="ICAO">
                                    </div>

                                    <!-- Чекбоксы -->
                                    <div class="col-md-4">
                                        <div class="d-flex gap-3 pb-2"> <!-- pb-2 для выравнивания с инпутами -->
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="atlb-cancel">
                                                <label class="form-check-label small">Cancelled</label>
                                            </div>
                                            <div class="form-check">
                                                <!-- Добавили Maintenance Only с функцией блокировки -->
                                                <input class="form-check-input" type="checkbox" id="atlb-maint-only" onchange="toggleFlightTimes()">
                                                <label class="form-check-label small fw-bold text-danger">Maintenance Only</label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                    
                                </div>

                                <!-- ROW 3: TIMES (BLOCK & FLIGHT) -->
                                <div class="row mb-3">
                                    <!-- BLOCK TIME -->
                                    <div class="col-md-6">
                                        <div class="border p-3 bg-white rounded">
                                            <h6 class="small fw-bold border-bottom pb-1 mb-2">Block Time</h6>
                                            <div class="row g-2">
                                                <div class="col-4">
                                                    <label class="small text-muted">Out (HH:MM)</label>
                                                    <input type="time" class="form-control" id="time-out" onchange="calcTime('block')">
                                                </div>
                                                <div class="col-4">
                                                    <label class="small text-muted">In (HH:MM)</label>
                                                    <input type="time" class="form-control" id="time-in" onchange="calcTime('block')">
                                                </div>
                                                <div class="col-4">
                                                    <label class="small text-primary fw-bold">Time</label>
                                                    <input type="text" class="form-control border-primary fw-bold" id="time-block-res" readonly>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- FLIGHT TIME -->
                                    <div class="col-md-6">
                                        <div class="border p-3 bg-white rounded">
                                            <h6 class="small fw-bold border-bottom pb-1 mb-2">Flight Time</h6>
                                            <div class="row g-2">
                                                <div class="col-4">
                                                    <label class="small text-muted">Off (HH:MM)</label>
                                                    <input type="time" class="form-control" id="time-off" onchange="calcTime('flight')">
                                                </div>
                                                <div class="col-4">
                                                    <label class="small text-muted">On (HH:MM)</label>
                                                    <input type="time" class="form-control" id="time-on" onchange="calcTime('flight')">
                                                </div>
                                                <div class="col-4">
                                                    <label class="small text-success fw-bold">Time</label>
                                                    <input type="text" class="form-control border-success fw-bold" id="time-flight-res" readonly>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- ROW 4: MAINTENANCE & CYCLES -->
                                <div class="row mb-3">
                                    <div class="col-md-8">
                                        <div class="border p-2 bg-white rounded">
                                            <label class="small fw-bold">Maintenance</label>
                                            <select class="form-select" id="atlb-maint">
                                                <option value="">Select...</option>
                                                <option>Daily Check</option>
                                                <option>PF Check</option>
                                                <option>TR Check</option>
                                                <option>Daily & PF/TR Check</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                     
                                </div>

                                <!-- ROW 5: FLUIDS -->
                                <div class="row mb-4">
                                    <div class="col-md-6">
                                        <div class="border p-2 bg-white rounded">
                                            <label class="small fw-bold">Oil Uplift</label>
                                            <div class="d-flex gap-2">
                                                <input type="number" class="form-control form-control-sm" placeholder="Eng 1" id="oil-1">
                                                <input type="number" class="form-control form-control-sm" placeholder="Eng 2" id="oil-2">
                                                <input type="number" class="form-control form-control-sm" placeholder="Eng 3" id="oil-3">
                                                <input type="number" class="form-control form-control-sm" placeholder="Eng 4" id="oil-4">
                                                <input type="number" class="form-control form-control-sm" placeholder="APU" id="oil-apu">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="border p-2 bg-white rounded">
                                            <label class="small fw-bold">Hydraulic Uplift</label>
                                            <div class="d-flex gap-2">
                                                <input type="number" class="form-control form-control-sm" placeholder="Sys 1" id="hyd-1">
                                                <input type="number" class="form-control form-control-sm" placeholder="Sys 2" id="hyd-2">
                                                <input type="number" class="form-control form-control-sm" placeholder="Sys 3" id="hyd-3">
                                                <input type="number" class="form-control form-control-sm" placeholder="Sys 4" id="hyd-4">
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="d-flex justify-content-between">
                                    <button type="button" class="btn btn-outline-secondary" onclick="switchAtlbTab('list')">Show utilization table</button>
                                    <div>
                                        <button type="button" class="btn btn-light border me-2">Clear</button>
                                        <button type="button" class="btn btn-success px-5" onclick="submitAtlbForm()">SAVE</button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- TAB 2: LIST -->
                <div id="tab-atlb-list" style="display: none;">
                    <div class="card shadow-sm">
                        <div class="card-body">
                            <div class="d-flex justify-content-end mb-2">
                                <button class="btn btn-success btn-sm me-2"><i class="bi bi-file-earmark-excel"></i> Export Excel</button>
                                <button class="btn btn-primary btn-sm" onclick="loadAtlbHistory()">Refresh</button>
                            </div>
                            <div class="table-responsive">
                                <table class="table table-bordered table-hover table-sm text-center" style="font-size: 0.8rem;">
                                    <thead class="table-secondary align-middle">
                                        <tr>
                                            <th rowspan="2" data-col="date">Date 
                                                <i class="bi bi-funnel-fill filter-icon" id="filter-icon-atlb-date" data-bs-toggle="dropdown"></i>
                                                <div class="dropdown-menu filter-dropdown-menu" id="filter-menu-atlb-date"></div>
                                            </th>
                                            <th rowspan="2" data-col="tail">A/C 
                                                <i class="bi bi-funnel-fill filter-icon" id="filter-icon-atlb-tail" data-bs-toggle="dropdown"></i>
                                                <div class="dropdown-menu filter-dropdown-menu" id="filter-menu-atlb-tail"></div>
                                            </th>
                                            <th rowspan="2" data-col="ref">ATLB Sheet 
                                                <i class="bi bi-funnel-fill filter-icon" id="filter-icon-atlb-ref" data-bs-toggle="dropdown"></i>
                                                <div class="dropdown-menu filter-dropdown-menu" id="filter-menu-atlb-ref"></div>
                                            </th>
                                            <th rowspan="2" data-col="route">Flight Leg 
                                                <i class="bi bi-funnel-fill filter-icon" id="filter-icon-atlb-route" data-bs-toggle="dropdown"></i>
                                                <div class="dropdown-menu filter-dropdown-menu" id="filter-menu-atlb-route"></div>
                                            </th>
        
                                            <th colspan="3">Block Time</th>
                                            <th colspan="3">Flight Time</th>

        
                                            <th rowspan="2" data-col="cycles">Cycles 
                                                <i class="bi bi-funnel-fill filter-icon" id="filter-icon-atlb-cycles" data-bs-toggle="dropdown"></i>
                                                <div class="dropdown-menu filter-dropdown-menu" id="filter-menu-atlb-cycles"></div>
                                            </th>
                                            <th rowspan="2">TTSN</th>
                                            <th rowspan="2">TCSN</th>
                                            <th colspan="5">Oil Service</th>
                                            <th colspan="4">Hyd Service</th>
                                            <th rowspan="2">Maintenance</th>
                                            <th rowspan="2" data-col="user">User 
                                                <i class="bi bi-funnel-fill filter-icon" id="filter-icon-atlb-user" data-bs-toggle="dropdown"></i>
                                                <div class="dropdown-menu filter-dropdown-menu" id="filter-menu-atlb-user"></div>
                                            </th>
                                        </tr>
                                        <tr>
                                            <th>Out</th>
                                            <th>In</th>
                                            <th>Time</th>
                                            <th>Off</th>
                                            <th>On</th>
                                            <th>Time</th>
                                            <th data-col="eng1">Eng1</th>
                                            <th data-col="eng2">Eng2</th>
                                            <th data-col="eng3">Eng3</th>
                                            <th data-col="eng4">Eng4</th>
                                            <th data-col="eng_apu">APU</th>
                                            <th data-col="hyd1">Hsys1</th>
                                            <th data-col="hyd2">Hsys2</th>
                                            <th data-col="hyd3">Hsys3</th>
                                            <th data-col="hyd4">Hsys4</th>
                                        </tr>
                                    </thead>
                                    <tbody id="atlb-history-body"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            <!-- 12. ENGINE PARAMETERS VIEW -->
            <div id="view-eng-param" style="display: none;">
                <h4 class="mb-3 text-info"><i class="bi bi-sliders"></i> Engine Parameters Entry</h4>
                
                <ul class="nav nav-tabs mb-4">
                    <li class="nav-item"><button class="nav-link active" id="tab-param-entry-btn" onclick="switchParamTab('entry')">Enter Parameters</button></li>
                    <li class="nav-item"><button class="nav-link" id="tab-param-history-btn" onclick="switchParamTab('history')">История</button></li>
                </ul>
                
                <!-- TAB 1: ENTRY FORM -->
                <div id="tab-param-entry">
                    <div class="card shadow-sm border-0">
                        <div class="card-body">
                            <form id="form-eng-param">
                            <!-- HEADER -->
                            <div class="row mb-4">
                                <div class="col-md-3">
                                    <label class="small fw-bold">Date *</label>
                                    <input type="date" class="form-control" id="param-date" required>
                                </div>
                                <div class="col-md-3">
                                    <label class="small fw-bold">Aircraft *</label>
                                    <select class="form-select" id="param-ac" required onchange="loadEnginePositions()">
                                        <option value="">Select A/C...</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label class="small fw-bold">Engine Position *</label>
                                    <select class="form-select" id="param-position" required>
                                        <option value="">Select position...</option>
                                        <option value="1">Position 1</option>
                                        <option value="2">Position 2</option>
                                        <option value="3">Position 3</option>
                                        <option value="4">Position 4</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label class="small fw-bold">Engine S/N</label>
                                    <input type="text" class="form-control" id="param-engine-sn" readonly placeholder="Select position first">
                                </div>
                            </div>

                            <!-- TAKEOFF SECTION -->
                            <div class="border p-3 mb-3 rounded bg-light">
                                <h6 class="text-primary fw-bold border-bottom pb-2 mb-3">Takeoff Data</h6>
                                
                                <div class="row mb-2">
                                    <div class="col-md-3">
                                        <label class="small fw-bold">Type</label>
                                        <select class="form-select" id="param-type-to" disabled>
                                            <option value="Takeoff" selected>Takeoff</option>
                                        </select>
                                    </div>
                                    
                                    <div class="col-md-9">
                                        <div class="row">
                                            <div class="col-md-3">
                                                <label class="small text-muted">N1</label>
                                                <input type="number" step="0.1" class="form-control" id="to-n1" placeholder="e.g. 95.5">
                                            </div>
                                            <div class="col-md-3">
                                                <label class="small text-muted">N2</label>
                                                <input type="number" step="0.1" class="form-control" id="to-n2" placeholder="e.g. 98.2">
                                            </div>
                                            <div class="col-md-3">
                                                <label class="small text-muted">EGT (°C)</label>
                                                <input type="number" step="1" class="form-control" id="to-egt" placeholder="e.g. 650">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- CRUISE SECTION -->
                            <div class="border p-3 mb-4 rounded bg-light">
                                <h6 class="text-success fw-bold border-bottom pb-2 mb-3">Cruise Data</h6>
                                
                                <div class="row mb-2">
                                    <div class="col-md-3">
                                        <label class="small fw-bold">Type</label>
                                        <select class="form-select" id="param-type-cr" disabled>
                                            <option value="Cruise" selected>Cruise</option>
                                        </select>
                                    </div>
                                    
                                    <div class="col-md-9">
                                        <div class="row">
                                            <div class="col-md-3">
                                                <label class="small text-muted">N1</label>
                                                <input type="number" step="0.1" class="form-control" id="cr-n1" placeholder="e.g. 85.0">
                                            </div>
                                            <div class="col-md-3">
                                                <label class="small text-muted">N2</label>
                                                <input type="number" step="0.1" class="form-control" id="cr-n2" placeholder="e.g. 92.0">
                                            </div>
                                            <div class="col-md-3">
                                                <label class="small text-muted">EGT (°C)</label>
                                                <input type="number" step="1" class="form-control" id="cr-egt" placeholder="e.g. 580">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="d-flex justify-content-end gap-2">
                                <button type="button" class="btn btn-secondary" onclick="openDashboardView()">Cancel</button>
                                <button type="button" class="btn btn-primary px-4" onclick="submitEngParams()">Save Parameters</button>
                            </div>
                        </form>
                    </div>
                </div>
                </div>
                
                <!-- TAB 2: HISTORY TABLE -->
                <div id="tab-param-history" style="display: none;">
                    <div class="card shadow-sm">
                        <div class="card-body">
                            <div class="d-flex justify-content-end mb-2">
                                <button class="btn btn-sm btn-primary" onclick="loadParameterHistory()"><i class="bi bi-arrow-clockwise"></i> Refresh</button>
                                <button class="btn btn-sm btn-warning ms-2" id="btn-param-edit" onclick="toggleEditModeTable('param')"><i class="bi bi-pencil-square"></i> Edit</button>
                                <button class="btn btn-sm btn-success ms-2 d-none" id="btn-param-save" onclick="saveEditModeTable('param')"><i class="bi bi-check-lg"></i> Save Changes</button>
                                <button class="btn btn-sm btn-secondary ms-2 d-none" id="btn-param-cancel" onclick="cancelEditModeTable('param')"><i class="bi bi-x-lg"></i> Cancel</button>
                                <button class="btn btn-circle btn-success d-none" id="add-row-param" onclick="addEmptyRowTable('param')" title="Add Row"><i class="bi bi-plus-lg"></i></button>
                            </div>
                            <table class="table table-hover table-bordered table-sm text-center" id="param-history-table">
                                <thead class="table-light">
                                    <tr>
                                        <th class="delete-col-param" style="display: none;"><i class="bi bi-trash"></i></th>
                                        <th>Date</th>
                                        <th>Aircraft</th>
                                        <th>Position</th>
                                        <th>Engine S/N</th>
                                        <th>N1 TO</th>
                                        <th>N2 TO</th>
                                        <th>EGT TO</th>
                                        <th>N1 CR</th>
                                        <th>N2 CR</th>
                                        <th>EGT CR</th>
                                        <th>Created At</th>
                                    </tr>
                                </thead>
                                <tbody id="param-history-body">
                                    <tr><td colspan="12" class="text-muted">Loading...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- UTILIZATION PARAMETERS VIEW -->
            <div id="view-utilization-param" style="display: none;">
                <h4 class="mb-3 text-info"><i class="bi bi-bar-chart-line"></i> Utilization Parameters</h4>
                
                <ul class="nav nav-tabs mb-4">
                    <li class="nav-item"><button class="nav-link active" id="tab-util-param-entry-btn" onclick="switchUtilParamTab('entry')">Внести данные</button></li>
                    <li class="nav-item"><button class="nav-link" id="tab-util-param-history-btn" onclick="switchUtilParamTab('history')">История</button></li>
                </ul>
                
                <!-- TAB 1: ENTRY FORM -->
                <div id="tab-util-param-entry">
                    <div class="card shadow-sm border-0">
                        <div class="card-body">
                            <form id="form-util-param">
                                <div class="row mb-4">
                                    <div class="col-md-3">
                                        <label class="small fw-bold">Дата *</label>
                                        <input type="date" class="form-control" id="util-param-date" required>
                                        <small class="text-muted">По умолчанию сегодняшняя дата</small>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="small fw-bold">Самолет *</label>
                                        <select class="form-select" id="util-param-ac" required>
                                            <option value="">Выберите самолет...</option>
                                            <option value="ER-BAT">ER-BAT</option>
                                            <option value="ER-BAR">ER-BAR</option>
                                            <option value="ER-BAQ">ER-BAQ</option>
                                        </select>
                                    </div>
                                    <div class="col-md-2">
                                        <label class="small fw-bold">TTSN *</label>
                                        <input type="number" step="0.1" class="form-control" id="util-param-ttsn" required placeholder="Введите TTSN">
                                    </div>
                                    <div class="col-md-2">
                                        <label class="small fw-bold">TCSN *</label>
                                        <input type="number" class="form-control" id="util-param-tcsn" required placeholder="Введите TCSN">
                                    </div>
                                    <div class="col-md-2 d-flex align-items-end">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="util-param-period" onchange="togglePeriodFields()">
                                            <label class="form-check-label fw-bold" for="util-param-period">
                                                Period
                                            </label>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- PERIOD FIELDS (initially disabled) -->
                                <div class="row mb-4" id="period-fields">
                                    <div class="col-md-6">
                                        <label class="small fw-bold">Date From</label>
                                        <input type="date" class="form-control" id="util-param-date-from" disabled>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="small fw-bold">Date To</label>
                                        <input type="date" class="form-control" id="util-param-date-to" disabled>
                                    </div>
                                </div>
                                
                                <div class="d-flex justify-content-end gap-2">
                                    <button type="button" class="btn btn-secondary" onclick="openDashboardView()">Отмена</button>
                                    <button type="button" class="btn btn-primary px-4" onclick="submitUtilParams()">Сохранить</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                
                <!-- TAB 2: HISTORY TABLE -->
                <div id="tab-util-param-history" style="display: none;">
                    <div class="card shadow-sm">
                        <div class="card-body">
                            <div class="d-flex justify-content-end mb-2">
                                <button class="btn btn-sm btn-primary" onclick="loadUtilParamHistory()"><i class="bi bi-arrow-clockwise"></i> Обновить</button>
                                <button class="btn btn-sm btn-warning ms-2" id="btn-util-param-edit" onclick="toggleEditModeTable('util-param')"><i class="bi bi-pencil-square"></i> Edit</button>
                                <button class="btn btn-sm btn-success ms-2 d-none" id="btn-util-param-save" onclick="saveEditModeTable('util-param')"><i class="bi bi-check-lg"></i> Save Changes</button>
                                <button class="btn btn-sm btn-secondary ms-2 d-none" id="btn-util-param-cancel" onclick="cancelEditModeTable('util-param')"><i class="bi bi-x-lg"></i> Cancel</button>
                                <button class="btn btn-circle btn-success d-none" id="add-row-util-param" onclick="addEmptyRowTable('util-param')" title="Add Row"><i class="bi bi-plus-lg"></i></button>
                            </div>
                            <table class="table table-hover table-bordered table-sm text-center" id="util-param-history-table">
                                <thead class="table-light">
                                    <tr>
                                        <th class="delete-col-util-param" style="display: none;"><i class="bi bi-trash"></i></th>
                                        <th>Дата</th>
                                        <th>Самолет</th>
                                        <th>TTSN</th>
                                        <th>TCSN</th>
                                        <th>Period</th>
                                        <th>Date From</th>
                                        <th>Date To</th>
                                        <th>Создано</th>
                                    </tr>
                                </thead>
                                <tbody id="util-param-history-body">
                                    <tr><td colspan="9" class="text-muted">Нет данных</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- UTILIZATION HISTORY MODAL -->
            <div id="utilization-history-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; justify-content: center; align-items: center;">
                <div style="background: white; border-radius: 8px; max-width: 900px; max-height: 80vh; overflow: auto; box-shadow: 0 4px 20px rgba(0,0,0,0.3); padding: 20px; position: relative;">
                    <button onclick="closeUtilizationHistoryModal()" style="position: absolute; top: 10px; right: 10px; background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #999;">&times;</button>
                    <h5 class="mb-3"><i class="bi bi-bar-chart-line"></i> Utilization Parameters History</h5>
                    <div id="utilization-history-modal-content">
                        <table class="table table-sm table-bordered table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>Дата</th>
                                    <th>Самолет</th>
                                    <th>TTSN</th>
                                    <th>TCSN</th>
                                    <th>Period</th>
                                    <th>Date From</th>
                                    <th>Date To</th>
                                    <th>Создано</th>
                                </tr>
                            </thead>
                            <tbody id="utilization-history-modal-body">
                                <tr><td colspan="8" class="text-muted">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- 11. UTILIZATION VIEW -->
            <div id="view-util" style="display: none;">
                <h4 class="mb-3 text-info"><i class="bi bi-speedometer2"></i> Aircraft Utilization (ATLB)</h4>
                
                <ul class="nav nav-tabs mb-4">
                    <li class="nav-item"><button class="nav-link active" id="tab-util-list-btn" onclick="switchUtilTab('list')">Flight History</button></li>
                    <li class="nav-item"><button class="nav-link" id="tab-util-entry-btn" onclick="switchUtilTab('entry')">Enter Flight Data</button></li>
                </ul>

                <!-- TAB 1: HISTORY TABLE -->
                                
                <div id="tab-util-list">
                    <div class="card shadow-sm">
                        <div class="card-body">
                            <div class="d-flex justify-content-end mb-2">
                                <button class="btn btn-sm btn-primary" onclick="loadUtilHistory()"><i class="bi bi-arrow-clockwise"></i> Refresh</button>
                                <button class="btn btn-sm btn-warning ms-2" id="btn-util-edit" onclick="toggleEditModeTable('util')"><i class="bi bi-pencil-square"></i> Edit</button>
                                <button class="btn btn-sm btn-success ms-2 d-none" id="btn-util-save" onclick="saveEditModeTable('util')"><i class="bi bi-check-lg"></i> Save Changes</button>
                                <button class="btn btn-sm btn-secondary ms-2 d-none" id="btn-util-cancel" onclick="cancelEditModeTable('util')"><i class="bi bi-x-lg"></i> Cancel</button>
                                <button class="btn btn-circle btn-success d-none" id="add-row-util" onclick="addEmptyRowTable('util')" title="Add Row"><i class="bi bi-plus-lg"></i></button>
                            </div>
                            <table class="table table-hover table-bordered table-sm text-center" id="util-table">
                                <thead class="table-light">
                                    <tr>
                                        <th class="delete-col-util" style="width: 40px; display: none;"><i class="bi bi-trash"></i></th>
                                        <!-- Добавляем data-col для идентификации столбца -->
                                        <th data-col="date">Date <i class="bi bi-funnel-fill filter-icon" id="filter-icon-date" data-bs-toggle="dropdown"></i>
                                            <div class="dropdown-menu filter-dropdown-menu" id="filter-menu-date"></div>
                                        </th>
                                        <th data-col="aircraft">Aircraft <i class="bi bi-funnel-fill filter-icon" id="filter-icon-aircraft" data-bs-toggle="dropdown"></i>
                                            <div class="dropdown-menu filter-dropdown-menu" id="filter-menu-aircraft"></div>
                                        </th>
                                        <th data-col="route">Route <i class="bi bi-funnel-fill filter-icon" id="filter-icon-route" data-bs-toggle="dropdown"></i>
                                            <div class="dropdown-menu filter-dropdown-menu" id="filter-menu-route"></div>
                                        </th>
                                        <th data-col="time">Flight Time <i class="bi bi-funnel-fill filter-icon" id="filter-icon-time" data-bs-toggle="dropdown"></i>
                                            <div class="dropdown-menu filter-dropdown-menu" id="filter-menu-time"></div>
                                        </th>
                                        <th data-col="cycles">Cycles <i class="bi bi-funnel-fill filter-icon" id="filter-icon-cycles" data-bs-toggle="dropdown"></i>
                                            <div class="dropdown-menu filter-dropdown-menu" id="filter-menu-cycles"></div>
                                        </th>
                                        <th data-col="ref">ATLB Ref <i class="bi bi-funnel-fill filter-icon" id="filter-icon-ref" data-bs-toggle="dropdown"></i>
                                            <div class="dropdown-menu filter-dropdown-menu" id="filter-menu-ref"></div>
                                        </th>
                                    </tr>
                                </thead>
                                <tbody id="util-history-body"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
              

                <!-- TAB 2: DATA ENTRY FORM -->
                <div id="tab-util-entry" style="display: none;">
                    <div class="card shadow-sm border-0">
                        <div class="card-header bg-white fw-bold text-info">New Flight Entry</div>
                        <div class="card-body">
                            <form id="form-util">
                                <!-- ВЕРХНИЙ БЛОК (САМОЛЕТ И ДАТА) -->
                                <div class="row mb-3">
                                    <div class="col-md-3">
                                        <label class="small fw-bold">Date *</label>
                                        <input type="date" class="form-control" id="util-date" required>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="small fw-bold">Aircraft Reg No *</label>
                                        <select class="form-select" id="util-ac" required></select>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="small fw-bold">ATLB Sheet No</label>
                                        <input type="text" class="form-control" id="util-atlb">
                                    </div>
                                    <div class="col-md-3">
                                        <label class="small fw-bold">Current TTSN / TCSN</label>
                                        <input type="text" class="form-control bg-light" id="util-current-stats" readonly placeholder="Select AC...">
                                    </div>
                                </div>

                                <!-- СРЕДНИЙ БЛОК (МАРШРУТ) -->
                                <div class="p-3 mb-3" style="background-color: #f8f9fa; border-radius: 5px;">
                                    <h6 class="text-muted border-bottom pb-2">Flight Leg</h6>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <label class="small fw-bold">From</label>
                                            <input type="text" class="form-control" id="util-from" placeholder="ICAO (e.g. UAAA)">
                                        </div>
                                        <div class="col-md-6">
                                            <label class="small fw-bold">To</label>
                                            <input type="text" class="form-control" id="util-to" placeholder="ICAO (e.g. UAFM)">
                                        </div>
                                    </div>
                                </div>

                                <!-- НИЖНИЙ БЛОК (ВРЕМЯ) -->
                                <div class="row mb-4">
                                    <div class="col-md-6">
                                        <label class="small fw-bold text-primary">Flight Time (Hours) *</label>
                                        <input type="number" step="0.01" class="form-control border-primary" id="util-fh" placeholder="e.g. 2.50">
                                        <small class="text-muted">Block time or Airborne time</small>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="small fw-bold text-primary">Cycles (Landings) *</label>
                                        <input type="number" class="form-control border-primary" id="util-fc" value="1">
                                    </div>
                                </div>

                                <div class="row mb-3">
                                    <div class="col-12">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="util-maintenance">
                                            <label class="form-check-label small fw-bold" for="util-maintenance">Maintenance (No Flight Time)</label>
                                        </div>
                                        <small class="text-muted">При отметке налет и циклы не увеличиваются, но запись сохраняется.</small>
                                    </div>
                                </div>

                                <div class="d-flex justify-content-end gap-2">
                                    <button type="button" class="btn btn-light border" onclick="switchUtilTab('list')">Cancel</button>
                                    <button type="button" class="btn btn-info text-white px-4" onclick="submitUtilForm()">SAVE</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
            <!-- 7. MASTER ENGINE VIEW (MAIN) -->
            <div id="view-main-engine" style="display: none;">
                <h4 class="mb-3 text-primary"><i class="bi bi-database-fill"></i> Master Engine List</h4>
                
                <ul class="nav nav-tabs mb-4">
                    <li class="nav-item"><button class="nav-link active" id="tab-main-list-btn" onclick="switchMainTab('list')">Список двигателей</button></li>
                    <li class="nav-item"><button class="nav-link" id="tab-main-add-btn" onclick="switchMainTab('add')">Добавить двигатель</button></li>
                </ul>

                <!-- TAB 1: LIST & EDIT -->
                <div id="tab-main-list">
                    <div class="card shadow-sm">
                        <div class="card-body">
                            <!-- Кнопки управления -->
                            <div class="d-flex justify-content-end mb-2 gap-2">
                                <button class="btn btn-sm btn-primary" onclick="loadMainTable()"><i class="bi bi-arrow-clockwise"></i> Refresh</button>
                                <button class="btn btn-sm btn-warning" id="btn-main-edit" onclick="toggleEditMode()"><i class="bi bi-pencil-square"></i> Edit Table</button>
                                <button class="btn btn-sm btn-info" id="btn-main-filter" onclick="toggleEngineFilter()" title="Filter"><i class="bi bi-funnel"></i> Filter</button>
                                <button class="btn btn-sm btn-danger d-none" id="btn-main-delete-selected" onclick="bulkDeleteSelected()"><i class="bi bi-trash3"></i> Delete Selected</button>
                                <button class="btn btn-sm btn-success d-none" id="btn-main-save" onclick="saveEditMode()"><i class="bi bi-check-lg"></i> Save Changes</button>
                                <button class="btn btn-sm btn-secondary d-none" id="btn-main-cancel" onclick="cancelEditMode()"><i class="bi bi-x-lg"></i> Cancel</button>
                            </div>
                            
                            <div class="table-responsive">
                                <table class="table table-bordered table-hover table-sm text-center align-middle" style="font-size: 0.85rem;">
                                    <thead class="table-dark">
                                        <tr>
                                            <th class="delete-col" style="width: 64px; display: none; white-space: nowrap;">
                                                <div class="bulk-controls">
                                                    <input type="checkbox" id="select-all-delete" class="form-check-input select-all" onchange="toggleSelectAllRows(this)">
                                                    <i class="bi bi-trash text-danger" title="Delete / Select"></i>
                                                </div>
                                            </th>
                                            <th>Date</th><th>Model</th><th>Orig. ESN</th><th>GSS ID</th><th>Status</th>
                                            <th>TT</th><th>TC</th><th>Moved From</th><th>Removed From</th>
                                            <th>Remarks</th><th>Links/Photo</th>
                                        </tr>
                                    </thead>
                                    <tbody id="main-engine-body"></tbody>
                                </table>
                                <!-- Кнопка Плюс внизу таблицы (появляется при Edit) -->
                                <div id="add-row-btn" class="text-center p-2 border-top d-none" style="cursor: pointer; background: #f8f9fa;" onclick="addEmptyRow()">
                                    <i class="bi bi-plus-circle fs-4 text-success"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Выдвижная панель фильтра -->
                <div id="engine-filter-panel" class="position-fixed" style="right: -400px; top: 0; width: 400px; height: 100vh; background: white; border-left: 1px solid #ddd; box-shadow: -2px 0 8px rgba(0,0,0,0.1); z-index: 1000; transition: right 0.3s ease; padding: 20px; overflow-y: auto;">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h5 class="mb-0">Filter Engines</h5>
                        <button class="btn btn-close" onclick="toggleEngineFilter()"></button>
                    </div>
                    
                    <div class="mb-4">
                        <label class="small fw-bold d-block mb-2">User (Created By)</label>
                        <select class="form-select" id="engine-user-filter" onchange="filterEnginesByUser()">
                            <option value="">All Users</option>
                        </select>
                    </div>
                    
                    <div class="mb-4">
                        <label class="small fw-bold d-block mb-2">Date</label>
                        <input type="date" class="form-control" id="engine-date-filter" onchange="filterEnginesByDate()">
                    </div>
                    
                    <div class="mb-4">
                        <label class="small fw-bold d-block mb-2">Status</label>
                        <select class="form-select" id="engine-status-filter" onchange="filterEnginesByStatus()">
                            <option value="">All Status</option>
                            <option value="SV">SV (Serviceable)</option>
                            <option value="US">US (Unserviceable)</option>
                            <option value="INSTALLED">INSTALLED</option>
                            <option value="REMOVED">REMOVED</option>
                            <option value="AS">AS (As Removed)</option>
                        </select>
                    </div>
                    
                    <div class="mb-4">
                        <label class="small fw-bold d-block mb-2">Model</label>
                        <input type="text" class="form-control" id="engine-model-filter" onchange="applyEngineFilters()" placeholder="e.g. CF6-80">
                    </div>
                    
                    <div class="mb-4">
                        <label class="small fw-bold d-block mb-2">Orig. ESN</label>
                        <input type="text" class="form-control" id="engine-esn-filter" onchange="applyEngineFilters()" placeholder="Search ESN">
                    </div>

                    <div class="mb-4">
                        <label class="small fw-bold d-block mb-2">GSS ID</label>
                        <input type="text" class="form-control" id="engine-gss-filter" onchange="applyEngineFilters()" placeholder="Search GSS ID">
                    </div>
                    
                    <div class="mb-4">
                        <label class="small fw-bold d-block mb-2">Location (Moved From)</label>
                        <input type="text" class="form-control" id="engine-location-filter" onchange="applyEngineFilters()" placeholder="Search location">
                    </div>

                    <div class="mb-4">
                        <label class="small fw-bold d-block mb-2">Removed From (AC)</label>
                        <input type="text" class="form-control" id="engine-removed-filter" onchange="applyEngineFilters()" placeholder="Search removed from">
                    </div>

                    <div class="mb-4">
                        <label class="small fw-bold d-block mb-2">TT Range</label>
                        <div class="d-flex gap-2">
                            <input type="number" class="form-control" id="engine-tt-min" onchange="applyEngineFilters()" placeholder="Min">
                            <input type="number" class="form-control" id="engine-tt-max" onchange="applyEngineFilters()" placeholder="Max">
                        </div>
                    </div>

                    <div class="mb-4">
                        <label class="small fw-bold d-block mb-2">TC Range</label>
                        <div class="d-flex gap-2">
                            <input type="number" class="form-control" id="engine-tc-min" onchange="applyEngineFilters()" placeholder="Min">
                            <input type="number" class="form-control" id="engine-tc-max" onchange="applyEngineFilters()" placeholder="Max">
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <label class="small fw-bold d-block mb-2">Remarks</label>
                        <input type="text" class="form-control" id="engine-remarks-filter" onchange="applyEngineFilters()" placeholder="Search remarks">
                    </div>

                    <div class="form-check mb-4">
                        <input class="form-check-input" type="checkbox" id="engine-has-photo" onchange="applyEngineFilters()">
                        <label class="form-check-label" for="engine-has-photo">With Photo only</label>
                    </div>
                    
                    <div class="d-flex gap-2">
                        <button class="btn btn-sm btn-primary w-100" onclick="applyEngineFilters()">Apply Filters</button>
                        <button class="btn btn-sm btn-outline-secondary w-100" onclick="clearEngineFilters()">Clear All</button>
                    </div>
                </div>
                <div id="engine-filter-overlay" class="position-fixed" style="display: none; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.3); z-index: 999;" onclick="toggleEngineFilter()"></div>

                <!-- TAB 2: ADD NEW -->
                <div id="tab-main-add" style="display: none;">
                    <div class="card shadow-sm border-0">
                        <div class="card-header bg-white fw-bold text-primary">Ввод основных данных</div>
                        <div class="card-body">
                            <form id="form-main-add">
                                <div class="row mb-3">
                                    <div class="col-md-3"><label class="small fw-bold">Date</label><input type="date" class="form-control" id="m-date"></div>
                                    <div class="col-md-3"><label class="small fw-bold">Model</label><input type="text" class="form-control" id="m-model" placeholder="e.g. CF6-80"></div>
                                    <div class="col-md-3"><label class="small fw-bold">Orig. ESN *</label><input type="text" class="form-control" id="m-esn" required></div>
                                    <div class="col-md-3"><label class="small fw-bold">GSS ID</label><input type="text" class="form-control" id="m-gssid"></div>
                                </div>
                                <div class="row mb-3">
                                    <div class="col-md-3">
                                        <label class="small fw-bold">Status</label>
                                        <select class="form-select" id="m-status">
                                            <option value="SV">SV (Serviceable)</option>
                                            <option value="US">US (Unserviceable)</option>
                                            <option value="AS">AS (As Removed)</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="small fw-bold">Current Location *</label>
                                        <select class="form-select" id="m-location" required>
                                            <option value="" disabled selected>Select Location...</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3"><label class="small fw-bold">TT</label><input type="number" step="0.1" class="form-control" id="m-tt" value="0"></div>
                                    <div class="col-md-3"><label class="small fw-bold">TC</label><input type="number" class="form-control" id="m-tc" value="0"></div>
                                </div>
                                <div class="row mb-3">
                                    <div class="col-md-3"><label class="small fw-bold">Photo (Link)</label><input type="text" class="form-control" id="m-photo" placeholder="http://..."></div>
                                </div>
                                <div class="row mb-3">
                                    <div class="col-md-6"><label class="small fw-bold">Moved From (Loc/Shop)</label><input type="text" class="form-control" id="m-moved"></div>
                                    <div class="col-md-6"><label class="small fw-bold">Removed From (AC)</label><input type="text" class="form-control" id="m-removed"></div>
                                </div>
                                <div class="mb-3"><label class="small fw-bold">Remarks</label><textarea class="form-control" id="m-rem" rows="2"></textarea></div>
                                
                                <div class="d-flex justify-content-end gap-2">
                                    <button type="button" class="btn btn-light border" onclick="switchMainTab('list')">Cancel</button>
                                    <button type="button" class="btn btn-success px-4" onclick="submitMainEngine()">Save Record</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
            <!-- ОБЕРТКА ДЛЯ ФЛОТА -->
            <div id="fleet-section" class="px-4">
                <!-- Заголовок тоже прячем -->
                <h6 class="text-muted text-uppercase mb-3 mt-4">ON WING (Fleet)</h6>
                
                <div class="row g-3" id="fleet-container">
                    <div class="col-12"><div class="spinner-border text-primary spinner-sm"></div> Loading fleet...</div>
                </div>

                <!-- === PARTS CARDS SECTION === -->
                <div class="parts-cards-section">
                    <h6 class="text-muted text-uppercase mb-3">PARTS MANAGEMENT</h6>
                    <div id="parts-cards-container" class="parts-cards-grid"></div>
                </div>

                <!-- RECENT ACTIONS SECTION (всегда сразу ПОД флотом) -->
                <div id="recent-actions-section" class="mt-5">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="text-muted text-uppercase mb-0">
                            <i class="bi bi-clock-history me-2"></i>Recent Actions
                        </h6>
                    </div>

                    <div class="card shadow-sm border-0">
                        <div class="card-body p-0">
                            <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                                <table class="table table-hover table-sm mb-0">
                                    <thead class="table-light sticky-top">
                                        <tr>
                                            <th style="width: 15%;">Date & Time</th>
                                            <th style="width: 15%;">User</th>
                                            <th style="width: 12%;">Action</th>
                                            <th style="width: 12%;">Entity</th>
                                            <th>Description</th>
                                            <th style="width: 8%;">Details</th>
                                        </tr>
                                    </thead>
                                    <tbody id="recent-actions-body">
                                        <tr>
                                            <td colspan="6" class="text-center text-muted py-4">
                                                <i class="bi bi-clock-history fs-3 d-block mb-2"></i>
                                                Loading recent actions...
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

<div class="modal fade" id="dataModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header bg-dark text-white">
                <h5 class="modal-title" id="modalTitle">Table Info</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-0">
                <div class="table-responsive">
                    <table class="table table-striped table-hover table-custom mb-0">
                        <thead id="modalTableHead">
                            </thead>
                        <tbody id="modalTableBody">
                            </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary">Export to Excel</button>
            </div>
        </div>
    </div>
</div>

        <!-- SETTINGS MODAL -->
        <div class="modal fade" id="settings-modal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-lg modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header bg-dark text-white">
                        <h5 class="modal-title"><i class="bi bi-gear me-2"></i>Settings</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <ul class="nav nav-tabs mb-3" id="settings-tabs">
                            <li class="nav-item">
                                <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#settings-interface">
                                    <i class="bi bi-speedometer2 me-2"></i>Interface
                                </button>
                            </li>
                            <li class="nav-item">
                                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#settings-parts">
                                    <i class="bi bi-box-seam me-2"></i>Parts Management
                                </button>
                            </li>
                            <li class="nav-item">
                                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#settings-recent">
                                    <i class="bi bi-clock-history me-2"></i>Recent Actions
                                </button>
                            </li>
                        </ul>
                        <div class="tab-content">
                            <div class="tab-pane fade show active" id="settings-interface">
                                <h6 class="mb-3">Dashboard Customization</h6>
                                <div class="form-check form-switch mb-3">
                                    <input class="form-check-input" type="checkbox" id="dashboard-edit-toggle" onchange="toggleDashboardEditMode()">
                                    <label class="form-check-label" for="dashboard-edit-toggle">
                                        <strong>Enable Edit Mode</strong> - Drag, rename, delete
                                    </label>
                                </div>
                                <div id="dashboard-edit-section" style="display: none;">
                                    <div class="alert alert-info small">
                                        <i class="bi bi-info-circle me-2"></i>
                                        Drag to reorder • Click edit to rename • Click trash to delete • Saves automatically
                                    </div>
                                    
                                    <!-- ACCORDION FOR SUBGROUPS -->
                                    <div class="accordion" id="dashboard-accordion">
                                        <!-- CITY SUBGROUP -->
                                        <div class="accordion-item">
                                            <h2 class="accordion-header">
                                                <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-city">
                                                    <i class="bi bi-geo-alt me-2"></i><strong>City Locations</strong>
                                                </button>
                                            </h2>
                                            <div id="collapse-city" class="accordion-collapse collapse show" data-bs-parent="#dashboard-accordion">
                                                <div class="accordion-body p-2">
                                                    <div id="locations-edit-list" class="list-group list-group-flush" style="max-height: 200px; overflow-y: auto;">
                                                        <!-- Populated by JS -->
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- STATUS SUBGROUP -->
                                        <div class="accordion-item">
                                            <h2 class="accordion-header">
                                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-status">
                                                    <i class="bi bi-tags me-2"></i><strong>Status Buttons</strong> <small class="text-muted ms-2">(order only)</small>
                                                </button>
                                            </h2>
                                            <div id="collapse-status" class="accordion-collapse collapse" data-bs-parent="#dashboard-accordion">
                                                <div class="accordion-body p-2">
                                                    <div id="status-edit-list" class="list-group list-group-flush">
                                                        <!-- Populated by JS -->
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- FLEET SUBGROUP -->
                                        <div class="accordion-item">
                                            <h2 class="accordion-header">
                                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-fleet">
                                                    <i class="bi bi-airplane me-2"></i><strong>Fleet (Aircraft)</strong>
                                                </button>
                                            </h2>
                                            <div id="collapse-fleet" class="accordion-collapse collapse" data-bs-parent="#dashboard-accordion">
                                                <div class="accordion-body p-2">
                                                    <div class="d-flex justify-content-end mb-2">
                                                        <button class="btn btn-sm btn-success" onclick="addNewAircraft()">
                                                            <i class="bi bi-plus-lg me-1"></i>Add Aircraft
                                                        </button>
                                                    </div>
                                                    <div id="fleet-edit-list" class="list-group list-group-flush" style="max-height: 200px; overflow-y: auto;">
                                                        <!-- Populated by JS -->
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <button class="btn btn-sm btn-warning mt-3" onclick="resetDashboardDefaults()">
                                        <i class="bi bi-arrow-counterclockwise me-2"></i>Reset All to Defaults
                                    </button>
                                </div>
                            </div>
                            <div class="tab-pane fade" id="settings-parts">
                                <h6 class="mb-3">Parts Management</h6>
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label class="small fw-bold">Card title: Logistics</label>
                                        <input type="text" class="form-control" id="parts-logistics-title-input" placeholder="Parts Logistics">
                                    </div>
                                    <div class="col-md-6">
                                        <label class="small fw-bold">Card title: Store Balance</label>
                                        <input type="text" class="form-control" id="parts-store-title-input" placeholder="Store Balance">
                                    </div>
                                    <div class="col-md-12">
                                        <label class="small fw-bold">Card height</label>
                                        <input type="range" class="form-range" min="160" max="260" step="10" id="parts-card-height" oninput="updatePartsCardHeightLabel(this.value)">
                                        <div class="d-flex justify-content-between small text-muted">
                                            <span>Current: <span id="parts-card-height-value">200px</span></span>
                                            <span>Range: 160-260px</span>
                                        </div>
                                    </div>
                                    <div class="col-md-12">
                                        <label class="small fw-bold">Card width (per card)</label>
                                        <input type="range" class="form-range" min="35" max="100" step="5" id="parts-card-width" oninput="updatePartsCardWidthLabel(this.value)">
                                        <div class="d-flex justify-content-between small text-muted">
                                            <span>Current: <span id="parts-card-width-value">50%</span></span>
                                            <span>Range: 35-100%</span>
                                        </div>
                                    </div>
                                    <div class="col-12 d-flex flex-wrap gap-2">
                                        <button class="btn btn-primary btn-sm" onclick="savePartsSettingsFromForm()"><i class="bi bi-save me-1"></i>Save Parts Settings</button>
                                        <button class="btn btn-outline-secondary btn-sm" onclick="resetPartsSettings()"><i class="bi bi-arrow-counterclockwise me-1"></i>Reset Parts Defaults</button>
                                    </div>
                                    <div class="col-12">
                                        <div class="alert alert-light border small mb-0">
                                            Renames sync across sidebar, cards, modals, and tabs; size is applied instantly.
                                        </div>
                                    </div>
                                </div>
                                <hr>
                                <h6 class="mb-2">Custom Cards</h6>
                                <div class="row g-3 align-items-end">
                                    <div class="col-md-4">
                                        <label class="small fw-bold">Card title</label>
                                        <input type="text" class="form-control" id="parts-custom-title" placeholder="e.g. Parts Add">
                                    </div>
                                    <div class="col-md-3">
                                        <label class="small fw-bold">Color</label>
                                        <input type="color" class="form-control form-control-color" id="parts-custom-color" value="#2563eb" title="Pick card color">
                                    </div>
                                    <div class="col-md-3">
                                        <label class="small fw-bold">Target</label>
                                        <select class="form-select" id="parts-custom-target">
                                            <option value="parts-modal">Parts Logistics modal</option>
                                            <option value="parts-view">Parts Logistics table</option>
                                            <option value="parts-add">Parts Logistics – Add tab</option>
                                            <option value="store-modal">Store Balance modal</option>
                                            <option value="store-view">Store Balance table</option>
                                            <option value="store-add">Store Balance – Add tab</option>
                                        </select>
                                    </div>
                                    <div class="col-md-2">
                                        <label class="small fw-bold">Width %</label>
                                        <input type="number" class="form-control" id="parts-custom-width" min="35" max="100" step="5" value="50">
                                    </div>
                                    <div class="col-md-12 d-flex gap-2">
                                        <button class="btn btn-success btn-sm" onclick="addCustomPartsCard()"><i class="bi bi-plus-lg me-1"></i>Add Card</button>
                                        <button class="btn btn-outline-secondary btn-sm" onclick="clearCustomCardForm()">Clear</button>
                                    </div>
                                    <div class="col-12">
                                        <div id="parts-custom-list" class="list-group small"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="tab-pane fade" id="settings-recent">
                                <h6 class="mb-3">Recent Actions Cleanup</h6>
                                <p class="small text-muted mb-3">Delete activity log entries older than the selected window.</p>
                                <div class="d-flex flex-wrap gap-2 mb-3">
                                    <button class="btn btn-outline-danger btn-sm" onclick="purgeRecentActions('1d')">Older than 1 day</button>
                                    <button class="btn btn-outline-danger btn-sm" onclick="purgeRecentActions('3d')">Older than 3 days</button>
                                    <button class="btn btn-outline-danger btn-sm" onclick="purgeRecentActions('7d')">Older than 1 week</button>
                                    <button class="btn btn-outline-danger btn-sm" onclick="purgeRecentActions('30d')">Older than 1 month</button>
                                    <button class="btn btn-danger btn-sm" onclick="purgeRecentActions('all')"><i class="bi bi-trash3 me-1"></i>Delete all</button>
                                </div>
                                <div class="alert alert-light border small" id="recent-actions-summary">Recent actions not loaded yet.</div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // --- 1. Sidebar Toggle ---

    const wrapper = document.getElementById("wrapper");
    
    // Логика Сэндвича
    document.getElementById("menu-toggle").onclick = function(e) {
        e.preventDefault();
        wrapper.classList.toggle("toggled");
    };

    // Логика кнопки Dashboard
    // Логика кнопки Dashboard (ИСПРАВЛЕННАЯ)
function openDashboardView() {
        hideAllViews(); // Сначала все скрываем

        const widgets = document.getElementById('dashboard-widgets');
        const fleet = document.getElementById('fleet-section');
        const btnWrapper = document.getElementById('engine-btn-wrapper');

        // Показываем блоки дашборда
        widgets.style.display = 'block';
        fleet.style.display = 'block';
        
        // Сбрасываем классы анимации сворачивания, если они были
        widgets.classList.remove('dashboard-collapsed');
        fleet.classList.remove('dashboard-collapsed');
        widgets.classList.add('dashboard-expanded');
        fleet.classList.add('dashboard-expanded');

        // --- ВАЖНО: Показываем кнопку двигателя ТОЛЬКО здесь ---
        if (btnWrapper) {
            btnWrapper.style.display = 'flex'; 
        }

        // Сброс состояния
        isDashboardOpen = true; 
        const btn = document.querySelector('.btn-engine-start');
        if(btn) btn.classList.add('active'); // Кнопка горит, т.к. дашборд открыт
        toggleEngineMenu(false);
        
        updateHistory('dashboard');
    
}
    // --- Notification Functions ---
    function showSuccessNotification(message) {
        document.getElementById('successMessage').textContent = message;
        const modal = new bootstrap.Modal(document.getElementById('successModal'));
        modal.show();
    }

    function showErrorNotification(message) {
        document.getElementById('errorMessage').textContent = message;
        const modal = new bootstrap.Modal(document.getElementById('errorModal'));
        modal.show();
    }

    // --- 2. Data Loading & Initialization ---
    let globalEngines = [];
    let globalFleet = [];
    let installableEngines;
    let localTestShipments = []; // Временное хранилище для отгрузок
    let localTestInstalls = [];  // Временное хранилище для установок
    const noCache = () => `?t=${new Date().getTime()}`;
    window.onload = async function() {
        await loadDashboardData();
    };


    //яяааааааааааааааааааааааааааааааааааа
    
    function hideAllViews() {
        const views = [
            'dashboard-widgets', // <--- ЭТОТ ID ОБЯЗАТЕЛЕН
            'fleet-section', 
            'view-install', 
            'view-shipment', 
            'view-remove',
            'view-add-engine',
            'view-main-engine',
            'view-repair',
            'view-parts',
            'view-store-balance',
            'view-util',
            'view-atlb',
            'view-eng-param',
            'view-utilization-param',
            'view-borescope',
            'view-engine-reports',
            'view-purchase-orders'
        ];
        
        views.forEach(id => {
            const el = document.getElementById(id);
            if (el) el.style.display = 'none';
        });

        // --- ВАЖНО: Скрываем кнопку двигателя при уходе с дашборда ---
        const btnWrapper = document.getElementById('engine-btn-wrapper');
        if (btnWrapper) {
            btnWrapper.style.display = 'none';
        }
    }
    // -------------------------------

    // --- HISTORY MANAGEMENT (Кнопка Назад) ---
    
    // 1. Функция для обновления URL без перезагрузки
    function updateHistory(viewName) {
        // Если мы уже на этой странице, не дублируем историю
        if (history.state && history.state.view === viewName) return;
        
        const url = new URL(window.location);
        url.hash = viewName; // Ставим #shipment, #install и т.д.
        history.pushState({ view: viewName }, '', url);
    }

    // 2. Слушаем нажатие кнопки "Назад" в браузере
    window.onpopstate = function(event) {
        if (event.state && event.state.view) {
            restoreView(event.state.view);
        } else {
            // Если истории нет (вернулись в начало), открываем Дашборд
            openDashboardView();
        }
    };

    // 3. Функция восстановления окна по имени
    // 3. Функция восстановления окна по имени (ИСПРАВЛЕННАЯ)
function restoreView(viewName) {
    // 1. Скрываем ВСЁ с помощью общей функции (чтобы не перечислять вручную)
    hideAllViews();

    // 2. Открываем нужное
    if (viewName === 'dashboard') {
        openDashboardView(); // Используем основную функцию, она сама все покажет
    } else if (viewName === 'shipment') {
        document.getElementById('view-shipment').style.display = 'block';
        loadShipmentHistory();
    } else if (viewName === 'install') {
        document.getElementById('view-install').style.display = 'block';
        loadInstallHistory();
    } else if (viewName === 'remove') {
        document.getElementById('view-remove').style.display = 'block';
        loadRemoveHistory();
    } else if (viewName === 'add-engine') {
        document.getElementById('view-add-engine').style.display = 'block';
    } else if (viewName === 'master') {
        document.getElementById('view-main-engine').style.display = 'block';
        loadMainTable();
    } else if (viewName === 'repair') {
        document.getElementById('view-repair').style.display = 'block';
        loadRepairHistory();
    } else if (viewName === 'parts') {
        document.getElementById('view-parts').style.display = 'block';
        loadPartsHistory();
    } else if (viewName === 'store-balance') {
        document.getElementById('view-store-balance').style.display = 'block';
        switchStoreBalanceTab('list');
        loadStoreBalance();
    } else if (viewName === 'util') {
        document.getElementById('view-util').style.display = 'block';
        loadUtilHistory();
    } else if (viewName === 'atlb') {
        document.getElementById('view-atlb').style.display = 'block';
        // ИЗМЕНЕНИЕ: Здесь тоже ставим 'entry'
        switchAtlbTab('entry');;
    } else if (viewName === 'eng-param') { // Добавляем новое окно в историю
        openEngParamView();
    }
}




    async function loadDashboardData() {
    try {
        // 2.1 Load Stats
        const statsRes = await fetch('/api/dashboard/stats');
        if (!statsRes.ok) {
            throw new Error(`Failed to fetch stats: ${statsRes.status} ${statsRes.statusText}`);
        }
        const stats = await statsRes.json();
        console.log('Stats:', stats); // Для отладки
        document.getElementById('cnt-sv').innerText = stats.SV || 0;
        document.getElementById('cnt-us').innerText = stats.US || 0;
        document.getElementById('cnt-inst').innerText = stats.INSTALLED || 0;
        document.getElementById('cnt-rem').innerText = stats.REMOVED || 0;

        // 2.2 Load Locations Buttons (Dynamic)
        const locRes = await fetch('/api/locations');
        if (!locRes.ok) {
            throw new Error(`Failed to fetch locations: ${locRes.status} ${locRes.statusText}`);
        }
        const locations = await locRes.json();
        console.log('Locations:', locations); // Для отладки
        const locContainer = document.getElementById('locations-container');
        locContainer.innerHTML = '';
        
        locations.forEach(loc => {
            locContainer.innerHTML += `
                <div class="col-md-2 col-sm-4" data-location-id="${loc.id}">
                    <button class="btn-dashboard w-100" onclick="openLocationModal('${loc.id}', '${loc.name}')">
                        <span class="label">${loc.name}</span>
                        <span class="count">${loc.engine_count}</span>
                        <i class="bi bi-geo-alt-fill"></i>
                    </button>
                </div>
            `;
        });

        // 2.3 Load Fleet Cards (BAR, BAT, BAQ) - NEW PROFESSIONAL DESIGN
        let aircraftDetails = [];
        try {
            const fleetRes = await fetch('/api/dashboard/aircraft-details');
            if (fleetRes.ok) {
                aircraftDetails = await fleetRes.json();
                console.log('Aircraft Details:', aircraftDetails);
            } else {
                console.warn('New API not available, using fallback...');
                // Fallback to old API
                const oldRes = await fetch('/api/fleet');
                if (oldRes.ok) {
                    const oldFleet = await oldRes.json();
                    // Convert old format to new format
                    aircraftDetails = oldFleet.map((ac, idx) => ({
                        aircraft_id: idx + 1,
                        tail_number: ac.tail_number,
                        model: ac.model || 'N/A',
                        total_time: 0,
                        total_cycles: 0,
                        positions: ac.engines.map(eng => ({
                            engine_id: 1,
                            original_sn: eng.original_sn,
                            current_sn: eng.current_sn,
                            model: 'N/A',
                            total_tsn: eng.tt || 0,
                            total_csn: eng.tc || 0,
                            tsn_on_aircraft: 0,
                            csn_on_aircraft: 0,
                            n1_takeoff: eng.n1_to,
                            n1_cruise: eng.n1_cr,
                            n2_takeoff: eng.n2_to,
                            n2_cruise: eng.n2_cr,
                            install_date: 'N/A',
                            last_update: 'N/A'
                        }))
                    }));
                }
            }
        } catch (err) {
            console.error('Error fetching aircraft data:', err);
        }
        
        const fleetContainer = document.getElementById('fleet-container');
        fleetContainer.innerHTML = '';
        
        // Теперь всегда показываем карточки, даже с нулевыми данными
        if (aircraftDetails.length === 0) {
            console.warn('No aircraft data from API, but cards will still be displayed');
        }

        aircraftDetails.forEach(ac => {
            const cardId = `aircraft-${ac.aircraft_id}`;
            const positionsId = `positions-${ac.aircraft_id}`;
            const chevronId = `chevron-${ac.aircraft_id}`;
            
            let positionsHTML = '';
            const positions = ac.positions || [null, null, null, null];
            
            // Создаем при необходимости блок с периодом перед позициями
            let periodHTML = '';
            if (ac.utilization_period) {
                const periodText = `Period: ${ac.utilization_date_from || '-'} — ${ac.utilization_date_to || '-'}`;
                periodHTML = `
                    <div class="engine-position-card" style="border-left: 4px solid #ffc107; background: #fff8e1; width: 100%;">
                        <div class="position-header" style="padding: 6px 12px; font-size: 0.85rem;">${periodText}</div>
                        <div style="display: flex; gap: 15px; padding: 6px 12px; justify-content: center;">
                            <div style="text-align: center;">
                                <div style="font-size: 1.1rem; font-weight: bold; color: #ff6b00;">${(ac.period_ttsn ?? 'N/A')}</div>
                                <div style="font-size: 0.7rem; color: #666; margin-top: 1px;">TTSN (hrs)</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 1.1rem; font-weight: bold; color: #ff6b00;">${(ac.period_tcsn ?? 'N/A')}</div>
                                <div style="font-size: 0.7rem; color: #666; margin-top: 1px;">TCSN (cyc)</div>
                            </div>
                        </div>
                    </div>
                `;
            }

            // Создаем 4 отдельные карточки для каждой позиции (без SVG анимации)
            positions.forEach((pos, index) => {
                const posNum = index + 1;
                if (pos === null) {
                    positionsHTML += `
                        <div class="engine-position-card">
                            <div class="position-header">Position ${posNum}</div>
                            <div class="empty-position">
                                <i class="bi bi-inbox" style="font-size: 2rem;"></i><br>
                                No Engine Installed
                            </div>
                        </div>
                    `;
                } else {
                    positionsHTML += `
                        <div class="engine-position-card">
                            <div class="position-header">Position ${posNum}</div>
                            <div class="engine-data" style="margin-bottom: 10px; padding: 8px; background: #e7f3ff; border-radius: 4px;">
                                <div class="engine-data-item">
                                    <div class="engine-data-label"><strong>Orig. ESN</strong></div>
                                    <div class="engine-data-value" style="color: #0066cc; font-weight: bold;">${pos.original_sn}</div>
                                </div>
                                <div class="engine-data-item">
                                    <div class="engine-data-label"><strong>Current S/N</strong></div>
                                    <div class="engine-data-value" style="color: #0066cc; font-weight: bold;">${pos.current_sn}</div>
                                </div>
                                <div class="engine-data-item">
                                    <div class="engine-data-label"><strong>GSS ID</strong></div>
                                    <div class="engine-data-value" style="color: #0066cc; font-weight: bold;">${pos.gss_sn}</div>
                                </div>
                            </div>
                            <div class="engine-data">
                                <div class="engine-data-item">
                                    <div class="engine-data-label">TSN on A/C</div>
                                    <div class="engine-data-value highlight">${pos.tsn_on_aircraft} hrs</div>
                                </div>
                                <div class="engine-data-item">
                                    <div class="engine-data-label">CSN on A/C</div>
                                    <div class="engine-data-value highlight">${pos.csn_on_aircraft} cyc</div>
                                </div>
                                <div class="engine-data-item">
                                    <div class="engine-data-label">Total TSN</div>
                                    <div class="engine-data-value">${pos.total_tsn} hrs</div>
                                </div>
                                <div class="engine-data-item">
                                    <div class="engine-data-label">Total CSN</div>
                                    <div class="engine-data-value">${pos.total_csn} cyc</div>
                                </div>
                                <div class="engine-data-item">
                                    <div class="engine-data-label">N1 Takeoff</div>
                                    <div class="engine-data-value">${pos.n1_takeoff !== null ? pos.n1_takeoff + '%' : 'N/A'}</div>
                                </div>
                                <div class="engine-data-item">
                                    <div class="engine-data-label">N1 Cruise</div>
                                    <div class="engine-data-value">${pos.n1_cruise !== null ? pos.n1_cruise + '%' : 'N/A'}</div>
                                </div>
                                <div class="engine-data-item">
                                    <div class="engine-data-label">N2 Takeoff</div>
                                    <div class="engine-data-value">${pos.n2_takeoff !== null ? pos.n2_takeoff + '%' : 'N/A'}</div>
                                </div>
                                <div class="engine-data-item">
                                    <div class="engine-data-label">N2 Cruise</div>
                                    <div class="engine-data-value">${pos.n2_cruise !== null ? pos.n2_cruise + '%' : 'N/A'}</div>
                                </div>
                                <div class="engine-data-item">
                                    <div class="engine-data-label">EGT Takeoff</div>
                                    <div class="engine-data-value">${pos.egt_takeoff !== null ? pos.egt_takeoff + '°C' : 'N/A'}</div>
                                </div>
                                <div class="engine-data-item">
                                    <div class="engine-data-label">EGT Cruise</div>
                                    <div class="engine-data-value">${pos.egt_cruise !== null ? pos.egt_cruise + '°C' : 'N/A'}</div>
                                </div>
                                <div class="engine-data-item">
                                    <div class="engine-data-label">Installed</div>
                                    <div class="engine-data-value">${pos.install_date}</div>
                                </div>
                                <div class="engine-data-item">
                                    <div class="engine-data-label">Param Date</div>
                                    <div class="engine-data-value param-date-value">${pos.param_date || 'N/A'}</div>
                                </div>
                            </div>
                        </div>
                    `;
                }
            });
            
            fleetContainer.insertAdjacentHTML('beforeend', `
                <div class="col-lg-4 col-md-6">
                    <div class="aircraft-card" id="${cardId}">
                        <div class="aircraft-visual-main">
                            <video id="engine-video-${ac.aircraft_id}" class="engine-video" src="/static/engine-fan.mp4" preload="auto" autoplay loop muted playsinline></video>
                        </div>
                        
                        <div class="aircraft-card-header">
                            <div class="aircraft-name">${ac.tail_number}</div>
                            <div class="aircraft-stats">
                                <div class="aircraft-hours">${ac.total_time} hrs</div>
                                <div class="aircraft-hours-label">Total Time</div>
                                <div class="aircraft-hours" style="font-size: 0.9rem; margin-top: 4px;">${ac.total_cycles} cyc</div>
                            </div>
                        </div>
                        ${ac.last_data_date ? `
                        <div style="padding: 6px 14px 0 14px; color: #17a2b8; font-size: 0.75rem; cursor: pointer; opacity: 0.9;" 
                             onclick="openUtilizationHistoryModal('${ac.tail_number}')" title="Click to view history">
                            <i class="bi bi-calendar-check"></i> Last data: ${ac.last_data_date}
                        </div>
                        ` : ''}
                        
                        <div class="chevron-toggle-top" data-aircraft-id="${ac.aircraft_id}">
                            <i class="bi bi-chevron-down" id="${chevronId}"></i>
                        </div>
                        
                        <div class="engine-positions" id="${positionsId}">
                            ${periodHTML}${positionsHTML}
                        </div>
                    </div>
                </div>
            `);
        });
        
        // Добавляем обработчики событий для всех кнопок-шевронов после создания HTML
        document.querySelectorAll('.chevron-toggle-top').forEach(toggle => {
            toggle.addEventListener('click', function() {
                const aircraftId = this.getAttribute('data-aircraft-id');
                toggleEnginePositions(aircraftId);
            });
        });
        
        // Initialize 3D engines for all aircraft cards
        initializeAllEngines();

        ensureEngineVideosPlaying();
        
        // Load recent actions
        await loadRecentActions();
        
        // Update Parts Cards Counts
        await updatePartsCardCounts();
        
    } catch (error) {
        console.error('Error loading dashboard data:', error);
        alert('Failed to load dashboard data. Check console for details.');
    }
}

    // --- THREE.JS 3D ENGINE ANIMATION ---
    
    const engineScenes = {}; // Store scenes for each aircraft

    // === RECENT ACTIONS (Activity Log) ===
    // Helper with timeout and graceful fallback
    async function safeFetch(url, options = {}, timeoutMs = 7000) {
        try {
            const controller = new AbortController();
            const id = setTimeout(() => controller.abort(), timeoutMs);
            const res = await fetch(url, { ...options, signal: controller.signal });
            clearTimeout(id);
            return res;
        } catch (e) {
            return null;
        }
    }
    
    // Debounce helper to avoid duplicate calls
    let lastRefreshTime = 0;
    function refreshAfterDataChange() {
        const now = Date.now();
        if (now - lastRefreshTime < 500) return; // Ignore if called within 500ms
        lastRefreshTime = now;
        
        loadRecentActions();
        updateNotificationCount();
    }

    let recentActionsIntervalId = null;
    let repairHistoryIntervalId = null;
    let partsHistoryIntervalId = null;
    let utilHistoryIntervalId = null;
    const recentActionRangeLabels = {
        '1d': 'older than 1 day',
        '3d': 'older than 3 days',
        '7d': 'older than 1 week',
        '30d': 'older than 1 month',
        'all': 'all time'
    };

    async function loadRecentActions() {
        const tbody = document.getElementById('recent-actions-body');
        if (!tbody) return; // not on dashboard yet

        // Show loading state only if table empty
        if (!tbody.children.length) {
            tbody.innerHTML = '<tr><td colspan="6" class="text-muted text-center py-3">Loading recent actions…</td></tr>';
        }

        // Try main endpoint, then fallback without query param
        let res = await safeFetch('/api/recent-actions?limit=50');
        if (!res || !res.ok) res = await safeFetch('/api/recent-actions');

        if (!res || !res.ok) {
            console.error('Error loading recent actions:', res && res.status);
            tbody.innerHTML = '<tr><td colspan="6" class="text-danger text-center py-3">Unable to load recent actions</td></tr>';
            return;
        }

        let actions = [];
        try { actions = await res.json(); } catch { actions = []; }

        window.recentActionsCache = Array.isArray(actions) ? actions : [];
        renderRecentActions();
        updateRecentActionsSummary();
    }

    let recentActionsExpanded = false;

    function renderRecentActions() {
        const tbody = document.getElementById('recent-actions-body');
        if (!tbody) return;
        const actions = window.recentActionsCache || [];
        tbody.innerHTML = '';

        if (!Array.isArray(actions) || actions.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" class="text-muted text-center py-3">No recent actions</td></tr>';
            return;
        }

        // When expanded show all (scroll is handled by container max-height); collapsed shows 2
        const maxVisible = recentActionsExpanded ? actions.length : 2;
        const slice = actions.slice(0, Math.min(maxVisible, actions.length));

        slice.forEach((a, idx) => {
            const tr = document.createElement('tr');
            const dateStr = a.created_at ? new Date(a.created_at).toLocaleString() : '';
            const description = formatActionMessage(a.message);
            tr.innerHTML = `
                <td>${dateStr}</td>
                <td>${a.performed_by || '-'}</td>
                <td><span class="badge bg-${a.action_type === 'created' ? 'success' : a.action_type === 'updated' ? 'primary' : 'danger'}">${a.action_type}</span></td>
                <td>${a.entity_type}</td>
                <td>${description}</td>
                <td><button type="button" class="btn btn-sm btn-outline-secondary recent-action-view" data-idx="${idx}">View</button></td>
            `;
            tbody.appendChild(tr);
        });

        // Toggle row if more items exist or always show toggle when expanded
        if (actions.length > 2) {
            const tr = document.createElement('tr');
            const chevron = recentActionsExpanded ? 'chevron-up' : 'chevron-down';
            tr.innerHTML = `
                <td colspan="6" class="text-center py-1" style="line-height: 1;">
                    <button class="btn btn-sm" style="border: none; background: transparent; padding: 0.1rem 0.35rem;" onclick="toggleRecentActions()" title="${recentActionsExpanded ? 'Свернуть' : 'Развернуть'}">
                        <i class="bi bi-${chevron}" style="font-size: 1.15rem; color: #6c757d; transition: 0.2s;"></i>
                    </button>
                </td>`;
            tbody.appendChild(tr);
        }

        // Add click handlers after rows inserted
        tbody.querySelectorAll('.recent-action-view').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const idx = parseInt(e.currentTarget.getAttribute('data-idx'));
                const all = window.recentActionsCache || [];
                if (!isNaN(idx) && all[idx]) {
                    openActionDetailsModal(all[idx]);
                }
            });
        });
    }

    function toggleRecentActions() {
        recentActionsExpanded = !recentActionsExpanded;
        renderRecentActions();
    }

    function updateRecentActionsSummary() {
        const summary = document.getElementById('recent-actions-summary');
        if (!summary) return;
        const actions = window.recentActionsCache || [];
        if (!actions.length) {
            summary.textContent = 'No recent actions loaded yet.';
            return;
        }
        const latest = actions[0]?.created_at ? new Date(actions[0].created_at).toLocaleString() : 'n/a';
        summary.textContent = `Loaded ${actions.length} items • Latest entry: ${latest}`;
    }

    async function purgeRecentActions(rangeKey) {
        const label = recentActionRangeLabels[rangeKey] || rangeKey;
        if (!confirm(`Delete recent actions ${label}?`)) return;
        try {
            const res = await fetch(`/api/recent-actions?range=${encodeURIComponent(rangeKey)}`, { method: 'DELETE' });
            const payload = await res.json().catch(() => ({}));
            if (!res.ok) {
                throw new Error(payload.detail || res.statusText || 'Delete failed');
            }
            const deleted = typeof payload.deleted === 'number' ? payload.deleted : null;
            await loadRecentActions();
            updateRecentActionsSummary();
            const deletedText = deleted !== null ? ` — removed ${deleted}` : '';
            showSuccessNotification(`Recent actions cleaned (${label})${deletedText}`);
        } catch (err) {
            console.error('Failed to purge recent actions:', err);
            showErrorNotification(`Failed to purge recent actions: ${err.message}`);
        }
    }

        async function openActionDetailsModal(action) {
                const modal = document.getElementById('action-details-modal');
                const content = document.getElementById('action-details-content');
                if (!modal || !content) return;

                // Ensure modal is attached to <body> so parent transforms/overflow don't hide it
                if (modal.parentElement !== document.body) {
                        document.body.appendChild(modal);
                }

                // Force overlay visibility and stacking above everything
                Object.assign(modal.style, {
                        display: 'flex',
                        position: 'fixed',
                        top: '0',
                        left: '0',
                        width: '100%',
                        height: '100%',
                        zIndex: '99999'
                });

                // Initial loading state
                content.innerHTML = '<div class="text-center py-4">Loading related data…</div>';

                // Render specific view by entity type
                await renderActionViewInModal(action, content);
    }

        async function renderActionViewInModal(action, contentEl) {
                const entity = (action.entity_type || '').toLowerCase();

                if (entity.includes('ship')) {
                        await renderShipmentModal(contentEl);
                        return;
                }
                if (entity.includes('install')) {
                        await renderInstallModal(contentEl);
                        return;
                }
                if (entity.includes('remove')) {
                        await renderRemoveModal(contentEl);
                        return;
                }
                if (entity.includes('repair')) {
                        await renderRepairModal(contentEl);
                        return;
                }
                if (entity.includes('part')) {
                        await renderPartsModal(contentEl);
                        return;
                }
                if (entity.includes('engine')) {
                        await renderEnginesListModal(contentEl);
                        return;
                }

                // Fallback: show basic info
                const dateStr = action.created_at ? new Date(action.created_at).toLocaleString() : '';
                const description = formatActionMessage(action.message);
                contentEl.innerHTML = `
                        <div class="mb-2"><strong>Дата и время:</strong> ${dateStr}</div>
                        <div class="mb-2"><strong>Пользователь:</strong> ${action.performed_by || '-'}</div>
                        <div class="mb-2"><strong>Действие:</strong> ${action.action_type}</div>
                        <div class="mb-2"><strong>Сущность:</strong> ${action.entity_type} (ID: ${action.entity_id ?? '-'})</div>
                        <div class="mb-3"><strong>Описание:</strong> ${description}</div>
                        <div class="d-flex justify-content-end gap-2"><button class="btn btn-secondary" onclick="closeActionDetailsModal()">Закрыть</button></div>
                `;
        }

    function formatActionMessage(msg) {
        if (!msg) return '-';
        if (typeof msg === 'string') return msg;
        if (typeof msg === 'object') {
            if (msg.summary) return msg.summary;
            try { return JSON.stringify(msg); } catch { return String(msg); }
        }
        return String(msg);
    }

        async function renderShipmentModal(container) {
                container.innerHTML = '<div class="text-muted">Loading shipment history…</div>';
                let res = await safeFetch('/api/history/SHIP' + noCache());
                if (!res || !res.ok) res = await safeFetch('/api/history/SHIP');
                if (!res || !res.ok) { container.innerHTML = '<div class="text-danger">Unable to load shipment records</div>'; return; }
                let data = []; try { data = await res.json(); } catch { data = []; }
                if (!Array.isArray(data) || data.length === 0) { container.innerHTML = '<div class="text-muted">No shipment records</div>'; return; }
                container.innerHTML = `
                        <h5 class="mb-3">Shipment History</h5>
                        <div class="table-responsive" style="max-height:60vh;">
                            <table class="table table-sm align-middle mb-0">
                                <thead><tr><th>Date</th><th>Engine</th><th>From</th><th>To</th><th>Remarks</th></tr></thead>
                                <tbody>
                                    ${data.map(row => `
                                        <tr>
                                            <td>${row.date || '-'}</td>
                                            <td><strong>${row.current_sn || '-'}</strong> <small class="text-muted">(${row.original_sn || '-'})</small></td>
                                            <td>${row.from || '-'}</td>
                                            <td><span class="badge bg-info text-dark">${row.to || '-'}</span></td>
                                            <td>${row.remarks || '-'}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                        <div class="d-flex justify-content-end mt-3"><button class="btn btn-secondary" onclick="closeActionDetailsModal()">Закрыть</button></div>
                `;
        }

        async function renderInstallModal(container) {
                container.innerHTML = '<div class="text-muted">Loading installation history…</div>';
                let res = await safeFetch('/api/history/INSTALL' + noCache());
                if (!res || !res.ok) res = await safeFetch('/api/history/INSTALL');
                if (!res || !res.ok) { container.innerHTML = '<div class="text-danger">Unable to load installations</div>'; return; }
                let data = []; try { data = await res.json(); } catch { data = []; }
                if (!Array.isArray(data) || data.length === 0) { container.innerHTML = '<div class="text-muted">No installations found</div>'; return; }
                container.innerHTML = `
                        <h5 class="mb-3">Installation History</h5>
                        <div class="table-responsive" style="max-height:60vh;">
                            <table class="table table-sm align-middle mb-0">
                                <thead><tr><th>Date</th><th>Original SN</th><th>Current SN</th><th>Install To</th><th>Position</th><th>From</th><th>TT</th><th>TC</th><th>Remarks</th></tr></thead>
                                <tbody>
                                    ${data.map(row => `
                                        <tr>
                                            <td>${row.date || '-'}</td>
                                            <td>${row.original_sn || '-'}</td>
                                            <td>${row.current_sn || '-'}</td>
                                            <td><span class="badge bg-primary">${row.install_to || '-'}</span></td>
                                            <td>${row.position || '-'}</td>
                                            <td>${row.location_from || '-'}</td>
                                            <td>${row.tt || '-'}</td>
                                            <td>${row.tc || '-'}</td>
                                            <td><small>${row.remarks || '-'}</small></td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                        <div class="d-flex justify-content-end mt-3"><button class="btn btn-secondary" onclick="closeActionDetailsModal()">Закрыть</button></div>
                `;
        }

        async function renderRemoveModal(container) {
                container.innerHTML = '<div class="text-muted">Loading removal history…</div>';
                let res = await safeFetch('/api/history/REMOVE' + noCache());
                if (!res || !res.ok) res = await safeFetch('/api/history/REMOVE');
                if (!res || !res.ok) { container.innerHTML = '<div class="text-danger">Unable to load removals</div>'; return; }
                let data = []; try { data = await res.json(); } catch { data = []; }
                if (!Array.isArray(data) || data.length === 0) { container.innerHTML = '<div class="text-muted">No removal records</div>'; return; }
                container.innerHTML = `
                        <h5 class="mb-3">Removal History</h5>
                        <div class="table-responsive" style="max-height:60vh;">
                            <table class="table table-sm align-middle mb-0">
                                <thead><tr><th>Date</th><th>Original SN</th><th>Current SN</th><th>Position</th><th>From</th><th>TT</th><th>TC</th><th>Remarks</th></tr></thead>
                                <tbody>
                                    ${data.map(row => `
                                        <tr>
                                            <td>${row.date || '-'}</td>
                                            <td>${row.original_sn || '-'}</td>
                                            <td>${row.current_sn || '-'}</td>
                                            <td>${row.position || '-'}</td>
                                            <td>${row.location_from || '-'}</td>
                                            <td>${row.tt || '-'}</td>
                                            <td>${row.tc || '-'}</td>
                                            <td><small>${row.remarks || '-'}</small></td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                        <div class="d-flex justify-content-end mt-3"><button class="btn btn-secondary" onclick="closeActionDetailsModal()">Закрыть</button></div>
                `;
        }

        async function renderRepairModal(container) {
                container.innerHTML = '<div class="text-muted">Loading repair history…</div>';
                let res = await safeFetch('/api/history/REPAIR' + noCache());
                if (!res || !res.ok) res = await safeFetch('/api/history/REPAIR');
                if (!res || !res.ok) { container.innerHTML = '<div class="text-danger">Unable to load repairs</div>'; return; }
                let data = []; try { data = await res.json(); } catch { data = []; }
                if (!Array.isArray(data) || data.length === 0) { container.innerHTML = '<div class="text-muted">No repair records</div>'; return; }
                container.innerHTML = `
                        <h5 class="mb-3">Repair History</h5>
                        <div class="table-responsive" style="max-height:60vh;">
                            <table class="table table-sm align-middle mb-0">
                                <thead><tr><th>Date</th><th>Engine</th><th>Event</th><th>Provider</th><th>Status</th><th>Remarks</th></tr></thead>
                                <tbody>
                                    ${data.map(row => `
                                        <tr>
                                            <td>${row.date || '-'}</td>
                                            <td>${row.engine_sn || '-'}</td>
                                            <td>${row.event_type || '-'}</td>
                                            <td>${row.provider || '-'}</td>
                                            <td>${row.status || '-'}</td>
                                            <td><small>${row.remarks || '-'}</small></td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                        <div class="d-flex justify-content-end mt-3"><button class="btn btn-secondary" onclick="closeActionDetailsModal()">Закрыть</button></div>
                `;
        }

        async function renderPartsModal(container) {
                container.innerHTML = '<div class="text-muted">Loading parts logistics…</div>';
                let res = await safeFetch('/api/history/PARTS' + noCache());
                if (!res || !res.ok) res = await safeFetch('/api/history/PARTS');
                if (!res || !res.ok) { container.innerHTML = '<div class="text-danger">Unable to load parts records</div>'; return; }
                let data = []; try { data = await res.json(); } catch { data = []; }
                if (!Array.isArray(data) || data.length === 0) { container.innerHTML = '<div class="text-muted">No parts records</div>'; return; }
                container.innerHTML = `
                    <h5 class="mb-3"><span data-parts-title="logistics">Parts Logistics</span></h5>
                        <div class="table-responsive" style="max-height:60vh;">
                            <table class="table table-sm align-middle mb-0">
                                <thead><tr><th>Date</th><th>Part</th><th>From</th><th>To</th><th>Qty</th><th>Remarks</th></tr></thead>
                                <tbody>
                                    ${data.map(row => `
                                        <tr>
                                            <td>${row.date || '-'}</td>
                                            <td>${row.part_name || row.part_number || '-'}</td>
                                            <td>${row.from || '-'}</td>
                                            <td>${row.to || '-'}</td>
                                            <td>${row.quantity ?? '-'}</td>
                                            <td><small>${row.remarks || '-'}</small></td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                        <div class="d-flex justify-content-end mt-3"><button class="btn btn-secondary" onclick="closeActionDetailsModal()">Закрыть</button></div>
                `;
                applyPartsSettings();
        }

        async function renderEnginesListModal(container) {
                container.innerHTML = '<div class="text-muted">Loading engines…</div>';
                let res = await safeFetch('/api/engines' + noCache());
                if (!res || !res.ok) res = await safeFetch('/api/engines');
                if (!res || !res.ok) { container.innerHTML = '<div class="text-danger">Unable to load engines</div>'; return; }
                let data = []; try { data = await res.json(); } catch { data = []; }
                if (!Array.isArray(data) || data.length === 0) { container.innerHTML = '<div class="text-muted">No engines found</div>'; return; }
                container.innerHTML = `
                        <h5 class="mb-3">Engines</h5>
                        <div class="table-responsive" style="max-height:60vh;">
                            <table class="table table-sm align-middle mb-0">
                                <thead><tr><th>Original SN</th><th>Current SN</th><th>Type</th><th>Status</th><th>Install Date</th></tr></thead>
                                <tbody>
                                    ${data.map(row => `
                                        <tr>
                                            <td>${row.original_sn || '-'}</td>
                                            <td>${row.current_sn || '-'}</td>
                                            <td>${row.engine_type || '-'}</td>
                                            <td>${row.status || '-'}</td>
                                            <td>${row.install_date || '-'}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                        <div class="d-flex justify-content-end mt-3"><button class="btn btn-secondary" onclick="closeActionDetailsModal()">Закрыть</button></div>
                `;
        }

    function closeActionDetailsModal() {
        const modal = document.getElementById('action-details-modal');
        if (modal) modal.style.display = 'none';
    }

    function navigateToAction(targetJsonStr) {
        let target = null; try { target = JSON.parse(targetJsonStr); } catch {}
        if (!target || !target.view) { closeActionDetailsModal(); return; }
        closeActionDetailsModal();
        const v = target.view;
        // Route to corresponding view and focus appropriate tab/section
        if (v === 'install') { hideAllViews(); document.getElementById('view-install').style.display='block'; updateHistory('install'); switchInstallTab(target.tab || 'info'); return; }
        if (v === 'shipment') { hideAllViews(); document.getElementById('view-shipment').style.display='block'; updateHistory('shipment'); switchShipmentTab(target.tab || 'info'); return; }
        if (v === 'remove') { hideAllViews(); document.getElementById('view-remove').style.display='block'; updateHistory('remove'); switchRemoveTab(target.tab || 'info'); return; }
        if (v === 'repair') { hideAllViews(); document.getElementById('view-repair').style.display='block'; updateHistory('repair'); switchRepairTab(target.tab || 'info'); return; }
        if (v === 'utilization_parameter') { openUtilizationParamView(); switchUtilParamTab('history'); return; }
        if (v === 'borescope') { openBoroscopeView(); switchBoroscopeTab(target.tab || 'info'); return; }
        if (v === 'purchase-orders') { openPurchaseOrdersView(); switchPurchaseOrdersTab(target.tab || 'info'); return; }
        if (v === 'store-balance') { openStoreBalanceView(); switchStoreBalanceTab('list'); return; }
        if (v === 'settings-city' || v === 'settings-fleet') {
            const modalEl = document.getElementById('settings-modal');
            const modal = new bootstrap.Modal(modalEl);
            modal.show();
            setTimeout(() => {
                const id = v === 'settings-city' ? 'collapse-city' : 'collapse-fleet';
                const el = document.getElementById(id);
                if (el && !el.classList.contains('show')) new bootstrap.Collapse(el, {toggle:true});
                el?.scrollIntoView({behavior:'smooth', block:'start'});
            }, 250);
            return;
        }
        // Fallback: go to dashboard
        openDashboardView();
    }
    
    function initializeAllEngines() {
        // Find all canvas elements and initialize 3D engines
        document.querySelectorAll('.engine-3d-canvas').forEach(canvas => {
            const aircraftId = canvas.id.replace('engine3d-', '');
            initEngine3D(canvas, aircraftId);
        });
    }
    
    function initEngine3D(canvas, aircraftId) {
        if (!canvas || !THREE) return;
        
        // Scene setup
        const scene = new THREE.Scene();
        const width = canvas.clientWidth || 160;
        const height = canvas.clientHeight || 100;
        
        // Camera - 3/4 perspective view like reference images
        const aspect = width / height;
        const camera = new THREE.PerspectiveCamera(55, aspect, 1, 500);
        camera.position.set(-55, 12, 45);
        camera.lookAt(0, 0, 0);
        
        // OrbitControls - интерактивное вращение мышкой
        const controls = new THREE.OrbitControls(camera, canvas);
        controls.enableDamping = true;
        controls.dampingFactor = 0.05;
        controls.minDistance = 30;
        controls.maxDistance = 150;
        controls.enablePan = false;
        controls.autoRotate = false;
        
        // Renderer with improved quality
        const renderer = new THREE.WebGLRenderer({ 
            canvas: canvas, 
            antialias: true, 
            alpha: true,
            powerPreference: "high-performance"
        });
        renderer.setSize(width, height);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        renderer.setClearColor(0x1a1a1a, 0);
        renderer.shadowMap.enabled = true;
        renderer.shadowMap.type = THREE.PCFSoftShadowMap;
        
        // Professional studio lighting setup
        const ambientLight = new THREE.AmbientLight(0xb0c4de, 0.5);
        scene.add(ambientLight);
        
        const keyLight = new THREE.DirectionalLight(0xffffff, 1.5);
        keyLight.position.set(-70, 50, 60);
        keyLight.castShadow = true;
        scene.add(keyLight);
        
        const fillLight = new THREE.DirectionalLight(0x88bbff, 0.6);
        fillLight.position.set(60, 30, -40);
        scene.add(fillLight);
        
        const rimLight = new THREE.DirectionalLight(0xffddaa, 0.7);
        rimLight.position.set(-40, -15, -50);
        scene.add(rimLight);
        
        const backLight = new THREE.DirectionalLight(0xff8844, 0.4);
        backLight.position.set(80, 10, 0);
        scene.add(backLight);
        
        // Engine Group Container
        const engineGroup = new THREE.Group();
        scene.add(engineGroup);
        
        // PBR Materials - highly realistic finishes based on reference images
        const nacelleBlue = new THREE.MeshStandardMaterial({ 
            color: 0x4a7cb8,
            metalness: 0.6,
            roughness: 0.3,
            envMapIntensity: 0.9
        });
        
        const nacelleLight = new THREE.MeshStandardMaterial({ 
            color: 0x8ab4d4,
            metalness: 0.5,
            roughness: 0.35
        });
        
        const casingDark = new THREE.MeshStandardMaterial({ 
            color: 0x3a3a3a,
            metalness: 0.85,
            roughness: 0.25
        });
        
        const casingLight = new THREE.MeshStandardMaterial({ 
            color: 0xa0a0a0,
            metalness: 0.9,
            roughness: 0.2
        });
        
        const fanBladeMetal = new THREE.MeshStandardMaterial({ 
            color: 0x505050,
            metalness: 0.95,
            roughness: 0.12,
            side: THREE.DoubleSide
        });
        
        const compressorBlade = new THREE.MeshStandardMaterial({ 
            color: 0xb8c8d8,
            metalness: 0.92,
            roughness: 0.08,
            emissive: 0x334455,
            emissiveIntensity: 0.1
        });
        
        const compressorDisk = new THREE.MeshStandardMaterial({ 
            color: 0xa8b8c8,
            metalness: 0.88,
            roughness: 0.15
        });
        
        const shaftTitanium = new THREE.MeshStandardMaterial({ 
            color: 0x707080,
            metalness: 0.95,
            roughness: 0.1
        });
        
        const combustorCasing = new THREE.MeshStandardMaterial({ 
            color: 0x888888,
            metalness: 0.75,
            roughness: 0.35,
            emissive: 0xff4400,
            emissiveIntensity: 0.0
        });
        
        const turbineBlade = new THREE.MeshStandardMaterial({ 
            color: 0xd4a858,
            metalness: 0.9,
            roughness: 0.15,
            emissive: 0xcc8800,
            emissiveIntensity: 0.2
        });
        
        const turbineDisk = new THREE.MeshStandardMaterial({ 
            color: 0xb89858,
            metalness: 0.88,
            roughness: 0.2,
            emissive: 0xaa7700,
            emissiveIntensity: 0.15
        });
        
        const exhaustNozzle = new THREE.MeshStandardMaterial({ 
            color: 0x909090,
            metalness: 0.85,
            roughness: 0.3,
            emissive: 0xff5500,
            emissiveIntensity: 0.0
        });
        
        // OUTER NACELLE COWLING - Large blue casing (cutaway top view)
        const nacelleGroup = new THREE.Group();
        
        // Inlet cowl - large diameter blue section
        const inletGeom = new THREE.CylinderGeometry(16, 15, 10, 48, 1, false, -0.1, Math.PI + 0.2);
        const inlet = new THREE.Mesh(inletGeom, nacelleBlue);
        inlet.rotation.z = Math.PI / 2;
        inlet.position.x = -32;
        nacelleGroup.add(inlet);
        
        // Fan cowl section (lighter blue)
        const fanCowlGeom = new THREE.CylinderGeometry(14.5, 13, 16, 48, 1, false, -0.1, Math.PI + 0.2);
        const fanCowl = new THREE.Mesh(fanCowlGeom, nacelleLight);
        fanCowl.rotation.z = Math.PI / 2;
        fanCowl.position.x = -18;
        nacelleGroup.add(fanCowl);
        
        // Main nacelle body (tapers towards rear)
        const nacelleBodyGeom = new THREE.CylinderGeometry(12, 9, 45, 48, 1, false, -0.1, Math.PI + 0.2);
        const nacelleBody = new THREE.Mesh(nacelleBodyGeom, nacelleBlue);
        nacelleBody.rotation.z = Math.PI / 2;
        nacelleBody.position.x = 8;
        nacelleGroup.add(nacelleBody);
        
        // Inlet lip (polished metal edge)
        const lipGeom = new THREE.TorusGeometry(15.5, 0.6, 20, 48, Math.PI);
        const lip = new THREE.Mesh(lipGeom, casingLight);
        lip.rotation.y = Math.PI / 2;
        lip.rotation.x = Math.PI;
        lip.position.x = -37;
        nacelleGroup.add(lip);
        
        // Cowl separation lines (panel details)
        for (let i = 0; i < 3; i++) {
            const lineGeom = new THREE.TorusGeometry(13.5 - i * 1.5, 0.08, 8, 48, Math.PI);
            const line = new THREE.Mesh(lineGeom, casingDark);
            line.rotation.y = Math.PI / 2;
            line.rotation.x = Math.PI;
            line.position.x = -10 + i * 12;
            nacelleGroup.add(line);
        }
        
        engineGroup.add(nacelleGroup);
        
        // Inner core engine casing (dark gray, structural)
        const coreOuterGeom = new THREE.CylinderGeometry(8.5, 6, 58, 48, 1, false, -0.15, Math.PI + 0.3);
        const coreOuter = new THREE.Mesh(coreOuterGeom, casingDark);
        coreOuter.rotation.z = Math.PI / 2;
        coreOuter.position.x = 0;
        engineGroup.add(coreOuter);
        
        // Bypass duct stators (visible between nacelle and core)
        for (let i = 0; i < 6; i++) {
            const angle = (i / 6) * Math.PI;
            const strutGeom = new THREE.BoxGeometry(12, 0.25, 4);
            const strut = new THREE.Mesh(strutGeom, casingLight);
            strut.position.set(-15, Math.cos(angle) * 11, Math.sin(angle) * 11);
            strut.rotation.z = angle;
            engineGroup.add(strut);
        }
        
        // CENTRAL ROTATING SHAFTS (dual spool design)
        // Low pressure shaft (larger diameter, connects fan to LPT)
        const lpShaftGeom = new THREE.CylinderGeometry(1.4, 1.3, 70, 32);
        const lpShaft = new THREE.Mesh(lpShaftGeom, shaftTitanium);
        lpShaft.rotation.z = Math.PI / 2;
        lpShaft.position.x = 0;
        engineGroup.add(lpShaft);
        
        // High pressure shaft (inside LP shaft, connects HPC to HPT)
        const hpShaftGeom = new THREE.CylinderGeometry(0.9, 0.85, 50, 24);
        const hpShaft = new THREE.Mesh(hpShaftGeom, new THREE.MeshStandardMaterial({ 
            color: 0x505060, metalness: 0.98, roughness: 0.05 
        }));
        hpShaft.rotation.z = Math.PI / 2;
        hpShaft.position.x = 5;
        engineGroup.add(hpShaft);
        
        // 1. MASSIVE INLET FAN - The most visually dominant component
        // Fan disk/hub
        const fanDiskGeom = new THREE.CylinderGeometry(4.5, 5, 5, 48);
        const fanDisk = new THREE.Mesh(fanDiskGeom, casingDark);
        fanDisk.rotation.z = Math.PI / 2;
        fanDisk.position.x = -30;
        engineGroup.add(fanDisk);
        
        // Nose cone spinner (aerodynamic)
        const spinnerGeom = new THREE.ConeGeometry(4.5, 8, 48);
        const spinner = new THREE.Mesh(spinnerGeom, casingLight);
        spinner.rotation.z = -Math.PI / 2;
        spinner.position.x = -35;
        engineGroup.add(spinner);
        
        // Wide-chord fan blades (modern design, 18-22 blades typical)
        const fanBlades = new THREE.Group();
        const numFanBlades = 20;
        for (let i = 0; i < numFanBlades; i++) {
            const angle = (i / numFanBlades) * Math.PI * 2;
            
            // Realistic wide-chord fan blade profile
            const bladeShape = new THREE.Shape();
            bladeShape.moveTo(0, 0);
            bladeShape.lineTo(1.2, 0);
            bladeShape.bezierCurveTo(2, 3, 2.5, 7, 1.8, 11);
            bladeShape.lineTo(0.4, 11);
            bladeShape.bezierCurveTo(0.8, 7, 0.6, 3, 0, 0);
            
            const extrudeSettings = { 
                depth: 0.4, 
                bevelEnabled: true, 
                bevelThickness: 0.08, 
                bevelSize: 0.08,
                bevelSegments: 3
            };
            const bladeGeom = new THREE.ExtrudeGeometry(bladeShape, extrudeSettings);
            const blade = new THREE.Mesh(bladeGeom, fanBladeMetal);
            
            // Position blade radially
            const radius = 5;
            blade.position.set(
                Math.cos(angle) * radius,
                Math.sin(angle) * radius,
                -0.2
            );
            blade.rotation.z = angle - Math.PI / 2;
            blade.rotation.y = Math.PI / 6; // Blade twist/pitch
            
            fanBlades.add(blade);
        }
        fanBlades.rotation.z = Math.PI / 2;
        fanBlades.position.x = -30;
        engineGroup.add(fanBlades);
        
        // 2. LOW PRESSURE COMPRESSOR (Booster) - 4-5 stages, beautiful blue/silver blades
        const lpcStages = [];
        const lpcBladeGroups = [];
        const lpcStatorGroups = [];
        
        for (let i = 0; i < 4; i++) {
            const radius = 7.8 - i * 0.6;
            const posX = -20 + i * 4;
            
            // Rotor disk (rotating)
            const diskGeom = new THREE.CylinderGeometry(radius + 0.3, radius - 0.3, 1.2, 48);
            const disk = new THREE.Mesh(diskGeom, compressorDisk);
            disk.rotation.z = Math.PI / 2;
            disk.position.x = posX;
            engineGroup.add(disk);
            lpcStages.push(disk);
            
            // Rotor blades (attached to disk)
            const rotorGroup = new THREE.Group();
            const numRotorBlades = 38 - i * 4;
            for (let j = 0; j < numRotorBlades; j++) {
                const angle = (j / numRotorBlades) * Math.PI * 2;
                const bladeHeight = radius * 0.65;
                const bladeGeom = new THREE.BoxGeometry(0.4, bladeHeight, 1.4);
                const blade = new THREE.Mesh(bladeGeom, compressorBlade);
                blade.position.set(
                    Math.cos(angle) * (radius * 0.65),
                    Math.sin(angle) * (radius * 0.65),
                    0
                );
                blade.rotation.z = angle;
                blade.rotation.x = -0.18; // Blade stagger angle
                rotorGroup.add(blade);
            }
            rotorGroup.rotation.z = Math.PI / 2;
            rotorGroup.position.x = posX;
            engineGroup.add(rotorGroup);
            lpcBladeGroups.push(rotorGroup);
            
            // Stator vanes (stationary, between stages)
            if (i < 3) {
                const statorGroup = new THREE.Group();
                const numStatorVanes = 42 - i * 4;
                for (let j = 0; j < numStatorVanes; j++) {
                    const angle = (j / numStatorVanes) * Math.PI * 2 + 0.05;
                    const vaneGeom = new THREE.BoxGeometry(0.3, radius * 0.6, 1.1);
                    const vane = new THREE.Mesh(vaneGeom, compressorBlade);
                    vane.position.set(
                        Math.cos(angle) * (radius * 0.7),
                        Math.sin(angle) * (radius * 0.7),
                        0
                    );
                    vane.rotation.z = angle;
                    vane.rotation.x = 0.15; // Opposite angle to rotors
                    statorGroup.add(vane);
                }
                statorGroup.rotation.z = Math.PI / 2;
                statorGroup.position.x = posX + 2;
                engineGroup.add(statorGroup);
                lpcStatorGroups.push(statorGroup);
            }
        }
        
        // 3. HIGH PRESSURE COMPRESSOR - 9-10 stages, highly compressed (blue glow visible)
        const hpcStages = [];
        const hpcBladeGroups = [];
        const hpcStatorGroups = [];
        
        for (let i = 0; i < 9; i++) {
            const radius = 5.5 - i * 0.4;
            const posX = -4 + i * 2;
            
            // HPC rotor disk (smaller, denser)
            const diskGeom = new THREE.CylinderGeometry(radius + 0.2, radius - 0.25, 0.7, 48);
            const disk = new THREE.Mesh(diskGeom, compressorDisk);
            disk.rotation.z = Math.PI / 2;
            disk.position.x = posX;
            engineGroup.add(disk);
            hpcStages.push(disk);
            
            // HPC rotor blades (very dense, many blades)
            const rotorGroup = new THREE.Group();
            const numRotorBlades = 48 - i * 3;
            for (let j = 0; j < numRotorBlades; j++) {
                const angle = (j / numRotorBlades) * Math.PI * 2;
                const bladeHeight = radius * 0.6;
                const bladeGeom = new THREE.BoxGeometry(0.28, bladeHeight, 0.9);
                const blade = new THREE.Mesh(bladeGeom, compressorBlade);
                blade.position.set(
                    Math.cos(angle) * (radius * 0.7),
                    Math.sin(angle) * (radius * 0.7),
                    0
                );
                blade.rotation.z = angle;
                blade.rotation.x = -0.25;
                rotorGroup.add(blade);
            }
            rotorGroup.rotation.z = Math.PI / 2;
            rotorGroup.position.x = posX;
            engineGroup.add(rotorGroup);
            hpcBladeGroups.push(rotorGroup);
            
            // HPC stator vanes
            if (i < 8) {
                const statorGroup = new THREE.Group();
                const numStatorVanes = 52 - i * 3;
                for (let j = 0; j < numStatorVanes; j++) {
                    const angle = (j / numStatorVanes) * Math.PI * 2 + 0.03;
                    const vaneGeom = new THREE.BoxGeometry(0.22, radius * 0.55, 0.75);
                    const vane = new THREE.Mesh(vaneGeom, compressorBlade);
                    vane.position.set(
                        Math.cos(angle) * (radius * 0.75),
                        Math.sin(angle) * (radius * 0.75),
                        0
                    );
                    vane.rotation.z = angle;
                    vane.rotation.x = 0.2;
                    statorGroup.add(vane);
                }
                statorGroup.rotation.z = Math.PI / 2;
                statorGroup.position.x = posX + 1;
                engineGroup.add(statorGroup);
                hpcStatorGroups.push(statorGroup);
            }
        }
        
        // 4. COMBUSTION CHAMBER - Annular combustor (hottest section, orange/yellow glow)
        // Outer combustor casing
        const combustorOuterGeom = new THREE.CylinderGeometry(5.5, 5.2, 8, 48);
        const combustorOuter = new THREE.Mesh(combustorOuterGeom, combustorCasing);
        combustorOuter.rotation.z = Math.PI / 2;
        combustorOuter.position.x = 15;
        engineGroup.add(combustorOuter);
        
        // Inner combustor liner (visible glow)
        const combustorInnerGeom = new THREE.CylinderGeometry(3.8, 3.8, 7, 48);
        const combustorInner = new THREE.Mesh(combustorInnerGeom, combustorCasing);
        combustorInner.rotation.z = Math.PI / 2;
        combustorInner.position.x = 15;
        engineGroup.add(combustorInner);
        
        // Flame tube with glow effect
        const flameTubeGeom = new THREE.CylinderGeometry(4.2, 4.2, 6, 32);
        const flameTube = new THREE.Mesh(flameTubeGeom, new THREE.MeshStandardMaterial({
            color: 0x664400,
            metalness: 0.3,
            roughness: 0.7,
            emissive: 0xff6600,
            emissiveIntensity: 0.0,
            transparent: true,
            opacity: 0.8
        }));
        flameTube.rotation.z = Math.PI / 2;
        flameTube.position.x = 15;
        engineGroup.add(flameTube);
        
        // Fuel nozzles (swirl vanes visible from cutaway)
        const fuelNozzleGroup = new THREE.Group();
        for (let i = 0; i < 18; i++) {
            const angle = (i / 18) * Math.PI * 2;
            const nozzleGeom = new THREE.CylinderGeometry(0.18, 0.25, 2.5, 12);
            const nozzle = new THREE.Mesh(nozzleGeom, shaftTitanium);
            nozzle.position.set(
                12,
                Math.cos(angle) * 4.8,
                Math.sin(angle) * 4.8
            );
            nozzle.rotation.z = angle;
            fuelNozzleGroup.add(nozzle);
            
            // Swirl vanes on each nozzle
            for (let v = 0; v < 6; v++) {
                const vaneAngle = (v / 6) * Math.PI * 2;
                const vaneGeom = new THREE.BoxGeometry(0.05, 0.4, 0.6);
                const vane = new THREE.Mesh(vaneGeom, casingLight);
                vane.position.set(
                    0.5,
                    Math.cos(vaneAngle) * 0.2,
                    Math.sin(vaneAngle) * 0.2
                );
                vane.rotation.x = vaneAngle;
                nozzle.add(vane);
            }
        }
        engineGroup.add(fuelNozzleGroup);
        
        // 5. HIGH PRESSURE TURBINE - 2 stages (golden/bronze, operates at 1600°C+)
        const hptStages = [];
        const hptBladeGroups = [];
        const hptStatorGroups = [];
        
        for (let i = 0; i < 2; i++) {
            const radius = 4.2 - i * 0.25;
            const posX = 20 + i * 2.5;
            
            // HPT disk (robust, golden color from heat)
            const diskGeom = new THREE.CylinderGeometry(radius + 0.2, radius + 0.1, 1.2, 48);
            const disk = new THREE.Mesh(diskGeom, turbineDisk);
            disk.rotation.z = Math.PI / 2;
            disk.position.x = posX;
            engineGroup.add(disk);
            hptStages.push(disk);
            
            // HPT rotor blades (thick, cooled blades)
            const rotorGroup = new THREE.Group();
            const numBlades = 28 - i * 4;
            for (let j = 0; j < numBlades; j++) {
                const angle = (j / numBlades) * Math.PI * 2;
                const bladeGeom = new THREE.BoxGeometry(0.55, radius * 0.7, 1.8);
                const blade = new THREE.Mesh(bladeGeom, turbineBlade);
                blade.position.set(
                    Math.cos(angle) * (radius * 0.6),
                    Math.sin(angle) * (radius * 0.6),
                    0
                );
                blade.rotation.z = angle;
                blade.rotation.x = -0.45; // High deflection angle
                rotorGroup.add(blade);
            }
            rotorGroup.rotation.z = Math.PI / 2;
            rotorGroup.position.x = posX;
            engineGroup.add(rotorGroup);
            hptBladeGroups.push(rotorGroup);
            
            // HPT nozzle guide vanes (NGVs) - stationary
            if (i === 0) {
                const nozzleGroup = new THREE.Group();
                const numNozzles = 32;
                for (let j = 0; j < numNozzles; j++) {
                    const angle = (j / numNozzles) * Math.PI * 2;
                    const nozzleGeom = new THREE.BoxGeometry(0.5, radius * 0.75, 1.5);
                    const nozzle = new THREE.Mesh(nozzleGeom, turbineBlade);
                    nozzle.position.set(
                        Math.cos(angle) * (radius * 0.65),
                        Math.sin(angle) * (radius * 0.65),
                        0
                    );
                    nozzle.rotation.z = angle;
                    nozzle.rotation.x = 0.35;
                    nozzleGroup.add(nozzle);
                }
                nozzleGroup.rotation.z = Math.PI / 2;
                nozzleGroup.position.x = 19;
                engineGroup.add(nozzleGroup);
                hptStatorGroups.push(nozzleGroup);
            }
        }
        
        // 6. LOW PRESSURE TURBINE - 5-7 stages (large diameter, drives fan)
        const lptStages = [];
        const lptBladeGroups = [];
        const lptStatorGroups = [];
        
        for (let i = 0; i < 5; i++) {
            const radius = 7.2 - i * 0.45;
            const posX = 26 + i * 3;
            
            // LPT disk (large, robust construction)
            const diskGeom = new THREE.CylinderGeometry(radius + 0.25, radius + 0.15, 1.4, 48);
            const disk = new THREE.Mesh(diskGeom, turbineDisk);
            disk.rotation.z = Math.PI / 2;
            disk.position.x = posX;
            engineGroup.add(disk);
            lptStages.push(disk);
            
            // LPT rotor blades (longer, more visible)
            const rotorGroup = new THREE.Group();
            const numBlades = 32 - i * 3;
            for (let j = 0; j < numBlades; j++) {
                const angle = (j / numBlades) * Math.PI * 2;
                const bladeHeight = radius * 0.68;
                const bladeGeom = new THREE.BoxGeometry(0.5, bladeHeight, 1.5);
                const blade = new THREE.Mesh(bladeGeom, turbineBlade);
                blade.position.set(
                    Math.cos(angle) * (radius * 0.62),
                    Math.sin(angle) * (radius * 0.62),
                    0
                );
                blade.rotation.z = angle;
                blade.rotation.x = -0.38;
                rotorGroup.add(blade);
            }
            rotorGroup.rotation.z = Math.PI / 2;
            rotorGroup.position.x = posX;
            engineGroup.add(rotorGroup);
            lptBladeGroups.push(rotorGroup);
            
            // LPT stator vanes
            if (i < 4) {
                const statorGroup = new THREE.Group();
                const numVanes = 36 - i * 3;
                for (let j = 0; j < numVanes; j++) {
                    const angle = (j / numVanes) * Math.PI * 2 + 0.04;
                    const vaneGeom = new THREE.BoxGeometry(0.45, radius * 0.62, 1.3);
                    const vane = new THREE.Mesh(vaneGeom, turbineBlade);
                    vane.position.set(
                        Math.cos(angle) * (radius * 0.67),
                        Math.sin(angle) * (radius * 0.67),
                        0
                    );
                    vane.rotation.z = angle;
                    vane.rotation.x = 0.32;
                    statorGroup.add(vane);
                }
                statorGroup.rotation.z = Math.PI / 2;
                statorGroup.position.x = posX + 1.5;
                engineGroup.add(statorGroup);
                lptStatorGroups.push(statorGroup);
            }
        }
        
        // 7. EXHAUST SECTION - Hot, glowing exit nozzle
        // Exhaust cone (tail cone/plug)
        const tailConeGeom = new THREE.CylinderGeometry(2, 4.5, 14, 48);
        const tailCone = new THREE.Mesh(tailConeGeom, exhaustNozzle);
        tailCone.rotation.z = Math.PI / 2;
        tailCone.position.x = 43;
        engineGroup.add(tailCone);
        
        // Exhaust struts (structural support for tail cone)
        const strutGroup = new THREE.Group();
        for (let i = 0; i < 6; i++) {
            const angle = (i / 6) * Math.PI * 2;
            const strutGeom = new THREE.BoxGeometry(12, 0.35, 1.2);
            const strut = new THREE.Mesh(strutGeom, casingLight);
            strut.position.set(
                43,
                Math.cos(angle) * 6.5,
                Math.sin(angle) * 6.5
            );
            strut.rotation.z = angle;
            strutGroup.add(strut);
        }
        engineGroup.add(strutGroup);
        
        // Exhaust nozzle outer ring
        const nozzleRingGeom = new THREE.CylinderGeometry(8.5, 9, 3, 48);
        const nozzleRing = new THREE.Mesh(nozzleRingGeom, exhaustNozzle);
        nozzleRing.rotation.z = Math.PI / 2;
        nozzleRing.position.x = 48;
        engineGroup.add(nozzleRing);
        
        // Hot exhaust gas plume (glowing particles)
        const exhaustPlume = new THREE.Group();
        for (let i = 0; i < 30; i++) {
            const size = 0.5 + Math.random() * 0.7;
            const particleGeom = new THREE.SphereGeometry(size, 10, 10);
            const hue = 0.08 + Math.random() * 0.08; // Orange to yellow
            const flameMat = new THREE.MeshBasicMaterial({ 
                color: new THREE.Color().setHSL(hue, 1, 0.6),
                transparent: true,
                opacity: 0.4 + Math.random() * 0.3
            });
            const particle = new THREE.Mesh(particleGeom, flameMat);
            
            // Position in exhaust stream
            particle.position.x = 50 + i * 1.5 + Math.random();
            const radialDist = (i / 30) * 4; // Expanding cone
            const angle = Math.random() * Math.PI * 2;
            particle.position.y = Math.cos(angle) * radialDist;
            particle.position.z = Math.sin(angle) * radialDist;
            
            particle.userData.offset = Math.random() * Math.PI * 2;
            particle.userData.speed = 0.6 + Math.random() * 0.6;
            particle.userData.baseX = particle.position.x;
            particle.userData.baseY = particle.position.y;
            particle.userData.baseZ = particle.position.z;
            
            exhaustPlume.add(particle);
        }
        engineGroup.add(exhaustPlume);
        
        // Heat shimmer effect (additional transparent particles)
        const heatShimmer = new THREE.Group();
        for (let i = 0; i < 15; i++) {
            const shimmerGeom = new THREE.SphereGeometry(0.8, 8, 8);
            const shimmerMat = new THREE.MeshBasicMaterial({
                color: 0xffaa44,
                transparent: true,
                opacity: 0.15
            });
            const shimmer = new THREE.Mesh(shimmerGeom, shimmerMat);
            shimmer.position.x = 52 + i * 2;
            shimmer.position.y = (Math.random() - 0.5) * 6;
            shimmer.position.z = (Math.random() - 0.5) * 6;
            shimmer.userData.offset = Math.random() * Math.PI * 2;
            heatShimmer.add(shimmer);
        }
        engineGroup.add(heatShimmer);
        
        // Add subtle rotating motion blur effect to fan
        const fanBlurGroup = new THREE.Group();
        for (let blur = 0; blur < 3; blur++) {
            const blurFan = fanBlades.clone();
            blurFan.rotation.x = (blur * Math.PI) / 12;
            blurFan.children.forEach(blade => {
                blade.material = blade.material.clone();
                blade.material.transparent = true;
                blade.material.opacity = 0.15 - blur * 0.05;
            });
            fanBlurGroup.add(blurFan);
        }
        engineGroup.add(fanBlurGroup);
        
        // Store all animation components
        engineScenes[aircraftId] = {
            scene,
            camera,
            renderer,
            controls,
            lpShaft,
            hpShaft,
            spinner,
            fanBlades,
            lpcStages,
            lpcBladeGroups,
            hpcStages,
            hpcBladeGroups,
            flameTube,
            hptStages,
            hptBladeGroups,
            lptStages,
            lptBladeGroups,
            exhaustPlume,
            heatShimmer,
            time: 0
        };
        
        // Start animation
        animateEngine(aircraftId);
    }
    
    function animateEngine(aircraftId) {
        const data = engineScenes[aircraftId];
        if (!data) return;
        
        const animate = () => {
            requestAnimationFrame(animate);
            
            // Обновляем OrbitControls
            if (data.controls) {
                data.controls.update();
            }
            
            data.time += 0.016;
            
            // N1 Spool (Low Pressure) - Fan, LPC, LPT rotate together (~3500 RPM)
            const n1Speed = 0.05;
            data.lpShaft.rotation.x += n1Speed;
            data.spinner.rotation.x += n1Speed;
            data.fanBlades.rotation.x += n1Speed;
            
            data.lpcStages.forEach(stage => {
                stage.rotation.x += n1Speed;
            });
            data.lpcBladeGroups.forEach(group => {
                group.rotation.x += n1Speed;
            });
            
            data.lptStages.forEach(stage => {
                stage.rotation.x -= n1Speed; // Turbines rotate opposite
            });
            data.lptBladeGroups.forEach(group => {
                group.rotation.x -= n1Speed;
            });
            
            // N2 Spool (High Pressure) - HPC and HPT rotate together (~12000 RPM)
            const n2Speed = 0.18;
            data.hpShaft.rotation.x += n2Speed;
            
            data.hpcStages.forEach(stage => {
                stage.rotation.x += n2Speed;
            });
            data.hpcBladeGroups.forEach(group => {
                group.rotation.x += n2Speed;
            });
            
            data.hptStages.forEach(stage => {
                stage.rotation.x -= n2Speed;
            });
            data.hptBladeGroups.forEach(group => {
                group.rotation.x -= n2Speed;
            });
            
            // Combustion chamber glow (realistic flame intensity)
            const combustionPulse = Math.sin(data.time * 7) * 0.25 + 
                                   Math.sin(data.time * 11.3) * 0.2 + 
                                   Math.sin(data.time * 15.7) * 0.15 + 0.6;
            data.flameTube.material.emissiveIntensity = combustionPulse;
            
            // Exhaust plume animation (hot gas flow)
            data.exhaustPlume.children.forEach((particle, i) => {
                const offset = particle.userData.offset;
                const speed = particle.userData.speed;
                
                // Turbulent swirling motion
                const swirl = data.time * 5 * speed + offset;
                const radialDist = (i / 30) * 4 + Math.sin(swirl) * 0.8;
                const angle = swirl * 0.3;
                
                particle.position.y = Math.cos(angle) * radialDist;
                particle.position.z = Math.sin(angle) * radialDist;
                
                // Flow downstream
                particle.position.x += 0.2 * speed;
                if (particle.position.x > 95) {
                    particle.position.x = particle.userData.baseX;
                }
                
                // Flickering and fading
                const fade = Math.max(0, 1 - (particle.position.x - 50) / 45);
                particle.material.opacity = (0.4 + Math.sin(swirl * 2) * 0.3) * fade;
                
                // Color evolution (orange -> yellow -> white as it cools)
                const progression = (particle.position.x - 50) / 45;
                const hue = Math.max(0.05, 0.12 - progression * 0.07);
                const saturation = Math.max(0.3, 1 - progression * 0.7);
                const lightness = 0.5 + progression * 0.3;
                particle.material.color.setHSL(hue, saturation, lightness);
            });
            
            // Heat shimmer effect
            data.heatShimmer.children.forEach((shimmer, i) => {
                const offset = shimmer.userData.offset;
                shimmer.position.y += Math.sin(data.time * 6 + offset) * 0.1;
                shimmer.position.z += Math.cos(data.time * 6 + offset) * 0.1;
                shimmer.material.opacity = 0.1 + Math.sin(data.time * 8 + offset) * 0.08;
            });
            
            // Dynamic camera movement for cinematic effect
            data.camera.position.y = 12 + Math.sin(data.time * 0.5) * 2;
            data.camera.position.z = 45 + Math.cos(data.time * 0.4) * 3;
            data.camera.position.x = -55 + Math.sin(data.time * 0.3) * 2;
            data.camera.lookAt(0, 0, 0);
            
            data.renderer.render(data.scene, data.camera);
        };
        
        animate();
    }
    
    // Handle window resize for responsive canvas
    window.addEventListener('resize', () => {
        Object.keys(engineScenes).forEach(aircraftId => {
            const data = engineScenes[aircraftId];
            const canvas = data.renderer.domElement;
            const width = canvas.clientWidth || 160;
            const height = canvas.clientHeight || 100;
            
            const aspect = width / height;
            data.camera.aspect = aspect;
            data.camera.updateProjectionMatrix();
            
            data.renderer.setSize(width, height);
        });
    });

    // --- 3. MODAL LOGIC (The "Magic" part) ---
    
    // A. Open Status Table (SV, US, REMOVED...)
    async function openTableModal(status) {
        // Fetch specific engines
        const res = await fetch(`/api/engines?status=${status}`);
        const engines = await res.json();
        
        setupModal(`Engines Status: ${status}`, 
            ['GSS SN', 'Orig SN', 'Current SN', 'Location', 'TT', 'TC'],
            engines.map(e => `
                <tr>
                    <td>${e.gss_sn || '-'}</td>
                    <td>${e.original_sn}</td>
                    <td><strong>${e.current_sn}</strong></td>
                    <td>${e.location}</td>
                    <td>${e.tt}</td>
                    <td>${e.tc}</td>
                </tr>
            `)
        );
    }

    // B. Open Location Table (FRU, SHJ...)
    async function openLocationModal(locId, locName) {
        // Загружаем все двигатели и фильтруем по локации
        const res = await fetch(`/api/engines`);
        const allEngines = await res.json();
        
        // Фильтруем по имени локации (бэкенд возвращает location как текст)
        const filtered = allEngines.filter(e => {
            // Проверяем, содержит ли location имя локации (например "SHJ")
            return e.location && e.location.includes(locName);
        });

        if(filtered.length === 0) {
            setupModal(`Location: ${locName}`, 
                ['GSS SN', 'Orig SN', 'Current SN', 'Status', 'TT', 'TC'],
                '<tr><td colspan="6" class="text-center text-muted">No engines at this location</td></tr>'
            );
            return;
        }

        setupModal(`Location: ${locName}`,
            ['Model', 'GSS SN', 'Orig SN', 'Current SN', 'Status', 'TT', 'TC'],
            filtered.map(e => `
                <tr>
                    <td>${e.model || '-'}</td>
                    <td>${e.gss_sn || '-'}</td>
                    <td>${e.original_sn}</td>
                    <td><strong>${e.current_sn}</strong></td>
                    <td><span class="badge bg-secondary">${e.status}</span></td>
                    <td>${e.tt}</td>
                    <td>${e.tc}</td>
                </tr>
            `)
        );
    }

    // Toggle Engine Positions Expansion
    function toggleEnginePositions(aircraftId) {
        const positions = document.getElementById(`positions-${aircraftId}`);
        const chevron = document.getElementById(`chevron-${aircraftId}`);
        
        if (!positions || !chevron) {
            console.error(`Elements not found for aircraft ${aircraftId}`);
            return;
        }
        
        if (positions.classList.contains('expanded')) {
            // Сворачиваем
            positions.classList.remove('expanded');
            chevron.classList.remove('bi-chevron-up');
            chevron.classList.add('bi-chevron-down');
        } else {
            // Разворачиваем
            positions.classList.add('expanded');
            chevron.classList.remove('bi-chevron-down');
            chevron.classList.add('bi-chevron-up');
        }
    }

    // C. Open Aircraft Table (THE BIG ONE)
    function openAircraftModal(tailNumber) {
        const ac = globalFleet.find(a => a.tail_number === tailNumber);
        if (!ac) return;

        // Columns requested: Date, Pos, Orig SN, GSS SN, Current SN, Loc From, TT, TC, N1 TO, N1 CR, N2 TO, N2 CR, Remarks
        const headers = [
            'Date', 'Pos', 'Orig SN', 'GSS SN', 'Current SN', 'Loc From', 
            'TT', 'TC', 'N1 TO', 'N1 CR', 'N2 TO', 'N2 CR', 'Remarks'
        ];

        const rows = ac.engines.map(eng => `
            <tr>
                <td>-</td> <td><strong>${eng.position}</strong></td>
                <td>${eng.original_sn}</td>
                <td>-</td> <td class="text-primary fw-bold">${eng.current_sn}</td>
                <td>-</td> <td>${eng.tt}</td>
                <td>${eng.tc}</td>
                <td class="param-col">${eng.n1_to || '-'}</td>
                <td class="param-col">${eng.n1_cr || '-'}</td>
                <td class="param-col">${eng.n2_to || '-'}</td>
                <td class="param-col">${eng.n2_cr || '-'}</td>
                <td>-</td>
            </tr>
        `);

        if (rows.length === 0) {
            rows.push(`<tr><td colspan="13" class="text-center">No engines installed</td></tr>`);
        }

        setupModal(`Aircraft: ${tailNumber} (On Wing)`, headers, rows);
    }

    // Helper to Show Modal
    function setupModal(title, headers, rowsHtml) {
        document.getElementById('modalTitle').innerText = title;
        
        // Set Headers
        const thead = document.getElementById('modalTableHead');
        thead.innerHTML = '<tr>' + headers.map(h => `<th>${h}</th>`).join('') + '</tr>';
        
        // Set Body
        const tbody = document.getElementById('modalTableBody');
        tbody.innerHTML = Array.isArray(rowsHtml) ? rowsHtml.join('') : rowsHtml;
        
        // Show
        const modal = new bootstrap.Modal(document.getElementById('dataModal'));
        modal.show();
    }
// --- INSTALLATION MODULE LOGIC ---

    // 1. Открытие раздела Installation (из меню Actions)
    async function openInstallView() {
        // Скрываем все, показываем Install
        document.querySelectorAll('.container-fluid > div').forEach(el => el.style.display = 'none'); // Скрываем Dashboard и др
        document.getElementById('view-install').style.display = 'block';
        updateHistory('install');
        // Загружаем историю по умолчанию
        await loadInstallHistory();
    }

    // 2. Переключение вкладок (Вся информация / Ввести данные)
    function switchInstallTab(tabName) {
        if (tabName === 'info') {
            document.getElementById('tab-inst-info').style.display = 'block';
            document.getElementById('tab-inst-entry').style.display = 'none';
            document.getElementById('tab-inst-info-btn').classList.add('active');
            document.getElementById('tab-inst-entry-btn').classList.remove('active');
            loadInstallHistory(); // Обновляем таблицу
        } else {
            document.getElementById('tab-inst-info').style.display = 'none';
            document.getElementById('tab-inst-entry').style.display = 'block';
            document.getElementById('tab-inst-info-btn').classList.remove('active');
            document.getElementById('tab-inst-entry-btn').classList.add('active');
            prepareInstallForm(); // Загружаем список двигателей
        }
    }

    // 3. Загрузка Истории (Таблица)
    async function loadInstallHistory() {
        const tbody = document.getElementById('install-history-body');
        if (!tbody) return;
        tbody.innerHTML = '<tr><td colspan="12" class="text-center text-muted py-3">Loading…</td></tr>';

        let res = await safeFetch('/api/history/INSTALL' + noCache());
        if (!res || !res.ok) res = await safeFetch('/api/history/INSTALL');

        if (!res || !res.ok) {
            console.error('Error loading installation history', res && res.status);
            tbody.innerHTML = '<tr><td colspan="12" class="text-center text-danger py-3">Unable to load installations</td></tr>';
            return;
        }

        let serverData = [];
        try { serverData = await res.json(); } catch { serverData = []; }

        tbody.innerHTML = '';
        if (!Array.isArray(serverData) || serverData.length === 0) {
            tbody.innerHTML = '<tr><td colspan="12" class="text-center text-muted">No installations found</td></tr>';
            return;
        }

        serverData.forEach(row => {
            tbody.innerHTML += `
                <tr data-log-id="${row.id || 0}" data-user="${row.user || row.created_by || ''}">
                    <td class="delete-col-install" style="display: none;">
                        <button class="btn btn-sm btn-danger" onclick="deleteHistoryRecord('INSTALL', ${row.id || 0}, '${row.original_sn}')" title="Delete">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                    <td>${row.date}</td>
                    <td>${row.original_sn}</td>
                    <td>${row.current_sn}</td>
                    <td><span class="badge bg-primary">${row.install_to}</span></td>
                    <td>${row.position}</td>
                    <td>${row.location_from}</td>
                    <td>${row.tt}</td>
                    <td>${row.tc}</td>
                    <td>${row.ac_ttsn}</td>
                    <td>${row.ac_tcsn}</td>
                    <td><small>${row.remarks||'-'}</small></td>
                </tr>
            `;
        });
    }
    // 5. Отправка формы (Save)
// 4. Подготовка формы (Загрузка SV двигателей)
    async function prepareInstallForm() {
        // Всегда грузим свежие данные без кеша, чтобы список был актуальным
        let res = await safeFetch('/api/engines?status=SV' + noCache().replace('?', '&')); 
        if (!res || !res.ok) res = await safeFetch('/api/engines' + noCache());
        
        let engines = [];
        try { engines = res && res.ok ? await res.json() : []; } catch { engines = []; }
        
        installableEngines = engines; // <--- ВАЖНО: Сохраняем данные в глобальную переменную
        
        const datalist = document.getElementById('engine-options'); // Ищем datalist
        datalist.innerHTML = ''; 
        
        engines.forEach(eng => {
            // Заполняем варианты для поиска
            datalist.innerHTML += `<option value="${eng.original_sn}">${eng.current_sn} (Loc: ${eng.location})</option>`;
        });
        
        // Добавляем валидацию при вводе
        const engineInput = document.getElementById('in-engine-input');
        engineInput.addEventListener('change', function() {
            const selectedEngine = engines.find(e => e.original_sn === this.value);
            if (!selectedEngine) {
                showErrorNotification('Engine not found! Please select from the list of available engines.');
                this.value = '';
                document.getElementById('in-engine-id').value = '';
                document.getElementById('in-cur-sn').value = '';
            } else {
                // Проверяем, что двигатель уже INSTALLED - это недопустимо для Installation
                if (selectedEngine.status === 'INSTALLED') {
                    const aircraftInfo = selectedEngine.aircraft ? ` on aircraft ${selectedEngine.aircraft}` : ' on some aircraft';
                    showErrorNotification(`❌ Engine ${selectedEngine.original_sn} CANNOT be installed! This engine is already INSTALLED${aircraftInfo}. Please select a different engine or remove this one first.`);
                    this.value = '';
                    document.getElementById('in-engine-id').value = '';
                    document.getElementById('in-cur-sn').value = '';
                    return;
                }
                // Проверяем статус двигателя
                if (selectedEngine.status !== 'SV') {
                    showErrorNotification(`❌ Engine ${selectedEngine.original_sn} cannot be installed! Status is ${selectedEngine.status}, must be SV (Serviceable).`);
                    this.value = '';
                    document.getElementById('in-engine-id').value = '';
                    document.getElementById('in-cur-sn').value = '';
                    return;
                }
                document.getElementById('in-engine-id').value = selectedEngine.id;
                document.getElementById('in-cur-sn').value = selectedEngine.current_sn;
            }
        });
    }
    // Guard flag to prevent double-submit
    let _installSubmitting = false;
    // 5. Отправка формы (Save)
    async function submitInstallForm() {
        if (_installSubmitting) { return; }
        _installSubmitting = true;
        const saveBtn = document.querySelector('#tab-inst-entry .btn.btn-success');
        if (saveBtn) { saveBtn.disabled = true; saveBtn.dataset._orig = saveBtn.innerHTML; saveBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Saving...'; }
        const date = document.getElementById('in-date').value;
        const engInputVal = document.getElementById('in-engine-input').value;
        const engId = document.getElementById('in-engine-id').value;
        const acId = document.getElementById('in-ac').value;
        const acText = document.getElementById('in-ac').options[document.getElementById('in-ac').selectedIndex]?.text;
        
        // Валидация обязательных полей
        if(!date || !acId || document.getElementById('in-tt').value === "" || document.getElementById('in-tc').value === "" || document.getElementById('in-ac-ttsn').value === "" || document.getElementById('in-ac-tcsn').value === "") { 
            showErrorNotification("Please fill in all required fields (*)");
            return; 
        }
        
        // Проверка что двигатель выбран из списка
        if(!engId || engId === '0' || engId === '' || !engInputVal) {
            showErrorNotification("Please select an engine from the list. You cannot add engines that are not in the system.");
            return;
        }
        
        // Проверка что выбранный двигатель есть в списке доступных
        const selectedEngine = installableEngines.find(e => e.id === parseInt(engId));
        if (!selectedEngine) {
            showErrorNotification("Selected engine not found in available engines list!");
            return;
        }
        
        // Проверка статуса двигателя
        if (selectedEngine.status !== 'SV') {
            showErrorNotification(`Engine ${selectedEngine.original_sn} cannot be installed! Current status: ${selectedEngine.status}. Only engines with status SV (Serviceable) can be installed.`);
            return;
        }
        
        const payload = {
            date: date, 
            engine_id: parseInt(engId),
            aircraft_id: parseInt(acId),
            position: parseInt(document.getElementById('in-pos').value),
            tt: parseFloat(document.getElementById('in-tt').value),
            tc: parseInt(document.getElementById('in-tc').value),
            ac_ttsn: parseFloat(document.getElementById('in-ac-ttsn').value),
            ac_tcsn: parseInt(document.getElementById('in-ac-tcsn').value),
            remarks: document.getElementById('in-rem').value
        };
        
        try {
            const res = await fetch('/api/actions/install', { 
                method: 'POST', 
                headers: {'Content-Type': 'application/json'}, 
                body: JSON.stringify(payload)
            });
            
            if (!res.ok) {
                const error = await res.json();
                throw new Error(error.detail || 'Save error');
            }

            // Очистка формы
            document.getElementById('form-install').reset(); 
            
            // Переключение на вкладку истории
            document.getElementById('tab-inst-info').style.display = 'block';
            document.getElementById('tab-inst-entry').style.display = 'none';
            document.getElementById('tab-inst-info-btn').classList.add('active');
            document.getElementById('tab-inst-entry-btn').classList.remove('active');

            // Обновляем таблицу с сервера
            await loadInstallHistory();
            
            // Обновляем Recent Actions
            refreshAfterDataChange();
            
            // Показываем уведомление об успехе
            showSuccessNotification(`Engine ${selectedEngine.original_sn} successfully installed on ${acText} position ${payload.position}!`);
            
        } catch(e) { 
            showErrorNotification("Error: " + e.message);
        } finally {
            _installSubmitting = false;
            if (saveBtn) { saveBtn.disabled = false; saveBtn.innerHTML = saveBtn.dataset._orig || 'Save Record'; }
        }
    }
        // ------------------------------------------------------------------------------------

// --- SIDEBAR MENU TOGGLES ---
    function toggleReportsMenu(forceState) {
        const submenu = document.getElementById('reports-submenu');
        const chevron = document.getElementById('reports-chevron');
        if (!submenu || !chevron) {
            return;
        }

        const isCurrentlyHidden = submenu.style.display === 'none' || submenu.style.display === '';
        const shouldOpen = typeof forceState === 'boolean' ? forceState : isCurrentlyHidden;

        if (shouldOpen) {
            submenu.style.display = 'block';
            chevron.classList.remove('bi-chevron-right');
            chevron.classList.add('bi-chevron-down');
        } else {
            submenu.style.display = 'none';
            chevron.classList.remove('bi-chevron-down');
            chevron.classList.add('bi-chevron-right');
        }
        localStorage.setItem('reports-menu-open', shouldOpen ? 'true' : 'false');
    }

    function toggleActionsMenu(forceState) {
        const submenu = document.getElementById('actions-submenu');
        const chevron = document.getElementById('actions-chevron');
        if (!submenu || !chevron) {
            return;
        }

        const isCurrentlyHidden = submenu.style.display === 'none';
        const shouldOpen = typeof forceState === 'boolean' ? forceState : isCurrentlyHidden;

        if (shouldOpen) {
            submenu.style.display = 'block';
            chevron.classList.remove('bi-chevron-right');
            chevron.classList.add('bi-chevron-down');
        } else {
            submenu.style.display = 'none';
            chevron.classList.remove('bi-chevron-down');
            chevron.classList.add('bi-chevron-right');
        }
        localStorage.setItem('actions-menu-open', shouldOpen ? 'true' : 'false');
    }

    function toggleLogisticsMenu(forceState) {
        const submenu = document.getElementById('logistics-submenu');
        const chevron = document.getElementById('logistics-chevron');
        if (!submenu || !chevron) {
            return;
        }

        const isCurrentlyHidden = submenu.style.display === 'none' || submenu.style.display === '';
        const shouldOpen = typeof forceState === 'boolean' ? forceState : isCurrentlyHidden;

        if (shouldOpen) {
            submenu.style.display = 'block';
            chevron.classList.remove('bi-chevron-right');
            chevron.classList.add('bi-chevron-down');
        } else {
            submenu.style.display = 'none';
            chevron.classList.remove('bi-chevron-down');
            chevron.classList.add('bi-chevron-right');
        }
        localStorage.setItem('logistics-menu-open', shouldOpen ? 'true' : 'false');
    }

    async function openShipmentView() {
        // ИСПРАВЛЕНИЕ: Используем hideAllViews(), чтобы корректно скрыть всё лишнее
        hideAllViews();
        
        document.getElementById('view-shipment').style.display = 'block';
        updateHistory('shipment');
        await loadShipmentHistory();
    }

// --- BORESCOPE MODULE LOGIC ---

    async function openBoroscopeView() {
        document.querySelectorAll('.container-fluid > div').forEach(el => el.style.display = 'none');
        document.getElementById('view-borescope').style.display = 'block';
        updateHistory('borescope');
        await loadBoroscopeHistory();
    }

// --- ENGINE REPORTS MODULE LOGIC ---
    async function openEngineReportsView() {
        document.querySelectorAll('.container-fluid > div').forEach(el => el.style.display = 'none');
        document.getElementById('view-engine-reports').style.display = 'block';
        updateHistory('engine-reports');
        await loadEngineReportsList();
    }

    async function loadEngineReportsList() {
        const tbody = document.getElementById('engine-reports-body');
        if (!tbody) return;
        tbody.innerHTML = '<tr><td colspan="9" class="text-center text-muted py-3">Loading engines...</td></tr>';

        let res = await safeFetch('/api/engines' + noCache());
        if (!res || !res.ok) res = await safeFetch('/api/engines');

        if (!res || !res.ok) {
            tbody.innerHTML = '<tr><td colspan="9" class="text-center text-danger py-3">Unable to load engines</td></tr>';
            return;
        }

        let engines = [];
        try { engines = await res.json(); } catch { engines = []; }

        if (!Array.isArray(engines) || engines.length === 0) {
            tbody.innerHTML = '<tr><td colspan="9" class="text-center text-muted">No engines found</td></tr>';
            return;
        }

        tbody.innerHTML = '';
        engines.forEach((eng, idx) => {
            const statusClass = {
                'SV': 'success',
                'INSTALLED': 'primary',
                'USV': 'warning',
                'REPAIR': 'danger',
                'SCRAP': 'dark'
            }[eng.status] || 'secondary';

            tbody.innerHTML += `
                <tr style="cursor: pointer;" onclick="showEngineHistoryTimeline(${eng.id}, '${eng.original_sn}')">
                    <td>${idx + 1}</td>
                    <td><strong>${eng.original_sn}</strong></td>
                    <td>${eng.current_sn}</td>
                    <td><span class="badge bg-${statusClass}">${eng.status}</span></td>
                    <td>${eng.aircraft || '-'}</td>
                    <td>${eng.location}</td>
                    <td>${eng.tt || 0}</td>
                    <td>${eng.tc || 0}</td>
                    <td>
                        <button class="btn btn-sm btn-info" onclick="event.stopPropagation(); showEngineHistoryTimeline(${eng.id}, '${eng.original_sn}')">
                            <i class="bi bi-clock-history"></i> View Timeline
                        </button>
                    </td>
                </tr>
            `;
        });
    }

    async function showEngineHistoryTimeline(engineId, serialNumber) {
        const modal = new bootstrap.Modal(document.getElementById('engineHistoryModal'));
        const modalBody = document.getElementById('engineHistoryBody');
        
        modalBody.innerHTML = `
            <div class="text-center py-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="text-muted mt-3">Loading full history for engine ${serialNumber}...</p>
            </div>
        `;
        
        modal.show();

        // Параллельно загружаем данные двигателя и его историю
        let engineRes = await safeFetch(`/api/engines/${engineId}` + noCache());
        let historyRes = await safeFetch(`/api/engines/${engineId}/history` + noCache());
        
        if (!engineRes || !engineRes.ok || !historyRes || !historyRes.ok) {
            modalBody.innerHTML = `
                <div class="timeline-no-data">
                    <i class="bi bi-exclamation-triangle text-warning" style="font-size: 3rem;"></i>
                    <p class="mt-3">Unable to load engine history. Please try again.</p>
                </div>
            `;
            return;
        }

        let engine = {};
        let history = [];
        try { 
            engine = await engineRes.json(); 
            history = await historyRes.json();
            console.log('🔍 Engine data:', engine);
            console.log('🔍 Engine history items:', history.length, 'events');
            if (history.length > 0) console.log('🔍 First event:', history[0]);
        } catch { 
            engine = {};
            history = [];
            console.error('❌ Error parsing engine/history JSON');
        }

        if (!Array.isArray(history) || history.length === 0) {
            modalBody.innerHTML = `
                <div class="timeline-header">
                    <h5>Engine ${serialNumber} - ${engine.current_sn || 'N/A'}</h5>
                    <div class="engine-meta">
                        <span><i class="bi bi-speedometer2"></i> TT: ${engine.tt || 0} hrs</span>
                        <span><i class="bi bi-arrow-repeat"></i> TC: ${engine.tc || 0} cycles</span>
                        <span><i class="bi bi-geo-alt"></i> ${engine.location || 'Unknown'}</span>
                    </div>
                </div>
                <div class="timeline-no-data">
                    <i class="bi bi-inbox text-muted" style="font-size: 3rem;"></i>
                    <p class="mt-3">No history records found for this engine.</p>
                </div>
            `;
            return;
        }

        // Сортируем историю по дате хронологически (старые события внизу, новые вверху в виде восходящей шкалы)
        history.sort((a, b) => new Date(a.date) - new Date(b.date));

        // Группируем по типу действия для иконок
        const actionIcons = {
            'INSTALL': '<i class="bi bi-arrow-up-circle"></i>',
            'REMOVE': '<i class="bi bi-arrow-down-circle"></i>',
            'REPAIR': '<i class="bi bi-wrench"></i>',
            'SHIP': '<i class="bi bi-truck"></i>',
            'PART': '<i class="bi bi-puzzle"></i>',
            'PART_ACTION': '<i class="bi bi-puzzle"></i>',
            'PART_INSTALLED': '<i class="bi bi-puzzle-fill"></i>',
            'ATLB': '<i class="bi bi-airplane"></i>',
            'FLIGHT': '<i class="bi bi-airplane"></i>',
            'INSPECT': '<i class="bi bi-eyeglass"></i>',
            'ENG_PARAM': '<i class="bi bi-gear"></i>',
            'UTIL_PARAM': '<i class="bi bi-bar-chart"></i>'
        };

        const actionLabels = {
            'INSTALL': 'Installation',
            'REMOVE': 'Removal',
            'REPAIR': 'Repair',
            'SHIP': 'Shipment',
            'PART': 'Part Installed',
            'PART_ACTION': 'Part Action',
            'PART_INSTALLED': 'Part Installed on Engine',
            'ATLB': 'Flight Log (ATLB)',
            'FLIGHT': 'Flight Log',
            'INSPECT': 'Engine Inspection/Created',
            'ENG_PARAM': 'Engine Parameters Update',
            'UTIL_PARAM': 'Utilization Update'
        };

        const actionClasses = {
            'INSTALL': 'install',
            'REMOVE': 'remove',
            'REPAIR': 'repair',
            'SHIP': 'ship',
            'PART': 'part',
            'PART_ACTION': 'part',
            'PART_INSTALLED': 'part',
            'ATLB': 'atlb',
            'FLIGHT': 'atlb',
            'INSPECT': 'inspect',
            'ENG_PARAM': 'param',
            'UTIL_PARAM': 'param'
        };

        let timelineHTML = `
            <div class="timeline-container">
                <div class="timeline-header">
                    <h5>Full History Timeline - Engine ${serialNumber}</h5>
                    <div class="engine-meta">
                        <span><i class="bi bi-card-text"></i> Current S/N: ${engine.current_sn || 'N/A'}</span>
                        <span><i class="bi bi-speedometer2"></i> Total Time: ${engine.tt || 0} hrs</span>
                        <span><i class="bi bi-arrow-repeat"></i> Total Cycles: ${engine.tc || 0}</span>
                        <span><i class="bi bi-geo-alt"></i> Location: ${engine.location || 'Unknown'}</span>
                        <span><i class="bi bi-tag"></i> Status: <span class="badge bg-info">${engine.status || 'N/A'}</span></span>
                    </div>
                </div>
                <div style="position: relative;">
                    <div class="timeline-line"></div>
        `;

        history.forEach((event, idx) => {
            const actionType = event.action_type || 'UNKNOWN';
            const icon = actionIcons[actionType] || '<i class="bi bi-question-circle"></i>';
            const label = actionLabels[actionType] || actionType;
            const cssClass = actionClasses[actionType] || 'param';
            
            let detailsHTML = '';
            if (actionType === 'INSTALL') {
                detailsHTML = `
                    <div class="timeline-details">
                        <strong>Aircraft:</strong> ${event.install_to || 'N/A'}<br>
                        <strong>Position:</strong> ${event.position || 'N/A'}<br>
                        <strong>Location From:</strong> ${event.location_from || 'N/A'}<br>
                        <strong>TT at Install:</strong> ${event.tt || 0} hrs | <strong>TC:</strong> ${event.tc || 0}
                        ${event.remarks ? `<br><strong>Remarks:</strong> ${event.remarks}` : ''}
                    </div>
                `;
            } else if (actionType === 'REMOVE') {
                detailsHTML = `
                    <div class="timeline-details">
                        <strong>From Aircraft:</strong> ${event.aircraft || 'N/A'}<br>
                        <strong>Destination:</strong> ${event.destination || 'N/A'}<br>
                        <strong>TT at Removal:</strong> ${event.tt || 0} hrs | <strong>TC:</strong> ${event.tc || 0}
                        ${event.remarks ? `<br><strong>Remarks:</strong> ${event.remarks}` : ''}
                    </div>
                `;
            } else if (actionType === 'REPAIR') {
                detailsHTML = `
                    <div class="timeline-details">
                        <strong>Station:</strong> ${event.station || 'N/A'}<br>
                        <strong>Defect:</strong> ${event.defect || 'N/A'}<br>
                        <strong>Correction:</strong> ${event.correction || 'N/A'}
                        ${event.remarks ? `<br><strong>Remarks:</strong> ${event.remarks}` : ''}
                    </div>
                `;
            } else if (actionType === 'PART' || actionType === 'PART_INSTALLED') {
                detailsHTML = `
                    <div class="timeline-details">
                        <strong>Part Number:</strong> ${event.part_number || 'N/A'}<br>
                        <strong>Part Name:</strong> ${event.part_name || 'N/A'}<br>
                        <strong>S/N:</strong> ${event.part_sn || 'N/A'}
                        ${event.remarks ? `<br><strong>Remarks:</strong> ${event.remarks}` : ''}
                    </div>
                `;
            } else if (actionType === 'ATLB' || actionType === 'FLIGHT') {
                detailsHTML = `
                    <div class="timeline-details">
                        <strong>Aircraft:</strong> ${event.aircraft || 'N/A'}<br>
                        <strong>Flight Hours:</strong> ${event.flight_hours || 0}<br>
                        <strong>Cycles:</strong> ${event.cycles || 0}
                        ${event.remarks ? `<br><strong>Remarks:</strong> ${event.remarks}` : ''}
                    </div>
                `;
            } else if (actionType === 'SHIP') {
                detailsHTML = `
                    <div class="timeline-details">
                        <strong>From Location:</strong> ${event.aircraft || 'N/A'}<br>
                        <strong>To Location:</strong> ${event.destination || 'N/A'}<br>
                        ${event.remarks ? `<strong>Waybill/Details:</strong> ${event.remarks}` : ''}
                    </div>
                `;
            } else if (actionType === 'INSPECT') {
                detailsHTML = `
                    <div class="timeline-details">
                        <strong>Location:</strong> ${event.destination || 'N/A'}<br>
                        <strong>TT:</strong> ${event.tt || 0} hrs | <strong>TC:</strong> ${event.tc || 0}
                        ${event.remarks ? `<br><strong>Details:</strong> ${event.remarks}` : ''}
                    </div>
                `;
            } else if (actionType === 'PART_ACTION') {
                detailsHTML = `
                    <div class="timeline-details">
                        <strong>Action:</strong> ${event.aircraft || 'N/A'}<br>
                        <strong>Part Name:</strong> ${event.destination || 'N/A'}<br>
                        ${event.remarks ? `<strong>Details:</strong> ${event.remarks}` : ''}
                    </div>
                `;
            } else {
                detailsHTML = `
                    <div class="timeline-details">
                        ${event.remarks ? `<strong>Details:</strong> ${event.remarks}` : '<em>No additional details</em>'}
                    </div>
                `;
            }

            timelineHTML += `
                <div class="timeline-event">
                    <div class="timeline-date">${event.date || 'Unknown date'}</div>
                    <div class="timeline-icon ${cssClass}">${icon}</div>
                    <div class="timeline-content">
                        <h6>${label} <span class="badge bg-secondary">#${idx + 1}</span></h6>
                        ${detailsHTML}
                    </div>
                </div>
            `;
        });

        timelineHTML += `
                </div>
            </div>
        `;

        modalBody.innerHTML = timelineHTML;
    }

    function switchBoroscopeTab(tabName) {
        if (tabName === 'info') {
            document.getElementById('tab-bore-info').style.display = 'block';
            document.getElementById('tab-bore-entry').style.display = 'none';
            document.getElementById('tab-bore-info-btn').classList.add('active');
            document.getElementById('tab-bore-entry-btn').classList.remove('active');
            loadBoroscopeHistory();
        } else {
            document.getElementById('tab-bore-info').style.display = 'none';
            document.getElementById('tab-bore-entry').style.display = 'block';
            document.getElementById('tab-bore-info-btn').classList.remove('active');
            document.getElementById('tab-bore-entry-btn').classList.add('active');
            prepareBoroscopeForm();
        }
    }

    async function loadBoroscopeHistory() {
        const tbody = document.getElementById('borescope-history-body');
        if (!tbody) return;
        tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted py-3">Loading…</td></tr>';

        let res = await safeFetch('/api/history/BORESCOPE' + noCache());
        if (!res || !res.ok) res = await safeFetch('/api/history/BORESCOPE');

        if (!res || !res.ok) {
            console.error('Error loading borescope history', res && res.status);
            tbody.innerHTML = '<tr><td colspan="8" class="text-center text-danger py-3">Unable to load borescope history</td></tr>';
            return;
        }

        let serverData = [];
        try { serverData = await res.json(); } catch { serverData = []; }

        tbody.innerHTML = '';
        if (!Array.isArray(serverData) || serverData.length === 0) {
            tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted py-3">No borescope inspections found</td></tr>';
            return;
        }

        serverData.forEach(row => {
            const linkHtml = row.link ? `<a href="${row.link}" target="_blank" class="btn btn-sm btn-outline-primary"><i class="bi bi-link-45deg"></i></a>` : '-';
            tbody.innerHTML += `
                <tr data-log-id="${row.id || 0}" data-user="${row.user || row.created_by || row.inspector || ''}">
                    <td class="delete-col-borescope" style="display: none;">
                        <button class="btn btn-sm btn-danger" onclick="deleteHistoryRecord('BORESCOPE', ${row.id || 0}, '')" title="Delete">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                    <td>${row.date}</td>
                    <td>${row.aircraft || '-'}</td>
                    <td>${row.serial_number || '-'}</td>
                    <td>${row.position || '-'}</td>
                    <td>${row.gss_id || '-'}</td>
                    <td>${row.inspector || '-'}</td>
                    <td>${linkHtml}</td>
                </tr>
            `;
        });
    }

    async function prepareBoroscopeForm() {
        try {
            const acRes = await fetch('/api/dashboard/aircraft-details' + noCache());
            if (!acRes.ok) throw new Error('Failed to fetch aircraft');
            
            const aircrafts = await acRes.json();
            
            const acSelect = document.getElementById('bore-aircraft');
            acSelect.innerHTML = '<option value="">Выберите...</option>';
            
            if (Array.isArray(aircrafts)) {
                aircrafts.forEach(ac => {
                    acSelect.innerHTML += `<option value="${ac.tail_number}">${ac.tail_number}</option>`;
                });
            }
        } catch (err) {
            console.error('Error loading aircraft for Borescope:', err);
            // Fallback - добавляем стандартные самолеты
            const acSelect = document.getElementById('bore-aircraft');
            acSelect.innerHTML = `
                <option value="">Выберите...</option>
                <option value="ER-BAT">ER-BAT</option>
                <option value="ER-BAR">ER-BAR</option>
                <option value="ER-BAQ">ER-BAQ</option>
            `;
        }
    }

    async function submitBoroscopeForm() {
        const date = document.getElementById('bore-date').value;
        const aircraft = document.getElementById('bore-aircraft').value;
        const serial = document.getElementById('bore-serial').value;
        const position = document.getElementById('bore-position').value;
        const gss = document.getElementById('bore-gss').value;
        const inspector = document.getElementById('bore-inspector').value;
        const link = document.getElementById('bore-link').value;
        
        // Валидация обязательных полей
        if (!date || !aircraft || !serial || !position || !inspector) {
            showErrorNotification("Please fill all required fields: Date, Aircraft, Serial Number, Position, Inspector");
            return;
        }
        
        const payload = {
            date: date,
            aircraft: aircraft,
            serial_number: serial,
            position: position,
            gss_id: gss || '',
            inspector: inspector,
            link: link || ''
        };
        
        try {
            const res = await fetch('/api/history/BORESCOPE', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            });
            
            if (!res.ok) {
                const error = await res.json();
                throw new Error(error.detail || 'Failed to save borescope inspection');
            }
            
            // Успешно сохранено
            showSuccessNotification("Borescope inspection saved successfully!");
            
            // Очищаем форму
            document.getElementById('form-borescope').reset();
            
            // Переключаемся на вкладку истории
            switchBoroscopeTab('info');
            
            // Перезагружаем таблицу с новыми данными
            await loadBoroscopeHistory();
            
        } catch (error) {
            showErrorNotification(`Error: ${error.message}`);
            console.error('Borescope save error:', error);
        }
    }

// --- PURCHASE ORDERS MODULE LOGIC ---

    async function openPurchaseOrdersView() {
        document.querySelectorAll('.container-fluid > div').forEach(el => el.style.display = 'none');
        document.getElementById('view-purchase-orders').style.display = 'block';
        updateHistory('purchase-orders');
        await loadPurchaseOrdersHistory();
    }

    function switchPurchaseOrdersTab(tabName) {
        if (tabName === 'info') {
            document.getElementById('tab-po-info').style.display = 'block';
            document.getElementById('tab-po-entry').style.display = 'none';
            document.getElementById('tab-po-info-btn').classList.add('active');
            document.getElementById('tab-po-entry-btn').classList.remove('active');
            loadPurchaseOrdersHistory();
        } else {
            document.getElementById('tab-po-info').style.display = 'none';
            document.getElementById('tab-po-entry').style.display = 'block';
            document.getElementById('tab-po-info-btn').classList.remove('active');
            document.getElementById('tab-po-entry-btn').classList.add('active');
            preparePurchaseOrderForm();
        }
    }

    async function loadPurchaseOrdersHistory() {
        const tbody = document.getElementById('purchase-orders-history-body');
        if (!tbody) return;
        
        // Загружаем конфигурацию столбцов
        let config = { columns: [] };
        try {
            const configRes = await safeFetch('/api/table-config/purchase-orders');
            if (configRes && configRes.ok) {
                config = await configRes.json();
            }
        } catch (e) {
            console.warn('Could not load column config:', e);
        }
        
        tbody.innerHTML = '<tr><td colspan="12" class="text-center text-muted py-3">Loading…</td></tr>';

        let res = await safeFetch('/api/history/PURCHASE_ORDER' + noCache());
        if (!res || !res.ok) res = await safeFetch('/api/history/PURCHASE_ORDER');

        if (!res || !res.ok) {
            console.error('Error loading purchase orders', res && res.status);
            tbody.innerHTML = '<tr><td colspan="12" class="text-center text-danger py-3">Unable to load purchase orders</td></tr>';
            return;
        }

        let serverData = [];
        try { serverData = await res.json(); } catch { serverData = []; }

        tbody.innerHTML = '';
        if (!Array.isArray(serverData) || serverData.length === 0) {
            tbody.innerHTML = '<tr><td colspan="12" class="text-center text-muted py-3">No purchase orders found</td></tr>';
            return;
        }

        serverData.forEach(row => {
            const linkHtml = row.link ? `<a href="${row.link}" target="_blank" class="btn btn-sm btn-outline-success"><i class="bi bi-link-45deg"></i></a>` : '-';
            const priceText = row.price !== null && row.price !== undefined ? row.price : '-';
            
            // Собираем значения для стандартных колонок
            let rowHtml = `
                <tr data-log-id="${row.id || 0}" data-user="${row.user || row.created_by || ''}">
                    <td class="delete-col-purchase-orders" style="display: none;">
                        <button class="btn btn-sm btn-danger" onclick="deleteHistoryRecord('PURCHASE_ORDER', ${row.id || 0}, '')" title="Delete">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                    <td>${row.date}</td>
                    <td>${row.name || '-'}</td>
                    <td>${row.part_number || '-'}</td>
                    <td>${row.serial_number || '-'}</td>
                    <td>${priceText}</td>
                    <td>${row.purpose || '-'}</td>
                    <td>${row.aircraft || '-'}</td>
                    <td>${row.ro_number || '-'}</td>
                    <td>${linkHtml}</td>
            `;
            
            rowHtml += `</tr>`;
            tbody.innerHTML += rowHtml;
        });
    }

    async function preparePurchaseOrderForm() {
        try {
            const acRes = await fetch('/api/dashboard/aircraft-details' + noCache());
            if (!acRes.ok) throw new Error('Failed to fetch aircraft');
            
            const aircrafts = await acRes.json();
            
            const acSelect = document.getElementById('po-aircraft');
            acSelect.innerHTML = '<option value="">Select...</option>';
            
            if (Array.isArray(aircrafts)) {
                aircrafts.forEach(ac => {
                    acSelect.innerHTML += `<option value="${ac.tail_number}">${ac.tail_number}</option>`;
                });
            }
        } catch (err) {
            console.error('Error loading aircraft for Purchase Orders:', err);
            // Fallback - добавляем стандартные самолеты
            const acSelect = document.getElementById('po-aircraft');
            acSelect.innerHTML = `
                <option value="">Select...</option>
                <option value="ER-BAT">ER-BAT</option>
                <option value="ER-BAR">ER-BAR</option>
                <option value="ER-BAQ">ER-BAQ</option>
            `;
        }
    }

    async function submitPurchaseOrderForm() {
        const date = document.getElementById('po-date').value;
        const name = document.getElementById('po-name').value;
        const pn = document.getElementById('po-pn').value;
        const sn = document.getElementById('po-sn').value;
        const price = document.getElementById('po-price').value;
        const purpose = document.getElementById('po-purpose').value;
        const aircraft = document.getElementById('po-aircraft').value;
        const roNumber = document.getElementById('po-ro-number').value;
        const link = document.getElementById('po-link').value;
        
        // Валидация обязательных полей
        if (!date || !name || !purpose || !aircraft || !roNumber) {
            showErrorNotification("Please fill all required fields: Date, Item Name, Purpose, Aircraft, RO Number");
            return;
        }
        
        const payload = {
            date: date,
            name: name,
            part_number: pn || '',
            serial_number: sn || '',
            price: price ? parseFloat(price) : null,
            purpose: purpose,
            aircraft: aircraft,
            ro_number: roNumber,
            link: link || ''
        };
        
        try {
            const res = await fetch('/api/history/PURCHASE_ORDER', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            });
            
            if (!res.ok) {
                const error = await res.json();
                throw new Error(error.detail || 'Failed to save purchase order');
            }
            
            // Успешно сохранено
            showSuccessNotification("Purchase order saved successfully!");
            
            // Очищаем форму
            document.getElementById('form-purchase-order').reset();
            
            // Переключаемся на вкладку истории
            switchPurchaseOrdersTab('info');
            
            // Перезагружаем таблицу с новыми данными
            await loadPurchaseOrdersHistory();
            
        } catch (error) {
            showErrorNotification(`Error: ${error.message}`);
            console.error('Purchase order save error:', error);
        }
    }

// --- SHIPMENT MODULE LOGIC ---

    async function openShipmentView() {
        hideAllViews();
        document.getElementById('view-shipment').style.display = 'block';
        updateHistory('shipment');
        await loadShipmentHistory();
    }

    function switchShipmentTab(tabName) {
        if (tabName === 'info') {
            document.getElementById('tab-ship-info').style.display = 'block';
            document.getElementById('tab-ship-entry').style.display = 'none';
            document.getElementById('tab-ship-info-btn').classList.add('active');
            document.getElementById('tab-ship-entry-btn').classList.remove('active');
            loadShipmentHistory();
        } else {
            document.getElementById('tab-ship-info').style.display = 'none';
            document.getElementById('tab-ship-entry').style.display = 'block';
            document.getElementById('tab-ship-info-btn').classList.remove('active');
            document.getElementById('tab-ship-entry-btn').classList.add('active');
            prepareShipmentForm();
        }
    }

    async function loadShipmentHistory() {
        const tbody = document.getElementById('shipment-history-body');
        if (!tbody) return;
        tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted py-3">Loading…</td></tr>';

        let res = await safeFetch('/api/history/SHIP' + noCache());
        if (!res || !res.ok) res = await safeFetch('/api/history/SHIP');

        if (!res || !res.ok) {
            console.error('Error loading shipment history', res && res.status);
            tbody.innerHTML = '<tr><td colspan="6" class="text-center text-danger py-3">Unable to load shipment records</td></tr>';
            return;
        }

        let data = [];
        try { data = await res.json(); } catch { data = []; }

        tbody.innerHTML = '';
        if (!Array.isArray(data) || data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">No shipment records</td></tr>';
            return;
        }

        data.forEach(row => {
            const identifier = `${row.current_sn || row.original_sn || 'Engine'}`;
            const safeIdentifier = escapeHtml(identifier);
            tbody.innerHTML += `
                <tr data-log-id="${row.id || row.log_id || 0}">
                    <td class="delete-col delete-col-shipment" style="display: none;">
                        <button class="btn btn-sm btn-danger" data-identifier="${safeIdentifier}" onclick="deleteHistoryRecord('SHIP', ${row.id || row.log_id || 0}, this.dataset.identifier || '')" title="Delete">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                    <td>${row.date}</td>
                    <td><strong>${row.current_sn}</strong> <small class="text-muted">(${row.original_sn})</small></td>
                    <td>${row.from}</td>
                    <td><span class="badge bg-info text-dark">${row.to}</span></td>
                    <td>${row.remarks || '-'}</td>
                </tr>
            `;
        });
    }

// Обновленная функция подготовки формы
    async function prepareShipmentForm() {
        let engRes = await safeFetch('/api/engines' + noCache());
        if (!engRes || !engRes.ok) engRes = await safeFetch('/api/engines');
        
        let engines = [];
        try { engines = engRes && engRes.ok ? await engRes.json() : []; } catch { engines = []; }
        
        // ИСПРАВЛЕНО: Теперь мы ищем правильный datalist для Shipments
        const datalist = document.getElementById('engine-options-ship');
        if(datalist) {
            datalist.innerHTML = ''; 
            engines.forEach(eng => {
                // Показываем в списке SN и где он сейчас лежит
                datalist.innerHTML += `<option value="${eng.original_sn}">${eng.current_sn} (Сейчас: ${eng.location})</option>`;
            });
        }

        // Логика при вводе двигателя
        document.getElementById('ship-engine-input').oninput = function() {
            // 1. Удаляем русские буквы на лету
            this.value = this.value.replace(/[а-яА-ЯёЁ]/g, '');
            
            const val = this.value;
            const found = engines.find(e => e.original_sn === val);
            
            if (found) {
                // Проверяем статус - INSTALLED двигатели нельзя отправлять (они на крыльях)
                if(found.status === 'INSTALLED') {
                    showErrorNotification(`❌ Engine ${found.original_sn} has status INSTALLED (On Wing). Cannot ship installed engines - remove from aircraft first.`);
                    this.value = '';
                    document.getElementById('ship-engine-id').value = '';
                    document.getElementById('ship-loc-from').value = '';
                    return;
                }
                
                // Если нашли в базе — ставим реальные данные
                document.getElementById('ship-engine-id').value = found.id;
                document.getElementById('ship-loc-from').value = found.location;
            } else {
                // Если не нашли — очищаем ID, но текст оставляем (для теста)
                document.getElementById('ship-engine-id').value = '';
                // Поле "Откуда" можно заполнить вручную
            }
        };

        // Загружаем список локаций (Куда)
        let locRes = await safeFetch('/api/locations' + noCache());
        if (!locRes || !locRes.ok) locRes = await safeFetch('/api/locations');
        
        let locations = [];
        try { locations = locRes && locRes.ok ? await locRes.json() : []; } catch { locations = []; }
        const sel = document.getElementById('ship-dest');
        sel.innerHTML = '';
        locations.forEach(loc => {
            sel.innerHTML += `<option value="${loc.id}">${loc.name} - ${loc.city}</option>`;
        });
    }

   
    async function submitShipmentForm() {
        const date = document.getElementById('ship-date').value;
        const engInputVal = document.getElementById('ship-engine-input').value;
        const engId = document.getElementById('ship-engine-id').value || 0;
        const destId = document.getElementById('ship-dest').value;
        // Получаем текст назначения для отображения
        const destText = document.getElementById('ship-dest').options[document.getElementById('ship-dest').selectedIndex]?.text || "Dest";

        if(!date || !engInputVal || !destId) {
            alert("Пожалуйста, заполните поля: Дата, Двигатель и Назначение.");
            return;
        }

        const payload = {
            date: date,
            engine_id: parseInt(engId),
            to_location_id: parseInt(destId),
            waybill: document.getElementById('ship-wb').value,
            remarks: document.getElementById('ship-rem').value
        };

        try {
            const res = await fetch('/api/actions/ship', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            });

            if(!res.ok) {
                const error = await res.json();
                throw new Error(error.detail || 'Ошибка сохранения');
            }

            // Очистка и переключение
            document.getElementById('form-shipment').reset();
            document.getElementById('ship-engine-id').value = '';
            
            document.getElementById('tab-ship-info').style.display = 'block';
            document.getElementById('tab-ship-entry').style.display = 'none';
            document.getElementById('tab-ship-info-btn').classList.add('active');
            document.getElementById('tab-ship-entry-btn').classList.remove('active');
            
            await loadShipmentHistory();
            refreshAfterDataChange();
            alert("✅ Успешно сохранено!");

        } catch(e) {
            alert("Ошибка соединения");
        }
    }  
// --- REMOVE MODULE LOGIC ---
    let localTestRemoves = []; // Временное хранилище

    async function openRemoveView() {
        hideAllViews();
        document.getElementById('view-remove').style.display = 'block';
        updateHistory('remove');
        await loadRemoveHistory();
    }
    
    function switchRemoveTab(tab) {
        if(tab === 'info') {
            document.getElementById('tab-rem-info').style.display = 'block';
            document.getElementById('tab-rem-entry').style.display = 'none';
            document.getElementById('tab-rem-info-btn').classList.add('active');
            document.getElementById('tab-rem-entry-btn').classList.remove('active');
            loadRemoveHistory();
        } else {
            document.getElementById('tab-rem-info').style.display = 'none';
            document.getElementById('tab-rem-entry').style.display = 'block';
            document.getElementById('tab-rem-info-btn').classList.remove('active');
            document.getElementById('tab-rem-entry-btn').classList.add('active');
            prepareRemoveForm();
        }
    }

    async function loadRemoveHistory() {
        const tbody = document.getElementById('remove-history-body');
        if (!tbody) return;
        tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted py-3">Loading…</td></tr>';

        let res = await safeFetch('/api/history/REMOVE' + noCache());
        if (!res || !res.ok) res = await safeFetch('/api/history/REMOVE');

        let serverData = [];
        try { serverData = res && res.ok ? await res.json() : []; } catch { serverData = []; }
        const allData = [...localTestRemoves, ...serverData];
        
        tbody.innerHTML = '';
        if(allData.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">No history found</td></tr>';
            return;
        }
        
        allData.forEach(row => {
            const isTest = row.isTest ? 'table-warning' : '';
            tbody.innerHTML += `
                <tr class="${isTest}" data-log-id="${row.id || 0}" data-user="${row.user || row.created_by || ''}">
                    <td class="delete-col-remove" style="display: none;">
                        <button class="btn btn-sm btn-danger" onclick="deleteHistoryRecord('REMOVE', ${row.id || 0}, '${row.current_sn || row.original_sn}')" title="Delete">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                    <td>${row.date}</td>
                    <td><strong>${row.current_sn || row.original_sn}</strong></td>
                    <td>${row.from}</td>
                    <td><span class="badge bg-success">${row.to}</span></td>
                    <td>${row.remarks||'-'}</td>
                </tr>`;
        });
    }

    async function prepareRemoveForm() {
        // Загружаем ТОЛЬКО установленные двигатели (status=INSTALLED)
        let engRes = await safeFetch('/api/engines?status=INSTALLED' + noCache().replace('?', '&'));
        if (!engRes || !engRes.ok) engRes = await safeFetch('/api/engines?status=INSTALLED');
        
        let engines = [];
        try { engines = engRes && engRes.ok ? await engRes.json() : []; } catch { engines = []; }
        
        // Грузим список самолетов
        let acRes = await safeFetch('/api/fleet' + noCache());
        if (!acRes || !acRes.ok) acRes = await safeFetch('/api/fleet');
        
        let aircrafts = [];
        try { aircrafts = acRes && acRes.ok ? await acRes.json() : []; } catch { aircrafts = []; }
        
        const datalist = document.getElementById('engine-options-rem');
        if(datalist) {
            datalist.innerHTML = '';
            engines.forEach(eng => {
                // Подсказка, где двигатель
                const locInfo = eng.location.includes('Pos') ? eng.location : "Storage"; 
                datalist.innerHTML += `<option value="${eng.original_sn}">${eng.current_sn} (${locInfo})</option>`;
            });
        }

        // Заполняем выпадающий список самолетов
        const acSelect = document.getElementById('rem-aircraft');
        acSelect.innerHTML = '<option value="" selected>Select engine first...</option>';
        aircrafts.forEach(ac => {
            acSelect.innerHTML += `<option value="${ac.tail_number}">${ac.tail_number} - ${ac.model}</option>`;
        });

        // Автозаполнение при вводе + Фильтр Кириллицы + Определение самолета
        const remEngineInput = document.getElementById('rem-engine-input');
        
        // Фильтр кириллицы при вводе
        remEngineInput.addEventListener('input', function() {
            this.value = this.value.replace(/[а-яА-ЯёЁ]/g, ''); // Убираем русские
        });
        
        // Валидация при выборе двигателя
        remEngineInput.addEventListener('change', function() {
            const val = this.value.trim();
            
            if (!val) {
                document.getElementById('rem-engine-id').value = '';
                document.getElementById('rem-loc-from').value = '';
                document.getElementById('rem-aircraft').value = '';
                document.getElementById('rem-aircraft').disabled = true;
                document.getElementById('rem-aircraft').classList.remove('border-success');
                return;
            }
            
            const found = engines.find(e => e.original_sn === val);
            
            if(!found) {
                showErrorNotification(`❌ Engine "${val}" not found in INSTALLED engines list. Please check the serial number or add the engine first.`);
                this.value = '';
                document.getElementById('rem-engine-id').value = '';
                document.getElementById('rem-loc-from').value = '';
                document.getElementById('rem-aircraft').value = '';
                document.getElementById('rem-aircraft').disabled = true;
                document.getElementById('rem-aircraft').classList.remove('border-success');
                return;
            }
            
            // Проверяем статус двигателя
            if(found.status !== 'INSTALLED') {
                showErrorNotification(`❌ Engine ${found.original_sn} cannot be removed! Current status: ${found.status}. Only INSTALLED engines can be removed.`);
                this.value = '';
                document.getElementById('rem-engine-id').value = '';
                document.getElementById('rem-loc-from').value = '';
                document.getElementById('rem-aircraft').value = '';
                document.getElementById('rem-aircraft').disabled = true;
                document.getElementById('rem-aircraft').classList.remove('border-success');
                return;
            }
            
            // Проверяем что двигатель установлен на самолете
            if(!found.aircraft_id || !found.aircraft) {
                showErrorNotification(`❌ Engine ${found.original_sn} is not linked to any aircraft! Cannot remove uninstalled engine. System error - please contact support.`);
                this.value = '';
                document.getElementById('rem-engine-id').value = '';
                document.getElementById('rem-loc-from').value = '';
                document.getElementById('rem-aircraft').value = '';
                document.getElementById('rem-aircraft').disabled = true;
                document.getElementById('rem-aircraft').classList.remove('border-success');
                return;
            }
            
            // Все проверки пройдены - заполняем поля
            document.getElementById('rem-engine-id').value = found.id;
            document.getElementById('rem-loc-from').value = found.location;
            
            const acSelect = document.getElementById('rem-aircraft');
            acSelect.value = found.aircraft;
            acSelect.disabled = false;
            acSelect.classList.add('border-success'); // Зеленая рамка = определено автоматически
        });

        // Грузим локации (куда снять)
        const locRes = await fetch('/api/locations' + noCache());
        const locations = await locRes.json();
        const sel = document.getElementById('rem-dest');
        sel.innerHTML = '';
        locations.forEach(loc => {
            sel.innerHTML += `<option value="${loc.id}">${loc.name}</option>`;
        });
    }

    let _removeSubmitting = false;
    async function submitRemoveForm() {
        if (_removeSubmitting) { return; }
        _removeSubmitting = true;
        const saveBtn = document.querySelector('#tab-rem-entry .btn.btn-danger.px-4');
        if (saveBtn) { saveBtn.disabled = true; saveBtn.dataset._orig = saveBtn.innerHTML; saveBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Saving...'; }
        const date = document.getElementById('rem-date').value;
        const engInput = document.getElementById('rem-engine-input').value;
        const engId = document.getElementById('rem-engine-id').value || 0;
        const destId = document.getElementById('rem-dest').value;
        const destText = document.getElementById('rem-dest').options[document.getElementById('rem-dest').selectedIndex]?.text || "Dest";

        if(!date || !engInput || !destId) { 
            showErrorNotification("Please fill in all required fields: date, engine, and destination location."); 
            return; 
        }
        
        // Проверяем что двигатель выбран из списка (существует в базе)
        if(!engId || engId === '0' || engId === '') {
            showErrorNotification("Please select an engine from the list. Engine must exist in Master Engine List.");
            return;
        }
        
        // Проверяем что двигатель установлен на самолете
        const engineCheckResponse = await fetch('/api/engines');
        const allEngines = await engineCheckResponse.json();
        const selectedEngine = allEngines.find(e => e.id === parseInt(engId));
        
        if (!selectedEngine) {
            showErrorNotification('Selected engine not found in database!');
            return;
        }
        
        if (selectedEngine.status !== 'INSTALLED') {
            showErrorNotification(`Engine ${selectedEngine.original_sn} cannot be removed! Current status: ${selectedEngine.status}. Only INSTALLED engines can be removed.`);
            return;
        }
        
        if (!selectedEngine.aircraft_id) {
            showErrorNotification(`Engine ${selectedEngine.original_sn} is not installed on any aircraft!`);
            return;
        }

        const payload = {
            date: date,
            engine_id: parseInt(engId),
            to_location_id: parseInt(destId),
            reason: document.getElementById('rem-reason').value
        };

        try {
            const res = await fetch('/api/actions/remove', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload)});
            
            if(!res.ok) {
                const error = await res.json();
                throw new Error(error.detail || 'Ошибка сохранения');
            }

            document.getElementById('form-remove').reset();
            
            document.getElementById('tab-rem-info').style.display = 'block';
            document.getElementById('tab-rem-entry').style.display = 'none';
            document.getElementById('tab-rem-info-btn').classList.add('active');
            document.getElementById('tab-rem-entry-btn').classList.remove('active');
            
            await loadRemoveHistory();
            refreshAfterDataChange();
            alert("✅ Снятие успешно!");

        } catch(e) { 
            alert("❌ Ошибка: " + e.message); 
        } finally {
            _removeSubmitting = false;
            if (saveBtn) { saveBtn.disabled = false; saveBtn.innerHTML = saveBtn.dataset._orig || 'Confirm Removal'; }
        }
    }    
// --- MASTER ENGINE LOGIC ---
    let isMainEdit = false;

    async function openMainEngineView() {
        hideAllViews();
        document.getElementById('view-main-engine').style.display = 'block';
        updateHistory('master');
        await loadMainTable();
    }

    function switchMainTab(t) {
        if(isMainEdit && t === 'add') { alert("Сначала сохраните изменения (Save Changes)!"); return; }
        document.getElementById('tab-main-list').style.display = t==='list'?'block':'none';
        document.getElementById('tab-main-add').style.display = t==='add'?'block':'none';
        document.getElementById('tab-main-list-btn').className = t==='list'?'nav-link active':'nav-link';
        document.getElementById('tab-main-add-btn').className = t==='add'?'nav-link active':'nav-link';
        
        // Если переключились на вкладку добавления - загружаем локации
        if(t === 'add') loadLocationsForForm();
    }

    // Сохраняем полный список двигателей для фильтрации
    let allEnginesData = [];
    let engineFilterState = { date: '', status: '', user: '', model: '', esn: '', gss: '', location: '', removed: '', ttMin: '', ttMax: '', tcMin: '', tcMax: '', remarks: '', hasPhoto: false };
    
    function toggleEngineFilter() {
        const panel = document.getElementById('engine-filter-panel');
        const overlay = document.getElementById('engine-filter-overlay');
        const isOpen = panel.style.right === '0px';
        
        if(isOpen) {
            panel.style.right = '-400px';
            overlay.style.display = 'none';
        } else {
            panel.style.right = '0px';
            overlay.style.display = 'block';
            if(Array.isArray(allEnginesData) && allEnginesData.length > 0) {
                updateUsersList(); // Загружаем список пользователей при открытии фильтра
            }
        }
    }
    
    function updateUsersList() {
        const users = new Set(allEnginesData.filter(e => e.performed_by).map(e => e.performed_by));
        const userSelect = document.getElementById('engine-user-filter');
        const currentVal = userSelect.value;
        
        // Сохраняем уже существующие опции
        const options = userSelect.querySelectorAll('option');
        const existingUsers = new Set();
        for(let i = 1; i < options.length; i++) {
            existingUsers.add(options[i].value);
        }
        
        // Добавляем новых пользователей
        users.forEach(user => {
            if(!existingUsers.has(user)) {
                const opt = document.createElement('option');
                opt.value = user;
                opt.textContent = user;
                userSelect.appendChild(opt);
            }
        });
        
        // Восстанавливаем выбранное значение
        userSelect.value = currentVal;
    }
    
    function applyEngineFilters() {
        const dateVal = document.getElementById('engine-date-filter').value;
        const statusVal = document.getElementById('engine-status-filter').value;
        const userVal = document.getElementById('engine-user-filter').value;
        const modelVal = document.getElementById('engine-model-filter').value.toLowerCase();
        const esnVal = document.getElementById('engine-esn-filter').value.toLowerCase();
        const gssVal = document.getElementById('engine-gss-filter').value.toLowerCase();
        const locVal = document.getElementById('engine-location-filter').value.toLowerCase();
        const removedVal = document.getElementById('engine-removed-filter').value.toLowerCase();
        const ttMin = parseFloat(document.getElementById('engine-tt-min').value) || null;
        const ttMax = parseFloat(document.getElementById('engine-tt-max').value) || null;
        const tcMin = parseFloat(document.getElementById('engine-tc-min').value) || null;
        const tcMax = parseFloat(document.getElementById('engine-tc-max').value) || null;
        const remarksVal = document.getElementById('engine-remarks-filter').value.toLowerCase();
        const hasPhoto = document.getElementById('engine-has-photo').checked;
        
        engineFilterState = { date: dateVal, status: statusVal, user: userVal, model: modelVal, esn: esnVal, gss: gssVal, location: locVal, removed: removedVal, ttMin, ttMax, tcMin, tcMax, remarks: remarksVal, hasPhoto };
        
        let filtered = allEnginesData;
        
        if(dateVal) {
            filtered = filtered.filter(eng => {
                const engDate = eng.install_date ? eng.install_date.split('T')[0] : '';
                return engDate === dateVal;
            });
        }
        
        if(statusVal) {
            filtered = filtered.filter(eng => eng.status === statusVal);
        }
        
        if(userVal) {
            filtered = filtered.filter(eng => eng.performed_by === userVal);
        }
        
        if(modelVal) {
            filtered = filtered.filter(eng => (eng.model || '').toLowerCase().includes(modelVal));
        }
        
        if(esnVal) {
            filtered = filtered.filter(eng => (eng.original_sn || '').toLowerCase().includes(esnVal));
        }
        if(gssVal) {
            filtered = filtered.filter(eng => (eng.gss_sn || '').toLowerCase().includes(gssVal));
        }
        
        if(locVal) {
            filtered = filtered.filter(eng => (eng.location || '').toLowerCase().includes(locVal));
        }
        if(removedVal) {
            filtered = filtered.filter(eng => (eng.removed_from || '').toLowerCase().includes(removedVal));
        }
        if(ttMin !== null) {
            filtered = filtered.filter(eng => (typeof eng.tt === 'number' ? eng.tt : parseFloat(eng.tt) || 0) >= ttMin);
        }
        if(ttMax !== null) {
            filtered = filtered.filter(eng => (typeof eng.tt === 'number' ? eng.tt : parseFloat(eng.tt) || 0) <= ttMax);
        }
        if(tcMin !== null) {
            filtered = filtered.filter(eng => (typeof eng.tc === 'number' ? eng.tc : parseFloat(eng.tc) || 0) >= tcMin);
        }
        if(tcMax !== null) {
            filtered = filtered.filter(eng => (typeof eng.tc === 'number' ? eng.tc : parseFloat(eng.tc) || 0) <= tcMax);
        }
        if(hasPhoto) {
            filtered = filtered.filter(eng => !!eng.photo_url);
        }
        
        if(remarksVal) {
            filtered = filtered.filter(eng => (eng.remarks || '').toLowerCase().includes(remarksVal));
        }
        
        renderEngineTable(filtered);
    }
    
    function filterEnginesByDate() {
        applyEngineFilters();
    }
    
    function filterEnginesByStatus() {
        applyEngineFilters();
    }
    
    function filterEnginesByUser() {
        applyEngineFilters();
    }
    
    function clearEngineFilters() {
        document.getElementById('engine-date-filter').value = '';
        document.getElementById('engine-status-filter').value = '';
        document.getElementById('engine-user-filter').value = '';
        document.getElementById('engine-model-filter').value = '';
        document.getElementById('engine-esn-filter').value = '';
        document.getElementById('engine-gss-filter').value = '';
        document.getElementById('engine-location-filter').value = '';
        document.getElementById('engine-removed-filter').value = '';
        document.getElementById('engine-tt-min').value = '';
        document.getElementById('engine-tt-max').value = '';
        document.getElementById('engine-tc-min').value = '';
        document.getElementById('engine-tc-max').value = '';
        document.getElementById('engine-remarks-filter').value = '';
        document.getElementById('engine-has-photo').checked = false;
        engineFilterState = { date: '', status: '', user: '', model: '', esn: '', gss: '', location: '', removed: '', ttMin: '', ttMax: '', tcMin: '', tcMax: '', remarks: '', hasPhoto: false };
        renderEngineTable(allEnginesData);
    }
    
    async function loadMainTable() {
        const tb = document.getElementById('main-engine-body');
        tb.innerHTML = '<tr><td colspan="11" class="text-center"><div class="spinner-border spinner-border-sm text-primary"></div> Loading...</td></tr>';
        
        try {
            const res = await fetch('/api/engines' + noCache());
            const engines = await res.json();
            allEnginesData = engines;
            renderEngineTable(engines);
        } catch(e) {
            console.error('Ошибка загрузки двигателей:', e);
            tb.innerHTML = '<tr><td colspan="11" class="text-center text-danger">Error loading engines. Check console.</td></tr>';
        }
    }
    
    function renderEngineTable(engines) {
        const tb = document.getElementById('main-engine-body');
        tb.innerHTML = '';
        
        if(engines.length === 0) {
            tb.innerHTML = '<tr><td colspan="11" class="text-center text-muted">No engines found. Add your first engine!</td></tr>';
            return;
        }
        
        engines.forEach((eng) => {
            let badge = 'bg-secondary';
            if(eng.status === 'SV') badge = 'bg-success';
            if(eng.status === 'US') badge = 'bg-danger';
            if(eng.status === 'INSTALLED') badge = 'bg-primary';
            if(eng.status === 'REMOVED') badge = 'bg-warning';

            const photo = eng.photo_url ? `<a href="${eng.photo_url}" target="_blank"><i class="bi bi-image"></i></a>` : '-';
            const model = eng.model || '-';
            const location = eng.location || '-';
            const remarks = eng.remarks || '-';
            const removedFrom = eng.removed_from || '-';
            const installDate = eng.install_date || '-';

            tb.innerHTML += `
                <tr data-engine-id="${eng.id}" 
                    data-original-sn="${eng.original_sn}" 
                    data-gss-sn="${eng.gss_sn}" 
                    data-model="${model}" 
                    data-status="${eng.status}"
                    data-tt="${eng.tt}"
                    data-tc="${eng.tc}"
                    data-location="${location}"
                    data-remarks="${remarks}"
                    data-removed-from="${removedFrom}"
                    data-photo="${eng.photo_url || ''}"
                    data-install-date="${installDate}">
                    <td class="delete-col" style="display: none;">
                        <div class="select-controls">
                            <input type="checkbox" class="form-check-input row-select-delete" title="Select row" />
                            <button class="btn btn-sm btn-danger trash-btn" onclick="deleteEngine(${eng.id}, '${eng.original_sn}')" title="Delete">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </td>
                    <td data-key="date">${installDate}</td>
                    <td data-key="model">${model}</td>
                    <td data-key="esn" class="fw-bold">${eng.original_sn}</td>
                    <td data-key="gss">${eng.gss_sn}</td>
                    <td data-key="status"><span class="badge ${badge}">${eng.status}</span></td>
                    <td data-key="tt">${eng.tt}</td>
                    <td data-key="tc">${eng.tc}</td>
                    <td data-key="moved">${location}</td>
                    <td data-key="removed">${removedFrom}</td>
                    <td data-key="rem">${remarks}</td>
                    <td data-key="photo">${photo}</td>
                </tr>
            `;
        });
    }

    // --- EDIT MODE LOGIC ---
    function toggleEditMode() {
        isMainEdit = true;
        // Переключаем видимость кнопок
        document.getElementById('btn-main-edit').classList.add('d-none');
        document.getElementById('btn-main-save').classList.remove('d-none');
        document.getElementById('btn-main-cancel').classList.remove('d-none');
        const btnDelSel = document.getElementById('btn-main-delete-selected');
        if (btnDelSel) btnDelSel.classList.remove('d-none');
        document.getElementById('add-row-btn').classList.remove('d-none'); // Показываем плюс

        // Показываем колонку с корзинами
        document.querySelectorAll('.delete-col').forEach(el => el.style.display = 'table-cell');
        const selAll = document.getElementById('select-all-delete');
        if (selAll) selAll.checked = false;

        // Превращаем ячейки в поля ввода
        const rows = document.querySelectorAll('#main-engine-body tr');
        rows.forEach(tr => {
            tr.classList.add('editing-row');
            
            // Получаем данные из data-атрибутов строки
            const rowData = {
                date: tr.getAttribute('data-install-date') || '',
                model: tr.getAttribute('data-model') || '-',
                originalSN: tr.getAttribute('data-original-sn') || '',
                gssSN: tr.getAttribute('data-gss-sn') || '',
                status: tr.getAttribute('data-status') || 'SV',
                tt: tr.getAttribute('data-tt') || '0',
                tc: tr.getAttribute('data-tc') || '0',
                location: tr.getAttribute('data-location') || 'SHJ',
                remarks: tr.getAttribute('data-remarks') || '',
                removedFrom: tr.getAttribute('data-removed-from') || '',
                photo: tr.getAttribute('data-photo') || ''
            };
            
            Array.from(tr.children).forEach(td => {
                const key = td.getAttribute('data-key');
                if(!key) return; // Пропускаем delete-col
                
                let inputHTML = '';
                
                if (key === 'date') {
                    inputHTML = `<input type="date" class="editing-input" value="${rowData.date && rowData.date !== '-' ? rowData.date : ''}">`;
                } else if (key === 'model') {
                    inputHTML = `<input type="text" class="editing-input" value="${rowData.model}">`;
                } else if (key === 'esn') {
                    inputHTML = `<input type="text" class="editing-input" value="${rowData.originalSN}">`;
                } else if (key === 'gss') {
                    inputHTML = `<input type="text" class="editing-input" value="${rowData.gssSN}">`;
                } else if (key === 'status') {
                    inputHTML = `
                        <select class="editing-input">
                            <option value="SV" ${rowData.status === 'SV' ? 'selected' : ''}>SV</option>
                            <option value="US" ${rowData.status === 'US' ? 'selected' : ''}>US</option>
                            <option value="AS" ${rowData.status === 'AS' ? 'selected' : ''}>AS</option>
                        </select>`;
                } else if (key === 'tt') {
                    inputHTML = `<input type="number" class="editing-input" value="${rowData.tt}">`;
                } else if (key === 'tc') {
                    inputHTML = `<input type="number" class="editing-input" value="${rowData.tc}">`;
                } else if (key === 'moved') {
                    inputHTML = `<input type="text" class="editing-input" value="${rowData.location}" readonly>`;
                } else if (key === 'removed') {
                    inputHTML = `<input type="text" class="editing-input" value="${rowData.removedFrom}">`;
                } else if (key === 'rem') {
                    inputHTML = `<input type="text" class="editing-input" value="${rowData.remarks}">`;
                } else if (key === 'photo') {
                    inputHTML = `<input type="text" class="editing-input" value="${rowData.photo}" placeholder="Link">`;
                } else {
                    const oldVal = td.innerText;
                    inputHTML = `<input type="text" class="editing-input" value="${oldVal}">`;
                }
                
                td.innerHTML = inputHTML;
            });
        });
    }

    function addEmptyRow() {
        // Добавляет пустую строку для заполнения вручную
        const tb = document.getElementById('main-engine-body');
        const newRow = document.createElement('tr');
        newRow.className = 'editing-row table-success';
        newRow.setAttribute('data-engine-id', '0'); // Новая строка, ID = 0
        
        newRow.innerHTML = `
            <td class="delete-col" style="display: table-cell;">
                <button class="btn btn-sm btn-danger" onclick="this.closest('tr').remove()" title="Delete">
                    <i class="bi bi-trash"></i>
                </button>
            </td>
            <td><input type="date" class="editing-input"></td>
            <td><input type="text" class="editing-input"></td>
            <td><input type="text" class="editing-input" placeholder="ESN"></td>
            <td><input type="text" class="editing-input"></td>
            <td><select class="editing-input"><option>SV</option><option>US</option><option>AS</option></select></td>
            <td><input type="text" class="editing-input" value="0"></td>
            <td><input type="text" class="editing-input" value="0"></td>
            <td><input type="text" class="editing-input"></td>
            <td><input type="text" class="editing-input"></td>
            <td><input type="text" class="editing-input"></td>
            <td><input type="text" class="editing-input"></td>
        `;
        tb.appendChild(newRow);
    }

    async function saveEditMode() {
        // Собираем данные из всех строк
        const rows = document.querySelectorAll('#main-engine-body tr.editing-row');
        const updatePromises = [];
        const createPromises = [];
        
        for (const tr of rows) {
            const inputs = tr.querySelectorAll('.editing-input');
            if(inputs.length === 0) continue;
            
            const engineId = tr.getAttribute('data-engine-id');
            const originalSN = inputs[2].value.trim(); // Orig ESN
            
            if (!originalSN) continue; // Пропускаем пустые строки
            
            const engineData = {
                date: inputs[0].value,
                model: inputs[1].value,
                original_sn: originalSN,
                gss_sn: inputs[3].value || originalSN,
                current_sn: originalSN, // По умолчанию = original
                status: inputs[4].value,
                total_time: parseFloat(inputs[5].value) || 0,
                total_cycles: parseInt(inputs[6].value) || 0,
                location_id: 1, // Default location (SHJ)
                removed_from: inputs[8].value || null,
                remarks: inputs[9].value,
                photo_url: inputs[10].value
            };
            
            if (engineId === '0') {
                // Новая запись - создаем через POST
                createPromises.push(
                    fetch(`/api/engines?user_id=${currentUser.id}`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(engineData)
                    }).then(async (response) => {
                        if (!response.ok) {
                            const error = await response.json();
                            throw new Error(`Create failed: ${error.detail || response.statusText}`);
                        }
                        return response;
                    })
                );
            } else {
                // Существующая запись - обновляем через PUT
                updatePromises.push(
                    fetch(`/api/engines/${engineId}`, {
                        method: 'PUT',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(engineData)
                    }).then(async (response) => {
                        if (!response.ok) {
                            const error = await response.json();
                            throw new Error(`Update failed for engine ${engineId}: ${error.detail || response.statusText}`);
                        }
                        return response;
                    })
                );
            }
        }
        
        try {
            // Выполняем все запросы
            const allPromises = [...createPromises, ...updatePromises];
            
            if (allPromises.length === 0) {
                showErrorNotification('No changes to save. Please edit at least one record.');
                return;
            }
            
            await Promise.all(allPromises);
            
            // Показываем уведомление СРАЗУ после успешного сохранения
            showSuccessNotification(`Successfully saved ${allPromises.length} engine record(s)!`);
            
            // Выходим из режима редактирования
            isMainEdit = false;
            document.getElementById('btn-main-edit').classList.remove('d-none');
            document.getElementById('btn-main-save').classList.add('d-none');
            document.getElementById('btn-main-cancel').classList.add('d-none');
            const btnDelSel = document.getElementById('btn-main-delete-selected');
            if (btnDelSel) btnDelSel.classList.add('d-none');
            document.getElementById('add-row-btn').classList.add('d-none');
            document.querySelectorAll('.delete-col').forEach(el => el.style.display = 'none');
            
            // Перезагружаем таблицу и дашборд в фоне
            await loadMainTable();
            await loadDashboardData();
            
        } catch (error) {
            showErrorNotification(`Error saving data: ${error.message}`);
            console.error('Save error:', error);
        }
    }

    function cancelEditMode() {
        isMainEdit = false;
        document.getElementById('btn-main-edit').classList.remove('d-none');
        document.getElementById('btn-main-save').classList.add('d-none');
        document.getElementById('btn-main-cancel').classList.add('d-none');
        const btnDelSel = document.getElementById('btn-main-delete-selected');
        if (btnDelSel) btnDelSel.classList.add('d-none');
        document.getElementById('add-row-btn').classList.add('d-none');
        
        // Скрываем колонку с корзинами
        document.querySelectorAll('.delete-col').forEach(el => el.style.display = 'none');
        const selAll = document.getElementById('select-all-delete');
        if (selAll) selAll.checked = false;
        
        loadMainTable();
    }

    // Выделение всех чекбоксов в колонке удаления
    function toggleSelectAllRows(master) {
        const boxes = document.querySelectorAll('#main-engine-body .row-select-delete');
        boxes.forEach(cb => cb.checked = master.checked);
    }

    // Пакетное удаление выбранных двигателей
    async function bulkDeleteSelected() {
        const selected = Array.from(document.querySelectorAll('#main-engine-body tr'))
            .map(tr => ({
                tr,
                id: parseInt(tr.getAttribute('data-engine-id') || '0', 10),
                sn: tr.getAttribute('data-original-sn') || ''
            }))
            .filter(x => x.id > 0 && x.tr.querySelector('.row-select-delete')?.checked);

        if (selected.length === 0) {
            showErrorNotification('Выберите хотя бы одну строку для удаления.');
            return;
        }

        const sample = selected.slice(0, 5).map(x => x.sn || x.id).join(', ');
        const more = selected.length > 5 ? ` … +${selected.length - 5}` : '';
        const okConfirm = confirm(`Удалить выбранные записи?\n\nВсего: ${selected.length}\nПримеры: ${sample}${more}\n\nЭто действие нельзя отменить.`);
        if (!okConfirm) return;

        try {
            const results = await Promise.allSettled(
                selected.map(x => fetch(`/api/engines/${x.id}?user_id=${currentUser.id}`, { method: 'DELETE' }))
            );
            const ok = results.filter(r => r.status === 'fulfilled' && r.value.ok).length;
            const failed = results.length - ok;

            await loadMainTable();
            await loadDashboardData();

            if (ok > 0) showSuccessNotification(`Удалено: ${ok}. Ошибок: ${failed}.`);
            if (failed > 0) showErrorNotification(`Не удалось удалить ${failed} записи. Возможно, некоторые двигатели установлены (INSTALLED).`);
        } catch (e) {
            showErrorNotification('Ошибка пакетного удаления: ' + e.message);
            console.error('bulk delete error', e);
        }
    }

    // Функция удаления двигателя с подтверждением
    async function deleteEngine(engineId, engineSN) {
        // Создаем красивое модальное окно подтверждения
        const confirmed = confirm(
            `⚠️ ВНИМАНИЕ!\n\n` +
            `Вы действительно хотите удалить двигатель?\n\n` +
            `Serial Number: ${engineSN}\n` +
            `Engine ID: ${engineId}\n\n` +
            `Это действие НЕЛЬЗЯ отменить!\n\n` +
            `Нажмите OK для удаления или Cancel для отмены.`
        );
        
        if (!confirmed) {
            return; // Пользователь нажал "Отмена"
        }
        
        try {
            // Отправляем запрос на удаление
            const res = await fetch(`/api/engines/${engineId}?user_id=${currentUser.id}`, {
                method: 'DELETE'
            });
            
            if (!res.ok) {
                const error = await res.json();
                throw new Error(error.detail || 'Ошибка удаления');
            }
            
            alert('✅ Двигатель успешно удален!');
            
            // Обновляем таблицу и Dashboard
            await loadMainTable();
            await loadDashboardData();
            
        } catch (e) {
            alert('❌ Ошибка при удалении: ' + e.message);
            console.error('Delete error:', e);
        }
    }

    // Функция удаления записи из истории (Install, Shipment, Remove, Repair, Parts, Flight)
    async function deleteHistoryRecord(actionType, logId, identifier) {
        const typeNames = {
            'INSTALL': 'Installation',
            'SHIP': 'Shipment',
            'REMOVE': 'Removal',
            'REPAIR': 'Repair',
            'PARTS': 'Parts',
            'PART_ACTION': 'Parts',
            'FLIGHT': 'Flight',
            'STORE_BALANCE': 'Store Item',
            'BORESCOPE': 'Borescope',
            'PURCHASE_ORDER': 'Purchase Order'
        };
        const typeName = typeNames[actionType] || 'Record';
        if (!logId || String(logId) === '0') {
            showErrorNotification('Unable to delete: invalid record identifier.');
            return false;
        }
        
        // Создаем красивое модальное окно подтверждения
        return new Promise((resolve) => {
            const modal = document.createElement('div');
            modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 9999; display: flex; align-items: center; justify-content: center;';
            
            modal.innerHTML = `
                <div style="background: white; border-radius: 12px; padding: 30px; max-width: 500px; box-shadow: 0 10px 40px rgba(0,0,0,0.3);">
                    <div style="text-align: center; margin-bottom: 20px;">
                        <i class="bi bi-exclamation-triangle-fill" style="font-size: 48px; color: #dc3545;"></i>
                    </div>
                    <h4 style="text-align: center; color: #dc3545; margin-bottom: 15px;">⚠️ Confirm Deletion</h4>
                    <p style="text-align: center; font-size: 16px; color: #333; margin-bottom: 10px;">
                        Are you sure you want to delete this <strong>${typeName}</strong> record?
                    </p>
                    <p style="text-align: center; font-size: 14px; color: #666; margin-bottom: 5px;">
                        <strong>Engine/Item:</strong> ${identifier}
                    </p>
                    <p style="text-align: center; font-size: 14px; color: #dc3545; margin-bottom: 25px; padding: 15px; background: #fff3cd; border-radius: 8px; border-left: 4px solid #dc3545;">
                        ⚠️ <strong>Warning:</strong> This record will be permanently deleted from the database and removed from all views. This action cannot be undone!
                    </p>
                    <div style="display: flex; gap: 15px; justify-content: center;">
                        <button id="confirm-delete-no" style="padding: 10px 30px; background: #6c757d; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 16px;">
                            ❌ Cancel
                        </button>
                        <button id="confirm-delete-yes" style="padding: 10px 30px; background: #dc3545; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 16px;">
                            ✅ Yes, Delete
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            document.getElementById('confirm-delete-yes').onclick = async () => {
                document.body.removeChild(modal);
                
                try {
                    let deleteUrl = `/api/history/${actionType}/${logId}`;
                    if (actionType === 'STORE_BALANCE') {
                        deleteUrl = `/api/store-balance/${logId}`;
                    } else if (actionType === 'PARTS') {
                        // Parts history uses PART_ACTION in backend
                        deleteUrl = `/api/history/PART_ACTION/${logId}`;
                    }

                    const res = await fetch(deleteUrl, {
                        method: 'DELETE'
                    });
                    
                    if (!res.ok) {
                        const error = await res.json();
                        throw new Error(error.detail || 'Delete failed');
                    }
                    
                    showSuccessNotification(`✅ ${typeName} record successfully deleted!`);
                    
                    // Обновляем соответствующую таблицу
                    if (actionType === 'INSTALL') await loadInstallHistory();
                    if (actionType === 'SHIP') await loadShipmentHistory();
                    if (actionType === 'REMOVE') await loadRemoveHistory();
                    if (actionType === 'REPAIR') await loadRepairHistory();
                    if (actionType === 'PARTS' || actionType === 'PART_ACTION') await loadPartsHistory();
                    if (actionType === 'FLIGHT') await loadUtilHistory();
                    if (actionType === 'STORE_BALANCE') await loadStoreBalance();
                    if (actionType === 'BORESCOPE') await loadBoroscopeHistory();
                    if (actionType === 'PURCHASE_ORDER') await loadPurchaseOrdersHistory();
                    
                    // Обновляем дашборд если это установка/снятие
                    if (actionType === 'INSTALL' || actionType === 'REMOVE') {
                        await loadDashboardData();
                    }
                    
                    resolve(true);
                } catch (e) {
                    showErrorNotification(`❌ Error deleting record: ${e.message}`);
                    console.error('Delete history error:', e);
                    resolve(false);
                }
            };
            
            document.getElementById('confirm-delete-no').onclick = () => {
                document.body.removeChild(modal);
                resolve(false);
            };
            
            // Закрытие по клику вне модального окна
            modal.onclick = (e) => {
                if (e.target === modal) {
                    document.body.removeChild(modal);
                    resolve(false);
                }
            };
        });
    }

    // Универсальная функция переключения режима удаления для любой таблицы
    function toggleDeleteMode(tableName) {
        const deleteBtn = document.getElementById(`btn-${tableName}-delete`);
        const deleteDoneBtn = document.getElementById(`btn-${tableName}-delete-done`);
        const deleteCols = document.querySelectorAll(`.delete-col-${tableName}`);
        const tbody = document.getElementById(tableConfigs[tableName]?.bodyId || `${tableName}-history-body`);
        const rows = tbody ? Array.from(tbody.querySelectorAll('tr')) : [];

        if (!deleteBtn || !deleteDoneBtn) {
            console.warn(`toggleDeleteMode: buttons missing for table ${tableName}`);
            return;
        }
        
        if (deleteBtn.classList.contains('d-none')) {
            // Выход из режима удаления
            deleteBtn.classList.remove('d-none');
            deleteDoneBtn.classList.add('d-none');
            deleteCols.forEach(el => el.style.display = 'none');
            rows.forEach(row => row.classList.remove('editing-row'));
        } else {
            // Вход в режим удаления
            deleteBtn.classList.add('d-none');
            deleteDoneBtn.classList.remove('d-none');
            deleteCols.forEach(el => el.style.display = 'table-cell');
            rows.forEach(row => row.classList.add('editing-row'));
        }
    }

    // Универсальная функция фильтрации таблиц
    function filterTable(tableBodyId, searchInputId) {
        const input = document.getElementById(searchInputId);
        const filter = input.value.toLowerCase();
        const tbody = document.getElementById(tableBodyId);
        const rows = tbody.getElementsByTagName('tr');
        
        for (let i = 0; i < rows.length; i++) {
            const row = rows[i];
            const text = row.textContent || row.innerText;
            
            if (text.toLowerCase().indexOf(filter) > -1) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        }
    }

    function escapeHtml(value) {
        if (value === undefined || value === null) return '';
        return value
            .toString()
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#39;');
    }

    // ============ УНИВЕРСАЛЬНЫЕ ФУНКЦИИ РЕДАКТИРОВАНИЯ ТАБЛИЦ ============
    
    // Конфигурация для каждой таблицы
    const tableConfigs = {
        'install': {
            bodyId: 'install-history-body',
            columns: ['date', 'original_sn', 'current_sn', 'install_to', 'position', 'location_from', 'tt', 'tc', 'remarks'],
            columnTypes: {
                date: 'date',
                position: 'number',
                tt: 'number',
                tc: 'number'
            },
            reloadFunction: loadInstallHistory,
            hasDeleteCol: true
        },
        'shipment': {
            bodyId: 'shipment-history-body',
            columns: ['date', 'current_sn', 'from', 'to', 'remarks'],
            columnTypes: {
                date: 'date'
            },
            reloadFunction: loadShipmentHistory,
            hasDeleteCol: true
        },
        'remove': {
            bodyId: 'remove-history-body',
            columns: ['date', 'current_sn', 'from', 'to', 'remarks'],
            columnTypes: {
                date: 'date'
            },
            reloadFunction: loadRemoveHistory,
            hasDeleteCol: true,
            allowRowCreation: false  // Запрещаем создание через Edit Mode
        },
        'repair': {
            bodyId: 'repair-history-body',
            columns: ['date', 'current_sn', 'vendor', 'wo', 'tt_tc', 'photo', 'remarks'],
            columnTypes: {
                date: 'date'
            },
            reloadFunction: loadRepairHistory,
            hasDeleteCol: true
        },
        'util': {
            bodyId: 'util-history-body',
            columns: ['date', 'aircraft', 'route', 'added_tt', 'added_tc', 'ref'],
            columnTypes: {
                date: 'date',
                added_tt: 'number',
                added_tc: 'number'
            },
            reloadFunction: loadUtilHistory,
            hasDeleteCol: true  // Теперь у Utilization есть delete-col
        },
        'param': {
            bodyId: 'param-history-body',
            columns: ['date', 'aircraft', 'position', 'engine_sn', 'n1_to', 'n2_to', 'egt_to', 'n1_cr', 'n2_cr', 'egt_cr', 'created_at'],
            columnTypes: {
                date: 'date',
                position: 'number',
                n1_to: 'number',
                n2_to: 'number',
                egt_to: 'number',
                n1_cr: 'number',
                n2_cr: 'number',
                egt_cr: 'number'
            },
            reloadFunction: loadParameterHistory,
            hasDeleteCol: true
        },
        'borescope': {
            bodyId: 'borescope-history-body',
            columns: ['date', 'aircraft', 'serial_number', 'position', 'gss_id', 'inspector', 'link'],
            columnTypes: {
                date: 'date'
            },
            reloadFunction: loadBoroscopeHistory,
            hasDeleteCol: true
        },
        'purchase-orders': {
            bodyId: 'purchase-orders-history-body',
            columns: ['date', 'name', 'part_number', 'serial_number', 'price', 'purpose', 'aircraft', 'ro_number', 'link'],
            columnTypes: {
                date: 'date',
                price: 'number'
            },
            reloadFunction: loadPurchaseOrdersHistory,
            hasDeleteCol: true
        },
        'store-balance': {
            bodyId: 'store-balance-body',
            columns: ['received_date', 'part_name', 'part_number', 'serial_number', 'condition', 'quantity', 'ro_number', 'location', 'status', 'owner', 'remarks'],
            columnTypes: {
                received_date: 'date',
                quantity: 'number',
                condition: 'select'
            },
            selectOptions: {
                condition: [
                    { value: 'SV - NGV (SENT)', label: 'SV - NGV (SENT)', color: '#28a745' },
                    { value: 'UNDER REPAIRING', label: 'UNDER REPAIRING', color: '#0056b3' },
                    { value: 'Delivered in Roma Italy', label: 'Delivered in Roma Italy', color: '#90ee90' },
                    { value: 'NO CAPABILITY', label: 'NO CAPABILITY', color: '#dc3545' },
                    { value: 'US - SHJ', label: 'US - SHJ', color: '#ffc107' }
                ]
            },
            reloadFunction: loadStoreBalance,
            hasDeleteCol: true
        },
        'parts': {
            bodyId: 'parts-history-body',
            columns: ['date', 'action', 'part_name', 'part_number', 'serial_number', 'quantity', 'from_esn', 'to_esn', 'location', 'reason'],
            columnTypes: {
                date: 'date',
                quantity: 'number'
            },
            reloadFunction: loadPartsHistory,
            hasDeleteCol: true
        },
        'util-param': {
            bodyId: 'util-param-history-body',
            columns: ['date', 'aircraft', 'ttsn', 'tcsn', 'period', 'date_from', 'date_to', 'created_at'],
            columnTypes: {
                date: 'date',
                ttsn: 'number',
                tcsn: 'number',
                date_from: 'date',
                date_to: 'date'
            },
            reloadFunction: loadUtilParamHistory,
            hasDeleteCol: true
        }
    };

    // Mapping table names to backend action types for delete endpoints
    const tableActionTypeMap = {
        'install': 'INSTALL',
        'shipment': 'SHIP',
        'remove': 'REMOVE',
        'repair': 'REPAIR',
        'util': 'FLIGHT',
        'param': 'PARAMETER',
        'util-param': 'PARAMETER',
        'borescope': 'BORESCOPE',
        'purchase-orders': 'PURCHASE_ORDER',
        'store-balance': 'STORE_BALANCE',
        'parts': 'PARTS'
    };

    function ensureSelectionStylesInjected() {
        if (document.getElementById('row-select-styles')) return;
        const style = document.createElement('style');
        style.id = 'row-select-styles';
        style.textContent = `
            .row-select { appearance: none; -webkit-appearance: none; width: 18px; height: 18px; border: 2px solid #6c757d; border-radius: 50%; display: inline-block; position: relative; cursor: pointer; vertical-align: middle; margin-right: 6px; }
            .row-select:checked { background-color: #dc3545; border-color: #dc3545; }
            .row-select:checked::after { content: ''; position: absolute; top: 50%; left: 50%; width: 6px; height: 6px; background: #fff; border-radius: 50%; transform: translate(-50%, -50%); }
            .row-select-disabled { opacity: 0.4; cursor: not-allowed; }
            /* Ensure delete columns have enough space for circle + trash */
            .delete-col, [class^='delete-col-'] { min-width: 64px; }
            /* Align contents neatly side by side */
            td.delete-col, td[class^='delete-col-'] { display: flex; align-items: center; justify-content: center; gap: 6px; }
        `;
        document.head.appendChild(style);
    }

    function getDeleteUrlForAction(actionType, id) {
        if (actionType === 'STORE_BALANCE') return `/api/store-balance/${id}`;
        if (actionType === 'PARTS') return `/api/history/PART_ACTION/${id}`;
        return `/api/history/${actionType}/${id}`;
    }

    function updateDeleteSelectedButtonState(tableName) {
        const btn = document.getElementById(`btn-${tableName}-delete-selected`);
        if (!btn) return;
        const config = tableConfigs[tableName];
        if (!config) { btn.disabled = true; return; }
        const tbody = document.getElementById(config.bodyId);
        if (!tbody) { btn.disabled = true; return; }
        const anySelected = !!tbody.querySelector('.row-select:checked');
        btn.disabled = !anySelected;
    }

    function insertDeleteSelectedButton(tableName) {
        const saveBtn = document.getElementById(`btn-${tableName}-save`);
        if (!saveBtn) return;
        let delBtn = document.getElementById(`btn-${tableName}-delete-selected`);
        if (!delBtn) {
            delBtn = document.createElement('button');
            delBtn.id = `btn-${tableName}-delete-selected`;
            delBtn.className = 'btn btn-sm btn-danger ms-2 d-none';
            delBtn.innerHTML = '<i class="bi bi-trash3"></i> Delete Selected';
            delBtn.onclick = () => bulkDeleteSelected(tableName);
            saveBtn.parentNode.insertBefore(delBtn, saveBtn.nextSibling);
        }
        // Show it for supported tables only
        if (tableActionTypeMap[tableName]) delBtn.classList.remove('d-none');
        updateDeleteSelectedButtonState(tableName);
    }

    function attachRowSelectionControls(tableName) {
        const config = tableConfigs[tableName];
        if (!config) return;
        const tbody = document.getElementById(config.bodyId);
        if (!tbody) return;
        const rows = tbody.querySelectorAll('tr');
        rows.forEach(row => {
            const id = row.getAttribute('data-log-id') || row.getAttribute('data-id');
            const delCell = row.querySelector(`.delete-col-${tableName}`);
            if (!delCell) return;
            if (delCell.querySelector('.row-select')) return; // already attached
            const cb = document.createElement('input');
            cb.type = 'checkbox';
            cb.className = 'row-select';
            cb.title = 'Select row';
            if (!id || id === '0') {
                cb.disabled = true;
                cb.classList.add('row-select-disabled');
            }
            cb.addEventListener('change', () => updateDeleteSelectedButtonState(tableName));
            delCell.insertBefore(cb, delCell.firstChild);
        });
        updateDeleteSelectedButtonState(tableName);
    }

    async function bulkDeleteSelected(tableName) {
        const config = tableConfigs[tableName];
        if (!config) return;
        const actionType = tableActionTypeMap[tableName];
        if (!actionType) {
            showErrorNotification('Bulk delete is not supported for this table.');
            return;
        }
        const tbody = document.getElementById(config.bodyId);
        const selected = Array.from(tbody.querySelectorAll('.row-select:checked'));
        if (selected.length === 0) {
            showErrorNotification('Please select at least one row to delete.');
            return;
        }
        
        const ids = selected.map(cb => {
            const tr = cb.closest('tr');
            return (tr && (tr.getAttribute('data-log-id') || tr.getAttribute('data-id')));
        }).filter(id => id && id !== '0');
        
        if (ids.length === 0) {
            showErrorNotification('Selected rows are not deletable.');
            return;
        }

        const confirmed = confirm(`Delete ${ids.length} selected record(s)? This cannot be undone.`);
        if (!confirmed) return;
        
        try {
            const deletions = ids.map(id => {
                // Utilization Parameters have a dedicated endpoint
                if (tableName === 'util-param') {
                    return fetch(`/api/utilization-parameters/${id}`, { method: 'DELETE' });
                }
                return fetch(getDeleteUrlForAction(actionType, id), { method: 'DELETE' });
            });
            
            const results = await Promise.allSettled(deletions);
            const failed = results.filter(r => r.status === 'rejected' || (r.status === 'fulfilled' && r.value && !r.value.ok));
            if (failed.length > 0) {
                showErrorNotification(`Some deletions failed: ${failed.length}/${ids.length}`);
            } else {
                showSuccessNotification(`Deleted ${ids.length} record(s).`);
            }

            // Reload data for the table
            await config.reloadFunction();
            // If still in edit mode, re-show delete column and reattach selectors
            const saveBtn = document.getElementById(`btn-${tableName}-save`);
            const isStillEditing = saveBtn && !saveBtn.classList.contains('d-none');
            if (isStillEditing) {
                const deleteCols = document.querySelectorAll(`.delete-col-${tableName}`);
                deleteCols.forEach(el => el.style.display = 'table-cell');
                attachRowSelectionControls(tableName);
            }
            // Update dashboard where applicable
            if (actionType === 'INSTALL' || actionType === 'REMOVE') {
                await loadDashboardData();
            }
        } catch (e) {
            console.error('Bulk delete error:', e);
            showErrorNotification(`Bulk delete error: ${e.message}`);
        } finally {
            updateDeleteSelectedButtonState(tableName);
        }
    }

    // Включить режим редактирования таблицы
// ============================================
// COLUMN HEADER EDITING FOR PURCHASE ORDERS
// ============================================

let poHeaderBackup = null;
let poCustomColumns = [];

async function toggleEditModeColumnHeaders(tableName) {
    if (tableName !== 'purchase-orders') return;
    
    const thead = document.querySelector('#purchase-orders-history-body').parentElement.querySelector('thead tr');
    const tbody = document.querySelector('#purchase-orders-history-body');
    const editBtn = document.getElementById('btn-purchase-orders-edit');
    const saveBtn = document.getElementById('btn-purchase-orders-save');
    const cancelBtn = document.getElementById('btn-purchase-orders-cancel');
    const addBtn = document.getElementById('po-header-add-btn');
    const ths = Array.from(thead.querySelectorAll('th'));

    // Проверяем, находимся ли мы в режиме редактирования
    const isEditMode = ths.some(th => th.querySelector('input[type="text"]'));

    if (isEditMode) {
        // ВЫКЛЮЧАЕМ режим редактирования: превращаем обратно в простой текст
        addBtn.style.display = 'none';
        editBtn.classList.remove('d-none');
        saveBtn.classList.add('d-none');
        cancelBtn.classList.add('d-none');
        document.querySelectorAll('.delete-col-purchase-orders').forEach(el => el.style.display = 'none');

        ths.forEach(th => {
            if (th.id === 'delete-col' || th.id === 'po-header-add-btn') return;

            const input = th.querySelector('input[type="text"]');
            const span = th.querySelector('span');
            const text = input ? input.value.trim() : (span ? span.textContent.trim() : th.textContent.trim());
            th.innerHTML = '';
            th.textContent = text;
            th.style.cursor = '';
            th.title = '';
        });
    } else {
        // ВКЛЮЧАЕМ режим редактирования: добавляем контролы
        addBtn.style.display = 'table-cell';
        editBtn.classList.add('d-none');
        saveBtn.classList.remove('d-none');
        cancelBtn.classList.remove('d-none');
        addBtn.querySelector('button').onclick = addNewColumnHeader;
        document.querySelectorAll('.delete-col-purchase-orders').forEach(el => el.style.display = '');

        ths.forEach((th, idx) => {
            // Пропускаем первый столбец (delete) и последний (add-btn)
            if (idx === 0 || th.id === 'po-header-add-btn') return;

            const currentText = th.textContent.replace(/✎|×|📌|✓|⊕|✚|delete/g, '').trim();

            // Очищаем и создаем новый контент с редактированием и удалением
            th.innerHTML = '';
            const content = document.createElement('div');
            content.style.display = 'flex';
            content.style.gap = '5px';
            content.style.alignItems = 'center';

            const titleSpan = document.createElement('span');
            titleSpan.textContent = currentText;
            titleSpan.style.flex = '1';
            titleSpan.style.cursor = 'pointer';
            titleSpan.title = 'Double-click to edit';
            titleSpan.ondblclick = function() { makeHeaderEditable(th); };

            const deleteBtn = document.createElement('button');
            deleteBtn.type = 'button';
            deleteBtn.className = 'btn btn-sm btn-outline-danger';
            deleteBtn.style.padding = '2px 6px';
            deleteBtn.innerHTML = '<i class="bi bi-x-circle" style="font-size: 0.8rem;"></i>';
            deleteBtn.title = 'Delete column';
            deleteBtn.onclick = async function(e) {
                e.stopPropagation();
                const result = confirm('Delete this column? All data in it will be lost.');
                if (result) {
                    deletePoHeaderColumn(th);
                }
            };

            content.appendChild(titleSpan);
            content.appendChild(deleteBtn);
            th.appendChild(content);
            th.style.cursor = 'pointer';
            th.title = 'Double-click to edit';
        });
    }
}

function makeHeaderEditable(thElement) {
    const originalText = thElement.textContent.replace(/✎|×|📌|✓|⊕|✚|📌|🔧|delete|×/g, '').trim();
    
    const input = document.createElement('input');
    input.type = 'text';
    input.className = 'form-control';
    input.style.padding = '5px';
    input.style.fontSize = '0.9rem';
    input.value = originalText;
    
    thElement.innerHTML = '';
    thElement.appendChild(input);
    input.focus();
    input.select();
    
    function saveHeader() {
        const newText = input.value.trim() || originalText;
        
        // Очищаем и создаем новый контент
        thElement.innerHTML = '';
        const newContent = document.createElement('div');
        newContent.style.display = 'flex';
        newContent.style.gap = '5px';
        newContent.style.alignItems = 'center';
        
        const titleSpan = document.createElement('span');
        titleSpan.textContent = newText;
        titleSpan.style.flex = '1';
        titleSpan.style.cursor = 'pointer';
        titleSpan.title = 'Double-click to edit';
        titleSpan.ondblclick = function() { makeHeaderEditable(thElement); };
        
        const deleteBtn = document.createElement('button');
        deleteBtn.type = 'button';
        deleteBtn.className = 'btn btn-sm btn-outline-danger';
        deleteBtn.style.padding = '2px 6px';
        deleteBtn.innerHTML = '<i class="bi bi-x-circle" style="font-size: 0.8rem;"></i>';
        deleteBtn.title = 'Delete column';
        deleteBtn.onclick = function(e) {
            e.stopPropagation();
            const result = confirm('Delete this column? All data in it will be lost.');
            if (result) {
                deletePoHeaderColumn(thElement);
            }
        };
        
        newContent.appendChild(titleSpan);
        newContent.appendChild(deleteBtn);
        thElement.appendChild(newContent);
        thElement.style.cursor = 'pointer';
        thElement.title = 'Double-click to edit';
    }
    
    input.onblur = saveHeader;
    input.onkeydown = function(e) {
        if (e.key === 'Enter') saveHeader();
        if (e.key === 'Escape') {
            thElement.innerHTML = '';
            const newContent = document.createElement('div');
            newContent.style.display = 'flex';
            newContent.style.gap = '5px';
            newContent.style.alignItems = 'center';
            
            const titleSpan = document.createElement('span');
            titleSpan.textContent = originalText;
            titleSpan.style.flex = '1';
            titleSpan.style.cursor = 'pointer';
            titleSpan.title = 'Double-click to edit';
            titleSpan.ondblclick = function() { makeHeaderEditable(thElement); };
            
            const deleteBtn = document.createElement('button');
            deleteBtn.type = 'button';
            deleteBtn.className = 'btn btn-sm btn-outline-danger';
            deleteBtn.style.padding = '2px 6px';
            deleteBtn.innerHTML = '<i class="bi bi-x-circle" style="font-size: 0.8rem;"></i>';
            deleteBtn.title = 'Delete column';
            deleteBtn.onclick = function(e) {
                e.stopPropagation();
                const result = confirm('Delete this column? All data in it will be lost.');
                if (result) {
                    deletePoHeaderColumn(thElement);
                }
            };
            
            newContent.appendChild(titleSpan);
            newContent.appendChild(deleteBtn);
            thElement.appendChild(newContent);
            thElement.style.cursor = 'pointer';
        }
    };
}

function addNewColumnHeader() {
    const thead = document.querySelector('#purchase-orders-history-body').parentElement.querySelector('thead tr');
    
    // Создаем новый столбец ПЕРЕД плюсиком
    const newTh = document.createElement('th');
    newTh.style.minWidth = '160px';
    newTh.style.width = '160px';
    newTh.style.padding = '5px';
    newTh.className = 'po-custom-col';
    
    // Контейнер для input и кнопок
    const inputContainer = document.createElement('div');
    inputContainer.style.display = 'flex';
    inputContainer.style.gap = '5px';
    inputContainer.style.alignItems = 'center';
    
    const input = document.createElement('input');
    input.type = 'text';
    input.className = 'form-control';
    input.style.padding = '5px';
    input.style.fontSize = '0.9rem';
    input.style.flex = '1';
    input.placeholder = 'Column name...';
    
    // Крестик для удаления пустой колонки
    const deleteBtn = document.createElement('button');
    deleteBtn.type = 'button';
    deleteBtn.className = 'btn btn-sm btn-outline-danger';
    deleteBtn.style.padding = '4px 8px';
    deleteBtn.style.minWidth = '32px';
    deleteBtn.innerHTML = '<i class="bi bi-x-circle"></i>';
    deleteBtn.title = 'Delete column';
    deleteBtn.onclick = async function(e) {
        e.stopPropagation();
        const result = confirm('Delete this column?');
        if (result) {
            deletePoHeaderColumn(newTh);
        }
    };
    
    inputContainer.appendChild(input);
    inputContainer.appendChild(deleteBtn);
    newTh.appendChild(inputContainer);
    
    // Добавляем ПЕРЕД плюсиком
    const addBtn = document.getElementById('po-header-add-btn');
    thead.insertBefore(newTh, addBtn);
    
    // Фокусируемся на input
    input.focus();
    
    // При потере фокуса или Enter - сохраняем колонку
    function confirmColumn() {
        const text = input.value.trim();
        if (text) {
            // Очищаем и создаем новый заголовок
            newTh.innerHTML = '';
            const newContent = document.createElement('div');
            newContent.style.display = 'flex';
            newContent.style.gap = '5px';
            newContent.style.alignItems = 'center';
            
            const titleSpan = document.createElement('span');
            titleSpan.textContent = text;
            titleSpan.style.flex = '1';
            titleSpan.style.cursor = 'pointer';
            titleSpan.title = 'Double-click to edit';
            titleSpan.ondblclick = function() { makeHeaderEditable(newTh); };
            
            const newDeleteBtn = document.createElement('button');
            newDeleteBtn.type = 'button';
            newDeleteBtn.className = 'btn btn-sm btn-outline-danger';
            newDeleteBtn.style.padding = '2px 6px';
            newDeleteBtn.innerHTML = '<i class="bi bi-x-circle" style="font-size: 0.8rem;"></i>';
            newDeleteBtn.title = 'Delete column';
            newDeleteBtn.onclick = function(e) {
                e.stopPropagation();
                const result = confirm('Delete this column? All data in it will be lost.');
                if (result) {
                    deletePoHeaderColumn(newTh);
                }
            };
            
            newContent.appendChild(titleSpan);
            newContent.appendChild(newDeleteBtn);
            newTh.appendChild(newContent);
            newTh.style.cursor = 'pointer';
            newTh.title = 'Double-click to edit';
            
            // Добавляем пустые ячейки в tbody
            const tbody = document.querySelector('#purchase-orders-history-body');
            const rows = tbody.querySelectorAll('tr');
            rows.forEach(row => {
                const newTd = document.createElement('td');
                newTd.textContent = '';
                row.appendChild(newTd);
            });
        } else {
            // Если не заполнили - удаляем столбец
                    deletePoHeaderColumn(newTh);
        }
    }
    
    input.onblur = confirmColumn;
    input.onkeydown = function(e) {
        if (e.key === 'Enter') confirmColumn();
        if (e.key === 'Escape') deletePoHeaderColumn(newTh);
    };
}
    function deletePoHeaderColumn(thElement) {
function deletePoHeaderColumn(thElement) {
    const thead = thElement.parentElement;
    const tbody = document.querySelector('#purchase-orders-history-body');
    
    // Получаем индекс столбца среди всех th
    const allThs = Array.from(thead.querySelectorAll('th'));
    const thIndex = allThs.indexOf(thElement);
    
    // Удаляем заголовок
    thElement.remove();
    
    // Удаляем соответствующие ячейки из всех строк
    // thIndex совпадает с индексом td, так как у обоих есть delete-col на первой позиции
    const rows = tbody.querySelectorAll('tr');
    rows.forEach(row => {
        const cells = Array.from(row.querySelectorAll('td'));
        if (cells[thIndex]) {
            cells[thIndex].remove();
        }
    });
}

async function saveColumnHeaders(tableName) {
    if (tableName !== 'purchase-orders') return;
    
    const thead = document.querySelector('#purchase-orders-history-body').parentElement.querySelector('thead tr');
    const ths = Array.from(thead.querySelectorAll('th'));
    const columns = [];
    
    // Стандартные колонки, которые не нужно сохранять в конфиг
    const standardColumns = ['', 'Date', 'Item Name', 'PN', 'SN', 'Price', 'Purchase Purpose', 'Aircraft', 'RO#', 'Link'];
    
    // Собираем только кастомные колонки (те, которых нет в стандартном списке)
    ths.forEach((th, idx) => {
        if (idx === 0 || th.id === 'po-header-add-btn') return; // Skip delete column and add button
        
        // Получаем текст
        let name = '';
        const input = th.querySelector('input[type="text"]');
        if (input) {
            name = input.value.trim();
        } else {
            // Если есть span внутри div - берем текст оттуда
            const span = th.querySelector('span');
            if (span) {
                name = span.textContent.trim();
            } else {
                name = th.textContent.replace(/✎|×|📌|✓|⊕|✚|🔧/g, '').trim();
            }
        }
        
        // Сохраняем только кастомные колонки (не стандартные и не пустые)
        if (name && name !== 'Column name...' && name !== '' && !standardColumns.includes(name)) {
            columns.push({ name, type: 'text' });
        }
    });
    
    try {
        const res = await fetch('/api/table-config/purchase-orders', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ columns })
        });
        
        if (res.ok) {
            showSuccessNotification('Column names saved!');
            cancelColumnHeaders('purchase-orders');
            await loadPurchaseOrdersHistory();
        } else {
            showErrorNotification('Error saving columns');
        }
    } catch (e) {
        showErrorNotification('Error: ' + e.message);
    }
}

function cancelColumnHeaders(tableName) {
    if (tableName !== 'purchase-orders') return;
    
    const editBtn = document.getElementById('btn-purchase-orders-edit');
    const saveBtn = document.getElementById('btn-purchase-orders-save');
    const cancelBtn = document.getElementById('btn-purchase-orders-cancel');
    const addBtn = document.getElementById('po-header-add-btn');
    
    editBtn.classList.remove('d-none');
    saveBtn.classList.add('d-none');
    cancelBtn.classList.add('d-none');
    if (addBtn) addBtn.style.display = 'none';
    document.querySelectorAll('.delete-col-purchase-orders').forEach(el => el.style.display = 'none');

    // Возвращаем текстовое состояние заголовков
    const thead = document.querySelector('#purchase-orders-history-body').parentElement.querySelector('thead tr');
    const ths = Array.from(thead.querySelectorAll('th'));
    ths.forEach((th, idx) => {
        if (idx === 0 || th.id === 'po-header-add-btn') return;
        const span = th.querySelector('span');
        const input = th.querySelector('input');
        const text = input ? input.value.trim() : (span ? span.textContent.trim() : th.textContent.trim());
        th.innerHTML = '';
        th.textContent = text;
        th.style.cursor = '';
        th.title = '';
    });
}

    function toggleEditModeTable(tableName) {
        const config = tableConfigs[tableName];
        if (!config) return;

        const editBtn = document.getElementById(`btn-${tableName}-edit`);
        const saveBtn = document.getElementById(`btn-${tableName}-save`);
        const cancelBtn = document.getElementById(`btn-${tableName}-cancel`);
        const addBtn = document.getElementById(`add-row-${tableName}`);
        const tbody = document.getElementById(config.bodyId);
        
        // Переключаем кнопки
        editBtn.classList.add('d-none');
        saveBtn.classList.remove('d-none');
        cancelBtn.classList.remove('d-none');
        if (addBtn) {
            if (config.allowRowCreation === false) {
                addBtn.classList.add('d-none');
            } else {
                addBtn.classList.remove('d-none');
            }
        }
        
        // Показываем колонку с корзинами
        const deleteCols = document.querySelectorAll(`.delete-col-${tableName}`);
        deleteCols.forEach(el => el.style.display = 'table-cell');
        // Add selection UI and button
        ensureSelectionStylesInjected();
        insertDeleteSelectedButton(tableName);
        attachRowSelectionControls(tableName);
        
        // Превращаем каждую ячейку в редактируемое поле
        const rows = tbody.querySelectorAll('tr');
        rows.forEach(row => {
            // Пропускаем строки "No data"
            if (row.cells.length === 1 && row.cells[0].colSpan > 1) return;
            
            row.classList.add('editing-row');
            const cells = Array.from(row.children);
            let dataColumnIndex = 0; // Счетчик для data-колонок (исключая delete-col)
            
            cells.forEach((cell) => {
                // Пропускаем колонку удаления (первую с классом delete-col-*)
                if (cell.classList.contains(`delete-col-${tableName}`)) return;
                
                const columnName = config.columns[dataColumnIndex];
                if (!columnName) return; // Если колонка не определена в конфиге
                
                const columnType = config.columnTypes[columnName] || 'text';
                
                // Извлекаем только текст, без HTML (например, для badges)
                const cleanValue = cell.textContent.trim();
                
                if (columnType === 'date') {
                    cell.innerHTML = `<input type="date" class="editing-input" value="${cleanValue}">`;
                } else if (columnType === 'number') {
                    cell.innerHTML = `<input type="number" class="editing-input" value="${cleanValue}" step="0.01">`;
                } else if (columnType === 'select' && config.selectOptions && config.selectOptions[columnName]) {
                    const options = config.selectOptions[columnName];
                    let selectHtml = `<select class="editing-input">`;
                    selectHtml += `<option value="">-- Select --</option>`;
                    options.forEach(opt => {
                        const selected = opt.value === cleanValue ? 'selected' : '';
                        selectHtml += `<option value="${opt.value}" ${selected}>${opt.label}</option>`;
                    });
                    selectHtml += `</select>`;
                    cell.innerHTML = selectHtml;
                } else {
                    cell.innerHTML = `<input type="text" class="editing-input" value="${cleanValue}">`;
                }
                
                dataColumnIndex++;
            });
        });
    }

    // Добавить пустую строку
    function addEmptyRowTable(tableName) {
        const config = tableConfigs[tableName];
        if (!config) return;
        if (config.allowRowCreation === false) {
            showErrorNotification('This table cannot create records from Edit mode. Please use the form above.');
            return;
        }
        
        const tbody = document.getElementById(config.bodyId);
        const newRow = document.createElement('tr');
        newRow.classList.add('editing-row', 'table-success'); // Подсвечиваем зеленым
        newRow.setAttribute('data-log-id', '0'); // Новая строка, ID = 0
        
        // Добавляем delete-col (ВИДИМУЮ в режиме Edit), если она есть в конфиге
        if (config.hasDeleteCol !== false) {
            const deleteCell = document.createElement('td');
            deleteCell.className = `delete-col delete-col-${tableName}`;
            deleteCell.style.display = 'table-cell'; // Показываем сразу, так как мы в режиме Edit
            deleteCell.innerHTML = `
                <button class="btn btn-sm btn-danger" onclick="this.closest('tr').remove()" title="Delete">
                    <i class="bi bi-trash"></i>
                </button>
            `;
            newRow.appendChild(deleteCell);
        }
        
        // Добавляем ячейки для каждой колонки
        config.columns.forEach(columnName => {
            const cell = document.createElement('td');
            const columnType = config.columnTypes[columnName] || 'text';
            
            if (columnType === 'date') {
                cell.innerHTML = `<input type="date" class="editing-input">`;
            } else if (columnType === 'number') {
                cell.innerHTML = `<input type="number" class="editing-input" value="0" step="0.01">`;
            } else if (columnType === 'select' && config.selectOptions && config.selectOptions[columnName]) {
                const options = config.selectOptions[columnName];
                let selectHtml = `<select class="editing-input">`;
                selectHtml += `<option value="">-- Select --</option>`;
                options.forEach(opt => {
                    selectHtml += `<option value="${opt.value}">${opt.label}</option>`;
                });
                selectHtml += `</select>`;
                cell.innerHTML = selectHtml;
            } else {
                cell.innerHTML = `<input type="text" class="editing-input" placeholder="${columnName}">`;
            }
            
            newRow.appendChild(cell);
        });
        
        tbody.appendChild(newRow);
    }

    // Сохранить изменения таблицы
    async function saveEditModeTable(tableName) {
        const config = tableConfigs[tableName];
        if (!config) return;
        
        // Специальная обработка для util-param (работает с API)
        if (tableName === 'util-param') {
            const tbody = document.getElementById(config.bodyId);
            const rows = tbody.querySelectorAll('tr.editing-row');
            const updatePromises = [];
            
            for (const row of rows) {
                const inputs = row.querySelectorAll('.editing-input');
                if (inputs.length === 0) continue;
                
                const dataId = row.getAttribute('data-id');
                const values = Array.from(inputs).map(inp => inp.value);
                
                const itemData = {
                    date: values[0] || new Date().toISOString().split('T')[0],
                    aircraft: values[1] || '',
                    ttsn: parseFloat(values[2]) || 0,
                    tcsn: parseInt(values[3]) || 0,
                    period: values[4] === 'Да' || values[4] === 'true',
                    date_from: values[5] !== '-' ? values[5] : null,
                    date_to: values[6] !== '-' ? values[6] : null
                };
                
                // Обновляем через API
                updatePromises.push(
                    fetch(`/api/utilization-parameters/${dataId}`, {
                        method: 'PUT',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(itemData)
                    })
                );
            }
            
            try {
                await Promise.all(updatePromises);
                
                showSuccessNotification('Данные успешно сохранены в базу данных!');
            } catch (err) {
                console.error('Error saving util-param:', err);
                showErrorNotification('Ошибка сохранения: ' + err.message);
            }
            
            // Выходим из режима редактирования
            const editBtn = document.getElementById('btn-util-param-edit');
            const saveBtn = document.getElementById('btn-util-param-save');
            const cancelBtn = document.getElementById('btn-util-param-cancel');
            const addBtn = document.getElementById('add-row-util-param');
            
            editBtn.classList.remove('d-none');
            saveBtn.classList.add('d-none');
            cancelBtn.classList.add('d-none');
            if (addBtn) addBtn.classList.add('d-none');
            
            const deleteCols = document.querySelectorAll('.delete-col-util-param');
            deleteCols.forEach(el => el.style.display = 'none');
            
            await loadUtilParamHistory();
            return;
        }
        
        const tbody = document.getElementById(config.bodyId);
        const rows = tbody.querySelectorAll('tr.editing-row');
        const updatePromises = [];
        const createPromises = [];
        const validationErrors = []; // Собираем все ошибки валидации
        
        for (const row of rows) {
            const inputs = row.querySelectorAll('.editing-input');
            if (inputs.length === 0) continue;
            
            const logId = row.getAttribute('data-log-id');
            const rowData = {};
            
            inputs.forEach((input, index) => {
                const columnName = config.columns[index];
                rowData[columnName] = input.value;
            });
            
            console.log('=== Processing row ===');
            console.log('Row data:', rowData);
            console.log('Log ID:', logId);
            console.log('Table name:', tableName);
            
            if (tableName === 'store-balance') {
                const sanitize = (val) => (val || '').trim();
                const quantityVal = rowData.quantity === undefined || rowData.quantity === null || rowData.quantity === ''
                    ? 0
                    : parseInt(rowData.quantity, 10);

                if (Number.isNaN(quantityVal)) {
                    validationErrors.push('Store Balance row: Quantity must be a number.');
                    continue;
                }

                const payload = {
                    received_date: sanitize(rowData.received_date) || null,
                    part_name: sanitize(rowData.part_name),
                    part_number: sanitize(rowData.part_number),
                    serial_number: sanitize(rowData.serial_number),
                    condition: sanitize(rowData.condition),
                    quantity: quantityVal,
                    unit: sanitize(rowData.ro_number || rowData.unit),
                    location: sanitize(rowData.location),
                    shelf: sanitize(rowData.status || rowData.shelf),
                    owner: sanitize(rowData.owner),
                    remarks: sanitize(rowData.remarks)
                };

                if (!payload.part_name) {
                    validationErrors.push('Store Balance row: Part Name is required.');
                    continue;
                }

                if (!payload.part_number) {
                    validationErrors.push('Store Balance row: P/N is required.');
                    continue;
                }

                if (payload.quantity < 0) {
                    validationErrors.push('Store Balance row: Quantity cannot be negative.');
                    continue;
                }

                if (logId === '0') {
                    createPromises.push(
                        fetch('/api/store-balance', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        }).then(async (response) => {
                            if (!response.ok) {
                                const error = await response.json().catch(() => ({}));
                                throw new Error(`Create failed for Store Balance: ${error.detail || response.statusText}`);
                            }
                            return response;
                        })
                    );
                } else {
                    updatePromises.push(
                        fetch(`/api/store-balance/${logId}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        }).then(async (response) => {
                            if (!response.ok) {
                                const error = await response.json().catch(() => ({}));
                                throw new Error(`Update failed for Store Balance ${logId}: ${error.detail || response.statusText}`);
                            }
                            return response;
                        })
                    );
                }

                continue;
            }

            // Определяем action_type по tableName
            const actionTypeMap = {
                'install': 'INSTALL',
                'shipment': 'SHIP',
                'remove': 'REMOVE',
                'repair': 'REPAIR',
                'borescope': 'BORESCOPE',
                'purchase-orders': 'PURCHASE_ORDER',
                'param': 'PARAMETER'
            };
            
            const actionType = actionTypeMap[tableName];
            if (!actionType) {
                console.error(`Unknown table name: ${tableName}`);
                continue;
            }
            
            // Преобразуем rowData в формат для API (универсально для разных таблиц)
            let apiData = {};
            
            if (tableName === 'purchase-orders') {
                // Специальный маппинг для Purchase Orders
                apiData = {
                    date: rowData.date || null,
                    name: rowData.name || null,
                    part_number: rowData.part_number || null,
                    serial_number: rowData.serial_number || null,
                    price: rowData.price ? parseFloat(rowData.price) : null,
                    purpose: rowData.purpose || null,
                    aircraft: rowData.aircraft || null,
                    ro_number: rowData.ro_number || null,
                    link: rowData.link || null
                };
            } else if (tableName === 'install') {
                // Маппинг для Install history (использует спец поля action log)
                apiData = {
                    date: rowData.date || null,
                    from_location: rowData.location_from || null,
                    to_aircraft: rowData.install_to || null,
                    position: rowData.position ? parseInt(rowData.position) : null,
                    snapshot_tt: rowData.tt ? parseFloat(rowData.tt) : null,
                    snapshot_tc: rowData.tc ? parseInt(rowData.tc) : null,
                    comments: rowData.remarks || null
                };
            } else if (tableName === 'borescope') {
                // Специальный маппинг для Borescope
                apiData = {
                    date: rowData.date || null,
                    to_aircraft: rowData.aircraft || null,
                    from_location: rowData.serial_number || null,  // serial_number
                    position: rowData.position ? parseInt(rowData.position) : null,
                    to_location: rowData.gss_id || null,  // gss_id
                    comments: rowData.inspector || null,   // inspector
                    file_url: rowData.link || null
                };
            } else {
                // Универсальный маппинг для остальных таблиц
                apiData = {
                    date: rowData.date || null,
                    from_location: rowData.from || rowData.location_from || rowData.original_sn || rowData.current_sn || rowData.vendor || null,
                    to_location: rowData.to || rowData.install_to || null,
                    to_aircraft: rowData.aircraft || null,
                    position: rowData.position ? parseInt(rowData.position) : null,
                    snapshot_tt: rowData.tt ? parseFloat(rowData.tt) : null,
                    snapshot_tc: rowData.tc ? parseInt(rowData.tc) : null,
                    comments: rowData.remarks || rowData.wo || null,
                    file_url: rowData.photo || null
                };
            }
            
            if (logId === '0') {
                if (config.allowRowCreation === false) {
                    showErrorNotification('Adding new rows directly in this table is not supported. Please use the input form.');
                    continue;
                }
                // Новая запись - создаем через POST
                let createData = {};
                
                if (tableName === 'purchase-orders') {
                    // Валидация обязательных полей
                    if (!rowData.date || !rowData.name || !rowData.purpose || !rowData.aircraft || !rowData.ro_number) {
                        console.error('Missing required fields for Purchase Order:', rowData);
                        validationErrors.push('❌ Purchase Order row: Required fields are date, item name, purpose, aircraft, RO number (PN/SN/Price/Link are optional).');
                        continue;
                    }
                    createData = {
                        date: rowData.date,
                        name: rowData.name,
                        part_number: rowData.part_number || '',
                        serial_number: rowData.serial_number || '',
                        price: rowData.price ? parseFloat(rowData.price) : null,
                        purpose: rowData.purpose,
                        aircraft: rowData.aircraft,
                        ro_number: rowData.ro_number,
                        link: rowData.link || ''
                    };
                } else if (tableName === 'borescope') {
                    // Валидация обязательных полей
                    if (!rowData.date || !rowData.aircraft || !rowData.serial_number || !rowData.position || !rowData.inspector) {
                        console.error('Missing required fields for Borescope:', rowData);
                        validationErrors.push('❌ Borescope row: Required fields are date, aircraft, serial_number, position, inspector (gss_id and link are optional)');
                        continue;
                    }
                    createData = {
                        date: rowData.date,
                        aircraft: rowData.aircraft,
                        serial_number: rowData.serial_number,
                        position: String(rowData.position),
                        gss_id: rowData.gss_id || '',
                        inspector: rowData.inspector,
                        link: rowData.link || ''
                    };
                } else if (tableName === 'install') {
                    if (!rowData.date) {
                        validationErrors.push('Installation row: Date is required.');
                        continue;
                    }
                    if (!rowData.original_sn && !rowData.current_sn) {
                        validationErrors.push('Installation row: Provide Original SN or Current SN to identify the engine.');
                        continue;
                    }
                    if (!rowData.install_to) {
                        validationErrors.push('Installation row: Aircraft (Install To) is required.');
                        continue;
                    }
                    if (!rowData.position) {
                        validationErrors.push('Installation row: Position is required.');
                        continue;
                    }
                    
                    // ВАЖНО: Проверяем что двигатель существует в Master Engine List
                    const engineCheckResponse = await fetch('/api/engines');
                    const allEngines = await engineCheckResponse.json();
                    const engineExists = allEngines.some(e => 
                        e.original_sn === rowData.original_sn || 
                        e.current_sn === rowData.current_sn ||
                        e.original_sn === rowData.current_sn ||
                        e.current_sn === rowData.original_sn
                    );
                    
                    if (!engineExists) {
                        validationErrors.push(`❌ Installation row: Engine with SN "${rowData.original_sn || rowData.current_sn}" NOT FOUND in Master Engine List!\n\n⚠️ Please add the engine to the database first (Master Engine List tab) before creating installation records.`);
                        continue;
                    }
                    
                    createData = {
                        date: rowData.date,
                        engine_original_sn: rowData.original_sn || null,
                        engine_current_sn: rowData.current_sn || null,
                        from_location: rowData.location_from || '',
                        to_aircraft: rowData.install_to,
                        position: rowData.position ? parseInt(rowData.position) : null,
                        snapshot_tt: rowData.tt ? parseFloat(rowData.tt) : null,
                        snapshot_tc: rowData.tc ? parseInt(rowData.tc) : null,
                        comments: rowData.remarks || ''
                    };
                } else if (tableName === 'parts') {
                    createData = {
                        date: rowData.date || new Date().toISOString().split('T')[0],
                        action: rowData.action || 'INSTALLED',
                        part_name: rowData.part_name || 'Part',
                        part_number: rowData.part_number || 'N/A',
                        serial_number: rowData.serial_number || 'N/A',
                        quantity: parseInt(rowData.quantity) || 1,
                        location: rowData.location || '',
                        from_esn: rowData.from_esn || '-',
                        to_esn: rowData.to_esn || '-',
                        reason: rowData.reason || ''
                    };
                    
                    console.log('Creating new Parts record:', createData);
                    
                    createPromises.push(
                        fetch('/api/actions/part', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify(createData)
                        }).then(async (response) => {
                            if (!response.ok) {
                                const error = await response.json().catch(() => ({}));
                                throw new Error(`Create failed for Parts: ${error.detail || response.statusText}`);
                            }
                            return response;
                        })
                    );
                    continue;
                } else {
                    // Для других таблиц пока не поддерживаем создание
                    console.warn(`Creating new records for ${tableName} not supported yet`);
                    continue;
                }
                
                console.log('Creating new record:', createData);
                
                createPromises.push(
                    fetch(`/api/history/${actionType}`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(createData)
                    }).then(async (response) => {
                        if (!response.ok) {
                            const error = await response.json();
                            throw new Error(`Create failed for ${actionType}: ${error.detail || response.statusText}`);
                        }
                        return response;
                    })
                );
            } else {
                // Существующая запись - обновляем через PUT
                if (tableName === 'parts') {
                    // Parts Logistics has special update structure (JSON in comments)
                    const sanitize = (val) => (val || '').trim();
                    const partsPayload = {
                        date: sanitize(rowData.date),
                        from_location: sanitize(rowData.action),
                        to_location: sanitize(rowData.part_name),
                        comments: JSON.stringify({
                            part_name: sanitize(rowData.part_name),
                            part_number: sanitize(rowData.part_number),
                            serial_number: sanitize(rowData.serial_number),
                            quantity: parseInt(rowData.quantity) || 0,
                            from_esn: sanitize(rowData.from_esn),
                            to_esn: sanitize(rowData.to_esn),
                            location: sanitize(rowData.location),
                            reason: sanitize(rowData.reason)
                        })
                    };
                    updatePromises.push(
                        fetch(`/api/history/PART_ACTION/${logId}`, {
                            method: 'PUT',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify(partsPayload)
                        }).then(async (response) => {
                            if (!response.ok) {
                                const error = await response.json().catch(() => ({}));
                                throw new Error(`Update failed for Parts ${logId}: ${error.detail || response.statusText}`);
                            }
                            return response;
                        })
                    );
                } else {
                    updatePromises.push(
                        fetch(`/api/history/${actionType}/${logId}`, {
                            method: 'PUT',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify(apiData)
                        }).then(async (response) => {
                            if (!response.ok) {
                                const error = await response.json();
                                throw new Error(`Update failed for ${actionType} ${logId}: ${error.detail || response.statusText}`);
                            }
                            return response;
                        })
                    );
                }
            }
        }
        
        // Показываем все ошибки валидации ПЕРЕД сохранением
        if (validationErrors.length > 0) {
            const errorMessage = validationErrors.join('\n\n');
            showErrorNotification(errorMessage);
            return; // Останавливаем сохранение
        }
        
        try {
            const allPromises = [...createPromises, ...updatePromises];
            
            if (allPromises.length === 0) {
                // Если нет изменений, просто выходим из режима редактирования
                console.log('No valid changes detected, exiting edit mode');
                const editBtn = document.getElementById(`btn-${tableName}-edit`);
                const saveBtn = document.getElementById(`btn-${tableName}-save`);
                const cancelBtn = document.getElementById(`btn-${tableName}-cancel`);
                const addBtn = document.getElementById(`add-row-${tableName}`);
                
                editBtn.classList.remove('d-none');
                saveBtn.classList.add('d-none');
                cancelBtn.classList.add('d-none');
                if (addBtn) addBtn.classList.add('d-none');
                const delSelBtn = document.getElementById(`btn-${tableName}-delete-selected`);
                if (delSelBtn) delSelBtn.classList.add('d-none');
                
                const deleteCols = document.querySelectorAll(`.delete-col-${tableName}`);
                deleteCols.forEach(el => el.style.display = 'none');
                
                await config.reloadFunction();
                return;
            }
            
            await Promise.all(allPromises);
            
            const totalSaved = allPromises.length;
            const createdCount = createPromises.length;
            const updatedCount = updatePromises.length;
            
            let message = `Successfully saved ${totalSaved} record(s)!`;
            if (createdCount > 0 && updatedCount > 0) {
                message = `Successfully created ${createdCount} and updated ${updatedCount} record(s)!`;
            } else if (createdCount > 0) {
                message = `Successfully created ${createdCount} record(s)!`;
            } else {
                message = `Successfully updated ${updatedCount} record(s)!`;
            }
            
            showSuccessNotification(message);
            
            // Выходим из режима редактирования и перезагружаем таблицу
            const editBtn = document.getElementById(`btn-${tableName}-edit`);
            const saveBtn = document.getElementById(`btn-${tableName}-save`);
            const cancelBtn = document.getElementById(`btn-${tableName}-cancel`);
            const addBtn = document.getElementById(`add-row-${tableName}`);
            
            editBtn.classList.remove('d-none');
            saveBtn.classList.add('d-none');
            cancelBtn.classList.add('d-none');
            if (addBtn) addBtn.classList.add('d-none');
            const delSelBtn2 = document.getElementById(`btn-${tableName}-delete-selected`);
            if (delSelBtn2) delSelBtn2.classList.add('d-none');
            
            const deleteCols = document.querySelectorAll(`.delete-col-${tableName}`);
            deleteCols.forEach(el => el.style.display = 'none');
            
            console.log(`🔄 Reloading table data for ${tableName}...`);
            await config.reloadFunction();
            console.log(`✅ Table ${tableName} reloaded successfully`);
            
        } catch (error) {
            showErrorNotification(`Error saving data: ${error.message}`);
            console.error('❌ Save error:', error);
        }
    }

    // Отменить редактирование таблицы
    function cancelEditModeTable(tableName) {
        const config = tableConfigs[tableName];
        if (!config) return;
        
        const editBtn = document.getElementById(`btn-${tableName}-edit`);
        const saveBtn = document.getElementById(`btn-${tableName}-save`);
        const cancelBtn = document.getElementById(`btn-${tableName}-cancel`);
        const addBtn = document.getElementById(`add-row-${tableName}`);
        
        // Переключаем кнопки обратно
        editBtn.classList.remove('d-none');
        saveBtn.classList.add('d-none');
        cancelBtn.classList.add('d-none');
        if (addBtn) addBtn.classList.add('d-none');
        
        // Скрываем колонку с корзинами
        const deleteCols = document.querySelectorAll(`.delete-col-${tableName}`);
        deleteCols.forEach(el => el.style.display = 'none');
        const delSelBtn = document.getElementById(`btn-${tableName}-delete-selected`);
        if (delSelBtn) delSelBtn.classList.add('d-none');
        // Clear any selections if rows remain
        const tbody = document.getElementById(config.bodyId);
        if (tbody) tbody.querySelectorAll('.row-select:checked').forEach(cb => { cb.checked = false; });
        
        // Перезагружаем таблицу с сервера
        config.reloadFunction();
    }

    // ============ КОНЕЦ УНИВЕРСАЛЬНЫХ ФУНКЦИЙ ============

    async function openAddEngineView() { 
        hideAllViews(); 
        document.getElementById('view-add-engine').style.display = 'block'; 
        updateHistory('add-engine');
        
        // Устанавливаем текущую дату по умолчанию
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('m-date').value = today;
        
        await loadLocationsForForm();
    }
    
    // Функция загрузки локаций для формы
    async function loadLocationsForForm() {
        try {
            const res = await fetch('/api/locations' + noCache());
            const locations = await res.json();
            const sel = document.getElementById('m-location');
            if(!sel) return;
            sel.innerHTML = '<option value="" disabled selected>Select Location...</option>';
            locations.forEach(loc => {
                sel.innerHTML += `<option value="${loc.id}">${loc.name} - ${loc.city}</option>`;
            });
        } catch(e) {
            console.error('Ошибка загрузки локаций:', e);
        }
    }



    let _mainEngineSubmitting = false;
    async function submitMainEngine() {
        if (_mainEngineSubmitting) { return; }
        _mainEngineSubmitting = true;
        const saveBtn = document.querySelector('#tab-main-add .btn.btn-success.px-4');
        if (saveBtn) { saveBtn.disabled = true; saveBtn.dataset._orig = saveBtn.innerHTML; saveBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Saving...'; }
        // 1. Собираем значения из полей
        const esn = document.getElementById('m-esn').value;
        const date = document.getElementById('m-date').value;
        const locationId = document.getElementById('m-location').value;
        
        // Простая валидация
        if(!esn) { 
            alert("Ошибка: Поле 'Orig. ESN' обязательно для заполнения!"); 
            return; 
        }
        if(!locationId) { 
            alert("Ошибка: Выберите локацию (Current Location)!"); 
            return; 
        }
        if(/[а-яА-ЯёЁ]/.test(esn)) { 
            alert("Русские буквы в серийном номере запрещены!"); 
            return; 
        }

        // 2. Создаем объект для отправки на сервер
        const payload = {
            date: date,
            original_sn: esn,
            gss_sn: document.getElementById('m-gssid').value || esn,
            current_sn: esn,
            model: document.getElementById('m-model').value,
            status: document.getElementById('m-status').value,
            location_id: parseInt(locationId),
            total_time: parseFloat(document.getElementById('m-tt').value) || 0,
            total_cycles: parseInt(document.getElementById('m-tc').value) || 0,
            photo_url: document.getElementById('m-photo').value,
            remarks: document.getElementById('m-rem').value
        };

        try {
            // 3. Отправляем на сервер
            console.log('Sending engine data:', payload);
            const res = await fetch(`/api/engines?user_id=${currentUser.id}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            
            if(!res.ok) {
                const errorData = await res.json().catch(() => ({}));
                console.error('Server error:', errorData);
                throw new Error(errorData.detail || `HTTP Error ${res.status}`);
            }
            
            alert("Двигатель успешно добавлен!");
            
            // 4. Очищаем форму
            document.getElementById('form-main-add').reset();
            
            // 5. Обновляем Dashboard и таблицу
            await loadDashboardData(); // Обновит счетчики на Dashboard
            switchMainTab('list');
            await loadMainTable(); // Обновляем таблицу двигателей
            refreshAfterDataChange();
            
        } catch(e) {
            alert("Ошибка при сохранении: " + e.message);
        } finally {
            _mainEngineSubmitting = false;
            if (saveBtn) { saveBtn.disabled = false; saveBtn.innerHTML = saveBtn.dataset._orig || 'Save Record'; }
        }
    }
    // --- REPAIR LOGIC ---
    let localTestRepairs = [];

    async function openRepairView() { 
        hideAllViews(); 
        document.getElementById('view-repair').style.display = 'block'; 
        updateHistory('repair');
        await loadRepairHistory();
    }
    
    function switchRepairTab(t) {
        document.getElementById('tab-rep-info').style.display = t==='info'?'block':'none';
        document.getElementById('tab-rep-entry').style.display = t==='entry'?'block':'none';
        document.getElementById('tab-rep-info-btn').className = t==='info'?'nav-link active':'nav-link';
        document.getElementById('tab-rep-entry-btn').className = t==='entry'?'nav-link active':'nav-link';
        if(t==='info') loadRepairHistory(); else prepareRepairForm();
    }

    async function loadRepairHistory() {
        const tb = document.getElementById('repair-history-body'); 
        if (!tb) return;
        tb.innerHTML = '<tr><td colspan="8" class="text-center text-muted py-3">Loading…</td></tr>';

        let res = await safeFetch('/api/history/REPAIR'+noCache());
        if (!res || !res.ok) res = await safeFetch('/api/history/REPAIR');

        let sData = [];
        try { sData = res && res.ok ? await res.json() : []; } catch { sData = []; }
        
        tb.innerHTML = '';
        if(sData.length===0) {
            tb.innerHTML = '<tr><td colspan="8" class="text-center text-muted">No data</td></tr>';
            return;
        }
        
        sData.forEach(r => {
            const photoLink = r.photo ? `<a href="${r.photo}" target="_blank"><i class="bi bi-image"></i></a>` : '-';
            
            tb.innerHTML += `<tr data-log-id="${r.id || 0}">
                <td class="delete-col-repair" style="display: none;">
                    <button class="btn btn-sm btn-danger" onclick="deleteHistoryRecord('REPAIR', ${r.id || 0}, '${r.current_sn}')" title="Delete">
                        <i class="bi bi-trash"></i>
                    </button>
                </td>
                <td>${r.date}</td><td>${r.current_sn}</td><td>${r.vendor}</td><td>${r.wo}</td>
                <td>${r.tt} / ${r.tc}</td><td>${photoLink}</td><td>${r.remarks||'-'}</td>
            </tr>`;
        });
    }

    async function prepareRepairForm() {
        const res = await fetch('/api/engines'+noCache()); const engs = await res.json();
        const dl = document.getElementById('engine-options-rep'); dl.innerHTML = '';
        engs.forEach(e => dl.innerHTML += `<option value="${e.original_sn}">${e.current_sn} (Status: ${e.status})</option>`);
        
        document.getElementById('rep-engine-input').oninput = function() {
            this.value = this.value.replace(/[а-яА-ЯёЁ]/g, '');
            const f = engs.find(e => e.original_sn === this.value);
            
            // Сброс красной рамки
            document.getElementById('rep-cur-sn').classList.remove('border', 'border-danger');

            if(f) { 
                // Проверяем статус - SV двигатели нельзя отремонтировать
                if(f.status === 'SV') {
                    showErrorNotification(`❌ Engine ${f.original_sn} has status SV (Serviceable) and does not need repair. Only non-SV engines can be repaired.`);
                    this.value = '';
                    document.getElementById('rep-engine-id').value = ''; 
                    document.getElementById('rep-cur-sn').value = '';
                    return;
                }
                
                document.getElementById('rep-engine-id').value = f.id; 
                document.getElementById('rep-cur-sn').value = f.current_sn; 
                document.getElementById('rep-status-view').value = f.status; 
                document.getElementById('rep-tt').value = f.tt; 
                document.getElementById('rep-tc').value = f.tc; 
            } else { 
                document.getElementById('rep-engine-id').value = ''; 
                document.getElementById('rep-cur-sn').value = '';
            }
        };
    }

    let _repairSubmitting = false;
    async function submitRepairForm() {
        if (_repairSubmitting) { return; }
        _repairSubmitting = true;
        const saveBtn = document.querySelector('#tab-rep-entry .btn.btn-warning.px-4');
        if (saveBtn) { saveBtn.disabled = true; saveBtn.dataset._orig = saveBtn.innerHTML; saveBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Saving...'; }
        const date = document.getElementById('rep-date').value;
        const eid = document.getElementById('rep-engine-id').value;
        const vendor = document.getElementById('rep-vendor').value;
        const curSn = document.getElementById('rep-cur-sn').value;
        
        // Строгая проверка: Если поле SN не заполнено (нет в базе) - ошибка
        if (!curSn) {
            alert("Ошибка: Выберите существующий двигатель из списка!");
            document.getElementById('rep-cur-sn').classList.add('border', 'border-danger');
            return;
        }
        if(!date || !vendor) { alert("Заполните дату и вендора"); return; }

        const payload = {
            date: date, engine_id: parseInt(eid), vendor: vendor,
            work_order: document.getElementById('rep-wo').value, 
            tt: parseFloat(document.getElementById('rep-tt').value)||0,
            tc: parseInt(document.getElementById('rep-tc').value)||0,
            photo_url: document.getElementById('rep-photo').value,
            remarks: document.getElementById('rep-rem').value
        };

        try {
            const res = await fetch('/api/actions/repair', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload)});
            
            if (!res.ok) {
                const error = await res.json();
                throw new Error(error.detail || 'Ошибка сохранения');
            }

            document.getElementById('form-repair').reset();
            switchRepairTab('info');
            await loadRepairHistory();
            refreshAfterDataChange();
            alert("✅ Ремонт записан! Статус обновлен на SV.");
        } catch(e) { 
            alert("❌ Ошибка: " + e.message); 
        } finally {
            _repairSubmitting = false;
            if (saveBtn) { saveBtn.disabled = false; saveBtn.innerHTML = saveBtn.dataset._orig || 'Save (Set SV)'; }
        }
    }

    // --- PARTS LOGIC ---
    let localTestParts = [];

    async function openPartsView() {
        hideAllViews();
        document.getElementById('view-parts').style.display = 'block';
        await loadPartsHistory();
        await loadStoreBalanceForPartsForm();
    }

    async function openStoreBalanceView() {
        hideAllViews();
        const view = document.getElementById('view-store-balance');
        if (view) {
            view.style.display = 'block';
        }
        switchStoreBalanceTab('list');
        updateHistory('store-balance');
        await loadStoreBalance();
    }

    function switchPartsTab(t) {
        document.getElementById('tab-parts-list').style.display = t==='list'?'block':'none';
        document.getElementById('tab-parts-add').style.display = t==='add'?'block':'none';
        document.getElementById('tab-parts-list-btn').className = t==='list'?'nav-link active':'nav-link';
        document.getElementById('tab-parts-add-btn').className = t==='add'?'nav-link active':'nav-link';
        
        // Load store balance data when switching to Add tab
        if (t === 'add') {
            loadStoreBalanceForPartsForm();
        }
    }

    function switchStoreBalanceTab(tab) {
        const listView = document.getElementById('tab-store-list');
        const addView = document.getElementById('tab-store-add');
        const listBtn = document.getElementById('tab-store-list-btn');
        const addBtn = document.getElementById('tab-store-add-btn');

        if (!listView || !addView || !listBtn || !addBtn) return;

        const isList = tab === 'list';
        listView.style.display = isList ? 'block' : 'none';
        addView.style.display = isList ? 'none' : 'block';
        listBtn.className = isList ? 'nav-link active' : 'nav-link';
        addBtn.className = isList ? 'nav-link' : 'nav-link active';
    }

    async function loadStoreBalance() {
        const tbody = document.getElementById('store-balance-body');
        if (!tbody) return;

        try {
            const res = await fetch('/api/store-balance' + noCache());
            if (!res.ok) {
                const error = await res.json().catch(() => ({}));
                throw new Error(error.detail || `HTTP ${res.status}`);
            }

            const data = await res.json();
            tbody.innerHTML = '';

            if (!data || data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="12" class="text-center">No store items recorded</td></tr>';
                return;
            }

            data.forEach(item => {
                const identifier = `${item.part_name || 'Item'} (${item.part_number || '-'})`;
                const safeIdentifier = escapeHtml(identifier);
                const fmt = (value) => {
                    if (value === undefined || value === null || value === '') return '-';
                    return escapeHtml(value);
                };
                const fmtNumber = (value) => {
                    if (value === undefined || value === null || value === '') return '-';
                    if (typeof value === 'number' && !Number.isFinite(value)) return '-';
                    return escapeHtml(value);
                };

                // Map condition text to CSS class for colored badge
                const condText = (item.condition || '').trim();
                const condClassMap = {
                    'SV - NGV (SENT)': 'cond-sv',
                    'UNDER REPAIRING': 'cond-under',
                    'Delivered in Roma Italy': 'cond-delivered',
                    'NO CAPABILITY': 'cond-nocap',
                    'US - SHJ': 'cond-us'
                };
                const condClass = condClassMap[condText] || 'cond-default';
                const condHtml = condText ? `<span class="cond-badge ${condClass}">${escapeHtml(condText)}</span>` : '-';

                tbody.innerHTML += `
                    <tr data-log-id="${item.id}">
                        <td class="delete-col delete-col-store-balance" style="display: none;">
                            <button class="btn btn-sm btn-danger" data-identifier="${safeIdentifier}" onclick="deleteHistoryRecord('STORE_BALANCE', ${item.id}, this.dataset.identifier || '')" title="Delete">
                                <i class="bi bi-trash"></i>
                            </button>
                        </td>
                        <td>${fmt(item.received_date)}</td>
                        <td>${fmt(item.part_name)}</td>
                        <td>${fmt(item.part_number)}</td>
                        <td>${fmt(item.serial_number)}</td>
                        <td>${condHtml}</td>
                        <td>${fmtNumber(item.quantity)}</td>
                        <td>${fmt(item.unit)}</td>
                        <td>${fmt(item.location)}</td>
                        <td>${fmt(item.shelf)}</td>
                        <td>${fmt(item.owner)}</td>
                        <td>${fmt(item.remarks)}</td>
                    </tr>`;
            });

            // After render, (re)attach column resizers once per header
            attachStoreBalanceColumnResizers();
        } catch (error) {
            console.error('Store balance load error:', error);
            showErrorNotification(`Failed to load store balance: ${error.message}`);
        }
    }

    let _storeBalanceSubmitting = false;
    async function submitStoreBalanceForm() {
        if (_storeBalanceSubmitting) { return; }
        _storeBalanceSubmitting = true;
        const saveBtn = document.querySelector('#tab-store-balance-add .btn.btn-primary.px-4');
        if (saveBtn) { saveBtn.disabled = true; saveBtn.dataset._orig = saveBtn.innerHTML; saveBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Saving...'; }
        const form = document.getElementById('form-store-part');
        if (!form) return;

        const quantityRaw = document.getElementById('store-qty').value;
        const payload = {
            received_date: document.getElementById('store-date').value || null,
            part_name: document.getElementById('store-name').value.trim(),
            part_number: document.getElementById('store-pn').value.trim(),
            serial_number: document.getElementById('store-sn').value.trim(),
            condition: document.getElementById('store-condition').value.trim(),
            quantity: quantityRaw === '' ? 0 : parseInt(quantityRaw, 10),
            unit: document.getElementById('store-unit').value.trim(),
            location: document.getElementById('store-location').value.trim(),
            shelf: document.getElementById('store-shelf').value.trim(),
            owner: document.getElementById('store-owner').value.trim(),
            remarks: document.getElementById('store-remarks').value.trim()
        };

        if (!payload.part_name) {
            showErrorNotification('Store item: Part Name is required.');
            return;
        }

        if (!payload.part_number) {
            showErrorNotification('Store item: P/N is required.');
            return;
        }

        if (Number.isNaN(payload.quantity)) {
            showErrorNotification('Store item: Quantity must be a number.');
            return;
        }

        if (payload.quantity < 0) {
            showErrorNotification('Store item: Quantity cannot be negative.');
            return;
        }

        try {
            const res = await fetch('/api/store-balance', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!res.ok) {
                const error = await res.json().catch(() => ({}));
                throw new Error(error.detail || res.statusText);
            }

            form.reset();
            switchStoreBalanceTab('list');
            await loadStoreBalance();
            showSuccessNotification('✅ Store item saved!');
        } catch (error) {
            console.error('Store balance save error:', error);
            showErrorNotification(`Error saving store item: ${error.message}`);
        } finally {
            _storeBalanceSubmitting = false;
            if (saveBtn) { saveBtn.disabled = false; saveBtn.innerHTML = saveBtn.dataset._orig || 'Save Item'; }
        }
    }

    // Динамические поля (From/To)
    function updatePartFormFields() {
        const action = document.getElementById('part-action').value;
        const container = document.getElementById('part-dynamic-fields');
        container.innerHTML = ''; // Очистить

        // HTML для полей From и To (с автопоиском по двигателям)
        const fromHtml = `
            <div class="col-md-6">
                <label class="small fw-bold text-danger">FROM (Orig ESN / GSS)</label>
                <input class="form-control" list="engine-options-parts" placeholder="Search Engine..." id="part-from-input">
            </div>`;
        
        const toHtml = `
            <div class="col-md-6">
                <label class="small fw-bold text-success">TO (Orig ESN / GSS)</label>
                <input class="form-control" list="engine-options-parts" placeholder="Search Engine..." id="part-to-input">
            </div>`;

        // Логика отображения
        if (action === 'INSTALLED') {
            container.innerHTML = `<div class="row">${toHtml}</div>`;
        } else if (action === 'REMOVED') {
            container.innerHTML = `<div class="row">${fromHtml}</div>`;
        } else if (action === 'SWAP') {
            container.innerHTML = `<div class="row">${fromHtml}${toHtml}</div>`;
        }

        // Загружаем список двигателей в datalist (если его еще нет)
        if(!document.getElementById('engine-options-parts')) {
            const dl = document.createElement('datalist');
            dl.id = 'engine-options-parts';
            // Используем глобальную переменную, если она заполнена, или грузим заново
            // Для упрощения просто добавим пустой, он заполнится при фокусе или загрузке
            document.body.appendChild(dl);
            populatePartsEngineList();
        }
    }

    async function populatePartsEngineList() {
        const res = await fetch('/api/engines' + noCache());
        const engs = await res.json();
        const dl = document.getElementById('engine-options-parts');
        dl.innerHTML = '';
        engs.forEach(e => dl.innerHTML += `<option value="${e.original_sn}">${e.current_sn}</option>`);
    }

    // Store Balance cache for Parts form
    let storeBalanceCache = [];

    async function loadStoreBalanceForPartsForm() {
        try {
            const res = await fetch('/api/store-balance' + noCache());
            if (!res.ok) return;
            
            storeBalanceCache = await res.json();
            
            // Populate datalists
            const nameList = document.getElementById('part-name-options');
            const pnList = document.getElementById('part-pn-options');
            
            if (nameList) {
                nameList.innerHTML = '';
                const uniqueNames = [...new Set(storeBalanceCache.map(p => p.part_name).filter(Boolean))];
                uniqueNames.forEach(name => {
                    nameList.innerHTML += `<option value="${name}">`;
                });
            }
            
            if (pnList) {
                pnList.innerHTML = '';
                const uniquePNs = [...new Set(storeBalanceCache.map(p => p.part_number).filter(Boolean))];
                uniquePNs.forEach(pn => {
                    pnList.innerHTML += `<option value="${pn}">`;
                });
            }
        } catch (err) {
            console.error('Error loading store balance for parts form:', err);
        }
    }

    function updatePartPNFromName() {
        const name = document.getElementById('part-name').value.trim();
        if (!name) return;
        
        // Find matching part in cache
        const match = storeBalanceCache.find(p => p.part_name === name);
        if (match && match.part_number) {
            document.getElementById('part-pn').value = match.part_number;
        }
    }

    async function checkPartInStoreBalance(name, pn) {
        if (!storeBalanceCache || storeBalanceCache.length === 0) {
            // Try to load if cache is empty
            await loadStoreBalanceForPartsForm();
        }
        
        // Check if part exists
        return storeBalanceCache.some(p => 
            (p.part_name && p.part_name.toLowerCase() === name.toLowerCase()) ||
            (p.part_number && p.part_number.toLowerCase() === pn.toLowerCase())
        );
    }

    let _partsSubmitting = false;
    async function submitPartForm() {
        if (_partsSubmitting) { return; }
        _partsSubmitting = true;
        const saveBtn = document.querySelector('#tab-parts-add .btn.btn-primary.px-4');
        if (saveBtn) { saveBtn.disabled = true; saveBtn.dataset._orig = saveBtn.innerHTML; saveBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Saving...'; }
        const date = document.getElementById('part-date').value || new Date().toISOString().split('T')[0];
        const action = document.getElementById('part-action').value || 'INSTALLED';
        const name = document.getElementById('part-name').value || 'Part';
        const pn = document.getElementById('part-pn').value || 'N/A';
        const sn = document.getElementById('part-sn').value || 'N/A';

        // Получаем значения из динамических полей (если они есть)
        const fromVal = document.getElementById('part-from-input') ? document.getElementById('part-from-input').value : '-';
        const toVal = document.getElementById('part-to-input') ? document.getElementById('part-to-input').value : '-';

        // Проверяем наличие запчасти в Store Balance
        const existsInStore = await checkPartInStoreBalance(name, pn);
        
        if (!existsInStore) {
            const confirmed = confirm(`⚠️ Запчасть "${name}" (P/N: ${pn}) не найдена в Store Balance.\n\nВы точно хотите сохранить эту операцию?`);
            if (!confirmed) {
                return; // Отменяем сохранение
            }
        }

        const payload = {
            date: date, action: action, part_name: name, part_number: pn, serial_number: sn,
            quantity: parseInt(document.getElementById('part-qty').value)||1,
            location: document.getElementById('part-loc').value,
            from_esn: fromVal, to_esn: toVal,
            reason: document.getElementById('part-rem').value
        };

        try {
            const res = await fetch('/api/actions/part', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload)});
            
            if (!res.ok) {
                const error = await res.json().catch(() => ({}));
                throw new Error(error.detail || 'Save failed');
            }
            
            document.getElementById('form-parts').reset();
            document.getElementById('part-dynamic-fields').innerHTML = '<p class="small text-muted mb-2">Select Action...</p>';
            switchPartsTab('list');
            await loadPartsHistory();
            refreshAfterDataChange();
            showSuccessNotification('✅ Part action saved!');
        } catch(e) { 
            showErrorNotification(`Error: ${e.message}`);
            console.error('Part save error:', e);
        } finally {
            _partsSubmitting = false;
            if (saveBtn) { saveBtn.disabled = false; saveBtn.innerHTML = saveBtn.dataset._orig || 'Save Record'; }
        }
    }

    async function loadPartsHistory() {
        const tb = document.getElementById('parts-history-body');
        if (!tb) return;
        tb.innerHTML = '<tr><td colspan="11" class="text-center text-muted py-3">Loading…</td></tr>';

        let res = await safeFetch('/api/parts/history' + noCache());
        if (!res || !res.ok) res = await safeFetch('/api/parts/history');
        
        let serverData = [];
        try { serverData = res && res.ok ? await res.json() : []; } catch { serverData = []; }

        tb.innerHTML = '';
        
        if(serverData.length === 0) {
            tb.innerHTML = '<tr><td colspan="11" class="text-center text-muted">No parts history</td></tr>';
            return;
        }

        serverData.forEach(r => {
            let badge = 'bg-secondary';
            if(r.action==='INSTALLED') badge='bg-success';
            if(r.action==='REMOVED') badge='bg-danger';
            if(r.action==='SWAP') badge='bg-warning text-dark';

            const safeSerialNumber = escapeHtml(r.serial_number || '');
            tb.innerHTML += `
                <tr data-log-id="${r.id || 0}">
                    <td class="delete-col delete-col-parts" style="display: none;">
                        <button class="btn btn-sm btn-danger" data-identifier="${safeSerialNumber}" onclick="deleteHistoryRecord('PARTS', ${r.id || 0}, this.dataset.identifier || '')" title="Delete">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                    <td>${escapeHtml(r.date)}</td>
                    <td><span class="badge ${badge}">${escapeHtml(r.action)}</span></td>
                    <td>${escapeHtml(r.part_name)}</td>
                    <td>${escapeHtml(r.part_number)}</td>
                    <td>${safeSerialNumber}</td>
                    <td>${escapeHtml(r.quantity)}</td>
                    <td>${escapeHtml(r.from_esn||'-')}</td>
                    <td>${escapeHtml(r.to_esn||'-')}</td>
                    <td>${escapeHtml(r.location||'-')}</td>
                    <td>${escapeHtml(r.reason||'-')}</td>
                </tr>`;
        });
    }
    // --- UTILIZATION LOGIC (UPDATED) ---
    let utilAircraftSummary = [];
    let utilSummaryById = new Map();
    let fullUtilData = []; // Храним полные данные для фильтрации
    let activeFilters = {}; // Храним состояние фильтров

    async function openUtilView() {
        hideAllViews();
        document.getElementById('view-util').style.display = 'block';
        await loadUtilHistory();
    }

    function switchUtilTab(t) {
        document.getElementById('tab-util-list').style.display = t==='list'?'block':'none';
        document.getElementById('tab-util-entry').style.display = t==='entry'?'block':'none';
        document.getElementById('tab-util-list-btn').className = t==='list'?'nav-link active':'nav-link';
        document.getElementById('tab-util-entry-btn').className = t==='entry'?'nav-link active':'nav-link';
        if(t==='list') loadUtilHistory(); else prepareUtilForm();
    }

    async function loadUtilHistory() {
        const tb = document.getElementById('util-history-body'); 
        if (!tb) return;
        tb.innerHTML = '<tr><td colspan="7" class="text-center text-muted py-3">Loading…</td></tr>';

        let res = await safeFetch('/api/history/FLIGHT' + noCache());
        if (!res || !res.ok) res = await safeFetch('/api/history/FLIGHT');
        
        let sData = [];
        try { sData = res && res.ok ? await res.json() : []; } catch { sData = []; }
        fullUtilData = sData;
        
        tb.innerHTML = '';
        
        if(sData.length===0) {
            tb.innerHTML = '<tr><td colspan="7" class="text-center text-muted">No flights recorded</td></tr>';
            return;
        }

        sData.forEach(r => {
            const ttDisplay = (typeof r.added_tt === 'number' && !isNaN(r.added_tt))
                ? r.added_tt.toFixed(2)
                : escapeHtml(r.added_tt ?? '0.00');
            const cyclesDisplay = r.cycles ?? r.added_tc ?? 0;
            const atlbLabel = r.ref ? `<strong>${escapeHtml(r.ref)}</strong>` : '<span class="text-muted">—</span>';
            const totalTtsn = escapeHtml(r.total_ttsn || '0:00');
            const totalTcsn = escapeHtml(String(r.total_tcsn ?? 0));
            const maintenanceBadge = r.maintenance ? '<span class="badge bg-warning text-dark">Maintenance</span>' : '';

            tb.innerHTML += `
                <tr data-log-id="${r.id || 0}" class="${r.maintenance ? 'table-warning' : ''}">
                    <td class="delete-col-util" style="display: none;">
                        <button class="btn btn-sm btn-danger" onclick="deleteHistoryRecord('FLIGHT', ${r.id || 0}, '${r.aircraft}')" title="Delete">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                    <td>${r.date}</td>
                    <td><strong>${r.aircraft}</strong></td>
                    <td>${r.route}</td>
                    <td>${ttDisplay}</td>
                    <td>${cyclesDisplay}</td>
                    <td>
                        ${atlbLabel}
                        <div class="text-muted small">TTSN: ${totalTtsn} | TCSN: ${totalTcsn}</div>
                        ${maintenanceBadge}
                    </td>
                </tr>
            `;
        });
    }

    async function ensureUtilSummary(forceReload = false) {
        if (!forceReload && utilAircraftSummary.length > 0) {
            return;
        }

        try {
            const res = await fetch('/api/utilization/summary' + noCache());
            utilAircraftSummary = await res.json();
        } catch (err) {
            console.error('Failed to load utilization summary', err);
            utilAircraftSummary = [];
        }

        utilSummaryById = new Map();
        utilAircraftSummary.forEach(ac => {
            const idKey = String(ac.aircraft_id);
            utilSummaryById.set(idKey, ac);

            const tailNormalized = String(ac.tail_number || '').toUpperCase();
            if (tailNormalized) {
                utilSummaryById.set(tailNormalized, ac);
                const shortTail = tailNormalized.includes('-') ? tailNormalized.split('-').pop() : tailNormalized;
                utilSummaryById.set(shortTail, ac);
            }
        });
    }

    async function prepareUtilForm(selectedId, forceReload = false) {
        await ensureUtilSummary(forceReload);

        const sel = document.getElementById('util-ac');
        sel.innerHTML = '<option value="" disabled selected>Select Aircraft...</option>';

        utilAircraftSummary.forEach(ac => {
            sel.innerHTML += `<option value="${ac.aircraft_id}">${ac.tail_number}</option>`;
        });

        sel.onchange = function() {
            const picked = this.value;
            sel.dataset.selectedId = picked;
            updateUtilFormContext(picked);
        };

        const maintenanceCheckbox = document.getElementById('util-maintenance');
        if (maintenanceCheckbox && !maintenanceCheckbox.dataset.bound) {
            maintenanceCheckbox.addEventListener('change', (e) => setUtilMaintenanceMode(e.target.checked));
            maintenanceCheckbox.dataset.bound = 'true';
        }

        const targetId = selectedId ? String(selectedId) : (sel.dataset.selectedId || '');
        if (targetId && utilSummaryById.has(targetId)) {
            sel.value = targetId;
            sel.dataset.selectedId = targetId;
            updateUtilFormContext(targetId);
        } else {
            const statsField = document.getElementById('util-current-stats');
            statsField.value = '';
            statsField.title = '';
            sel.dataset.selectedId = '';
        }
    }

    function updateUtilFormContext(aircraftId) {
        const statsField = document.getElementById('util-current-stats');
        const atlbInput = document.getElementById('util-atlb');
        const summary = utilSummaryById.get(String(aircraftId));

        if (!summary) {
            statsField.value = '';
            statsField.title = '';
            return;
        }

        const ttInfo = summary.initial_ttsn && summary.initial_ttsn !== summary.current_ttsn
            ? `TT ${summary.current_ttsn} (base ${summary.initial_ttsn})`
            : `TT ${summary.current_ttsn}`;
        const tcInfo = summary.initial_tcsn !== summary.current_tcsn
            ? `TC ${summary.current_tcsn} (base ${summary.initial_tcsn})`
            : `TC ${summary.current_tcsn}`;
        const infoParts = [ttInfo, tcInfo];
        const titleParts = [`Start TT ${summary.initial_ttsn}`, `Start TC ${summary.initial_tcsn}`];
        if (summary.last_atlb_ref) {
            infoParts.push(`ATLB ${summary.last_atlb_ref}`);
        }
        if (summary.next_atlb_ref) {
            infoParts.push(`Next ${summary.next_atlb_ref}`);
        }

        statsField.value = infoParts.join(' | ');
        statsField.title = titleParts.join(' | ');

        if (summary.next_atlb_ref) {
            if (!atlbInput.value || atlbInput.value === summary.last_atlb_ref) {
                atlbInput.value = summary.next_atlb_ref;
            }
        }
    }

    function setUtilMaintenanceMode(isMaintenance) {
        const fhField = document.getElementById('util-fh');
        const fcField = document.getElementById('util-fc');
        if (isMaintenance) {
            fhField.dataset.prevValue = fhField.value;
            fcField.dataset.prevValue = fcField.value;
            fhField.value = '0.00';
            fcField.value = '0';
        } else {
            if (fhField.dataset.prevValue !== undefined) {
                fhField.value = fhField.dataset.prevValue;
                delete fhField.dataset.prevValue;
            }
            if (fcField.dataset.prevValue !== undefined) {
                fcField.value = fcField.dataset.prevValue || '1';
                delete fcField.dataset.prevValue;
            }
        }
        fhField.disabled = isMaintenance;
        fcField.disabled = isMaintenance;
    }

    // === ENGINE PARAMETERS TAB SWITCHING ===
    function switchParamTab(t) {
        document.getElementById('tab-param-entry').style.display = t==='entry'?'block':'none';
        document.getElementById('tab-param-history').style.display = t==='history'?'block':'none';
        document.getElementById('tab-param-entry-btn').className = t==='entry'?'nav-link active':'nav-link';
        document.getElementById('tab-param-history-btn').className = t==='history'?'nav-link active':'nav-link';
        if(t==='history') loadParameterHistory();
    }
    
    async function loadParameterHistory() {
        try {
            const res = await fetch('/api/engines/parameters/history');
            const history = await res.json();
            
            const tbody = document.getElementById('param-history-body');
            tbody.innerHTML = '';
            
            if (history.length === 0) {
                tbody.innerHTML = '<tr><td colspan="12" class="text-muted">No parameter records found</td></tr>';
                return;
            }
            
            history.forEach(h => {
                const dateStr = h.date ? new Date(h.date).toLocaleDateString('ru-RU') : 'N/A';
                const createdStr = h.created_at ? new Date(h.created_at).toLocaleString('ru-RU') : 'N/A';
                
                const row = document.createElement('tr');
                row.setAttribute('data-log-id', h.id);
                row.innerHTML = `
                    <td class="delete-col-param" style="display: none;">
                        <button class="btn btn-sm btn-danger" onclick="deleteHistoryRecord('PARAMETER', ${h.id})" title="Delete">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                    <td>${dateStr}</td>
                    <td>${h.aircraft || 'N/A'}</td>
                    <td>Pos ${h.position || 'N/A'}</td>
                    <td>${h.engine_sn}</td>
                    <td>${h.n1_takeoff !== null ? h.n1_takeoff + '%' : 'N/A'}</td>
                    <td>${h.n2_takeoff !== null ? h.n2_takeoff + '%' : 'N/A'}</td>
                    <td>${h.egt_takeoff !== null ? h.egt_takeoff + '°C' : 'N/A'}</td>
                    <td>${h.n1_cruise !== null ? h.n1_cruise + '%' : 'N/A'}</td>
                    <td>${h.n2_cruise !== null ? h.n2_cruise + '%' : 'N/A'}</td>
                    <td>${h.egt_cruise !== null ? h.egt_cruise + '°C' : 'N/A'}</td>
                    <td>${createdStr}</td>
                `;
                tbody.appendChild(row);
            });
        } catch (err) {
            console.error('Error loading parameter history:', err);
            document.getElementById('param-history-body').innerHTML = 
                '<tr><td colspan="12" class="text-danger">Error loading history</td></tr>';
        }
    }

    async function submitUtilForm() {
        const date = document.getElementById('util-date').value;
        const aircraftSelect = document.getElementById('util-ac');
        const aircraftId = aircraftSelect.value;
        const fhRaw = document.getElementById('util-fh').value;
        const fcRaw = document.getElementById('util-fc').value;
        const isMaintenance = document.getElementById('util-maintenance').checked;

        const fh = parseFloat(fhRaw);
        const fc = parseInt(fcRaw);

        if (!date || !aircraftId) {
            alert("Выберите дату и самолет");
            return;
        }

        if (!isMaintenance && (isNaN(fh) || isNaN(fc))) {
            alert("Укажите налет и циклы");
            return;
        }

        const summary = utilSummaryById.get(String(aircraftId));

        const payload = {
            date: date,
            aircraft_id: parseInt(aircraftId, 10),
            aircraft_tail: summary ? summary.tail_number : aircraftSelect.options[aircraftSelect.selectedIndex]?.text,
            flight_from: document.getElementById('util-from').value.trim(),
            flight_to: document.getElementById('util-to').value.trim(),
            flight_hours: isNaN(fh) ? 0 : fh,
            flight_cycles: isNaN(fc) ? 0 : fc,
            atlb_ref: document.getElementById('util-atlb').value.trim(),
            maintenance: isMaintenance
        };

        try {
            const res = await fetch('/api/actions/utilization', {
                method:'POST',
                headers:{'Content-Type':'application/json'},
                body:JSON.stringify(payload)
            });

            if(!res.ok) {
                const err = await res.json().catch(() => null);
                const detail = err?.detail || err?.message || 'Server error';
                throw new Error(detail);
            }

            await prepareUtilForm(payload.aircraft_id, true);
            const fhField = document.getElementById('util-fh');
            const fcField = document.getElementById('util-fc');
            delete fhField.dataset.prevValue;
            delete fcField.dataset.prevValue;
            document.getElementById('form-util').reset();
            setUtilMaintenanceMode(false);
            switchUtilTab('list');
            alert("Налет сохранен");
        } catch(e) {
            console.error('Failed to save utilization', e);
            alert(`Ошибка: ${e.message}`);
        }
    }
    // --- ATLB LOGIC ---
    let aircraftCache = []; // Кэш для хранения данных о самолетах

    async function openAtlbView() {
        hideAllViews();
        document.getElementById('view-atlb').style.display = 'block';
        updateHistory('atlb');
        switchAtlbTab('entry');

        await ensureUtilSummary();
        aircraftCache = utilAircraftSummary;

        const sel = document.getElementById('atlb-ac');
        const previousSelection = sel.dataset.selectedId;
        sel.innerHTML = '<option value="" disabled selected>Select A/C...</option>';

        aircraftCache.forEach(ac => {
            sel.innerHTML += `<option value="${ac.aircraft_id}">${ac.tail_number}</option>`;
        });

        let defaultId = previousSelection && utilSummaryById.has(String(previousSelection))
            ? previousSelection
            : (aircraftCache.length ? String(aircraftCache[0].aircraft_id) : '');

        if (defaultId) {
            sel.value = defaultId;
            sel.dataset.selectedId = defaultId;
            updateAcInfo();
        } else {
            sel.value = '';
            sel.dataset.selectedId = '';
            updateAcInfo();
        }
    }

    function switchAtlbTab(t) {
        document.getElementById('tab-atlb-entry').style.display = t==='entry'?'block':'none';
        document.getElementById('tab-atlb-list').style.display = t==='list'?'block':'none';
        document.getElementById('tab-atlb-entry-btn').className = t==='entry'?'nav-link active':'nav-link';
        document.getElementById('tab-atlb-list-btn').className = t==='list'?'nav-link active':'nav-link';
        if(t==='list') loadAtlbHistory();
    }

    // Автозаполнение при выборе самолета
    function updateAcInfo() {
        const sel = document.getElementById('atlb-ac');
        const aircraftId = sel.value;
        const summary = utilSummaryById.get(String(aircraftId));

        sel.dataset.selectedId = aircraftId || '';

        const msnField = document.getElementById('atlb-msn');
        const statsField = document.getElementById('atlb-stats');
        const lastDateField = document.getElementById('atlb-last-date');
        const lastSheetField = document.getElementById('atlb-last-sheet');
        const atlbNoField = document.getElementById('atlb-no');
        const atlbSuggestionList = document.getElementById('atlb-no-suggestions');

        if (!summary) {
            msnField.value = '';
            statsField.value = '';
            statsField.title = '';
            lastDateField.value = '';
            lastSheetField.value = '';
            if (atlbSuggestionList) {
                atlbSuggestionList.innerHTML = '';
            }
            if (atlbNoField) {
                atlbNoField.value = '';
                atlbNoField.placeholder = '';
            }
            return;
        }

        msnField.value = summary.msn || 'Unknown';

        const statsParts = [`TT ${summary.current_ttsn}`, `TC ${summary.current_tcsn}`];
        statsField.value = statsParts.join(' | ');
        statsField.title = `Start TT ${summary.initial_ttsn} | Start TC ${summary.initial_tcsn}`;

        lastDateField.value = summary.last_entry_date || '—';
        lastSheetField.value = summary.last_atlb_ref || '—';
        if (atlbSuggestionList) {
            atlbSuggestionList.innerHTML = '';
            if (summary.next_atlb_ref) {
                const opt = document.createElement('option');
                opt.value = summary.next_atlb_ref;
                atlbSuggestionList.appendChild(opt);
            }
        }
        atlbNoField.value = '';
        atlbNoField.placeholder = summary.next_atlb_ref || '';
    }

    // Калькулятор времени (самая важная часть)
    function calcTime(type) {
        const t1Str = document.getElementById(type === 'block' ? 'time-out' : 'time-off').value;
        const t2Str = document.getElementById(type === 'block' ? 'time-in' : 'time-on').value;
        const resField = document.getElementById(type === 'block' ? 'time-block-res' : 'time-flight-res');

        if (t1Str && t2Str) {
            const [h1, m1] = t1Str.split(':').map(Number);
            const [h2, m2] = t2Str.split(':').map(Number);
            
            let minutes1 = h1 * 60 + m1;
            let minutes2 = h2 * 60 + m2;
            
            // Если время "Прилета" меньше "Вылета", значит перешли полночь (+24 часа)
            if (minutes2 < minutes1) {
                minutes2 += 24 * 60;
            }
            
            const diff = minutes2 - minutes1;
            const diffH = Math.floor(diff / 60);
            const diffM = diff % 60;
            
            // Форматируем в HH:MM
            const hh = String(diffH).padStart(2, '0');
            const mm = String(diffM).padStart(2, '0');
            resField.value = `${hh}:${mm}`;
        }
    }
    // Функция блокировки времени для Maintenance Only
    function toggleFlightTimes() {
        const isMaint = document.getElementById('atlb-maint-only').checked;
        
        // Список полей времени, которые надо отключить
        const fields = ['time-out', 'time-in', 'time-off', 'time-on'];
        const routeFields = ['atlb-from', 'atlb-to'];

        fields.forEach(id => {
            const el = document.getElementById(id);
            el.disabled = isMaint; // Если галочка стоит -> выключаем
            if (isMaint) el.value = ''; // И очищаем значение
        });

        // Очищаем и расчетные поля
        if (isMaint) {
            document.getElementById('time-block-res').value = '';
            document.getElementById('time-flight-res').value = '';
        }

        routeFields.forEach(id => {
            const el = document.getElementById(id);
            if (!el) return;
            if (isMaint) {
                if (el.dataset.prevValue === undefined) {
                    el.dataset.prevValue = el.value;
                }
                el.value = '';
            } else if (el.dataset.prevValue !== undefined) {
                el.value = el.dataset.prevValue;
                delete el.dataset.prevValue;
            }
            el.disabled = isMaint;
        });
    }

    let _atlbSubmitting = false;
    async function submitAtlbForm() {
        if (_atlbSubmitting) { return; }
        _atlbSubmitting = true;
        const saveBtn = document.querySelector('#tab-atlb-entry .btn.btn-success');
        if (saveBtn) { saveBtn.disabled = true; saveBtn.dataset._orig = saveBtn.innerHTML; saveBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Saving...'; }
        const aircraftSelect = document.getElementById('atlb-ac');
        const aircraftId = aircraftSelect.value;
        if (!aircraftId) { alert('Выберите самолет'); return; }

        const isMaintenanceOnly = document.getElementById('atlb-maint-only').checked;

        const summary = utilSummaryById.get(String(aircraftId));
        const acId = parseInt(aircraftId, 10);

        // Для отправки нам нужно Flight Time
        const ftStr = document.getElementById('time-flight-res').value;
        const btStr = document.getElementById('time-block-res').value;
        
        if (!isMaintenanceOnly && !ftStr) { alert("Заполните время полета (Off/On)"); return; }

        const numberOrZero = (id) => {
            const raw = document.getElementById(id)?.value;
            const parsed = parseFloat(raw);
            return Number.isFinite(parsed) ? parsed : null;
        };

        const payload = {
            date: document.getElementById('atlb-date').value,
            aircraft_id: acId || 1,
            atlb_no: document.getElementById('atlb-no').value,
            from_apt: document.getElementById('atlb-from').value,
            to_apt: document.getElementById('atlb-to').value,
            out_time: document.getElementById('time-out').value,
            in_time: document.getElementById('time-in').value,
            block_time: btStr || (isMaintenanceOnly ? '00:00' : ''),
            off_time: document.getElementById('time-off').value,
            on_time: document.getElementById('time-on').value,
            flight_time: ftStr || (isMaintenanceOnly ? '00:00' : ''),
            cycles: isMaintenanceOnly ? 0 : 1,
            maintenance_type: document.getElementById('atlb-maint').value,
            maintenance_only: isMaintenanceOnly,
            oil_1: numberOrZero('oil-1'),
            oil_2: numberOrZero('oil-2'),
            oil_3: numberOrZero('oil-3'),
            oil_4: numberOrZero('oil-4'),
            oil_apu: numberOrZero('oil-apu'),
            hyd_1: numberOrZero('hyd-1'),
            hyd_2: numberOrZero('hyd-2'),
            hyd_3: numberOrZero('hyd-3'),
            hyd_4: numberOrZero('hyd-4')
            // Масло и гидравлику можно добавить в payload по аналогии
        };

        if (isMaintenanceOnly) {
            payload.from_apt = '';
            payload.to_apt = '';
            payload.out_time = '';
            payload.in_time = '';
            payload.off_time = '';
            payload.on_time = '';
        }

        try {
            console.log('Submitting ATLB payload', payload);
            const res = await fetch('/api/actions/atlb', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload)});
            if(res.ok) {
                alert("ATLB Saved!");
                await ensureUtilSummary(true);
                document.getElementById('form-atlb').reset();
                toggleFlightTimes();
                aircraftSelect.value = String(aircraftId);
                aircraftSelect.dataset.selectedId = String(aircraftId);
                updateAcInfo();
                switchAtlbTab('list');
            } else {
                let errorMessage = '';
                try {
                    errorMessage = await res.text();
                    if (errorMessage) {
                        const maybeJson = JSON.parse(errorMessage);
                        if (maybeJson.detail) {
                            errorMessage = Array.isArray(maybeJson.detail)
                                ? maybeJson.detail.map(item => item.msg || JSON.stringify(item)).join('\n')
                                : String(maybeJson.detail);
                        }
                    }
                } catch (parseErr) {
                    console.warn('Failed to parse error response', parseErr);
                }
                console.error('ATLB save failed', res.status, errorMessage);
                alert(errorMessage || `Ошибка сервера (${res.status})`);
            }
        } catch(e) { alert("Ошибка сети"); }
    }

    function formatLiftValue(value) {
        if (value === null || value === undefined) {
            return '-';
        }
        const num = Number(value);
        if (Number.isNaN(num)) {
            return '-';
        }
        if (num === 0) {
            return '0';
        }
        return Number.isInteger(num) ? num.toString() : num.toFixed(1);
    }

    // --- ENGINE BUTTON LOGIC ---
    let isDashboardOpen = true;
    let engineClickTimer = null;
    let engineClickCount = 0;
    let fanSpinTimeout = null;

    function handleEngineButtonClick(event) {
        event.preventDefault();
        event.stopPropagation();

        const wrapperEl = document.getElementById('engine-btn-wrapper');
        if (wrapperEl && wrapperEl.dataset.dragged === 'true') {
            return;
        }

        engineClickCount += 1;

        if (engineClickTimer) {
            clearTimeout(engineClickTimer);
        }

        engineClickTimer = setTimeout(() => {
            if (engineClickCount === 1) {
                toggleEngineMenu();
            } else if (engineClickCount === 2) {
                toggleEngineMenu(false);
                toggleDashboardEngine();
            } else if (engineClickCount >= 3) {
                toggleEngineMenu(false);
                triggerEngineFanSpin();
            }

            engineClickCount = 0;
            engineClickTimer = null;
        }, 240);
    }

    function triggerEngineFanSpin() {
        const fan = document.querySelector('.engine-fan');
        if (!fan) {
            return;
        }

        fan.classList.add('spin');

        if (fanSpinTimeout) {
            clearTimeout(fanSpinTimeout);
        }

        fanSpinTimeout = setTimeout(() => {
            fan.classList.remove('spin');
            fanSpinTimeout = null;
        }, 2600);
    }

    function toggleEngineMenu(forceState) {
        const menu = document.getElementById('engine-btn-menu');
        const button = document.getElementById('engine-toggle-btn');
        if (!menu || !button) {
            return;
        }

        const shouldOpen = typeof forceState === 'boolean'
            ? forceState
            : !menu.classList.contains('show');

        if (shouldOpen) {
            menu.classList.add('show');
            button.classList.add('menu-open');
        } else {
            menu.classList.remove('show');
            button.classList.remove('menu-open');
        }
    }

    function handleEngineMenuSelection(action) {
        toggleEngineMenu(false);

        if (action === 'reports') {
            const submenu = document.getElementById('reports-submenu');
            if (submenu) {
                if (submenu.style.display === 'none') {
                    toggleReportsMenu();
                }
                submenu.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        } else if (action === 'manuals') {
            showSuccessNotification('Manuals shortcut activated.');
        } else if (action === 'folders') {
            showSuccessNotification('Folders shortcut activated.');
        }
    }

    document.addEventListener('click', function(event) {
        const menu = document.getElementById('engine-btn-menu');
        const wrapperEl = document.getElementById('engine-btn-wrapper');
        if (!menu || !wrapperEl) {
            return;
        }

        if (!menu.classList.contains('show')) {
            return;
        }

        if (!wrapperEl.contains(event.target)) {
            toggleEngineMenu(false);
        }
    });

    function toggleDashboardEngine() {
        const btn = document.querySelector('.btn-engine-start');
        const widgets = document.getElementById('dashboard-widgets');
        const fleet = document.getElementById('fleet-section');

        toggleEngineMenu(false);

        isDashboardOpen = !isDashboardOpen; // Переключаем состояние

        if (isDashboardOpen) {
            // --- РАЗВЕРНУТЬ ---
            btn.classList.add('active'); // Включаем подсветку
            
            // Убираем класс сворачивания, добавляем появление
            widgets.classList.remove('dashboard-collapsed');
            fleet.classList.remove('dashboard-collapsed');
            
            widgets.classList.add('dashboard-expanded');
            fleet.classList.add('dashboard-expanded');
        } else {
            // --- СВЕРНУТЬ ---
            btn.classList.remove('active'); // Выключаем подсветку
            
            // Убираем появление, добавляем сворачивание
            widgets.classList.remove('dashboard-expanded');
            fleet.classList.remove('dashboard-expanded');
            
            widgets.classList.add('dashboard-collapsed');
            fleet.classList.add('dashboard-collapsed');
        }
    }

    // Обновим функцию загрузки, чтобы при старте кнопка загоралась
    // Добавьте эту строку в конец функции loadDashboardData():
    // document.getElementById('engine-toggle-btn').classList.add('active');
    // --- ENG PARAMETERS LOGIC ---
    let localTestParams = []; // Хранилище параметров

    let currentEnginesByAircraft = {}; // Хранит двигатели по самолетам

    async function openEngParamView() {
        hideAllViews();
        document.getElementById('view-eng-param').style.display = 'block';
        updateHistory('eng-param');
        
        // Загружаем самолеты
        const sel = document.getElementById('param-ac');
        sel.innerHTML = '<option value="">Select A/C...</option>';
        
        try {
            // Пробуем новый API
            const res = await fetch('/api/dashboard/aircraft-details');
            if (res.ok) {
                const aircrafts = await res.json();
                console.log('Loaded aircraft:', aircrafts);
                
                for (const ac of aircrafts) {
                    sel.innerHTML += `<option value="${ac.tail_number}">${ac.tail_number}</option>`;
                }
            } else {
                throw new Error('API failed');
            }
        } catch (err) {
            console.error('Error loading aircraft, using fallback:', err);
            // Fallback - всегда показываем самолеты
            sel.innerHTML = `
                <option value="">Select A/C...</option>
                <option value="ER-BAT">ER-BAT</option>
                <option value="ER-BAR">ER-BAR</option>
                <option value="ER-BAQ">ER-BAQ</option>
            `;
        }
        
        // Дата сегодня
        document.getElementById('param-date').valueAsDate = new Date();
    }

    async function loadEnginePositions() {
        const aircraft = document.getElementById('param-ac').value;
        const posSelect = document.getElementById('param-position');
        const engineSN = document.getElementById('param-engine-sn');
        
        if (!aircraft) {
            posSelect.value = '';
            engineSN.value = '';
            posSelect.onchange = null;
            return;
        }
        
        // Загружаем установленные двигатели для выбранного самолета
        try {
            const res = await fetch('/api/engines');
            if (!res.ok) throw new Error('Failed to fetch engines');
            
            const allEngines = await res.json();
            console.log('All engines:', allEngines);
            
            // Фильтруем только установленные на выбранном самолете
            const installedEngines = allEngines.filter(e => 
                e.aircraft === aircraft && e.status === 'INSTALLED'
            );
            
            console.log(`Installed engines on ${aircraft}:`, installedEngines);
            
            // Сохраняем для автозаполнения S/N
            currentEnginesByAircraft[aircraft] = installedEngines;
            
            // Если нет установленных двигателей
            if (installedEngines.length === 0) {
                engineSN.value = 'No engines installed on this aircraft';
                alert(`На самолете ${aircraft} нет установленных двигателей. Сначала установите двигатели через Installation.`);
                return;
            }
            
            // Автоматически заполним S/N при выборе позиции
            posSelect.onchange = () => {
                const pos = parseInt(posSelect.value);
                const engine = installedEngines.find(e => e.position === pos);
                if (engine) {
                    engineSN.value = engine.current_sn;
                    console.log(`Selected: Position ${pos} - ${engine.current_sn}`);
                } else {
                    engineSN.value = 'No engine on this position';
                }
            };
            
            // Если выбрана позиция - сразу покажем S/N
            if (posSelect.value) {
                posSelect.onchange();
            }
            
        } catch (err) {
            console.error('Error loading engines:', err);
            engineSN.value = 'Error loading engine data';
        }
    }

    // Логика скрытия полей при смене типа
    function toggleParamFields(section) { // section = 'to' или 'cr'
        const type = document.getElementById(`param-type-${section}`).value;
        const fieldsDiv = document.getElementById(`fields-${section}`);
        
        // Если в секции Takeoff выбрали Cruise -> скрываем поля (или наоборот, как вам удобно)
        // В вашем описании: "если выбираем одно, то на след строке будет то, что не выбрано"
        // Реализуем простую логику: если тип совпадает с названием секции - показываем, нет - скрываем/меняем
        
        // Для простоты: поля всегда видны, просто меняется заголовок или логика сохранения
        // Но если вы хотите прятать:
        /*
        if ( (section === 'to' && type === 'Cruise') || (section === 'cr' && type === 'Takeoff') ) {
             fieldsDiv.style.opacity = '0.5'; // Делаем полупрозрачным
             fieldsDiv.style.pointerEvents = 'none'; // Запрещаем ввод
        } else {
             fieldsDiv.style.opacity = '1';
             fieldsDiv.style.pointerEvents = 'auto';
        }
        */
    }

    let _engParamSubmitting = false;
    async function submitEngParams() {
        if (_engParamSubmitting) { return; }
        _engParamSubmitting = true;
        const saveBtn = document.querySelector('#tab-eng-param-entry .btn.btn-primary.px-4');
        if (saveBtn) { saveBtn.disabled = true; saveBtn.dataset._orig = saveBtn.innerHTML; saveBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Saving...'; }
        console.log('=== submitEngParams called ===');
        console.log('Function exists and running...');
        
        const date = document.getElementById('param-date').value;
        const ac = document.getElementById('param-ac').value;
        const position = document.getElementById('param-position').value;
        
        console.log('Form values:', { date, ac, position });
        
        if(!date || !ac || !position) { 
            showErrorNotification("Please fill in all required fields: Date, Aircraft, and Position");
            return; 
        }

        // Находим двигатель на этой позиции
        try {
            console.log('Fetching engines from /api/engines...');
            const res = await fetch(`/api/engines`);
            
            if (!res.ok) {
                throw new Error(`API error: ${res.status} ${res.statusText}`);
            }
            
            const allEngines = await res.json();
            console.log('All engines:', allEngines);
            console.log('Looking for:', { ac, position: parseInt(position), status: 'INSTALLED' });
            
            const engine = allEngines.find(e => 
                e.aircraft === ac && 
                e.position === parseInt(position) && 
                e.status === 'INSTALLED'
            );
            
            console.log('Found engine:', engine);
            
            if (!engine) {
                showErrorNotification(`No engine installed on ${ac} position ${position}! Please install an engine first via Installation form.`);
                return;
            }

            // Собираем данные параметров
            const params = {
                engine_id: engine.id,
                date: date,  // Передаем дату
                n1_takeoff: parseFloat(document.getElementById('to-n1').value) || null,
                n2_takeoff: parseFloat(document.getElementById('to-n2').value) || null,
                egt_takeoff: parseFloat(document.getElementById('to-egt').value) || null,
                n1_cruise: parseFloat(document.getElementById('cr-n1').value) || null,
                n2_cruise: parseFloat(document.getElementById('cr-n2').value) || null,
                egt_cruise: parseFloat(document.getElementById('cr-egt').value) || null
            };
            
            console.log('Parameters to save:', params);

            // Отправляем на backend
            console.log('Sending to /api/engines/parameters...');
            const saveRes = await fetch('/api/engines/parameters', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(params)
            });

            console.log('Save response status:', saveRes.status);

            if (saveRes.ok) {
                const result = await saveRes.json();
                console.log('Save successful:', result);
                
                // Показываем красивое уведомление
                showSuccessNotification(`Parameters for engine ${engine.current_sn} (${ac} Position ${position}) have been saved successfully!`);
                
                // Очищаем форму
                document.getElementById('form-eng-param').reset();
                document.getElementById('param-date').valueAsDate = new Date();
                
                // Обновляем историю параметров
                await loadParameterHistory();
            } else {
                const err = await saveRes.text();
                console.error('Save failed:', err);
                showErrorNotification(`Failed to save parameters: ${err}`);
            }
            
        } catch (err) {
            console.error('Error in submitEngParams:', err);
            showErrorNotification(`Error saving parameters: ${err.message}`);
        } finally {
            _engParamSubmitting = false;
            if (saveBtn) { saveBtn.disabled = false; saveBtn.innerHTML = saveBtn.dataset._orig || 'Save Parameters'; }
        }
    }
    // === UTILIZATION PARAMETERS LOGIC ===
    let utilizationParamsData = []; // Локальное хранилище данных

    async function openUtilizationParamView() {
        hideAllViews();
        document.getElementById('view-utilization-param').style.display = 'block';
        updateHistory('utilization-param');
        
        // Устанавливаем сегодняшнюю дату по умолчанию
        document.getElementById('util-param-date').valueAsDate = new Date();
        
        // Загружаем список самолетов
        await loadAircraftDropdown();
    }
    
    async function loadAircraftDropdown() {
        try {
            const response = await fetch('/api/fleet');
            if (!response.ok) throw new Error('Failed to load fleet');
            
            const fleet = await response.json();
            const dropdown = document.getElementById('util-param-ac');
            
            // Сохраняем текущее значение
            const currentValue = dropdown.value;
            
            // Очищаем и заполняем заново
            dropdown.innerHTML = '<option value="">Выберите самолет...</option>';
            
            fleet.forEach(aircraft => {
                const option = document.createElement('option');
                option.value = aircraft.tail_number;
                option.textContent = aircraft.tail_number;
                dropdown.appendChild(option);
            });
            
            // Восстанавливаем значение если оно было
            if (currentValue) {
                dropdown.value = currentValue;
            }
        } catch (err) {
            console.error('Error loading aircraft dropdown:', err);
        }
    }

    function switchUtilParamTab(tab) {
        document.getElementById('tab-util-param-entry').style.display = tab === 'entry' ? 'block' : 'none';
        document.getElementById('tab-util-param-history').style.display = tab === 'history' ? 'block' : 'none';
        document.getElementById('tab-util-param-entry-btn').className = tab === 'entry' ? 'nav-link active' : 'nav-link';
        document.getElementById('tab-util-param-history-btn').className = tab === 'history' ? 'nav-link active' : 'nav-link';
        if (tab === 'history') loadUtilParamHistory();
    }

    function togglePeriodFields() {
        const checkbox = document.getElementById('util-param-period');
        const dateFrom = document.getElementById('util-param-date-from');
        const dateTo = document.getElementById('util-param-date-to');
        
        if (checkbox.checked) {
            dateFrom.disabled = false;
            dateTo.disabled = false;
        } else {
            dateFrom.disabled = true;
            dateTo.disabled = true;
            dateFrom.value = '';
            dateTo.value = '';
        }
    }

    let _utilParamSubmitting = false;
    async function submitUtilParams() {
        if (_utilParamSubmitting) { return; }
        _utilParamSubmitting = true;
        const saveBtn = document.querySelector('#tab-util-param-entry .btn.btn-primary.px-4');
        if (saveBtn) { saveBtn.disabled = true; saveBtn.dataset._orig = saveBtn.innerHTML; saveBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Saving...'; }
        const date = document.getElementById('util-param-date').value;
        const aircraft = document.getElementById('util-param-ac').value;
        const ttsn = document.getElementById('util-param-ttsn').value;
        const tcsn = document.getElementById('util-param-tcsn').value;
        const periodChecked = document.getElementById('util-param-period').checked;
        const dateFrom = document.getElementById('util-param-date-from').value;
        const dateTo = document.getElementById('util-param-date-to').value;

        if (!date || !aircraft || !ttsn || !tcsn) {
            showErrorNotification('Пожалуйста, заполните все обязательные поля: Дата, Самолет, TTSN и TCSN');
            return;
        }

        if (periodChecked && (!dateFrom || !dateTo)) {
            showErrorNotification('При выборе периода укажите Date From и Date To');
            return;
        }

        const data = {
            date: date,
            aircraft: aircraft,
            ttsn: parseFloat(ttsn),
            tcsn: parseInt(tcsn),
            period: periodChecked,
            date_from: periodChecked ? dateFrom : null,
            date_to: periodChecked ? dateTo : null
        };

        // Сохраняем в базу данных через API
        try {
            const response = await fetch('/api/utilization-parameters', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            });
            
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.detail || 'Failed to save');
            }
            
            showSuccessNotification('Данные по Utilization Parameters успешно сохранены в базу данных!');
            
            // Очищаем форму
            document.getElementById('form-util-param').reset();
            document.getElementById('util-param-date').valueAsDate = new Date();
            
            // Обновляем историю
            await loadUtilParamHistory();
            // Обновляем дашборд, чтобы новые TTSN/TCSN применились
            if (typeof loadDashboardData === 'function') {
                await loadDashboardData();
            }
        } catch (err) {
            console.error('Error saving utilization parameters:', err);
            showErrorNotification('Ошибка сохранения: ' + err.message);
        } finally {
            _utilParamSubmitting = false;
            if (saveBtn) { saveBtn.disabled = false; saveBtn.innerHTML = saveBtn.dataset._orig || 'Сохранить'; }
        }
    }

    async function loadUtilParamHistory() {
        const tbody = document.getElementById('util-param-history-body');
        tbody.innerHTML = '<tr><td colspan="9" class="text-muted">Загрузка...</td></tr>';
        
        try {
            const response = await fetch('/api/utilization-parameters');
            if (!response.ok) {
                throw new Error('Failed to load data');
            }
            
            const data = await response.json();
            tbody.innerHTML = '';
            
            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="text-muted">Нет данных</td></tr>';
                return;
            }

        data.forEach((item, index) => {
            const dateStr = new Date(item.date).toLocaleDateString('ru-RU');
            const createdStr = new Date(item.created_at).toLocaleString('ru-RU');
            const periodStr = item.period ? 'Да' : 'Нет';
            const dateFromStr = item.date_from ? new Date(item.date_from).toLocaleDateString('ru-RU') : '-';
            const dateToStr = item.date_to ? new Date(item.date_to).toLocaleDateString('ru-RU') : '-';

            const row = document.createElement('tr');
            row.setAttribute('data-id', item.id);
            row.setAttribute('data-user', item.user || item.created_by || '');
            row.innerHTML = `
                <td class="delete-col-util-param" style="display: none;">
                    <button class="btn btn-sm btn-danger" onclick="deleteUtilParamRecord(${item.id})" title="Delete">
                        <i class="bi bi-trash"></i>
                    </button>
                </td>
                <td>${dateStr}</td>
                <td>${item.aircraft}</td>
                <td>${item.ttsn}</td>
                <td>${item.tcsn}</td>
                <td>${periodStr}</td>
                <td>${dateFromStr}</td>
                <td>${dateToStr}</td>
                <td>${createdStr}</td>
            `;
            tbody.appendChild(row);
        });
        } catch (err) {
            console.error('Error loading utilization parameters:', err);
            tbody.innerHTML = '<tr><td colspan="9" class="text-danger">Ошибка загрузки данных</td></tr>';
        }
        attachAllTableResizers();
    }
    
    async function deleteUtilParamRecord(id) {
        if (!confirm('Удалить эту запись из базы данных?')) return;
        
        try {
            const response = await fetch(`/api/utilization-parameters/${id}`, {
                method: 'DELETE'
            });
            
            if (!response.ok) {
                throw new Error('Failed to delete');
            }
            
            showSuccessNotification('Запись удалена из базы данных');
            await loadUtilParamHistory();
            if (typeof loadDashboardData === 'function') {
                await loadDashboardData();
            }
        } catch (err) {
            console.error('Error deleting record:', err);
            showErrorNotification('Ошибка удаления: ' + err.message);
        }
    }

    // === UTILIZATION HISTORY MODAL ===
    async function openUtilizationHistoryModal(tailNumber) {
        const modal = document.getElementById('utilization-history-modal');
        modal.style.display = 'flex';
        
        const tbody = document.getElementById('utilization-history-modal-body');
        tbody.innerHTML = '<tr><td colspan="8" class="text-muted">Загрузка...</td></tr>';
        
        try {
            const response = await fetch('/api/utilization-parameters');
            if (!response.ok) throw new Error('Failed to load data');
            
            const allData = await response.json();
            const filtered = allData.filter(item => item.aircraft === tailNumber);
            
            tbody.innerHTML = '';
            if (filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-muted">Нет данных для этого борта</td></tr>';
                return;
            }
            
            filtered.forEach(item => {
                const dateStr = new Date(item.date).toLocaleDateString('ru-RU');
                const createdStr = new Date(item.created_at).toLocaleString('ru-RU');
                const periodStr = item.period ? 'Да' : 'Нет';
                const dateFromStr = item.date_from ? new Date(item.date_from).toLocaleDateString('ru-RU') : '-';
                const dateToStr = item.date_to ? new Date(item.date_to).toLocaleDateString('ru-RU') : '-';
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${dateStr}</td>
                    <td>${item.aircraft}</td>
                    <td>${item.ttsn}</td>
                    <td>${item.tcsn}</td>
                    <td>${periodStr}</td>
                    <td>${dateFromStr}</td>
                    <td>${dateToStr}</td>
                    <td>${createdStr}</td>
                `;
                tbody.appendChild(row);
            });
        } catch (err) {
            console.error('Error loading modal history:', err);
            tbody.innerHTML = '<tr><td colspan="8" class="text-danger">Ошибка загрузки</td></tr>';
        }
    }

    function closeUtilizationHistoryModal() {
        document.getElementById('utilization-history-modal').style.display = 'none';
    }

    // Close modal when clicking outside
    document.addEventListener('click', function(event) {
        const modal = document.getElementById('utilization-history-modal');
        if (modal && event.target === modal) {
            closeUtilizationHistoryModal();
        }
    });

    // Запускаем функцию после загрузки страницы
document.addEventListener("DOMContentLoaded", () => {
    makeElementDraggable(document.getElementById("engine-btn-wrapper"));

    const reportsState = localStorage.getItem('reports-menu-open');
    if (reportsState === 'true') {
        toggleReportsMenu(true);
    } else if (reportsState === 'false') {
        toggleReportsMenu(false);
    }

    const actionsState = localStorage.getItem('actions-menu-open');
    if (actionsState === 'false') {
        toggleActionsMenu(false);
    } else if (actionsState === 'true') {
        toggleActionsMenu(true);
    }

    const logisticsState = localStorage.getItem('logistics-menu-open');
    if (logisticsState === 'true') {
        toggleLogisticsMenu(true);
    } else if (logisticsState === 'false') {
        toggleLogisticsMenu(false);
    }
});

function makeElementDraggable(elmnt) {
    if (!elmnt) return;

    let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
    let isDragging = false; // Флаг: мы тащим или просто кликаем?

    // Обработчик нажатия кнопки мыши
    elmnt.onmousedown = dragMouseDown;

    function dragMouseDown(e) {
        e = e || window.event;
        e.preventDefault();
        
        // Получаем позицию курсора при старте
        pos3 = e.clientX;
        pos4 = e.clientY;
        
        // Считаем, что пока это не драг, а подготовка
        isDragging = false;
        elmnt.dataset.dragged = 'false';

        document.onmouseup = closeDragElement;
        document.onmousemove = elementDrag;
    }

    function elementDrag(e) {
        e = e || window.event;
        e.preventDefault();
        
        // Если мышь сдвинулась, ставим флаг "Это перетаскивание!"
        isDragging = true;
        elmnt.dataset.dragged = 'true';

        // Вычисляем новую позицию
        pos1 = pos3 - e.clientX;
        pos2 = pos4 - e.clientY;
        pos3 = e.clientX;
        pos4 = e.clientY;

        // Устанавливаем новые координаты элементу
        // (Убираем transform, чтобы он не мешал точному позиционированию после первого движения)
        elmnt.style.transform = "none"; 
        elmnt.style.top = (elmnt.offsetTop - pos2) + "px";
        elmnt.style.left = (elmnt.offsetLeft - pos1) + "px";
    }

    function closeDragElement() {
        // Остановка перемещения при отпускании кнопки
        document.onmouseup = null;
        document.onmousemove = null;

        if (elmnt.dataset.dragged === 'true') {
            setTimeout(() => {
                elmnt.dataset.dragged = 'false';
            }, 200);
        }
    }
}

function ensureEngineVideosPlaying() {
    document.querySelectorAll('.engine-video').forEach(video => {
        if (!video) return;

        const attemptPlay = () => {
            try {
                video.load();
            } catch (err) {
                console.warn('Video load issue:', err);
            }

            video.play().catch(() => {
                // Autoplay might still be blocked; we can retry on user interaction
                const handler = () => {
                    video.play().finally(() => {
                        document.removeEventListener('click', handler);
                    });
                };
                document.addEventListener('click', handler, { once: true });
            });
        };

        if (video.readyState >= 2) {
            attemptPlay();
        } else {
            video.addEventListener('loadeddata', attemptPlay, { once: true });
        }
    });
}
// --- ATLB FILTER LOGIC ---
let fullAtlbData = []; // Глобальная переменная для данных ATLB

async function loadAtlbHistory() {
    try {
        const res = await fetch('/api/history/ATLB' + noCache());
        if (!res.ok) {
            throw new Error('Failed to load ATLB history');
        }
        const data = await res.json();
        fullAtlbData = Array.isArray(data) ? data : [];
        initAtlbFilters();
        renderAtlbTable(fullAtlbData);
    } catch (err) {
        console.error('Failed to load ATLB history', err);
        const tb = document.getElementById('atlb-history-body');
        tb.innerHTML = '<tr><td colspan="24" class="text-danger">Error loading ATLB history</td></tr>';
    }
}

function toCellValue(value, dashOnEmpty = true) {
    if (value === undefined || value === null) {
        return dashOnEmpty ? '-' : '';
    }
    const str = String(value).trim();
    const normalized = str.toLowerCase();
    if (!str || normalized === 'undefined' || normalized === 'null') {
        return dashOnEmpty ? '-' : '';
    }
    return escapeHtml(str);
}

function renderAtlbTable(data) {
    const tb = document.getElementById('atlb-history-body');
    tb.innerHTML = '';

    if (!Array.isArray(data) || data.length === 0) {
        tb.innerHTML = '<tr><td colspan="24" class="text-muted">No ATLB records yet</td></tr>';
        return;
    }

    data.forEach(r => {
        const maintenanceLabel = toCellValue(r.maintenance || (r.maintenance_only ? 'Maintenance' : ''), true);
        tb.innerHTML += `
            <tr>
                <td>${toCellValue(r.date)}</td>
                <td>${toCellValue(r.tail_number)}</td>
                <td class="fw-bold text-primary">${toCellValue(r.atlb_sheet)}</td>
                <td>${toCellValue(r.flight_leg)}</td>
                <td>${toCellValue(r.block_out)}</td>
                <td>${toCellValue(r.block_in)}</td>
                <td>${toCellValue(r.block_time)}</td>
                <td>${toCellValue(r.flight_off)}</td>
                <td>${toCellValue(r.flight_on)}</td>
                <td class="fw-bold">${toCellValue(r.flight_time_text)}</td>
                <td>${toCellValue(r.cycles ?? '')}</td>
                <td>${toCellValue(r.total_ttsn)}</td>
                <td>${toCellValue(r.total_tcsn)}</td>
                <td>${formatLiftValue(r.oil_1)}</td>
                <td>${formatLiftValue(r.oil_2)}</td>
                <td>${formatLiftValue(r.oil_3)}</td>
                <td>${formatLiftValue(r.oil_4)}</td>
                <td>${formatLiftValue(r.oil_apu)}</td>
                <td>${formatLiftValue(r.hyd_1)}</td>
                <td>${formatLiftValue(r.hyd_2)}</td>
                <td>${formatLiftValue(r.hyd_3)}</td>
                <td>${formatLiftValue(r.hyd_4)}</td>
                <td>${maintenanceLabel}</td>
                <td>${toCellValue(r.user)}</td>
            </tr>
        `;
    });
}

function initAtlbFilters() {
    const columns = [
        { key: 'date', htmlId: 'date' },
        { key: 'tail_number', htmlId: 'tail' },
        { key: 'atlb_sheet', htmlId: 'ref' },
        { key: 'flight_leg', htmlId: 'route' },
        { key: 'cycles', htmlId: 'cycles' },
        { key: 'user', htmlId: 'user' }
    ];

    columns.forEach(({ key: colKey, htmlId }) => {
        const uniqueValues = [...new Set(fullAtlbData.map(item => toCellValue(item[colKey] ?? '-', true)))].sort();

        const menu = document.getElementById(`filter-menu-atlb-${htmlId}`);
        if(!menu) return;

        // Генерируем HTML меню
        // 1. Добавляем поле поиска
        let html = `
            <div class="p-2">
                <input type="text" class="form-control form-control-sm filter-search-input" placeholder="Search..." autofocus>
            </div>
            <div class="filter-checkbox-item">
                <input type="checkbox" class="filter-select-all-atlb" checked id="all-atlb-${colKey}">
                <label for="all-atlb-${colKey}" class="fw-bold text-primary ms-2">Select All</label>
            </div>
            <hr class="my-1">
            <div class="filter-list-container" style="max-height: 200px; overflow-y: auto;">
        `;

        // 2. Генерируем список значений
        uniqueValues.forEach(val => {
            // Очищаем значение для использования в value
            const safeVal = String(val).replace(/"/g, '&quot;');
            html += `
                <div class="filter-checkbox-item filter-item-row">
                    <input type="checkbox" class="filter-val-atlb" data-col="${colKey}" value="${safeVal}" checked>
                    <span class="ms-2 filter-text">${val}</span>
                </div>
            `;
        });

        html += `</div>`; // Закрываем контейнер списка

        menu.innerHTML = html;
        
        // Останавливаем закрытие меню при клике
        menu.onclick = (e) => e.stopPropagation();

        // --- ЛОГИКА ПОИСКА ---
        const searchInput = menu.querySelector('.filter-search-input');
        const listContainer = menu.querySelector('.filter-list-container');
        const itemRows = listContainer.querySelectorAll('.filter-item-row');

        searchInput.oninput = function() {
            const searchText = this.value.toLowerCase();
            itemRows.forEach(row => {
                const text = row.querySelector('.filter-text').innerText.toLowerCase();
                if (text.includes(searchText)) {
                    row.style.display = 'flex';
                } else {
                    row.style.display = 'none';
                }
            });
        };

        // --- ЛОГИКА ЧЕКБОКСОВ ---
        const selectAllCb = menu.querySelector('.filter-select-all-atlb');
        const valCbs = menu.querySelectorAll('.filter-val-atlb');

        selectAllCb.onchange = function() {
            // При клике на "Select All" меняем состояние только ВИДИМЫХ чекбоксов (если работает поиск)
            // Или всех, если хотите поведение как в Excel (обычно Excel выбирает только отфильтрованное)
            // Для простоты пока меняем все:
            valCbs.forEach(cb => {
                // Если строка скрыта поиском, не трогаем её (опционально)
                // Но классический вариант - выбрать/снять всё:
                cb.checked = this.checked;
            });
            applyAtlbFilters();
        };

        valCbs.forEach(cb => {
            cb.onchange = function() {
                if (!this.checked) selectAllCb.checked = false;
                // Проверяем, все ли выбраны
                if (Array.from(valCbs).every(c => c.checked)) selectAllCb.checked = true;
                applyAtlbFilters();
            };
        });
    });
}


function applyAtlbFilters() {
    const columns = [
        { key: 'date', htmlId: 'date' },
        { key: 'tail_number', htmlId: 'tail' },
        { key: 'atlb_sheet', htmlId: 'ref' },
        { key: 'flight_leg', htmlId: 'route' },
        { key: 'cycles', htmlId: 'cycles' },
        { key: 'user', htmlId: 'user' }
    ];

    let filteredData = fullAtlbData;

    columns.forEach(({ key: colKey, htmlId }) => {
        const menu = document.getElementById(`filter-menu-atlb-${htmlId}`);
        if(!menu) return;

        const checkedBoxes = menu.querySelectorAll('.filter-val-atlb:checked');
        const checkedValues = Array.from(checkedBoxes).map(cb => cb.value);
        
        // Фильтрация
        filteredData = filteredData.filter(row => {
            const val = toCellValue(row[colKey] || '-', true);
            return checkedValues.includes(val);
        });

        // Подсветка иконки
        const allBoxes = menu.querySelectorAll('.filter-val-atlb');
        const icon = document.getElementById(`filter-icon-atlb-${htmlId}`);
        if(checkedBoxes.length < allBoxes.length) {
            icon.classList.add('text-primary');
            icon.classList.remove('text-muted');
        } else {
            icon.classList.remove('text-primary');
        }
    });

    renderAtlbTable(filteredData);
    attachAllTableResizers();
}
    // Функция фильтрации для таблицы Installation
    function filterInstallTable() {
        const input = document.getElementById("inst-search-input");
        const filter = input.value.toUpperCase();
        const table = document.getElementById("install-history-body");
        const tr = table.getElementsByTagName("tr");

        for (let i = 0; i < tr.length; i++) {
            if(tr[i].cells.length < 2) continue;
            let textContent = tr[i].textContent || tr[i].innerText;
            if (textContent.toUpperCase().indexOf(filter) > -1) {
                tr[i].style.display = "";
            } else {
                tr[i].style.display = "none";
            }
        }
    }

</script>

<!-- === AUTHENTICATION & USER MANAGEMENT JAVASCRIPT === -->
<script>
// === GLOBAL STATE ===
let currentUser = null;
let editingUserId = null;
let userCache = [];

// === AUTHENTICATION FUNCTIONS ===
async function handleLogin(event) {
    event.preventDefault();
    const username = document.getElementById('login-username').value;
    const password = document.getElementById('login-password').value;
    console.log('🔐 Login attempt:', username);
    try {
        const response = await fetch('/api/auth/login', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({username, password})
        });
        console.log('📡 Response status:', response.status);
        const data = await response.json();
        console.log('📦 Response data:', data);
        if (!response.ok) throw new Error(data.detail || 'Login failed');
        currentUser = data;
        console.log('✅ Login success:', currentUser);
        sessionStorage.setItem('currentUser', JSON.stringify(currentUser));
        const modal = document.getElementById('login-modal');
        if (modal) {
            modal.style.display = 'none';
            console.log('🚪 Modal hidden');
        }
        initializeUserInterface();
        if (typeof openDashboardView === 'function') {
            console.log('📊 Opening dashboard');
            openDashboardView();
        }
        if (typeof loadDashboardData === 'function') {
            console.log('📈 Loading dashboard data');
            loadDashboardData();
        }
    } catch (error) {
        console.error('❌ Login error:', error.message);
        const errorDiv = document.getElementById('login-error');
        if (errorDiv) {
            errorDiv.textContent = error.message;
            errorDiv.style.display = 'block';
        }
    }
}

function logout() {
    if (confirm('Are you sure you want to logout?')) {
        currentUser = null;
        sessionStorage.removeItem('currentUser');
        location.reload();
    }
}

function initializeUserInterface() {
    if (!currentUser) {
        console.warn('⚠️ currentUser is null');
        return;
    }
    console.log('👤 Initializing UI for:', currentUser.username, 'role:', currentUser.role);
    const initials = (currentUser.first_name[0] + currentUser.last_name[0]).toUpperCase();
    const userInitials = document.getElementById('user-initials');
    if (userInitials) userInitials.textContent = initials;
    const profileAvatar = document.getElementById('profile-avatar');
    if (profileAvatar) profileAvatar.textContent = initials;
    const profileName = document.getElementById('profile-name');
    if (profileName) profileName.textContent = `${currentUser.first_name} ${currentUser.last_name}`;
    const profilePosition = document.getElementById('profile-position');
    if (profilePosition) profilePosition.textContent = currentUser.position || 'No position';
    const profileRole = document.getElementById('profile-role');
    if (profileRole) profileRole.textContent = currentUser.role;
    if (currentUser.role === 'admin') {
        const btn = document.getElementById('add-user-btn');
        if (btn) {
            btn.style.display = 'flex';
            btn.style.visibility = 'visible';
            console.log('✅ Users button shown (admin)');
        }
    }
    // Apply role-based permissions to UI
    applyRolePermissions();
    loadNotifications();
    updateNotificationCount();
    
    console.log('✨ UI initialization complete');
}

// === ROLE HELPERS & PERMISSIONS ===
function isAdmin() { return currentUser && currentUser.role === 'admin'; }
function isUser() { return currentUser && currentUser.role === 'user'; }
function isViewer() { return currentUser && currentUser.role === 'viewer'; }

function applyRolePermissions() {
    // Hide Users button for non-admins (safety)
    const usersBtn = document.getElementById('add-user-btn');
    if (!isAdmin() && usersBtn) usersBtn.style.display = 'none';

    if (isViewer()) {
        // Read-only: disable most inputs/buttons, but allow dashboard/status & engine ring interactions
        const scope = document.getElementById('page-content-wrapper') || document.body;
        scope.querySelectorAll('input, select, textarea, button').forEach(el => {
            const allowIds = ['menu-toggle','notifications-btn','user-profile-btn','settings-btn','engine-toggle-btn'];
            const allowClasses = ['btn-dashboard','engine-menu-item'];
            const isAllowed = allowIds.includes(el.id) || allowClasses.some(cls => el.classList.contains(cls));
            if (isAllowed) return; // allow viewer to open status tables and engine quick menu
            if (el.closest('#login-modal')) return;
            el.disabled = true;
            el.style.pointerEvents = 'none';
            el.classList.add('disabled');
        });
    } else if (isUser()) {
        // Users can create/edit but cannot delete or manage users
        if (usersBtn) usersBtn.style.display = 'none';
        // Soften/disable delete buttons
        hideDeleteControls();
        // Intercept DELETE requests to backend
        interceptDeletesForNonAdmins();
    }
}

function hideDeleteControls() {
    document.querySelectorAll('.btn-danger, .bi-trash').forEach(el => {
        if (el.tagName === 'BUTTON') {
            el.disabled = true;
            el.style.pointerEvents = 'none';
            el.style.opacity = '0.5';
            el.title = 'Недоступно для вашей роли';
        } else {
            el.style.opacity = '0.4';
        }
    });
}

let fetchWrapped = false;
function interceptDeletesForNonAdmins() {
    if (fetchWrapped) return;
    const origFetch = window.fetch.bind(window);
    window.fetch = async (...args) => {
        try {
            const [url, opts] = args;
            if (!isAdmin() && opts && (opts.method || 'GET').toUpperCase() === 'DELETE') {
                showErrorNotification('Ваша роль не позволяет удалять записи');
                return new Response(null, { status: 403, statusText: 'Forbidden' });
            }
        } catch (e) { /* noop */ }
        return origFetch(...args);
    };
    fetchWrapped = true;
}

// === PROFILE FUNCTIONS ===
document.getElementById('user-profile-btn')?.addEventListener('click', () => {
    const dropdown = document.getElementById('profile-dropdown');
    dropdown.classList.toggle('show');
    document.getElementById('notifications-panel').classList.remove('show');
});

// === SETTINGS FUNCTIONS ===
document.getElementById('settings-btn')?.addEventListener('click', () => {
    const modal = new bootstrap.Modal(document.getElementById('settings-modal'));
    modal.show();
    populateDashboardEditList();
    populatePartsSettingsForm();
    updateRecentActionsSummary();
});

document.getElementById('settings-modal')?.addEventListener('hidden.bs.modal', () => {
    // Reset any unsaved tweaks back to persisted values
    applyPartsSettings();
    populatePartsSettingsForm();
});

const partsSettingsDefaults = {
    storeTitle: 'Store Balance',
    logisticsTitle: 'Parts Logistics',
    cardHeight: 200,
    cardWidth: 50,
    customCards: []
};
let partsSettings = { ...partsSettingsDefaults };

const partsCardTargets = {
    'parts-modal': {
        label: 'Parts Logistics modal',
        icon: 'bi-arrow-left-right',
        run: () => openPartsLogisticsModal()
    },
    'parts-view': {
        label: 'Parts Logistics table',
        icon: 'bi-arrow-left-right',
        run: () => { openPartsView(); switchPartsTab('list'); }
    },
    'parts-add': {
        label: 'Parts Logistics – Add tab',
        icon: 'bi-plus-circle',
        run: () => { openPartsView(); switchPartsTab('add'); }
    },
    'store-modal': {
        label: 'Store Balance modal',
        icon: 'bi-box-seam',
        run: () => openStoreBalanceModal()
    },
    'store-view': {
        label: 'Store Balance table',
        icon: 'bi-box-seam',
        run: () => { openStoreBalanceView(); switchStoreBalanceTab('list'); }
    },
    'store-add': {
        label: 'Store Balance – Add tab',
        icon: 'bi-plus-circle',
        run: () => { openStoreBalanceView(); switchStoreBalanceTab('add'); }
    }
};

function clampNumber(val, min, max) {
    if (!Number.isFinite(val)) return min;
    return Math.min(max, Math.max(min, val));
}

function loadPartsSettings() {
    try {
        const raw = localStorage.getItem('parts-settings');
        const parsed = raw ? JSON.parse(raw) : {};
        const parsedHeight = Number.parseInt(parsed.cardHeight, 10);
        const parsedWidth = Number.parseInt(parsed.cardWidth, 10);
        const customCards = Array.isArray(parsed.customCards) ? parsed.customCards : [];
        partsSettings = {
            storeTitle: parsed.storeTitle || partsSettingsDefaults.storeTitle,
            logisticsTitle: parsed.logisticsTitle || partsSettingsDefaults.logisticsTitle,
            cardHeight: Number.isFinite(parsedHeight) ? clampNumber(parsedHeight, 160, 260) : partsSettingsDefaults.cardHeight,
            cardWidth: Number.isFinite(parsedWidth) ? clampNumber(parsedWidth, 35, 100) : partsSettingsDefaults.cardWidth,
            customCards: customCards.map(normalizeCustomCard)
        };
    } catch (_e) {
        partsSettings = { ...partsSettingsDefaults };
    }
}

function normalizeCustomCard(card, idx) {
    return {
        id: card?.id || `custom-${idx}`,
        title: (card?.title || 'Custom Card').toString().trim() || 'Custom Card',
        color: card?.color || '#2563eb',
        target: partsCardTargets[card?.target] ? card.target : 'parts-modal',
        width: clampNumber(Number.parseInt(card?.width, 10) || partsSettingsDefaults.cardWidth, 35, 100)
    };
}

function persistPartsSettings() {
    localStorage.setItem('parts-settings', JSON.stringify(partsSettings));
}

function getPartsCardsConfig() {
    const baseCards = [
        {
            id: 'store',
            title: partsSettings.storeTitle,
            subtitle: 'View current inventory & stock',
            color: '#667eea',
            target: 'store-modal',
            icon: 'bi-box-seam',
            countId: 'store-balance-count',
            width: partsSettings.cardWidth
        },
        {
            id: 'logistics',
            title: partsSettings.logisticsTitle,
            subtitle: 'Track all parts movements',
            color: '#11998e',
            target: 'parts-modal',
            icon: 'bi-arrow-left-right',
            countId: 'parts-logistics-count',
            width: partsSettings.cardWidth
        }
    ];
    const customCards = (partsSettings.customCards || []).map((card, idx) => normalizeCustomCard(card, idx + 1));
    return [...baseCards, ...customCards];
}

function renderPartsCards() {
    const container = document.getElementById('parts-cards-container');
    if (!container) return;
    container.innerHTML = '';

    getPartsCardsConfig().forEach(card => {
        const wrapper = document.createElement('div');
        wrapper.className = 'parts-card-wrapper';
        const width = clampNumber(card.width || partsSettings.cardWidth, 35, 100);
        wrapper.style.flex = `0 0 calc(${width}% - 1rem)`;
        wrapper.style.minWidth = '240px';

        const cardEl = document.createElement('div');
        cardEl.className = 'parts-card-3d';
        cardEl.style.background = `linear-gradient(135deg, ${card.color} 0%, ${card.color} 90%)`;
        cardEl.style.boxShadow = '0 10px 40px rgba(0,0,0,0.18)';
        cardEl.onclick = () => handlePartsCardClick(card.target);

        const iconEl = document.createElement('div');
        iconEl.className = 'parts-card-icon';
        iconEl.innerHTML = `<i class="bi ${card.icon || 'bi-stars'}"></i>`;

        const contentEl = document.createElement('div');
        contentEl.className = 'parts-card-content';
        contentEl.innerHTML = `
            <div class="parts-card-title" data-parts-title="${card.id === 'store' ? 'store' : card.id === 'logistics' ? 'logistics' : ''}">${card.title}</div>
            <div class="parts-card-subtitle">${card.subtitle || partsCardTargets[card.target]?.label || 'Open view'}</div>
        `;

        const countEl = document.createElement('div');
        countEl.className = 'parts-card-count';
        if (card.countId) countEl.id = card.countId;
        countEl.textContent = '0';

        cardEl.appendChild(iconEl);
        cardEl.appendChild(contentEl);
        cardEl.appendChild(countEl);
        wrapper.appendChild(cardEl);
        container.appendChild(wrapper);
    });
}

function handlePartsCardClick(targetKey) {
    const handler = partsCardTargets[targetKey]?.run;
    if (handler) handler();
}

function applyPartsSettings() {
    const titles = {
        store: partsSettings.storeTitle,
        logistics: partsSettings.logisticsTitle
    };
    Object.entries(titles).forEach(([key, val]) => {
        document.querySelectorAll(`[data-parts-title="${key}"]`).forEach(el => {
            el.textContent = val;
        });
    });
    document.documentElement.style.setProperty('--parts-card-height', `${partsSettings.cardHeight}px`);
    document.documentElement.style.setProperty('--parts-card-width', `${partsSettings.cardWidth}%`);
    renderPartsCards();
    renderCustomCardsList();
}

function populatePartsSettingsForm() {
    const storeInput = document.getElementById('parts-store-title-input');
    const logisticsInput = document.getElementById('parts-logistics-title-input');
    const heightInput = document.getElementById('parts-card-height');
    const widthInput = document.getElementById('parts-card-width');

    if (storeInput) storeInput.value = partsSettings.storeTitle;
    if (logisticsInput) logisticsInput.value = partsSettings.logisticsTitle;
    if (heightInput) {
        heightInput.value = partsSettings.cardHeight;
        updatePartsCardHeightLabel(partsSettings.cardHeight);
    }
    if (widthInput) {
        widthInput.value = partsSettings.cardWidth;
        updatePartsCardWidthLabel(partsSettings.cardWidth);
    }
    clearCustomCardForm();
    renderCustomCardsList();
}

function updatePartsCardHeightLabel(value) {
    const label = document.getElementById('parts-card-height-value');
    if (label) label.textContent = `${value}px`;
    document.documentElement.style.setProperty('--parts-card-height', `${value}px`);
}

function updatePartsCardWidthLabel(value) {
    const label = document.getElementById('parts-card-width-value');
    if (label) label.textContent = `${value}%`;
    document.documentElement.style.setProperty('--parts-card-width', `${value}%`);
}

function addCustomPartsCard() {
    const titleInput = document.getElementById('parts-custom-title');
    const colorInput = document.getElementById('parts-custom-color');
    const targetSelect = document.getElementById('parts-custom-target');
    const widthInput = document.getElementById('parts-custom-width');

    const title = (titleInput?.value || '').trim();
    const color = colorInput?.value || '#2563eb';
    const target = targetSelect?.value || 'parts-modal';
    const width = clampNumber(Number.parseInt(widthInput?.value, 10) || partsSettings.cardWidth, 35, 100);

    const newCard = normalizeCustomCard({
        id: `custom-${Date.now()}`,
        title: title || 'Custom Card',
        color,
        target,
        width
    }, (partsSettings.customCards || []).length + 1);

    partsSettings.customCards = [...(partsSettings.customCards || []), newCard];
    persistPartsSettings();
    applyPartsSettings();
    populatePartsSettingsForm();
    showSuccessNotification('Custom card added');
}

function renderCustomCardsList() {
    const list = document.getElementById('parts-custom-list');
    if (!list) return;
    const cards = partsSettings.customCards || [];
    if (!cards.length) {
        list.innerHTML = '<div class="list-group-item text-muted">No custom cards yet</div>';
        return;
    }
    list.innerHTML = cards.map(card => {
        const targetLabel = partsCardTargets[card.target]?.label || card.target;
        return `
            <div class="list-group-item d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center gap-2">
                    <span class="rounded-circle d-inline-block" style="width:14px;height:14px;background:${card.color};"></span>
                    <div>
                        <div><strong>${card.title}</strong></div>
                        <div class="text-muted">${targetLabel} • ${card.width}% width</div>
                    </div>
                </div>
                <button class="btn btn-sm btn-outline-danger" onclick="removeCustomCard('${card.id}')"><i class="bi bi-trash"></i></button>
            </div>`;
    }).join('');
}

function removeCustomCard(id) {
    partsSettings.customCards = (partsSettings.customCards || []).filter(c => c.id !== id);
    persistPartsSettings();
    applyPartsSettings();
    populatePartsSettingsForm();
}

function clearCustomCardForm() {
    const titleInput = document.getElementById('parts-custom-title');
    const colorInput = document.getElementById('parts-custom-color');
    const targetSelect = document.getElementById('parts-custom-target');
    const widthInput = document.getElementById('parts-custom-width');
    if (titleInput) titleInput.value = '';
    if (colorInput) colorInput.value = '#2563eb';
    if (targetSelect) targetSelect.value = 'parts-modal';
    if (widthInput) widthInput.value = partsSettings.cardWidth;
}

function savePartsSettingsFromForm() {
    const storeInput = document.getElementById('parts-store-title-input');
    const logisticsInput = document.getElementById('parts-logistics-title-input');
    const heightInput = document.getElementById('parts-card-height');
    const widthInput = document.getElementById('parts-card-width');

    const newHeightRaw = heightInput ? Number.parseInt(heightInput.value, 10) : partsSettingsDefaults.cardHeight;
    const newWidthRaw = widthInput ? Number.parseInt(widthInput.value, 10) : partsSettingsDefaults.cardWidth;
    const clampedHeight = Number.isFinite(newHeightRaw) ? clampNumber(newHeightRaw, 160, 260) : partsSettingsDefaults.cardHeight;
    const clampedWidth = Number.isFinite(newWidthRaw) ? clampNumber(newWidthRaw, 35, 100) : partsSettingsDefaults.cardWidth;

    partsSettings = {
        ...partsSettings,
        storeTitle: (storeInput?.value || partsSettingsDefaults.storeTitle).trim() || partsSettingsDefaults.storeTitle,
        logisticsTitle: (logisticsInput?.value || partsSettingsDefaults.logisticsTitle).trim() || partsSettingsDefaults.logisticsTitle,
        cardHeight: clampedHeight,
        cardWidth: clampedWidth
    };

    persistPartsSettings();
    applyPartsSettings();
    populatePartsSettingsForm();
    showSuccessNotification('Parts settings saved');
}

function resetPartsSettings() {
    if (!confirm('Reset parts titles, sizes, and custom cards to defaults?')) return;
    partsSettings = { ...partsSettingsDefaults };
    persistPartsSettings();
    applyPartsSettings();
    populatePartsSettingsForm();
}

loadPartsSettings();
applyPartsSettings();

let dashboardEditMode = localStorage.getItem('dashboard-edit-mode') === 'true';

function toggleDashboardEditMode() {
    dashboardEditMode = document.getElementById('dashboard-edit-toggle').checked;
    localStorage.setItem('dashboard-edit-mode', dashboardEditMode);
    const section = document.getElementById('dashboard-edit-section');
    section.style.display = dashboardEditMode ? 'block' : 'none';
    if (dashboardEditMode) {
        enableLocationDragDrop();
    } else {
        disableLocationDragDrop();
    }
}

function populateDashboardEditList() {
    populateCityList();
    populateStatusList();
    populateFleetList();
}

function populateCityList() {
    const list = document.getElementById('locations-edit-list');
    const container = document.getElementById('locations-container');
    const buttons = container.querySelectorAll('.col-md-2[data-location-id]');
    
    list.innerHTML = '';
    buttons.forEach((btn, idx) => {
        const nameEl = btn.querySelector('.label');
        const name = nameEl ? nameEl.textContent : `Location ${idx}`;
        const item = document.createElement('div');
        item.className = 'list-group-item d-flex justify-content-between align-items-center py-2';
        item.draggable = true;
        item.setAttribute('data-location-idx', idx);
        item.setAttribute('data-type', 'city');
        item.style.cursor = 'grab';
        item.innerHTML = `
            <span><i class="bi bi-geo-alt text-primary me-2"></i><strong>${name}</strong></span>
            <div class="btn-group btn-group-sm">
                <button class="btn btn-outline-info" onclick="renameLocation(${idx})" title="Rename">
                    <i class="bi bi-pencil"></i>
                </button>
                <button class="btn btn-outline-danger" onclick="deleteLocation(${idx})" title="Delete">
                    <i class="bi bi-trash"></i>
                </button>
            </div>
        `;
        
        // Add drag event listeners
        item.addEventListener('dragstart', handleSettingsDragStart);
        item.addEventListener('dragover', handleSettingsDragOver);
        item.addEventListener('drop', handleSettingsDrop);
        item.addEventListener('dragend', handleSettingsDragEnd);
        
        list.appendChild(item);
    });
}

function populateStatusList() {
    const list = document.getElementById('status-edit-list');
    const statusButtons = [
        {name: 'Serviceable (SV)', icon: 'check-circle-fill', color: 'success'},
        {name: 'Unserviceable (US)', icon: 'x-circle-fill', color: 'danger'},
        {name: 'Removed from AC', icon: 'arrow-down-left-circle-fill', color: 'warning'},
        {name: 'Installed on AC', icon: 'airplane-engines-fill', color: 'info'}
    ];
    
    list.innerHTML = '';
    statusButtons.forEach((status, idx) => {
        const item = document.createElement('div');
        item.className = 'list-group-item d-flex justify-content-between align-items-center py-2';
        item.draggable = true;
        item.setAttribute('data-type', 'status');
        item.style.cursor = 'grab';
        item.innerHTML = `
            <span><i class="bi bi-${status.icon} text-${status.color} me-2"></i><strong>${status.name}</strong></span>
            <span class="badge bg-secondary">Drag to reorder</span>
        `;
        
        // Add drag event listeners
        item.addEventListener('dragstart', handleSettingsDragStart);
        item.addEventListener('dragover', handleSettingsDragOver);
        item.addEventListener('drop', handleSettingsDrop);
        item.addEventListener('dragend', handleSettingsDragEnd);
        
        list.appendChild(item);
    });
}

async function populateFleetList() {
    const list = document.getElementById('fleet-edit-list');
    
    try {
        const response = await fetch('/api/fleet');
        if (!response.ok) throw new Error('Failed to load fleet');
        
        const fleet = await response.json();
        list.innerHTML = '';
        
        fleet.forEach((aircraft, idx) => {
            const item = document.createElement('div');
            item.className = 'list-group-item d-flex justify-content-between align-items-center py-2';
            item.draggable = true;
            item.setAttribute('data-aircraft-id', aircraft.id);
            item.setAttribute('data-type', 'fleet');
            item.style.cursor = 'grab';
            item.innerHTML = `
                <span><i class="bi bi-airplane text-primary me-2"></i><strong>${aircraft.tail_number}</strong> <small class="text-muted">(${aircraft.model || 'N/A'})</small></span>
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-info" onclick="renameAircraft(${aircraft.id})" title="Edit">
                        <i class="bi bi-pencil"></i>
                    </button>
                    <button class="btn btn-outline-danger" onclick="deleteAircraft(${aircraft.id})" title="Delete">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
            `;
            
            // Add drag event listeners
            item.addEventListener('dragstart', handleSettingsDragStart);
            item.addEventListener('dragover', handleSettingsDragOver);
            item.addEventListener('drop', handleSettingsDrop);
            item.addEventListener('dragend', handleSettingsDragEnd);
            
            list.appendChild(item);
        });
    } catch (err) {
        console.error('Error loading fleet:', err);
        list.innerHTML = '<div class="list-group-item text-danger">Error loading fleet</div>';
    }
}

async function addNewAircraft() {
    if (!isAdmin()) {
        showErrorNotification('Only admins can add aircraft');
        return;
    }
    
    const tailNumber = prompt('Enter aircraft tail number (e.g., ER-BAX):');
    if (!tailNumber) return;
    
    const model = prompt('Enter aircraft model (e.g., Boeing 747-200):') || '';
    const msn = prompt('Enter MSN (optional):') || '';
    
    try {
        const response = await fetch(`/api/aircrafts?user_id=${currentUser.id}`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                tail_number: tailNumber,
                model: model,
                msn: msn,
                total_time: 0,
                total_cycles: 0
            })
        });
        
        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || 'Failed to create aircraft');
        }
        
        showSuccessNotification(`Aircraft ${tailNumber} added successfully`);
        await populateFleetList();
        await loadDashboardData();
        await loadAircraftDropdown(); // Refresh utilization parameters dropdown
    } catch (err) {
        console.error('Error adding aircraft:', err);
        showErrorNotification('Error: ' + err.message);
    }
}

async function renameAircraft(aircraftId) {
    if (!isAdmin()) {
        showErrorNotification('Only admins can edit aircraft');
        return;
    }
    
    const newTailNumber = prompt('Enter new tail number:');
    if (!newTailNumber) return;
    
    const newModel = prompt('Enter new model (optional):');
    
    try {
        const response = await fetch(`/api/aircrafts/${aircraftId}`, {
            method: 'PUT',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                tail_number: newTailNumber,
                model: newModel || undefined
            })
        });
        
        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || 'Failed to update aircraft');
        }
        
        showSuccessNotification(`Aircraft updated successfully`);
        await populateFleetList();
        await loadDashboardData();
        await loadAircraftDropdown(); // Refresh utilization parameters dropdown
    } catch (err) {
        console.error('Error updating aircraft:', err);
        showErrorNotification('Error: ' + err.message);
    }
}

async function deleteAircraft(aircraftId) {
    if (!isAdmin()) {
        showErrorNotification('Only admins can delete aircraft');
        return;
    }
    
    if (!confirm('Delete this aircraft? This cannot be undone!')) return;
    
    try {
        const response = await fetch(`/api/aircrafts/${aircraftId}?user_id=${currentUser.id}`, {
            method: 'DELETE'
        });
        
        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || 'Failed to delete aircraft');
        }
        
        showSuccessNotification('Aircraft deleted successfully');
        await populateFleetList();
        await loadDashboardData();
        await loadAircraftDropdown(); // Refresh utilization parameters dropdown
    } catch (err) {
        console.error('Error deleting aircraft:', err);
        showErrorNotification('Error: ' + err.message);
    }
}

function enableLocationDragDrop() {
    const container = document.getElementById('locations-container');
    const items = container.querySelectorAll('.col-md-2');
    items.forEach(item => {
        item.style.cursor = 'grab';
        item.draggable = true;
        item.addEventListener('dragstart', handleDragStart);
        item.addEventListener('dragover', handleDragOver);
        item.addEventListener('drop', handleDrop);
    });
}

function disableLocationDragDrop() {
    const container = document.getElementById('locations-container');
    const items = container.querySelectorAll('.col-md-2');
    items.forEach(item => {
        item.style.cursor = 'default';
        item.draggable = false;
        item.removeEventListener('dragstart', handleDragStart);
        item.removeEventListener('dragover', handleDragOver);
        item.removeEventListener('drop', handleDrop);
    });
}

let draggedElement = null;

function handleDragStart(e) {
    draggedElement = this;
    this.style.opacity = '0.5';
}

function handleDragOver(e) {
    if (e.preventDefault) e.preventDefault();
    e.dataTransfer.dropEffect = 'move';
    return false;
}

function handleDrop(e) {
    if (e.stopPropagation) e.stopPropagation();
    if (draggedElement !== this) {
        const container = document.getElementById('locations-container');
        const allItems = [...container.querySelectorAll('.col-md-2')];
        const draggedIdx = allItems.indexOf(draggedElement);
        const targetIdx = allItems.indexOf(this);
        if (draggedIdx < targetIdx) {
            this.parentNode.insertBefore(draggedElement, this.nextSibling);
        } else {
            this.parentNode.insertBefore(draggedElement, this);
        }
        saveDashboardLayout();
    }
    draggedElement.style.opacity = '1';
    draggedElement = null;
    return false;
}

// Drag-drop handlers for Settings modal
let settingsDraggedItem = null;

function handleSettingsDragStart(e) {
    settingsDraggedItem = this;
    this.style.opacity = '0.4';
    this.style.cursor = 'grabbing';
    e.dataTransfer.effectAllowed = 'move';
}

function handleSettingsDragOver(e) {
    if (e.preventDefault) e.preventDefault();
    e.dataTransfer.dropEffect = 'move';
    
    // Add visual feedback
    if (settingsDraggedItem && this !== settingsDraggedItem) {
        const rect = this.getBoundingClientRect();
        const midpoint = rect.top + rect.height / 2;
        if (e.clientY < midpoint) {
            this.style.borderTop = '3px solid #007bff';
            this.style.borderBottom = '';
        } else {
            this.style.borderBottom = '3px solid #007bff';
            this.style.borderTop = '';
        }
    }
    
    return false;
}

function handleSettingsDrop(e) {
    if (e.stopPropagation) e.stopPropagation();
    if (e.preventDefault) e.preventDefault();
    
    // Remove visual feedback
    this.style.borderTop = '';
    this.style.borderBottom = '';
    
    if (settingsDraggedItem && settingsDraggedItem !== this) {
        // Determine drop position
        const rect = this.getBoundingClientRect();
        const midpoint = rect.top + rect.height / 2;
        
        if (e.clientY < midpoint) {
            // Insert before
            this.parentNode.insertBefore(settingsDraggedItem, this);
        } else {
            // Insert after
            this.parentNode.insertBefore(settingsDraggedItem, this.nextSibling);
        }
        
        // Save the new order based on type
        const type = settingsDraggedItem.getAttribute('data-type');
        if (type === 'city') {
            saveLocationOrder();
        } else if (type === 'status') {
            saveStatusOrder();
        } else if (type === 'fleet') {
            saveFleetOrder();
        }
    }
    
    return false;
}

function handleSettingsDragEnd(e) {
    this.style.opacity = '1';
    this.style.cursor = 'grab';
    
    // Remove all visual feedback
    const lists = ['locations-edit-list', 'status-edit-list', 'fleet-edit-list'];
    lists.forEach(listId => {
        const list = document.getElementById(listId);
        if (list) {
            list.querySelectorAll('.list-group-item').forEach(item => {
                item.style.borderTop = '';
                item.style.borderBottom = '';
            });
        }
    });
    
    settingsDraggedItem = null;
}

function saveLocationOrder() {
    const list = document.getElementById('locations-edit-list');
    const items = list.querySelectorAll('.list-group-item');
    const newOrder = [];
    
    items.forEach((item, idx) => {
        const locationIdx = item.getAttribute('data-location-idx');
        newOrder.push(parseInt(locationIdx));
    });
    
    // Reorder the actual location buttons on dashboard
    const container = document.getElementById('locations-container');
    const buttons = [...container.querySelectorAll('.col-md-2[data-location-id]')];
    
    newOrder.forEach((oldIdx, newIdx) => {
        container.appendChild(buttons[oldIdx]);
    });
    
    saveDashboardLayout();
    loadDashboardData(); // Refresh to show new order
}

function saveStatusOrder() {
    // Status order is UI only for now
    console.log('Status order saved (UI only)');
}

function saveFleetOrder() {
    // Fleet order - could be saved to backend in future
    console.log('Fleet order saved (local only)');
}

async function renameLocation(idx) {
    // Only admin can rename
    if (!isAdmin()) {
        showErrorNotification('Only admins can rename locations');
        return;
    }
    
    const container = document.getElementById('locations-container');
    const item = container.querySelectorAll('.col-md-2')[idx];
    const nameEl = item.querySelector('.label');
    const oldName = nameEl.textContent;
    const newName = prompt('Enter new location name:', oldName);
    
    if (!newName || newName === oldName) return;
    
    try {
        // Get location ID from data attribute (we'll need to add this)
        const locId = item.getAttribute('data-location-id');
        if (!locId) {
            showErrorNotification('Location ID not found');
            return;
        }
        
        const response = await fetch(`/api/locations/${locId}`, {
            method: 'PUT',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ name: newName })
        });
        
        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || 'Failed to update location');
        }
        
        // Update UI
        nameEl.textContent = newName;
        saveDashboardLayout();
        populateDashboardEditList();
        
        // Reload dashboard data to sync everywhere
        if (typeof loadDashboardData === 'function') {
            await loadDashboardData();
        }
        
        showSuccessNotification(`Location renamed to ${newName}`);
    } catch (err) {
        console.error('Error renaming location:', err);
        showErrorNotification('Error: ' + err.message);
    }
}

async function deleteLocation(idx) {
    if (!isAdmin()) {
        showErrorNotification('Only admins can delete locations');
        return;
    }
    
    const container = document.getElementById('locations-container');
    const item = container.querySelectorAll('.col-md-2[data-location-id]')[idx];
    const locationId = item.getAttribute('data-location-id');
    const locationName = item.querySelector('.label').textContent;
    
    if (!confirm(`Delete location "${locationName}"? This cannot be undone!`)) return;
    
    try {
        const response = await fetch(`/api/locations/${locationId}`, {
            method: 'DELETE'
        });
        
        if (!response.ok) {
            let message = '';
            try {
                const ct = response.headers.get('content-type') || '';
                if (ct.includes('application/json')) {
                    const error = await response.json();
                    message = (error && (error.detail || error.message)) || '';
                } else {
                    message = (await response.text()) || '';
                }
            } catch (_) {
                // swallow parse errors, fallback to status
            }
            if (!message) message = `${response.status} ${response.statusText}`;
            throw new Error(message);
        }
        
        showSuccessNotification('Location deleted successfully');
        // Ensure any custom overlays are closed so UI remains interactive
        try {
            document.getElementById('filter-overlay')?.classList.remove('active');
            document.getElementById('filter-panel')?.classList.remove('open');
        } catch (_e) {}
        await loadDashboardData();  // This reloads locations from API
        populateCityList();  // Then refresh the settings list from updated DOM
    } catch (err) {
        console.error('Error deleting location:', err);
        showErrorNotification('Error: ' + err.message);
        // Also close any overlays if an error modal masked the page
        try {
            document.getElementById('filter-overlay')?.classList.remove('active');
            document.getElementById('filter-panel')?.classList.remove('open');
        } catch (_e) {}
    }
}

function saveDashboardLayout() {
    const container = document.getElementById('locations-container');
    const buttons = container.querySelectorAll('.col-md-2');
    const layout = [];
    buttons.forEach(btn => {
        const nameEl = btn.querySelector('.label');
        const countEl = btn.querySelector('.count');
        layout.push({
            name: nameEl ? nameEl.textContent : '',
            count: countEl ? countEl.textContent : '0'
        });
    });
    localStorage.setItem('dashboard-layout', JSON.stringify(layout));
}

function resetDashboardDefaults() {
    if (confirm('Reset dashboard to default layout?')) {
        localStorage.removeItem('dashboard-layout');
        localStorage.removeItem('dashboard-edit-mode');
        dashboardEditMode = false;
        document.getElementById('dashboard-edit-toggle').checked = false;
        document.getElementById('dashboard-edit-section').style.display = 'none';
        location.reload();
    }
}

function editProfile() {
    alert('Profile editing coming soon!');
}

async function changePassword() {
    const oldPassword = prompt('Enter current password:');
    if (!oldPassword) return;
    const newPassword = prompt('Enter new password:');
    if (!newPassword) return;
    const confirmPassword = prompt('Confirm new password:');
    if (newPassword !== confirmPassword) {
        alert('Passwords do not match!');
        return;
    }
    try {
        const response = await fetch(`/api/users/${currentUser.id}/change-password`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({old_password: oldPassword, new_password: newPassword})
        });
        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail);
        }
        alert('Password changed successfully!');
    } catch (error) {
        alert('Error: ' + error.message);
    }
}

// === NOTIFICATIONS FUNCTIONS ===
document.getElementById('notifications-btn')?.addEventListener('click', () => {
    const panel = document.getElementById('notifications-panel');
    panel.classList.toggle('show');
    document.getElementById('profile-dropdown').classList.remove('show');
    if (panel.classList.contains('show')) loadNotifications();
});

async function loadNotifications() {
    try {
        const response = await fetch('/api/notifications');
        if (!response.ok) return;
        const notifications = await response.json();
        const list = document.getElementById('notifications-list');
        if (notifications.length === 0) {
            list.innerHTML = '<div class="text-center text-muted py-4">No notifications</div>';
            return;
        }
        list.innerHTML = notifications.map(n => `
            <div class="notification-item ${n.is_read ? '' : 'unread'}" onclick="markNotificationRead(${n.id})">
                <div class="d-flex justify-content-between">
                    <strong>${n.entity_type}</strong>
                    <span class="badge bg-${getActionBadgeColor(n.action_type)}">${n.action_type}</span>
                </div>
                <div>${n.message}</div>
                <div class="notification-time">by ${n.performed_by} • ${formatNotificationTime(n.created_at)}</div>
            </div>
        `).join('');
    } catch (error) {
        console.error('Error loading notifications:', error);
    }
}

async function updateNotificationCount() {
    try {
        const response = await safeFetch('/api/notifications/unread-count');
        if (!response || !response.ok) return;
        const data = await response.json();
        const badge = document.getElementById('notification-count');
        if (data.count > 0) {
            badge.textContent = data.count > 99 ? '99+' : data.count;
            badge.style.display = 'block';
        } else {
            badge.style.display = 'none';
        }
    } catch (error) {
        // Silently fail - notification count is not critical
    }
}

async function markNotificationRead(id) {
    try {
        await fetch(`/api/notifications/${id}/read`, {method: 'PUT'});
        loadNotifications();
        updateNotificationCount();
    } catch (error) {
        console.error('Error marking notification:', error);
    }
}

async function markAllNotificationsRead() {
    try {
        await fetch('/api/notifications/mark-all-read', {method: 'PUT'});
        loadNotifications();
        updateNotificationCount();
    } catch (error) {
        console.error('Error marking all notifications:', error);
    }
}

// Debounced refresh function - called only after data changes, never from intervals
function refreshAfterDataChange() {
    const now = Date.now();
    if (now - lastRefreshTime < 500) return; // Debounce: ignore calls within 500ms
    lastRefreshTime = now;
    loadRecentActions();
    updateNotificationCount();
}

function getActionBadgeColor(action) {
    switch(action) {
        case 'created': return 'success';
        case 'updated': return 'info';
        case 'deleted': return 'danger';
        default: return 'secondary';
    }
}

function formatNotificationTime(timestamp) {
    const date = new Date(timestamp);
    const now = new Date();
    const diff = now - date;
    const minutes = Math.floor(diff / 60000);
    if (minutes < 1) return 'Just now';
    if (minutes < 60) return `${minutes}m ago`;
    const hours = Math.floor(minutes / 60);
    if (hours < 24) return `${hours}h ago`;
    const days = Math.floor(hours / 24);
    if (days < 7) return `${days}d ago`;
    return date.toLocaleDateString();
}

// === USER MANAGEMENT ===
document.getElementById('add-user-btn')?.addEventListener('click', openUserManager);
document.getElementById('refresh-users-btn')?.addEventListener('click', loadUsersList);
document.getElementById('user-form')?.addEventListener('submit', submitUserForm);
document.getElementById('user-reset-btn')?.addEventListener('click', resetUserForm);

async function openUserManager() {
    if (!isAdmin()) {
        showErrorNotification('Только админ может управлять пользователями');
        return;
    }
    resetUserForm();
    await loadUsersList();
    const modalEl = document.getElementById('user-manage-modal');
    if (modalEl) {
        const modal = new bootstrap.Modal(modalEl);
        modal.show();
    }
}

function resetUserForm() {
    editingUserId = null;
    document.getElementById('user-id').value = '';
    document.getElementById('user-first-name').value = '';
    document.getElementById('user-last-name').value = '';
    document.getElementById('user-username').value = '';
    document.getElementById('user-password').value = '';
    document.getElementById('user-position').value = '';
    document.getElementById('user-role').value = 'viewer';
    document.getElementById('user-submit-btn').textContent = 'Create User';
}

function validateUsername(username) {
    return /^[A-Za-z0-9]+$/.test(username);
}

async function submitUserForm(event) {
    event.preventDefault();
    const first_name = document.getElementById('user-first-name').value.trim();
    const last_name = document.getElementById('user-last-name').value.trim();
    const username = document.getElementById('user-username').value.trim();
    const password = document.getElementById('user-password').value;
    const position = document.getElementById('user-position').value.trim();
    const role = document.getElementById('user-role').value;
    if (!validateUsername(username)) {
        showErrorNotification('Логин: только английские буквы и цифры.');
        return;
    }
    const payload = { first_name, last_name, username, position, role };
    if (!editingUserId) {
        payload.password = password;
    } else if (password) {
        payload.password = password;
    }
    try {
        let response;
        if (editingUserId) {
            response = await fetch(`/api/users/${editingUserId}?user_id=${currentUser.id}`, {
                method: 'PUT',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            });
        } else {
            response = await fetch(`/api/users?user_id=${currentUser.id}`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            });
        }
        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || 'Operation failed');
        }
        showSuccessNotification(editingUserId ? 'Пользователь обновлен' : 'Пользователь создан');
        await loadUsersList();
        resetUserForm();
    } catch (error) {
        showErrorNotification(error.message);
    }
}

async function loadUsersList() {
    try {
        const response = await fetch('/api/users');
        if (!response.ok) throw new Error('Не удалось загрузить пользователей');
        userCache = await response.json();
        renderUsersTable(userCache);
    } catch (error) {
        showErrorNotification(error.message);
    }
}

function renderUsersTable(users) {
    const tbody = document.getElementById('user-table-body');
    if (!tbody) return;
    tbody.innerHTML = users.map(u => `
        <tr>
            <td>${u.first_name}</td>
            <td>${u.last_name}</td>
            <td>${u.username}</td>
            <td><span class="badge bg-${u.role === 'admin' ? 'danger' : u.role === 'user' ? 'primary' : 'secondary'}">${u.role}</span></td>
            <td class="text-end">
                <button class="btn btn-outline-secondary btn-sm me-1" onclick="editUser(${u.id})"><i class="bi bi-pencil"></i></button>
                <button class="btn btn-outline-warning btn-sm me-1" onclick="resetUserPassword(${u.id})"><i class="bi bi-key"></i></button>
                <button class="btn btn-outline-danger btn-sm" onclick="deleteUser(${u.id})"><i class="bi bi-trash"></i></button>
            </td>
        </tr>
    `).join('');
}

function editUser(id) {
    const user = userCache.find(u => u.id === id);
    if (!user) return;
    editingUserId = id;
    document.getElementById('user-id').value = id;
    document.getElementById('user-first-name').value = user.first_name;
    document.getElementById('user-last-name').value = user.last_name;
    document.getElementById('user-username').value = user.username;
    document.getElementById('user-position').value = user.position || '';
    document.getElementById('user-role').value = user.role;
    document.getElementById('user-password').value = '';
    document.getElementById('user-submit-btn').textContent = 'Save User';
}

async function resetUserPassword(id) {
    const oldPassword = prompt('Введите текущий пароль пользователя');
    if (oldPassword === null) return;
    const newPassword = prompt('Введите новый пароль');
    if (!newPassword) return;
    try {
        const response = await fetch(`/api/users/${id}/change-password`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ old_password: oldPassword, new_password: newPassword })
        });
        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || 'Не удалось сменить пароль');
        }
        showSuccessNotification('Пароль обновлен');
    } catch (error) {
        showErrorNotification(error.message);
    }
}

async function deleteUser(id) {
    const target = userCache?.find(u => u.id === id);
    if (target && (target.role === 'admin' || target.username === 'admin')) {
        showErrorNotification('Нельзя удалить администратора');
        return;
    }
    if (currentUser && currentUser.id === id) {
        showErrorNotification('Нельзя удалить самого себя');
        return;
    }
    if (!confirm('Удалить пользователя?')) return;
    try {
        const response = await fetch(`/api/users/${id}?user_id=${currentUser.id}`, { method: 'DELETE' });
        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || 'Не удалось удалить пользователя');
        }
        showSuccessNotification('Пользователь удален');
        await loadUsersList();
    } catch (error) {
        showErrorNotification(error.message);
    }
}

// === UNIVERSAL TABLE FILTER SYSTEM ===
let currentFilterTable = null;
let currentFilterData = [];
let panelActiveFilters = {};

function openFilterPanel(tableName) {
    // Check if tableConfigs is defined
    if (typeof tableConfigs === 'undefined') {
        showErrorNotification('Filter system not ready. Please try again.');
        return;
    }
    
    currentFilterTable = tableName;
    const config = tableConfigs[tableName];
    if (!config) {
        showErrorNotification('Table configuration not found.');
        return;
    }
    
    const tbody = document.getElementById(config.bodyId);
    if (!tbody) {
        showErrorNotification('Table not found. Please open the table first.');
        return;
    }
    
    // Collect all data from table rows
    const rows = Array.from(tbody.querySelectorAll('tr'));
    currentFilterData = rows.map(row => {
        const cells = Array.from(row.querySelectorAll('td'));
        const rowData = { element: row, values: {} };
        
        // Extract user from data attribute if exists
        rowData.values.user = row.getAttribute('data-user') || '';
        
        // Extract column values
        let colIndex = 0;
        cells.forEach(cell => {
            // Skip delete column
            if (cell.classList.contains('delete-col') || 
                cell.className.includes('delete-col-')) return;
            
            const columnName = config.columns[colIndex];
            if (columnName) {
                rowData.values[columnName] = cell.textContent.trim();
                colIndex++;
            }
        });
        
        return rowData;
    });
    
    // Build filter fields
    const container = document.getElementById('filter-fields-container');
    let html = '';
    
    // User field first
    html += `
        <div class="filter-field">
            <label><i class="bi bi-person-fill me-1"></i>User</label>
            <input type="text" id="filter-user" placeholder="Filter by user..." 
                   value="${panelActiveFilters.user || ''}" oninput="filterTableRealtime()">
        </div>
    `;
    
    // Other columns
    config.columns.forEach(col => {
        const label = col.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
        html += `
            <div class="filter-field">
                <label><i class="bi bi-funnel me-1"></i>${label}</label>
                <input type="text" id="filter-${col}" placeholder="Filter ${label}..." 
                       value="${panelActiveFilters[col] || ''}" oninput="filterTableRealtime()">
            </div>
        `;
    });
    
    container.innerHTML = html;
    
    // Show panel
    document.getElementById('filter-overlay').classList.add('active');
    document.getElementById('filter-panel').classList.add('open');
    
    // Apply existing filters
    if (Object.keys(panelActiveFilters).length > 0) {
        applyTableFilter();
    }
}

function closeFilterPanel() {
    document.getElementById('filter-overlay').classList.remove('active');
    document.getElementById('filter-panel').classList.remove('open');
}

function filterTableRealtime() {
    // Real-time filtering as user types
    applyTableFilter();
}

function applyTableFilter() {
    if (!currentFilterTable || currentFilterData.length === 0) return;
    
    const config = tableConfigs[currentFilterTable];
    if (!config) return;
    
    // Collect filter values
    panelActiveFilters = {};
    
    const userInput = document.getElementById('filter-user');
    if (userInput && userInput.value.trim()) {
        panelActiveFilters.user = userInput.value.trim().toLowerCase();
    }
    
    config.columns.forEach(col => {
        const input = document.getElementById(`filter-${col}`);
        if (input && input.value.trim()) {
            panelActiveFilters[col] = input.value.trim().toLowerCase();
        }
    });
    
    // Apply filters to data
    currentFilterData.forEach(item => {
        let matches = true;
        
        // Check user filter
        if (panelActiveFilters.user) {
            const userVal = (item.values.user || '').toLowerCase();
            if (!userVal.includes(panelActiveFilters.user)) {
                matches = false;
            }
        }
        
        // Check column filters
        for (const col in panelActiveFilters) {
            if (col === 'user') continue;
            const filterVal = panelActiveFilters[col];
            const cellVal = (item.values[col] || '').toLowerCase();
            if (!cellVal.includes(filterVal)) {
                matches = false;
                break;
            }
        }
        
        // Show/hide row
        item.element.style.display = matches ? '' : 'none';
    });
    
    // Show notification
    const visibleCount = currentFilterData.filter(item => 
        item.element.style.display !== 'none').length;
    const totalCount = currentFilterData.length;
    
    if (visibleCount < totalCount) {
        const filterCount = Object.keys(panelActiveFilters).length;
        console.log(`✅ Filter applied: ${visibleCount}/${totalCount} rows match ${filterCount} filter(s)`);
    }
}

function resetTableFilter() {
    if (!currentFilterTable || currentFilterData.length === 0) return;
    
    // Clear all inputs
    document.querySelectorAll('#filter-fields-container input').forEach(input => {
        input.value = '';
    });
    
    // Clear active filters
    panelActiveFilters = {};
    
    // Show all rows
    currentFilterData.forEach(item => {
        item.element.style.display = '';
    });
    
    showSuccessNotification('Filters cleared - showing all data');
}

// Add filter buttons to all tables
function addFilterButtons() {
    // Check if tableConfigs is defined
    if (typeof tableConfigs === 'undefined') {
        console.warn('tableConfigs not defined yet, skipping filter buttons');
        return;
    }
    
    Object.keys(tableConfigs).forEach(tableName => {
        const editBtn = document.getElementById(`btn-${tableName}-edit`);
        if (!editBtn) return;
        
        // Check if filter button already exists
        if (document.getElementById(`btn-${tableName}-filter`)) return;
        
        const filterBtn = document.createElement('button');
        filterBtn.id = `btn-${tableName}-filter`;
        filterBtn.className = 'btn btn-sm btn-info btn-filter-toggle';
        filterBtn.innerHTML = '<i class="bi bi-funnel-fill"></i>';
        filterBtn.title = 'Filter table data';
        filterBtn.onclick = () => openFilterPanel(tableName);
        
        // Insert after edit button
        editBtn.parentNode.insertBefore(filterBtn, editBtn.nextSibling);
    });
}

// === STORE CONDITION COLOR HANDLER ===
function initStoreConditionColorHandler() {
    const conditionSelect = document.getElementById('store-condition');
    if (!conditionSelect) return;
    
    const colorMap = {
        'SV - NGV (SENT)': 'sv-sent',
        'UNDER REPAIRING': 'under-repair',
        'Delivered in Roma Italy': 'delivered-roma',
        'NO CAPABILITY': 'no-capability',
        'US - SHJ': 'us-shj'
    };
    
    function updateConditionColor() {
        // Удаляем все классы цветов
        Object.values(colorMap).forEach(className => {
            conditionSelect.classList.remove(className);
        });
        
        // Добавляем класс для выбранного значения
        const selectedValue = conditionSelect.value;
        if (colorMap[selectedValue]) {
            conditionSelect.classList.add(colorMap[selectedValue]);
        }
    }
    
    // Обновляем цвет при загрузке и при изменении
    conditionSelect.addEventListener('change', updateConditionColor);
    updateConditionColor(); // Initial color on load
}

// Universal column resize system with localStorage persistence
function attachColumnResizers(tbodySelector, storageKey) {
    const tbody = document.querySelector(tbodySelector);
    if (!tbody) return;
    
    const table = tbody.closest('table');
    if (!table) return;

    const thead = table.tHead;
    if (!thead || !thead.rows.length) return;
    const headerCells = Array.from(thead.rows[0].cells);
    
    // Load saved widths from localStorage
    const savedWidths = JSON.parse(localStorage.getItem(storageKey) || '{}');

    headerCells.forEach((th, index) => {
        // Restore saved width if exists
        if (savedWidths[index]) {
            th.style.width = savedWidths[index] + 'px';
        }
        
        // Prevent duplicating resizers
        const existing = th.querySelector('.col-resizer');
        if (existing) existing.remove();
        
        const resizer = document.createElement('div');
        resizer.className = 'col-resizer';
        th.appendChild(resizer);

        let startX = 0;
        let startWidth = 0;
        
        function onMouseMove(e) {
            const dx = e.clientX - startX;
            const newW = Math.max(50, startWidth + dx);
            th.style.width = newW + 'px';
        }
        
        function onMouseUp() {
            document.removeEventListener('mousemove', onMouseMove);
            document.removeEventListener('mouseup', onMouseUp);
            
            // Save all column widths to localStorage
            const widths = {};
            headerCells.forEach((cell, idx) => {
                widths[idx] = cell.getBoundingClientRect().width;
            });
            localStorage.setItem(storageKey, JSON.stringify(widths));
        }
        
        resizer.addEventListener('mousedown', (e) => {
            e.preventDefault();
            startX = e.clientX;
            startWidth = th.getBoundingClientRect().width;
            document.addEventListener('mousemove', onMouseMove);
            document.addEventListener('mouseup', onMouseUp);
        });
    });
}

// Attach resizers to all tables after they load data
function attachAllTableResizers() {
    // Wait a bit for tables to render
    setTimeout(() => {
        attachColumnResizers('#install-history-body', 'colWidth-install');
        attachColumnResizers('#shipment-history-body', 'colWidth-shipment');
        attachColumnResizers('#remove-history-body', 'colWidth-remove');
        attachColumnResizers('#repair-history-body', 'colWidth-repair');
        attachColumnResizers('#util-history-body', 'colWidth-util');
        attachColumnResizers('#param-history-body', 'colWidth-param');
        attachColumnResizers('#util-param-history-body', 'colWidth-util-param');
        attachColumnResizers('#atlb-history-body', 'colWidth-atlb');
        attachColumnResizers('#borescope-history-body', 'colWidth-borescope');
        attachColumnResizers('#purchase-orders-history-body', 'colWidth-purchase');
        attachColumnResizers('#store-balance-body', 'colWidth-store');
        attachColumnResizers('#parts-history-body', 'colWidth-parts');
    }, 100);
}

// Legacy function redirects to new system
function attachStoreBalanceColumnResizers() {
    attachColumnResizers('#store-balance-body', 'colWidth-store');
}

// === INITIALIZATION ===
document.addEventListener('DOMContentLoaded', () => {
    console.log('🔧 DOMContentLoaded event fired');
    
    // Initialize resizers after short delay
    setTimeout(() => {
        attachAllTableResizers();
        // Add filter buttons after everything is loaded
        setTimeout(() => addFilterButtons(), 1000);
    }, 500);
    
    const savedUser = sessionStorage.getItem('currentUser');
    if (savedUser) {
        console.log('📝 User session found');
        currentUser = JSON.parse(savedUser);
        const modal = document.getElementById('login-modal');
        if (modal) modal.style.display = 'none';
        initializeUserInterface();
    } else {
        console.log('🔓 No session - showing login modal');
        const modal = document.getElementById('login-modal');
        if (modal) modal.style.display = 'flex';
    }
    const form = document.getElementById('login-form');
    console.log('🎯 Login form element:', form);
    if (form) {
        form.addEventListener('submit', handleLogin);
        console.log('✅ Login form listener attached');
    } else {
        console.error('❌ Login form not found!');
        initStoreConditionColorHandler();
    }
    document.addEventListener('click', (e) => {
        if (!e.target.closest('.user-icon-btn') && !e.target.closest('.profile-dropdown')) {
            const profileDropdown = document.getElementById('profile-dropdown');
            if (profileDropdown) profileDropdown.classList.remove('show');
        }
        if (!e.target.closest('.user-icon-btn') && !e.target.closest('.notifications-panel')) {
            const notifyPanel = document.getElementById('notifications-panel');
            if (notifyPanel) notifyPanel.classList.remove('show');
        }
    });
});

// Expose handlers for inline onclick attributes to avoid ReferenceError
window.toggleReportsMenu = toggleReportsMenu;
window.toggleActionsMenu = toggleActionsMenu;
window.toggleLogisticsMenu = toggleLogisticsMenu;
window.openInstallView = openInstallView;
window.openMainEngineView = openMainEngineView;
window.openTableModal = openTableModal;
window.openAtlbView = openAtlbView;
window.openRemoveView = openRemoveView;

async function sendNotification(actionType, entityType, entityId, message) {
    if (!currentUser) return;
    try {
        const performedBy = `${currentUser.first_name} ${currentUser.last_name}`;
        console.log(`Notification: ${actionType} ${entityType} by ${performedBy}`);
    } catch (error) {
        console.error('Error sending notification:', error);
    }
}

// === PARTS CARDS MODALS ===
async function openStoreBalanceModal() {
    const modal = document.getElementById('store-balance-modal');
    modal.classList.add('show');
    
    // Load Store Balance data
    const tbody = document.getElementById('modal-store-balance-body');
    tbody.innerHTML = '<tr><td colspan="11" class="text-center">Loading...</td></tr>';
    
    try {
        const res = await fetch('/api/store-balance' + noCache());
        if (!res.ok) throw new Error('Failed to load');
        
        const data = await res.json();
        tbody.innerHTML = '';
        
        if (!data || data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="11" class="text-center">No items in store</td></tr>';
            return;
        }
        
        data.forEach(item => {
            const fmt = (v) => v || '-';
            const condText = (item.condition || '').trim();
            const condClassMap = {
                'SV - NGV (SENT)': 'cond-sv',
                'UNDER REPAIRING': 'cond-under',
                'Delivered in Roma Italy': 'cond-delivered',
                'NO CAPABILITY': 'cond-nocap',
                'US - SHJ': 'cond-us'
            };
            const condClass = condClassMap[condText] || 'cond-default';
            const condHtml = condText ? `<span class="cond-badge ${condClass}">${escapeHtml(condText)}</span>` : '-';
            
            tbody.innerHTML += `
                <tr>
                    <td>${fmt(item.received_date)}</td>
                    <td>${fmt(item.part_name)}</td>
                    <td>${fmt(item.part_number)}</td>
                    <td>${fmt(item.serial_number)}</td>
                    <td>${condHtml}</td>
                    <td>${fmt(item.quantity)}</td>
                    <td>${fmt(item.unit)}</td>
                    <td>${fmt(item.location)}</td>
                    <td>${fmt(item.shelf)}</td>
                    <td>${fmt(item.owner)}</td>
                    <td>${fmt(item.remarks)}</td>
                </tr>`;
        });
    } catch (err) {
        tbody.innerHTML = '<tr><td colspan="11" class="text-center text-danger">Error loading data</td></tr>';
    }
}

function closeStoreBalanceModal() {
    document.getElementById('store-balance-modal').classList.remove('show');
}

async function openPartsLogisticsModal() {
    const modal = document.getElementById('parts-logistics-modal');
    modal.classList.add('show');
    
    // Load Parts History data
    const tbody = document.getElementById('modal-parts-logistics-body');
    tbody.innerHTML = '<tr><td colspan="10" class="text-center">Loading...</td></tr>';
    
    try {
        const res = await fetch('/api/parts/history' + noCache());
        if (!res.ok) throw new Error('Failed to load');
        
        const data = await res.json();
        tbody.innerHTML = '';
        
        if (!data || data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="10" class="text-center">No parts movements recorded</td></tr>';
            return;
        }
        
        data.forEach(item => {
            const fmt = (v) => v || '-';
            tbody.innerHTML += `
                <tr>
                    <td>${fmt(item.date)}</td>
                    <td><span class="badge bg-info">${fmt(item.action)}</span></td>
                    <td>${fmt(item.part_name)}</td>
                    <td>${fmt(item.part_number)}</td>
                    <td>${fmt(item.serial_number)}</td>
                    <td>${fmt(item.quantity)}</td>
                    <td>${fmt(item.from_esn)}</td>
                    <td>${fmt(item.to_esn)}</td>
                    <td>${fmt(item.location)}</td>
                    <td>${fmt(item.reason)}</td>
                </tr>`;
        });
    } catch (err) {
        tbody.innerHTML = '<tr><td colspan="10" class="text-center text-danger">Error loading data</td></tr>';
    }
}

function closePartsLogisticsModal() {
    document.getElementById('parts-logistics-modal').classList.remove('show');
}

function filterModalTable(tableId, searchId) {
    const search = document.getElementById(searchId).value.toLowerCase();
    const tbody = document.getElementById(tableId);
    const rows = tbody.getElementsByTagName('tr');
    
    for (let row of rows) {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(search) ? '' : 'none';
    }
}

// Update card counts on dashboard load
async function updatePartsCardCounts() {
    try {
        // Store Balance count
        const sbRes = await fetch('/api/store-balance' + noCache());
        if (sbRes.ok) {
            const sbData = await sbRes.json();
            document.getElementById('store-balance-count').textContent = sbData.length || 0;
        }
        
        // Parts Logistics count
        const plRes = await fetch('/api/parts/history' + noCache());
        if (plRes.ok) {
            const plData = await plRes.json();
            document.getElementById('parts-logistics-count').textContent = plData.length || 0;
        }
    } catch (err) {
        console.error('Error updating parts counts:', err);
    }
}

// ============================================
// COLUMN MANAGER - для редактирования структуры таблиц
// ============================================

let currentTableName = '';
let tableColumnsConfig = {};

async function openColumnManager(tableName) {
    currentTableName = tableName;
    const modal = document.getElementById('column-manager-modal');
    
    // Загружаем текущую конфигурацию столбцов
    try {
        const res = await safeFetch(`/api/table-config/${tableName}`);
        if (res && res.ok) {
            tableColumnsConfig = await res.json();
        } else {
            tableColumnsConfig = { columns: [] };
        }
    } catch (e) {
        console.error('Error loading column config:', e);
        tableColumnsConfig = { columns: [] };
    }
    
    // Отображаем столбцы в модальном окне
    renderColumnList();
    modal.style.display = 'flex';
}

function closeColumnManager() {
    const modal = document.getElementById('column-manager-modal');
    modal.style.display = 'none';
    currentTableName = '';
}

function renderColumnList() {
    const columnList = document.getElementById('column-list');
    columnList.innerHTML = '';
    
    if (!tableColumnsConfig.columns || tableColumnsConfig.columns.length === 0) {
        columnList.innerHTML = '<p class="text-muted">No columns configured yet.</p>';
        return;
    }
    
    tableColumnsConfig.columns.forEach((col, idx) => {
        const item = document.createElement('div');
        item.className = 'input-group mb-2';
        item.style.display = 'flex';
        item.style.gap = '10px';
        item.style.alignItems = 'center';
        
        item.innerHTML = `
            <input type="text" class="form-control col-name-${idx}" value="${col.name}" placeholder="Column name">
            <select class="form-select col-type-${idx}" style="max-width: 150px;">
                <option value="text" ${col.type === 'text' ? 'selected' : ''}>Text</option>
                <option value="number" ${col.type === 'number' ? 'selected' : ''}>Number</option>
                <option value="date" ${col.type === 'date' ? 'selected' : ''}>Date</option>
                <option value="currency" ${col.type === 'currency' ? 'selected' : ''}>Currency</option>
            </select>
            <button type="button" class="btn btn-sm btn-danger" onclick="deleteColumn(${idx})">
                <i class="bi bi-trash"></i>
            </button>
        `;
        columnList.appendChild(item);
    });
}

function addNewColumn() {
    const name = document.getElementById('new-column-name').value.trim();
    const type = document.getElementById('new-column-type').value;
    
    if (!name) {
        alert('Please enter a column name');
        return;
    }
    
    if (!tableColumnsConfig.columns) {
        tableColumnsConfig.columns = [];
    }
    
    tableColumnsConfig.columns.push({ name, type });
    document.getElementById('new-column-name').value = '';
    document.getElementById('new-column-type').value = 'text';
    renderColumnList();
}

function deleteColumn(idx) {
    if (confirm('Delete this column?')) {
        tableColumnsConfig.columns.splice(idx, 1);
        renderColumnList();
    }
}

async function saveColumnChanges() {
    // Собираем обновленные данные
    const columns = [];
    if (tableColumnsConfig.columns) {
        tableColumnsConfig.columns.forEach((col, idx) => {
            const name = document.querySelector(`.col-name-${idx}`)?.value || col.name;
            const type = document.querySelector(`.col-type-${idx}`)?.value || col.type;
            columns.push({ name, type });
        });
    }
    
    try {
        const res = await fetch(`/api/table-config/${currentTableName}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ columns })
        });
        
        if (res.ok) {
            showSuccessNotification('Column configuration saved!');
            closeColumnManager();
            // Перезагружаем таблицу
            if (currentTableName === 'purchase-orders') {
                loadPurchaseOrdersHistory();
            }
        } else {
            showErrorNotification('Error saving column configuration');
        }
    } catch (e) {
        showErrorNotification('Error: ' + e.message);
    }
}
</script>

<!-- Universal Filter Panel -->
<div id="filter-overlay" class="filter-overlay" onclick="closeFilterPanel()"></div>
<div id="filter-panel" class="filter-panel">
    <div class="filter-panel-header">
        <h4><i class="bi bi-funnel-fill me-2"></i>Filter Data</h4>
        <button class="filter-panel-close" onclick="closeFilterPanel()">×</button>
    </div>
    <div id="filter-fields-container"></div>
    <div class="filter-actions">
        <button class="filter-reset" onclick="resetTableFilter()">
            <i class="bi bi-arrow-clockwise me-1"></i>Reset
        </button>
        <button class="filter-apply" onclick="applyTableFilter()">
            <i class="bi bi-check-circle me-1"></i>Apply
        </button>
    </div>
</div>

<!-- Store Balance Modal -->
<div id="store-balance-modal" class="parts-modal-overlay" onclick="if(event.target === this) closeStoreBalanceModal()">
    <div class="parts-modal-content">
        <div class="parts-modal-header">
            <h4><i class="bi bi-box-seam me-2"></i><span data-parts-title="store">Store Balance</span> - Inventory</h4>
            <button class="parts-modal-close" onclick="closeStoreBalanceModal()">×</button>
        </div>
        <div class="parts-modal-body">
            <div class="mb-3">
                <input type="text" class="form-control" id="modal-store-search" placeholder="🔍 Filter by part name, P/N, S/N, condition..." onkeyup="filterModalTable('modal-store-balance-body', 'modal-store-search')">
            </div>
            <div class="table-responsive">
                <table class="table table-hover table-sm">
                    <thead class="table-light">
                        <tr>
                            <th>Received</th>
                            <th>Part Name</th>
                            <th>P/N</th>
                            <th>S/N</th>
                            <th>Condition</th>
                            <th>Qty</th>
                            <th>R.O#</th>
                            <th>Location</th>
                            <th>Status</th>
                            <th>Delivered to</th>
                            <th>Remarks</th>
                        </tr>
                    </thead>
                    <tbody id="modal-store-balance-body"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Parts Logistics Modal -->
<div id="parts-logistics-modal" class="parts-modal-overlay" onclick="if(event.target === this) closePartsLogisticsModal()">
    <div class="parts-modal-content">
        <div class="parts-modal-header green">
            <h4><i class="bi bi-arrow-left-right me-2"></i><span data-parts-title="logistics">Parts Logistics</span> - All Movements</h4>
            <button class="parts-modal-close" onclick="closePartsLogisticsModal()">×</button>
        </div>
        <div class="parts-modal-body">
            <div class="mb-3">
                <input type="text" class="form-control" id="modal-parts-search" placeholder="🔍 Filter by date, action, part name..." onkeyup="filterModalTable('modal-parts-logistics-body', 'modal-parts-search')">
            </div>
            <div class="table-responsive">
                <table class="table table-hover table-sm">
                    <thead class="table-light">
                        <tr>
                            <th>Date</th>
                            <th>Action</th>
                            <th>Part Name</th>
                            <th>P/N</th>
                            <th>S/N</th>
                            <th>Qty</th>
                            <th>From ESN</th>
                            <th>To ESN</th>
                            <th>Location</th>
                            <th>Reason</th>
                        </tr>
                    </thead>
                    <tbody id="modal-parts-logistics-body"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- MODAL: Column Manager for Tables -->
<div id="column-manager-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 10000; justify-content: center; align-items: center; overflow-y: auto;">
    <div style="background: white; border-radius: 8px; padding: 30px; max-width: 600px; width: 90%; margin: 20px auto; box-shadow: 0 10px 40px rgba(0,0,0,0.3);">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h5 style="margin: 0;">Manage Table Columns</h5>
            <button onclick="closeColumnManager()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #999;">&times;</button>
        </div>

        <div id="column-list" style="max-height: 400px; overflow-y: auto; margin-bottom: 20px; border: 1px solid #ddd; padding: 15px; border-radius: 5px;">
            <!-- Columns will be listed here dynamically -->
        </div>

        <div style="display: flex; gap: 10px; margin-bottom: 15px;">
            <input type="text" id="new-column-name" placeholder="New column name" class="form-control" style="flex: 1;">
            <select id="new-column-type" class="form-select" style="flex: 1;">
                <option value="text">Text</option>
                <option value="number">Number</option>
                <option value="date">Date</option>
                <option value="currency">Currency</option>
            </select>
            <button onclick="addNewColumn()" class="btn btn-primary">+ Add</button>
        </div>

        <div style="display: flex; gap: 10px; justify-content: flex-end;">
            <button onclick="closeColumnManager()" class="btn btn-secondary">Cancel</button>
            <button onclick="saveColumnChanges()" class="btn btn-success">Save Changes</button>
        </div>
    </div>
</div>

</body>
</html>