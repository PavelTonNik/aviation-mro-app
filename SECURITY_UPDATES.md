# Обновления безопасности - Контроль ролей пользователей

## Что было сделано

### 1. Backend (backend/main.py)

#### Добавлена функция `get_current_user()` 
- Новая зависимость для FastAPI, которая читает `user_id` из query параметра
- Проверяет, что пользователь существует и активен
- Возвращает объект пользователя с его ролью

#### Защита чувствительных endpoints-ов

Следующие endpoints теперь требуют **admin** роль:

1. **POST /api/users** - Создание новых пользователей
   - ✅ Добавлена проверка: `if current_user.role != "admin": raise HTTPException(403)`

2. **PUT /api/users/{user_id}** - Редактирование пользователей
   - ✅ Добавлена проверка: `if current_user.role != "admin": raise HTTPException(403)`

3. **DELETE /api/users/{user_id}** - Удаление пользователей
   - ✅ Добавлена проверка: `if current_user.role != "admin": raise HTTPException(403)`

4. **POST /api/aircrafts** - Создание воздушных судов
   - ✅ Добавлена проверка: `if current_user.role != "admin": raise HTTPException(403)`

5. **POST /api/engines** - Создание двигателей
   - ✅ Добавлена проверка: `if current_user.role != "admin": raise HTTPException(403)`

### 2. Frontend (frontend/index.html)

#### Обновлены все запросы к защищённым endpoints-ам

Теперь все POST/PUT/DELETE запросы содержат параметр `user_id` текущего пользователя:

1. **Создание пользователя**
   ```javascript
   fetch(`/api/users?user_id=${currentUser.id}`, { method: 'POST', ... })
   ```

2. **Редактирование пользователя**
   ```javascript
   fetch(`/api/users/${editingUserId}?user_id=${currentUser.id}`, { method: 'PUT', ... })
   ```

3. **Удаление пользователя**
   ```javascript
   fetch(`/api/users/${id}?user_id=${currentUser.id}`, { method: 'DELETE', ... })
   ```

4. **Создание самолёта**
   ```javascript
   fetch(`/api/aircrafts?user_id=${currentUser.id}`, { method: 'POST', ... })
   ```

5. **Удаление самолёта**
   ```javascript
   fetch(`/api/aircrafts/${aircraftId}?user_id=${currentUser.id}`, { method: 'DELETE', ... })
   ```

6. **Создание двигателя**
   ```javascript
   fetch(`/api/engines?user_id=${currentUser.id}`, { method: 'POST', ... })
   ```

7. **Удаление двигателя**
   ```javascript
   fetch(`/api/engines/${engineId}?user_id=${currentUser.id}`, { method: 'DELETE', ... })
   ```

## Результат

### Для администратора (admin)
✅ Все функции доступны:
- Создание новых пользователей
- Редактирование пользователей
- Удаление пользователей
- Создание воздушных судов
- Создание двигателей
- Удаление любых записей

### Для обычных пользователей (user)
✅ Ограниченный доступ:
- ❌ НЕ могут создавать других пользователей (403 Forbidden)
- ❌ НЕ могут редактировать пользователей (403 Forbidden)
- ❌ НЕ могут удалять пользователей (403 Forbidden)
- ❌ НЕ могут создавать воздушные суда (403 Forbidden)
- ❌ НЕ могут создавать двигатели (403 Forbidden)
- ✅ Могут добавлять записи в таблицы
- ✅ Могут редактировать свои добавленные записи
- ❌ НЕ могут удалять записи (frontend блокирует, backend проверяет)

### Для зрителей (viewer)
✅ Только просмотр:
- ❌ Все интерактивные элементы отключены
- ✅ Могут только просматривать данные

## Защита на двух уровнях

1. **Frontend** - UX защита
   - Кнопка "Add User" скрыта для non-admin
   - DELETE запросы блокируются fetch wrapper-ом
   - Модальное окно управления пользователями проверяет роль

2. **Backend** - Безопасность
   - Каждый чувствительный endpoint проверяет `current_user.role == "admin"`
   - Возвращает 403 Forbidden для non-admin запросов
   - Это правильный подход "defense in depth"

## Тестирование

Для проверки работы:

1. Войдите как admin (username: admin, password: admin123)
   - ✅ Должны работать все функции

2. Создайте обычного пользователя с ролью "user"
   - Попытайтесь создать нового пользователя
   - ❌ Должна появиться ошибка 403 в консоли браузера

3. Создайте пользователя с ролью "viewer"
   - Все кнопки должны быть отключены
   - ✅ Может только просматривать

## Безопасность

✅ Реализована полная система контроля ролей:
- Только админ может управлять пользователями
- Обычные пользователи могут только добавлять свои данные
- Зрители могут только просматривать
- Backend验证на каждом запросе (не зависит от frontend)
